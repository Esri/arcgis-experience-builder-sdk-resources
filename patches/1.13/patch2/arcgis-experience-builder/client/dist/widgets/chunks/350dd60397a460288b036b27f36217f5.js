/*! For license information please see 350dd60397a460288b036b27f36217f5.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([[83129],{82463:(e,t,r)=>{r.d(t,{a:()=>i,i:()=>a});const i={FeatureServer:"Feature Service",GeocodeServer:"Geocoding Service",GeoDataServer:"Geodata Service",GeometryServer:"Geometry Service",GeoenrichmentServer:"Geoenrichment Service",GPServer:"Geoprocessing Service",GlobeServer:"Globe Service",ImageServer:"Image Service",MapServer:"Map Service",NAServer:"Network Analysis Service",ElevationServer:"Image Service",VectorTileServer:"Vector Tile Service",SceneServer:"Scene Service",StreamServer:"Stream Service",WMServer:"Workflow Manager Service",TiledImageServer:"Image Service",VideoServer:"Video Service"},a=e=>!!Object.values(i).includes(e)},83129:(e,t,r)=>{r.d(t,{A:()=>Ue,M:()=>P,a:()=>Fe,b:()=>$,c:()=>He,d:()=>Pe,e:()=>Se,f:()=>E,g:()=>Qe,h:()=>Te,i:()=>De,j:()=>I,k:()=>T,l:()=>xe,m:()=>fe,n:()=>j,o:()=>Je,p:()=>Y,q:()=>b,r:()=>x,s:()=>k,t:()=>he,u:()=>qe,v:()=>_e,w:()=>ke,x:()=>be,y:()=>U,z:()=>Ke});var i=r(76134),a=r(26426),s=r(62381),n=r(65508),o=r(58892),l=r(24552),c=r(30063),u=r(86739),d=r(41171),p=r(66716),y=r(82463),v=r(48507),m=r(48333),f=r(31546),g=r(48680),w=r(86274),h=r(27010);function b(e){return(null==e?void 0:e.id)===(null==e?void 0:e.username)}function S(e){const{customParameters:t}=o.a,r=e.includes("?")?"&":"?",i=(null==t?void 0:t.map((({parameter:e,value:t})=>`${e||""}${e||t?"=":""}${t||""}`)).join("&"))||"";return i?`${e}${r}${i}`:e}function x(e,{value:t,parameter:r}){const i=`${r}=${t}`,a=e.replace("&"===e[e.indexOf(i)-1]?`&${i}`:i,"");return"?"===a[a.length-1]?a.replace("?",""):a}const O=["appExtensionError","forbiddenCredential","disabledSubscription","unauthorized","timeout","itemExists","exceedsFileSize","fileExists","emptyFile","unavailableGeocoder","dataNotAvailable","invalidShapefile","invalidFileGeodatabase","providePath","useSameFileName","invalidExtension","tokenRequired","serviceNameInvalid","titleInvalid","titleRequired","titleInUseService","summaryInvalid","missingUserOrPortal","dataStoreTitleInvalid","serviceNameExists","serviceNotExist","unsupportedWFSVersion","invalidWMTS","invalidSpatialRef","emptyFeatureLayer","invalidFeatureLayerUrl","invalidUrl","httpWarning","flowAborted","duplicateFieldNames","failToFetchText","mapServiceError","noTilingSchemeFound","noMatchSpatialRef","invalidDataStorePublishType","noRegisteredServersForDataStore","noContentInDataStore","failToPublishFromDataStore","failToListDataStoreContents","invalidUsernameOrPassword","invalidJSON","unknownAGSType","unhandledError","incompatibleGeometries","multiPatchRestriction"],I=e=>O.includes(null==e?void 0:e.code),T=e=>e&&e.hasOwnProperty("code")&&e.hasOwnProperty("message")&&e.hasOwnProperty("details")&&(!e.details||Array.isArray(e.details)),L=async e=>{const t=k.subscribers[e];try{await(null==t?void 0:t.unsubscribe())}catch(e){console.error(`Fail to call unsubscribe for ${t.name}: ${e}`)}},M=(0,h.c)({subscribers:{},unsubscribeAll:async()=>{await Promise.all(Object.keys(k.subscribers).map(L)),M.reset()},addSubscriber:(e,t)=>{const r=`${e}---${(0,g.g)()}`;return k.subscribers[r]={name:e,unsubscribe:t},r},unsubscribe:L,removeSubscriber:async e=>{delete k.subscribers[e]},isSubscriberValid:e=>!!k.subscribers[e]}),k=M.state,P=78643200;function j(e){if(!e)return null;let t=!0,r={},i={};return e.forEach((({append:e,parameter:a,value:s})=>{"layer"===e?(t=!1,i[a]=s):r[a]=s})),t?{customParameters:r}:{customParameters:r,customLayerParameters:i}}async function $(e,t,r){if("Desktop Application"===e.type)return Se();const i=await(0,u.c)(e);return"Application"!==e.type&&"API Key"!==e.type||await U(i.id,t,r),i}async function U(e,t,r){const i=`${t}oauth2/registerApp`;let a={itemId:e,appType:"multiple",redirect_uris:JSON.stringify(["urn:ietf:wg:oauth:2.0:oob"])};const s=JSON.stringify(r.redirect_uris);r&&(a="apikey"===r.appType?{itemId:e,appType:"apikey",redirect_uris:s,httpReferrers:JSON.stringify(r.httpReferrers),privileges:JSON.stringify(r.privileges)}:{itemId:e,appType:r.appType,redirect_uris:s,url:r.url});try{return{result:await(0,d.r)(i,a,{},"post")}}catch(e){return console.error("error:",e),{error:{code:"unhandledError"}}}}async function E(e){try{return{result:await(0,d.r)(e,{},{addTokenManually:!1}),error:null}}catch(e){return console.error("error:",e),{result:null,error:{code:"appExtensionError"}}}}const R="hiddenMapDiv",F=()=>{const e=document.getElementById(R);e&&e.parentNode.removeChild(e)},C=(e=200,t=130)=>{let r=document.getElementById(R);r||(r=document.createElement("div"),r.id=R,r.style.position="absolute",r.style.left="-1000px",r.style.top="-1000px",r.style.width=`${e}px`,r.style.height=`${t}px`,document.body.appendChild(r));const i=document.createElement("div"),a="hiddenMap";return i.id=a,i.style.width=`${e}px`,i.style.height=`${t}px`,r.appendChild(i),a};async function N(e,t){const[r,i,a,s]=await(0,p.l)(["esri/tasks/PrintTemplate","esri/tasks/PrintParameters","esri/tasks/PrintTask","esri/config"]),n=new r;n.layout="MAP_ONLY",n.format="png32",n.preserveScale=!1,n.showAttribution=!1,n.showLabels=!1,n.exportOptions={width:600,height:400,dpi:96};const o=new a(t.self.helperServices.printTask.url,{}),l=new i;return l.map=e,l.template=n,s.defaults.io.timeout=12e4,new Promise(((t,r)=>{o.execute(l,(r=>{s.defaults.io.timeout=6e4,function(e){var t;e.destroy(),null===(t=document.getElementById("hiddenMapDiv"))||void 0===t||t.removeChild(document.getElementById("hiddenMap"))}(e),t(r.url)}),(e=>{s.defaults.io.timeout=6e4,r(e)}))}))}async function A(e,t,r){var a;const s=i.c.api,[n]=await(0,p.l)([3===s?"esri/tasks/Geoprocessor":"esri/rest/geoprocessor"]),{portal:o}=i.c;(null!==(a=e.baseMap.baseMapLayers)&&void 0!==a?a:[]).forEach((e=>{delete e.resourceInfo})),e.mapOptions={showAttribution:!1,extent:{xmin:t[0][0],ymin:t[0][1],xmax:t[1][0],ymax:t[1][1],spatialReference:{wkid:4326}},spatialReference:r},e.exportOptions={dpi:96,outputSize:[600,400]},e.layoutOptions={};const l={Web_Map_as_JSON:JSON.stringify(e),Format:"PNG32",Layout_Template:"MAP_ONLY"};if(3===s){const e=new n(o.helperServices.printTask.url);return new Promise(((t,r)=>{e.execute(l).then((e=>{if(e){let i=!1;for(let r=0;r<e.length;r++)if("Output_File"===e[r].paramName){t(e[r].value.url),i=!0;break}i||r()}}))}))}const{results:c}=await n.execute(o.helperServices.printTask.url,l),u=c.find((e=>"data-file"===e.dataType&&e)).value.url;if(!u)throw new Error("Failed to create thumbnail");return u}async function D(e,t){return await async function(e,t){const{config:r}=i.c,a={item:{extent:t},itemData:e};try{const[e]=await(0,p.l)(["esri/arcgis/utils"]);e.arcgisUrl=`${(0,d.g)()}content/items`;const t=C(),s=await e.createMap(a,t,{mapOptions:{nav:!1},bingMapsKey:r.self.bingKey,geometryServiceURL:i.c.portal.helperServices.geometry.url}),n=function(e){return new Promise((t=>{e._heatmapManager?e._heatmapManager.on("recalculateHeatmap",t):t()}))},o=e=>{const t=[0];return new Promise((r=>{const i=setInterval(((e,t)=>{var a;(null===(a=e.graphics)||void 0===a?void 0:a.length)||t[0]>10?(clearInterval(i),r()):t[0]=t[0]+1}),500,e,t)}))},l=e=>new Promise((t=>{"esri.layers.VectorTileLayer"===e.declaredClass&&setTimeout(t,5e3),e.on("update-start",(()=>{c(e).then(t)}))})),c=function(e){return new Promise((t=>{if(!e.updating)return t();"esri.layers.VectorTileLayer"===e.declaredClass&&setTimeout(t,1e4),e.on("update-end",t)}))},{map:u}=s,y=[];return u.graphicsLayerIds.forEach((e=>{var t;const r=u.getLayer(e);"heatmap"===(null===(t=r.renderer)||void 0===t?void 0:t.type)?y.push(n(r)):"esri.layers.WFSLayer"===r.declaredClass?y.push(o(r)):r.updating&&y.push(c(r))})),u.layerIds.forEach((e=>{const t=s.map.getLayer(e);t.updating?y.push(c(t)):"esri.layers.VectorTileLayer"===t.declaredClass&&y.push(l(t))})),y.length?(await Promise.all(y),new Promise((e=>{setTimeout((async()=>{e(await N(s.map,r))}),1e3)}))):await N(s.map,r)}catch(e){throw new Error(`Map creation failed: ${JSON.stringify(e)}`)}}(e,t)}async function W(e){var t;const[r]=await(0,p.l)([4===i.c.api?"esri/geometry/SpatialReference":"esri/SpatialReference"]),{config:a,portal:s}=i.c,n={};n.baseMap=a.defaultBasemap||s.defaultBasemap,n.baseMap.title="basemap",n.operationalLayers=[];let o=e.url;o||"KML"!==e.type||(o=a.restBaseUrl+"content/items/"+e.id+"/data");const l=new URL(a.restBaseUrl).hostname;if(o.indexOf(l)>-1){const e=null===(t=null==a?void 0:a.userInfo)||void 0===t?void 0:t.token;e&&(o+="?token="+e)}n.operationalLayers.push({url:o,id:"KML_"+Math.random(),opacity:1,title:e.title,visibility:!0,type:"KML"});let c=[];if("string"==typeof e.extent){const t=e.extent.split(",");c=[[parseFloat(t[0]),parseFloat(t[1])],[parseFloat(t[2]),parseFloat(t[3])]]}else c=e.extent&&e.extent.length>0?e.extent:[[-180,-90],[180,90]];return A(n,c,new r({wkid:4326}))}const G={xmax:2e7,xmin:-2e7,ymax:2e7,ymin:-2e7,spatialReference:{wkid:102100}};function J(e,t){const r={102113:[-20037508.342788905,20037508.342788905],102100:[-20037508.342788905,20037508.342788905],3785:[-20037508.342788905,20037508.342788905],3857:[-20037508.342788905,20037508.342788905],4326:[-180,180]}[e];if(r&&t.xmin>t.xmax){const e=r[1]-t.xmin,i=t.xmax-r[0];e>i?t.xmax=r[1]+i:t.xmin=r[0]-e}}function _(e,t){var r,i;const a="ImageServer"!==t?null==e?void 0:e.spatialReference:null===(r=null==e?void 0:e.extent)||void 0===r?void 0:r.spatialReference;return a?a.wkid?a.wkid:-1!==(null===(i=a.wkt)||void 0===i?void 0:i.search(/^PROJCS/i))?/^PROJCS\["[A-Za-z0-9_]*/i.exec(a.wkt)[0].split("[")[1]:null:null}async function V(e){var t,r;const[s]=await(0,p.l)([4===i.c.api?"esri/geometry/SpatialReference":"esri/SpatialReference"]),n=(null===(t=null==e?void 0:e.spatialReference)||void 0===t?void 0:t.wkid)||(null===(r=null==e?void 0:e.spatialReference)||void 0===r?void 0:r.wkt),o=new s({wkid:4326}),l=await async function(e,t){const r=[102113,102100,3857];return!!((null==e?void 0:e.wkt)==(null==t?void 0:t.wkt)&&((null==e?void 0:e.wkid)==(null==t?void 0:t.wkid)||(0,a.i)(e.latestWkid)&&(null==e?void 0:e.latestWkid)==(null==t?void 0:t.wkid))||(0,a.i)(null==t?void 0:t.latestWkid)&&(null==e?void 0:e.wkid)==(null==t?void 0:t.latestWkid)||(0,a.i)(null==e?void 0:e.latestWkid)&&(null==e?void 0:e.latestWkid)==(null==t?void 0:t.latestWkid))||!!((null==e?void 0:e.wkid)&&(null==t?void 0:t.wkid)&&r.includes(null==e?void 0:e.wkid)&&r.includes(null==t?void 0:t.wkid))}(o,null==e?void 0:e.spatialReference);return n&&!l?await q(e,o):e}async function K(e,t){const{portal:r}=i.c,[a,s]=await(0,p.l)(4===i.c.api?["esri/geometry/support/webMercatorUtils","esri/rest/geometryService"]:["esri/geometry/webMercatorUtils","esri/tasks/GeometryService"]),n=[102113,102100,3857],o=e.spatialReference.wkid;if(o===t.wkid)return[e];let l;return 4326===o&&n.indexOf(t.wkid)>-1?(e.ymin=Math.max(e.ymin,-89.99),e.ymax=Math.min(e.ymax,89.99),l=a.geographicToWebMercator(e),J(t.wkid,l),l.spatialReference.wkid=t.wkid,[l]):n.indexOf(o)>-1&&4326===t.wkid?(l=a.webMercatorToGeographic(e),J(t.wkid,l),[l]):new Promise((async(a,n)=>{const o=4===i.c.api?s:new s(r.helperServices.geometry.url),l=e=>{const t=null==e?void 0:e[0];if("extent"!==(null==t?void 0:t.type)||isNaN(e[0].xmin)||isNaN(e[0].ymin)||isNaN(e[0].xmax)||isNaN(e[0].ymax)){if("point"!==(null==t?void 0:t.type)||isNaN(e[0].x)||isNaN(e[0].y))throw new Error;a(e)}else a(e)};if(4===i.c.api)try{const[i]=await(0,p.l)(["esri/rest/support/ProjectParameters"]),a=new i({geometries:[e],outSpatialReference:t});l(await o.project(r.helperServices.geometry.url,a))}catch(e){throw new Error(e)}else o.project([e],t,l,(e=>{n(e)}))}))}async function q(e,t){var r;const[i]=await(0,p.l)(["esri/geometry/Extent"]),a=new i(G),s=new i(e),n=await K(s,t);return"extent"===(null===(r=null==n?void 0:n[0])||void 0===r?void 0:r.type)?n[0]:a}async function z(e,t){const{api:r}=i.c,[a]=await(0,p.l)([4===r?"esri/geometry/SpatialReference":"esri/SpatialReference"]),[s,n]=await(0,p.l)(["esri/layers/FeatureLayer","esri/layers/StreamLayer"]);if(!e||!(e instanceof s)||e instanceof n)return t;if(3===r){await e.addPlugin("esri/plugins/FeatureLayerStatistics");const r=await e.statisticsPlugin.getSuggestedScaleRange(),{minScale:i,center:s,relaxedMinScale:n}=r;if(!s)return t;{let e=await H(s,1280,i);if(r.relaxedMinScale>0){let t=B(e,200),r=800;for(;t>n&&(e=H(s,r,i),t=B(e,200),r-=200,!(r<=0)););}try{const t=await K(e,new a({wkid:4326}));return[[t[0].xmin,t[0].ymin],[t[0].xmax,t[0].ymax]]}catch(e){return t}}}return t}async function B(e,t){const[r,i]=await(0,p.l)(["esri/config","esri/WKIDUnitConversion"]),a=e.spatialReference,s=null==a?void 0:a.wkid,n=null==a?void 0:a.wkt;let o=null;if(s)o=i.values[i[s]];else if(-1!==(null==n?void 0:n.search(/^PROJCS/i))){const e=/UNIT\[([^\]]+)\]\]$/i.exec(n);(null==e?void 0:e[1])&&(o=parseFloat(e[1].split(",")[1]))}return e.getWidth()/t*(o||20015077/180)*39.37*r.defaults.screenDPI}async function H(e,t,r){const[i]=await(0,p.l)(["esri/geometry/Extent"]);return async function(e,t,r){const[i,a]=await(0,p.l)(["esri/config","esri/WKIDUnitConversion"]),s=a;let n,o,l=e.spatialReference;l&&(n=l.wkid,o=l.wkt);let c=null;if(n)c=s.values[s[n]];else if(o&&-1!==o.search(/^PROJCS/i)){const e=/UNIT\[([^\]]+)\]\]$/i.exec(o);(null==e?void 0:e[1])&&(c=parseFloat(e[1].split(",")[1]))}return e.expand(r*t/(39.37*(c||20015077/180)*i.defaults.screenDPI)/e.getWidth())}(new i(e.x-1,e.y-.5,e.x+1,e.y+.5,e.spatialReference),t,r)}function Q(e,t=4){if(!e)return Q(G);if("string"==typeof e)return e;if(Array.isArray(e)){if(Array.isArray(e[0])&&Array.isArray(e[1])){let t,r;return 2===e[0].length&&(t=e[0],r=e[1]),4!==e[0].length&&6!==e[0].length||(t=[e[0][0],e[0][1]],r=[e[0][2],e[0][3]],6===e[0].length&&(r=[e[0][3],e[0][4]])),`${t.join(",")},${r.join(",")}`}return e.join(",")}return`${e.xmin.toFixed(t)},${e.ymin.toFixed(t)},${e.xmax.toFixed(t)},${e.ymax.toFixed(t)}`}async function X(e,t,r){const[i,a]=await(0,p.l)(["esri/config","esri/layers/KMLLayer"]);if(3===r?i.defaults.kmlService=t.kmlService:i.kmlServiceUrl=t.kmlService,4===r){const t=new a({url:e});return await t.load(),Q(t.fullExtent)}const s=new a(e);return new Promise(((e,t)=>{s.on("load",(async()=>{const t=await async function(e){const[t]=await(0,p.l)(["esri/graphicsUtils"]);let r;return e.getLayers().forEach((e=>{var i;if((null===(i=e.graphics)||void 0===i?void 0:i.length)>0){const i=t.graphicsExtent(e.graphics);r=r?r.union(i):i}})),r}(s);e(t?Q(t):void 0)})),s.on("error",t)}))}const Y=async(e,t,r,i,a)=>{try{const s=t.isPortal?r:`https://${t.portalHostname}/sharing/rest`,n=t.portalHostname?`${s}/content/items/${e}/data`:`${(0,u.g)(e)}/data`,o=await X(n,i,a);return{result:await(0,u.e)(e,{url:n,extent:o})}}catch(e){return console.error(e),{error:{code:"unhandledError"}}}};async function Z(e){if(4===i.c.api)return"imagery-tile"==e.type;const[t]=await(0,p.l)(["esri/layers/RasterXLayer"]);return e instanceof t}async function ee(e){if(4===i.c.api)return"imagery"===e.type;const[t,r]=await(0,p.l)(["esri/layers/ArcGISImageServiceLayer","esri/layers/ArcGISImageServiceVectorLayer"]);return e instanceof t||e instanceof r}const te={type:"esriSMS",style:"esriSMSCircle",color:[34,114,162,128],size:6,outline:{color:[34,114,162,255],width:1}},re={type:"esriSLS",style:"esriSLSSolid",color:[77,77,77,255],width:1.5},ie={type:"esriSFS",style:"esriSFSSolid",color:[227,139,79,204],outline:{type:"esriSLS",style:"esriSLSSolid",color:[255,255,255,255],width:.75}};async function ae(e){const[t,r]=await(0,p.l)(["esri/renderers/SimpleRenderer",4===i.c.api?"esri/geometry/support/jsonUtils":"esri/symbols/jsonUtils"]);switch(e){case"esriGeometryPoint":return new t(r.fromJson(te)).toJson();case"esriGeometryPolyline":return new t(r.fromJson(re)).toJson();case"esriGeometryPolygon":return new t(r.fromJson(ie)).toJson()}}async function se(e){const{fields:t,selectedLayer:r}=e;if(null==t?void 0:t.length){const i=t.filter((e=>"esriFieldTypeGeometry"!==e.type));if(null==i?void 0:i.length)return async function(e,t){var r,i;const a=e.displayField,s=e.name+((null==a?void 0:a.length)?`: {${a}}`:"");let n=e.fields,o=!1,l=!1,c=!1;const u=await ee(t),d=await Z(t);if(u||d){const e={rasterAttributeTableFieldPrefix:"Raster."};n=null===(r=t.getCustomRasterFields)||void 0===r?void 0:r.call(t,e),c=["F32","F64"].indexOf(t.pixelType)<0,(null==t?void 0:t.capabilities)&&(o=(null==t?void 0:t.capabilities.toLowerCase().indexOf("catalog"))>-1||(null===(i=t.fields)||void 0===i?void 0:i.length)>0,l=o&&("esriImageServiceDataTypeVector-UV"===t.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===t.serviceDataType))}const p={esriFieldTypeDouble:1,esriFieldTypeSingle:1},y={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},v={esriFieldTypeDate:1};let m=",";e.editFieldsInfo&&(e.editFieldsInfo.creatorField&&(m+=`${e.editFieldsInfo.creatorField},`),e.editFieldsInfo.creationDateField&&(m+=`${e.editFieldsInfo.creationDateField},`),e.editFieldsInfo.editorField&&(m+=`${e.editFieldsInfo.editorField},`),e.editFieldsInfo.editDateField&&(m+=`${e.editFieldsInfo.editDateField},`),m=m.toLowerCase());const f={title:s,fieldInfos:n.map((r=>{let i="esriFieldTypeOID"!==r.type&&"esriFieldTypeGlobalID"!==r.type&&"esriFieldTypeGeometry"!==r.type,a=null,s=r.editable&&"esriFieldTypeOID"!==r.type&&"esriFieldTypeGlobalID"!==r.type;if(i){let s=r.name.toLowerCase(),n=`${m}stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,`;o&&(n=`${n}raster.itempixelvalue,`,l&&(n=`${n}raster.magnitude,raster.direction,`)),(n.indexOf(`,${s},`)>-1||s.indexOf("shape")>-1||s.indexOf("perimeter")>-1||s.indexOf("objectid")>-1||s.indexOf("raster.servicepixelvalue.")>-1||s.indexOf("_i")==s.length-2)&&(i=!1),r.type in y?a={places:0,digitSeparator:!0}:r.type in p?a={places:c&&(s.indexOf("raster.servicepixelvalue")>-1||s.indexOf("raster.itempixelvalue")>-1)?0:2,digitSeparator:!0}:r.type in v&&(e.currentVersion>=10||(null==t?void 0:t.version)>=10)&&(a={dateFormat:"longMonthDayYear"})}return s=s?-1===m.indexOf(`,${r.name.toLowerCase()},`):s,{fieldName:r.name,label:r.alias,isEditable:s,tooltip:"",visible:i,format:a,stringFieldOption:"textbox"}})),description:null,showAttachments:!0,mediaInfos:[],layerOptions:void 0};return ee(t)?(f.layerOptions={},f.layerOptions.showNoDataRecords=!0,f.layerOptions.returnTopmostRaster=!0):Z(t)&&(f.layerOptions={},f.layerOptions.showNoDataRecords=!0),f}({name:(null==r?void 0:r.title)||"",fields:t},e)}}const ne=e=>{var t;const r=i.c.portal;return e.thumbnailURL&&(e.thumbnailURL=function(e){var t;return(null===(t=null==e?void 0:e.staticImagesUrl)||void 0===t?void 0:t.replace("http:","https:"))||""}(r)+e.thumbnailURL),r.isPortal&&0!==(null===(t=e.thumbnailURL)||void 0===t?void 0:t.indexOf("http"))&&(e.thumbnailURL=window.location.protocol+"//"+window.location.host+e.thumbnailURL),e},oe=(e,t)=>{const[r,i]=e.split("?");return`${r}${(null==i?void 0:i.split("&").reduce(((e,r)=>{const[i]=r.split("=");return-1===t.indexOf(i.toLowerCase())?`${e}${e?"&":"?"}${r}`:e}),""))||""}`},le=async e=>{var t;const[r]=await(0,p.l)(["esri/layers/WMSLayer"]),{customParameters:a}=e,s=j(a),n=oe(e.url,["service","request","bbox","format","height","width","layers","srs","crs","styles","transparent","bgcolor","exceptions","time","elevation","sld","wfs"]);try{if(4===i.c.api){const i=new r({url:n,customParameters:Object.assign({},null==s?void 0:s.customParameters)||{},customLayerParameters:Object.assign({},null==s?void 0:s.customLayerParameters)||{}});try{const t=await i.load();return e.type="WMS",{result:Object.assign(Object.assign({},e),{type:"WMS",serviceInfo:t})}}catch(e){return{error:{code:e.message?"unhandledError":"serviceNotExist",message:null!==(t=e.message)&&void 0!==t?t:e.message}}}}await pe(n);const a=new r(n,{customParameters:Object.assign({},null==s?void 0:s.customParameters)||{},customLayerParameters:Object.assign({},null==s?void 0:s.customLayerParameters)||{}}),o=await new Promise(((t,r)=>{a.on("load",(()=>{e.type="WMS",t(Object.assign(Object.assign({},e),{type:"WMS",serviceInfo:a}))})),a.on("error",(e=>{var t;const{error:i}=e,a=!(null==i?void 0:i.message)||404===(null==i?void 0:i.status);r({code:a?"serviceNotExist":"unhandledError",message:null!==(t=i.message)&&void 0!==t?t:e.message})}))}));return{result:o}}catch(e){return console.error(e),{error:e}}},ce=async e=>{const t=4===i.c.api?await e.load():e,{layerInfos:r,title:a,allSublayers:s}=t;return{title:a,layers:(n=4===i.c.api?s.items:r,n.map((e=>({name:e.name,visible:!1,title:e.title.replace(/ /g,String.fromCharCode(160)),extent:e.extent,legendURL:e.legendURL,queryable:e.queryable,subLayers:e.subLayers||[]}))))};var n};function ue(e=[],t){return delete t.id,t.subLayers&&t.subLayers.length?t.subLayers.reduce(ue,e):[...e,t]}const de=(e,t)=>JSON.stringify({title:e.title||"",url:e.url,mapUrl:e.getMapURL,version:e.version,layers:t,copyright:e.copyright||"",maxHeight:e.maxHeight,maxWidth:e.maxWidth,spatialReferences:e.spatialReferences,format:"png"!==e.getImageFormat()?e.getImageFormat():null,featureInfoUrl:e.getFeatureInfoURL,featureInfoFormat:e.featureInfoFormat,customParameters:e.customParameters||{},customLayerParameters:e.customLayerParameters||{}});async function pe(e){var t,r,i;try{const a=await fetch(e);if("cors"===a.type&&200===a.status){const a=new URL(e).hostname,[s]=await(0,p.l)(["esri/config"]);null===(i=null===(r=null===(t=null==s?void 0:s.defaults)||void 0===t?void 0:t.io)||void 0===r?void 0:r.corsEnabledServers)||void 0===i||i.push(a)}}catch(e){}}const ye=async(e,t)=>{const[r]=await(0,p.l)(["esri/layers/WFSLayer"]),{customParameters:a}=o.a,{url:s}=e,n=oe(s,["version","service","request","layer","typename"]),l=j(a),c=await(async e=>{const{query:t}=await(0,v.c)(e);return(null==t?void 0:t.version)||"2.0.0"})(s),u=t||{version:c,url:n,customParameters:(null==l?void 0:l.customParameters)||{}};try{if(4===i.c.api){if("2.0.0"!==c)return{error:{code:"unsupportedWFSVersion"}};delete u.version,delete u.url;const[t]=await(0,p.l)(["esri/layers/ogc/wfsUtils"]),i=await t.getCapabilities(n,u),a=i.featureTypes;if(a&&a.length){const s=await t.getWFSLayerInfo(i),o=r.fromWFSLayerInfo(s);return o.layers=a,o.url=n,o.isComplex="esriGeometryComplex"===o.geometryType,{result:Object.assign(Object.assign({},e),{type:"WFS",serviceInfo:o})}}return{error:{code:"emptyFeatureLayer"}}}const t=new r(u);return await pe(n),{result:await new Promise(((r,i)=>{t.initialize(u,(a=>{a&&a.length?(t.layers=a,t.url=n,t.isComplex="esriGeometryComplex"===t.geometryType,r(Object.assign(Object.assign({},e),{type:"WFS",serviceInfo:t}))):i({code:"emptyFeatureLayer"})})),t.on("error",(async()=>{if("2.0.0"===t.toJson().version){const{result:t,error:a}=await ye(e,{version:"1.1.0",url:s});a&&i(a),r(t)}else if("1.1.0"===t.toJson().version){const{result:t,error:a}=await ye(e,{version:"1.0.0",url:s});a&&i(a),r(t)}else i({code:"serviceNotExist"})}))}))}}catch(e){return console.error(e),{error:e}}};async function ve(e,t){const[r]=await(0,p.l)(["esri/layers/WMTSLayer"]),{customParameters:a,url:s}=e,n=j(a),o=Object.assign(Object.assign({},t),{customLayerParameters:(null==n?void 0:n.customLayerParameters)||{},customParameters:(null==n?void 0:n.customParameters)||{}})||await Object.assign(Object.assign({},async function(e){var t,r;const i=await(0,v.c)(e),a=(null===(t=i.query)||void 0===t?void 0:t.service)||"",s=(null===(r=i.query)||void 0===r?void 0:r.request)||"";return"wmts"===a.toLowerCase()&&"getcapabilities"===s.toLowerCase()||e.toLowerCase().indexOf("/1.0.0/wmtscapabilities.xml")>-1?{serviceMode:"KVP"}:{}}(s)),{customLayerParameters:(null==n?void 0:n.customLayerParameters)||{},customParameters:(null==n?void 0:n.customParameters)||{}}),l=oe(s,["version","service","request","layer","style","format","tilematrixset","tilematrix","tilerow","tilecol"]),c=l.replace(/\/1.0.0\/wmtscapabilities.xml/i,"");try{if(4===i.c.api){const t=new r(c,o),i=t;await i.load();const a=i.sublayers.toArray();return a&&a.length?(t.layers=a,{result:Object.assign(Object.assign({},e),{type:"WMTS",serviceInfo:t})}):{error:{code:"serviceNotExist"}}}await pe(l);const t=new r(c,o);let a;return{result:await new Promise(((r,i)=>{t.on("load",(({layer:s})=>{a=s.layers,a&&a.length?(t.layers=a,r(Object.assign(Object.assign({},e),{type:"WMTS",serviceInfo:t}))):i(new Error("serviceNotExist"))})),t.on("error",(t=>{var a;o.serviceMode?("The WMTS capabilities XML is not valid"===(null===(a=t.error)||void 0===a?void 0:a.message)&&i({code:"invalidWMTS"}),i({code:"serviceNotExist"})):ve(e,{serviceMode:"KVP"}).then((({result:e,error:t})=>{t&&i(t),r(e)}),i)}))}))}}catch(e){return console.error(e),{error:e}}}async function me(e){if(!e)return Promise.reject("serviceNotExist");const{serviceInfo:t,selectedLayer:r,selectedTileInfo:a}=e;if(!r)return Promise.reject(new Error("layerNotSelected"));if(!a)return Promise.reject(new Error("missingGeometry"));t.selectedTileInfo=a;const{wmtsConfig:s,fullExtent:n}=await async function(e){var t;const r=4===i.c.api;try{const[a]=await(0,p.l)([r?"esri/geometry/SpatialReference":"esri/SpatialReference"]),{selectedLayer:s,selectedTileInfo:n,copyright:o}=e,l=(null==n?void 0:n.fullExtent.spatialReference)||new a({wkid:4326}),c=await K(null==s?void 0:s[r?"fullExtent":"gcsExtent"],l).then((e=>{var t;return"extent"===(null===(t=null==e?void 0:e[0])||void 0===t?void 0:t.type)?4===i.c.api?e[0]:e[0].toJson():null})),u=s[r?"imageFormat":"formats"].indexOf("image/png")>-1?"image/png":s.formats[0];let d;e.resourceUrls=s.resourceUrls,d=r?e.getUrlTemplate(s.id,n.id,u,s.styleId):e.getTileUrlTemplate({identifier:s.identifier,tileMatrixSet:n.tileMatrixSet,format:u});const y={templateUrl:d,copyright:function(e){return"none"!==(null==e?void 0:e.toLowerCase())?(null==e?void 0:e.length)>180?`${e.substring(0,180)}..`:"":e}(o),fullExtent:c||e.selectedTileInfo.fullExtent,tileInfo:function(e){const{tileInfo:t}=e;return 96!==(null==t?void 0:t.dpi)&&(t.lods.forEach((e=>{e.scale=96*e.scale/t.dpi})),t.dpi=96),r?t:t.toJson()}(n),wmtsInfo:{url:null!==(t=e.wmtsUrl)&&void 0!==t?t:e.url,layerIdentifier:s.identifier,tileMatrixSet:n.tileMatrixSet,customParameters:e.customParameters||{},customLayerParameters:e.customLayerParameters||{}}};return Promise.resolve({wmtsConfig:y,fullExtent:c})}catch(e){throw console.error(e),e}}(t).catch((e=>{throw console.error("Error getting WMTS config",e),e})),o=t.selectedLayer[4===i.c.api?"fullExtent":"gcsExtent"],l=n?o:{xmin:-180,ymin:-90,xmax:180,ymax:90},c={type:e.type,url:e.url,thumbnailURL:e.thumbnailURL},y=Object.assign(Object.assign({},ne(c)),{url:s.wmtsInfo.url,text:JSON.stringify(s),extent:`${l.xmin},${l.ymin},${l.xmax},${l.ymax}`}),v=await Me(y),m=Object.assign(Object.assign(Object.assign({},y),v),{extent:[[l.xmin,l.ymin],[l.xmax,l.ymax]]});try{const e=await async function(e,t){if(3===i.c.api){const r={opacity:1,visibility:!0,layerType:"WebTiledLayer",type:"WebTiledLayer"},a={baseMap:{title:"basemap",baseMapLayers:[],operationalLayers:[]}};if(e.id){const t=await async function(e){const{config:t}=i.c,r=`${t.restBaseUrl}content/items/${e}/data`;try{const e=await(0,d.r)(r,null,{disableIdentityLookup:!0});return e&&((null==e?void 0:e.wfsInfo)||e.wmtsInfo)?e:(null==e?void 0:e.layers)?e.layers:{}}catch(e){return e}}(e.id);a.baseMap.baseMapLayers.push(Object.assign(Object.assign({},t),r))}else a.baseMap.baseMapLayers.push(r);return D(a,t||e.extent)}{const[t,r,a,s]=await(0,p.l)(["esri/layers/WMTSLayer","esri/Map","esri/views/MapView","esri/core/reactiveUtils"]),n=new t({portalItem:{id:e.id,portal:i.c.portal}}),o=new r({layers:[n]}),l=new a({container:C(),map:o});return await s.whenOnce((()=>!l.updating)),await l.goTo(n.fullExtent),(await l.takeScreenshot({width:l.width,height:l.height,format:"png"})).dataUrl}}(m),t=4===i.c.api?{type:"base64",data:e}:{type:"url",url:e},r=await(0,u.i)(v.id,t);return Object.assign(Object.assign({},m),r)}catch(e){return console.error("Error when adding WMTS URL:",e),m}}function fe(e){var t,r;if(!e)return;const{title:i,description:a}=e;n.i.title=null!==(t=null!=i?i:n.i.title)&&void 0!==t?t:"",n.i.snippet=null!==(r=null!=a?a:n.i.snippet)&&void 0!==r?r:"",o.a.selectedLayer=e}async function ge(e,t={},r=!0){const{links:a}=e,s=we(a,"data","application/json")||we(a,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(null==s)throw new Error("Missing collections url");return 3===i.c.api?(0,d.r)(S(s.href),{},Object.assign(Object.assign({},t),{addTokenManually:!1}),"auto",{v3Request:{headers:{accept:"application/json"}},excludeJson:r}):(0,d.r)(S(s.href),{},Object.assign(Object.assign({},t),{addTokenManually:!1,headers:{accept:"application/json"}}),"auto",{excludeJson:r})}function we(e,t,r){return e.find((e=>e.rel===t&&e.type===r))||e.find((e=>e.rel===t&&!e.type))}const he=(e,t)=>{const{newItemMode:r,typeKeywords:a,tags:s,extent:l,selectedServiceInfoLayersNames:c,addFeatureLayerType:d}=o.a,p=n.i.title;switch((null==p?void 0:p.length)>250&&(n.i.title=p.substring(0,250)),r){case"application":return $(e,t);case"file":return Se();case"url":return Te(e,i.c.config,i.c.api);case"featureLayer":return He({serviceInfo:e.serviceInfo,typeKeywords:a,tags:s,extent:l,selectedServiceInfoLayersNames:c,addFeatureLayerType:d});default:return(0,u.c)(Object.assign({},e))}},be=async()=>{try{const e=o.c,t=await he(e,"");o.a.id=t.id;const r=await ke(o.a.id,{success:t.success});if("failed"===r.status)throw r.statusMessage;return{}}catch(e){console.error(e);const t=(null==e?void 0:e.statusMessage)||e||"";switch(!0){case t.includes("Invalid File Geodatabase"):return{error:{code:"invalidFileGeodatabase"}};case t.includes("Invalid Shapefile"):return{error:{code:"invalidShapefile"}};case t.includes("The request size is greater than the max allowed of 1024MB"):return{error:{code:"exceedsFileSize"}};default:return{error:{code:"unhandledError"}}}}},Se=async e=>{const t=o.a.file,r=o.a.dataUrl;return!t&&r?xe(e):(null==t?void 0:t.size)>P||"Esri Classifier Definition"===o.a.type?Ie():async function(){const e=(0,u.n)(i.c.user,n.i.folder),t=(0,u.k)(n.i,o.a);try{return await(0,d.e)(e,t,{},"post")}catch(e){throw(null==e?void 0:e.message)||e}}()},xe=async e=>{var t;const r=(0,u.n)(i.c.user,n.i.folder),{fileName:a,dataUrl:s,extension:l}=o.a,c=(0,u.j)(n.i,o.a),p=!!o.a.overwrite,y=(null==s?void 0:s.includes("/query?"))&&(null==a?void 0:a.includes("query"))&&(null==l?void 0:l.includes("json"))?{filename:(0,g.g)(),dataUrl:s}:{},v=Object.assign(Object.assign(Object.assign({},c),{async:!0,filename:null!==(t=null==e?void 0:e.filename)&&void 0!==t?t:a,title:null==e?void 0:e.title,overwrite:p}),y);return(0,d.r)(r,v,{},"post")};async function Oe(e,t,r=0){const a=i.c.user;try{const{partData:s,formData:n}=e,o=`?streamdata=true&size=${s.size}&partNum=${s.partNum}&f=json`,l=`${a.userContentUrl}/items/${t}/addPart${o}`;return{response:await(0,d.e)(l,n,{"X-Esri-Authorization":`Bearer ${(0,d.h)(i.c.portal)}`},"post"),attempts:r,partSize:s.size}}catch(i){if(!o.a.id)throw"cancelled";if(++r>5)throw new Error("Upload failed - too many attempts");return Oe(e,t,r)}}const Ie=async()=>{var e,t,r,a;let s=!0;const l=()=>{if(o.a.id){s=!1;const e=o.a.id;return o.a.id=null,(0,u.o)(e)}},p=k.addSubscriber("addFileMultiPart",l),y=i.c.config,v=(0,u.n)(i.c.user,n.i.folder),{fileName:m,file:f}=o.a;let g,h=null!==(e=y.multiPartBatchSize)&&void 0!==e?e:3,b=0;try{const e=await(0,d.r)(v,{multipart:!0,fileName:m,async:!0},{},"post");g=null!==(t=e.id)&&void 0!==t?t:e.itemId,o.a.id=g,o.a.uploadProgress=0,w.w.uploadProgress=0;let r=0;const a=function*(){const e=o.a.file,{name:t,size:r}=e;let a=26214400,s=Math.ceil(r/a),n=0;for(s>1e4&&(a=Math.ceil(r/1e4),s=Math.ceil(r/a));n<s;){const r=new FormData,s=n*a,o=e.slice(s,s+a);n++;const l={partNum:n,size:o.size};r.append("partNum",String(l.partNum)),r.append("streamdata","true"),r.append("f","json"),r.append("token",(0,d.h)(i.c.portal)),r.append("file",o,t),yield{partData:l,formData:r}}return null}();await(0,c.s)((()=>{const{value:e,done:t}=a.next();return t?null:Oe(e,g)}),{getBatchSize:()=>h,onPromiseCompleted:e=>{const{attempts:t,partSize:i}=e;t>0?(h=Math.max(1,Math.ceil(h/2)),b=0):(b++,b>=h&&(h=Math.min(h+1,10),b=0)),r+=i;const a=Math.floor(r/f.size*100);o.a.uploadProgress=a,w.w.uploadProgress=a},onPromiseThrow(){s=!1},shouldContinue:()=>s&&k.isSubscriberValid(p)}),k.removeSubscriber(p);const{type:n,extension:l,enablePublishing:y,properties:S}=o.a;return await(0,u.l)(g,{file:f,type:n,extension:l,enablePublishing:y,properties:S})}catch(e){throw await l(),console.error(null!==(r=null==e?void 0:e.message)&&void 0!==r?r:e),null!==(a=null==e?void 0:e.message)&&void 0!==a?a:e}},Te=(e,t,r)=>{if(e.agsType)return Fe(e);switch(e.type){case"KML":return async function(e,t,r){try{const[i,a]=await Promise.all([X(e.url,t,r),W(e)]);return await Me(Object.assign(Object.assign({},e),{extent:i,thumbnailURL:a}))}catch(e){throw e}}(e,t,r);case"WMS":return(async e=>{const[t]=await(0,p.l)([4===i.c.api?"esri/geometry/SpatialReference":"esri/SpatialReference"]),{layers:r}=o.a;if(!e||!(null==e?void 0:e.serviceInfo))return Promise.reject(new Error("serviceNotExist"));const a=ne(e),{serviceInfo:s}=a,n=[];let l;const c=r.reduce(ue,[]).map((e=>{l=l?e.extent?l.union(e.extent):l:e.extent,n.push(e.name);const t={name:e.name,title:e.title,legendURL:"",queryable:e.queryable};return e.legendURL&&(t.legendURL=e.legendURL),t}));s.setVisibleLayers(n),l=l||s.fullExtent;const u=!s.spatialReferences.some((e=>e===l.spatialReference.wkid)),d={type:e.type,url:s.url,description:s.description||"",accessInformation:s.copyright||"",text:de(s,c),extent:l};u&&q(l,new t({wkid:s.spatialReferences[0]})).then((e=>d.extent=e));const y=await((e,t)=>new Promise((r=>{const i=t=>{r(Object.assign(Object.assign({},e),{thumbnailURL:t||e.thumbnailURL,extent:Q(e.extent)}))};t.getImageUrl(e.extent,800,532,i,i)})))(d,s);return Me(y)})(e);case"WFS":return(async e=>{var t;if(!e||!(null==e?void 0:e.serviceInfo))return Promise.reject(new Error("serviceNotExist"));const{serviceInfo:r}=e,a=Q((null===(t=r.selectedLayer)||void 0===t?void 0:t.fullExtent)||[[],[]]),s=a.split(",").map(Number);if(!r.geometryType||"none"===r.geometryType)return Promise.reject(new Error("missingGeometry"));const n={type:e.type,url:e.url,thumbnailURL:e.thumbnailURL},l=await async function(e){const{layerNamespace:t,getFeatureUrl:r,spatialReferences:a,fields:s}=e,{maxFeatures:n,geometryType:l}=o.a;let c,u,d,p;if(3===i.c.api){const t=e.toJson();c=t.url,u=t.mode,d=t.version,p=t.name}else{const t=e;c=t.url,d="2.0.0",p=t.name}const y=l||e.geometryType||"esriGeometryComplex";return{url:c,mode:u,wfsInfo:{version:d,name:p,wfsNamespace:t,featureUrl:r,supportedSpatialReferences:a,customParameters:e.customParameters||{},maxFeatures:n||e.maxFeatures||3e3},layerDefinition:{geometryType:y,drawingInfo:{renderer:await ae(y)},spatialReference:{wkid:4326},fields:s},popupInfo:await se(e)}}(r),c=Object.assign(Object.assign({},ne(n)),{text:JSON.stringify(l),extent:a}),u=await Me(c),d=Object.assign(Object.assign(Object.assign({},c),u),{extent:[[s[0],s[1]],[s[2],s[3]]]});try{const e=await async function(e){const{config:t}=i.c,r={baseMap:t.defaultBasemap||t.self.defaultBasemap,operationalLayers:[]},{baseMapLayers:a}=r.baseMap;let s=!1;return a.forEach((e=>{e.isReference||s||(!t.allSSL&&"https:"!=location.protocol||!(0,v.a)(e.url)&&!(0,v.b)(e.url)||(e.url=e.url.replace("http:","https:")),e.visibility=!1,s=!0,r.baseMap.baseMapLayers=[e])})),r.operationalLayers.push({type:"WFS",layerType:"WFS",opacity:1,visibility:!0,id:"wfs_xxx",wfsInfo:{maxFeatures:100}}),A(r,e)}(d.extent);return Object.assign(Object.assign({},d),{thumbnailUrl:e})}catch(e){return d}})(e);case"WMTS":return me(e);case"OGCFeatureServer":return async function(e){const{serviceInfo:t,customParameters:r}=e;return t?(r.length>0&&(e.text=JSON.stringify({customParameters:j(r).customParameters})),Me(e)):Promise.reject(new Error("serviceNotExist"))}(e);default:return Me(e)}},Le=e=>{var t;const{type:r,agsType:i}=e;return[...(null===(t=f.a[null!=i?i:r])||void 0===t?void 0:t.typeKeywords)||[],...e.typeKeywords||[]]},Me=async e=>{const{customParameters:t,agsType:r}=e,{type:i}=(0,m.g)(e.type),a=Object.assign(Object.assign({},e),{typeKeywords:Le(e),type:i});if((null==t?void 0:t.length)>=1&&r){const{customParameters:e}=j(t);a.text=JSON.stringify({customParameters:e})}return(0,u.c)(a)};async function ke(e,t={},r){var a;try{const a=i.c.user,s=null!=r?r:`${a.userContentUrl}/items/${e}/status`,n=(null==t?void 0:t.jobId)?{jobId:t.jobId}:{};return await(0,d.p)(s,{requestParams:n})}catch(r){if(!(null===(a=r.statusMessage)||void 0===a?void 0:a.includes("Item status doesn't exist"))||!t.success)throw console.error(r),r;return{itemId:e,status:"status-not-found",lastUpdatedTime:0,submissionTime:0,recordCount:0}}}async function Pe(e,t){const r=n.i.folder,{user:a}=i.c;return async function(e,t,r,a){const{config:s}=i.c,n=r.id&&"/"!==r.id&&r.id!==e?`/${r.id}`:"",o=`${s.restBaseUrl}content/users/${e}${n}/items/${t}/addResources`;return(0,d.r)(o,a,{},"post")}(a.username,t,r,{fileName:"cloudProvider.json",text:JSON.stringify(e),access:"private"})}async function je(e){const{url:t,thumbnailURL:r,serviceInfo:a,extent:s}=e;if(r)return r;if(!["Map Service","Feature Service","Image Service"].includes(e.type))return null;if(["Map Service","Image Service"].includes(e.type)||-1!==t.indexOf("MapServer")){const e=Q(s);return s?function(e){var t;let r,{visibleLayers:i,serviceUrl:a,serviceInfo:s,size:n,extent:o,bboxSR:l,imageSR:c,format:u}=e;if(!s)return"";let d=a.indexOf("/MapServer")>-1;if(!i&&d){let e;r=a.indexOf("/MapServer");const t=a.indexOf("?");t>-1?(e=a.substring(r+11,t),a=a.substring(0,r+10)+a.substring(t),i=e):(e=a.substring(r+11),a=a.substring(0,r+10),i=e)}!d&&s&&(d=s.capabilities?s.capabilities.toLowerCase().indexOf("map")>-1:s.supportedImageFormatTypes);let p=a;if(r=p.indexOf("?"),-1===r)if(d)p+="/export?";else{if(void 0!==s.currentVersion&&s.currentVersion>=10.1)return p+="/info/thumbnail",p;p+="/exportImage?"}else if(d)p=`${p.substring(0,r)}/export${p.substring(r,p.length)}&`;else{if(void 0!==s.currentVersion&&s.currentVersion>=10.1)return p=`${p.substring(0,r)}/info/thumbnail${p.substring(r,p.length)}`,p;p=`${p.substring(0,r)}/exportImage${p.substring(r,p.length)}&`}return p+=`size=${n}&bbox=${o}`,(null==l?void 0:l.length)>0&&(p+=`&bboxSR=${l}`),(null==c?void 0:c.length)>0&&(p+=`&imageSR=${c}`),d&&(null===(t=null==s?void 0:s.supportedImageFormatTypes)||void 0===t?void 0:t.indexOf("PNG32"))>-1?p+=`&format=png32&f=${u}`:p+=d?`&format=png24&f=${u}`:`&format=jpgpng&f=${u}`,d?(null==i?void 0:i.length)>0&&(p+=`&layers=show:${i}`):p+="&interpolation=RSP_NearestNeighbor&bandIds=null",p}({serviceUrl:t,extent:e,size:"800,532",format:"image",serviceInfo:a}):null}const{result:n,error:o}=await async function(e){var t;const{config:r,portal:a,api:s}=i.c;if(4===s)return{result:await $e(e.id,a)};const[n,o,l]=await(0,p.l)(["esri/IdentityManager","esri/layers/FeatureLayer","esri/geometry/Extent"]),{serviceInfo:c,proxyUrl:u}=e,d={baseMap:r.defaultBasemap||r.self.defaultBasemap,operationalLayers:[]};d.baseMap.title="basemap";const y=d.baseMap.baseMapLayers.length;for(let e=0;e<y;e++){let t=d.baseMap.baseMapLayers[e];if(!t.isReference){!r.allSSL&&"https:"!=location.protocol||!(0,v.a)(t.url)&&!(0,v.b)(t.url)||(t.url=t.url.replace("http:","https:")),t.visibility=!1,d.baseMap.baseMapLayers=[t];break}}if(!c)return{result:""};const m=c.layers||[],f=u||e.url,g=await(0,v.c)(f),w=n.findCredential(g.path);m.reverse().forEach((async t=>{const r={url:`${f}/${t.id}${w?`?token=${w.token}`:""}`,id:`${e.id||Math.random()}_${t.id}`,opacity:1,title:`${e.title||"title"}_${t.id}`,visibility:!0,layerDefinition:void 0};let i=!1;m.forEach((e=>{e.id!==t.id||i||(i=!0,r.layerDefinition=e.layerDefinition)})),(!m.length||m.length&&i)&&d.operationalLayers.push(r)}));let h=[[-180,-90],[180,90]];if("string"==typeof e.extent){const t=e.extent.split(",");h=[[parseFloat(t[0]),parseFloat(t[1])],[parseFloat(t[2]),parseFloat(t[3])]]}else(null===(t=e.extent)||void 0===t?void 0:t.length)>0&&(h=e.extent);if(1===d.operationalLayers.length){let e=new o(d.operationalLayers[0].url);return new Promise((t=>{e.on("load",(async r=>{(null==r?void 0:r.layer)&&(e=r.layer);const i=await z(e,h);try{const e=await D(d,i);t({result:e})}catch(e){t({error:{code:"unhandledError",message:e}})}}))}))}{const t=e.extent,r=B(new l(t[0][0],t[0][1],t[1][0],t[1][1]),200),i=[],a=[],s=[];d.operationalLayers.forEach((e=>{const t=new o(e.url),n=new Promise((s=>{t.on("load",(t=>{i.push(e),a.push(t),t.minScale<=r&&t.maxScale>r?s(!0):s(!1)})),t.on("error",(()=>{s(!1)}))}));s.push(n)}));const n=await Promise.all(s);d.operationalLayers=i;const c=n.filter((e=>e)).length>0;try{if(!c&&a.length>0){const e=await z(a[0],t);return{result:await D(d,e)}}return{result:await D(d,t)}}catch(e){return{error:{code:"unhandledError",message:e}}}}}(e);return o?(console.error("Error generating thumbnail",o),""):n}async function $e(e,t){var r,i,s;const[n,o,l,c,u,d,y,v]=await(0,p.l)(["esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/Basemap","esri/rest/print","esri/rest/support/PrintTemplate","esri/rest/support/PrintParameters","esri/smartMapping/heuristics/scaleRange"]);try{const p=C(800,532),m=t.defaultBasemap.id.includes("basemap"),f=new l({portalItem:{id:e,portal:t}}),g=new n({basemap:m?"topo-vector":new c({portalItem:{id:t.defaultBasemap.id,portal:t}})}),w=new o({map:g,container:p});await g.watch("loaded");let h=0,b=0;m||({minScale:h,maxScale:b}=await v({layer:f,view:w}));const S=await f.queryExtent();w.goTo(S.extent),f.minScale=h,f.maxScale=b,w.map.add(f),w.scale=b,await(0,a.t)(2e3);const x=null!==(s=null===(i=null===(r=t.helperServices)||void 0===r?void 0:r.printTask)||void 0===i?void 0:i.url)&&void 0!==s?s:"https://utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task",O=new y({view:w,template:new d({format:"png32",exportOptions:{dpi:96,width:800,height:532},layout:"map-only",showLabels:!1,attributionVisible:!1})}),I=await u.execute(x,O);return F(),I.url}catch(e){return F(),null}}async function Ue(e){var t;const{config:r}=i.c,{checkAuth:a,storeAuth:n,username:o,password:l}=e;var c;e.title=(c=e.url,(0,s.p)((0,v.d)(c)).serverName);const u=function(e){const t=(0,v.d)(e),r=(0,s.p)(e),i=t.replace(s.v,"").match(s.r);let a=null==r?void 0:r.serverType,n=null==r?void 0:r.index;const o={mapserver:"MapServer",geocodeserver:"GeocodeServer",gpserver:"GPServer",geometryserver:"GeometryServer",geoenrichmentserver:"GeoenrichmentServer",imageserver:"ImageServer",naserver:"NAServer",featureserver:"FeatureServer",geodataserver:"GeoDataServer",globeserver:"GlobeServer",wmserver:"WMServer",sceneserver:"SceneServer",vectortileserver:"VectorTileServer",streamserver:"StreamServer",videoserver:"VideoServer"};return a&&o[a.toLowerCase()]&&(a=o[a.toLowerCase()]),("ags"===a||!a&&i)&&(a="MapServer"),"MapServer"===a&&null!==n?"FeatureServer":a}(e.url);if(!u||"SceneServer"===u&&!r.sceneViewerEnabled)return{error:{code:"unknownAGSType"}};let y=null===(t=f.a[u])||void 0===t?void 0:t.type;y||console.warn(`Unknown AGS Type ${u}`),e.type=y,e.agsType=u;try{if(!i.c.user)return{result:await Re(e)};const t=await Ae({username:o,password:l},e.url,(0,d.g)(i.c.portal),a),r=null==t?void 0:t.allowStoredAuth;if(!1===r&&(e.allowStoredAuth=!1),t.secured){e.isSecured=Object.assign({},t),e.allowStoredAuth=!1;const s=await async function(e,t,r){var a,s;if(499===(null==t?void 0:t.httpStatusCode)){const[t]=await(0,p.l)([3===i.c.api?"esri/IdentityManager":"esri/identity/IdentityManager"]),{url:n,password:o,username:l}=e;let c=null===(a=(await t._getTokenSvcUrl(n)).authInfo)||void 0===a?void 0:a.tokenServicesUrl;if(c){"/"!==c[c.length-1]&&(c+="/");try{const e=await Ae({password:o,username:l},null!=c?c:"",(0,d.g)(),r);return(null==e?void 0:e.secured)&&401===(null==e?void 0:e.httpStatusCode)}catch(e){return(null===(s=null==e?void 0:e.message)||void 0===s?void 0:s.indexOf("Http StatusCode: -1"))>-1&&-1}}}return!1}({username:e.username,password:e.password,url:e.url},t,a);if(s||401===t.httpStatusCode){if(-1===s){const t=Object.assign(Object.assign({},e),{isSecured:null,checkUrlError:!0,storeAuth:!1});return{result:await Re(t)}}{const t=Object.assign(Object.assign({},e),{isSecured:{httpStatusCode:401,isFederatedWithWebTierAuth:s}});return{result:await Re(t)}}}return e.isSecured=Object.assign(Object.assign({},t),{isFederatedWithWebTierAuth:s}),!1!==r&&(e.allowStoredAuth=!0),t.isOverride&&("GeoenrichmentServer"!==u||e.storeAuth?e.storeAuth=!0:e.createAsServiceProxy=!0),a&&!n?{result:await Re(e)}:{result:e}}return{result:await Re(e)}}catch(t){if(I(t)){const e=t.code;if("flowAborted"===e||"unauthorized"===e||"invalidSpatialRef"===e)return{error:t}}try{const r=Object.assign(Object.assign({},e),{isSecured:e.isSecured||null,checkUrlError:t,storeAuth:!1});return{result:await Re(r)}}catch(e){return I(e)?{error:e}:{error:{code:"unhandledError",message:JSON.stringify(e)}}}}}const Ee=3;async function Re(e,t=e.url,r=0){var s,l,c,u,m,f,g,w,h,b,S,x,O,I,L,M,k,P;const[j]=await(0,p.l)([3===i.c.api?"esri/IdentityManager":"esri/identity/IdentityManager"]),{username:$,password:U,checkAuth:E,agsType:R}=e,{tags:F=[]}=n.i||{},C=[499,498],N=(0,v.d)(t);if(!e.isSecured||401!==(null===(s=e.isSecured)||void 0===s?void 0:s.httpStatusCode)&&E||(null===(l=e.checkUrlError)||void 0===l?void 0:l.message)&&e.isSecured&&(0,y.i)(e.type))try{const r=await We({username:$,password:U},N,{isSecure:e.isSecured,isVideoService:"Video Service"===e.type,checkAuth:E});"Image Service"===e.type&&r.tileInfo&&("LERC"===r.tileInfo.format||"elevation"===(null===(c=r.cacheType)||void 0===c?void 0:c.toLowerCase())?e.agsType="ElevationServer":"raster"===(null===(u=r.cacheType)||void 0===u?void 0:u.toLowerCase())&&(e.agsType="TiledImageServer",De(t,r)&&"TiledImageServer"!==o.a.hybridImageServiceSetting&&(e.agsType="ImageServer")));const i=r.credential||j.findCredential(t),s=r.documentInfo,n=((null==s?void 0:s.Keywords)||"").split(","),l=null!==(m=null==s?void 0:s.Title)&&void 0!==m?m:r.name;return e.tags=(0,a.b)([...n,...F]).filter((e=>e)),(null==l?void 0:l.length)>0&&(e.title=l),e.description=null!==(g=null!==(f=null==s?void 0:s.Comments)&&void 0!==f?f:r.description)&&void 0!==g?g:"",e.snippet=null!==(h=null!==(w=null==s?void 0:s.Subject)&&void 0!==w?w:r.serviceDescription)&&void 0!==h?h:"",e=Object.assign(Object.assign({},e),{thumbnailToken:(null==i?void 0:i.token)||null,extent:e.extent||r.fullExtent||r.extent,serviceInfo:Object.assign(Object.assign({},r),{isSecure:!!E,userInfo:{username:$,password:U}})}),Object.assign({},e)}catch(i){if((null===(b=null==i?void 0:i.message)||void 0===b?void 0:b.toLowerCase().includes("aborted"))||"Error: json"===(null==i?void 0:i.message))throw{code:"flowAborted",message:JSON.stringify(i.message.message)};if(C.includes(null!==(S=null==i?void 0:i.code)&&void 0!==S?S:null===(x=null==i?void 0:i.details)||void 0===x?void 0:x.httpStatus))return!1!==e.allowStoredAuth&&(e.allowStoredAuth=!e.checkUrlError),Object.assign(Object.assign({},e),{isSecured:{secured:!0},serviceInfo:{isSecure:!0},allowStoredAuth:!1!==e.allowStoredAuth&&o.a.allowStoredAuth});if(403===(null==i?void 0:i.code))throw e.serviceInfo={isSecure:!0},e.isSecured={secured:!0},{code:"forbiddenCredential",message:JSON.stringify(i)};if(i&&(null===(O=e.checkUrlError)||void 0===O?void 0:O.message)){if(null===(M=null===(L=null===(I=e.checkUrlError)||void 0===I?void 0:I.message)||void 0===L?void 0:L.includes)||void 0===M?void 0:M.call(L,"was not found"))throw{code:"serviceNotExist",message:JSON.stringify(e.checkUrlError.message)};throw{code:"unhandledError",message:JSON.stringify(e.checkUrlError.message)}}if(R&&"FeatureServer"!==R||"string"==typeof i&&i.includes("not found"))throw{code:"serviceNotExist",message:JSON.stringify(i)};if(T(i)&&"The input spatial reference must be either a geographic or projected coordinate system"===i.details[0])throw{code:"invalidSpatialRef",message:JSON.stringify(i)};if(r<Ee)return Re(e,t,r+1)}else if((null===(k=e.isSecured)||void 0===k?void 0:k.isFederatedWithWebTierAuth)||401===(null===(P=e.isSecured)||void 0===P?void 0:P.httpStatusCode))try{const{title:t}=e,r=await(0,d.r)(e.url,{},{addTokenManually:!1}),i=(r.documentInfo.Keywords||"").split(","),s=[...(0,a.b)([...i,...F])];return e=Object.assign(Object.assign({},e),{extent:r.fullExtent||r.extent,serviceInfo:r}),Object.assign(Object.assign({},e),{title:t,tags:s})}catch(e){if(401===e.status)throw{code:"unauthorized"};throw{code:"serviceNotExist",message:JSON.stringify(e)}}}async function Fe(e){const{serviceInfo:t,username:r,password:a,isSecured:s,storeAuth:n,type:o}=e,{user:l,portal:c,config:u}=i.c,p=o,y={username:r,password:a},{thumbnailURL:f}=(0,m.g)(p),g=Object.assign(Object.assign({},e),{thumbnailURL:f||e.thumbnailURL});if((null==t?void 0:t.isSecure)&&!t.userInfo||(null==s?void 0:s.isOverride)&&!y||401!==(null==s?void 0:s.httpStatusCode)&&!y||n&&!y)throw new Error("invalidCredentials");if(s&&n){if(!(!c.isPortal||c.isPortal&&(0,v.e)()))throw new Error;if(g.serviceUsername=r,g.servicePassword=a,401===s.httpStatusCode){const e=await he(g,null==u?void 0:u.restBaseUrl).then((({id:e})=>(0,d.r)(`${l.userContentUrl}/items/${e}`,{},{},"post")));return Ce(Object.assign(Object.assign({},g),{id:e.item.id,url:e.item.url,sourceUrl:e.item.sourceUrl}),!0)}if((null==t?void 0:t.isSecure)&&!(null==t?void 0:t.userInfo))throw new Error("invalidCredentials")}return Ce(g)}async function Ce(e,t=!1){var r,s,n,l;const{url:c,serviceInfo:p,type:y,storeAuth:v,hybridImageServiceSetting:g}=e;let w;if(!p&&!v)throw new Error("serviceNotExist");if(v&&!p){const{response:t,updatedProperties:r}=await async function(e){var t,r,a,s,n,o;const{user:l}=i.c,{type:c,exportTilesAllowed:u}=e,p=await Me(e),{id:y}=p,v=`${l.userContentUrl}/items/${y}`,{item:m}=await(0,d.r)(v,{},{},"post"),f=u?e.url:m.url,g=await Re(Object.assign(Object.assign({},e),{type:c}),f)||{},w=null!==(r=null===(t=g.serviceInfo)||void 0===t?void 0:t.documentInfo)&&void 0!==r?r:{},{tags:h,serviceUsername:b,servicePassword:S,serviceInfo:x,spatialReference:O,extent:I,thumbnailToken:T}=g;let L={};return L.title=null!==(a=null==w?void 0:w.Title)&&void 0!==a?a:"",L.description=null!==(s=null==w?void 0:w.description)&&void 0!==s?s:"",L.snippet=null!==(o=null!==(n=null==w?void 0:w.Subject)&&void 0!==n?n:null==w?void 0:w.serviceDescription)&&void 0!==o?o:"",L.tags=h,L.proxyUrl=m.url,L.serviceUsername=b,L.servicePassword=S,L.serviceInfo=x,L.spatialReference=O,L.extent=I,L.thumbnailToken=T,{response:p,updatedProperties:L}}(e);return await(0,u.d)(t.id,{permanentDelete:!0}),await(0,a.t)(3e3),r}const h=Object.assign(Object.assign({},e),{description:(null==p?void 0:p.description)||(null===(r=null==p?void 0:p.documentInfo)||void 0===r?void 0:r.Comments)||"",accessInformation:(null==p?void 0:p.copyrightText)||(null===(s=null==p?void 0:p.documentInfo)||void 0===s?void 0:s.Credits)||"",spatialReference:_(e.serviceInfo,e.agsType)});if("map service"===(null==y?void 0:y.toLowerCase())&&h.typeKeywords.push((null==p?void 0:p.singleFusedMapCache)?"Tiled":"Dynamic"),("Image Service"===y&&"TiledImageServer"===g||function(e,t){var r,i;return(null===(r=e.toLowerCase())||void 0===r?void 0:r.includes("/imageserver"))&&(null===(i=null==t?void 0:t.capabilities)||void 0===i?void 0:i.toLowerCase().includes("tilesonly"))}(c,p))&&(h.typeKeywords=f.a.TiledImageServer.typeKeywords),"Table"===(null==p?void 0:p.type)&&(h.typeKeywords=[...h.typeKeywords,"Table","Singlelayer"]),y in{StreamServer:1,ImageServer:1,WorkspaceServer:1}?h.typeKeywords.push("Singlelayer"):((null==p?void 0:p.layers)||(null==p?void 0:p.tables))&&(p.layers&&(null===(n=null==p?void 0:p.layers)||void 0===n?void 0:n.length)||!(null==p?void 0:p.tables.length)?(w=[...p.layers||[],...p.tables||[]],h.typeKeywords.push(w.length>1?"Multilayer":"Singlelayer")):(-1===h.typeKeywords.findIndex((e=>"Table"===e))&&h.typeKeywords.push("Table"),h.typeKeywords.push(p.tables.length>1?"Multilayer":"Singlelayer"))),"sceneserver"===(null==y?void 0:y.toLowerCase())){const{layers:e}=p,t=(null===(l=null==e?void 0:e[0])||void 0===l?void 0:l.layerType)||(null==p?void 0:p.layerType);t&&h.typeKeywords.push(t)}try{const{extent:e}=await async function(e){const{extent:t}=e;return e.extent=Q(await V(t)),e}(Object.assign({},h)),r=h,a=(0,m.g)(r.type);if(r.type=a.type,r.typeKeywords=[...r.typeKeywords||[],...a.typeKeywords||[]],!v){const t=Q(r.extent).split(","),i=[[parseFloat(t[0]),parseFloat(t[1])],[parseFloat(t[2]),parseFloat(t[3])]];r.extent=i;const a=await je(r);r.thumbnailURL=a,r.thumbnailURL&&r.thumbnailToken&&(r.thumbnailURL+=`${r.thumbnailURL.indexOf("?")>-1?"&":"?"}${r.thumbnailToken}`),r.extent=Q("Feature Service"===r.type?e:r.extent)}return v?async function(e){const{user:t}=i.c,{exportTilesAllowed:r}=o.a,a=await Me(e),s=`${t.userContentUrl}/items/${a.id}`,{item:n}=await(0,d.r)(s,{},{},"post"),l=r?e.url:n.url,c=await Re(Object.assign(Object.assign({},e),{type:o.a.type}),l),{typeKeywords:p,thumbnailToken:y,spatialReference:v,extent:m,description:f}=c;e.id=a.id,e.proxyUrl=n.url,e.typeKeywords=p,e.thumbnailToken=y,e.spatialReference=v,e.extent=m,e.description=f;try{const t=Q(c.extent).split(","),r=[[parseFloat(t[0]),parseFloat(t[1])],[parseFloat(t[2]),parseFloat(t[3])]];e.extent=r;const i=await je(e);n.thumbnailURL=i,n.thumbnailURL&&n.thumbnailToken&&(n.thumbnailURL+=`${n.thumbnailURL.indexOf("?")>-1?"&":"?"}${n.thumbnailToken}`)}catch(e){console.error(e)}return await(0,u.e)(a.id,{thumbnailURL:n.thumbnailURL}),a}(r):t?(0,u.e)(r.id,Object.assign(Object.assign({},r),{url:r.sourceUrl})):Me(r)}catch(t){if(v)throw t;return Me(e)}}const Ne=["geocode.arcgis.com","geocodedev.arcgis.com","geocodeqa.arcgis.com","route.arcgis.com","routedev.arcgis.com","routeqa.arcgis.com","geoenrich.arcgis.com","geoenrichqa.arcgis.com","geoenrichddev.arcgis.com"];async function Ae(e,t,r,i){const a=t.split("?")[0],s=`${r}portals/checkurl`,n=Ne.some((e=>-1!==t.indexOf(e)));if(n)return{secured:!0,isOverride:!0};{const l=!n&&t.indexOf("/VectorTileServer")>-1,c=`${s}?url=${encodeURIComponent(`${S(`${a}?f=json`)}`)}`;try{const a=await(0,d.r)(c,{},{addTokenManually:!1}),{httpStatusCode:s}=a;if(a.secured)403===s?a.secured=!1:401===s&&(a.allowStoredAuth=!1);else if(l){const a=await We({username:e.username,password:e.password},t,{isVideoService:!1,checkAuth:i});if(o.a.exportTilesAllowed=null==a?void 0:a.exportTilesAllowed,null==a?void 0:a.exportTilesAllowed)return Ae(e,`${t}/exportTiles`,r,i)}return Object.assign(Object.assign({},a),{isOverride:!1})}catch(e){const{message:r,code:i}=e;return"Error checking resource"===r?{secured:!1,url:t,httpResponse:"",httpStatusCode:i,httpStatusMessage:r,isOverride:!1,allowStoredAuth:!1}:{allowStoredAuth:!1,url:t,httpResponse:"",httpStatusCode:i,httpStatusMessage:r,isOverride:!1}}}}function De(e,t){var r;return e.toLowerCase().indexOf("/imageserver")>-1&&"Raster"===(null==t?void 0:t.cacheType)&&-1===(null===(r=null==t?void 0:t.capabilities)||void 0===r?void 0:r.toLowerCase().indexOf("tilesonly"))}async function We(e,t,r){const a=i.c.config,[s]=await(0,p.l)([3===i.c.api?"esri/IdentityManager":"esri/identity/IdentityManager"]),{forceAddToken:n,isSecure:o,checkAuth:l}=r,{username:c,password:u}=e,d="auto",y=(0,v.a)(t),m=t.indexOf(".esri.com/server/rest/services")>-1,f=y||m,g=Ne.some((e=>-1!==t.indexOf(e))),w={useProxy:!1,timeout:!1===a.isMultiTenant?6e4:5e3,addSSL:f,addTokenManually:o&&f&&!!a.isMultiTenant||n||!1,disableIdentityLookup:null};if(l){if(t=t.split("?")[0],g)return await async function(e,t){const[r,a]=await(0,p.l)([3===i.c.api?"esri/IdentityManager":"esri/identity/IdentityManager","esri/Credential"]);if(t.username&&t.password){const s=await async function(e){const[t,r]=await(0,p.l)([3===i.c.api?"esri/IdentityManager":"esri/identity/IdentityManager","esri/ServerInfo"]);let a=await t.findServerInfo(e);if(a)return a;{a=new r,a.server=await t._getOrigin(e);const i=await t._getTokenSvcUrl(e),{authInfo:s,tokenServiceUrl:n,currentVersion:o}=i;return a.tokenServiceUrl=(null==s?void 0:s.tokenServicesUrl)||(null==s?void 0:s.tokenServiceUrl)||n,a.currentVersion=o,a.hasServer=!0,t.registerServers([a]),a}}(e);if(!r._checkProtocol(e,s,(e=>console.error(e))))return null;try{const i=await r.generateToken(s,t),n=i.expires?Number(i.expires):null,o=!!i.ssl,l=new a({userId:t.username,server:s.server,token:i.token,expires:n,ssl:o,validity:s.shortLivedTokenValidity,resources:[e],scope:"server"});return-1===r.credentials.indexOf(l)&&r.credentials.push(l),t}catch(e){throw e.code=403,e}}}(t,{username:c,password:u}),Ge(t,w,d);{const e=await Ge(t,w,d);return e.credential=s.findCredential(t),e.credential&&s.registerToken({server:t,token:e.credential.token,userId:e.credential.userId,expires:e.credential.expires,ssl:e.credential.ssl}),e}}return w.disableIdentityLookup=!0,await Ge(t,w,d)}async function Ge(e,t,r="post"){try{return await(0,d.r)(S(e),{},Object.assign({},t),r)}catch(e){throw e}}async function Je(e){var t,r;let i={};if((0,y.i)(e.type))i=await Ue(e);else switch(e.type){case"OGCFeatureServer":i=await async function(e){var t,r,i,a;const{url:s}=e,n={addTokenManually:!1,headers:{accept:"application/json"}};try{const o=async(e,t)=>{var r,i,a;try{return await e()}catch(e){const s=null!==(a=null===(i=null===(r=null==e?void 0:e.message)||void 0===r?void 0:r.toLowerCase)||void 0===i?void 0:i.call(r))&&void 0!==a?a:"";if(s.includes("unexpected token")||s.includes("expected expression"))return t();throw{result:null,error:{code:"unhandledError",message:JSON.stringify(e)}}}},l=await o((()=>(0,d.r)(s,{},n,"auto",{excludeJson:!0})),(()=>(0,d.r)(s,{},n))),c=await o((()=>ge(l)),(()=>ge(l,{},!1)));return{result:Object.assign(Object.assign({},e),{extent:Q(null===(a=null===(i=null===(r=null===(t=c.collections)||void 0===t?void 0:t[0])||void 0===r?void 0:r.extent)||void 0===i?void 0:i.spatial)||void 0===a?void 0:a.bbox),type:"OGCFeatureServer",serviceInfo:c,layers:c.collections}),error:null}}catch(e){return console.error("get OGC feature layer:",e),{result:null,error:{code:"unhandledError",message:JSON.stringify(e)}}}}(e);break;case"WMS":const{result:a,error:s}=await le(e);if(s)i.error=s;else{const e=await ce(a.serviceInfo);i.result=Object.assign(Object.assign({},a),e)}break;case"WFS":i=await ye(e),i.result&&(i.result.layers=i.result.serviceInfo.layers,i.result.title=null!==(t=i.result.serviceInfo.title)&&void 0!==t?t:"",i.result.isComplex="esriGeometryComplex"===i.result.serviceInfo.isComplex);break;case"WMTS":i=await ve(e),i.result&&(i.result.layers=i.result.serviceInfo.layers,i.result.title=null!==(r=i.result.serviceInfo.title)&&void 0!==r?r:"");break;default:i={result:Object.assign({},e)}}return i}async function _e(e,t){var r,i;const a=Object.assign({},e),{config:s,user:n,asyncAddToDefinition:o=!0}=t,l={layers:null!==(r=a.layers)&&void 0!==r?r:[],tables:null!==(i=a.tables)&&void 0!==i?i:[]},c=JSON.stringify(l);delete a.layers,delete a.tables,delete a.initialExtent,delete a.fullExtent,delete a._ssl;const u={createParameters:JSON.stringify(a),targetType:"featureService"},p=`${s.restBaseUrl}content/users/${n.username}/createService`,y=await(0,d.r)(p,u,{},"post");try{return await Ve(c,y.encodedServiceURL,o),{createServiceResponse:y,addToDefinitionResponse:l}}catch(e){const t=`${n.userContentUrl}/items/${y.itemId}/delete`;throw await(0,d.r)(t,{},{},"post"),console.error(e),e}}async function Ve(e,t,r=!0){if(e){const i=`${t.replace("rest/services","rest/admin/services")}/addToDefinition`;try{const t=await(0,d.r)(i,{addToDefinition:e,async:r},{},"post");return r?await(0,d.p)(t.statusURL):t}catch(i){throw r&&await Ve(e,t,!1),i}}return null}function Ke(e,t){const r=`${(0,d.g)(t)}content/items/${e.id}/data`;return(0,d.r)(r)}async function qe(e){var t,r;const i=null===(t=(await(0,d.q)({q:'title: "Esri Layer Templates" AND owner: "esri_en"',num:1})).results)||void 0===t?void 0:t[0];if(!i)return null;const a=null===(r=(await(0,d.r)(`${(0,d.g)(e)}/search`,{q:`title:"Points" group:"${i.id}" AND type:"Layer Template" -type:"Attachment"`,num:1})).results)||void 0===r?void 0:r[0];return a?Ke(a,e):null}var ze=function(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(i=Object.getOwnPropertySymbols(e);a<i.length;a++)t.indexOf(i[a])<0&&Object.prototype.propertyIsEnumerable.call(e,i[a])&&(r[i[a]]=e[i[a]])}return r};const Be={currentVersion:10.51,hasVersionedData:!1,supportsDisconnectedEditing:!1,hasStaticData:!1,maxRecordCount:2e3,supportedQueryFormats:"JSON",supportsVCSProjection:!1,capabilities:"Query,Editing,Create,Update,Delete,Sync",description:"",copyrightText:"",allowGeometryUpdates:!0,units:"esriMeters",supportsAppend:!0,syncEnabled:!1,supportsApplyEditsWithGlobalIds:!1,editorTrackingInfo:{allowAnonymousToDelete:!0,allowAnonymousToQuery:!0,allowAnonymousToUpdate:!0,allowOthersToDelete:!1,allowOthersToQuery:!0,allowOthersToUpdate:!0,enableEditorTracking:!1,enableOwnershipAccessControl:!1},xssPreventionInfo:{xssPreventionEnabled:!0,xssPreventionRule:"InputOnly",xssInputRule:"rejectInvalid"},_ssl:!0},He=async e=>{var t,r,a;const{tags:s,serviceInfo:l,typeKeywords:d,extent:p,selectedServiceInfoLayersNames:y,addFeatureLayerType:v}=e,{portal:m}=i.c,f=m.isPortal;if(!l)throw new Error("No service info found.");try{let e=Be;try{e=null!==(t=await qe(m))&&void 0!==t?t:Be,e.capabilities="Query,Editing,Create,Update,Delete",e.hasStaticData=!1}catch(e){console.warn(`Could not fetch template ${JSON.stringify(e)}`)}const g=l;let w=null!==(r=g.layers)&&void 0!==r?r:[],h=null!==(a=g.tables)&&void 0!==a?a:[];if("build"!==v&&y){const e=e=>y[e.name];w=w.filter(e),h=h.filter(e)}const{layers:S,tables:x}=Ye(w,h),{layers:O,tables:I}=Ze(S,x),T=Object.assign(Object.assign(Object.assign({},e),l),{name:g.name||n.i.title,layers:O,tables:I}),{cleanedCreateParameters:L,relationshipParameters:M}=Xe(T);["serviceDescription","hasStaticData","maxRecordCount","supportedQueryFormats","capabilities","description","copyrightText","spatialReference","initialExtent","fullExtent","_ssl","allowGeometryUpdates","units","xssPreventionInfo"].forEach((e=>{const t=g[e];null!=t&&(L[e]=t)})),L.name=(0,c.a)(L.name),"template"===v&&(L.syncEnabled=!0,L.capabilities="Query,Editing,Create,Update,Delete,Sync");const{createServiceResponse:k}=await _e(L,{asyncAddToDefinition:!f,config:i.c.config,user:i.c.user}),{itemId:P,success:j}=k,{typeKeywords:$}=(await(0,u.a)(P)).result,U=[...d,...$];l.captureGPS&&U.push("gpsMetadataEnabled");try{const e=m.defaultExtent||l.fullExtent||l.extent||p,t=e.spatialReference.wkid||e.spatialReference.wkt||"4326",r=Q((e=>{const t=(e,t,r)=>e>=t&&e<=r;return t(e.ymax,-90,90)&&t(e.ymin,-90,90)&&t(e.xmax,-180,180)&&t(e.xmin,-180,180)&&e.ymax>e.ymin&&e.xmax>e.xmin})(e)||"4326"!==t?e:await V(e)),i=`https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/export?size=800,532&format=png24&bboxSR=${t}&bbox=${r}&f=image`,a=b(n.i.folder);return await Promise.all([(0,u.e)(P,{title:n.i.title,typeKeywords:U.join(","),tags:(null!=s?s:n.i.tags).join(","),extent:r,snippet:n.i.snippet,description:o.a.description}),M.layers||M.tables?Ve(JSON.stringify(M),k.encodedServiceURL,!f):void 0,!a&&(0,u.m)(P,n.i.folder.id)]),(0,u.e)(P,{thumbnailURL:i}).catch(console.error),{success:j,id:P,folder:n.i.folder.id}}catch(e){throw(0,u.d)(P),console.error(e),e}}catch(e){throw console.error(e),e}},Qe=async(e,t,r,i)=>{var a;const{username:n,password:l,checkAuth:c}=o.a;try{const t=e=>We({username:n,password:l},e,{forceAddToken:r,isSecure:i,isVideoService:!1,checkAuth:c}),a=(0,s.p)(e);if(!a)return console.warn("invalid service info"),null;const{baseServerUrl:o,index:u}=a,d=await t(o);return{serviceInfo:d,layers:await Promise.all((d.layers||[]).filter((e=>null===u||e.id===u)).map((e=>t(`${o}/${e.id}`)))),tables:await Promise.all((d.tables||[]).filter((e=>null===u||e.id===u)).map((e=>t(`${o}/${e.id}`))))}}catch(r){if(console.error(r),"token required"===(null===(a=r.message)||void 0===a?void 0:a.toLowerCase()))try{const{secured:r}=await Ae({username:n,password:l},e,t,c);return await Qe(e,t,r)}catch(e){throw e}throw r}},Xe=e=>{const t={},r=e=>t[e.id]=!0;e.layers.forEach(r),e.tables.forEach(r);const i=e=>t[e.relatedTableId],a=e=>({relationships:e.relationships.filter(i),id:e.id}),s=e=>{var t;return(null===(t=e.relationships)||void 0===t?void 0:t.length)>0},n={layers:e.layers.map(a).filter(s),tables:e.tables.map(a).filter(s)};0===n.layers.length&&delete n.layers,0===n.tables.length&&delete n.tables;const o=e.layers.map((e=>ze(e,["relationships"]))),l=e.tables.map((e=>ze(e,["relationships"])));return{relationshipParameters:n,cleanedCreateParameters:Object.assign(Object.assign({},e),{layers:o,tables:l})}},Ye=(e,t)=>{const r=e=>Object.assign(Object.assign({},e),{indexes:(0,a.u)(e.indexes,(e=>e.name))});return{layers:e.map(r),tables:t.map(r)}},Ze=(e,t)=>{let r=(0,l.c)(e,t);const i={};return r=r.map(((e,t)=>(i[e.id]=t,Object.assign(Object.assign({},e),{id:t})))),r.forEach((e=>{var t;e.relationships=(null!==(t=e.relationships)&&void 0!==t?t:[]).map((e=>{const t=e.relatedTableId,r=i[t];return Object.assign(Object.assign({},e),{relatedTableId:r})}))})),r.reduce(((e,t)=>("Table"===t.type?e.tables.push(t):e.layers.push(t),e)),{layers:[],tables:[]})}},48333:(e,t,r)=>{r.d(t,{a:()=>s,f:()=>c,g:()=>l,s:()=>n,v:()=>o});var i=r(31546),a=r(48680);function s(e,t){const r=/(?:\.([^.]+))?$/;let i=e.replace(/^.*(\\|\/|:)/,""),s=i&&r.exec(i)[1]?r.exec(i)[1].toLowerCase():"",n="";if(i.indexOf(".rft.")>-1){const[e,t]=i.split(".rft.");s=`rft.${t}`,n=e}return i&&!n&&(n=-1===i.lastIndexOf(".")?i:i.substring(0,i.lastIndexOf("."))),n=n.replace(/\.|-/g,"_"),t&&(n=function(e){return`${e}_${(0,a.g)()}`}(n),i=`${n}.${s}`),{title:n,fileName:i,extension:s}}function n(e,t){return s(e.name,!!t)}function o(e,t){let r=e;const i=e.lastIndexOf("\\");return i>-1&&(r=r.substring(i+1,r.length)),r.replace(/\ /g,"_")===t.replace(/\ /g,"_")}function l(e){return i.a[e]?i.a[e]:i.a[Object.keys(i.a).find((t=>i.a[t].type===e))]}function c(e){if(!e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${Math.round(e/Math.pow(1024,t))} ${["B","KB","MB","GB","TB"][t]}`}},15859:(e,t,r)=>{r.d(t,{a:()=>s,b:()=>a,c:()=>l,d:()=>c,g:()=>o,s:()=>n});var i=r(26426);function a(e,t,r,i){!function(e,t,r){let i=null==(r=r||{})?void 0:r.expires;if("number"==typeof i){const e=new Date,t=24*i*60*60*1e3;e.setTime(Date.now()+t),i=r.expires=e}"string"!=typeof i&&(null==i?void 0:i.toUTCString)&&(r.expires=i.toUTCString());let a,s=`${e}=${encodeURIComponent(t)}`;for(a in r){s+=`; ${a}`;const e=r[a];!0!==e&&(s+=`=${e}`)}document.cookie=s}(e,i?JSON.stringify(t):t,r)}function s(e,t){const r=function(e){const t=document.cookie,r=new RegExp(`(?:^|; )${(0,i.e)(e)}=([^;]*)`),a=t.match(r);return a?decodeURIComponent(a[1]):void 0}(e);return r&&t?JSON.parse(r):r}function n(e,t,r){window.localStorage.setItem(e,r?JSON.stringify(t):t)}function o(e,t){const r=window.localStorage.getItem(e);return r&&t?JSON.parse(r):r}function l(e,t,r){window.sessionStorage.setItem(e,r?JSON.stringify(t):t)}function c(e,t){const r=window.sessionStorage.getItem(e);return r&&t?JSON.parse(r):r}},86274:(e,t,r)=>{r.d(t,{w:()=>i});const i=(0,r(27010).c)({portal:null,user:null,i18n:null,scale:"m",api:4,nextText:null,uploadProgress:0}).state},48507:(e,t,r)=>{r.d(t,{a:()=>v,b:()=>y,c:()=>u,d:()=>f,e:()=>m,f:()=>g,g:()=>w,i:()=>h,r:()=>c,s:()=>p,u:()=>d});var i=r(41171),a=r(62381),s=r(76134),n=r(66716),o=r(15859),l=r(82463);function c(e){return"/"===(null==e?void 0:e.slice(-1))?e.slice(0,e.length-1):e}async function u(e){var t;const r=null!==(t=null===s.c||void 0===s.c?void 0:s.c.api)&&void 0!==t?t:4,[i]=await(0,n.l)([4===r?"esri/core/urlUtils":"esri/urlUtils"]);let a=i.urlToObject(e);a.query=a.query||{};for(let e in a.query||{})a.query.hasOwnProperty(e)&&(Array.isArray(a.query[e])||(a.query[e]=a.query[e].replace(/(&lt;|&gt;|<|>|%3C|%3E)/g,"")));return a}function d(e){return(null==e?void 0:e.replace(/^.*\//,"").replace(/.[^.]*$/,""))||""}function p(e){return["WFS","GeoJson","CSV","GeoRSS","KML","OGCFeatureServer","WMS","WMTS"].includes(e)}function y(e){const{config:t,portal:r}=s.c;let i=!1;if(!e)return!1;if((t.httpsDomains||[]).forEach((t=>{(e.indexOf(`.${t}/`)>-1||e.indexOf(`/${t}/`)>-1)&&(i=!0)})),!i){let t=r.portalHostname;t.indexOf("/")>-1&&(t=t.substring(0,t.indexOf("/"))),e.indexOf(t)>-1&&(i=!0)}return i}function v(e){if(!e)return!1;const{config:t,portal:r}=s.c,a=(0,i.g)(r),n=new URL(a).hostname,o=!1===t.isMultiTenant,l=-1!==e.indexOf(".arcgis.com/"),c=-1!==e.indexOf("//services")||-1!==e.indexOf("//tiles")||-1!==e.indexOf("//features")||-1!==e.indexOf("//locationservices"),u=r.supportsHostedServices&&-1!==e.indexOf(n)&&!o;return l&&c||!l&&u}function m(){var e;if(-1===window.location.protocol.toLowerCase().indexOf("https")){const t=(0,o.a)("esri_auth",!0);return"web"!==(null===(e=null==t?void 0:t.auth_tier)||void 0===e?void 0:e.toLowerCase())}return!0}function f(e){let t=e.toLowerCase();-1==t.indexOf("http://")&&-1==t.indexOf("https://")&&(t=(e="https://"+e).toLowerCase());let r=t.indexOf("//");r=t.indexOf("/",r+2),-1==r?t=(e+="/arcgis/rest/services").toLowerCase():r==t.length-1&&(t=(e+="arcgis/rest/services").toLowerCase());let i=t.indexOf("/arcgis",r);i==t.length-7?t=(e+="/rest/services").toLowerCase():i==t.length-8&&(t=(e+="rest/services").toLowerCase()),i=t.indexOf("/server",r),t.endsWith("/server")?t=(e+="/rest/services").toLowerCase():t.endsWith("/server/")&&(t=(e+="rest/services").toLowerCase());const a=t.indexOf("/rest/services",r),s=t.indexOf("/services",r),n=t.indexOf("/rest",r);return-1==a&&s>-1?t=(e=`${e.substring(0,s)}/rest/services${e.substring(s+9)}`).toLowerCase():-1==a&&n>-1&&(t=(e=`${e.substring(0,n)}/rest/services${e.substring(n+5)}`).toLowerCase()),t.indexOf("/rest/services"),e}const g=(e,t=!1)=>(e=c(e),/(http|https|ftp):\/\/?/.exec(e)||(e=`https://${e}`),!t&&"https:"!==location.protocol||!v(e)&&!y(e)||(e=e.replace("http:/","https:/")),e.indexOf("/dynamicLayer?")>-1?e.substring(0,e.indexOf("/dynamicLayer?")):e),w=(e,t=!1)=>{var r,i,s;if(!e)return{error:{code:"invalidUrl"}};if(h(e,t))return{error:{code:"httpWarning"}};const n=decodeURIComponent(e),o=n.replace(a.v,"").match(/((\.|\/)*(kml|kmz))/gi),c=n.replace(a.v,"").match(/((\/|\=)(wmts|wms|wfs))/gi),u=n.replace(a.v,"").match(/((\/|\=)(OGC|OGCFeatureServer))/gi),d=n.replace(a.v,"").match(/((\.|\/)*(rss))/gi),p=null===(r=n.replace(a.v,"").match(a.u))||void 0===r?void 0:r[1],y=n.replace(a.v,"").match(a.r),v=n.replace(a.v,"").match(/((\.|\/)*(csv))/gi),m=n.replace(a.v,"").match(/(\.|\/)((\$?{(z|level)})\/*(\$?{(x|col)})\/*(\$?{(y|row)}))/gi);let f=null;if(n.match(a.q))f="GeoJson";else if(!u||c||p)if(p&&!c)f=l.a[p];else if(y)f="Map Service";else if(c){const e="/"===(null==c?void 0:c[0].charAt(0))?"/":"=";f=null===(s=null===(i=null==c?void 0:c[0])||void 0===i?void 0:i.split(e)[1])||void 0===s?void 0:s.toUpperCase()}else o?f="KML":d?f="GeoRSS":v?f="CSV":m&&(f="Tile Layer");else f="OGCFeatureServer";return{result:f}},h=(e,t)=>!t&&e.includes("http://")}}]);