System.register(["jimu-core","jimu-ui","jimu-ui/advanced/rich-text-editor","jimu-theme","jimu-for-builder"],(function(e,t){var r={},o={},n={},s={},a={};return{setters:[function(e){r.BrowserSizeMode=e.BrowserSizeMode,r.DataSourceManager=e.DataSourceManager,r.Immutable=e.Immutable,r.React=e.React,r.ReactRedux=e.ReactRedux,r.appActions=e.appActions,r.css=e.css,r.getAppStore=e.getAppStore,r.hooks=e.hooks,r.jsx=e.jsx},function(e){o.defaultMessages=e.defaultMessages,o.richTextUtils=e.richTextUtils,o.sanitizer=e.sanitizer},function(e){n.Bubble=e.Bubble,n.Delta=e.Delta,n.RichExpressionBuilderPopper=e.RichExpressionBuilderPopper,n.RichTextEditor=e.RichTextEditor,n.richTextEditorUtils=e.richTextEditorUtils},function(e){s.ThemeSwitcher=e.ThemeSwitcher},function(e){a.appBuilderSync=e.appBuilderSync}],execute:function(){e((()=>{"use strict";var e={48891:e=>{e.exports=r},23137:e=>{e.exports=a},34796:e=>{e.exports=s},30726:e=>{e.exports=o},65492:e=>{e.exports=n}},t={};function l(r){var o=t[r];if(void 0!==o)return o.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,l),n.exports}l.d=(e,t)=>{for(var r in t)l.o(t,r)&&!l.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return(()=>{l.r(i),l.d(i,{default:()=>P});var e={};l.r(e),l.d(e,{DATA_SOURCE_ID_REGEXP:()=>a,getDataSourceIds:()=>c,getDefaultValue:()=>m,getExpressionParts:()=>p,getInvalidDataSourceIds:()=>d,getUseDataSourceIds:()=>u,sanitizeHTML:()=>h,shouldShowPlaceholder:()=>f});var t=l(48891),r=l(30726),o=l(65492);const n=(e,t)=>{const o=r.richTextUtils.getHTMLTextContent(e);return e.replace(null==o?void 0:o.trim(),t)},s=(e,t)=>(t.forEach((e=>{var t;const r=null===(t=null==e?void 0:e.attributes)||void 0===t?void 0:t.linespace;r&&isNaN(Number(r))&&(e.attributes.linespace=1.5)})),t),a=/data-dsid=\"(((?![\=|\>|\"]).)*)[\"\>|"\s)]/gm,c=(e=(0,t.Immutable)([]))=>e.map((e=>{return r=null==e?void 0:e.dataSourceId,null!=t.DataSourceManager.getInstance().getDataSource(r)?null==e?void 0:e.dataSourceId:null;var r})).filter((e=>null!=e)),u=e=>{const t=a;let r,o=[];for(;null!==(r=t.exec(e));){let e=r[1];e.indexOf(",")>0?(e=e.split(","),o=o.concat(e)):o.push(e)}return o},d=(e,t)=>{const r=u(e);if(null==r||r.length<=0)return;const o=c(t),n=r.filter((e=>!o.includes(e)));return n.length>=0?n:void 0},p=e=>{let t=[];for(const r in e){const o=e[r],n=null==o?void 0:o.parts;null!=n&&(t=t.concat(n))}return t},f=(e,t,o)=>{const n=r.richTextUtils.isBlankRichText(e)&&!!t;return void 0!==o?!o&&n:n},h=(e="")=>""!==e?r.sanitizer.sanitize(e):e,m=(e,t,o="")=>{let s=t;const a=f(t,o);return e?a&&(s=n(o,r.richTextUtils.BLANK_CHARATER)):s=a?o:t,h(s)};const{useEffect:g,useRef:b,useState:v,useMemo:S}=t.React,x={toolbar:!1,autoformat:{link:{trigger:/[\s]/,find:/https?:\/\/[\S]+|(www\.[\S]+)/gi,transform:function(e,t){return t?"http://"+e:e},format:"link"}},clipboard:{matchers:[["img",()=>new o.Delta],["p",s],["li",s]]}},R=/(?!^\n$)[\n]/gm,y=(e,t)=>(t.forEach((e=>{"string"==typeof e.insert&&(e.insert=e.insert.replace(R," "))})),t),E=e=>{e.clipboard.addMatcher("*",y)},w=(e,t)=>{if(null==e)return;const r=(e=>{const t=e.clipboard.matchers;let r=-1;if(t.some((([e,t],o)=>"*"===e&&t===y&&(r=o,!0))),r>-1)return e.clipboard.matchers.splice(r,1),!0})(e);t=h(t);const n=e.clipboard.convert(t);e.setContents(n,"silent"),o.richTextEditorUtils.setEditorCursorEnd(e,"silent"),r&&E(e)},C=e=>{const{editorRef:s,value:a,placeholder:l,enabled:i,onChange:c,onComplete:u}=e,d=function(e,t){var r={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(r[o[n]]=e[o[n]])}return r}(e,["editorRef","value","placeholder","enabled","onChange","onComplete"]),[p,h]=t.hooks.useForwardRef(s),[R,y]=v(a),[C,O]=v(l),T=((e,t,r,o,n)=>{const s=b({enabled:e,value:t,placeholder:r,onChange:o,onComplete:n});return g((()=>{s.current={enabled:e,value:t,placeholder:r,onChange:o,onComplete:n}}),[e,t,r,o,n]),s})(i,R,C,c,u),j=S((()=>m(i,R,C)),[]),I=t.hooks.useEventCallback(((e,t,r)=>{"silent"!==r&&(f(R,C,i)?O(e):(y(e),null==c||c(e)))}));return t.hooks.useUpdateEffect((()=>{if(O(l),f(R,l)){const e=p.current;w(e,l)}}),[l]),t.hooks.useUpdateEffect((()=>{const{value:e,placeholder:t,onComplete:o}=T.current,s=p.current;if(i){const o=p.current;if(f(e,t)){const e=n(t,r.richTextUtils.BLANK_CHARATER);w(o,e),o.focus()}}else f(e,t)&&w(s,t),null==o||o(e,t)}),[i]),g((()=>{const e=p.current;null!=e&&E(e)}),[p]),t.hooks.useUnmount((()=>{const{value:e,placeholder:t,onComplete:r}=T.current;null==r||r(e,t)})),t.React.createElement(o.RichTextEditor,Object.assign({autoFocus:!0,enabled:i,editorRef:h,onChange:I,defaultValue:j,modules:x},d))};var O=l(34796),T=l(23137);const j=e=>{const{editor:n,formats:s,selection:a,useDataSources:l,widgetId:i,enabled:c,onInitResizeHandler:u}=e,d=t.ReactRedux.useSelector((e=>{var t;return!!(null===(t=e.widgetsState[i])||void 0===t?void 0:t.showExpression)})),p=t.ReactRedux.useSelector((e=>e.browserSizeMode)),f=t.ReactRedux.useSelector((e=>{var t;return null===(t=e.appConfig.widgets[i])||void 0===t?void 0:t.uri})),h=t.hooks.useTranslation(r.defaultMessages),[m,g]=t.React.useState(0),[b,v]=t.React.useState(0),S=t.React.useRef(null);p===t.BrowserSizeMode.Small&&T.appBuilderSync.publishSidePanelToApp({type:"textExpression",widgetId:i,uri:f,editor:n,formats:s,selection:a,useDataSources:l,active:d}),t.React.useEffect((()=>{null==u||u((()=>{var e;g((e=>e+1)),null===(e=S.current)||void 0===e||e.classList.add("d-none")}),null,(()=>{var e;v((e=>e+1)),null===(e=S.current)||void 0===e||e.classList.remove("d-none")}))}),[u]);const x=t.React.useMemo((()=>({title:h("dynamicContent"),onClose:()=>(0,t.getAppStore)().dispatch(t.appActions.widgetStatePropChange(i,"showExpression",!1))})),[i,h]);return t.hooks.useUpdateEffect((()=>{g((e=>e+1))}),[c]),t.React.createElement(O.ThemeSwitcher,{useTheme2:!0},t.React.createElement(o.Bubble,{editor:n,formats:s,selection:a,source:"user",version:m}),p!==t.BrowserSizeMode.Small&&t.React.createElement(o.RichExpressionBuilderPopper,{ref:S,version:b,source:"user",editor:n,formats:s,selection:a,open:d,useDataSources:l,header:x,widgetId:i}))};const{useMemo:I,useCallback:D}=t.React,M=t.css`
  opacity: 0.5;
  background: red;
  outline: 1px solid white;
`,P={Editor:e=>{const{value:r,widgetId:o,useDataSources:n,onComplete:s,onCreate:a,onDestory:l,onInitResizeHandler:i,enabled:c}=e,u=function(e,t){var r={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(r[o[n]]=e[o[n]])}return r}(e,["value","widgetId","useDataSources","onComplete","onCreate","onDestory","onInitResizeHandler","enabled"]),[p,f]=t.React.useState(r),h=((e,t)=>D((r=>null!=r?null==e?void 0:e(r):null==t?void 0:t()),[e,t]))(a,l),m=((e,r,o,n)=>t.React.useMemo((()=>({editor:s,selection:a,formats:l})=>(0,t.jsx)(j,{editor:s,selection:a,formats:l,widgetId:e,useDataSources:r,enabled:o,onInitResizeHandler:n})),[o,n,r,e]))(o,n,c,i),g=((e,r)=>I((()=>{const o=d(e,r);let n;return null!=o&&o.length>0&&(n=o.map((e=>t.css`
          exp[data-dsid*="${e}"] {
           ${M}
          }
        `))),t.css`${n}`}),[e,r]))(p,n);return(0,t.jsx)(C,Object.assign({editorRef:h,css:g,value:r,plugin:m,onChange:f,onComplete:s,enabled:c},u))},builderUtils:e}})(),i})())}}}));