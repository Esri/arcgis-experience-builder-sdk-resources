System.register(["jimu-core","jimu-arcgis"],(function(e,t){var n={},a={};return{setters:[function(e){n.AbstractMessageAction=e.AbstractMessageAction,n.AppMode=e.AppMode,n.DataSourceManager=e.DataSourceManager,n.Immutable=e.Immutable,n.JimuFieldType=e.JimuFieldType,n.MessageActionConnectionType=e.MessageActionConnectionType,n.MessageType=e.MessageType,n.MutableStoreManager=e.MutableStoreManager,n.dataSourceUtils=e.dataSourceUtils,n.getAppStore=e.getAppStore,n.lodash=e.lodash,n.messageActionUtils=e.messageActionUtils},function(){}],execute:function(){e((()=>{"use strict";var e={62686:e=>{e.exports=a},79244:e=>{e.exports=n}},t={};function o(n){var a=t[n];if(void 0!==a)return a.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,o),i.exports}o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};o.r(i),o.d(i,{default:()=>p});var s=o(79244);o(62686);var r=function(e,t,n,a){return new(n||(n=Promise))((function(o,i){function s(e){try{l(a.next(e))}catch(e){i(e)}}function r(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}l((a=a.apply(e,t||[])).next())}))};function l(e,t){const n=[];for(let a=0;a<e.length;a++){const o=e[a],i=s.messageActionUtils.formatValue(o,t);n.includes(i)||n.push(i)}return n}function c(e,t,n,a){return r(this,void 0,void 0,(function*(){let o="";if(t.enabledDataRelationShip){let{messageField:i,actionField:r}=function(e,t,n){var a,o,i,r;let l=null,c=null;if(e.messageUseDataSource.mainDataSourceId===e.actionUseDataSource.mainDataSourceId&&e.messageUseDataSource.rootDataSourceId===e.actionUseDataSource.rootDataSourceId){const e=t.getSchema(),n=e&&e.fields&&Object.keys(e.fields).find((t=>"esriFieldTypeOID"===e.fields[t].esriType));l=e&&e.fields&&e.fields[n],c=l}else{let u,d;if(e.connectionType===s.MessageActionConnectionType.UseLayersRelationship){const e=s.dataSourceUtils.getJimuDataSourceRelationship(t,n);e&&(u=e.keyField,d=e.relatedKeyField)}else u=null===(a=e.messageUseDataSource.fields)||void 0===a?void 0:a[0],d=null===(o=e.actionUseDataSource.fields)||void 0===o?void 0:o[0];u&&(l=null===(i=t.getSchema().fields)||void 0===i?void 0:i[u]),d&&(c=null===(r=n.getSchema().fields)||void 0===r?void 0:r[d])}return{messageField:l,actionField:c}}(t,n,a);if(i&&r){const c=i.name,u=i.type,d=e;let g=[];if(t.connectionType===s.MessageActionConnectionType.UseLayersRelationship){g=l((yield null==n?void 0:n.queryRelatedFieldValues(d.records||[],a,r.name))||[],u),0===g.length&&(g=["-1"],r=a.getSchema().fields[a.getIdField()])}else{g=l(d.records.map((e=>e.getData()[c])),u)}if(o="",g.length>0){const e=!0,t=s.messageActionUtils.getSqlExpressionWidthMessageFieldValues(g,r,a,e);if(t){const e=(0,s.Immutable)(t),n=s.dataSourceUtils.getArcGISSQL(e,a);(null==n?void 0:n.sql)&&(o=null==n?void 0:n.sql)}}o||(o="")}}return o||(o=""),o}))}function u(e,t,n,a,o){return r(this,void 0,void 0,(function*(){let i="";const r=[],l=yield c(e,n,a,o);l&&r.push(l);const u=function(e,t,n){let a="";if(e.length>0){const e=t.sqlExprObj?s.dataSourceUtils.getArcGISSQL(t.sqlExprObj,n).sql:null;e&&(a=e)}else a="";return a||(a=""),a}(t,n,o);return u&&r.push(u),0===r.length?i="":1===r.length?i=r[0]:2===r.length&&(i=`(${r[0]}) AND (${r[1]})`),i||(i=""),i}))}function d(e){var t,n;const a=[],o=e.records||[],i=(e.dataSourceIds||[]).filter((e=>!!e));if(o.length>0&&o[0]){const e=null===(n=null===(t=o[0])||void 0===t?void 0:t.dataSource)||void 0===n?void 0:n.getMainDataSource();if(e){a.push(e.id);const t=e.getAssociatedDataSource&&e.getAssociatedDataSource();t&&a.push(t.id)}}if((null==i?void 0:i.length)>0){const e=s.DataSourceManager.getInstance();i.forEach((t=>{const n=e.getDataSource(t);if(n){const e=n.getMainDataSource();e&&a.push(e.id)}}))}return Array.from(new Set(a))}var g=function(e,t,n,a){return new(n||(n=Promise))((function(o,i){function s(e){try{l(a.next(e))}catch(e){i(e)}}function r(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}l((a=a.apply(e,t||[])).next())}))};const S="filterActionValue-",f="filterMessageValue-";class p extends s.AbstractMessageAction{constructor(){super(...arguments),this.filterActions={}}filterMessageDescription(e){return(0,s.getAppStore)().getState().appRuntimeInfo.appMode!==s.AppMode.Express&&e.messageType===s.MessageType.DataRecordsSelectionChange}filterMessage(e){return!0}getDefaultMessageActionConfig(e){return{useAnyTriggerData:!0,messageUseDataSource:null,actionUseDataSource:null,sqlExprObj:null,enabledDataRelationShip:!0,connectionType:s.MessageActionConnectionType.SetCustomFields}}onRemoveListen(e,t){Object.keys(this.filterActions||{}).forEach((e=>{Object.entries(this.filterActions[e]||{}).forEach((n=>{var a;const o=n[0];(null===(a=n[1])||void 0===a?void 0:a.messageWidgetId)===t&&s.lodash.setValue(this.filterActions,`${e}.${o}.querySQL`,"")}));const n={layerDataSourceId:e.slice(18),querySQL:this.getUnionAllFilterQuerySQL(e)};s.MutableStoreManager.getInstance().updateStateValue(this.widgetId,e,n)}))}onExecute(e,t){return g(this,void 0,void 0,(function*(){switch(e.type){case s.MessageType.DataRecordsSelectionChange:const n=e,a=n.records||[];let o,i,r=null;if(null==t?void 0:t.useAnyTriggerData)if(a.length>0)r=function(e){var t,n,a,o;let i="",r="";if(e.length>0){const c=null===(n=null===(t=e[0])||void 0===t?void 0:t.dataSource)||void 0===n?void 0:n.getMainDataSource();if(c){i=c.id;const t=c.getIdField(),n=t&&(null===(o=null===(a=c.getSchema())||void 0===a?void 0:a.fields)||void 0===o?void 0:o[t]);if(n){const t=[];e.forEach((e=>{const n=e.getId();null!=n&&""!==n&&t.push(n)}));const a=l(t,s.JimuFieldType.Number);if(a.length>0){const e=!0,t=s.messageActionUtils.getSqlExpressionWidthMessageFieldValues(a,n,c,e);if(t){const e=(0,s.Immutable)(t),n=s.dataSourceUtils.getArcGISSQL(e,c);(null==n?void 0:n.sql)&&(r=null==n?void 0:n.sql)}}}}}let c=null;return i&&r&&(c={layerDataSourceId:i,querySQL:r}),c}(a),r&&r.layerDataSourceId&&(o=s.DataSourceManager.getInstance().getDataSource(r.layerDataSourceId),i=o);else{const e=d(n);if(e.length>0&&e[0]){const t=e[0];r={layerDataSourceId:t,querySQL:""},o=s.DataSourceManager.getInstance().getDataSource(t),i=o}}else if(t)if(t.messageUseDataSource&&t.actionUseDataSource){const l=function(e,t){var n;if(null==t?void 0:t.useAnyTriggerData)return!0;const a=d(e),o=null===(n=null==t?void 0:t.messageUseDataSource)||void 0===n?void 0:n.mainDataSourceId;return o&&a.includes(o)}(n,t);if(!l){s.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"filterActionValue",null);break}if(o=s.DataSourceManager.getInstance().getDataSource(t.messageUseDataSource.mainDataSourceId),i=s.DataSourceManager.getInstance().getDataSource(t.actionUseDataSource.mainDataSourceId),o&&i)if(0===a.length)r={layerDataSourceId:i&&i.id,querySQL:""};else{const n=yield u(e,a,t,o,i);r={layerDataSourceId:i&&i.id,querySQL:n}}else r=null}else r=null;const c=function(e,t){const n=`${f}${e}-${t}`;return n}(e.widgetId,null==o?void 0:o.id),g=function(e){const t=`${S}${e}`;return t}(null==r?void 0:r.layerDataSourceId);r&&(s.lodash.setValue(this.filterActions,`${g}.${c}`,{querySQL:null==r?void 0:r.querySQL,messageWidgetId:e.widgetId}),r.querySQL=this.getUnionAllFilterQuerySQL(g)),s.MutableStoreManager.getInstance().updateStateValue(this.widgetId,g,r)}return!0}))}getUnionAllFilterQuerySQL(e){let t="";return Object.entries(this.filterActions[e]||{}).forEach((e=>{var n;const a=null===(n=e[1])||void 0===n?void 0:n.querySQL;t=t&&a?` ${t} AND ${a} `:a||t})),t}}return i})())}}}));