System.register(["jimu-core","jimu-arcgis"],(function(e,t){var n={},a={};return{setters:[function(e){n.AbstractMessageAction=e.AbstractMessageAction,n.AppMode=e.AppMode,n.DataSourceManager=e.DataSourceManager,n.Immutable=e.Immutable,n.JimuFieldType=e.JimuFieldType,n.MessageActionConnectionType=e.MessageActionConnectionType,n.MessageType=e.MessageType,n.MutableStoreManager=e.MutableStoreManager,n.dataSourceUtils=e.dataSourceUtils,n.getAppStore=e.getAppStore,n.messageActionUtils=e.messageActionUtils},function(){}],execute:function(){e((()=>{"use strict";var e={62686:e=>{e.exports=a},79244:e=>{e.exports=n}},t={};function o(n){var a=t[n];if(void 0!==a)return a.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,o),i.exports}o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};o.r(i),o.d(i,{default:()=>v});var r=o(79244);o(62686);function s(e){var t;if(!e)return null;const n=l();return null===(t=null==n?void 0:n.widgets)||void 0===t?void 0:t[e]}function l(){var e,t,n;return window.jimuConfig.isBuilder?null===(t=null===(e=(0,r.getAppStore)().getState())||void 0===e?void 0:e.appStateInBuilder)||void 0===t?void 0:t.appConfig:null===(n=(0,r.getAppStore)().getState())||void 0===n?void 0:n.appConfig}function u(){var e;const t=function(){var e;return(null===(e=window.jimuConfig)||void 0===e?void 0:e.isBuilder)?(0,r.getAppStore)().getState().appStateInBuilder:(0,r.getAppStore)().getState()}();return(null===(e=null==t?void 0:t.appRuntimeInfo)||void 0===e?void 0:e.appMode)===r.AppMode.Express}var c=function(e,t,n,a){return new(n||(n=Promise))((function(o,i){function r(e){try{l(a.next(e))}catch(e){i(e)}}function s(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,s)}l((a=a.apply(e,t||[])).next())}))};function d(e){const t=u(),n=null==e?void 0:e.useAnyTriggerData;return t||n}function g(e,t){const n=[];for(let a=0;a<e.length;a++){const o=e[a],i=r.messageActionUtils.formatValue(o,t);n.includes(i)||n.push(i)}return n}function f(e,t,n,a){return c(this,void 0,void 0,(function*(){let o="";if(t.enabledDataRelationShip){let{messageField:i,actionField:s}=function(e,t,n){var a,o,i,s;let l=null,u=null;if(e.messageUseDataSource.mainDataSourceId===e.actionUseDataSource.mainDataSourceId&&e.messageUseDataSource.rootDataSourceId===e.actionUseDataSource.rootDataSourceId){const e=t.getSchema(),n=e&&e.fields&&Object.keys(e.fields).find((t=>"esriFieldTypeOID"===e.fields[t].esriType));l=e&&e.fields&&e.fields[n],u=l}else{let c,d;if(e.connectionType===r.MessageActionConnectionType.UseLayersRelationship){const e=r.dataSourceUtils.getJimuDataSourceRelationship(t,n);e&&(c=e.keyField,d=e.relatedKeyField)}else c=null===(a=e.messageUseDataSource.fields)||void 0===a?void 0:a[0],d=null===(o=e.actionUseDataSource.fields)||void 0===o?void 0:o[0];c&&(l=null===(i=t.getSchema().fields)||void 0===i?void 0:i[c]),d&&(u=null===(s=n.getSchema().fields)||void 0===s?void 0:s[d])}return{messageField:l,actionField:u}}(t,n,a);if(i&&s){const l=i.name,u=i.type,c=e;let d=[];if(t.connectionType===r.MessageActionConnectionType.UseLayersRelationship){d=g((yield null==n?void 0:n.queryRelatedFieldValues(c.records||[],a,s.name))||[],u),0===d.length&&(d=["-1"],s=a.getSchema().fields[a.getIdField()])}else{d=g(c.records.map((e=>e.getData()[l])),u)}if(o="",d.length>0){const e=!0,t=r.messageActionUtils.getSqlExpressionWidthMessageFieldValues(d,s,a,e);if(t){const e=(0,r.Immutable)(t),n=r.dataSourceUtils.getArcGISSQL(e,a);(null==n?void 0:n.sql)&&(o=null==n?void 0:n.sql)}}o||(o="")}}return o||(o=""),o}))}function p(e,t,n,a,o){return c(this,void 0,void 0,(function*(){let i="";const s=[],l=yield f(e,n,a,o);l&&s.push(l);const u=function(e,t,n){let a="";if(e.length>0){const e=t.sqlExprObj?r.dataSourceUtils.getArcGISSQL(t.sqlExprObj,n).sql:null;e&&(a=e)}else a="";return a||(a=""),a}(t,n,o);return u&&s.push(u),0===s.length?i="":1===s.length?i=s[0]:2===s.length&&(i=`(${s[0]}) AND (${s[1]})`),i||(i=""),i}))}var S=function(e,t,n,a){return new(n||(n=Promise))((function(o,i){function r(e){try{l(a.next(e))}catch(e){i(e)}}function s(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,s)}l((a=a.apply(e,t||[])).next())}))};class v extends r.AbstractMessageAction{filterMessageDescription(e){const t=e.widgetId;if(t&&u()){const e=s(t);if(e&&"widgets/common/chart/"===e.uri)return!1}return e.messageType===r.MessageType.DataRecordsSelectionChange}filterMessage(e){return!0}getDefaultMessageActionConfig(e){return{useAnyTriggerData:!0,messageUseDataSource:null,actionUseDataSource:null,sqlExprObj:null,enabledDataRelationShip:!0,connectionType:r.MessageActionConnectionType.SetCustomFields}}getSettingComponentUri(e,t){return(0,r.getAppStore)().getState().appRuntimeInfo.appMode===r.AppMode.Express?null:"message-actions/flash-action-setting"}onExecute(e,t){return S(this,void 0,void 0,(function*(){switch(e.type){case r.MessageType.DataRecordsSelectionChange:const n=e,a=n.records||[];if(0===a.length)break;let o=null;if(d(t)){if(o=function(e){var t,n,a,o;let i="",s="";if(e.length>0){const l=null===(n=null===(t=e[0])||void 0===t?void 0:t.dataSource)||void 0===n?void 0:n.getMainDataSource();if(l){i=l.id;const t=l.getIdField(),n=t&&(null===(o=null===(a=l.getSchema())||void 0===a?void 0:a.fields)||void 0===o?void 0:o[t]);if(n){const t=[];e.forEach((e=>{const n=e.getId();null!=n&&""!==n&&t.push(n)}));const a=g(t,r.JimuFieldType.Number);if(a.length>0){const e=!0,t=r.messageActionUtils.getSqlExpressionWidthMessageFieldValues(a,n,l,e);if(t){const e=(0,r.Immutable)(t),n=r.dataSourceUtils.getArcGISSQL(e,l);(null==n?void 0:n.sql)&&(s=null==n?void 0:n.sql)}}}}}let l=null;return i&&s&&(l={layerDataSourceId:i,querySQL:s}),l}(a),o&&o.layerDataSourceId&&o.querySQL){const e=`flashActionValue-${o.layerDataSourceId}`;r.MutableStoreManager.getInstance().updateStateValue(this.widgetId,e,o)}break}if(t)if(t.messageUseDataSource&&t.actionUseDataSource){const i=function(e,t){var n;const a=e.records||[];if(0===a.length)return!1;if(d())return!0;const o=function(e){var t,n;const a=[],o=e.records||[],i=(e.dataSourceIds||[]).filter((e=>!!e));if(o.length>0&&o[0]){const e=null===(n=null===(t=o[0])||void 0===t?void 0:t.dataSource)||void 0===n?void 0:n.getMainDataSource();if(e){a.push(e.id);const t=e.getAssociatedDataSource&&e.getAssociatedDataSource();t&&a.push(t.id)}}if((null==i?void 0:i.length)>0){const e=r.DataSourceManager.getInstance();i.forEach((t=>{const n=e.getDataSource(t);if(n){const e=n.getMainDataSource();e&&a.push(e.id)}}))}return Array.from(new Set(a))}(e),i=null===(n=null==t?void 0:t.messageUseDataSource)||void 0===n?void 0:n.mainDataSourceId;return i&&o.includes(i)}(n,t);if(!i){r.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"flashActionValue",null);break}const s=r.DataSourceManager.getInstance().getDataSource(t.messageUseDataSource.mainDataSourceId),l=r.DataSourceManager.getInstance().getDataSource(t.actionUseDataSource.mainDataSourceId);if(s&&l){const n=yield p(e,a,t,s,l);let i="";if(n){const e={outFields:[],where:n,returnGeometry:!0},t=l.getRealQueryParams(e,"query");i=t&&t.where}i||(i=""),o={layerDataSourceId:l&&l.id,querySQL:i}}else o=null}else o=null;const i=`flashActionValue-${null==o?void 0:o.layerDataSourceId}`;r.MutableStoreManager.getInstance().updateStateValue(this.widgetId,i,o)}return!0}))}}return i})())}}}));