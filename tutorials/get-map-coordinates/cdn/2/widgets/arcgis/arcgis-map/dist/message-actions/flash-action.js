System.register(["jimu-core"],(function(e,t){var n={};return{setters:[function(e){n.AbstractMessageAction=e.AbstractMessageAction,n.AppMode=e.AppMode,n.DataSourceManager=e.DataSourceManager,n.Immutable=e.Immutable,n.JimuFieldType=e.JimuFieldType,n.MessageActionConnectionType=e.MessageActionConnectionType,n.MessageType=e.MessageType,n.MutableStoreManager=e.MutableStoreManager,n.dataSourceUtils=e.dataSourceUtils,n.getAppStore=e.getAppStore,n.messageActionUtils=e.messageActionUtils}],execute:function(){e((()=>{var e={79244:e=>{"use strict";e.exports=n}},t={};function a(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,a),i.exports}a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.p="";var o={};return a.p=window.jimuConfig.baseUrl,(()=>{"use strict";a.r(o),a.d(o,{default:()=>g});var e=a(79244);function t(e){var t;if(!e)return null;const a=n();return null===(t=null==a?void 0:a.widgets)||void 0===t?void 0:t[e]}function n(){var t,n,a;return window.jimuConfig.isBuilder?null===(n=null===(t=(0,e.getAppStore)().getState())||void 0===t?void 0:t.appStateInBuilder)||void 0===n?void 0:n.appConfig:null===(a=(0,e.getAppStore)().getState())||void 0===a?void 0:a.appConfig}function i(){var t;const n=function(){var t;return(null===(t=window.jimuConfig)||void 0===t?void 0:t.isBuilder)?(0,e.getAppStore)().getState().appStateInBuilder:(0,e.getAppStore)().getState()}();return(null===(t=null==n?void 0:n.appRuntimeInfo)||void 0===t?void 0:t.appMode)===e.AppMode.Express}var r=function(e,t,n,a){return new(n||(n=Promise))((function(o,i){function r(e){try{l(a.next(e))}catch(e){i(e)}}function s(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,s)}l((a=a.apply(e,t||[])).next())}))};function s(e){const t=i(),n=null==e?void 0:e.useAnyTriggerData;return t||n}function l(t,n){const a=[];for(let o=0;o<t.length;o++){const i=t[o],r=e.messageActionUtils.formatValue(i,n);a.includes(r)||a.push(r)}return a}function u(t,n,a,o){return r(this,void 0,void 0,(function*(){let i="";if(n.enabledDataRelationShip){let{messageField:r,actionField:s}=function(t,n,a){var o,i,r,s;let l=null,u=null;if(t.messageUseDataSource.mainDataSourceId===t.actionUseDataSource.mainDataSourceId&&t.messageUseDataSource.rootDataSourceId===t.actionUseDataSource.rootDataSourceId){const e=n.getSchema(),t=e&&e.fields&&Object.keys(e.fields).find((t=>"esriFieldTypeOID"===e.fields[t].esriType));l=e&&e.fields&&e.fields[t],u=l}else{let c,d;if(t.connectionType===e.MessageActionConnectionType.UseLayersRelationship){const t=e.dataSourceUtils.getJimuDataSourceRelationship(n,a);t&&(c=t.keyField,d=t.relatedKeyField)}else c=null===(o=t.messageUseDataSource.fields)||void 0===o?void 0:o[0],d=null===(i=t.actionUseDataSource.fields)||void 0===i?void 0:i[0];c&&(l=null===(r=n.getSchema().fields)||void 0===r?void 0:r[c]),d&&(u=null===(s=a.getSchema().fields)||void 0===s?void 0:s[d])}return{messageField:l,actionField:u}}(n,a,o);if(r&&s){const u=r.name,c=r.type,d=t;let g=[];if(n.connectionType===e.MessageActionConnectionType.UseLayersRelationship){g=l((yield null==a?void 0:a.queryRelatedFieldValues(d.records||[],o,s.name))||[],c),0===g.length&&(g=["-1"],s=o.getSchema().fields[o.getIdField()])}else{g=l(d.records.map((e=>e.getData()[u])),c)}if(i="",g.length>0){const t=!0,n=e.messageActionUtils.getSqlExpressionWidthMessageFieldValues(g,s,o,t);if(n){const t=(0,e.Immutable)(n),a=e.dataSourceUtils.getArcGISSQL(t,o);(null==a?void 0:a.sql)&&(i=null==a?void 0:a.sql)}}i||(i="")}}return i||(i=""),i}))}function c(t,n,a,o,i){return r(this,void 0,void 0,(function*(){let r="";const s=[],l=yield u(t,a,o,i);l&&s.push(l);const c=function(t,n,a){let o="";if(t.length>0){const t=n.sqlExprObj?e.dataSourceUtils.getArcGISSQL(n.sqlExprObj,a).sql:null;t&&(o=t)}else o="";return o||(o=""),o}(n,a,i);return c&&s.push(c),0===s.length?r="":1===s.length?r=s[0]:2===s.length&&(r=`(${s[0]}) AND (${s[1]})`),r||(r=""),r}))}var d=function(e,t,n,a){return new(n||(n=Promise))((function(o,i){function r(e){try{l(a.next(e))}catch(e){i(e)}}function s(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,s)}l((a=a.apply(e,t||[])).next())}))};class g extends e.AbstractMessageAction{filterMessageDescription(n){const a=n.widgetId;if(a&&i()){const e=t(a);if(e&&"widgets/common/chart/"===e.uri)return!1}return n.messageType===e.MessageType.DataRecordsSelectionChange}filterMessage(e){return!0}getDefaultMessageActionConfig(t){return{useAnyTriggerData:!0,messageUseDataSource:null,actionUseDataSource:null,sqlExprObj:null,enabledDataRelationShip:!0,connectionType:e.MessageActionConnectionType.SetCustomFields}}getSettingComponentUri(t,n){return(0,e.getAppStore)().getState().appRuntimeInfo.appMode===e.AppMode.Express?null:"message-actions/flash-action-setting"}onExecute(t,n){return d(this,void 0,void 0,(function*(){switch(t.type){case e.MessageType.DataRecordsSelectionChange:const a=t,o=a.records||[];if(0===o.length)break;let i=null;if(s(n)){if(i=function(t){var n,a,o,i;let r="",s="";if(t.length>0){const u=null===(a=null===(n=t[0])||void 0===n?void 0:n.dataSource)||void 0===a?void 0:a.getMainDataSource();if(u){r=u.id;const n=u.getIdField(),a=n&&(null===(i=null===(o=u.getSchema())||void 0===o?void 0:o.fields)||void 0===i?void 0:i[n]);if(a){const n=[];t.forEach((e=>{const t=e.getId();null!=t&&""!==t&&n.push(t)}));const o=l(n,e.JimuFieldType.Number);if(o.length>0){const t=!0,n=e.messageActionUtils.getSqlExpressionWidthMessageFieldValues(o,a,u,t);if(n){const t=(0,e.Immutable)(n),a=e.dataSourceUtils.getArcGISSQL(t,u);(null==a?void 0:a.sql)&&(s=null==a?void 0:a.sql)}}}}}let u=null;return r&&s&&(u={layerDataSourceId:r,querySQL:s}),u}(o),i&&i.layerDataSourceId&&i.querySQL){const t=`flashActionValue-${i.layerDataSourceId}`;e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,t,i)}break}if(n)if(n.messageUseDataSource&&n.actionUseDataSource){const r=function(t,n){var a;const o=t.records||[];if(0===o.length)return!1;if(s())return!0;const i=function(t){var n,a;const o=[],i=t.records||[],r=(t.dataSourceIds||[]).filter((e=>!!e));if(i.length>0&&i[0]){const e=null===(a=null===(n=i[0])||void 0===n?void 0:n.dataSource)||void 0===a?void 0:a.getMainDataSource();if(e){o.push(e.id);const t=e.getAssociatedDataSource&&e.getAssociatedDataSource();t&&o.push(t.id)}}if((null==r?void 0:r.length)>0){const t=e.DataSourceManager.getInstance();r.forEach((e=>{const n=t.getDataSource(e);if(n){const e=n.getMainDataSource();e&&o.push(e.id)}}))}return Array.from(new Set(o))}(t),r=null===(a=null==n?void 0:n.messageUseDataSource)||void 0===a?void 0:a.mainDataSourceId;return r&&i.includes(r)}(a,n);if(!r){e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"flashActionValue",null);break}const l=e.DataSourceManager.getInstance().getDataSource(n.messageUseDataSource.mainDataSourceId),u=e.DataSourceManager.getInstance().getDataSource(n.actionUseDataSource.mainDataSourceId);if(l&&u){const e=yield c(t,o,n,l,u);let a="";if(e){const t={outFields:[],where:e,returnGeometry:!0},n=u.getRealQueryParams(t,"query");a=n&&n.where}a||(a=""),i={layerDataSourceId:u&&u.id,querySQL:a}}else i=null}else i=null;const r=`flashActionValue-${null==i?void 0:i.layerDataSourceId}`;e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,r,i)}return!0}))}}})(),o})())}}}));