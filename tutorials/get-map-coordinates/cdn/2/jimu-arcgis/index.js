System.register(["jimu-core","jimu-core/data-source","jimu-theme"],(function(e,t){var i={},r={},a={};return{setters:[function(e){i.AppMode=e.AppMode,i.CONSTANTS=e.CONSTANTS,i.DataRecordsSelectionChangeMessage=e.DataRecordsSelectionChangeMessage,i.DataSourceManager=e.DataSourceManager,i.DataSourceSelectionMode=e.DataSourceSelectionMode,i.DataSourceStatus=e.DataSourceStatus,i.DataSourceTypes=e.DataSourceTypes,i.ExBAddedJSAPIProperties=e.ExBAddedJSAPIProperties,i.ExternalResolvablePromise=e.ExternalResolvablePromise,i.Immutable=e.Immutable,i.JimuMapViewStatus=e.JimuMapViewStatus,i.LocationChangeMessage=e.LocationChangeMessage,i.MessageManager=e.MessageManager,i.MutableStoreManager=e.MutableStoreManager,i.React=e.React,i.ReactRedux=e.ReactRedux,i.ServiceManager=e.ServiceManager,i.SessionChangedReasonType=e.SessionChangedReasonType,i.SessionManager=e.SessionManager,i.SignInErrorCode=e.SignInErrorCode,i.SupportedLayerServiceTypes=e.SupportedLayerServiceTypes,i.UrlManager=e.UrlManager,i.WidgetState=e.WidgetState,i.appActions=e.appActions,i.appConfigUtils=e.appConfigUtils,i.dataSourceUtils=e.dataSourceUtils,i.defaultMessages=e.defaultMessages,i.geometryUtils=e.geometryUtils,i.getAppStore=e.getAppStore,i.i18n=e.i18n,i.loadArcGISJSAPIModule=e.loadArcGISJSAPIModule,i.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules,i.lodash=e.lodash,i.moduleLoader=e.moduleLoader,i.observeStore=e.observeStore,i.portalUrlUtils=e.portalUrlUtils,i.proxyUtils=e.proxyUtils,i.requestUtils=e.requestUtils,i.urlUtils=e.urlUtils,i.utils=e.utils,i.uuidv1=e.uuidv1},function(e){r.AbstractDataSource=e.AbstractDataSource,r.DataSourceError=e.DataSourceError,r.ItemMixinImpl=e.ItemMixinImpl,r.SetDataSourceMixinImpl=e.SetDataSourceMixinImpl,r.dataSourceJsonCreator=e.dataSourceJsonCreator},function(e){a.ThemeStore=e.ThemeStore,a.getTheme=e.getTheme}],execute:function(){e((()=>{"use strict";var e={244:e=>{e.exports=i},349:e=>{e.exports=r},888:e=>{e.exports=a}},t={};function s(i){var r=t[i];if(void 0!==r)return r.exports;var a=t[i]={exports:{}};return e[i](a,a.exports,s),a.exports}s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};s.r(n),s.d(n,{ADD_TO_MAP_DATA_ID_PREFIX:()=>We,ActionType:()=>Te,ArcGISDataSourceFactoryUriExtension:()=>pt,ArcGISDataSourceTypes:()=>d,ArcGISDependencyDefineExtension:()=>yt,DataChangeStatus:()=>Ue,DataChangeType:()=>Be,DataSourceTypes:()=>d,JimuBuildingComponentSublayerView:()=>Ve,JimuBuildingGroupSublayer:()=>be,JimuBuildingSceneLayerView:()=>Le,JimuFeatureLayerView:()=>ve,JimuGroupLayerView:()=>ue,JimuImageryLayerView:()=>Me,JimuImageryTileLayerView:()=>pe,JimuLayerView:()=>oe,JimuLayerViewComponent:()=>St,JimuMapImageLayerView:()=>he,JimuMapServiceLayerView:()=>de,JimuMapView:()=>He,JimuMapViewComponent:()=>wt,JimuMapViewGroup:()=>Qe,JimuOrientedImageryLayerView:()=>Ce,JimuQueriableLayerView:()=>fe,JimuSceneLayerView:()=>we,JimuSubtypeGroupLayerView:()=>Pe,JimuSubtypeSublayerView:()=>Ae,JimuTileLayerView:()=>ye,LayerTypes:()=>h,MapViewManager:()=>Xe,SHOW_ON_MAP_DATA_ID_PREFIX:()=>Ge,basemapUtils:()=>c,defaultMessages:()=>se,featureUtils:()=>u,geometryUtils:()=>y.geometryUtils,init:()=>It,loadArcGISJSAPIModules:()=>v,portalUtils:()=>l,zoomToUtils:()=>o});var o={};s.r(o),s.d(o,{getExtentFromScale:()=>I,layerExtent:()=>R,projectToSpatialReference:()=>G,zoomTo:()=>L});var l={};s.r(l),s.d(l,{checkDefaultBaseMapIsExist:()=>q,getDefaultWebMap:()=>Q,getDefaultWebMapWithoutCache:()=>$,getItemQueryStringByTypes:()=>N});var u={};s.r(u),s.d(u,{convertDataRecordSetToFeatureSet:()=>z,getDefaultSymbol:()=>X});var c={};s.r(c),s.d(c,{BasemapGroupType:()=>K,getBasemapGroup:()=>te,getBasemapItemsByGroupId:()=>ie,getLoadedBasemapList:()=>ae,getOrgBasemaps:()=>ee,isBasemap3D:()=>Z,loadBasemap:()=>re});var d,h,y=s(244);function p(e,t){var i;const r={};if(e.type!==y.DataSourceTypes.SubtypeGroupLayer)return r;const a={},s=e.getSubtypeField();t.forEach((e=>{const t=e.getFieldValue(s);null!=t&&(a[t]||(a[t]=[]),a[t].push(e))}));let n=null===(i=e.getChildDataSources)||void 0===i?void 0:i.call(e);return n||(n=[]),n.forEach((e=>{if(e.type!==y.DataSourceTypes.SubtypeSublayer)return;const t=e.getSubtypeCode(),i=(a[t]||[]).map((t=>{const i=t.clone();return i.dataSource=e,i}));r[e.id]=i})),r}function g(e,t){const i=e.getMapWidgetId(),r=new y.DataRecordsSelectionChangeMessage(i,t,[e.layerDataSourceId]);y.MessageManager.getInstance().publishMessage(r),e.type===h.SubtypeGroupLayer?function(e,t,i){const r=t.getLayerDataSource();if(!r)return;const a=p(r,i),s=y.MessageManager.getInstance();Object.keys(a).forEach((t=>{const i=a[t];if(i.length>0){const r=new y.DataRecordsSelectionChangeMessage(e,i,[t]);s.publishMessage(r)}}))}(i,e,t):e.type===h.SubtypeSublayer&&function(e,t,i){const r=t.getLayerDataSource();if(!r)return;const a=r.parentDataSource;if(!a)return;const s=m(t.layer),n=t.layer.subtypeCode,o=a.getSelectedRecords().filter((e=>e.getFieldValue(s)!==n)),l=function(e,t){return t.map((t=>{const i=t.clone();return i.dataSource=e,i}))}(a,i);o.push(...l);const u=new y.DataRecordsSelectionChangeMessage(e,o,[a.id]);y.MessageManager.getInstance().publishMessage(u)}(i,e,t)}function m(e){if(!e)return null;const t=e.subtypeField;if(t){const i=e.getField(t);if(i&&i.name)return i.name}return t}!function(e){e.Map="MAP",e.WebMap="WEB_MAP",e.WebScene="WEB_SCENE"}(d||(d={})),function(e){e.BaseDynamicLayer="base-dynamic",e.BaseElevationLayer="base-elevation",e.BaseTileLayer="base-tile",e.BuildingSceneLayer="building-scene",e.BuildingGroupSublayer="building-group",e.BuildingComponentSublayer="building-component",e.CSVLayer="csv",e.ElevationLayer="elevation",e.FeatureLayer="feature",e.GeoJSONLayer="geojson",e.GeoRSSLayer="geo-rss",e.GraphicsLayer="graphics",e.GroupLayer="group",e.SubtypeGroupLayer="subtype-group",e.SubtypeSublayer="subtype-sublayer",e.ImageryLayer="imagery",e.ImageryTileLayer="imagery-tile",e.OrientedImageryLayer="oriented-imagery",e.IntegratedMeshLayer="integrated-mesh",e.KMLLayer="kml",e.MapImageLayer="map-image",e.MapNotesLayer="map-notes",e.PointCloudLayer="point-cloud",e.SceneLayer="scene",e.TileLayer="tile",e.UnknownLayer="unknown",e.UnsupportedLayer="unsupported",e.VectorTileLayer="vector-tile",e.WMSLayer="wms",e.WMTSLayer="wmts",e.WebTileLayer="web-tile"}(h||(h={}));var f=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};function v(e){return f(this,void 0,void 0,(function*(){return yield(0,y.loadArcGISJSAPIModules)(e)}))}var w=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};let S=null;function L(e,t,i){return w(this,void 0,void 0,(function*(){if(!e)return yield Promise.reject(new Error("Invalid target."));if(!t)return yield Promise.reject(new Error("Invalid target."));let r,a,s;i||(i={});const n=yield v(["esri/Graphic","esri/geometry/Extent","esri/layers/Layer","esri/layers/support/TileInfo"]);[r,a,s,S]=n;const o=i.padding;o&&e.padding&&(e.padding.left=o.left||0,e.padding.right=o.right||0,e.padding.top=o.top||0,e.padding.bottom=o.bottom||0);let l=null;try{function u(e){return!!e&&(e instanceof s||"esri.layers.buildingSublayers.BuildingComponentSublayer"===e.declaredClass||"esri.layers.support.SubtypeSublayer"===e.declaredClass)}t instanceof a?yield M(e,t,i.scale):Array.isArray(t)&&t.length&&t[0]instanceof r?yield b(e,t,i.scale):Array.isArray(t)&&t.length&&t[0]instanceof Array&&t[0][0]instanceof r?yield function(e,t,i){return w(this,void 0,void 0,(function*(){if(0===t.length)return Promise.resolve();if(1===t.length)return b(e,t[0],i);{const r=[];t.forEach((t=>{r.push(J(e,t).catch((()=>null)))}));let a=null;return Promise.all(r).then((t=>(t.forEach((e=>{e&&(a=a?a.union(e):e)})),M(e,a,i))))}}))}(e,t,i.scale):u(t)?yield V(e,t,null,null,i):t.layer&&u(t.layer)&&t.extent&&t.extent instanceof a?yield V(e,t.layer,null,t.extent,i):t.layer&&u(t.layer)&&Array.isArray(t.graphics)?0===t.graphics.length?yield V(e,t.layer,null,null,i):t.graphics.length&&t.graphics[0]instanceof r&&(yield V(e,t.layer,t.graphics,null,i)):Array.isArray(t)&&t.length&&u(t[0])?yield function(e,t,i){return w(this,void 0,void 0,(function*(){if(1===(null==t?void 0:t.length))return V(e,t[0],null,null,i);{let r=null;const a=[];return t.forEach((t=>a.push(R(e,t,null==i?void 0:i.queryParams)))),Promise.all(a).then((t=>(t.forEach((e=>{e&&(r=r?r.union(e):e)})),C(e,r))))}}))}(e,t,i):l=new Error("Invalid target.")}catch(c){l=c}return e.padding&&(e.padding.left=0,e.padding.right=0,e.padding.top=0,e.padding.bottom=0),l?(console.warn("zoomTo warning",l),Promise.reject(l)):Promise.resolve()}))}function I(e,t,i){return w(this,arguments,void 0,(function*(e,t,i,r=!0){return U(e,t,i,r)}))}function b(e,t,i){return w(this,void 0,void 0,(function*(){return"3d"!==e.type||i?J(e,t).then((t=>w(this,void 0,void 0,(function*(){return M(e,t,i)})))).catch((e=>w(this,void 0,void 0,(function*(){return Promise.reject(e)})))):e.goTo(t)}))}function V(e,t,i,r,a){return w(this,void 0,void 0,(function*(){let s,n=null==a?void 0:a.scale;if(s=r&&D(r)?r:i&&i.length>0?yield J(e,i):yield R(e,t,null==a?void 0:a.queryParams),!D(s))return Promise.reject(new Error("Invalid extent."));const o=yield G([s],e.spatialReference);if(s=o[0],n)return B(e,s,n).then((t=>C(e,t)));if("3d"===e.type)return e.goTo(s);{let i=t.minScale||0,r=t.maxScale||0;if(A(s)){let t=E(e,i,r,3);return t?(s=T(e,s),B(e,s,t).then((t=>C(e,t)))):C(e,s)}return s=T(e,s),function(e,t){return w(this,void 0,void 0,(function*(){return yield v(["esri/config","esri/geometry/support/WKIDUnitConversion"]).then((i=>{let r,a,s;[r,a]=i;const n=e.size[0],o=39.37,l=20015077/180,u=a;let c,d,h=t.spatialReference;h&&(c=h.wkid,d=h.wkt);let y=null;if(c)y=u.values[u[c]];else if(d&&-1!==d.search(/^PROJCS/i)){const e=/UNIT\[([^\]]+)\]\]$/i.exec(d);e&&e[1]&&(y=parseFloat(e[1].split(",")[1]))}return s=t.width/n*(y||l)*o*(r.screenDPI||96),s})).catch((e=>w(this,void 0,void 0,(function*(){return yield Promise.reject()}))))}))}(e,s).then((t=>i>0&&t>i?(i=O(e,i,!0),B(e,s,i).then((t=>C(e,t)))):t<r?(r=O(e,r,!1),B(e,s,r).then((t=>C(e,t)))):C(e,s)))}}))}function M(e,t,i){return w(this,void 0,void 0,(function*(){return D(t=t.clone())?G([t],e.spatialReference).then((i=>{let r=i&&i[0];return r||(r=t),A(r)?function(e,t){return w(this,void 0,void 0,(function*(){const i=E(e,0,0,3);return i?yield B(e,t,i):yield Promise.reject()}))}(e,r):r})).then((t=>i?B(e,t,i,!1):t)).then((t=>C(e,t))).catch((e=>w(this,void 0,void 0,(function*(){return Promise.reject(e)})))):Promise.reject(new Error("Invalid extent."))}))}function C(e,t){return new Promise(((i,r)=>{setTimeout((()=>{e.goTo(t).then((()=>{i()})).catch((()=>{r()}))}),400)}))}function D(e){return e&&P(e.xmin)&&P(e.ymin)&&P(e.xmax)&&P(e.ymax)}function P(e){return 0===e||!!e}var F;function A(e){return e.xmin+F.X===e.xmax-F.X&&e.ymin+F.Y===e.ymax-F.Y}function J(e,t){return w(this,arguments,void 0,(function*(e,t,i={}){let r=t&&t[0]&&t[0].layer;return r&&"scene"===r.type?yield function(e,t){return w(this,void 0,void 0,(function*(){return yield v(["esri/rest/support/Query"]).then((i=>w(this,void 0,void 0,(function*(){const[r]=i;if(t){const i=new r;return i.objectIds=e.map((e=>e.attributes[t.objectIdField])),i.returnGeometry=!0,t.queryExtent(i).then((e=>1===e.count?e.extent.expand(3.5):e.extent.expand(2)))}return Promise.reject()})))).catch((e=>w(this,void 0,void 0,(function*(){return yield Promise.reject(e)}))))}))}(t,r,i.factor):"3d"===e.type?yield j(t,3):yield j(t)}))}function j(e,t){return w(this,void 0,void 0,(function*(){return yield v(["esri/Graphic","esri/geometry/Extent","esri/geometry/Point"]).then((i=>{let r,a,s,n=null,o=e;[r,a,s]=i;try{if(o&&1===o.length&&o[0].geometry&&"esri.geometry.Multipoint"===o[0].geometry.declaredClass&&1===o[0].geometry.points.length){const e=o[0].geometry.points[0];o=[new r({geometry:new s({x:e[0],y:e[1],spatialReference:o[0].geometry.spatialReference})})]}if(o&&1===o.length&&o[0].geometry&&"esri.geometry.Point"===o[0].geometry.declaredClass){const e=o[0].geometry;n=new a({xmin:e.x-F.X,ymin:e.y-F.Y,xmax:e.x+F.X,ymax:e.y+F.Y,spatialReference:e.spatialReference})}else o&&o.length>0&&(n=function(e,t){if(!e||!e.length)return null;let i,r=null,a=e.length;for(i=0;i<a;i++){const a=e[i].geometry;if(!a)continue;let s=a.extent;s||"point"!==a.type||null==a.x||null==a.y||(s=new t({xmin:a.x,ymin:a.y,xmax:a.x,ymax:a.y,spatialReference:a.spatialReference})),s&&(r=r?r.union(s):s)}if(!r||r.width<0||r.height<0)return null;return r}(o,a),n&&t&&t>0&&(n=n.expand(t)));return n}catch(e){return Promise.reject(e)}})).catch((e=>w(this,void 0,void 0,(function*(){return yield Promise.reject(e)}))))}))}function x(e){var t;let i=[];const r=null===(t=e.map.basemap)||void 0===t?void 0:t.baseLayers;return null==r||r.forEach((e=>{e&&e.tileInfo&&e.tileInfo.lods&&i.length<e.tileInfo.lods.length&&(i=e.tileInfo.lods)})),i&&0!==i.length?i:S.create().lods}function E(e,t,i,r){const a=x(e);let s,n=1;if(a){const e=[],o=[];let l;a.forEach((r=>{t>0&&r.scale>t||(r.scale<i?o.push(r.scale):e.push(r.scale))})),e.reverse(),e.length>=1?(n=o.length?o.length/a.length:1,l=Math.floor((e.length-1)/(r/n)),s=e[l]):s=null}else s=0===t?null:(t-i)/r;return s}function O(e,t,i){let r;const a=x(e);if(a){if(i){for(r=0;r<a.length;r++)if(a[r].scale<t)return a[r].scale-1;return a[a.length-1].scale-1}for(r=a.length-1;r>=0;r--)if(a[r].scale>t)return a[r].scale+1;return a[0].scale+1}return i?t-1:t+1}function T(e,t){const i=e.size[0]/e.size[1],r=t.width/t.height,a=t.center.x,s=t.center.y;if(r>i){const e=t.width/i/2;t.ymin=s-e,t.ymax=s+e}else if(r<i){const e=t.height*i/2;t.xmin=a-e,t.xmax=a+e}return t}function B(e,t,i){return w(this,arguments,void 0,(function*(e,t,i,r=!0){return U({width:e.size[0],height:e.size[1]},t,i,r)}))}function U(e,t,i){return w(this,arguments,void 0,(function*(e,t,i,r=!0){return r&&(t=function(e,t){const i=t.width*(e.height/e.width)/5,r=t.center.y;return t.ymin=r-i,t.ymax=r+i,t}(e,t.clone())),yield v(["esri/config","esri/geometry/support/WKIDUnitConversion"]).then((r=>{let a,s;[a,s]=r;const n=e.width,o=s;let l,u,c=t.spatialReference;c&&(l=c.wkid,u=c.wkt);let d=null;if(l)d=o.values[o[l]];else if(u&&-1!==u.search(/^PROJCS/i)){const e=/UNIT\[([^\]]+)\]\]$/i.exec(u);e&&e[1]&&(d=parseFloat(e[1].split(",")[1]))}return t.expand(i*n/(39.37*(d||20015077/180)*(a.screenDPI||96))/t.width)})).catch((e=>w(this,void 0,void 0,(function*(){return yield Promise.reject()}))))}))}function R(e,t,i){return w(this,void 0,void 0,(function*(){var r;!t.loaded&&t.load&&(yield t.load());const a="esri.layers.SubtypeGroupLayer"===t.declaredClass;let s=t.fullExtent||t.initialExtent;if(t.sublayers&&!a||t.type===h.GroupLayer){if(s)return Promise.resolve(null==s?void 0:s.clone());{const r=[];return(t.type===h.GroupLayer?t.layers:t.sublayers).forEach((t=>r.push(R(e,t,i)))),Promise.all(r).then((e=>{var i;return e.forEach((e=>{e&&(s=s?s.union(e):e)})),s||(null===(i=t.fullExtent)||void 0===i?void 0:i.clone())}))}}return(null===(r=t.capabilities)||void 0===r?void 0:r.query)?yield function(e,t,i){return w(this,void 0,void 0,(function*(){var r,a;const s=(null===(r=t.fullExtent)||void 0===r?void 0:r.clone())||(null===(a=t.initialExtent)||void 0===a?void 0:a.clone()),n=t.capabilities.query;return n?yield v(["esri/rest/support/Query","esri/geometry/Extent"]).then((r=>{let a,o;[a,o]=r;const l=new a;if(l.where=(null==i?void 0:i.where)||(null==t?void 0:t.definitionExpression)||"1=1",l.outSpatialReference=e.spatialReference,l.returnGeometry=!0,n.supportsExtent){const i="esri.layers.support.SubtypeSublayer"===t.declaredClass;return!t.queryExtent&&i?function(e,t){return w(this,void 0,void 0,(function*(){const i=e.parent;if(i){const r=t.clone(),a=`${m(e)} = ${e.subtypeCode}`;r.where?r.where=`(${r.where}) AND (${a})`:r.where=a;const s=yield i.queryExtent(r);if(s)return s.extent}return null}))}(t,l):t.queryExtent(l).then((i=>{var r,a;if("3d"===e.type)return i.extent;if(1===i.count&&"point"===t.geometryType&&(null===(r=null==i?void 0:i.extent)||void 0===r?void 0:r.center)){const t=null===(a=null==i?void 0:i.extent)||void 0===a?void 0:a.center;return new o({xmin:t.x-F.X,ymin:t.y-F.Y,xmax:t.x+F.X,ymax:t.y+F.Y,spatialReference:e.spatialReference})}return i.extent})).catch((e=>w(this,void 0,void 0,(function*(){return yield Promise.resolve(s)}))))}return s?Promise.resolve(s):t.queryFeatures?t.queryFeatures(l).then((t=>w(this,void 0,void 0,(function*(){return J(e,t.features)})))).catch((e=>w(this,void 0,void 0,(function*(){return yield Promise.resolve(s)})))):void 0})).catch((e=>w(this,void 0,void 0,(function*(){return yield Promise.resolve(s)})))):Promise.resolve(s)}))}(e,t,i):yield Promise.resolve(null==s?void 0:s.clone())}))}function G(e,t){return w(this,void 0,void 0,(function*(){return yield v(["esri/geometry/Extent"]).then((i=>{let r;return[r]=i,y.geometryUtils.projectToSpatialReference(e,t).then((e=>e.map((e=>{if("extent"!==e.type||0!==e.width&&0!==e.height)return e;return new r({xmin:e.xmin-F.X,ymin:e.ymin-F.Y,xmax:e.xmax+F.X,ymax:e.ymax+F.Y,spatialReference:e.spatialReference})}))))})).catch((e=>w(this,void 0,void 0,(function*(){return yield Promise.reject()}))))}))}!function(e){e[e.X=1e-4]="X",e[e.Y=1e-4]="Y"}(F||(F={}));var W=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};const k=" "+N(["Web Map"])+" ";let H=null;function q(){const e=(0,y.getAppStore)().getState().portalSelf;return!!(e&&e.defaultBasemap&&e.defaultBasemap.baseMapLayers&&e.defaultBasemap.baseMapLayers[0]&&e.defaultBasemap.baseMapLayers[0].url)}function Q(e){return W(this,void 0,void 0,(function*(){return H||(H=$(e),H)}))}function $(e){return W(this,void 0,void 0,(function*(){const t=new(0,(yield v(["esri/portal/Portal"]))[0])({url:e});yield t.load();const i=t.sourceJSON,r=i.defaultBasemap&&i.defaultBasemap.id,a=i.defaultExtent;if(r)return{defaultMapId:r,defaultExtent:a};const s=yield function(e,t,i){return W(this,void 0,void 0,(function*(){const e=t.defaultBasemap&&t.defaultBasemap.title,r=t.useVectorBasemaps&&t.vectorBasemapGalleryGroupQuery?t.vectorBasemapGalleryGroupQuery:t.basemapGalleryGroupQuery;return yield i.queryGroups({f:"json",query:r}).then((t=>W(this,void 0,void 0,(function*(){const r=t.results;if(r.length>0){const t=r[0],a=k+" AND group:"+t.id;return yield i.queryItems({start:1,num:1,f:"json",query:a}).then((t=>W(this,void 0,void 0,(function*(){let r=t.results;r=r.filter((e=>e.type&&"web map"===e.type.toLowerCase()));let a=null;if(r.length>0&&(a=r.find((t=>{var i;return null===(i=t.title)||void 0===i?void 0:i.toLowerCase().includes(null==e?void 0:e.toLowerCase())}))),a)return Promise.resolve(a.id);{const t=`${k} AND owner:esri AND title:"${e}"`;return i.queryItems({start:1,num:1,f:"json",query:t}).then((e=>W(this,void 0,void 0,(function*(){let t=e.results;if(t=t.filter((e=>e.type&&"web map"===e.type.toLowerCase())),t.length>0){const e=t[0];return Promise.resolve(e.id)}return Promise.resolve(null)}))))}}))))}}))))}))}(0,i,t);if(s){const e=yield function(e,t){return W(this,void 0,void 0,(function*(){try{const i=yield v(["esri/portal/PortalItem"]),r=new(0,i[0])({portal:e,id:t}),a=yield r.fetchData();if(a&&a.version&&"string"==typeof a.version){return parseFloat(a.version.split(".")[0])>=2}}catch(e){return console.error("validate web map version error",t,e),!1}return!1}))}(t,s);if(e)return{defaultMapId:s,defaultExtent:a}}const n=yield function(e){return W(this,void 0,void 0,(function*(){const t={start:1,num:1,f:"json",query:k+" AND access:public AND owner:esri_en",sortField:"num-views",sortOrder:"desc",disableExtraQuery:!0};return yield e.queryItems(t).then((e=>W(this,void 0,void 0,(function*(){let t=e.results;if(t=t.filter((e=>e.type&&"web map"===e.type.toLowerCase())),t.length>0){const e=t[0];return Promise.resolve(e.id)}return Promise.resolve(null)}))))}))}(t);return{defaultMapId:n,defaultExtent:a}}))}function N(e){let t="";const i=function(){let e=[];const t=["Web Map","Web Scene","CityEngine Web Scene"],i=["Feature Service","Map Service","Image Service","KML","WMS","Feature Collection","Feature Collection Template","Geodata Service","Globe Service"],r=["Geometry Service","Geocoding Service","Network Analysis Service","Geoprocessing Service"],a=["Web Mapping Application","Mobile Application","Code Attachment","Operations Dashboard Add In","Operation View"],s=["Symbol Set","Color Set","Shapefile","CSV","Service Definition","Document Link","Microsoft Word","Microsoft PowerPoint","Microsoft Excel","PDF","Image","Visio Document"],n=["Map Document","Map Package","Tile Package","ArcPad Package","Explorer Map","Globe Document","Scene Document","Published Map","Map Template","Windows Mobile Package"],o=["Layer","Layer Package","Explorer Layer"],l=["Geoprocessing Package","Geoprocessing Sample","Locator Package","Rule Package"],u=["Workflow Manager Package","Desktop Application","Desktop Application Template","Code Sample","Desktop Add In","Explorer Add In"];return e=e.concat(t).concat(i).concat(r).concat(a).concat(s),e=e.concat(n).concat(o).concat(l).concat(u),e}();if(e&&e.length>0&&e.length>0){let r="";for(let t=0;t<e.length;t++){r+=' type:"'+e[t]+'" ',t!==e.length-1&&(r+=" OR ")}t=" ( "+r+" ) ";const a=e.concat(i).filter((t=>e.every((e=>!e.toLowerCase().includes(t.toLowerCase())))));for(let e=0;e<a.length;e++){t+=' -type:"'+a[e]+'" '}}return t}var _=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};function z(e){return(0,y.loadArcGISJSAPIModules)(["esri/Graphic","esri/rest/support/FeatureSet"]).then((t=>_(this,void 0,void 0,(function*(){const[i,r]=t,a=new r,s=y.dataSourceUtils.changeRestAPIGeometryTypeToJSAPIGeometryType(e.dataSource.getGeometryType());return a.geometryType=s,a.features=e.records.map((e=>{let t;const r=e.feature;return"esri.Graphic"===(null==r?void 0:r.declaredClass)?t=r.clone():(r.geometry&&(r.geometry.type=s),t=new i({geometry:r.geometry,attributes:r.attributes})),t})),a})))).catch((e=>(console.warn(e),null)))}function X(e){let t=null;switch(e){case"point":t={type:"esriSMS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}};break;case"polyline":t={type:"esriSLS",color:[255,255,0,150],width:.75};break;case"polygon":t={type:"esriSFS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}}}return t}var K,Y=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};function Z(e){var t;return"Web Scene"===(null===(t=e.portalItem)||void 0===t?void 0:t.type)||e.referenceLayers.some((e=>"scene"===e.type))}function ee(){return Y(this,void 0,void 0,(function*(){const e=yield v(["esri/portal/Portal","esri/Basemap"]),[t,i]=e,r=(0,y.getAppStore)().getState().portalUrl,a=new t({url:r});yield a.load();const s=a.sourceJSON,n=yield te(a,s),o=null==n?void 0:n.id;if(!o)return[];let l=[...yield ie(a,r,o,"title","asc")];if(s.use3dBasemaps){const e=yield te(a,s,K.EsriDefault3d),t=null==e?void 0:e.id;if(t){l=[...yield ie(a,r,t,"title","asc",!0),...l]}}return yield ae(i,l)}))}function te(e,t){return Y(this,arguments,void 0,(function*(e,t,i=K.OrgDefault){try{const r=function(e,t){switch(t){case K.EsriDefault:return'title:"ArcGIS Online Basemaps" AND owner:esri_en';case K.EsriDefault3d:return e["3DBasemapGalleryGroupQuery"];case K.OrgDefault:return e.useVectorBasemaps&&e.vectorBasemapGalleryGroupQuery?e.vectorBasemapGalleryGroupQuery:e.basemapGalleryGroupQuery}}(t,i),a=yield e.queryGroups({query:r,disableExtraQuery:!0});return a.results.length>0?a.results[0]:null}catch(e){return console.log("Failed to get basemap groups",e),null}}))}function ie(e,t,i,r,a){return Y(this,arguments,void 0,(function*(e,t,i,r,a,s=!1,n=!0){try{const o=`group:${i} AND ${N([s?"Web Scene":"Web Map"])}`,l=yield e.queryItems({start:1,num:100,sortField:"title"!==r&&r?`${r},title`:r,sortOrder:a,query:o,disableExtraQuery:n});return((null==l?void 0:l.results)?l.results:[]).map((e=>{const i=y.portalUrlUtils.getItemUrl(t,e.id)+"/info/"+e.thumbnail;return{id:e.id,title:e.title,thumbnailUrl:i,type:e.type}}))}catch(e){return console.log("Failed to get basemap items by  group id",e),[]}}))}!function(e){e.EsriDefault="ESRI_DEFAULT",e.EsriDefault3d="ESRI_DEFAULT_3D",e.OrgDefault="ORG_DEFAULT"}(K||(K={}));const re=e=>Y(void 0,void 0,void 0,(function*(){try{yield e.load()}catch(e){console.error("basemap load error",e)}return e})),ae=(e,t)=>Promise.all(t.map((t=>Y(void 0,void 0,void 0,(function*(){const i=new e({portalItem:{id:t.id}});return re(i)}))))),se={layerIsNotSupported:"This layer type is not supported."};var ne=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class oe{constructor(e){this.runTimeIsHidden=!1,this.removeableByMapTool=!1,this.id=e.id,this.mapViewManager=e.mapViewManager,this.type=e.type,this.layerDataSourceId=e.layerDataSourceId,this.jimuMapViewId=e.jimuMapViewId,this.jimuLayerId=e.jimuLayerId,this.layer=e.layer,this.parentJimuLayerViewId=e.parentJimuLayerViewId,this.index=e.index,this.fromRuntime=e.fromRuntime,this.isLoaded=!1;let t="";if(this.parentJimuLayerViewId){const e=this.getParentJimuLayerView();e&&(t=e.hierarchyLevel)}if(this.hierarchyLevel=t?`${t}.${this.index}`:this.index.toString(),this.layer&&(this.originalLayerVisible=this.layer.visible,e.urlHashLayersVisibility&&!this.fromRuntime)){const t=e.urlHashLayersVisibility[this.id];"boolean"==typeof t&&this.layer.visible!==t&&(this.layer.visible=t)}const i=y.appConfigUtils.getDataSourceJsonById(this.getAppConfig(),this.layerDataSourceId);if(i){const e=i.isHidden,t=i.label;t&&t!==this.layer.title&&(this.layer.title=t),this.runTimeIsHidden=e,e&&(this.layer.visible=!e)}this.initListenToDataSourceJsonChange(),this.initListenToDataSourceInfoChange(),(this.isLayerUsedByFilter()||this.isLayerUsedBySelection())&&this.createLayerDataSource(),this.watchLayerVisibleChange()}ready(){return ne(this,void 0,void 0,(function*(){return Promise.resolve(this)}))}whenViewLoaded(){return ne(this,void 0,void 0,(function*(){if(!this.view&&!this.isLoaded)try{const e=this.getJimuMapView();yield e.whenJimuLayerViewLoaded(this.id)}catch(e){console.error(`whenViewLoaded error, jimuLayerViewId: ${this.id}`,e)}}))}validateDataSource(e){return!0}getLayerDataSource(){let e=y.DataSourceManager.getInstance().getDataSource(this.layerDataSourceId);return e&&!this.validateDataSource(e)&&(console.error(`JimuLayerView ${this.id} gets wrong data source type ${e.type}, data source id: ${this.layerDataSourceId}`),e=null),e}createLayerDataSource(){return ne(this,void 0,void 0,(function*(){let e=y.DataSourceManager.getInstance().getDataSource(this.layerDataSourceId);if(!e)try{const t=this.getMapDataSource();if(t)e=yield t.createDataSourceByLayer(this.layer);else{e=y.DataSourceManager.getInstance().getDataSource(this.layerDataSourceId);const t=this.getParentJimuLayerView();if(t){const i=t.getLayerDataSource();(null==i?void 0:i.isDataSourceSet())&&i.createDataSourceById&&(e=yield i.createDataSourceById(this.layerDataSourceId))}}}catch(t){console.error(`JimuLayerView ${this.id} create layer data source failed:`,t),e=null}return e&&!this.validateDataSource(e)&&(console.error(`JimuLayerView ${this.id} gets wrong data source type ${e.type}, data source id: ${this.layerDataSourceId}`),e=null),e}))}getOrCreateLayerDataSource(){return ne(this,void 0,void 0,(function*(){let e=this.getLayerDataSource();if(!e)try{e=yield this.createLayerDataSource()}catch(t){e=null,console.error(`JimuLayerView ${this.id} createLayerDataSource error`,t)}return e}))}getParentJimuLayerView(){const e=this.getJimuMapView();return e&&this.parentJimuLayerViewId?e.jimuLayerViews[this.parentJimuLayerViewId]:null}getAllAncestorJimuLayerViews(){let e=[];const t=this.getJimuMapView();return t&&(e=t.getParentJimuLayerViews(this.id)),e}isLayerUsedByFilter(){const e=(0,y.getAppStore)().getState().appConfig.dataSources||{},t=Object.values(e);for(;t.length>0;){const e=t.shift();if(e.id===this.layerDataSourceId)return!!e.query;if(this.layerDataSourceId.startsWith(e.id)&&e.childDataSourceJsons){const i=Object.values(e.childDataSourceJsons);t.push(...i)}}return!1}isLayerUsedBySelection(){if(this.layerDataSourceId){if(this.isLayerDataSourceUsedBySelection(this.layerDataSourceId))return!0;const e=this.layerDataSourceId+"-associated_data_source";if(this.isLayerDataSourceUsedBySelection(e))return!0}return!1}isLayerDataSourceUsedBySelection(e){var t,i;if(e){let r=null===(t=(0,y.getAppStore)().getState().dataSourcesInfo)||void 0===t?void 0:t[e];if(!r){const t=y.urlUtils.getDataSourceInfosFromUrlParams(y.UrlManager.getInstance().getQueryObject(),y.UrlManager.getInstance().getHashObject()),i=null==t?void 0:t[e];Array.isArray(null==i?void 0:i.selection)?r={selectedIds:null==i?void 0:i.selection}:(null==i?void 0:i.selection)&&(r={selectOptions:null==i?void 0:i.selection})}if(r&&(r.selectOptions||(null===(i=r.selectedIds)||void 0===i?void 0:i.length)>0))return!0}return!1}isLayerVisible(){return[this,...this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).getParentJimuLayerViews(this.id)].every((e=>e.layer.visible))}isLayerVisibleForRendering(){if(!this.isLayerVisible())return!1;const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId),t=[this,...e.getParentJimuLayerViews(this.id)],i=e.view.scale;return t.every((e=>{const t=e.layer;if(t){const e=t.minScale,r=t.maxScale;return("number"!=typeof r||0===r||i>=r)&&("number"!=typeof e||0===e||i<=e)}return!1}))}getMapSceneView(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);return e&&e.view}getMapDataSource(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).dataSourceId;return y.DataSourceManager.getInstance().getDataSource(e)}onLayerDataSourceInfoChange(e,t){var i;const r=null===(i=this.getLayerDataSource())||void 0===i?void 0:i.getLabel();if(r&&r!==this.layer.title){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId),t=y.i18n.getIntl().formatMessage({id:"action_addedData",defaultMessage:y.defaultMessages.action_addedData},{label:r});this.layer.title=r,y.MutableStoreManager.getInstance().updateStateValue(e.mapWidgetId,`addToMapDatas.${this.layer.id}.title`,t)}}getJimuMapView(){return this.mapViewManager.getJimuMapViewById(this.jimuMapViewId)}destroy(){this.watchLayerVisibleChangeHandle&&(this.watchLayerVisibleChangeHandle.remove(),this.watchLayerVisibleChangeHandle=null),this.dataSourceInfoObserver&&this.dataSourceInfoObserver(),this.dataSourceJsonObserver&&this.dataSourceJsonObserver()}getAppConfig(){var e;return window.jimuConfig.isBuilder?null===(e=(0,y.getAppStore)().getState().appStateInBuilder)||void 0===e?void 0:e.appConfig:(0,y.getAppStore)().getState().appConfig}initListenToDataSourceJsonChange(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).dataSourceId;this.dataSourceJsonObserver=(0,y.observeStore)(this.onLayerDatasourceJsonChange.bind(this),["appConfig","dataSources",e])}initListenToDataSourceInfoChange(){this.dataSourceInfoObserver=(0,y.observeStore)(this.onLayerDataSourceInfoChange.bind(this),["dataSourcesInfo",this.layerDataSourceId])}onLayerDatasourceJsonChange(e,t){if(!y.appConfigUtils.getDataSourceJsonById(this.getAppConfig(),this.layerDataSourceId))return;const i=y.appConfigUtils.getDataSourceJsonById(this.getAppConfig(),this.layerDataSourceId).isHidden;this.runTimeIsHidden!==i&&(this.runTimeIsHidden=i,this.layer.visible=!i)}watchLayerVisibleChange(){this.layer&&(this.watchLayerVisibleChangeHandle&&(this.watchLayerVisibleChangeHandle.remove(),this.watchLayerVisibleChangeHandle=null),this.watchLayerVisibleChangeHandle=this.layer.watch("visible",(e=>{const t=this.getJimuMapView();if(!t)return;this.fromRuntime||t&&t.updateUrlHashLayerVisibility();t.getAllChildJimuLayerViews(this.id).forEach((t=>{t.onParentLayerVisibleChange(e)})),t.onJimuLayerViewSelfVisibleChange(this)})))}onParentLayerVisibleChange(e){}getMapWidgetId(){const e=this.getJimuMapView();return(null==e?void 0:e.mapWidgetId)||""}setRemoveableByMapTool(e){var t;this.removeableByMapTool=e;const i=this.getMapWidgetId(),r=null===(t=this.layer)||void 0===t?void 0:t.id,a=this.getJimuMapView();if(i&&r&&a){const e=a.id,t=(y.MutableStoreManager.getInstance().getStateValue([i])||{}).removeableLayerIdsInfo||{},r=[];Object.values(a.jimuLayerViews).forEach((e=>{e.removeableByMapTool&&e.layer&&r.push(e.layer.id)})),t[e]=r,y.MutableStoreManager.getInstance().updateStateValue(i,"removeableLayerIdsInfo",t)}}supportTime(){return this.layer&&y.dataSourceUtils.doesJSAPILayerSupportTime(this.layer)}}var le=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class ue extends oe{constructor(e){super(e),this.url=null,this.url=e.url}ready(){return le(this,void 0,void 0,(function*(){var e,t,i,r;const a=(null===(t=null===(e=this.layer.layers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse())||(null===(r=null===(i=this.layer.sublayers)||void 0===i?void 0:i.toArray())||void 0===r?void 0:r.reverse());if(a&&a.length>0)for(let e=0;e<a.length;e++)yield this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).createJimuLayerView(a[e],this.jimuLayerId,e,null,this.fromRuntime);return this}))}}var ce=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class de extends oe{constructor(e){super(e),this.url=null,this.url=e.url}ready(){return ce(this,void 0,void 0,(function*(){var e,t;yield this.layer.loadAll?this.layer.loadAll():this.layer.load();const i=null===(t=null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse();if(i&&i.length>0)for(let e=0;e<i.length;e++)yield this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).createJimuLayerView(i[e],this.jimuLayerId,e,null,this.fromRuntime);return this}))}}class he extends de{constructor(e){super(e),this.url=null,this.originalGdbVersion=null,this.originalGdbVersion=this.layer.gdbVersion}onLayerDataSourceInfoChange(e,t){const i=this.layer,r=this.getLayerDataSource();if(r){const e=r.getTimeExtent();i.useViewTime=null==e,i.timeExtent=y.dataSourceUtils.changeJimuTimeToJSAPITimeExtent(e)}(null==t?void 0:t.gdbVersion)&&(i.gdbVersion=t.gdbVersion),!(null==t?void 0:t.gdbVersion)&&this.originalGdbVersion&&(i.gdbVersion=this.originalGdbVersion)}validateDataSource(e){return(null==e?void 0:e.type)===y.DataSourceTypes.MapService}getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}class ye extends de{}class pe extends oe{constructor(e){super(e)}onLayerDataSourceInfoChange(e,t){super.onLayerDataSourceInfoChange(e,t);const i=this.getLayerDataSource();if(i&&i.getCurrentQueryParams){let e=null;const t=i.getCurrentQueryParams();(null==t?void 0:t.time)&&(e=y.dataSourceUtils.changeJimuTimeToJSAPITimeExtent(t.time)),this.layer.timeExtent=e}}getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}var ge=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};const me=y.ExBAddedJSAPIProperties.EXB_OID;class fe extends oe{constructor(e){super(e),this.highlightFeatureLayer=null,this.highlightFeatureLayerView=null,this.isHighlightFeatureLayerDirty=!1,this.localDefinitionExpression="",this.originalGdbVersion=null,this.selectByQueryAbortController=null,this.selectByQueryProgress=1,this.onMapViewRestore=()=>{var e;if(this.isHighlightFeatureLayerDirty){this.isHighlightFeatureLayerDirty=!1;let t=null;const i=(0,y.getAppStore)().getState().dataSourcesInfo;if(i){const e=i[this.layerDataSourceId];t=null==e?void 0:e.selectedIds}const r=this.highlightFeatureLayer;if(this.highLightLayerCreationPromise=null,this.highlightFeatureLayer=null,this.highlightFeatureLayerView=null,r){const t=this.getJimuMapView(),i=null===(e=null==t?void 0:t.view)||void 0===e?void 0:e.map;i&&i.remove(r)}this.updateHighlightBySelectedIds(t)}},this.latestHighlightIds||(this.latestHighlightIds=[]),this.originalGdbVersion=this.layer.gdbVersion}ready(){return ge(this,void 0,void 0,(function*(){return[this.reactiveUtils,this.Graphic]=yield(0,y.loadArcGISJSAPIModules)(["esri/core/reactiveUtils","esri/Graphic"]),this.watchHighlightOptions(),this.watchLayerVisible(),this.watchPopupSelectFeature(),this.watchPopupVisible(),this.watchMapViewRestore(),Promise.resolve(this)}))}destroy(){this.popupSelectFeatureWatchHandle&&(this.popupSelectFeatureWatchHandle.remove(),this.popupSelectFeatureWatchHandle=null),this.releasePopupVisibleWatchHandle(),this.layerVisibleWatchHandle&&(this.layerVisibleWatchHandle.remove(),this.layerVisibleWatchHandle=null),this.highlightOptionsWatchHandle&&(this.highlightOptionsWatchHandle.remove(),this.highlightOptionsWatchHandle=null);const e=this.getJimuMapView();e&&e.removeRestoreListener(this.onMapViewRestore),super.destroy()}isFeatureLayer(){var e;return"esri.layers.FeatureLayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)}isSceneLayer(){var e;return"esri.layers.SceneLayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)}isBuildingComponentSublayer(){var e;return"esri.layers.buildingSublayers.BuildingComponentSublayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)}isImageryLayer(){var e;return"esri.layers.ImageryLayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)}isOrientedImageryLayer(){var e;return"esri.layers.OrientedImageryLayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)}isSubtypeGroupLayer(){var e;return"esri.layers.SubtypeGroupLayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)}getSelectedFeatureCount(){var e;let t=0;const i=this.getLayerDataSource();return i&&(t=i.getSelectedRecordIds().length),0===t&&(null===(e=this.latestHighlightIds)||void 0===e?void 0:e.length)>0&&(t=this.latestHighlightIds.length),t}getSelectedFeatures(){return ge(this,void 0,void 0,(function*(){var e;let t=[];const i=this.getLayerDataSource();let r=[];if(i&&(r=i.getSelectedRecords()),r.length>0){const e=r.map((e=>null==e?void 0:e.feature)),i=!1;t=yield this.getApiGraphicsByRecordFeatures(e,i)}else(null===(e=this.latestHighlightIds)||void 0===e?void 0:e.length)>0&&(t=yield this.querySelectedFeaturesFromClient());return t.forEach((e=>{e.jimuLayerViewId=this.id})),t}))}getApiGraphicsByRecordFeatures(e,t){return ge(this,void 0,void 0,(function*(){const[i]=yield(0,y.loadArcGISJSAPIModules)(["esri/Graphic"]),r=[];return e.forEach((e=>{let a=null;e&&(a="esri.Graphic"===e.declaredClass?t?e.clone():e:i.fromJSON(e)),a&&r.push(a)})),r}))}querySelectedFeaturesFromClient(){return ge(this,void 0,void 0,(function*(){var e;let t=[];if((null===(e=this.latestHighlightIds)||void 0===e?void 0:e.length)>0){const e={objectIds:this.latestHighlightIds,returnGeometry:!0};t=this.highlightFeatureLayer?yield this.queryFeaturesFromClientHighlightLayer(this.latestHighlightIds):yield this.queryFeaturesFromClient(e)}return t}))}queryFeaturesFromClient(e){return ge(this,void 0,void 0,(function*(){return new Promise((t=>ge(this,void 0,void 0,(function*(){const i=this.view;if(!i||!i.queryFeatures)return void t([]);yield this.whenCurrentLayerViewNotUpdating();let r=null,a=null;try{const t=yield i.queryFeatures(e);r=null==t?void 0:t.features}catch(e){console.error("Query feature from view error.",this.id,e),a=e,r=[]}const s="esri.views.3d.layers.SceneLayerView3D"===this.view.declaredClass||"esri.views.3d.layers.BuildingComponentSublayerView3D"===this.view.declaredClass;if(a&&s&&e.returnGeometry){const t=Object.assign({},e,{returnGeometry:!1});try{const e=yield i.queryFeatures(t);r=null==e?void 0:e.features}catch(e){console.error("Query feature from view error.",this.id,e),r=[]}}r||(r=[]),t(r)}))))}))}queryFeaturesFromClientHighlightLayer(e){return ge(this,void 0,void 0,(function*(){return new Promise((t=>ge(this,void 0,void 0,(function*(){const i=this.highlightFeatureLayerView;if(e||(e=[]),!i||0===e.length)return void t([]);yield this.whenHighlightLayerViewNotUpdating();this.highlightFeatureLayer.queryFeatures({where:"1=1",returnGeometry:!0}).then((i=>{var r;const a={},s=[];(null===(r=i.features)||void 0===r?void 0:r.length)>0&&(i.features.forEach((e=>{const t=e.getAttribute(me);a[t]=e})),e.forEach((e=>{const t=a[e];t&&s.push(t)}))),t(s)}),(e=>{console.error("Query feature from highlightFeatureLayer error.",e),t([])}))}))))}))}selectFeatureById(e,t){return ge(this,void 0,void 0,(function*(){const i=yield this.getOrCreateLayerDataSource();if(i){if(!e&&0===i.getSelectedRecordIds().length)return;if(e){let r=null;r=t&&"esri.Graphic"===t.declaredClass?i.buildRecord(t):t,i.selectRecordById(e+"",r)}else i.selectRecordById(null)}else null!=e?this.highLightFeatures([e]):this.clearHighLight()}))}selectFeaturesByIds(e,t){return ge(this,void 0,void 0,(function*(){let i=null;if(i=e.length>0?yield this.getOrCreateLayerDataSource():this.getLayerDataSource(),i){if(0===e.length&&0===i.getSelectedRecordIds().length)return;i.selectRecordsByIds(e.map((e=>e+"")),t)}else if(e.length>0){const t=e.map((e=>Number(e)));this.highLightFeatures(t)}else this.clearHighLight()}))}beforeSelectFeaturesByQuery(e){return e}selectFeaturesByQuery(e,t){t!==y.DataSourceSelectionMode.AddToCurrent&&t!==y.DataSourceSelectionMode.RemoveFromCurrent&&t!==y.DataSourceSelectionMode.SelectFromCurrent&&(t=y.DataSourceSelectionMode.New),e.geometry=e.geometry.toJSON?e.geometry.toJSON():e.geometry,e=y.lodash.cloneDeep(e);const i=this.beforeSelectFeaturesByQuery(e);i&&(e=i);const r=new AbortController;this.cancelSelectByQuery(!1),this.selectByQueryAbortController=r;const a=this.selectQueryPromise||Promise.resolve([]);return this.selectByQueryProgress=0,this.selectQueryPromise=new Promise((i=>{a.finally((()=>ge(this,void 0,void 0,(function*(){let a=null,s=[];const n=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).mapWidgetId;try{if(a=yield this.getOrCreateLayerDataSource(),a){const i=r.signal,o=yield y.dataSourceUtils.selectBySelectionMode({widgetId:n,ds:a,query:e,selectionMode:t,signal:i,checkLayerVisibility:!0,jimuLayerView:this,progressCallback:e=>{this.setSelectQueryProgress(r,e)},updateSelectionIfAborted:()=>{let e=!1;return r&&(e=this.isFreshAbortController(r)&&!r.notUpdateSelection),e}});(null==o?void 0:o.records)&&(s=o.records)}}catch(e){s=[]}const o=s.map((e=>e.feature));g(this,s),this.setSelectQueryProgress(r,1),this.isFreshAbortController(r)&&(this.selectQueryPromise=null,this.selectByQueryAbortController=null),i(o)}))))})),this.selectQueryPromise}cancelSelectByQuery(e){return ge(this,void 0,void 0,(function*(){this.selectByQueryAbortController&&(this.selectByQueryAbortController.notUpdateSelection=!e,this.selectByQueryAbortController.abort()),this.selectQueryPromise&&(yield this.selectQueryPromise)}))}isFreshAbortController(e){return e&&e===this.selectByQueryAbortController}getOrCreateLocalDataSource(e){return ge(this,void 0,void 0,(function*(){const t=yield this.getOrCreateLayerDataSource();return t?t.dataSourceManager.createLocalDataSource(t,e):null}))}getSelectQueryProgress(){if(this.selectQueryPromise){const e=this.selectByQueryProgress,t=.01;return"number"==typeof e?Math.max(e,t):t}return 1}setSelectQueryProgress(e,t){if(this.isFreshAbortController(e)){const e=0,i=1;this.selectByQueryProgress=Math.max(e,Math.min(t,i));const r=this.getJimuMapView();r&&r.onSelectByQueryProgressChange()}}whenClientQueryReady(e,t){return ge(this,void 0,void 0,(function*(){var i;if(!e)throw new Error(`query param is null, ${this.id} not ready for client query`);if(e.disableClientQuery)return console.debug(`disableClientQuery is true, ${this.id} not ready for client query`),null;const r=yield this.getApiQueryForClientQuery(e,t);if(!r)throw new Error(`can't convert queryParams to API query instance, ${this.id} not ready for client query`);if("esri.layers.FeatureLayer"!==(null===(i=this.layer)||void 0===i?void 0:i.declaredClass))return console.debug(`layer is not a real FeatureLayer, ${this.id} not ready for client query`),null;const a=this.getJimuMapView();if(a.isDestroyed())return console.debug(`JimuMapView is destroyed, ${this.id} not ready for client query`),null;if(a.isCached())return console.debug(`JimuMapView is cached, ${this.id} not ready for client query`),null;if(yield a.whenJimuMapViewLoaded(),this.view||(yield a.whenJimuLayerViewLoaded(this.id)),!this.view)return console.debug(`layerView is not available, ${this.id} not ready for client query`),null;const s=this.view,n=yield this.getOrCreateLayerDataSource();if(!n)throw new Error(`layer data source is not available, ${this.id} not ready for client query`);const o=n.getCurrentQueryParams&&n.getCurrentQueryParams(),l=(null==o?void 0:o.where)||"",u=e.where||"",c=this.layer.definitionExpression||"";if(u&&l&&u.includes(l)){if(c!==l)return console.debug(`layer.definitionExpression is not same with data source runtime where, ${this.id} not ready for client query`),null}else{if(!this.isSqlEmpty(c))return console.debug(`query data from global data scope but layer.definitionExpression is not empty, ${this.id} not ready for client query`),null}let d=yield this.checkGeometryForClientQuery(r);if(!d)return null;if(!this.updateLayerOutFieldsForClientQuery(e,r,t,n))return null;if(yield this.whenCurrentLayerViewNotUpdating(),d=yield this.checkGeometryForClientQuery(r),!d)return null;if(this.view.updating)throw new Error(`layerView.updating is still true after pass all checks, ${this.id} not ready for client query`);if("feature"===t){if(e.returnGeometry&&e.returnFullGeometry&&!s.hasFullGeometries)return console.debug(`layerView.hasFullGeometries is false, ${this.id} not ready for client query`),null}return r}))}checkGeometryForClientQuery(e){return ge(this,void 0,void 0,(function*(){try{const t=this.view;if(t.hasAllFeatures)return!0;const i=this.getJimuMapView().view,r=e.geometry;let a=null;return r&&(r.extent?a=r.extent:"point"===r.type&&(a=r)),a?i.extent.contains(a)?(yield this.whenCurrentLayerViewNotUpdating(),i.extent.contains(a)?(t.hasAllFeaturesInView||console.debug(`layerView.hasAllFeaturesInView is false, ${this.id} not ready for client query`),t.hasAllFeaturesInView):(console.debug(`current map extent does not contain geometry, ${this.id} not ready for client query`),!1)):(console.debug(`current map extent does not contain geometry, ${this.id} not ready for client query`),!1):(yield this.whenCurrentLayerViewNotUpdating(),t.hasAllFeatures||console.debug(`layerView.hasAllFeatures is false, ${this.id} not ready for client query`),t.hasAllFeatures)}catch(e){console.error("check geometry error for client query",e)}return!1}))}updateLayerOutFieldsForClientQuery(e,t,i,r){if(!(this.layer.outFields&&this.layer.outFields.includes("*"))){const a=y.dataSourceUtils.getUsedFieldsFromFeatureLayerQueryParams(e.asMutable({deep:!0}),r,i)||[],s=t.outFields||[],n=Array.from(new Set([...a,...s]));let{added:o}=y.utils.diffArrays(!0,this.view.availableFields,n);if(o.includes("*")&&(o=["*"]),o.length>0){if(e.notAddFieldsToClient)return console.debug(`don't add new fields to layer.outFields for client query because notAddFieldsToClient is true: ${o}, view id: ${this.id}, query type:${i}`),!1;if(!this.isLayerVisibleForRendering())return console.debug(`layer is not visible for rendering, so can't add new fields to layer.outFields for client query: ${o}, view id: ${this.id}, query type:${i}`),!1;if(console.debug(`add new fields to layer.outFields for client query: ${o}, view id: ${this.id}, query type:${i}`),o.includes("*"))this.layer.outFields=["*"];else{const e=(this.layer.outFields||[]).concat(o);this.layer.outFields=e}}}return!0}whenCurrentLayerViewNotUpdating(){return this.view?this.whenLayerViewNotUpdating(this.view):Promise.resolve()}whenHighlightLayerViewNotUpdating(){return this.highlightFeatureLayerView?this.whenLayerViewNotUpdating(this.highlightFeatureLayerView):Promise.resolve()}whenLayerViewNotUpdating(e){return new Promise((t=>{setTimeout((()=>{if(e.updating){let i=e.watch("updating",(e=>{e||i&&(i.remove(),i=null,t())}))}else t()}),0)}))}clientQueryFeatures(e){return ge(this,void 0,void 0,(function*(){let t=null;try{const i=yield this.whenClientQueryReady(e,"feature");if(i){const e=yield this.view.queryFeatures(i);console.debug(`Query from client-side. view id: ${this.id}`),t={success:!0,data:e,hasFullGeometry:!!this.view.hasFullGeometries}}}catch(e){t=null,console.error(`clientQueryFeatures err for ${this.id}`,e)}return t||(t={success:!1,data:null,hasFullGeometry:!1}),t}))}clientQueryObjectIds(e){return ge(this,void 0,void 0,(function*(){let t=null;try{const i=yield this.whenClientQueryReady(e,"id");if(i){let e=yield this.view.queryObjectIds(i);e||(e=[]),console.debug(`Query objectIds from client-side. view id: ${this.id}`),t={success:!0,data:e}}}catch(e){t=null,console.error(`clientQueryObjectIds err for ${this.id}`,e)}return t||(t={success:!1,data:null}),t}))}clientQueryFeatureCount(e){return ge(this,void 0,void 0,(function*(){let t=null;try{const i=yield this.whenClientQueryReady(e,"count");if(i){const e=yield this.view.queryFeatureCount(i);console.debug(`Query feature count from client-side. view id: ${this.id}`),t={success:!0,data:e}}}catch(e){t=null,console.error(`clientQueryFeatureCount err for ${this.id}`,e)}return t||(t={success:!1,data:null}),t}))}clientQueryExtent(e){return ge(this,void 0,void 0,(function*(){let t=null;try{const i=yield this.whenClientQueryReady(e,"extent");if(i){const e=yield this.view.queryExtent(i);console.debug(`Query extent from client-side. view id: ${this.id}`),t={success:!0,data:e}}}catch(e){t=null,console.error(`clientQueryExtent err for ${this.id}`,e)}return t||(t={success:!1,data:null}),t}))}getApiQueryForClientQuery(e,t){return ge(this,void 0,void 0,(function*(){let i=null;const r=yield this.getOrCreateLayerDataSource(),a=yield y.dataSourceUtils.changeJimuArcGISQueryToJSAPIQuery(r,e);if("esri.rest.support.Query"===a.declaredClass)i=a;else{i=new(yield(0,y.loadArcGISJSAPIModule)("esri/rest/support/Query"))(a)}if(!r.isSqlCaseSensitive){const t=this.isSqlEmpty(e.where),a=r.getMainDataSource().getDataView(y.CONSTANTS.SELECTION_DATA_VIEW_ID),s=y.dataSourceUtils.getArcGISSQL(e.sqlExpression,a),n=(null==s?void 0:s.sql)||"",o=this.isSqlEmpty(n);if(!t&&o)return null;i.where=n}return"id"!==t&&"count"!==t&&"extent"!==t||(i.outFields=[]),i}))}isSqlEmpty(e){return e&&(e=e.replace(/[()\s]/g,"")),!e||"1=1"===e}setDefinitionExpression(e){this.localDefinitionExpression=e,this.setDefinitionExpressionToLayer()}validateDataSource(e){const t=null==e?void 0:e.type,i=[y.DataSourceTypes.FeatureLayer,y.DataSourceTypes.SceneLayer,y.DataSourceTypes.BuildingComponentSubLayer,y.DataSourceTypes.ImageryLayer,y.DataSourceTypes.OrientedImageryLayer,y.DataSourceTypes.SubtypeGroupLayer,y.DataSourceTypes.SubtypeSublayer];return t&&i.includes(t)}getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}getOrCreateLayerDataSource(){return super.getOrCreateLayerDataSource()}getHighlightLayerLayer(){return this.highlightFeatureLayer}getExcludePairsForBuildingExplorer(){var e;const t=[],i=null===(e=(0,y.getAppStore)().getState().appConfig)||void 0===e?void 0:e.widgets;return i&&Object.values(i).forEach((e=>{if("widgets/arcgis/building-explorer/"===e.uri){const i={dataSourceId:this.layerDataSourceId,widgetId:e.id};t.push(i)}})),t}getCurrentQueryParamsWithoutBuildingExplorer(){const e=this.getLayerDataSource();if(e&&e.getCurrentQueryParams){const t=this.getExcludePairsForBuildingExplorer();return e.getCurrentQueryParams({exclude:t})}return null}shouldWatchMapViewRestore(){return!0}watchMapViewRestore(){if(!this.shouldWatchMapViewRestore())return;const e=this.getJimuMapView();e&&e.addRestoreListener(this.onMapViewRestore)}onLayerDataSourceInfoChange(e,t){var i;super.onLayerDataSourceInfoChange(e,t);const r=(null==e?void 0:e.selectedIds)||null,a=(null==t?void 0:t.selectedIds)||null;if(r!==a){if(this.highlightFeatureLayer){const e=this.getJimuMapView();(null==e?void 0:e.isCached())&&(this.isHighlightFeatureLayerDirty=!0)}this.updateHighlightBySelectedIds(a)}const s=this.getLayerDataSource();s?this.setDefinitionExpressionToLayer():(null===(i=null==t?void 0:t.widgetQueries)||void 0===i?void 0:i._filterInUrl)&&this.createLayerDataSource().then((()=>{this.setDefinitionExpressionToLayer()})),this.view&&((null==t?void 0:t.gdbVersion)&&(this.layer.gdbVersion=t.gdbVersion),!(null==t?void 0:t.gdbVersion)&&this.originalGdbVersion&&(this.layer.gdbVersion=this.originalGdbVersion)),s&&s.getAutoRefreshInterval&&this.setRefreshIntervalForLayer(s.getAutoRefreshInterval()),(null==e?void 0:e.sourceVersion)!==(null==t?void 0:t.sourceVersion)&&this.refreshLayer()}shouldWatchPopupSelectFeature(){return!0}watchPopupSelectFeature(){this.shouldWatchPopupSelectFeature()&&(this.popupSelectFeatureWatchHandle&&(this.popupSelectFeatureWatchHandle.remove(),this.popupSelectFeatureWatchHandle=null),this.popupSelectFeatureWatchHandle=this.reactiveUtils.watch((()=>{var e,t;return null===(t=null===(e=this.getMapSceneView())||void 0===e?void 0:e.popup)||void 0===t?void 0:t.selectedFeature}),(e=>ge(this,void 0,void 0,(function*(){var t,i;const r=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId);if(r&&r.isPopupFeaturesFromSelection())return;if(!e)return;if(this.shouldUsePopupSelectedFeatureToUpdateSelection()){if(!e)return;const a=e.getObjectId();if(null==a)return;const s=yield this.getOrCreateLayerDataSource();if((null===(i=null===(t=r.view)||void 0===t?void 0:t.popup)||void 0===i?void 0:i.selectedFeature)!==e)return;if(!s)return void this.selectFeatureById(a);if(s.getSelectedRecordIds().includes(a+""))return;s.queryById(a+"").then((t=>{var i,s;(null===(s=null===(i=r.view)||void 0===i?void 0:i.popup)||void 0===s?void 0:s.selectedFeature)===e&&(this.selectFeatureById(Number(a),t),g(this,[t]))}))}else{this.getSelectedFeatureCount()>0&&(this.selectFeatureById(null),g(this,[]))}})))))}releasePopupVisibleWatchHandle(){this.popupVisibleWatchHandle&&(this.popupVisibleWatchHandle.remove(),this.popupVisibleWatchHandle=null)}watchPopupVisible(){this.releasePopupVisibleWatchHandle(),this.popupVisibleWatchHandle=this.reactiveUtils.watch((()=>{var e,t;return null===(t=null===(e=this.getMapSceneView())||void 0===e?void 0:e.popup)||void 0===t?void 0:t.visible}),(e=>{var t;const i=null===(t=this.getMapSceneView())||void 0===t?void 0:t.popup;!e&&i&&this.isPopupSelectCurrentLayerFeature()&&(i.features=[],g(this,[]),this.selectFeatureById(null))}))}isPopupSelectCurrentLayerFeature(){var e;const t=null===(e=this.getMapSceneView())||void 0===e?void 0:e.popup;return t&&t.selectedFeature&&this.getLayerFromFeature(t.selectedFeature)===this.layer}shouldUsePopupSelectedFeatureToUpdateSelection(){return this.isPopupSelectCurrentLayerFeature()}onParentLayerVisibleChange(e){this.onLayerFinalVisibleChange()}watchLayerVisible(){this.layerVisibleWatchHandle&&(this.layerVisibleWatchHandle.remove(),this.layerVisibleWatchHandle=null),this.layerVisibleWatchHandle=this.layer.watch("visible",((e,t)=>{this.onLayerFinalVisibleChange()}))}onLayerFinalVisibleChange(){var e;const t=this.isLayerVisible();this.highlightFeatureLayer&&(this.highlightFeatureLayer.visible=t);const i=null===(e=this.getMapSceneView())||void 0===e?void 0:e.popup;i&&this.isPopupSelectCurrentLayerFeature()&&i.visible!==t&&(this.releasePopupVisibleWatchHandle(),i.visible=t,this.watchPopupVisible())}watchHighlightOptions(){const e=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).view;this.highlightOptionsWatchHandle&&(this.highlightOptionsWatchHandle.remove(),this.highlightOptionsWatchHandle=null),this.highlightOptionsWatchHandle=e.watch("highlightOptions",(()=>{this.highlightFeatureLayer&&(this.highlightFeatureLayer.renderer=this.getRendererForHighlightLayer(this.highlightFeatureLayer.geometryType,e))}))}getLayerFromFeature(e){const t=e.layer,i=e.sourceLayer;let r=t||i;return"esri.layers.BuildingSceneLayer"===(null==t?void 0:t.declaredClass)&&"esri.layers.buildingSublayers.BuildingComponentSublayer"===(null==i?void 0:i.declaredClass)&&(r=i),r}setRefreshIntervalForLayer(e){if(!this.view||null==e)return;(0,y.getAppStore)().getState().appRuntimeInfo.appMode===y.AppMode.Design?this.layer.refreshInterval=0:this.layer.refreshInterval=e/60}getLocalDefinitionExpressionToMerge(){return this.localDefinitionExpression||""}setDefinitionExpressionToLayer(){return ge(this,void 0,void 0,(function*(){var e,t,i;const r=this.getCurrentQueryParamsWithoutBuildingExplorer();if(r&&this.layer){const a=this.isFeatureLayer(),s=this.isSceneLayer(),n=this.isBuildingComponentSublayer(),o=this.isImageryLayer(),l=this.isOrientedImageryLayer(),u=this.isSubtypeGroupLayer(),c=this.getLayerDataSource(),d={outFields:["*"],where:this.getLocalDefinitionExpressionToMerge(),returnGeometry:!0};let h=null;if(c&&c.getRealQueryParams){const e={excludeQuery:this.getExcludePairsForBuildingExplorer()};h=c.getRealQueryParams(d,"query",e)}const p=h||r,g="esri.layers.support.Sublayer"===this.layer.declaredClass&&(null===(i=null===(t=null===(e=this.layer.layer)||void 0===e?void 0:e.capabilities)||void 0===t?void 0:t.exportMap)||void 0===i?void 0:i.supportsSublayerDefinitionExpression)||a||s||n||o||l||u||this.view;if(p&&g&&p.where!==this.layer.definitionExpression&&(this.layer.definitionExpression=p.where),a||o||u){const e=this.layer;null!=(null==p?void 0:p.time)?e.useViewTime=!1:e.useViewTime=!0,e.timeExtent=y.dataSourceUtils.changeJimuTimeToJSAPITimeExtent(null==p?void 0:p.time)}if(yield this.whenViewLoaded(),this.view&&!o){const e=this.view;if(r.geometry){if(e.filter&&e.filter.geometry===r.geometry)return;(0,y.loadArcGISJSAPIModules)(["esri/geometry/support/jsonUtils"]).then((t=>{const i=t[0];e.filter={geometry:i.fromJSON(r.geometry)}}))}else e.filter&&(e.filter=null)}}}))}refreshLayer(){var e,t;(this.isFeatureLayer()||this.isSubtypeGroupLayer())&&(null===(t=(e=this.layer).refresh)||void 0===t||t.call(e))}updateHighlightBySelectedIds(e){(null==e?void 0:e.length)>0?this.highLightSelectedRecords():this.clearHighLight()}highLightSelectedRecords(){if(0===this.getSelectedRecordIds().length)return;const e=this.getSelectedRecordIds().map((e=>parseInt(e)));this.highLightFeatures(e)}tryCreateHighLightFeatureLayer(){return ge(this,void 0,void 0,(function*(){if(yield this.whenViewLoaded(),this.view||this.type!==h.FeatureLayer||!this.isLoaded)return;yield this.getJimuMapView().whenJimuLayerViewLoaded(this.id);if(!(this.getLayerDataSource()||(yield this.createLayerDataSource())))return;if(this.highLightLayerCreationPromise)return this.highLightLayerCreationPromise;const e=this.layer,t=this.getObjectIdField(e.fields,e.objectIdField),i={name:me,type:"integer",alias:me,description:""},r=t?[t,i]:[i];return this.highLightLayerCreationPromise=(0,y.loadArcGISJSAPIModules)(["esri/layers/FeatureLayer"]).then((t=>{var i,a;const s=t[0],n=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).view,o=(null===(a=null===(i=this.layer)||void 0===i?void 0:i.sourceJSON)||void 0===a?void 0:a.hasZ)||!1;return this.highlightFeatureLayer=new s({title:`${e.title}-highlight`,geometryType:e.geometryType,spatialReference:e.spatialReference,source:[],fields:r,objectIdField:e.objectIdField,renderer:this.getRendererForHighlightLayer(e.geometryType,n),listMode:"hide",legendEnabled:!1,popupEnabled:!1,visible:this.isLayerVisible(),hasZ:o}),n.map.add(this.highlightFeatureLayer),new Promise(((e,t)=>{this.highlightFeatureLayer.on("layerview-create",(t=>{this.highlightFeatureLayerView=t.layerView,e()}))}))})),this.highLightLayerCreationPromise}))}addFeaturesToHighlightFeatureLayer(e){return ge(this,void 0,void 0,(function*(){const t=this.getLayerDataSource(),i=t.getIdField(),r=t.getSelectedRecords(),a=e.map((e=>{var t;return null===(t=r.find((t=>t.getId()===e+"")))||void 0===t?void 0:t.feature})).filter((e=>!!e));if(0===a.length)return;const s=yield this.getApiGraphicsByRecordFeatures(a,!0);0!==s.length&&(s.forEach((e=>{const t=e.attributes&&e.attributes[i];e.attributes={},e.attributes[i]=t,e.attributes[me]=t})),yield this.highlightFeatureLayer.applyEdits({addFeatures:s}))}))}removeFeaturesFromHighlightFeatureLayer(){return ge(this,void 0,void 0,(function*(){const e=(yield this.highlightFeatureLayer.queryFeatures({where:"1=1"})).features||[];e.length>0&&(yield this.highlightFeatureLayer.applyEdits({deleteFeatures:e}))}))}highlightFeatureById(e){"number"==typeof e&&this.highLightFeatures([e])}highLightFeatures(e){return ge(this,void 0,void 0,(function*(){if(this.latestHighlightIds=e,this.releaseHighLightHandle(),yield this.tryCreateHighLightFeatureLayer(),this.view){const t=this.view;let i=[];const r=this.isImageryLayer();r&&(i=yield this.queryRasterFeatures(e)),t.when((()=>ge(this,void 0,void 0,(function*(){if(yield this.whenLayerViewNotUpdating(t),r)this.latestHighlightIds===e&&(this.releaseHighLightHandle(),this.highLightHandle=t.highlight(i),this.onSelectedFeaturesChange(!1));else{this.releaseHighLightHandle();const e=this.latestHighlightIds||[];this.highLightHandle=t.highlight(e),this.onSelectedFeaturesChange(!1)}}))))}else this.highlightFeatureLayerView?(yield this.removeFeaturesFromHighlightFeatureLayer(),yield this.addFeaturesToHighlightFeatureLayer(e),this.onSelectedFeaturesChange(!1)):this.onSelectedFeaturesChange(!1)}))}queryRasterFeatures(e){return ge(this,void 0,void 0,(function*(){let t=[];if(this.isImageryLayer()&&e.length>0){const i=this.layer;try{const r=yield i.queryRasters({objectIds:e,returnGeometry:!0,outFields:[]});t=null==r?void 0:r.features}catch(e){console.error(`JimuImageryLayerView ${this.id} can not query rasters`,e)}}return t||(t=[]),t}))}clearHighLight(){var e,t;this.latestHighlightIds=[],this.releaseHighLightHandle(),this.highlightFeatureLayerView&&this.removeFeaturesFromHighlightFeatureLayer();const i=this.getMapSceneView();if(i){if(this.shouldClosePopupWhenClearHighlight()){(null===(t=null===(e=i.popup)||void 0===e?void 0:e.selectedFeature)||void 0===t?void 0:t.isAggregate)||i.closePopup()}}this.onSelectedFeaturesChange(!0)}shouldClosePopupWhenClearHighlight(){return this.isPopupSelectCurrentLayerFeature()}releaseHighLightHandle(){this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null)}onSelectedFeaturesChange(e){const t=this.getJimuMapView();t&&t.onJimuLayerViewSelectedFeaturesChange(this,e)}getSelectedRecordIds(){return this.getLayerDataSource()?this.getLayerDataSource().getSelectedRecordIds().filter((e=>!!e)):[]}getObjectIdField(e,t){let i=null;for(let r=0;r<e.length;r++)if(e[r].name===t)return i=e[r],i;return i}getRendererForHighlightLayer(e,t){var i,r,a,s;const n=(null===(r=null===(i=t.highlightOptions)||void 0===i?void 0:i.color)||void 0===r?void 0:r.clone())||"#00FFFF",o=(null===(s=null===(a=t.highlightOptions)||void 0===a?void 0:a.haloColor)||void 0===s?void 0:s.clone())||"#00FFFF";return["point","multipoint"].includes(e)?{type:"simple",symbol:{type:"simple-marker",style:"circle",color:n,size:"16px",outline:{color:o,width:1}}}:["polyline"].includes(e)?{type:"simple",symbol:{type:"simple-line",color:n,width:1,style:"solid"}}:["polygon","extent"].includes(e)?{type:"simple",symbol:{type:"simple-fill",color:[0,255,255,0],style:"solid",outline:{color:o,width:1}}}:["mesh"].includes(e)?{type:"simple",symbol:{type:"mesh-3d",symbolLayers:[{type:"fill",material:{color:n}}]}}:null}}class ve extends fe{getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}class we extends fe{getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}var Se=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class Le extends oe{constructor(e){super(e)}ready(){return Se(this,void 0,void 0,(function*(){var e,t;yield this.layer.loadAll();const i=null===(t=null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse();if(i&&i.length>0){const e=i.map(((e,t)=>{const i=e;return i.parent||(i.parent=this.layer),this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).createJimuLayerView(i,this.jimuLayerId,t,null,this.fromRuntime)}));yield Promise.all(e)}return this}))}}var Ie=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class be extends oe{constructor(e){super(e)}ready(){return Ie(this,void 0,void 0,(function*(){var e,t;yield this.layer.loadAll();const i=null===(t=null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse();if(i&&i.length>0){const e=i.map(((e,t)=>{const i=e;return i.parent||(i.parent=this.layer),this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).createJimuLayerView(i,this.jimuLayerId,t,null,this.fromRuntime)}));yield Promise.all(e)}return this}))}}class Ve extends fe{getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}class Me extends fe{getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}class Ce extends fe{getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}}var De=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class Pe extends fe{ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return De(this,void 0,void 0,(function*(){return yield e.ready.call(this),yield this.createSubLayerViews(),this}))}createSubLayerViews(){return De(this,void 0,void 0,(function*(){var e,t;const i=null===(t=null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse();if(i&&i.length>0){const e=[];for(let t=0;t<i.length;t++){const r=i[t],a=this.mapViewManager.getJimuMapViewById(this.jimuMapViewId).createJimuLayerView(r,this.jimuLayerId,t,null,this.fromRuntime);e.push(a)}yield Promise.all(e)}}))}getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}shouldClosePopupWhenClearHighlight(){const e=this.isPopupSelectCurrentLayerFeature(),t=this.isPopupSelectChildSubtypeSublayerFeature();return e||t}shouldUsePopupSelectedFeatureToUpdateSelection(){const e=this.isPopupSelectCurrentLayerFeature(),t=this.isPopupSelectChildSubtypeSublayerFeature();return e||t}isPopupSelectChildSubtypeSublayerFeature(){var e;const t=null===(e=this.getMapSceneView())||void 0===e?void 0:e.popup;if(t&&t.selectedFeature){const e=this.getLayerFromFeature(t.selectedFeature);if(e&&"esri.layers.support.SubtypeSublayer"===e.declaredClass&&e.parent===this.layer)return!0}return!1}getLocalDefinitionExpressionToMerge(){const e=this.getJimuMapView(),t=m(this.layer),i=this.localDefinitionExpression||"",r={};if(e){e.getChildJimuLayerViews(this.id).filter((e=>e.type===h.SubtypeSublayer&&e.getLocalDefinitionExpressionToMerge)).forEach((e=>{var t;const i=e.getLocalDefinitionExpressionToMerge(),a=null===(t=e.layer)||void 0===t?void 0:t.subtypeCode;i&&"number"==typeof a&&(r[a]=i)}))}let a="";return(i||Object.keys(r).length>0)&&(a=y.dataSourceUtils.mergeSubtypeSublayerWhereClausesToSubtypeGroupLayer(t,i,r)),a||(a=""),a}beforeSelectFeaturesByQuery(e){var t;let i=e;if(this.layer){const r=m(this.layer),a=null===(t=this.layer.sublayers)||void 0===t?void 0:t.toArray();if(r&&(null==a?void 0:a.length)>0){const t=[];if(a.forEach((e=>{e.visible||t.push(e.subtypeCode)})),t.length>0){const a=`${r} NOT IN (${t.join(",")})`,s=e.where;let n=e.where;n=s?`((${s}) AND (${a}))`:`(${a})`,i=Object.assign({},e),i.where=n}}}return i}}var Fe=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class Ae extends fe{constructor(e){super(e)}getLayerDataSource(){return super.getLayerDataSource()}createLayerDataSource(){return super.createLayerDataSource()}onLayerDataSourceInfoChange(e,t){oe.prototype.onLayerDataSourceInfoChange.apply(this,[e,t])}shouldWatchPopupSelectFeature(){return!1}shouldWatchMapViewRestore(){return!1}getLocalDefinitionExpressionToMerge(){return this.localDefinitionExpression||""}setDefinitionExpression(e){this.localDefinitionExpression=e;const t=this.getParentJimuLayerView();t&&t.type===h.SubtypeGroupLayer&&t.setDefinitionExpressionToLayer&&t.setDefinitionExpressionToLayer()}setDefinitionExpressionToLayer(){return Fe(this,void 0,void 0,(function*(){console.warn("JimuSubtypeSublayerView.setDefinitionExpressionToLayer() doesn't work because SubtypeSublayer doesn't support layer.definitionExpression")}))}}var Je=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};function je(e){return Je(this,void 0,void 0,(function*(){let t=null;const i=yield v(["esri/renderers/SimpleRenderer"]),[r]=i;return e&&(t=new r({symbol:e})),t}))}function xe(e,t){return Je(this,void 0,void 0,(function*(){let i=null;const r=Ee(e,t);if(r){if("esri.symbols.SimpleLineSymbol"===r.declaredClass){r.width=2}i=yield je(r)}return i}))}function Ee(e,t){let i=null;const r=X(t);return r&&(i=e.fromJSON(r)),i}function Oe(e,t,i,r,a,s,n){return Je(this,void 0,void 0,(function*(){const o=Ee(s,r),l=new n({field:i,defaultSymbol:o}),u=null==t?void 0:t.features,c={};if((null==u?void 0:u.length)>0){const t=u.map((t=>Je(this,void 0,void 0,(function*(){var r;if(t)try{const n=t.getObjectId()||(null===(r=t.attributes)||void 0===r?void 0:r[i]);if(null!=n){const i=yield function(e,t,i,r){return Je(this,void 0,void 0,(function*(){var a,s,n,o,l,u,c,d,h,y,p;let g=null,m=null;try{m=yield i.getDisplayedSymbol(t)}catch(e){m=null,g=null}if(m){g=m;if(e&&"esri.views.MapView"===e.declaredClass)if("esri.symbols.PointSymbol3D"===m.declaredClass){const e={type:"esriSMS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}},t=m.symbolLayers.toArray();if(t.length>0){const i=null===(s=null===(a=t[0].material)||void 0===a?void 0:a.color)||void 0===s?void 0:s.toJSON();i&&(e.color=i,e.outline.color=i)}g=r.fromJSON(e)}else if("esri.symbols.LineSymbol3D"===m.declaredClass){const e={type:"esriSLS",color:[255,255,0,150],width:1},t=m.symbolLayers.toArray();if(t.length>0){const i=t.find((e=>"esri.symbols.LineSymbol3DLayer"===e.declaredClass));if(i){const t=null===(o=null===(n=i.material)||void 0===n?void 0:n.color)||void 0===o?void 0:o.toJSON();t&&(e.color=t),i.size>0&&(e.width=i.size)}else{const i=null===(u=null===(l=t[0].material)||void 0===l?void 0:l.color)||void 0===u?void 0:u.toJSON();i&&(e.color=i)}}g=r.fromJSON(e)}else if("esri.symbols.PolygonSymbol3D"===m.declaredClass){const e={type:"esriSFS",color:[255,255,0,150],outline:{color:[255,255,0,150],width:1}},t=m.symbolLayers.toArray();if(t.length>0){const i=t.find((e=>"esri.symbols.FillSymbol3DLayer"===e.declaredClass)),r=t.find((e=>"esri.symbols.ExtrudeSymbol3DLayer"===e.declaredClass));if(i){const t=null===(d=null===(c=i.material)||void 0===c?void 0:c.color)||void 0===d?void 0:d.toJSON();if(t&&(e.color=t,e.outline.color=t),i.outline){const t=null===(h=i.outline.color)||void 0===h?void 0:h.toJSON();t&&(e.outline.color=t),i.outline.size>0&&(e.outline.width=i.outline.size)}}else if(r){const t=null===(p=null===(y=r.material)||void 0===y?void 0:y.color)||void 0===p?void 0:p.toJSON();t&&(e.color=t,e.outline.color=t)}}g=r.fromJSON(e)}}return g}))}(e,t,a,s);i&&(c[n]=i)}}catch(e){console.error("getGraphicDisplaySymbolByRenderer error",e)}}))));yield Promise.all(t)}return Object.keys(c).forEach((e=>{const t=Number(e),i=c[t];i&&l.addUniqueValueInfo(t,i)})),l}))}var Te,Be,Ue,Re=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};!function(e){e.DataAction="DATA_ACTION",e.MessageAction="MESSAGE_ACTION"}(Te||(Te={})),function(e){e.Create="CREATE",e.Creating="CREATING",e.Created="CREATED",e.Remove="REMOVE"}(Be||(Be={})),function(e){e.Fulfilled="FULFILLED",e.Pending="PENDING",e.Rejected="REJECTED",e.RejectedAndKnown="REJECTEDANDKNOWN"}(Ue||(Ue={}));const Ge="layer_of_showOnMap_action_",We="layer_of_addToMap_action_",ke=[h.FeatureLayer,h.SceneLayer,h.BuildingComponentSublayer,h.OrientedImageryLayer,h.ImageryLayer,h.SubtypeGroupLayer];class He{constructor(e){this.clickHighlightEnabled=!0,this.cacheListeners=[],this.restoreListeners=[],this.selectedFeaturesChangeListeners=[],this.jimuLayerViewCreatedListeners=[],this.jimuLayerViewRemovedListeners=[],this.jimuLayerViewsVisibleChangedListeners=[],this.selectByQueryProgressChangeListeners=[],this.popupFeaturesFromSelection=!1,this.showPopupUponSelection=!1,this.forcePopupEnabledLayers=[],this.mapClickCount=0,this.getJimuLayerViewIdByJimuLayerId=e=>`${this.id}-${e}`,this.getJimuLayerViewIdByAPILayer=e=>this.getJimuLayerViewIdByJimuLayerId(y.dataSourceUtils.getJimuLayerIdByJSAPILayer(e)),this.id=e.mapWidgetId+"-"+e.dataSourceId,this.mapWidgetId=e.mapWidgetId,this.isActive=e.isActive,this.dataSourceId=e.dataSourceId,this.view=e.view,this.mapViewManager=e.mapViewManager,this.jimuLayerViews={},this.jimuTables={},this.finalLayerVisibles={},this.status=y.JimuMapViewStatus.Loading,this.view&&(this.view.popupEnabled=void 0===e.isEnablePopup||null===e.isEnablePopup||e.isEnablePopup),this.showOnMapDatas={},this.jimuMapTools=[],this.jimuLayerViewLoadPromises={},this.storeUnsubscribes=[],e.useUrlHashLayersVisibility&&(this.urlHashLayersVisibility=this.parseLayersVisibilityFromUrlHash()),this.initView(this.view);const t=(0,y.observeStore)(this.onStoreChange.bind(this),["dataSourcesInfo"]);this.storeUnsubscribes.push(t),this.watchLayersChange(),this.watchPopupFeaturesAndSelectedFeature()}watchLayersChange(){var e,t;const i=null===(t=null===(e=this.view)||void 0===e?void 0:e.map)||void 0===t?void 0:t.layers;i&&(this.watchRemoveLayerHandle&&(this.watchRemoveLayerHandle.remove(),this.watchRemoveLayerHandle=null),this.watchRemoveLayerHandle=i.on("after-remove",(e=>{const t=e.item;setTimeout((()=>{if(!this.isDestroyed()&&t){if(i.find((e=>e===t)))return;const e=this.getJimuLayerViewByAPILayer(t);e&&this.removeJimuLayerView(e)}}),50)})))}watchPopupFeaturesAndSelectedFeature(){return Re(this,void 0,void 0,(function*(){const e=yield(0,y.loadArcGISJSAPIModule)("esri/core/reactiveUtils");this.watchPopupFeaturesHandle&&(this.watchPopupFeaturesHandle.remove(),this.watchPopupFeaturesHandle=null),this.watchPopupSelectedHandle&&(this.watchPopupSelectedHandle.remove(),this.watchPopupSelectedHandle=null),this.watchPopupFeaturesHandle=e.watch((()=>{var e;return null===(e=this.view.popup)||void 0===e?void 0:e.features}),(e=>{this.popupFeaturesFromSelection=null==e?void 0:e.fromSelection})),this.watchPopupSelectedHandle=e.watch((()=>{var e;return null===(e=this.view.popup)||void 0===e?void 0:e.selectedFeature}),(()=>{var e,t;if(!this.popupFeaturesFromSelection)return;const i=null===(e=this.view)||void 0===e?void 0:e.popup;if(i&&i.selectedFeature){const e=i.selectedFeature.geometry;let r=null;e&&(r="esri.geometry.Point"===e.declaredClass?e.clone():null===(t=e.extent)||void 0===t?void 0:t.center),r&&(i.location=r)}}))}))}handlePopupOnSelectionChange(e,t){return Re(this,void 0,void 0,(function*(){var i;const r=null===(i=this.view)||void 0===i?void 0:i.popup;if(!r)return;const a=this.isMapWidgetActive();if(this.isAutoShowPopupWhenSelectFeatures()&&!a)yield this.updatePopupFeaturesWhenSelectionChange(r,e,t);else if(r.visible&&!a){const t=r.selectedFeature;if(t){const i=t.getObjectId();if(i>=0){const r=String(i);if(e.layer&&t.layer===e.layer||e.layer&&t.sourceLayer===e.layer||e.id&&t.jimuLayerViewId===e.id){const t=e.getLayerDataSource();if(t){t.getSelectedRecordIds().some((e=>e===r))||this.closePopup()}}}}}}))}isFeaturePopupEnabledByCurrentMapPopupSetting(e){const t=e.layer||e.sourceLayer;if(t){const e=this.getJimuLayerViewByThisOrOtherMapAPILayer(t);if(e&&e.layer){return!1!==e.layer.popupEnabled}}return!0}updatePopupFeaturesWhenSelectionChange(e,t,i){return Re(this,void 0,void 0,(function*(){if(!e)return;if(!e.visible&&i)return void(this.popupFeaturesFromSelection&&this.closePopup());let r=yield this.getSelectedFeatures();r=r.filter((e=>this.isFeaturePopupEnabledByCurrentMapPopupSetting(e)));const a=e.selectedFeature,s=a&&a.jimuLayerViewId;let n=null;if(i?s&&(n=s):n=t.id,n){const e=[],t=[];r.forEach((i=>{i.jimuLayerViewId===n?e.push(i):t.push(i)})),r=[...e,...t]}if(a&&r.length>0&&(s&&s===n||!n)){let e=r.indexOf(a);if(e<0){const t=a.getObjectId();if(t>=0){const i=r.length;for(let a=0;a<i;a++){if(r[a].getObjectId()===t){e=a;break}}}}e>=0&&(r.splice(e,1),r.unshift(a))}r.length>0?(r.fromSelection=!0,this.view.openPopup({features:r})):this.closePopup()}))}closePopup(){if(this.view){const e=this.view.popup;e&&(e.features=[]),this.view.closePopup()}}isAutoShowPopupWhenSelectFeatures(){return this.view.popupEnabled&&this.showPopupUponSelection}setShowPopupUponSelection(e){this.showPopupUponSelection=!!e}isPopupFeaturesFromSelection(){return this.popupFeaturesFromSelection}getSelectedFeatures(){return Re(this,void 0,void 0,(function*(){const e=[],t=Object.values(this.jimuLayerViews),i=[];if(t.forEach((e=>{const t=e;if(t.getSelectedFeatures&&t.type!==h.SubtypeSublayer){const e=t.getSelectedFeatures();i.push(e)}})),i.length>0){const t=yield Promise.all(i);t.length>0&&t.forEach((t=>{t&&t.length>0&&t.forEach((t=>{e.push(t)}))}))}return e}))}getSelectedFeatureCount(){let e=0;return Object.values(this.jimuLayerViews).forEach((t=>{const i=t;i.getSelectedFeatureCount&&i.type!==h.SubtypeSublayer&&(e+=i.getSelectedFeatureCount())})),e}addJimuMapTool(e){this.jimuMapTools.find((t=>t.name===e.name))||this.jimuMapTools.push(e)}deleteJimuMapTool(e){this.jimuMapTools.find((t=>t.name===e))&&(this.jimuMapTools=this.jimuMapTools.filter((t=>t.name!==e)))}enableClickOpenPopup(){this.view.popupEnabled=!0}disableClickOpenPopup(){this.view.popupEnabled=!1}isClickOpenPopupEnabled(){return this.view.popupEnabled}enableClickHighlight(){this.clickHighlightEnabled=!0}disableClickHighlight(){this.clickHighlightEnabled=!1}isClickHighlightEnabled(){return this.clickHighlightEnabled}setIsActive(e){this.isActive=e,this.mapViewManager.setJimuMapView(this)}setMapWidgetState(e){this.mapWidgetState=e}isMapWidgetActive(){return this.mapWidgetState===y.WidgetState.Active}initView(e){e&&e.when((()=>{e.on("click",this.onClick.bind(this))}))}onClick(e){const t={x:e.x,y:e.y},i=this.view.toMap(t);i&&(y.MessageManager.getInstance().publishMessage(new y.LocationChangeMessage(this.mapWidgetId,i.toJSON())),this.view.hitTest(t).then((e=>{if(!this.isClickHighlightEnabled())return;const t=e.results.filter((e=>"graphic"===e.type));this.selectDataSourceOrFeatureByFeatures(this.isClickOpenPopupEnabled(),t.map((e=>e.graphic)),i)}),(()=>{this.isClickOpenPopupEnabled()||this.clearAllJimuLayerViewsSelectRecord()})))}getLayerDataSourceIdsWithSelection(){var e,t;const i=[],r=this.getAllJimuLayerViews(),a=null===(t=null===(e=this.view)||void 0===e?void 0:e.popup)||void 0===t?void 0:t.visible;return r.forEach((e=>{if(e&&e.layerDataSourceId&&e instanceof fe&&e.getSelectedFeatureCount){if(e.getSelectedFeatureCount()>0){a&&e.isPopupSelectCurrentLayerFeature()||i.push(e.layerDataSourceId)}}})),i}publishEmptySelectionChangeMessage(e){if(e.length>0){const t=y.MessageManager.getInstance(),i=new y.DataRecordsSelectionChangeMessage(this.mapWidgetId,[],e);t.publishMessage(i)}}selectDataSourceOrFeatureByFeatures(e,t,i){return Re(this,void 0,void 0,(function*(){var r;const a=this.getLayerDataSourceIdsWithSelection();if(yield this.clearAllJimuLayerViewsSelectRecord(),this.publishEmptySelectionChangeMessage(a),e)return;const s=t.find((e=>{var t;const i=e.layer;return!(!i||i.type!==h.FeatureLayer&&i.type!==h.SceneLayer&&i.type!==h.OrientedImageryLayer)&&(i.popupEnabled||(null===(t=this.forcePopupEnabledLayers)||void 0===t?void 0:t.includes(i)))}));if(!s)return void this.tryIdentifyClickedFeature(i);const n=this.getJimuLayerViewIdByAPILayer(s.layer),o=this.jimuLayerViews[n];if(!o)return;const l=s.getObjectId();if("number"==typeof l){o.highlightFeatureById(l),this.mapClickCount++;const e=this.mapClickCount,t=yield o.getOrCreateLayerDataSource();let i;t&&(i=yield t.queryById(l+""));e===this.mapClickCount&&(i&&g(o,[i]),yield o.selectFeatureById(l,i))}s.layer&&(null===(r=this.forcePopupEnabledLayers)||void 0===r?void 0:r.includes(s.layer))&&this.view.openPopup({features:[s],location:i})}))}isMapServiceLayerPopupEnabled(e){var t;if(e.popupEnabled){const i=null===(t=e.sublayers)||void 0===t?void 0:t.toArray();if(i&&i.length>0){return i.some((e=>e.popupEnabled))}}return!1}tryIdentifyClickedFeature(e){var t,i;let r=null;const a=this.view.map.layers.toArray().reverse(),s=Object.values(this.jimuLayerViews);for(let e=0;e<a.length;e++){const n=a[e];if(n.type===h.MapImageLayer||n.type===h.TileLayer){const e=n;if((null===(i=null===(t=e.capabilities)||void 0===t?void 0:t.operations)||void 0===i?void 0:i.supportsIdentify)&&this.isMapServiceLayerPopupEnabled(e)){const e=s.find((e=>e.layer===n));if(e){r=e;break}}}}if(r)return v(["esri/rest/identify","esri/rest/support/IdentifyParameters"]).then((([t,i])=>{const a=this.getAllChildJimuLayerViews(r.id).filter((e=>e.layer.popupEnabled)).map((e=>e.layer.id)),s=new i;s.tolerance=3,s.layerIds=a,s.layerOption="top",s.width=this.view.width,s.height=this.view.height,s.geometry=e,s.mapExtent=this.view.extent,s.returnFieldName=!0,s.returnGeometry=!0,s.returnUnformattedValues=!0,t.identify(r.layer.url,s).then((e=>Re(this,void 0,void 0,(function*(){const t=e.results[0];if(!t)return;const i=`${r.id}-${t.layerId}`,a=this.jimuLayerViews[i];if(!a)return;const s=yield a.getOrCreateLayerDataSource();if(s){const e=s.buildRecord(t.feature);a.selectFeatureById(Number(e.getId()),e),g(a,[e])}else a.selectFeatureById(t.feature.attributes[a.layer.objectIdField],t.feature)}))))}))}getMapDataSource(){let e=null;return this.dataSourceId&&(e=y.DataSourceManager.getInstance().getDataSource(this.dataSourceId)),e}getJimuLayerViewByThisOrOtherMapAPILayer(e){let t=this.getJimuLayerViewByAPILayer(e);if(t)return t;const i=this.getAllJimuLayerViews(),r=this.getMapDataSource();if(r){const a=y.dataSourceUtils.getDataSourceIdByJSAPILayer(r,e);a&&(t=i.find((e=>e.layerDataSourceId===a)))}return t}getJimuLayerViewByAPILayer(e){return Object.values(this.jimuLayerViews).find((t=>t.layer===e))}getJimuLayerViewByDataSourceId(e){const t=this.getAllJimuLayerViews();let i=t.filter((e=>!e.fromRuntime)).find((t=>t.layerDataSourceId===e));if(i)return i;if(!i){i=t.filter((e=>e.fromRuntime)).find((t=>t.layerDataSourceId===e))}return i}getDataSourceIdByAPILayer(e){const t=this.getJimuLayerViewByAPILayer(e);if(t)return t.layerDataSourceId;const i=this.getMapDataSource();return i?y.dataSourceUtils.getDataSourceIdByJSAPILayer(i,e):null}clearAllJimuLayerViewsSelectRecord(){return Re(this,void 0,void 0,(function*(){const e=this.jimuLayerViews,t=Object.keys(e),i=[];for(let r=0;r<t.length;r++){const a=e[t[r]];if(ke.includes(a.type)&&a.selectFeaturesByIds){const e=a.selectFeaturesByIds([]);i.push(e)}}i.length>0&&(yield Promise.all(i))}))}addJimuLayerView(e){this.jimuLayerViews[e.id]=e}whenJimuMapViewLoaded(){return Re(this,void 0,void 0,(function*(){return this.jimuMapViewLoadPromise?this.jimuMapViewLoadPromise:this.view?(this.jimuMapViewLoadPromise=this.view.when().then((()=>Re(this,void 0,void 0,(function*(){return this.startCreateJimuLayerViews(),this.createJimuTablesAndWatchTableDataSourcesInfoChange(),this.tryGoToSelectionsByUrlHash(),this.status=y.JimuMapViewStatus.Loaded,this.mapViewManager.setJimuMapView(this),Promise.resolve(this)}))),(e=>Re(this,void 0,void 0,(function*(){return console.error(e),this.status=y.JimuMapViewStatus.Failed,this.mapViewManager.setJimuMapView(this),Promise.reject(this)})))),this.jimuMapViewLoadPromise):(this.status=y.JimuMapViewStatus.Failed,this.mapViewManager.setJimuMapView(this),this.jimuMapViewLoadPromise=Promise.reject(this),this.jimuMapViewLoadPromise)}))}whenJimuLayerViewLoaded(e){return Re(this,void 0,void 0,(function*(){if(this.jimuLayerViewLoadPromises[e])return this.jimuLayerViewLoadPromises[e];try{yield this.makeSureParentLayerViewsLoaded(e)}catch(e){console.log(e)}return this.jimuLayerViewLoadPromises[e]?this.jimuLayerViewLoadPromises[e]:Promise.reject(Error("Bad jimuLayerViewId:"+e))}))}whenJimuLayerViewLoadedByDataSource(e){return Re(this,void 0,void 0,(function*(){let t="";if(e.type===y.DataSourceTypes.BuildingComponentSubLayer||e.type===y.DataSourceTypes.BuildingGroupSubLayer)t=`${this.mapWidgetId}-${e.id}`;else{const i=e.jimuLayerId;if(!i)return console.error("Can not find jimuLayerId in data source.",e.id),Promise.resolve(null);t=this.getJimuLayerViewIdByJimuLayerId(i)}return this.whenJimuLayerViewLoaded(t)}))}makeSureParentLayerViewsLoaded(e){return Re(this,void 0,void 0,(function*(){const t=Object.keys(this.jimuLayerViewLoadPromises).length,i=[];Object.keys(this.jimuLayerViewLoadPromises).forEach((t=>{const r=this.jimuLayerViewLoadPromises[t];r&&e.startsWith(t)&&i.push(r)})),yield Promise.all(i),Object.keys(this.jimuLayerViewLoadPromises).length>t&&(yield this.makeSureParentLayerViewsLoaded(e))}))}whenAllJimuLayerViewLoaded(){return Re(this,void 0,void 0,(function*(){const e={};return yield this.whenChildJimuLayerViewLoaded(null,e),e}))}whenChildJimuLayerViewLoaded(e,t){return Re(this,void 0,void 0,(function*(){const i=yield Promise.all(this.getChildJimuLayerViewIds(e).map((e=>this.whenJimuLayerViewLoaded(e).then((i=>(t[e]=i,i))).catch((t=>(console.error("JimuLayerView fails.",e,t),null))))));yield Promise.all(i.filter((e=>e)).map((e=>this.whenChildJimuLayerViewLoaded(e.id,t))))}))}getAllJimuLayerViews(){return Object.values(this.jimuLayerViews)}getParentJimuLayerViews(e){const t=[];let i=this.jimuLayerViews[e];for(;null==i?void 0:i.parentJimuLayerViewId;){const e=this.jimuLayerViews[i.parentJimuLayerViewId];e&&t.push(e),i=e}return t}getAllChildJimuLayerViews(e){const t=[];return this.findChildLayerView(e,t),t}getChildJimuLayerViews(e){const t=[];return Object.values(this.jimuLayerViews).forEach((i=>{i&&i.parentJimuLayerViewId===e&&t.push(i)})),t}getChildJimuLayerViewIds(e){return Object.keys(this.jimuLayerViews).filter((t=>this.jimuLayerViews[t].parentJimuLayerViewId===e))}findChildLayerView(e,t){const i=this.jimuLayerViews,r=Object.keys(i);for(let a=0;a<r.length;a++){if(i[r[a]].parentJimuLayerViewId===e){const e=i[r[a]];t.push(e),this.findChildLayerView(e.id,t)}}}startCreateJimuLayerViews(){return Re(this,void 0,void 0,(function*(){Object.keys(this.jimuLayerViewLoadPromises).length>0||this.view.map.layers.toArray().reverse().forEach(((e,t)=>Re(this,void 0,void 0,(function*(){try{this.createJimuLayerView(e,null,t)}catch(e){console.log("Create JimuLayerViews error.",e)}}))))}))}createJimuLayerView(e,t,i,r,a){return Re(this,void 0,void 0,(function*(){var s,n,o;let l=null;const u=y.DataSourceManager.getInstance().getDataSource(this.dataSourceId),c=e.id+"",d=y.dataSourceUtils.getJimuLayerIdByJSAPILayer(e),p=this.getJimuLayerViewIdByJimuLayerId(d),g=t?this.getJimuLayerViewIdByJimuLayerId(t):null;let m;if(a){if(r)m=r.id;else if(g){const t=this.jimuLayerViews[g],i=t&&t.getLayerDataSource();m=y.dataSourceUtils.getDataSourceIdByJSAPILayer(i,e)}}else m=y.dataSourceUtils.getDataSourceIdByJSAPILayer(u,e);m||(m="");const f={id:p,jimuLayerId:d,layerDataSourceId:m,jimuMapViewId:this.id,parentJimuLayerViewId:g,mapViewManager:this.mapViewManager,index:i,fromRuntime:a,urlHashLayersVisibility:this.urlHashLayersVisibility};if("esri.layers.support.Sublayer"===e.declaredClass){const t=e,i=(null===(s=t.sourceJSON)||void 0===s?void 0:s.layerType)||(null===(n=t.sourceJSON)||void 0===n?void 0:n.type);i===y.SupportedLayerServiceTypes.GroupLayer?(null===(o=t.sublayers)||void 0===o?void 0:o.length)>0&&(Object.assign(f,{type:h.GroupLayer,layer:t}),l=new ue(f)):i===y.SupportedLayerServiceTypes.FeatureLayer?(Object.assign(f,{type:h.FeatureLayer,layer:t}),l=new ve(f)):"Raster Layer"===i?(Object.assign(f,{type:t.type,layer:t}),l=new oe(f)):console.log("Unsupported sub layer type.",c)}else{const t=e;switch(t.type){case h.SceneLayer:Object.assign(f,{type:t.type,layer:t}),l=new we(f);break;case h.FeatureLayer:Object.assign(f,{type:t.type,layer:t}),l=new ve(f);break;case h.MapImageLayer:case h.TileLayer:Object.assign(f,{type:t.type,layer:t}),t.type===h.MapImageLayer&&(l=new he(f)),t.type===h.TileLayer&&(l=new ye(f));break;case h.GroupLayer:Object.assign(f,{view:null,type:t.type,layer:t}),l=new ue(f);break;case h.SubtypeGroupLayer:Object.assign(f,{type:t.type,layer:t}),l=new Pe(f);break;case h.SubtypeSublayer:Object.assign(f,{type:t.type,layer:t}),l=new Ae(f);break;case h.BuildingSceneLayer:Object.assign(f,{type:t.type,layer:t}),l=new Le(f);break;case h.BuildingGroupSublayer:Object.assign(f,{type:t.type,layer:t}),l=new be(f);break;case h.BuildingComponentSublayer:Object.assign(f,{type:t.type,layer:t}),l=new Ve(f);break;case h.ImageryLayer:Object.assign(f,{type:t.type,layer:t}),l=new Me(f);break;case h.ImageryTileLayer:Object.assign(f,{type:t.type,layer:t}),l=new pe(f);break;case h.OrientedImageryLayer:Object.assign(f,{type:t.type,layer:t}),l=new Ce(f);break;default:Object.assign(f,{type:t.type,layer:t}),l=new oe(f)}}return l?(this.addJimuLayerView(l),this.finalLayerVisibles[l.id]=l.isLayerVisible(),this.jimuLayerViewLoadPromises[p]=this.whenLayerView(l).then((e=>(l.view=e,l.ready()))).then((e=>(e.isLoaded=!0,setTimeout((()=>{this.onJimuLayerViewCreated(e)}),0),e))),l):Promise.resolve(null)}))}whenLayerView(e){return Re(this,void 0,void 0,(function*(){var t,i;const r=e.layer;if("esri.layers.support.Sublayer"===r.declaredClass||e.type===h.GroupLayer||"esri.layers.support.SubtypeSublayer"===r.declaredClass||"esri.layers.buildingSublayers.BuildingGroupSublayer"===r.declaredClass)return null;if("esri.layers.buildingSublayers.BuildingComponentSublayer"===r.declaredClass){const a=r;let s=null,n=null;if("esri.layers.BuildingSceneLayer"===(null===(t=a.layer)||void 0===t?void 0:t.declaredClass))s=a.layer;else{const t=this.getParentJimuLayerViews(e.id);for(let e=0;e<t.length;e++){const i=t[e].layer;if("esri.layers.BuildingSceneLayer"===i.declaredClass){s=i;break}}}if(s){const e=yield this.view.whenLayerView(s);(null===(i=null==e?void 0:e.sublayerViews)||void 0===i?void 0:i.length)>0&&(n=e.sublayerViews.find((e=>e.sublayer===a)))}else console.error(`BuildingComponentSublayer ${e.id} can not get the related BuildingSceneLayer`);return n}return this.view.whenLayerView(r)}))}onStoreChange(e,t){Object.keys(t||{}).forEach((i=>{if(t[i].instanceStatus===y.DataSourceStatus.Created&&(!(null==e?void 0:e[i])||e[i].instanceStatus!==y.DataSourceStatus.Created)){const e=y.DataSourceManager.getInstance().getDataSource(i),t=Object.keys(this.jimuLayerViews).find((t=>!this.jimuLayerViews[t].layerDataSourceId&&this.jimuLayerViews[t].jimuLayerId===(null==e?void 0:e.jimuLayerId)));t&&(this.jimuLayerViews[t].layerDataSourceId=e.id)}}))}createJimuTablesAndWatchTableDataSourcesInfoChange(){var e,t,i,r;const a=this.getMapDataSource(),s=null===(r=null===(i=null===(t=null===(e=this.view)||void 0===e?void 0:e.map)||void 0===t?void 0:t.tables)||void 0===i?void 0:i.toArray())||void 0===r?void 0:r.reverse();s&&s.length>0&&s.forEach((e=>{const t=y.dataSourceUtils.getJimuLayerIdByJSAPILayer(e),i=this.getJimuLayerViewIdByJimuLayerId(t);if(this.jimuTables[i]=e,!a)return;if("esri.layers.FeatureLayer"!==e.declaredClass)return;const r=y.dataSourceUtils.getDataSourceIdByJSAPILayer(a,e);if(r){const t=(0,y.observeStore)(((t,i)=>{this.onTableDataSourceInfoChange(e,r)}),["dataSourcesInfo",r]);this.storeUnsubscribes.push(t)}}))}onTableDataSourceInfoChange(e,t){const i=y.DataSourceManager.getInstance().getDataSource(t);if(i&&i.getRealQueryParams){const t={outFields:["*"],where:"",returnGeometry:!0},r=i.getRealQueryParams(t,"query");r&&e.definitionExpression!==r.where&&(e.definitionExpression=r.where)}}clearSelectedFeatures(){const e=this.getLayerDataSourceIdsWithSelection();this.clearAllJimuLayerViewsSelectRecord(),this.publishEmptySelectionChangeMessage(e)}selectFeaturesByGraphic(e,t,i,r){return Re(this,void 0,void 0,(function*(){const a=(yield v(["esri/geometry/geometryEngine"]))[0];let s=e.geometry;if("point"===s.type||"polyline"===s.type){const e=2.54*this.view.scale/9600;s=a.buffer(s,10*e,"meters")}const n={geometry:s,returnGeometry:!0,outFields:[],returnZ:!0};n.spatialRelationship=t;let o=null;r&&(r.returnAllFields&&(n.outFields=["*"]),r.returnFullGeometry&&(n.returnFullGeometry=!0),"function"==typeof r.filterJimuLayerView&&(o=r.filterJimuLayerView));const l=this.jimuLayerViews,u=Object.keys(l),c=[],d={},y=e=>Re(this,void 0,void 0,(function*(){const t=yield e.selectFeaturesByQuery(n,i);if(d[e.id]=t,e.type===h.SubtypeGroupLayer){const t=e.getLayerDataSource();if(t){const e=t.getSelectedRecords(),i=p(t,e);Object.keys(i).forEach((e=>{const t=this.getJimuLayerViewByDataSourceId(e),r=null==t?void 0:t.id;if(r){const t=i[e].map((e=>e.feature));d[r]=t}}))}}}));for(let e=0;e<u.length;e++){const t=l[u[e]];if(ke.includes(t.type)&&t.selectFeaturesByQuery){if(o&&o(t)||!o){const e=y(t);c.push(e)}}}return this.onSelectByQueryProgressChange(),yield Promise.all(c),d}))}cancelSelectByQuery(e){return Re(this,void 0,void 0,(function*(){const t=this.jimuLayerViews,i=Object.keys(t),r=[];for(let a=0;a<i.length;a++){const s=t[i[a]];if(ke.includes(s.type)&&s.cancelSelectByQuery){const t=s.cancelSelectByQuery(e);r.push(t)}}yield Promise.all(r)}))}getSelectByQueryProgress(){const e=[],t=this.jimuLayerViews,i=Object.keys(t);for(let r=0;r<i.length;r++){const a=t[i[r]];if(ke.includes(a.type)&&a.getSelectQueryProgress){const t=a.getSelectQueryProgress();e.push(t)}}if(0===e.length)return 1;{let t=e.reduce(((e,t)=>e+t));return t/=e.length,t=Math.max(0,Math.min(t,1)),t}}destroy(){var e;this.cacheListeners=[],this.restoreListeners=[],this.selectedFeaturesChangeListeners=[],this.jimuLayerViewCreatedListeners=[],this.jimuLayerViewRemovedListeners=[],this.jimuLayerViewsVisibleChangedListeners=[],this.selectByQueryProgressChangeListeners=[],this.forcePopupEnabledLayers=[],this.watchRemoveLayerHandle&&(this.watchRemoveLayerHandle.remove(),this.watchRemoveLayerHandle=null),this.watchPopupFeaturesHandle&&(this.watchPopupFeaturesHandle.remove(),this.watchPopupFeaturesHandle=null),this.watchPopupSelectedHandle&&(this.watchPopupSelectedHandle.remove(),this.watchPopupSelectedHandle=null),(null===(e=this.storeUnsubscribes)||void 0===e?void 0:e.length)>0&&this.storeUnsubscribes.forEach((e=>{e()})),this.storeUnsubscribes=[];const t=this.id,i=y.MutableStoreManager.getInstance().getStateValue([this.mapWidgetId])||{},r=i.addToMapDatas,a=i.showOnMapDatas;if(r){Object.keys(r).forEach((e=>{const i=r[e];i&&i.mapWidgetId===this.mapWidgetId&&i.jimuMapViewId===t&&delete r[e]}))}if(a){Object.keys(a).forEach((e=>{const i=a[e];i&&i.mapWidgetId===this.mapWidgetId&&i.jimuMapViewId===t&&delete a[e]}))}const s=this.jimuLayerViews,n=Object.keys(s);for(let e=0;e<n.length;e++){s[n[e]].destroy()}this.view&&(this.view.destroyed||(this.view.graphics&&this.view.graphics.destroyed&&this.view.graphics.destroy(),this.view.container=null,this.view.allLayerViews&&this.view.allLayerViews.destroyed&&this.view.allLayerViews.destroy(),this.view.layerViews&&this.view.layerViews.destroyed&&this.view.layerViews.destroy(),this.jimuMapTools=[],this.view.destroy(),this.view=null))}_getDefaultJimuMapViewId(){const e=(0,y.getAppStore)().getState().jimuMapViewsInfo;return Object.keys(e||{}).find((t=>e[t].mapWidgetId===this.mapWidgetId))}handleShowOnMapAction(e){const t=[];Object.entries(e).forEach((e=>{const i=e[0],r=e[1];let a=r.jimuMapViewId;if(a||r.mapWidgetId!==this.mapWidgetId||(a=this._getDefaultJimuMapViewId()),a===this.id){let e=null;e=this.showOnMapDatas[i]?this.tryUpdateFeatureLayerForShowOnMapAction(i,r):this.createFeatureLayerForShowOnMapAction(i,r),r.type===Te.DataAction&&t.push(e),this.showOnMapDatas[i]=r}})),Object.entries(this.showOnMapDatas).forEach((t=>{const i=t[0];if(!e[i]){const e=this.view.map.findLayerById(i);delete this.showOnMapDatas[i],e&&this.view.map.remove(e)}})),t.length>0&&Promise.all(t).then((e=>{const t=e.flat();t.length>0&&L(this.view,t,{padding:{left:50,right:50,top:50,bottom:50}})}))}createFeatureLayerForShowOnMapAction(e,t){return Re(this,void 0,void 0,(function*(){var i,r,a,s,n;let o=[];try{const{dataSet:l,title:u,symbolOption:c}=t,d=yield v(["esri/symbols/support/jsonUtils","esri/symbols/support/symbolUtils","esri/renderers/UniqueValueRenderer"]),[h,p,g]=d,m=l.dataSource;let f=l.records||[];f=f.filter((e=>e&&e.getGeometry()));const w=m.getIdField(),S=yield z(l);(null===(i=null==S?void 0:S.features)||void 0===i?void 0:i.length)>0&&(o=S.features.filter((e=>!!e.geometry)));let L=null,I=null;if(f.length>0){const e=f[0].getFeature();e&&(L=e.layer||e.sourceLayer)}L&&L.renderer&&"function"==typeof(null===(r=L.renderer)||void 0===r?void 0:r.clone)&&(I=null===(a=L.renderer)||void 0===a?void 0:a.clone());let b=!0;if(t.type===Te.DataAction)b=!0;else if(t.type===Te.MessageAction){b=!!this.getJimuLayerViewByDataSourceId(m.id)}let V=null,M=null;if(b){const e=(0,y.uuidv1)(),t=null===(s=m.getSchema())||void 0===s?void 0:s.asMutable({deep:!0}),i={id:`${this.mapWidgetId}_show_on_map_${e}`,type:y.DataSourceTypes.FeatureLayer,label:u||m.getLabel(),isOutputFromWidget:!0,originDataSources:null,url:null,itemId:null,portalUrl:null,schema:t},r=y.DataSourceManager.getInstance(),a=yield r.createDataSource((0,y.Immutable)(i));let n=yield y.dataSourceUtils.changeJimuRecordsToJSAPIGraphics(f);n||(n=[]),n=n.filter((e=>!!e)),yield a.setSourceFeatures(n),a.setStatus(y.DataSourceStatus.Unloaded),a.setCountStatus(y.DataSourceStatus.Unloaded),V=a,M=a.layer}else{V=m;const e=yield y.dataSourceUtils.createJSAPIFeatureLayerByRecords(V,f);M=null==e?void 0:e.layer}if(M){if(M[y.ExBAddedJSAPIProperties.EXB_DATA_SOURCE]=V,M[y.ExBAddedJSAPIProperties.EXB_DATA_SET]=l,M.id=e,!M.geometryType&&f.length>0){const e=f[0],t=null===(n=null==e?void 0:e.feature)||void 0===n?void 0:n.geometry;if(t&&t.declaredClass){let e=t.type;e&&("extent"===e&&(e="polygon"),M.geometryType=e)}}u&&(M.title=u);const i=M.fields;i&&i.forEach((e=>{e.editable=!1})),t.isOperationalLayer?(M.listMode="show",M.legendEnabled=!0,M.popupEnabled=!0):(M.listMode="hide",M.legendEnabled=!1,M.popupEnabled=!1),M.editingEnabled=!0;const r=yield M.queryObjectIds({where:"1=1"}),a={};r.forEach((e=>{a[e]=!0}));const s=f.filter((e=>{const t=e.getId();return t&&!a[t]}));if(s.length>0){let e=yield y.dataSourceUtils.changeJimuRecordsToJSAPIGraphics(s);e||(e=[]),e=e.filter((e=>!!e)),yield M.applyEdits({addFeatures:e})}const o=M.geometryType;let d;if("point"===o||"polyline"===o||"polygon"===o?d=o:"multipoint"===o&&(d="point"),!d)throw new Error(`invalid geometry type ${o}`);let m=null;c?m=yield function(e,t,i){return Je(this,void 0,void 0,(function*(){let r=null,a=null;return t&&(t.pointSymbol&&"point"===i?a=e.fromJSON(t.pointSymbol):t.polylineSymbol&&"polyline"===i?a=e.fromJSON(t.polylineSymbol):t.polygonSymbol&&"polygon"===i&&(a=e.fromJSON(t.polygonSymbol))),a&&(r=yield je(a)),r}))}(h,c,d):void 0===c?m=yield xe(h,d):null===c&&I&&(m=yield Oe(this.view,S,w,d,p,h,g)),m||(m=yield xe(h,d)),M.renderer=m,yield this.addLayerAndCreateJimuLayerView(M,V)}}catch(e){console.warn("drawDataRecordSet error",e),o=[]}return o||(o=[]),o}))}tryUpdateFeatureLayerForShowOnMapAction(e,t){return Re(this,void 0,void 0,(function*(){const{dataSet:i}=t,r=this.view.map.findLayerById(e);let a=[];if(r){if(r[y.ExBAddedJSAPIProperties.EXB_DATA_SET]===i)return a=[],a;{const i=this.getJimuLayerViewByAPILayer(r);i?this.removeJimuLayerView(i):this.view.map.remove(r),a=yield this.createFeatureLayerForShowOnMapAction(e,t)}}return a}))}handleAddToMapAction(e){Object.entries(e).forEach((t=>{const i=t[0],r=t[1];let a=r.jimuMapViewId;if(a||r.mapWidgetId!==this.mapWidgetId||(a=this._getDefaultJimuMapViewId()),a===this.id&&r.dataChangeType===Be.Create){if(r.dataChangeType===Be.Create){r.dataChangeType=Be.Creating;const e=i;this.addLayerToMap(r.dataSourceId,i).then((()=>{const t=y.MutableStoreManager.getInstance().getStateValue([this.mapWidgetId,"addToMapDatas",`${e}`]);y.MutableStoreManager.getInstance().updateStateValue(this.mapWidgetId,`addToMapDatas.${e}`,Object.assign(Object.assign({},t),{dataChangeType:Be.Created,dataChangeStatus:Ue.Fulfilled}))})).catch((t=>{y.MutableStoreManager.getInstance().updateStateValue(this.mapWidgetId,`addToMapDatas.${e}.dataChangeStatus`,Ue.Rejected),setTimeout((()=>{y.MutableStoreManager.getInstance().updateStateValue(this.mapWidgetId,`addToMapDatas.${e}.dataChangeStatus`,Ue.RejectedAndKnown)}),3e3)}))}}else a===this.id&&r.dataChangeType===Be.Remove&&(this.removeLayerFromMap(i),delete e[i])}))}addLayerToMap(e,t){return Re(this,void 0,void 0,(function*(){const i=y.DataSourceManager.getInstance().getDataSource(e);if(!i)throw new Error(`can't get data source for ${e}`);const r=yield null==i?void 0:i.createJSAPILayerByDataSource();if(!r)throw new Error(`data source ${e} can't create layer`);r.id=t;return yield this.addLayerAndCreateJimuLayerView(r,i)}))}addLayerAndCreateJimuLayerView(e,t){return Re(this,void 0,void 0,(function*(){this.view.map.add(e);const i=this.getNewMinLayerIndexOfRootLayers();return yield this.createJimuLayerView(e,null,i,t,!0)}))}getNewMinLayerIndexOfRootLayers(){let e=null;return Object.values(this.jimuLayerViews).forEach((t=>{t&&!t.parentJimuLayerViewId&&(e="number"==typeof e?Math.min(e,t.index):t.index)})),"number"==typeof e?e-1:0}removeJimuLayerView(e){if(!e)return;if(e.getJimuMapView()===this&&this.jimuLayerViews[e.id]===e&&e.fromRuntime){const t=this.getChildJimuLayerViewIds(e.id).map((e=>this.jimuLayerViews[e]));delete this.jimuLayerViews[e.id],this.jimuLayerViewLoadPromises&&delete this.jimuLayerViewLoadPromises[e.id];const i=e.layer;if(this.onJimuLayerViewRemoved(e),i){const e=this.view.map;e.layers.toArray().includes(i)&&e.remove(i)}e.destroy(),t.forEach((e=>{this.removeJimuLayerView(e)}))}}removeLayerFromMap(e){console.warn("jimuMapView.removeLayerFromMap() is deprecated, please use jimuMapView.removeJimuLayerView() instead.");const t=this.view.map.findLayerById(e);t&&this.view.map.remove(t)}parseLayersVisibilityFromUrlHash(){let e=null;try{const t=(0,y.getAppStore)().getState();if(t.urlHashObject){const i=t.urlHashObject[this.mapWidgetId];if(i&&i.layer_visibility){const t=JSON.parse(i.layer_visibility);if(t){const i=t[this.id];i&&"object"==typeof i&&(e=i)}}}}catch(t){e=null,console.error("parse layers visibility from url hash error",t)}return e}getCurrentLayersVisibilityForUrlHash(){const e={};return Object.values(this.jimuLayerViews).forEach((t=>{t.layer&&!t.fromRuntime&&t.layer.visible!==t.originalLayerVisible&&(e[t.id]=t.layer.visible)})),e}updateUrlHashLayerVisibility(){const e={};if(e[this.id]=this.getCurrentLayersVisibilityForUrlHash(),this.jimuMapViewGroup){this.jimuMapViewGroup.getAllJimuMapViews().forEach((t=>{t!==this&&(e[t.id]=t.getCurrentLayersVisibilityForUrlHash())}))}const t=y.UrlManager.getInstance();Object.keys(e).forEach((t=>{const i=e[t];i&&0!==Object.keys(i).length||delete e[t]}));let i=null;Object.keys(e).length>0&&(i=JSON.stringify(e)),t.setWidgetUrlParams(this.mapWidgetId,{layer_visibility:i})}tryGoToSelectionsByUrlHash(){return Re(this,void 0,void 0,(function*(){var e,t,i;if(!this.view)return;const r=this.view,a=r.initUrlHashMapOptions;if(a&&Object.keys(a).length>0)return;yield this.whenJimuMapViewLoaded();const s=y.UrlManager.getInstance(),n=s.getQueryObject(),o=s.getHashObject(),l=(0,y.getAppStore)().getState(),u=null===(i=null===(t=null===(e=null==l?void 0:l.appConfig)||void 0===e?void 0:e.urlParams)||void 0===t?void 0:t.general)||void 0===i?void 0:i.dataSelection,c=u&&u.isEnable&&u.zoomToSelection,d="true"===(null==o?void 0:o.zoom_to_selection)||c,h=y.urlUtils.getDataSourceInfosFromUrlParams(n,o),p=this.getMapDataSource(),g=[];if(h&&p&&Object.keys(h).forEach((e=>{if(e.startsWith(`${this.dataSourceId}-`)){const t=h[e];if(t){const i=t.selection;if(i){let t=null;if(Array.isArray(i))i.length>0&&(t={objectIds:i});else{const e=i.ids;Array.isArray(e)&&e.length>0?t={objectIds:e}:i.queryParams&&(t=i.queryParams)}if(t){t.disableClientQuery=!0;const i=this.queryExtentByDataSource(p,e,t);g.push(i)}}}}})),g.length>0){const e=(yield Promise.all(g)).filter((e=>!!e));if(e.length>0){const t=e.map((e=>Re(this,void 0,void 0,(function*(){let t=null;try{const i=yield y.geometryUtils.projectToSpatialReference([e],this.view.spatialReference);i&&i.length>0&&(t=i[0])}catch(e){console.error("projectToSpatialReference error",e),t=null}return t}))));let i=yield Promise.all(t);i=i.filter((e=>!!e));let a=null;if(i&&i.length>0&&i.forEach((e=>{a?a.union(e):a=e.clone()})),a){const e=a.center;if(d||!d&&e){if(r.extentChangeRelatedWidgetIds=[],r.receiveMessageTimeOfLastViewUpdate=Date.now(),d){const e={padding:{left:50,right:50,top:50,bottom:50}},[t,i]=yield v(["esri/geometry/Polygon","esri/Graphic"]),r=new i({geometry:t.fromExtent(a)});yield L(this.view,[r],e)}else e&&(yield this.view.goTo(e,{animate:!1}));if(r.publishExtentChangeMessage){r.extentChangeRelatedWidgetIds=[],r.receiveMessageTimeOfLastViewUpdate=Date.now();const e=!0,t=!0;r.publishExtentChangeMessage(e,t)}}}}}}))}queryExtentByDataSource(e,t,i){return Re(this,void 0,void 0,(function*(){var r,a,s;let n=null;try{const o=yield e.createDataSourceById(t);let l=!1,u=null;(null===(r=i.objectIds)||void 0===r?void 0:r.length)>0&&(l=1===(null===(a=i.objectIds)||void 0===a?void 0:a.length),u=i.objectIds[0]);try{const e=yield o.queryExtent(i);if(e){const t=e.extent;if(t)if("esri.geometry.Extent"===t.declaredClass)n=t;else{n=(yield(0,y.loadArcGISJSAPIModule)("esri/geometry/Extent")).fromJSON(t)}try{if("number"==typeof e.count&&!l&&(l=1===e.count,l&&null==u)){const e=Object.assign({},i),t=yield o.queryIds(e);t&&1===(null===(s=t.ids)||void 0===s?void 0:s.length)&&(u=t.ids[0])}}catch(e){console.error("ds.queryIds() error",e)}}}catch(e){n=null,console.warn(`ds.queryExtent() error for ${o.id}`,e)}if((!n||l)&&null!=u){const e=yield o.queryById(u,[]),t=null==e?void 0:e.feature;if(t){let e=null;if("esri.Graphic"===t.declaredClass)e=t;else{e=new(yield(0,y.loadArcGISJSAPIModule)("esri/Graphic"))({geometry:t.geometry,attributes:t.attributes})}const i=null==e?void 0:e.geometry;if(i&&(n=i.extent,!n&&"esri.geometry.Point"===i.declaredClass)){const e=i;if("number"==typeof e.x&&"number"==typeof e.y){n=new(yield(0,y.loadArcGISJSAPIModule)("esri/geometry/Extent"))({xmin:e.x,xmax:e.x,ymin:e.y,ymax:e.y,spatialReference:e.spatialReference})}}}}}catch(e){console.error("dataSourceQueryExtent error",e),n=null}return n}))}isDestroyed(){return!this.view||this.view.destroyed}isCached(){var e;const t=null===(e=this.view)||void 0===e?void 0:e.container;return t&&!document.body.contains(t)}addCacheListener(e){this.cacheListeners.includes(e)||this.cacheListeners.push(e)}removeCacheListener(e){const t=this.cacheListeners.indexOf(e);t>=0&&this.cacheListeners.splice(t,1)}onCache(){this.cacheListeners.forEach((e=>{try{e(this)}catch(t){console.error("JimuMapView onCache listener error",this.id,e,t)}}))}addRestoreListener(e){this.restoreListeners.includes(e)||this.restoreListeners.push(e)}removeRestoreListener(e){const t=this.restoreListeners.indexOf(e);t>=0&&this.restoreListeners.splice(t,1)}onRestore(){this.restoreListeners.forEach((e=>{try{e(this)}catch(t){console.error("JimuMapView onRestore listener error",this.id,e,t)}}))}addJimuLayerViewSelectedFeaturesChangeListener(e){this.selectedFeaturesChangeListeners.includes(e)||this.selectedFeaturesChangeListeners.push(e)}removeJimuLayerViewSelectedFeaturesChangeListener(e){const t=this.selectedFeaturesChangeListeners.indexOf(e);t>=0&&this.selectedFeaturesChangeListeners.splice(t,1)}onJimuLayerViewSelectedFeaturesChange(e,t){return Re(this,void 0,void 0,(function*(){this.selectedFeaturesChangeListeners.forEach((t=>{try{t(e)}catch(e){console.error("onJimuLayerViewSelectedFeaturesChange listener error",this.id,t,e)}})),yield this.handlePopupOnSelectionChange(e,t)}))}addSelectByQueryProgressChangeListener(e){this.selectByQueryProgressChangeListeners.includes(e)||this.selectByQueryProgressChangeListeners.push(e)}removeSelectByQueryProgressChangeListener(e){const t=this.selectByQueryProgressChangeListeners.indexOf(e);t>=0&&this.selectByQueryProgressChangeListeners.splice(t,1)}onSelectByQueryProgressChange(){const e=this.getSelectByQueryProgress();this.selectByQueryProgressChangeListeners.forEach((t=>{try{t(e)}catch(e){console.error("onSelectByQueryProgressChange listener error",this.id,t,e)}}))}addJimuLayerViewCreatedListener(e){this.jimuLayerViewCreatedListeners.includes(e)||this.jimuLayerViewCreatedListeners.push(e)}removeJimuLayerViewCreatedListener(e){const t=this.jimuLayerViewCreatedListeners.indexOf(e);t>=0&&this.jimuLayerViewCreatedListeners.splice(t,1)}onJimuLayerViewCreated(e){this.jimuLayerViewCreatedListeners.forEach((t=>{try{t(e)}catch(e){console.error("onJimuLayerViewCreated listener error",this.id,t,e)}}))}addJimuLayerViewRemovedListener(e){this.jimuLayerViewRemovedListeners.includes(e)||this.jimuLayerViewRemovedListeners.push(e)}removeJimuLayerViewRemovedListener(e){const t=this.jimuLayerViewRemovedListeners.indexOf(e);t>=0&&this.jimuLayerViewRemovedListeners.splice(t,1)}onJimuLayerViewRemoved(e){this.jimuLayerViewRemovedListeners.forEach((t=>{try{t(e)}catch(e){console.error("onJimuLayerViewRemoved listener error",this.id,t,e)}}))}addJimuLayerViewsVisibleChangeListener(e){this.jimuLayerViewsVisibleChangedListeners.includes(e)||this.jimuLayerViewsVisibleChangedListeners.push(e)}removeJimuLayerViewsVisibleChangeListener(e){const t=this.jimuLayerViewsVisibleChangedListeners.indexOf(e);t>=0&&this.jimuLayerViewsVisibleChangedListeners.splice(t,1)}onJimuLayerViewSelfVisibleChange(e){const t=[e,...this.getAllChildJimuLayerViews(e.id)].filter((e=>{const t=e.id,i=this.finalLayerVisibles[t],r=e.isLayerVisible();return this.finalLayerVisibles[t]=r,i!==r}));t.length>0&&this.jimuLayerViewsVisibleChangedListeners.forEach((e=>{try{e(t.slice())}catch(e){console.error("onJimuLayerViewSelfVisibleChange listener error",e)}}))}enableLayerPopup(e,t){e&&(e.popupEnabled=!0,t&&(this.forcePopupEnabledLayers||(this.forcePopupEnabledLayers=[]),this.forcePopupEnabledLayers.includes(e)||this.forcePopupEnabledLayers.push(e)))}disableLayerPopup(e){var t,i;if(!e)return;e.popupEnabled=!1,(null===(t=this.forcePopupEnabledLayers)||void 0===t?void 0:t.includes(e))&&(this.forcePopupEnabledLayers=this.forcePopupEnabledLayers.filter((t=>t!==e)));const r=null===(i=this.view)||void 0===i?void 0:i.popup;if(!r)return;const a=(null==r?void 0:r.features)||[];if(a.length>0){const t=a.filter((t=>(t.layer||t.sourceLayer)!==e&&this.isFeaturePopupEnabledByCurrentMapPopupSetting(t)));t.length<a.length&&(0===t.length?this.closePopup():r.features=t)}}}var qe=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class Qe{constructor(e){this.switchMap=(...e)=>qe(this,[...e],void 0,(function*(e=!1){if(this.mapWidgetInstance)return yield this.mapWidgetInstance.switchMap(e);yield Promise.resolve()})),this.fullScreenMap=()=>{this.mapWidgetInstance&&this.mapWidgetInstance.fullScreenMap()},this.mapWidgetId=e,this.jimuMapViews={}}setMapWidgetInstance(e){this.mapWidgetInstance=e}addJimuMapView(e){this.jimuMapViews[e.id]=e,e.jimuMapViewGroup=this}setJimuMapView(e){this.jimuMapViews[e.id]=e,e.jimuMapViewGroup=this}removeJimuMapView(e){delete this.jimuMapViews[e.id],e.jimuMapViewGroup===this&&(e.jimuMapViewGroup=null)}getActiveJimuMapView(){const e=Object.keys(this.jimuMapViews);for(let t=0;t<e.length;t++)if(this.jimuMapViews[e[t]].isActive)return this.jimuMapViews[e[t]];return null}showMapTools(){this.getAllJimuMapViews().forEach((e=>{const t=e.view;t&&t.showMapTools&&t.showMapTools()}))}hideMapTools(){this.getAllJimuMapViews().forEach((e=>{const t=e.view;t&&t.hideMapTools&&t.hideMapTools()}))}getAllJimuMapViews(){return Object.keys(this.jimuMapViews).map((e=>this.jimuMapViews[e]))}}var $e=s(349),Ne=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class _e extends((0,$e.SetDataSourceMixinImpl)($e.AbstractDataSource)){constructor(e){super(e),this.type=d.Map,this.map=e.map}ready(){return Ne(this,void 0,void 0,(function*(){return this.map||(yield this.createMap()),this.createFilterUrlChildDataSource()}))}getChildIds(){return this.getLayersAndTables().map((e=>this.getChildIdByLayer(e)))}createChildDataSourceById(e,t,i){const r=this.findLayerInfo(i);return(null==r?void 0:r.layer)?this.createChildDataSourceByLayer(r.layer,t,e,r.order):Promise.reject(new $e.DataSourceError(e,"Can not find data source."))}createDataSourceByLayer(e){const t=this.getDataSourceByLayer(e);return t?Promise.resolve(t):this.createDataSourceById(y.dataSourceUtils.getDataSourceIdByJSAPILayer(this,e))}fetchSchema(){return Ne(this,void 0,void 0,(function*(){var e,t;const i=this.getChildDataSources();let r=(0,y.Immutable)({childSchemas:{},label:this.getDataSourceJson().sourceLabel||(null===(t=null===(e=this.map)||void 0===e?void 0:e.portalItem)||void 0===t?void 0:t.title)});return i.forEach(((e,t)=>{const i=e.getFetchedSchema();r=r.setIn(["childSchemas",e.jimuChildId],i)})),Promise.resolve(r)}))}getDataSourceByLayer(e){return this.dataSourceManager.getDataSource(y.dataSourceUtils.getDataSourceIdByJSAPILayer(this,e))}getDataSourcesByType(e){if(!e)return[];const t=[];return this.traverseToGetDataSourcesByType(e,this,t),t}traverseToGetDataSourcesByType(e,t,i){if(!e||!t||!i)return;t.type===e&&i.push(t);const r=t.isDataSourceSet()&&t.getChildDataSources();r&&r.forEach((t=>{this.traverseToGetDataSourcesByType(e,t,i)}))}createMap(){return Ne(this,void 0,void 0,(function*(){var e;const t=yield(0,y.loadArcGISJSAPIModules)(["esri/Map","esri/layers/FeatureLayer"]),i=t[0],r=t[1];this.map=new i,null===(e=this.getDataSourceJson().layers)||void 0===e||e.forEach((e=>{this.map.layers.add(new r(e))}))}))}createChildDataSourceByLayer(e,t,i,r){var a,s,n;const o=(null===(s=null===(a=this.getDataSourceJson().schema)||void 0===a?void 0:a.childSchemas)||void 0===s?void 0:s[t])||null,l=(null===(n=this.getDataSourceJson().childDataSourceJsons)||void 0===n?void 0:n[t])||null,u=$e.dataSourceJsonCreator.createDataSourceJsonByJSAPILayer(i,e,l,o);if(u){const i={id:u.id,dataSourceJson:u,layer:e,parentDataSource:this,jimuChildId:t,order:r};return this.dataSourceManager.createDataSource(i)}return Promise.reject(new $e.DataSourceError(i,"Do not support this type of data."))}findLayerInfo(e){let t;return this.getLayersAndTables().some(((i,r)=>this.getChildIdByLayer(i)===e&&(t={layer:i,order:r},!0))),t}getLayersAndTables(){const e=this.map.layers.toArray().reverse(),t=this.map.ground.layers.toArray().reverse(),i=(this.map.tables?this.map.tables.toArray():[]).reverse();return e.concat(t).concat(i)}getChildIdByLayer(e){return y.dataSourceUtils.getFixedLayerIdByLayer(e)}createFilterUrlChildDataSource(){const e=(0,y.getAppStore)().getState().dataSourcesInfo;return Promise.all(Object.keys(e||{}).filter((t=>{var i;return(null===(i=e[t].widgetQueries)||void 0===i?void 0:i._filterInUrl)&&this.findChildDataSourceIdByDescendantDataSourceId(t)})).map((e=>this.createDataSourceById(e)))).then((()=>{})).catch((e=>{console.error("create filter url child data sources error",e)}))}}(0,$e.ItemMixinImpl)(_e);(0,$e.ItemMixinImpl)(_e);var ze=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};class Xe{constructor(){this.jimuMapViewGroups={}}static getInstance(){return window.jimuConfig.isBuilder?window._appWindow&&window._appWindow._mapViewManager:(Xe._instance||(Xe._instance=new Xe,window._mapViewManager=Xe._instance),Xe._instance)}getJimuMapViewById(e){const t=Object.keys(this.jimuMapViewGroups);if(0===t.length)return null;for(let i=0;i<t.length;i++){const r=t[i];if(Object.keys(this.jimuMapViewGroups[r].jimuMapViews).includes(e))return this.jimuMapViewGroups[r].jimuMapViews[e]}return null}getJimuMapViewGroup(e){return this.jimuMapViewGroups[e]?this.jimuMapViewGroups[e]:null}createJimuMapView(e){return ze(this,void 0,void 0,(function*(){const t=e.mapWidgetId+"-"+e.dataSourceId;if(this.getJimuMapViewById(t))return yield Promise.resolve(this.getJimuMapViewById(t));const i=new He(e);return this.addJimuMapView(i),yield i.whenJimuMapViewLoaded()}))}addJimuMapView(e){if(this.jimuMapViewGroups[e.mapWidgetId])this.jimuMapViewGroups[e.mapWidgetId].addJimuMapView(e);else{const t=new Qe(e.mapWidgetId);t.addJimuMapView(e),this.jimuMapViewGroups[e.mapWidgetId]=t}(0,y.getAppStore)().dispatch(y.appActions.jimuMapViewAdded(e.id,(0,y.Immutable)({id:e.id,mapWidgetId:e.mapWidgetId,dataSourceId:e.dataSourceId,status:e.status})))}setJimuMapView(e){if(this.jimuMapViewGroups[e.mapWidgetId])this.jimuMapViewGroups[e.mapWidgetId].setJimuMapView(e);else{const t=new Qe(e.mapWidgetId);t.addJimuMapView(e),this.jimuMapViewGroups[e.mapWidgetId]=t}(0,y.getAppStore)().dispatch(y.appActions.jimuMapViewUpdated(e.id,(0,y.Immutable)({id:e.id,mapWidgetId:e.mapWidgetId,dataSourceId:e.dataSourceId,isActive:e.isActive,status:e.status})))}destroyJimuMapView(e){const t=this.getJimuMapViewById(e);t&&t.destroy();const i=Object.keys(this.jimuMapViewGroups);if(0===i.length);else for(let t=0;t<i.length;t++){const r=i[t];if(Object.keys(this.jimuMapViewGroups[r].jimuMapViews).includes(e)){delete this.jimuMapViewGroups[r].jimuMapViews[e],0===Object.keys(this.jimuMapViewGroups[r].jimuMapViews).length&&delete this.jimuMapViewGroups[r],(0,y.getAppStore)().dispatch(y.appActions.jimuMapViewRemoved(e));break}}}getAllJimuMapViewIds(){const e=[];return Object.keys(this.jimuMapViewGroups).forEach((t=>{Object.keys(this.jimuMapViewGroups[t].jimuMapViews).forEach((t=>{e.push(t)}))})),e}getAllJimuMapViews(){const e=[];return Object.keys(this.jimuMapViewGroups).forEach((t=>{const i=Object.values(this.jimuMapViewGroups[t].jimuMapViews);e.push(...i)})),e}destroyAllJimuMapViews(){this.getAllJimuMapViewIds().forEach((e=>{this.destroyJimuMapView(e)}))}getJimuLayerViewForClientQuery(e){var t,i,r;if(!e||![y.DataSourceTypes.FeatureLayer,y.DataSourceTypes.SceneLayer].includes(e.type))return null;const a=e.id,s=null===(t=e.getRootDataSource())||void 0===t?void 0:t.id;if(!s)return null;const n=null===(r=null===(i=(0,y.getAppStore)().getState())||void 0===i?void 0:i.appConfig)||void 0===r?void 0:r.widgets;if(!n)return null;const o=this.getAllJimuMapViews().filter((e=>{var t;return"2d"===(null===(t=e.view)||void 0===t?void 0:t.type)&&e.dataSourceId===s}));for(const e of o){const t=n[e.mapWidgetId];if(t){const i=t.config||{},r=(null==i?void 0:i.clientQueryDataSourceIds)||[],n=t.useDataSources,o=[];if(n&&n.length>0&&n.forEach((e=>{const t=null==e?void 0:e.dataSourceId;t&&o.push(t)})),r.includes(s)&&o.includes(s)){const t=e.getJimuLayerViewByDataSourceId(a);return t&&t.clientQueryFeatures&&(t.type===h.FeatureLayer||t.type===h.SceneLayer)?t:null}}}return null}}var Ke=s(888),Ye=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};const{loadModules:Ze,resolveModuleFullPath:et}=y.moduleLoader,{getPortalProxyUrl:tt,getStandardPortalUrl:it,isAGOLDomain:rt,isSamePortalUrl:at}=y.portalUrlUtils,{normalize:st,getFolder:nt,getFixedRootPath:ot}=y.urlUtils;let lt,ut,ct,dt,ht;class yt{constructor(){this.id="arcgis-dependency-define"}getDependencyKey(){return"jimu-arcgis"}getResources(){this.themeLoadObserver||(this.themeLoadObserver=Ke.ThemeStore.subscribe(this.onCurrentThemeLoad.bind(this)));let e=window.jimuConfig.arcgisJsApiUrl;if((0,y.getAppStore)().getState().queryObject.apiurl)if("prod"===window.jimuConfig.hostEnv)console.warn("The apiurl query parameter is only valid in dev and qa environments.");else if(e=(0,y.getAppStore)().getState().queryObject.apiurl,!this.checkApiUrl(e))return void console.log("Bad apiurl.",e);/\/$/.test(e)||(e+="/"),window.jimuConfig.arcgisJsApiUrl=e;const t=[{url:`${e}init.js`}];(0,Ke.getTheme)()&&((0,Ke.getTheme)().darkTheme?(document.body.classList.add("calcite-mode-dark"),t.push({url:this.getAPIThemeUrl(e,!0)})):t.push({url:this.getAPIThemeUrl(e,!1)}));const i=`${ot()}arcgis-amd-packages/`;return window.dojoConfig={packages:[{name:"arcgis-charts-js",location:i+"arcgis-charts-js",main:"index"},{name:"arcgis-charts-components",location:i+"arcgis-charts-components",main:"index"},{name:"arcgis-analysis-components",location:i+"arcgis-analysis-components",main:"index"},{name:"arcgis-analysis-core",location:i+"arcgis-analysis-core",main:"index"},{name:"arcgis-analysis-shared-utils",location:i+"arcgis-analysis-shared-utils",main:"index"},{name:"arcgis-analysis-raster-function-utils",location:i+"arcgis-analysis-raster-function-utils",main:"index"},{name:"arcgis-analysis-tool-app",location:i+"arcgis-analysis-tool-app",main:"index"}]},[{url:"jimu-arcgis",dependencies:t}]}postInit(){return Ye(this,void 0,void 0,(function*(){var e,t,i;yield this.initModules(),this.initToRegisterOAuthForMainPortalAndAGOL();const r=(0,y.getAppStore)().getState().portalUrl;dt.setLocale((0,y.getAppStore)().getState().appContext.locale),ct.request.proxyUrl=tt(r),this.initInterceptor(),ct.portalUrl=r;const a=null===(i=null===(t=null===(e=(0,y.getAppStore)().getState().portalSelf)||void 0===e?void 0:e.helperServices)||void 0===t?void 0:t.geometry)||void 0===i?void 0:i.url;a&&(ct.geometryServiceUrl=a),this.addToTrustedServers(),(window.jimuConfig.isBuilder||window.jimuConfig.isInBuilder)&&(window.jimuConfig.isDevEdition||window.jimuConfig.isInPortal)?this.replaceGetCredential():this.replaceGetCredential(!1)}))}initModules(){return Ye(this,void 0,void 0,(function*(){[ut,lt,ct,dt,ht]=yield Ze(["esri/identity/IdentityManager","esri/identity/OAuthInfo","esri/config","esri/intl","esri/core/Error"])}))}initInterceptor(){var e;y.requestUtils.registerCacheableUrl(gt),y.requestUtils.registerCacheableUrl(mt),y.requestUtils.registerCacheableUrl(ft),null===(e=ct.request.interceptors)||void 0===e||e.push({before:e=>{var t,i,r;if(y.proxyUtils.getWhetherUseProxy()){const t=e.url;if("string"==typeof t){const i=y.proxyUtils.getProxyUrl(t);i&&i!==t&&(e.url=i)}}if(!y.requestUtils.isURLCacheable(e.url,null===(t=e.requestOptions)||void 0===t?void 0:t.query))return;const a=y.requestUtils.getRequestCache(e.url,null===(i=e.requestOptions)||void 0===i?void 0:i.query);if(a)return a.promise;{const t=new y.ExternalResolvablePromise;y.requestUtils.setRequestCache(e.url,null===(r=e.requestOptions)||void 0===r?void 0:r.query,t)}},after:e=>{var t,i,r,a,s,n;if(!e||!e.url)return;if(e.url.indexOf("/rest/info")&&(null===(t=e.data)||void 0===t?void 0:t.owningSystemUrl)&&this.registerOAuthInfo(e.data.owningSystemUrl),!y.requestUtils.isURLCacheable(e.url,null===(i=e.requestOptions)||void 0===i?void 0:i.query))return;const o=y.requestUtils.getRequestCache(e.url,null===(r=e.requestOptions)||void 0===r?void 0:r.query);if(o&&(o.resolve(e.data),null===(a=e.data)||void 0===a?void 0:a.editingInfo)){const t=y.DataSourceManager.getInstance().getDataSources(),i=Object.keys(t).filter((i=>t[i].url===e.url)).map((e=>t[e]));i.length>0?i.find((e=>e.getAutoRefreshInterval&&e.getAutoRefreshInterval()>0))&&y.requestUtils.deleteRequestCache(e.url,null===(s=e.requestOptions)||void 0===s?void 0:s.query):y.requestUtils.deleteRequestCache(e.url,null===(n=e.requestOptions)||void 0===n?void 0:n.query)}},error:e=>{var t,i,r,a,s,n;const o=y.requestUtils.getRequestCache(null===(t=null==e?void 0:e.details)||void 0===t?void 0:t.url,null===(r=null===(i=null==e?void 0:e.details)||void 0===i?void 0:i.requestOptions)||void 0===r?void 0:r.query);o&&(o.reject(e),y.requestUtils.deleteRequestCache(null===(a=null==e?void 0:e.details)||void 0===a?void 0:a.url,null===(n=null===(s=null==e?void 0:e.details)||void 0===s?void 0:s.requestOptions)||void 0===n?void 0:n.query))}})}replaceGetCredential(e=!0){const t=y.SessionManager.getInstance(),i=ut.getCredential.bind(ut);let r;ut.getCredential=(a,s)=>{try{const n=!!t.getServerKeyFromUrl(a),o=y.SessionManager.getInstance().getClientIdByUrl(a),l=(null==a?void 0:a.indexOf("/sharing/rest/portals/self"))>0;if(t.getNoPermissionResourceInfoByUrl(a)){return ut.findCredential(a)?i.call(ut,a,s):Promise.reject(new ht("identity-manager:user-aborted","ABORTED"))}let u=null;if(!(null==s?void 0:s.prompt)||ut.findCredential(a)||t.getSessionByUrl(a)||(u=t.tryToPendingSignInDialog(a)),u)r=u.promise.then((()=>i.call(ut,a,s)));else if(n||o||!(null==s?void 0:s.prompt)||ut.findCredential(a)||ut.findOAuthInfo(a)||!e)r=i.call(ut,a,s);else{const e=it(a);r=t.useDialogToSetClientIdToConnectionsOfAppConfigAndSignIn(e).then((()=>(this.registerOAuthInfo(e),i.call(ut,a,s)))).catch((()=>i.call(ut,a,s)))}return r.then((e=>(l||(t.getServerKeyFromUrl(a)?y.ServiceManager.getInstance().fetchArcGISServerInfo(a).then((i=>{t.checkSessionPermissionForUrl(a,e.token,e.userId,null==i?void 0:i.owningSystemUrl)})):t.checkSessionPermissionForUrl(a,e.token,e.userId,"")),e))).catch((e=>(t.releasePendingSignIn(a,e),"identity-manager:user-aborted"===e.name?t.getServerKeyFromUrl(a)?y.ServiceManager.getInstance().fetchArcGISServerInfo(a).then((e=>{t.addToNoPermissionResourceInfoList(a,"",y.SignInErrorCode.SignInCanceled,!1,null==e?void 0:e.owningSystemUrl)})):t.addToNoPermissionResourceInfoList(a,"",y.SignInErrorCode.SignInCanceled,!1):"identity-manager:not-authenticated"===e.name&&t.handleInvalidToken(a),Promise.reject(e))))}catch(e){return console.warn('replaced "getCredential" method error',e),i.call(ut,a,s)}}}initToRegisterOAuthForMainPortalAndAGOL(){return Ye(this,void 0,void 0,(function*(){const e=y.SessionManager.getInstance(),{portalUrl:t,isWebTier:i}=(0,y.getAppStore)().getState();i||this.registerOAuthInfo(t),this.registerOAuthInfo("https://devext.arcgis.com"),this.registerOAuthInfo("https://qaext.arcgis.com"),this.registerOAuthInfo("https://www.arcgis.com"),this.syncToArcgisJSAPI(e.getSessions()),e.addSessionChangeListener(this.onSessionChangedCallback.bind(this)),this.listeningJsApiSignIn()}))}registerOAuthInfo(e,t){let i=ut.findOAuthInfo(e);if(t=t||y.SessionManager.getInstance().getClientIdByUrl(e),!i&&t){const r=st(`${window.location.origin}${nt(et("jimu-arcgis"))}/oauth-callback.html`);i=new lt({appId:t,expiration:20159,portalUrl:e,authNamespace:"/",popup:!0,flowType:"auto",popupCallbackUrl:r}),ut.registerOAuthInfos([i])}}getFlowTypeForRegisteringOAuthInfo(e){var t;let i;if(rt(e))return"authorization-code";if(at(e,(0,y.getAppStore)().getState().portalUrl))i=null===(t=(0,y.getAppStore)().getState().portalSelf)||void 0===t?void 0:t.currentVersion;else{const t=y.appConfigUtils.getConnectionInfoFromAppConfig(e);i=null==t?void 0:t.portalVersion}return i&&Number(i)>=8.4?"authorization-code":"auto"}removePortalAndItsServerCredentials(e,t,i){const r=ut.findCredential(e,t),a=[];let s;s="portal"===(null==r?void 0:r.scope)?r.server:i,ut.credentials.forEach((e=>{if("server"===e.scope){const t=ut.serverInfos.find((t=>t.server===e.server));s===(null==t?void 0:t.owningSystemUrl)&&a.push(e)}else s===e.server&&a.push(e)})),a.forEach((e=>(null==e?void 0:e.server)&&e.destroy()))}addCredentialToSessionManger(e){const t=y.SessionManager.getInstance();if("server"===e.scope&&e.server)return y.ServiceManager.getInstance().fetchArcGISServerInfo(e.server).then((i=>Ye(this,void 0,void 0,(function*(){return t.addFromArcGisJSCredential(e,i),e}))));{const i=ut.findOAuthInfo(e.server);return t.addFromArcGisJSCredential(e,null,i),Promise.resolve(e)}}listeningJsApiSignIn(){ut.on("credential-create",(({credential:e})=>{this.addCredentialToSessionManger(e).then((e=>{var t;let i;i="server"===e.scope?(null===(t=e.resources)||void 0===t?void 0:t.length)>0?e.resources[0]:`${e.server}/rest/services`:e.server,y.SessionManager.getInstance().releasePendingSignIn(i)})),e.on("token-change",(()=>{this.addCredentialToSessionManger(e)}))}))}syncToArcgisJSAPI(e){var t;e&&e.forEach((e=>{var t;const i=e.server?`${e.server}/rest/services`:e.portal,r=ut.findCredential(i),a=e.server&&e.portal;(!r||e.username!==r.userId||e.token!==r.token)&&!a&&ut.registerToken({server:i,token:e.token,expires:null===(t=e.tokenExpires)||void 0===t?void 0:t.getTime(),ssl:e.ssl,userId:e.username})}));const i=[],r=y.SessionManager.getInstance();null===(t=ut.credentials)||void 0===t||t.forEach((t=>{const a="server"===t.scope?`${t.server}/rest/services`:t.server,s=r.getSessionKeyFromUrl(a);e.find((e=>{const i=y.SessionManager.getInstance().getSessionKeyFromSession(e);return s===i&&t.userId===e.username}))||i.push(t)})),i.forEach((e=>e.destroy()))}onSessionChangedCallback(e,t){t!==y.SessionChangedReasonType.ArcGISJSSync&&this.syncToArcgisJSAPI(e)}addToTrustedServers(){const{portalUrl:e,isWebTier:t}=(0,y.getAppStore)().getState(),i=y.SessionManager.getInstance().getTrustedServers();t&&ct.request.trustedServers.push(e),i.forEach((e=>{ct.request.trustedServers.includes(e)||ct.request.trustedServers.push(e)}))}onCurrentThemeLoad(e,t){e&&!t&&(this.checkAPITheme(this.getAPIThemeUrl(window.jimuConfig.arcgisJsApiUrl,"dark"===e.theme.sys.color.mode))||(this.removeApiThemeStyle(this.getAPIThemeUrl(window.jimuConfig.arcgisJsApiUrl,"dark"!==e.theme.sys.color.mode)),y.moduleLoader.loadModule(this.getAPIThemeUrl(window.jimuConfig.arcgisJsApiUrl,"dark"===e.theme.sys.color.mode)),"dark"!==e.theme.sys.color.mode||document.body.classList.contains("calcite-mode-dark")?document.body.classList.remove("calcite-mode-dark"):document.body.classList.add("calcite-mode-dark"),Xe.getInstance().getAllJimuMapViewIds().forEach((t=>{var i,r;const a=null===(i=Xe.getInstance().getJimuMapViewById(t).view)||void 0===i?void 0:i.ui.container;a&&("dark"!==(null===(r=e.theme)||void 0===r?void 0:r.sys.color.mode)||a.classList.contains("calcite-mode-dark")?(a.classList.remove("calcite-mode-dark"),a.classList.add("calcite-theme-light")):(a.classList.remove("calcite-theme-light"),a.classList.add("calcite-mode-dark")))}))))}removeApiThemeStyle(e){var t;y.moduleLoader.deleteModule(e),null===(t=document.querySelector(`link[href="${e}"]`))||void 0===t||t.remove()}getAPIThemeUrl(e,t){return t?`${e}esri/themes/dark/main.css`:`${e}esri/css/main.css`}checkAPITheme(e){return!!document.querySelector(`link[href="${e}"]`)}checkApiUrl(e){return"development"===window.env||(!/^\/\//.test(e)&&!/^https?:\/\//.test(e)||/(?:[\w\-\_]+\.)+(?:esri|arcgis)\.com/.test(e))}}class pt{constructor(){this.id="arcgis-ds-factory"}getFactoryUri(e){if(Object.keys(d).map((e=>d[e])).includes(e))return"jimu-arcgis/arcgis-data-source"}}function gt(e,t){return/rest\/services\/(.+)\/(MapServer|FeatureServer|ImageServer)\/(\d+)\/?$/.test(e)}function mt(e,t){return/sharing\/rest\/community\/self\/?$/.test(e)}function ft(e,t){const i="sharing/rest/content/items/",r=e.indexOf(i);if(r>-1){const t=e.substring(r+27).split("/");if(t.length>0&&(1===t.length||"data"===t[t.length-1]))return!0}return!1}class vt extends y.React.PureComponent{constructor(){super(...arguments),this.viewManager=Xe.getInstance(),this.onViewsCreate=e=>{this.props.onViewsCreate&&this.props.onViewsCreate(e)},this.onViewGroupCreate=()=>{if(this.props.onViewGroupCreate&&this.viewManager&&this.props.useMapWidgetId){const e=this.viewManager.getJimuMapViewGroup(this.props.useMapWidgetId);this.props.onViewGroupCreate(e)}},this.onViewsChange=e=>{if(this.props.onViewsChange){const t=this.getViews(e);this.props.onViewsChange(t)}},this.onActiveViewChange=e=>{if(!this.props.onActiveViewChange)return;let t=null;if(this.viewManager){const e=this.getActiveViewId(this.props.useMapWidgetId,this.props.viewInfos);e&&(t=this.viewManager.getJimuMapViewById(e))}this.props.onActiveViewChange(t,e)},this.getActiveViewId=(e,t)=>{let i="";return e&&t&&(i=t&&Object.keys(t).find((i=>t[i].mapWidgetId===e&&t[i].isActive&&t[i].status===y.JimuMapViewStatus.Loaded))),i||(i=""),i},this.getWhetherAllViewsCreated=(e,t,i)=>!((null==e?void 0:e.length)<(null==i?void 0:i.length))&&((null==e?void 0:e.length)>0&&!e.some((e=>!this.getWhetherViewCreated(e,t)))),this.getWhetherViewCreated=(e,t)=>!!(e&&t&&t[e]&&t[e].status&&t[e].status===y.JimuMapViewStatus.Loaded),this.getViewIdsFromMapWidgetId=(e,t)=>t?Object.keys(t).filter((i=>t[i].mapWidgetId===e)):[],this.getCreatedViewIdsFromMapWidgetId=(e,t)=>this.getViewIdsFromMapWidgetId(e,t).filter((e=>this.getWhetherViewCreated(e,t))),this.getViews=e=>{if(!e)return null;const t={};return this.viewManager&&e.forEach((e=>{t[e]=this.viewManager.getJimuMapViewById(e)})),t}}componentDidMount(){this.checkPropCallbacksForCurrentMapWidgetId([],"")}componentDidUpdate(e){const t=e.useMapWidgetId||"",i=this.props.useMapWidgetId||"",r=this.getViewIdsFromMapWidgetId(e.useMapWidgetId,e.viewInfos),a=this.getCreatedViewIdsFromMapWidgetId(e.useMapWidgetId,e.viewInfos),s=this.getActiveViewId(e.useMapWidgetId,e.viewInfos);if(i===t){const t=this.getViewIdsFromMapWidgetId(this.props.useMapWidgetId,this.props.viewInfos);if(0===r.length&&t.length>0&&this.onViewGroupCreate(),!this.getWhetherAllViewsCreated(r,e.viewInfos,e.useDataSources)&&this.getWhetherAllViewsCreated(t,this.props.viewInfos,this.props.useDataSources)){const e=this.getViews(t);this.onViewsCreate(e)}const i=this.getCreatedViewIdsFromMapWidgetId(this.props.useMapWidgetId,this.props.viewInfos),{isEqual:n}=y.utils.diffArrays(!0,a,i);n||this.onViewsChange(t);s!==this.getActiveViewId(this.props.useMapWidgetId,this.props.viewInfos)&&this.onActiveViewChange(s)}else this.checkPropCallbacksForCurrentMapWidgetId(a,s)}checkPropCallbacksForCurrentMapWidgetId(e,t){const{useMapWidgetId:i,viewInfos:r,useDataSources:a}=this.props,s=this.getViewIdsFromMapWidgetId(i,r);if(s.length>0&&this.onViewGroupCreate(),this.getWhetherAllViewsCreated(s,r,a)){const e=this.getViews(s);this.onViewsCreate(e)}const n=this.getCreatedViewIdsFromMapWidgetId(i,r),{isEqual:o}=y.utils.diffArrays(!0,e,n);o||this.onViewsChange(s);t!==this.getActiveViewId(i,r)&&this.onActiveViewChange(t)}render(){if(!this.props.useMapWidgetId||!this.props.viewInfos||!this.props.children)return null;const e=this.getViewIdsFromMapWidgetId(this.props.useMapWidgetId,this.props.viewInfos),t=this.getViews(e);return"function"==typeof this.props.children?this.props.children(t):this.props.children}}const wt=y.ReactRedux.connect(((e,t)=>{var i,r,a;const s=null!==(i=e.appStateInBuilder)&&void 0!==i?i:e;return{viewInfos:s.jimuMapViewsInfo,useDataSources:null===(a=null===(r=s.appConfig)||void 0===r?void 0:r.widgets[t.useMapWidgetId])||void 0===a?void 0:a.useDataSources}}))(vt);function St(e){const[,t]=y.React.useState(!1);if(y.React.useEffect((()=>{if(this.getJimuLayerView())t(!0);else{Xe.getInstance().getJimuMapViewById(this.props.jimuMapViewId).whenJimuLayerViewLoaded(this.props.jimuLayerViewId).then((()=>{t(!0)}))}}),[]),!e.jimuLayerViewId||!e.children)return null;const i=(()=>{const t=Xe.getInstance().getJimuMapViewById(e.jimuMapViewId);return null==t?void 0:t.jimuLayerViews[e.jimuLayerViewId]})();return i?"function"==typeof e.children?e.children(i):e.children:null}var Lt=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function n(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};function It(){return Lt(this,void 0,void 0,(function*(){return Xe.getInstance(),yield Promise.resolve(null)}))}return n})())}}}));