System.register(["jimu-core"],(function(e,t){var r={};return{setters:[function(e){r.AppMode=e.AppMode,r.CONSTANTS=e.CONSTANTS,r.DataSourceManager=e.DataSourceManager,r.Immutable=e.Immutable,r.JimuFieldType=e.JimuFieldType,r.ServiceManager=e.ServiceManager,r.TimezoneConfig=e.TimezoneConfig,r.UrlManager=e.UrlManager,r.appActions=e.appActions,r.dataSourceUtils=e.dataSourceUtils,r.esri=e.esri,r.getAppStore=e.getAppStore,r.i18n=e.i18n,r.jimuHistory=e.jimuHistory,r.loadArcGISJSAPIModule=e.loadArcGISJSAPIModule,r.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules,r.lodash=e.lodash,r.moduleLoader=e.moduleLoader,r.observeStore=e.observeStore,r.portalUrlUtils=e.portalUrlUtils,r.proxyUtils=e.proxyUtils,r.requestUtils=e.requestUtils,r.semver=e.semver,r.urlUtils=e.urlUtils,r.utils=e.utils,r.uuidv1=e.uuidv1}],execute:function(){e((()=>{"use strict";var e={9244:e=>{e.exports=r}},t={};function i(r){var a=t[r];if(void 0!==a)return a.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,i),s.exports}i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};i.r(a),i.d(a,{AbstractDataRecord:()=>m,AbstractDataSource:()=>A,AbstractLayerFolderDataSource:()=>re,AbstractLoadableDataSource:()=>ae,AbstractQueriableDataSource:()=>he,AllDataSourceTypes:()=>u,ArcGISDataSourceTypes:()=>n,CSVDataSourceImpl:()=>fe,DataSourceError:()=>p,DataSourceSelectionMode:()=>v,DataSourceStatus:()=>s,DataSourceTypes:()=>o,FeatureDataRecordImpl:()=>ve,FeatureLayerDataSourceImpl:()=>Pe,FeatureServiceDataSourceImpl:()=>Fe,GroupLayerDataSourceImpl:()=>Re,ItemMixinImpl:()=>C,JSAPILayerMixinImpl:()=>_,JimuCoreDataSourceFactory:()=>St,MapServiceDataSourceImpl:()=>we,QueryScope:()=>g,SceneLayerDataSourceImpl:()=>Qe,SceneServiceDataSourceImpl:()=>Ee,SetDataSourceMixinImpl:()=>ee,SimpleDataRecordImpl:()=>D,SimpleDataRecordSetImpl:()=>I,SimpleLocalDataSourceImpl:()=>Ve,SupportedItemTypes:()=>h,SupportedJSAPILayerTypes:()=>y,SupportedLayerServiceTypes:()=>d,SupportedLayerTypesInWebMapSpec:()=>S,SupportedServerTypes:()=>c,dataSourceJsonCreator:()=>l,default:()=>gt});var s,o,n,l={};i.r(l),i.d(l,{createDataSourceJson:()=>W,createDataSourceJsonByItemData:()=>Y,createDataSourceJsonByItemInfo:()=>$,createDataSourceJsonByJSAPILayer:()=>k,createDataSourceJsonByLayerDefinition:()=>H,getDataSourceTypeFromArcGISWholeServiceUrl:()=>K}),function(e){e.NotCreated="NOT_CREATED",e.Created="CREATED",e.CreateError="CREATE_ERROR",e.NotReady="NOT_READY",e.Unloaded="UNLOADED",e.Loading="LOADING",e.Loaded="LOADED",e.LoadError="LOAD_ERROR",e.Saving="SAVING",e.Saved="SAVED",e.SaveError="SAVE_ERROR",e.Closed="CLOSED",e.Connecting="CONNECTING",e.Connected="CONNECTED",e.Closing="CLOSING"}(s||(s={})),function(e){e.Error="ERROR",e.SimpleLocal="SIMPLE_LOCAL",e.CSV="CSV",e.FeatureLayer="FEATURE_LAYER",e.SceneLayer="SCENE_LAYER",e.SubtypeGroupLayer="SUBTYPE_GROUP_LAYER",e.SubtypeSublayer="SUBTYPE_SUBLAYER",e.GroupLayer="GROUP_LAYER",e.FeatureService="FEATURE_SERVICE",e.MapService="MAP_SERVICE",e.SceneService="SCENE_SERVICE",e.VectorTileService="VECTOR_TILE_SERVICE",e.GeoJSON="GEO_JSON",e.KML="KML",e.WFS="WFS",e.WMS="WMS",e.WMTS="WMTS",e.BuildingSceneLayer="building-scene",e.BuildingGroupSubLayer="building-group",e.BuildingComponentSubLayer="building-component",e.OrientedImageryLayer="ORIENTED_IMAGERY_LAYER",e.ImageryLayer="IMAGERY_LAYER",e.ImageryTileLayer="IMAGERY_TILE_LAYER",e.ElevationLayer="ELEVATION_LAYER"}(o||(o={})),function(e){e.Map="MAP",e.WebMap="WEB_MAP",e.WebScene="WEB_SCENE"}(n||(n={}));const u=Object.assign(Object.assign({},o),n);var d,c,h,y,S,g,v;!function(e){e.FeatureLayer="Feature Layer",e.Table="Table",e.GroupLayer="Group Layer",e.OrientedImageryLayer="Oriented Imagery Layer",e.SceneLayerPoint="Point",e.SceneLayer3DObject="3DObject",e.BuildingSceneLayer="Building",e.BuildingGroupSubLayer="building-group",e.BuildingComponentSubLayer="building-component"}(d||(d={})),function(e){e.FeatureService="FeatureServer",e.MapService="MapServer",e.SceneService="SceneServer",e.ImageService="ImageServer",e.VectorTileService="VectorTileServer"}(c||(c={})),function(e){e.WebMap="Web Map",e.WebScene="Web Scene",e.FeatureService="Feature Service",e.MapService="Map Service",e.SceneService="Scene Service",e.ImageService="Image Service",e.VectorTileService="Vector Tile Service",e.FeatureCollection="Feature Collection",e.GroupLayer="Group Layer",e.CSV="CSV",e.GeoJSON="GeoJson",e.KML="KML",e.WFS="WFS",e.WMS="WMS",e.WMTS="WMTS",e.GeometryService="Geometry Service",e.GeocodingService="Geocoding Service",e.GeoprocessingService="Geoprocessing Service",e.NetworkAnalysisService="Network Analysis Service",e.GeoenrichmentService="Geoenrichment service"}(h||(h={})),function(e){e.FeatureLayer="feature",e.MapImageLayer="map-image",e.TileLayer="tile",e.GroupLayer="group",e.SceneLayer="scene",e.ImageryLayer="imagery",e.ImageryTileLayer="imagery-tile",e.ElevationLayer="elevation",e.OrientedImageryLayer="oriented-imagery",e.SubtypeGroupLayer="subtype-group",e.SubtypeSublayer="subtype-sublayer",e.VectorTileLayer="vector-tile",e.KMLLayer="kml",e.CSVLayer="csv",e.GeoJSONLayer="geojson",e.WFSLayer="wfs",e.WMSLayer="wms",e.WMTSLayer="wmts",e.BuildingSceneLayer="building-scene",e.BuildingComponentSubLayer="building-component",e.BuildingGroupSubLayer="building-group"}(y||(y={})),function(e){e.FeatureLayer="ArcGISFeatureLayer",e.SceneLayer="ArcGISSceneServiceLayer",e.GroupLayer="GroupLayer",e.MapService="ArcGISMapServiceLayer",e.TiledMapService="ArcGISTiledMapServiceLayer",e.VectorTileService="VectorTileLayer",e.ImageService="ArcGISImageServiceLayer",e.TiledImageService="ArcGISTiledImageServiceLayer",e.CSV="CSV",e.GeoJSON="GeoJSON",e.KML="KML",e.WFS="WFS",e.WMS="WMS",e.SubtypeGroupLayer="SubtypeGroupLayer"}(S||(S={}));class p extends Error{constructor(e,t){super(`data source id: ${e}, ${t}`),this.dataSourceId=e}}!function(e){e.InAllData="IN_ALL_DATA",e.InRemoteConfigView="IN_REMOTE_CONFIG_VIEW",e.InConfigView="IN_CONFIG_VIEW",e.InRuntimeView="IN_RUNTIME_VIEW"}(g||(g={})),function(e){e.New="New",e.AddToCurrent="AddToCurrent",e.RemoveFromCurrent="RemoveFromCurrent",e.SelectFromCurrent="SelectFromCurrent"}(v||(v={}));var f=i(9244);class m{clone(e){const t=f.lodash.clone(this);return e?(t.setData(f.lodash.cloneDeep(this.getData())),t):t}getFieldValue(e){return this.getData()[e]}getDateFieldValue(e){return this.getFieldValue(e)}getFormattedFieldValue(e,t){const r=this.dataSource.getSchema().fields[e];if(!r)return this.getFieldValue(e);if(r.format)switch(r.type){case f.JimuFieldType.Date:return this.formatDateField(this.getDateFieldValue(e),r.format.dateFormat,t);case f.JimuFieldType.Number:return this.formatNumberField(this.getFieldValue(e),r.format.places,r.format.digitSeparator,t);default:return this.getFieldValue(e)}else switch(r.type){case f.JimuFieldType.Date:return null!==this.getFieldValue(e)&&void 0!==this.getFieldValue(e)?this.formatDateField(this.getDateFieldValue(e),null,t):null;case f.JimuFieldType.Number:return null!==this.getFieldValue(e)&&void 0!==this.getFieldValue(e)?t.formatNumber(this.getFieldValue(e)):null;default:return this.getFieldValue(e)}}convertBeforeMappingDataToData(e){const t={},r=this.dataSource.getReversedConfigSchema();return Object.keys(e).forEach((i=>{const a=r&&r.fields&&r.fields[i];a?a.forEach((r=>{t[r.jimuName]=e[i]})):t[i]=e[i]})),t}convertDataToDataBeforeMapping(e){const t={},r=this.dataSource.getSchema();return Object.keys(e).forEach((i=>{const a=r&&r.fields&&r.fields[i]?r.fields[i].name:i;t[a]=e[i]})),t}getFormattedData(e){const t={};return Object.keys(this.getData()).forEach((r=>{t[r]=this.getFormattedFieldValue(r,e)})),t}formatDateField(e,t,r){return t?f.dataSourceUtils.formatDateField(e,t,r):r.formatDate(e,{dateStyle:"short",timeStyle:"short"})}formatNumberField(e,t,r,i){if(null==e)return null;const a=new Number(e);return r?i.formatNumber(e,{maximumFractionDigits:t,minimumFractionDigits:t}):a.toFixed(t)}set dataSource(e){this._dataSource=e}get dataSource(){return this._dataSource}}class D extends m{constructor(e,t,r=!0){super(),this.dataSource=t,this.data=r?this.convertBeforeMappingDataToData(e):e}getData(){return this.data}setData(e){this.data=e}getDataBeforeMapping(){return this.convertDataToDataBeforeMapping(this.data)}toJson(){return this.data}getId(){return this.data.id}setId(){}getGeometry(){return null}getRawGeometry(){return null}setGeometry(e){}}class I{constructor(e){Object.assign(this,e)}}var L=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class A{constructor(e){if(this.records=[],this.dataSourceManager=e.dataSourceManager,Object.assign(this,e),this.originDataSourceJson=e.dataSourceJson,e.dataSourceJson)this.isDataView=!1,this.isLocal=!1,e.dataSourceJson.url&&(this.url=e.dataSourceJson.url);else{if(!e.belongToDataSource)return void console.error("bad DataSourceConstructorOptions.");e.localId?(this.isLocal=!0,this.isDataView=!1):(this.isLocal=!1,this.isDataView=!0)}this.getDataSourceJson().isDataInDataSourceInstance&&(this.sourceRecords=e.sourceRecords,this.url=null),this.isLocal?this.listenSelection=!1:this.listenSelection=!0}ready(){return Promise.resolve()}isDataSourceSet(){return!!this.getChildDataSources}get url(){return this._url}set url(e){this.getDataSourceJson().isDataInDataSourceInstance||(this._url=e)}isInAppConfig(){var e,t;return!!(null===(e=(0,f.getAppStore)().getState().appConfig.dataSources)||void 0===e?void 0:e[(null===(t=this.getRootDataSource())||void 0===t?void 0:t.id)||this.getMainDataSource().id])}getLabel(){if(this.isLocal)return this.belongToDataSource.getLabel();if(this.isDataView){if(this.dataViewId===f.CONSTANTS.OUTPUT_DATA_VIEW_ID&&this.getDataSourceJson().isOutputFromWidget)return f.i18n.getIntl().formatMessage({id:"outputView"},{dataSourceLabel:this.belongToDataSource.getLabel()});const e=this.getMainDataSource().getDataSourceJson(),t=(null==e?void 0:e.dataViews)&&e.dataViews[this.dataViewId];return(null==t?void 0:t.label)||this.belongToDataSource.getLabel()}return this.getDataSourceJson().label||this.getSchema().label||this.getDataSourceJson().sourceLabel}getDataSourceJson(){if(this.isDataView||this.isLocal){let e=this.getMainDataSource().getDataSourceJson();return this.dataViewId===f.CONSTANTS.SELECTION_DATA_VIEW_ID&&(e=e.set("isDataInDataSourceInstance",!0)),e}return this.dataSourceJson}setDataSourceJson(e){e?this.dataSourceJson?this.dataSourceJson=this.traverseToMergeDataSourceJson(this.dataSourceJson,e):this.dataSourceJson=e:this.dataSourceJson=this.originDataSourceJson}traverseToMergeDataSourceJson(e,t){if(!e&&!t)return null;if(!e)return t;if(!t)return e;const r=this.dataSourceManager.getDataSource(e.id);if(!r)return e;let i=e.merge(t.asMutable({deep:!0}));return["label","isHidden","useFields","query","dataViews","childDataSourceJsons","schema","url","itemId","portalUrl"].forEach((a=>{t[a]||(i=i.without(a)),t[a]&&"schema"===a&&(i=i.set("schema",t.schema)),!t[a]||"url"!==a&&"portalUrl"!==a&&"itemId"!==a||(i=i.set(a,t[a]),r[a]=t[a],r.canSaveSourceRecords()&&r.getAllDerivedDataSources().forEach((e=>{e[a]=t[a]}))),e[a]&&"useFields"===a&&(i=t.schema?i.set("useFields",e.useFields.filter((e=>{var r;return!!(null===(r=t.schema.fields)||void 0===r?void 0:r[e])}))):i.set("useFields",e.useFields))})),i.childDataSourceJsons&&Object.keys(i.childDataSourceJsons).forEach((a=>{var s;const o=r.traverseToMergeDataSourceJson(null===(s=null==e?void 0:e.childDataSourceJsons)||void 0===s?void 0:s[a],t.childDataSourceJsons[a]);o&&(i=i.setIn(["childDataSourceJsons",a],o))})),i}getSchema(){return this.isDataView||this.isLocal?this.getMainDataSource().getSchema():this.schema||{}}getSelectedFields(){var e,t,r,i;let a;if(this.isLocal)return this.belongToDataSource.getSelectedFields();if(this.isSelectionView()||this.dataViewId===f.CONSTANTS.OUTPUT_DATA_VIEW_ID)return this.getMainDataSource().getSelectedFields();const s=(null===(e=this.getSchema())||void 0===e?void 0:e.fields)?Object.keys(this.getSchema().fields):[];if(a=this.isDataView?null===(r=null===(t=this.getDataSourceJson().dataViews)||void 0===t?void 0:t[this.dataViewId])||void 0===r?void 0:r.outFields:null===(i=this.getDataSourceJson().query)||void 0===i?void 0:i.outFields,!a&&!this.selectedFields)return s;let o=s;return a&&(o=o.filter((e=>a.includes(e)))),this.selectedFields&&(o=o.filter((e=>this.selectedFields.includes(e)))),o}getAllUsedFields(e){let t;return t="*"===this.getLoadOnDemandUsedFields()?this.getLoadOnDemandUsedFields(e):this.mergeUsedFields(this.getLoadOnDemandUsedFields(e),this.getConfigUsedFields(e)),"debug"===(null==e?void 0:e.logLevel)&&"*"===t&&console.warn("All used fields are * since used fields length equals schema fields length."),t}_printUsedFieldsDetail(e){this.getAllUsedFields(Object.assign({logLevel:"debug",excludeWidgetsDoNotUseDsToQuery:!0},e))}getLoadOnDemandUsedFields(e){return"debug"===(null==e?void 0:e.logLevel)&&console.log("Load on demand fields are:",this.loadOnDemandFields),this.loadOnDemandFields}getConfigUsedFields(e){var t,r,i;if(this.isLocal)return[];if(this.dataViewId===f.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION)return window.jimuConfig.isInBuilder?"*":null===(t=this.getMainDataSource().getDataView(f.CONSTANTS.SELECTION_DATA_VIEW_ID))||void 0===t?void 0:t.getAllUsedFields();"debug"===(null==e?void 0:e.logLevel)&&console.group("Config used fields");const a=null===(r=(0,f.getAppStore)().getState().appConfig)||void 0===r?void 0:r.widgets,s=null===(i=(0,f.getAppStore)().getState().appConfig)||void 0===i?void 0:i.messageConfigs;let o=[];s&&Object.values(s).forEach((e=>{var t,r;e.actions&&(o=o.concat(null===(r=(t=e.actions).asMutable)||void 0===r?void 0:r.call(t)))}));const n=(a?Object.values(a):[]).concat(o),l=[];n.every((t=>{var r,i;const a=(null==e?void 0:e.excludeWidgetsDoNotUseDsToQuery)&&(null===(i=null===(r=t.manifest)||void 0===r?void 0:r.properties)||void 0===i?void 0:i.notAutoLoadUsedFieldsData);return t.useDataSources&&t.useDataSources.every((r=>{var i,s,o,n,u,d,c,h,y;if((null==r?void 0:r.dataSourceId)!==(null===(i=this.getSelectionDataView())||void 0===i?void 0:i.id)&&a)return!0;const S=(null==r?void 0:r.dataSourceId)===this.id,g=(null==r?void 0:r.dataSourceId)===(null===(s=this.getSelectionDataView())||void 0===s?void 0:s.id),v=this.isSelectionView()&&(null==r?void 0:r.mainDataSourceId)===this.getMainDataSource().id,p=this.getDataSourceJson().isOutputFromWidget&&!this.getDataSourceJson().schema&&1===(null===(o=this.getDataSourceJson().originDataSources)||void 0===o?void 0:o.length)&&(null==r?void 0:r.dataSourceId)===this.getDataSourceJson().originDataSources[0].dataSourceId,f=this.getDataSourceJson().isOutputFromWidget&&!this.isDataView&&(null==r?void 0:r.mainDataSourceId)===this.getMainDataSource().id,m=(null==r?void 0:r.dataSourceId)===(null===(u=null===(n=this.getAssociatedDataSource)||void 0===n?void 0:n.call(this))||void 0===u?void 0:u.id);if(S||g||v||p||f||m){if(r.fields&&l.push(...r.fields),r.useFieldsInPopupInfo){const r=(null===(y=null===(h=null===(c=null===(d=this.getPopupInfo)||void 0===d?void 0:d.call(this))||void 0===c?void 0:c.fieldInfos)||void 0===h?void 0:h.map((e=>!1===e.visible?null:this.findJimuFieldName(e.fieldName))))||void 0===y?void 0:y.filter((e=>!!e)))||[];r.length>0?l.push(...r):("debug"===(null==e?void 0:e.logLevel)&&console.warn("Config used fields are * since widget uses popup info fields, but can not find them.",t.id||t.actionId),l.push("*"))}r.useFieldsInSymbol&&("debug"===(null==e?void 0:e.logLevel)&&console.warn("Config used fields are * since widget uses symbol fields.",t.id||t.actionId),l.push("*"))}return!l.includes("*")})),"debug"===(null==e?void 0:e.logLevel)&&console.log("Accumulated config used fields are:",l,t.id||t.actionId),!l.includes("*")}));let u=l.includes("*")?"*":Array.from(new Set(l));return"*"!==u&&(u=u.filter((e=>{var t,r;return!!(null===(r=null===(t=this.getSchema())||void 0===t?void 0:t.fields)||void 0===r?void 0:r[e])}))),"debug"===(null==e?void 0:e.logLevel)&&(console.log("Final config used fields are:",l),console.groupEnd()),u}updateLoadOnDemandFields(e){e&&(this.loadOnDemandFields=this.mergeUsedFields(this.loadOnDemandFields,this.findMissingFields(e,this.getConfigUsedFields())),"*"!==this.loadOnDemandFields&&(this.loadOnDemandFields=this.loadOnDemandFields.filter((e=>{var t,r;return!!(null===(r=null===(t=this.getSchema())||void 0===t?void 0:t.fields)||void 0===r?void 0:r[e])}))))}mergeUsedFields(e,t){if("*"===e||"*"===t)return"*";if(Array.isArray(e)&&Array.isArray(t)){let r=Array.from(new Set(e.concat(t))).filter((e=>!!e));return r.length===Object.keys(this.getSchema().fields).length&&(r="*"),r}return e||t||[]}missingSomeFields(e,t){return"*"!==t&&this.findMissingFields(e,t).length>0}findMissingFields(e,t){const r=this.getSelectedFields(),i="*"===e?r:e,a="*"===t?r:t,s=[];return null==i||i.forEach((e=>{(null==a?void 0:a.includes(e))||s.push(e)})),s}findJimuFieldName(e){const t=this.getSchema();let r=null;return(null==t?void 0:t.fields)&&(r=Object.keys(t.fields).find((r=>t.fields[r].name===e))),r}setSelectedFields(e){this.selectedFields=e}setSchema(e){this.schema=e}fetchSchema(){return L(this,void 0,void 0,(function*(){return yield Promise.resolve((0,f.Immutable)({}))}))}getFetchedSchema(){return this.isDataView||this.isLocal?this.getMainDataSource().getFetchedSchema():this.fetchedSchema}setFetchedSchema(e){this.fetchedSchema=e}getGeometryType(){return null}getReversedConfigSchema(){if(this.isDataView||this.isLocal)return this.getMainDataSource().getReversedConfigSchema();if(this.reverseSchema)return this.reverseSchema;if(this.isDataSourceSet()){const e=this.getDataSourceJson().schema,t={childSchemas:{}};if(!e)return(0,f.Immutable)({});if(!e.childSchemas)return(0,f.Immutable)({label:e.label,childId:e.childId,jimuChildId:e.jimuChildId});Object.keys(e.childSchemas).forEach((r=>{const i=e.childSchemas[r].childId;t.childSchemas[i]?t.childSchemas[i].push(this.getOneReversedConfigSchema(e.childSchemas[r])):t.childSchemas[i]=[this.getOneReversedConfigSchema(e.childSchemas[r])]})),this.reverseSchema=(0,f.Immutable)(t)}else this.reverseSchema=this.getOneReversedConfigSchema(this.getDataSourceJson().schema);return this.reverseSchema}setRecords(e){this.records=e,this.addVersion()}getOneReversedConfigSchema(e){const t={};return e?(t.fields={},Object.keys(e.fields).forEach((r=>{const i=e.fields[r].asMutable({deep:!0});t.fields[i.name]?t.fields[i.name].push(i):t.fields[i.name]=[i]})),e.childId&&(t.childId=e.childId),e.jimuChildId&&(t.jimuChildId=e.jimuChildId),(0,f.Immutable)(t)):(0,f.Immutable)(t)}getStatus(){return(0,f.getAppStore)().getState().dataSourcesInfo[this.id]&&(0,f.getAppStore)().getState().dataSourcesInfo[this.id].status}setStatus(e){(0,f.getAppStore)().dispatch(f.appActions.dataSourceStatusChanged(this.id,e))}getCountStatus(){return(0,f.getAppStore)().getState().dataSourcesInfo[this.id]&&(0,f.getAppStore)().getState().dataSourcesInfo[this.id].countStatus}setCountStatus(e){(0,f.getAppStore)().dispatch(f.appActions.dataSourceCountStatusChanged(this.id,e))}getVersion(){var e;return null===(e=(0,f.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.version}addVersion(){(0,f.getAppStore)().dispatch(f.appActions.dataSourceVersionAdded(this.id))}getSourceVersion(){var e;return this.canSaveSourceRecords()?null===(e=(0,f.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.sourceVersion:this.getMainDataSource().getSourceVersion()}addSourceVersion(){this.canSaveSourceRecords()&&(0,f.getAppStore)().dispatch(f.appActions.dataSourceSourceVersionAdded(this.id))}getSelectedRecordIdsFromInfo(){var e,t;return(null===(t=null===(e=(0,f.getAppStore)().getState().dataSourcesInfo)||void 0===e?void 0:e[this.id])||void 0===t?void 0:t.selectedIds)||(0,f.Immutable)([])}getSelectOptionsFromInfo(){var e,t;return null===(t=null===(e=(0,f.getAppStore)().getState().dataSourcesInfo)||void 0===e?void 0:e[this.id])||void 0===t?void 0:t.selectOptions}updateSelectionInfo(e,t){e&&(this.getListenSelection()||this.id===(null==t?void 0:t.id))&&(0,f.getAppStore)().dispatch(f.appActions.dataSourceSelectionChanged(this.id,e))}buildRecord(e){return new D(e,this)}getRecords(){return this.records}getRecordsWithSelection(){return this.concatRecordsAndSelection(this.getSelectedRecords(),this.getRecords())}concatRecordsAndSelection(e,t){var r;const i=t||[];return null===(r=null==e?void 0:e.reverse())||void 0===r||r.forEach((e=>{(null==t?void 0:t.some((t=>(null==t?void 0:t.getId())===(null==e?void 0:e.getId()))))||i.unshift(e)})),i}clearSourceRecordsNotAddVersion(){this.clearRecordsNotAddVersion(),this.sourceRecords=[]}clearSourceRecords(){this.clearSourceRecordsNotAddVersion(),this.addSourceVersion(),this.addVersion()}setSourceRecords(e){if(this.canSaveSourceRecords()){this.clearRecordsNotAddVersion();const t=!this.isSelectionView();t&&f.lodash.defer((()=>{this.updateSelectionInfo({widgetId:null,ids:[]},this.getMainDataSource())})),this.sourceRecords=e.filter((e=>!!e)).map((e=>(e.dataSource=this,e))),this.getAllDerivedDataSources().forEach((e=>{e.clearRecords(),t&&f.lodash.defer((()=>{e.updateSelectionInfo({widgetId:null,ids:[]},e.getMainDataSource())}))})),this.addSourceVersion(),this.addVersion()}}getSourceRecords(){var e;if(!this.canSaveSourceRecords())return this.isLocalViewOfSelectionView()?this.belongToDataSource.getSourceRecords():this.getMainDataSource().getSourceRecords();let t=this.sourceRecords||[];if(this.useNoSelectionView(this)){const r=this.getMainDataSource().getDataView(f.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION);r&&(t=null===(e=r.getRecords())||void 0===e?void 0:e.map((e=>(e.dataSource=this,e))))}return t}useNoSelectionView(e=this){if(!(this.getMainDataSource().id===e.getMainDataSource().id&&this.isDataView&&this.dataViewId===f.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION?this:e.getMainDataSource().getDataView(f.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION)))return!1;const t=e.sourceRecords||[];return e.isDataView&&e.dataViewId===f.CONSTANTS.SELECTION_DATA_VIEW_ID&&0===t.length&&0===e.getMainDataSource().getSelectedRecordIds().filter((e=>!!e)).length}canSaveSourceRecords(){return!this.isDataView&&!this.isLocal||this.isSelectionView()}getSelectionDataView(){const e=this.isDataView||this.isLocal?this.getMainDataSource().id:this.id;return this.dataSourceManager.getDataViewDataSource(e,f.CONSTANTS.SELECTION_DATA_VIEW_ID)}getSelectedRecords(){const e=this.getSelectionDataView(),t=e?e.getRecords():[],r=this.getSelectedRecordIds();return t.filter((e=>r.includes(e.getId())))}getSelectedRecordIndexes(){if(!(0,f.getAppStore)().getState().dataSourcesInfo[this.id])return[];const e=this.isDataView||this.isLocal?this.getMainDataSource().id:this.id;return(0,f.getAppStore)().getState().dataSourcesInfo[e].selectedIds?(0,f.getAppStore)().getState().dataSourcesInfo[e].selectedIds.asMutable().map((e=>this.getRecords().findIndex((t=>t.getId()===e)))):[]}getSelectedRecordIds(){return this.isSelectionView()?this.getMainDataSource().getSelectedRecordIdsFromInfo().asMutable():this.getSelectedRecordIdsFromInfo().asMutable()}nextRecord(){if(this.getSelectedRecordIndexes().length>1)return console.warn('method "nextRecord" only works when single record is selected'),null;if(this.getSelectedRecordIndexes().indexOf(this.getRecords().length-1))throw Error("Reach the end of data.");return(0,f.getAppStore)().dispatch(f.appActions.dataSourceSelectedIndexesChanged(this.id,[this.getSelectedRecordIndexes()[0]++])),this.getSelectedRecords()[0]}prevRecord(){if(this.getSelectedRecordIndexes().length>1)return console.warn('method "prevRecord" only works when single record is selected'),null;if(this.getSelectedRecordIndexes().indexOf(0))throw Error("Reach the start of data.");return(0,f.getAppStore)().dispatch(f.appActions.dataSourceSelectedIndexesChanged(this.id,[this.getSelectedRecordIndexes()[0]--])),this.getSelectedRecords()[0]}getRecord(e){return this.getRecords()[e]}getSourceRecord(e){return this.getSourceRecords()[e]}getRecordById(e){return this.getRecords().filter((t=>t&&t.getId()===e))[0]}getSourceRecordById(e){return this.getSourceRecords().filter((t=>t&&t.getId()===e))[0]}clearSelection(){this.copySelectionToDataView([]),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:[]})}updateSelectionInfoOfDerivedDssAndChangeUrl(e,t,r){const i=this.getMainDataSource();t=t||i,this.updateSelectionInfoOfDerivedDss(e,t,r),t.id===i.id&&this.changeSelectionInUrl(e)}updateSelectionInfoOfDerivedDss(e,t,r){const i=this.getMainDataSource();null==t||t.getAllDerivedDataSources().forEach((t=>{t.id!==this.dataSourceManager.getDataViewDataSourceId(i.id,f.CONSTANTS.SELECTION_DATA_VIEW_ID)&&t.id!==this.dataSourceManager.getDataViewDataSourceId(i.id,f.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION)&&t.updateSelectionInfo(e,this,r)})),null==t||t.updateSelectionInfo(e,this,r)}changeSelectionInUrl(e){const t=this.getMainDataSource();f.UrlManager.getInstance().changeHashObjectByDataSourceSelection(t.id,e)}selectRecord(e){const t=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecord(e):this.getRecord(e);t&&(this.copySelectionToDataView([t]),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:[t.getId()]}))}selectRecords(e){let t=[];if(null==e?void 0:e.records)t=e.records;else if(null==e?void 0:e.ids){const r=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords();t=e.ids.map((e=>r.find((t=>(null==t?void 0:t.getId())===e))))}return this.copySelectionToDataView(t),this.updateSelectionInfoOfDerivedDssAndChangeUrl(e),Promise.resolve({records:t})}selectRecordById(e,t){if(this.getSelectedRecordIds().find((t=>t===e)))return;let r;r=this.getDataSourceJson().isDataInDataSourceInstance?t||e&&this.getSourceRecordById(e):t||e&&this.getRecordById(e),r?(this.copySelectionToDataView([r]),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:[e]})):(this.copySelectionToDataView([]),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:[]}))}selectRecordsByIds(e,t){const r=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),i=t||e.map((e=>r.find((t=>(null==t?void 0:t.getId())===e))));this.copySelectionToDataView(i),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:e})}copySelectionToDataView(e){const t=this.getSelectionDataView();if(!t)return;const r=e.filter((e=>!!e)).map((e=>e.clone()));t.setSourceRecords(r),t.setRecords(r)}getInfo(){return(0,f.getAppStore)().getState().dataSourcesInfo[this.id]||(0,f.Immutable)({})}clearRecords(){this.clearRecordsNotAddVersion(),this.addVersion()}clearRecordsNotAddVersion(){!this.isSelectionView()&&this.getSelectedRecords().length>0&&this.copySelectionToDataView([]),this.records=[]}getIdField(){return this.getSchema()&&this.getSchema().idField||"id"}getRootDataSource(){if(this.isDataView||this.isLocal)return this.getMainDataSource().getRootDataSource();let e=this.parentDataSource;for(;e&&e.parentDataSource;)e=e.parentDataSource;return e}getOriginDataSources(){return this.isDataView||this.isLocal?this.getMainDataSource().getOriginDataSources():this.getDataSourceJson().originDataSources&&0!==this.getDataSourceJson().originDataSources.length?this.getDataSourceJson().originDataSources.asMutable().map((e=>this.dataSourceManager.getDataSource(e.dataSourceId))):[]}getMainDataSource(){var e;return this.belongToDataSource?null!==(e=this.belongToDataSource.belongToDataSource)&&void 0!==e?e:this.belongToDataSource:this}getDataViews(){return this.getMainDataSource()!==this?[]:this.dataSourceManager.getDataSourcesAsArray().filter((e=>e.belongToDataSource===this&&e.isDataView))}getDataView(e){return this.getDataViews().find((t=>t.dataViewId===e))}getDataViewConfig(){return this.isLocal?this.belongToDataSource.getDataViewConfig():this.isDataView?this.getDataSourceJson().dataViews&&this.getDataSourceJson().dataViews[this.dataViewId]:this.getDataSourceJson().query}getLocalDataSources(){return this.isLocal?[]:this.dataSourceManager.getDataSourcesAsArray().filter((e=>e.belongToDataSource===this&&e.isLocal))}getLocalDataSource(e){return this.getLocalDataSources().find((t=>t.localId===e))}getAllDerivedDataSources(){let e=[];const t=this.getDataViews(),r=this.getLocalDataSources();return e=t.concat(r),t.forEach((t=>{e=e.concat(t.getLocalDataSources())})),e}getSaveStatus(){var e;return null===(e=(0,f.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.saveStatus}setSaveStatus(e){(0,f.getAppStore)().dispatch(f.appActions.dataSourceSaveStatusChanged(this.id,e))}setListenSelection(e){this.listenSelection=e}getListenSelection(){return this.listenSelection}isSelectionView(){return this.isDataView&&this.dataViewId===f.CONSTANTS.SELECTION_DATA_VIEW_ID}isLocalViewOfSelectionView(){return this.isLocal&&this.dataViewId===f.CONSTANTS.SELECTION_DATA_VIEW_ID}addRecord(e){return L(this,void 0,void 0,(function*(){return e?(this.setSaveStatus(s.Saving),yield this.doAddRecord(e).then((e=>(this.setSaveStatus(s.Saved),e)),(e=>L(this,void 0,void 0,(function*(){return this.setSaveStatus(s.SaveError),yield Promise.reject(e)}))))):yield Promise.reject("No record passed in.")}))}doAddRecord(e){return L(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doAddRecordToSourceRecords(e):yield Promise.reject("Editing source is not ready yet.")}))}updateRecord(e){return L(this,void 0,void 0,(function*(){return yield this.updateRecords([e])}))}updateRecords(e){return L(this,void 0,void 0,(function*(){return e&&0!==e.length?(this.setSaveStatus(s.Saving),yield this.doUpdateRecords(e).then((e=>(this.setSaveStatus(s.Saved),e)),(e=>L(this,void 0,void 0,(function*(){return this.setSaveStatus(s.SaveError),yield Promise.reject(e)}))))):yield Promise.reject("No records passed in.")}))}doUpdateRecords(e){return L(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doUpdateRecordsInSourceRecords(e):yield Promise.reject("Editing source is not ready yet.")}))}deleteRecord(e){return L(this,void 0,void 0,(function*(){const t=this.getRecords()[e];return yield this.deleteOneRecord(t)}))}deleteRecordById(e){return L(this,void 0,void 0,(function*(){const t=this.getRecordById(e);return yield this.deleteOneRecord(t)}))}deleteOneRecord(e){return L(this,void 0,void 0,(function*(){return e?(this.setSaveStatus(s.Saving),yield this.doDeleteOneRecord(e).then((e=>(this.setSaveStatus(s.Saved),e)),(e=>L(this,void 0,void 0,(function*(){return this.setSaveStatus(s.SaveError),yield Promise.reject(e)}))))):yield Promise.reject("No record passed in.")}))}doDeleteOneRecord(e){return L(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doDeleteOneRecordFromSourceRecords(e):yield Promise.reject("Editing source is not ready yet.")}))}doDeleteOneRecordFromSourceRecords(e){return L(this,void 0,void 0,(function*(){return this.sourceRecords=this.sourceRecords.filter((t=>t.getId()!==e.getId())),Promise.resolve(!0)}))}doAddRecordToSourceRecords(e){return L(this,void 0,void 0,(function*(){return this.sourceRecords=this.sourceRecords.concat(e),yield Promise.resolve(e)}))}doUpdateRecordsInSourceRecords(e){return L(this,void 0,void 0,(function*(){return e.forEach((e=>{const t=this.sourceRecords.findIndex((t=>t.getId()===e.getId()));t>-1&&(this.sourceRecords[t]=e)})),Promise.resolve(!0)}))}afterUpdateRecords(e){if(!e||0===e.filter((e=>!!e)).length)return;const t=[];e.forEach((e=>{[this.getMainDataSource()].concat(this.getMainDataSource().getAllDerivedDataSources()).forEach((r=>{this.updateOneLoadedRecord(r,e)&&(t.some((e=>e.id===r.id))||t.push(r))}))})),t.forEach((e=>{e.addVersion()})),this.getMainDataSource().addSourceVersion()}afterUpdateRecord(e){if(!e)return;const t=[];[this.getMainDataSource()].concat(this.getMainDataSource().getAllDerivedDataSources()).forEach((r=>{this.updateOneLoadedRecord(r,e)&&t.push(r)})),t.forEach((e=>{e.addVersion()})),this.getMainDataSource().addSourceVersion()}updateOneLoadedRecord(e,t){const r=e.getRecordById(t.getId());return!(!r||!t)&&(r.setData(t.getData()),r.setGeometry(t.getRawGeometry()),!0)}afterAddRecord(e){if(!e)return;[this.getMainDataSource()].concat(this.getMainDataSource().getAllDerivedDataSources()).forEach((t=>{t.dataViewId!==f.CONSTANTS.SELECTION_DATA_VIEW_ID&&t.setRecords(t.getRecords().concat(e))})),this.getMainDataSource().addSourceVersion()}afterDeleteRecordsByIds(e){if(!(null==e?void 0:e.length))return;const t=[];e.forEach((e=>{this.deleteOneSelectedRecordById(e);[this.getMainDataSource()].concat(this.getMainDataSource().getAllDerivedDataSources()).filter((e=>e.dataViewId!==f.CONSTANTS.SELECTION_DATA_VIEW_ID)).forEach((r=>{this.deleteOneLoadedRecordById(r,e)&&(t.some((e=>e.id===r.id))||t.push(r))}))})),t.forEach((e=>{e.addVersion()})),this.getMainDataSource().addSourceVersion()}afterDeleteRecordById(e){if(!e)return;const t=[];this.deleteOneSelectedRecordById(e);[this.getMainDataSource()].concat(this.getMainDataSource().getAllDerivedDataSources()).filter((e=>e.dataViewId!==f.CONSTANTS.SELECTION_DATA_VIEW_ID)).forEach((r=>{this.deleteOneLoadedRecordById(r,e)&&t.push(r)})),t.forEach((e=>{e.addVersion()})),this.getMainDataSource().addSourceVersion()}deleteOneSelectedRecordById(e){return!!this.getMainDataSource().getSelectedRecordIds().includes(e)&&(this.getMainDataSource().selectRecordsByIds(this.getMainDataSource().getSelectedRecordIds().filter((t=>t!==e)),this.getMainDataSource().getSelectedRecords().filter((t=>t.getId()!==e))),!0)}deleteOneLoadedRecordById(e,t){const r=e.getRecords().findIndex((e=>(null==e?void 0:e.getId())===t));return"number"==typeof r&&r>-1&&(e.getRecords().splice(r,1),null!=e.count&&e.count--,!0)}destroy(){if(this.parentDataSource){const e=this.type===o.Error?this.dataSourceManager.restoreErrorDataSourceId(this.id):this.id;this.parentDataSource.clearChildDataSourcePromise(e)}}}const b={},P={},C=e=>class extends e{get itemId(){return this._itemId}set itemId(e){this._itemId!==e&&(this._itemId=e,this.clearData())}get portalUrl(){return this._portalUrl}set portalUrl(e){this._portalUrl!==e&&(this._portalUrl=e,this.clearData())}getItemData(){return this.itemData}setItemData(e){this.itemData=e}setItemInfo(e){this.itemInfo=e}getItemInfo(){return this.itemInfo}fetchItemData(){return this.portalUrl&&this.itemId?this.itemData?Promise.resolve(this.itemData):(b[F(this.portalUrl,this.itemId)]||(b[F(this.portalUrl,this.itemId)]=f.requestUtils.requestWrapper(this.portalUrl,(e=>f.esri.restPortal.getItemData(this.itemId,{portal:f.portalUrlUtils.getPortalRestUrl(this.portalUrl),authentication:e})))),b[F(this.portalUrl,this.itemId)].then((e=>{var t,r,i,a,s,o;const n=this.parentDataSource;if(n){const l=null===(a=null===(i=null===(r=(t=n).getItemData)||void 0===r?void 0:r.call(t))||void 0===i?void 0:i.layers)||void 0===a?void 0:a.find((e=>e.id===this.jimuChildId));if(l){const t=this.layerId,r=null===(o=null===(s=null==e?void 0:e.layers)||void 0===s?void 0:s.findIndex)||void 0===o?void 0:o.call(s,(e=>`${e.id}`===t));r>-1?e.layers[r]=Object.assign(Object.assign(Object.assign({},e.layers[r]),l),{id:parseInt(t)}):e=Object.assign(Object.assign({},e),{layers:((null==e?void 0:e.layers)||[]).concat(Object.assign(Object.assign({},l),{id:parseInt(t)}))})}}return this.itemData=e,this.itemData}))):Promise.resolve(null)}fetchItemInfo(){return this.portalUrl&&this.itemId?this.itemInfo?Promise.resolve(this.itemInfo):(P[F(this.portalUrl,this.itemId)]||(P[F(this.portalUrl,this.itemId)]=f.requestUtils.requestWrapper(this.portalUrl,(e=>f.esri.restPortal.getItem(this.itemId,{portal:f.portalUrlUtils.getPortalRestUrl(this.portalUrl),authentication:e})))),P[F(this.portalUrl,this.itemId)].then((e=>(this.itemInfo=e,this.itemInfo)))):Promise.resolve(null)}clearData(){this.itemData=null,this.itemInfo=null}};function F(e,t){return`${e}-${t}`}var R,O,w,T,V,B,E,U;!function(e){e.Small="SMALL",e.Medium="MEDIUM",e.Large="LARGE"}(R||(R={})),function(e){e.String="STRING",e.Number="NUMBER",e.Date="DATE"}(O||(O={})),function(e){e.Blob="esriFieldTypeBlob",e.Date="esriFieldTypeDate",e.Double="esriFieldTypeDouble",e.Geometry="esriFieldTypeGeometry",e.GlobalID="esriFieldTypeGlobalID",e.GUID="esriFieldTypeGUID",e.Integer="esriFieldTypeInteger",e.OID="esriFieldTypeOID",e.Raster="esriFieldTypeRaster",e.Single="esriFieldTypeSingle",e.SmallInteger="esriFieldTypeSmallInteger",e.String="esriFieldTypeString",e.XML="esriFieldTypeXML"}(w||(w={})),function(e){e.Fetching="FETCHING",e.Success="SUCCESS",e.Error="ERROR"}(T||(T={})),function(e){e.Design="DESIGN",e.Run="RUN",e.Express="EXPRESS"}(V||(V={})),function(e){e.Opened="OPENED",e.Active="ACTIVE",e.Closed="CLOSED"}(B||(B={})),function(e){e.None="NONE",e.Page="PAGE",e.Dialog="DIALOG",e.View="VIEW",e.WebAddress="WEB_ADDRESS",e.Block="BLOCK",e.Screen="SCREEN",e.PageTop="PAGE_TOP",e.PrintPreview="PRINT_PREVIEW",e.CookieBanner="COOKIE_BANNER"}(E||(E={})),function(e){e.Normal="NORMAL",e.Layout="LAYOUT"}(U||(U={}));var Q,M;!function(e){e.Header="HEADER",e.Footer="FOOTER",e.Body="BODY"}(Q||(Q={})),function(e){e.Http="http:",e.Https="https:"}(M||(M={}));var J,x,j;!function(e){e.Image="IMAGE",e.Config="CONFIG"}(J||(J={})),function(e){e.Primary="PRIMARY",e.Secondary="SECONDARY",e.Donut="DONUT",e.Bar="BAR",e.DotsPrimary="DOTS_PRIMARY",e.DotsSecondary="DOTS_SECONDARY"}(x||(x={})),function(e){e.EXB_DATA_SOURCE_ID_SET_TO_CREATED_JS_API_LAYER="_exb_data_source_id_set_to_created_js_api_layer",e.EXB_OID="_exb_oid",e.EXB_NOT_EDITABLE="_exb_not_editable",e.EXB_DATA_SOURCE="__exb_data_source",e.EXB_DATA_SET="__exb_data_set"}(j||(j={}));var N=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};const _=e=>class extends e{get jimuLayerId(){return this.layer&&!this._jimuLayerId&&(this._jimuLayerId=f.dataSourceUtils.getJimuLayerIdByJSAPILayer(this.layer)),this._jimuLayerId}createJSAPILayerByDataSource(e){return N(this,arguments,void 0,(function*(e,t=!0,r=!1){var i;const a=e||this;let s;if(a.dataViewId===f.CONSTANTS.SELECTION_DATA_VIEW_ID&&a.useNoSelectionView()){const e=a.getMainDataSource().getDataView(f.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION);if(e){return(yield f.dataSourceUtils.createJSAPIFeatureLayerByRecords(e,e.getRecords())).layer}}if(this.canCacheLayer(a)&&(null===(i=a.layer||a.cachedLayer)||void 0===i?void 0:i.clone))try{s=(a.layer||a.cachedLayer).clone()}catch(e){s=yield this.createNewJSAPILayerByDataSource(a,r)}else s=yield this.createNewJSAPILayerByDataSource(a,r);return s&&t&&this.syncQueryParams(s,a),this.afterCreateJSAPILayer(s,a),s}))}supportSpatialInfo(){const e=f.DataSourceManager.getInstance().getDataSource(this.id);return(null==e?void 0:e.isDataSourceSet())?0===e.getChildDataSources().length||e.getChildDataSources().some((e=>{var t;return null===(t=null==e?void 0:e.supportSpatialInfo)||void 0===t?void 0:t.call(e)})):this.layer||this.cachedLayer?!(this.layer||this.cachedLayer).isTable:this.type===o.SceneLayer||!!(null==e?void 0:e.getGeometryType())}createNewJSAPILayerByDataSource(e,t){return N(this,void 0,void 0,(function*(){var r,i,a,s,n,l;let u;try{if(e.getDataSourceJson().isDataInDataSourceInstance)u=yield f.dataSourceUtils.createJSAPIFeatureLayerByRecords(e,e.getSourceRecords()).then((e=>null==e?void 0:e.layer));else if(e.type!==o.FeatureLayer||e.url||e.itemId||!e.layer){const t=this.getLayerConstructorOptions(e);if(G[this.type]){u=new(yield(0,f.loadArcGISJSAPIModule)(G[this.type]))(t)}else{const i=yield(0,f.loadArcGISJSAPIModule)("esri/layers/Layer");if(e.url){if(u=yield i.fromArcGISServerUrl(t),t.portalItem){const e=yield(0,f.loadArcGISJSAPIModule)("esri/portal/PortalItem");u.portalItem=new e(t.portalItem),u.layers?u.layers=null:u.sublayers&&(u.sublayers=null)}}else if(e.portalUrl&&e.itemId)u=yield i.fromPortalItem(t);else if(e.layerId&&e.parentDataSource){let t=e.parentDataSource;for(;t&&!t.url;)t=t.parentDataSource;u=yield null===(r=t.createJSAPILayerByDataSource)||void 0===r?void 0:r.call(t)}}}else{const t=yield(0,f.loadArcGISJSAPIModule)("esri/layers/FeatureLayer"),r=e;u=new t({source:r.layer.source.clone(),objectIdField:r.layer.objectIdField,geometryType:r.layer.geometryType,sourceJSON:r.layer.sourceJSON,fields:r.layer.fields,customParameters:r.layer.customParameters||{},outFields:["*"]})}}catch(e){if(t)throw e;console.error("Failed to create JS API layer. ",e,this.id)}if(u){const t=null===(i=u.sourceJSON)||void 0===i?void 0:i.capabilities;yield u.loadAll?u.loadAll():null===(s=(a=u).load)||void 0===s?void 0:s.call(a),t&&u.sourceJSON&&(u.sourceJSON.capabilities=t);const r=(null===(n=u.layers)||void 0===n?void 0:n.toArray())||(null===(l=u.allSublayers)||void 0===l?void 0:l.toArray()),o=null==r?void 0:r.filter((e=>Object.values(y).some((t=>t===e.type)))),d=!!(null==o?void 0:o.length),c=e.isDataSourceSet(),h=!e.layerId||`${u.layerId}`===e.layerId;d&&(!c||!h)&&(u=o.find((t=>`${t.layerId}`===e.layerId||`${t.id}`===e.layerId||f.dataSourceUtils.fixLayerId(t.title)===f.dataSourceUtils.fixLayerId(e.getMainDataSource().getDataSourceJson().sourceLabel))))}return u&&!this.cachedLayer&&this.canCacheLayer(e)&&(this.cachedLayer=u),u}))}setJimuChildIdAsLayerId(e,t){var r,i;if(!e||!t)return;try{e.id=t.jimuChildId||t.id}catch(e){}e[j.EXB_DATA_SOURCE_ID_SET_TO_CREATED_JS_API_LAYER]=t.id;const a=[],s=(null===(r=e.layers)||void 0===r?void 0:r.toArray())||(null===(i=e.sublayers)||void 0===i?void 0:i.toArray());if((null==s?void 0:s.length)&&t.isDataSourceSet()){let e;s.forEach((r=>{e=t.getChildDataSources().filter((e=>!a.includes(e.id))).find((e=>f.dataSourceUtils.getWhetherDataSourceHasSameSourceWithJSAPILayer(e,r))),e&&(a.push(e.id),this.setJimuChildIdAsLayerId(r,e))}))}}canCacheLayer(e){return(null==e?void 0:e.id)===this.id&&!e.getDataSourceJson().isDataInDataSourceInstance}getLayerConstructorOptions(e){var t,r;if(!e)return null;const i={};e.url&&(i.url=e.url),e.itemId&&e.portalUrl&&(i.portalItem={id:e.itemId,portal:{url:e.portalUrl}});const a=+e.layerId;isNaN(a)||(i.layerId=a);const s=e.layer||(this.canCacheLayer(e)?e.layer||e.cachedLayer:null);return(null==s?void 0:s.sourceJSON)&&(i.sourceJSON=s.sourceJSON),(null==s?void 0:s.customParameters)&&(i.customParameters=s.customParameters),(null===(t=null==s?void 0:s.source)||void 0===t?void 0:t.clone)&&(i.source=s.source.clone().toJSON(),i.source.toArray().length&&(i.outFields=["*"])),(null===(r=null==s?void 0:s.portalItem)||void 0===r?void 0:r.clone)&&(i.portalItem=s.portalItem.clone().toJSON()),i}syncQueryParams(e,t){var r,i,a,s,o,n,l,u;"definitionExpression"in e&&(e.definitionExpression=null===(a=null===(i=(r=t).getCurrentQueryParams)||void 0===i?void 0:i.call(r))||void 0===a?void 0:a.where),"gdbVersion"in e&&(e.gdbVersion=null===(o=(s=t).getGDBVersion)||void 0===o?void 0:o.call(s)),"timeExtent"in e&&(e.timeExtent=f.dataSourceUtils.changeJimuTimeToJSAPITimeExtent(null===(u=null===(l=(n=t).getCurrentQueryParams)||void 0===l?void 0:l.call(n))||void 0===u?void 0:u.time))}afterCreateJSAPILayer(e,t){if(!e||!t)return;const r=t.getLabel()||this.getDataSourceJson().sourceLabel;e.title!==r&&(e.title=r),this.setJimuChildIdAsLayerId(e,this),(t.layer||t.cachedLayer)&&(e.id=(t.layer||t.cachedLayer).id)}},G={[o.CSV]:"esri/layers/CSVLayer",[o.GeoJSON]:"esri/layers/GeoJSONLayer",[o.KML]:"esri/layers/KMLLayer",[o.WFS]:"esri/layers/WFSLayer",[o.WMS]:"esri/layers/WMSLayer",[o.WMTS]:"esri/layers/WMTSLayer",[o.VectorTileService]:"esri/layers/VectorTileLayer",[o.SubtypeGroupLayer]:"esri/layers/SubtypeGroupLayer"},q=["id","url","itemId","portalUrl","type","geometryType","layerId"];function W(e,t,r,i,a,s){if(t)return k(e,t,a,s);{let t,o;return r.data?t=Y(e,r.data,r.portalUrl,a,s):r.item&&(t=$(e,r.item,r.portalUrl,a,s)),i&&(o=H(e,i.layerDefinition,i.url,a,s)),t&&o?o.merge(t):t||o}}function k(e,t,r,i){var a,s,o,n,l,d;if(!e||!t)return null;let c,h,S,g=f.dataSourceUtils.getUrlByLayer(t);const v=t.type;switch(v){case y.GroupLayer:c=u.GroupLayer;break;case y.FeatureLayer:c=u.FeatureLayer,h=`${t.layerId}`,S=null===(a=t.sourceJSON)||void 0===a?void 0:a.geometryType;break;case y.SceneLayer:c=u.SceneLayer,h=`${t.layerId}`;break;case y.MapImageLayer:case y.TileLayer:c=u.MapService;break;case y.BuildingSceneLayer:c=u.BuildingSceneLayer;break;case y.BuildingGroupSubLayer:c=u.BuildingGroupSubLayer;break;case y.BuildingComponentSubLayer:c=u.BuildingComponentSubLayer,h=`${t.id}`;break;case y.ImageryLayer:c=u.ImageryLayer;break;case y.ImageryTileLayer:c=u.ImageryTileLayer;break;case y.ElevationLayer:c=u.ElevationLayer;break;case y.OrientedImageryLayer:c=u.OrientedImageryLayer;break;case y.SubtypeGroupLayer:c=u.SubtypeGroupLayer,h=`${t.layerId}`,S=null===(s=t.sourceJSON)||void 0===s?void 0:s.geometryType;break;case y.SubtypeSublayer:c=u.SubtypeSublayer,h=`${t.parent.layerId}`,S=null===(o=t.parent.sourceJSON)||void 0===o?void 0:o.geometryType,g=f.dataSourceUtils.getUrlByLayer(t.parent);break;case y.VectorTileLayer:case y.KMLLayer:case y.CSVLayer:case y.GeoJSONLayer:case y.WFSLayer:case y.WMSLayer:case y.WMTSLayer:break;default:const e=v;console.warn(`Unhandled case: ${e}`)}let p;return c&&(p=(0,f.Immutable)({id:e,type:c,sourceLabel:t.title||(null===(n=t.sourceJSON)||void 0===n?void 0:n.name)}),p=(null===(l=t.portalItem)||void 0===l?void 0:l.id)?p.set("portalUrl",null===(d=t.portalItem.portal)||void 0===d?void 0:d.url).set("itemId",t.portalItem.id):p,p=/^\d+$/.test(h)?p.set("layerId",h):p,p=g?p.set("url",g):p,p=S?p.set("geometryType",S):p,p=r?p.merge(r.without(...q),{deep:!0}):p,p=i?p.set("schema",i):p),p}function $(e,t,r,i,a){var s,o,n,l,d;if(!e||!t)return null;let c,y,S;const g=t.type;switch(g){case h.WebMap:case h.WebScene:case h.CSV:case h.GeoJSON:case h.KML:case h.WFS:case h.WMS:case h.WMTS:case h.GroupLayer:c=u[X(h,g)],S=null===(s=t.url)||void 0===s?void 0:s.replace(/^http:/,"https:").replace(/\/$/,"");break;case h.FeatureCollection:(null===(o=t.typeKeywords)||void 0===o?void 0:o.includes("Singlelayer"))?(c=u.FeatureLayer,y="0"):c=u.GroupLayer;break;case h.FeatureService:case h.MapService:case h.SceneService:case h.ImageService:case h.VectorTileService:if(f.dataSourceUtils.isSupportedWholeArcGISService(t.url))c=K(t.url,{isTiledImagery:(v=t.typeKeywords,null==v?void 0:v.includes("Tiled Imagery")),isElevation3DLayer:z(t.typeKeywords)});else if(f.dataSourceUtils.isSupportedSingleArcGISLayerService(t.url)){const e=K(f.dataSourceUtils.getFullArcGISServiceUrl(t.url,!1));e===u.FeatureService||e===u.MapService?c=u.FeatureLayer:e===u.SceneService&&(c=u.SceneLayer),y=c&&(null===(n=t.url)||void 0===n?void 0:n.replace(/\/$/,"").split("/").reverse()[0])}S=c===u.VectorTileService?null===(l=t.url)||void 0===l?void 0:l.replace(/^http:/,"https:").replace(/\/$/,""):null===(d=t.url)||void 0===d?void 0:d.split("?")[0].replace(/^http:/,"https:").replace(/\/$/,"");break;case h.GeocodingService:case h.GeoenrichmentService:case h.GeometryService:case h.GeoprocessingService:case h.NetworkAnalysisService:break;default:throw new Error(`Unhandled case: ${g}`)}var v;let p;return c&&(p=(0,f.Immutable)({id:e,type:c,sourceLabel:t.title}),p=p.set("itemId",t.id),p=p.set("portalUrl",r),p=/^\d+$/.test(y)?p.set("layerId",y):p,p=S?p.set("url",S):p,p=i?p.merge(i.without(...q),{deep:!0}):p,p=a?p.set("schema",a):p),p}function z(e){return null==e?void 0:e.includes("Elevation 3D Layer")}function Y(e,t,r,i,a){var s;if(!e||!t)return null;let o,n;const l=t,d=l.layerType;switch(d){case S.FeatureLayer:case S.SceneLayer:case S.SubtypeGroupLayer:o=u[X(S,d)],n=null===(s=l.url)||void 0===s?void 0:s.replace(/\/$/,"").split("/").reverse()[0];break;case S.GroupLayer:case S.MapService:o=u[X(S,d)];break;case S.TiledMapService:o=u.MapService;break;case S.ImageService:o=u.ImageryLayer;break;case S.TiledImageService:o=u.ImageryTileLayer;break;case S.VectorTileService:case S.CSV:case S.GeoJSON:case S.KML:case S.WFS:case S.WMS:break;default:throw new Error(`Unhandled case: ${d}`)}let c;return o&&(c=(0,f.Immutable)({id:e,type:o,sourceLabel:l.title}),c=c.set("itemId",l.itemId),c=c.set("portalUrl",r),c=/^\d+$/.test(n)?c.set("layerId",n):c,c=l.url?c.set("url",l.url.replace(/^http:/,"https:").replace(/\/$/,"")):c,c=i?c.merge(i.without(...q),{deep:!0}):c,c=a?c.set("schema",a):c),c}function H(e,t,r,i,a){if(!e||!t)return null;let s;if(f.dataSourceUtils.isSupportedWholeArcGISService(r)){s=function(e,t,r){if(!e||!t||!r)return null;const i="Elevation"===r.cacheType?{isElevation3DLayer:!0}:(s=r.capabilities,(null==s?void 0:s.includes("TilesOnly"))?{isTiledImagery:!0}:null),a=K(t,i);var s;if(!a)return null;const o=(0,f.Immutable)({id:e,type:a,url:f.dataSourceUtils.getFullArcGISServiceUrl(t,!1),sourceLabel:f.dataSourceUtils.getLabelFromArcGISServiceUrl(t)});return o}(e,f.dataSourceUtils.getFullArcGISServiceUrl(r,!1,t),t)}else if(!r||f.dataSourceUtils.isSupportedSingleArcGISLayerService(r)){s=function(e,t,r){if(!e||!r)return null;let i;const a=r.type||r.layerType;switch(a){case d.GroupLayer:i=u.GroupLayer;break;case d.FeatureLayer:i=r.subtypeField?u.SubtypeGroupLayer:u.FeatureLayer;break;case d.Table:i=u.FeatureLayer;break;case d.OrientedImageryLayer:i=u.OrientedImageryLayer;break;case d.SceneLayer3DObject:case d.SceneLayerPoint:i=u.SceneLayer;break;case d.BuildingSceneLayer:i=u.BuildingSceneLayer;break;case d.BuildingGroupSubLayer:i=u.BuildingGroupSubLayer;break;case d.BuildingComponentSubLayer:i=u.BuildingComponentSubLayer;break;default:throw new Error(`Unhandled case: ${a}`)}let s;i&&(s=(0,f.Immutable)({id:e,type:i,sourceLabel:r.name}),s=t?s.set("url",f.dataSourceUtils.getFullArcGISServiceUrl(t,!0,r)):s,s=/^\d+$/.test(`${r.id}`)?s.set("layerId",`${r.id}`):s,s=r.geometryType?s.set("geometryType",r.geometryType):s);return s}(e,f.dataSourceUtils.getFullArcGISServiceUrl(r,!0,t),t)}return s=i&&s?s.merge(i.without(...q),{deep:!0}):s,s=a&&s?s.set("schema",a):s,s}function K(e,t){if(!f.dataSourceUtils.isSupportedWholeArcGISService(e))return null;const r=e.split("?")[0].split("/"),i=Object.values(c).find((e=>r.some((t=>e.toLowerCase()===t.toLowerCase()))));let a;switch(i){case c.FeatureService:case c.MapService:case c.SceneService:case c.VectorTileService:a=u[X(c,i)];break;case c.ImageService:a=(null==t?void 0:t.isElevation3DLayer)?u.ElevationLayer:(null==t?void 0:t.isTiledImagery)?u.ImageryTileLayer:u.ImageryLayer;break;default:throw new Error(`Unhandled case: ${i}`)}return a}function X(e,t){var r;return null===(r=Object.entries(e).find((([e,r])=>r===t)))||void 0===r?void 0:r[0]}var Z=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};const ee=e=>class extends e{constructor(){super(...arguments),this.childDataSourcesCreated=!1,this.childDataSourcePromises={}}childDataSourcesReady(){return this.createChildDataSourcesRecursively().finally((()=>{this.childDataSourcesCreated=!0}))}areChildDataSourcesCreated(){return this.childDataSourcesCreated}createChildDataSourcesRecursively(){return this.createChildDataSources().then((e=>Promise.allSettled(e.map((e=>e.isDataSourceSet()?e.childDataSourcesReady().then((()=>e)):e))).then((e=>e.filter((e=>"fulfilled"===e.status)).map((e=>e.value))))))}createChildDataSources(){return Z(this,void 0,void 0,(function*(){return this.getChildDataSourceIds().forEach((e=>{this.childDataSourcePromises[e]||(this.childDataSourcePromises[e]=this.createDataSourceById(e))})),Promise.allSettled(Object.values(this.childDataSourcePromises)).then((e=>e.filter((e=>"fulfilled"===e.status)).map((e=>e.value))))}))}createDataSourceById(e){return Z(this,void 0,void 0,(function*(){try{const t=this.findChildDataSourceIdByDescendantDataSourceId(e);if(!t)return Promise.reject(new p(e,"Can not find data source."));if(!this.childDataSourcePromises[t]){const e=this.getChildIds().find((e=>this.getJimuChildId(e).some((e=>this.getChildDataSourceId(e)===t)))),r=this.getJimuChildId(e).find((e=>this.getChildDataSourceId(e)===t));this.childDataSourcePromises[t]=this.createChildDataSourceById(t,r,e)}const r=yield this.childDataSourcePromises[t];return r.id===e?r:r.isDataSourceSet()?r.createDataSourceById(e):Promise.reject(new p(e,"Can not find data source."))}catch(t){return Promise.reject(new p(e,"Failed to create the data source."))}}))}findChildDataSourceIdByDescendantDataSourceId(e){const t=this.getChildDataSourceIds(),r=null==e?void 0:e.split("-");return t.find((e=>{const t=null==e?void 0:e.split("-");return null==t?void 0:t.every(((e,t)=>r[t]===e))}),null)}getChildDataSourceIds(){return(this.getChildIds()||[]).reduce(((e,t)=>e.concat(this.getJimuChildId(t))),[]).map((e=>this.getChildDataSourceId(e)))}destroy(){Object.keys(this.childDataSourcePromises).forEach((e=>{this.dataSourceManager.destroyDataSource(e)}))}areSomeChildDataSourcesPending(){const e=Object.keys(this.childDataSourcePromises).map((e=>(e=>{const t={};return Promise.race([e,t]).then((e=>e===t),(e=>!1))})(this.childDataSourcePromises[e])));return Promise.all(e).then((e=>e.some((e=>e))))}getChildDataSourceId(e){return f.dataSourceUtils.getChildDataSourceId(this.id,e)}getChildDataSources(){return Object.keys(this.dataSourceManager.getDataSources()).filter((e=>this.dataSourceManager.getDataSource(e).parentDataSource===this)).map((e=>this.dataSourceManager.getDataSource(e))).sort(((e,t)=>e.order-t.order))}getAllChildDataSources(){const e=(t,r)=>{const i=t.isDataSourceSet()&&t.getChildDataSources();i&&i.forEach((t=>{r.push(t),t.isDataSourceSet()&&e(t,r)}))},t=[];return e(this,t),t}getChildDataSource(e){return this.dataSourceManager.getDataSource(this.getChildDataSourceId(e))}getJimuChildId(e){const t=this.getReversedConfigSchema();return t&&t.childSchemas&&t.childSchemas[e]?t.childSchemas[e].map((e=>e.jimuChildId)).asMutable():[e]}clearChildDataSourcePromise(e){delete this.childDataSourcePromises[e]}};var te=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class re extends(_(C(ee(A)))){constructor(e){var t;super(e),e.layer&&(this.layer=e.layer);const r=this.getDataSourceJson();this.portalUrl=r.portalUrl,this.itemId=r.itemId,this.layerId=r.layerId,(null===(t=this.layer)||void 0===t?void 0:t.portalItem)&&this.setItemInfo(this.layer.portalItem.sourceJSON)}ready(){const e=Object.create(null,{ready:{get:()=>super.ready},createChildDataSourcesRecursively:{get:()=>super.createChildDataSourcesRecursively}});return this.fetchDataDefinitions().then((()=>e.ready.call(this))).then((()=>te(this,void 0,void 0,(function*(){const t=(0,f.getAppStore)().getState().appConfig;if(t.originExbVersion&&f.semver.lt(t.originExbVersion,"1.6.0")){const t=yield e.createChildDataSourcesRecursively.call(this);yield this.upgradeChildDssId(t)}}))))}upgradeChildDssId(e){return te(this,void 0,void 0,(function*(){let t=(0,f.getAppStore)().getState().appConfig;const r=[],i=(e,t,r)=>((null==e?void 0:e.dataSourceId)&&(e.dataSourceId=e.dataSourceId.replace(t,r)),(null==e?void 0:e.mainDataSourceId)&&(e.mainDataSourceId=e.mainDataSourceId.replace(t,r)),e),a=(e,t)=>(null==e?void 0:e.mainDataSourceId)?e.mainDataSourceId===t:!!(null==e?void 0:e.dataSourceId)&&e.dataSourceId.split("-dataView_")[0]===t;if(e.forEach((e=>{var s,o,n,l,u,d,c;if(e){let h="",y=e;const S=[];for(;y;){const e=!y.parentDataSource,t=!y.isDataSourceSet()&&!y.getDataSourceJson().url||f.dataSourceUtils.isSupportedSingleArcGISLayerService(y.getDataSourceJson().url),r=!!(null===(s=y.parentDataSource)||void 0===s?void 0:s.map);let i;if(e)i=y.id;else if(t&&!r){const e=y.getLayerDefinition?y.getLayerDefinition():null===(n=(o=y).getServiceDefinition)||void 0===n?void 0:n.call(o);i=f.dataSourceUtils._getFixedLayerIdByLayerDefinition(e)||y.jimuChildId}else i=t||r?y.jimuChildId:f.dataSourceUtils.getLabelFromArcGISServiceUrl(y.getDataSourceJson().url);if(!e&&!r&&y.getDataSourceJson().url&&(null===(c=null===(d=null===(u=null===(l=y.parentDataSource.layer)||void 0===l?void 0:l.layers)||void 0===u?void 0:u.toArray)||void 0===d?void 0:d.call(u))||void 0===c?void 0:c.filter((e=>f.dataSourceUtils.getUrlByLayer(e)===y.getDataSourceJson().url)).length)>1){const e=y.parentDataSource.layer.layers.toArray().filter((e=>f.dataSourceUtils.getUrlByLayer(e)===y.getDataSourceJson().url)).findIndex((e=>e.id===y.jimuChildId));e>0&&(i=`${i}_${e}`)}h=h?`${i}-${h}`:i,S.unshift({jimuChildIdFromLabel:i,jimuChildIdFromId:y.jimuChildId||y.id}),y=y.parentDataSource}Object.keys(t.widgets||{}).forEach((r=>{var s;if(null===(s=t.widgets[r].useDataSources)||void 0===s?void 0:s.some((e=>a(e,h)))){const a=t.widgets[r].asMutable({deep:!0});a.useDataSources=a.useDataSources.map((t=>i(t,h,e.id))),a.config&&(a.config=JSON.parse(JSON.stringify(a.config).replace(new RegExp(h,"g"),e.id))),t=t.setIn(["widgets",r],a)}})),Object.keys(t.dataSources||{}).forEach((r=>{var s;if(null===(s=t.dataSources[r].originDataSources)||void 0===s?void 0:s.some((e=>a(e,h)))){const a=t.dataSources[r].asMutable({deep:!0});a.originDataSources=a.originDataSources.map((t=>i(t,h,e.id))),t=t.setIn(["dataSources",r],a)}const o=[];if(S.forEach(((e,t)=>{o.push(e.jimuChildIdFromLabel),t!==S.length-1&&o.push("childDataSourceJsons")})),t.dataSources.getIn(o)){const r=S.slice().reverse();if(r[0].jimuChildIdFromId!==r[0].jimuChildIdFromLabel){const i=o.slice(0,o.length-2),a=t.dataSources.getIn(i).asMutable({deep:!0});a.childDataSourceJsons[r[0].jimuChildIdFromId]=a.childDataSourceJsons[r[0].jimuChildIdFromLabel],a.childDataSourceJsons[r[0].jimuChildIdFromId].id=e.id,delete a.childDataSourceJsons[r[0].jimuChildIdFromLabel],t=t.setIn(["dataSources"].concat(i),a)}}})),Object.keys(t.messageConfigs||{}).forEach((r=>{var a;const s=null===(a=t.messageConfigs[r].actions)||void 0===a?void 0:a.some((e=>{var t,r,i,a,s;return(null===(t=e.useDataSources)||void 0===t?void 0:t.some((e=>(null==e?void 0:e.mainDataSourceId)===h)))||(null===(i=null===(r=e.config)||void 0===r?void 0:r.actionUseDataSource)||void 0===i?void 0:i.mainDataSourceId)===h||(null===(s=null===(a=e.config)||void 0===a?void 0:a.messageUseDataSource)||void 0===s?void 0:s.mainDataSourceId)===h}));if(s){const a=t.messageConfigs[r].asMutable({deep:!0});a.actions=a.actions.map((t=>{var r,a;return t.useDataSources&&(t.useDataSources=t.useDataSources.map((t=>i(t,h,e.id)))),(null===(r=t.config)||void 0===r?void 0:r.actionUseDataSource)&&(t.config.actionUseDataSource=i(t.config.actionUseDataSource,h,e.id)),(null===(a=t.config)||void 0===a?void 0:a.messageUseDataSource)&&(t.config.messageUseDataSource=i(t.config.messageUseDataSource,h,e.id)),t})),t=t.setIn(["messageConfigs",r],a)}})),!e.isDataSourceSet()&&Object.keys((0,f.getAppStore)().getState().dataSourcesInfo).some((e=>e.includes(h)))&&(Object.keys((0,f.getAppStore)().getState().dataSourcesInfo).forEach((t=>{if(t.includes(h)){const r=t,i=t.replace(h,e.id);(0,f.getAppStore)().dispatch(f.appActions.updateDataSourceInfo(e.id,(0,f.getAppStore)().getState().dataSourcesInfo[r].merge((0,f.getAppStore)().getState().dataSourcesInfo[i]||{})))}})),e.getDataView(f.CONSTANTS.SELECTION_DATA_VIEW_ID)&&r.push(e.getDataView(f.CONSTANTS.SELECTION_DATA_VIEW_ID).ready()))}})),(0,f.getAppStore)().getState().appConfig!==t){(0,f.getAppStore)().dispatch(f.appActions.appConfigChanged(t));const e=this.getRootDataSource()||this,r=t.dataSources[e.id];r&&f.lodash.defer((()=>{this.dataSourceManager.updateDataSourceByDataSourceJson(e,r)}))}return Promise.allSettled(r).then()}))}fetchDataDefinitions(){return te(this,void 0,void 0,(function*(){const e=[this.fetchServiceDefinition().then((()=>{var e,t;(null===(t=null===(e=this.serviceDefinition)||void 0===e?void 0:e.tables)||void 0===t?void 0:t.length)>0&&(this.serviceDefinition.tables=this.serviceDefinition.tables.map((e=>Object.assign(Object.assign({},e),{type:d.Table}))))}))];this.layer||this.url||!this.itemId||e.push(this.fetchItemData(),this.fetchItemInfo()),yield Promise.all(e)}))}fetchServiceDefinition(){return te(this,void 0,void 0,(function*(){var e;let t;if(this.layer?(yield this.layer.load(),this.updateServiceDefinitionByLayer(),t=this.getServiceDefinition()):this.url&&(t=yield this.fetchServiceDefinitionByUrl()),null===(e=null==t?void 0:t.layers)||void 0===e?void 0:e.some((e=>!e.type))){const e=t.layers.filter((e=>!e.type)).map((e=>f.dataSourceUtils.getFullArcGISServiceUrl(this.url,!0,e))),r=yield f.ServiceManager.getInstance().fetchChildLayerDefinitionsFromUrls(e),i=Object.values(r);t.layers.forEach(((e,r)=>{t.layers[r]=Object.assign(Object.assign({},t.layers[r]),i.find((e=>e.id===t.layers[r].id)))}))}return t}))}fetchSchema(){return te(this,void 0,void 0,(function*(){const e=this.getChildDataSources(),t=yield f.dataSourceUtils.getOriginDataLabel(this);let r=(0,f.Immutable)({childSchemas:{},label:t});return e.forEach(((e,t)=>{const i=e.getFetchedSchema();r=r.setIn(["childSchemas",e.jimuChildId],i)})),Promise.resolve(r)}))}getServiceDefinition(){return this.isDataView||this.isLocal?this.getMainDataSource().getServiceDefinition():this.serviceDefinition}getItemInfo(){return this.isDataView||this.isLocal?this.getMainDataSource().getItemInfo():super.getItemInfo()}createChildDataSourceById(e,t,r){return te(this,void 0,void 0,(function*(){const i=this.createChildDataSourceOptionsById(e,t,r);if(!i)return Promise.reject(new p(e,"Do not support this type of data."));const a=yield this.dataSourceManager.createDataSource(i);return this.updateChildDataSourcesGDBVersion([a]),a}))}createChildDataSourceOptionsByIdFromUrl(e,t,r){if(this.url){const i=this.findLayerDefinitionInfo(r);return(null==i?void 0:i.url)?this.createChildDataSourceOptionsByLayerDefinition(i.partialLayerDefinition,i.url,t,e,i.order):null}return null}createChildDataSourceOptionsByLayerDefinition(e,t,r,i,a){const s=this.createChildDataSourceJsonByLayerDefinition(e,t,r,i);return s?{id:i,dataSourceJson:s,parentDataSource:this,jimuChildId:r,order:a}:null}createChildDataSourceJsonByLayerDefinition(e,t,r,i){var a,s,o,n,l,u;if(!e||!i)return null;const d=f.dataSourceUtils._getFixedLayerIdByLayerDefinition(e)||f.dataSourceUtils.getLabelFromArcGISServiceUrl(t),c=(null===(s=null===(a=this.getDataSourceJson().schema)||void 0===a?void 0:a.childSchemas)||void 0===s?void 0:s[r])||(null===(n=null===(o=this.getDataSourceJson().schema)||void 0===o?void 0:o.childSchemas)||void 0===n?void 0:n[d]);let h=H(i,e,t,(null===(l=this.getDataSourceJson().childDataSourceJsons)||void 0===l?void 0:l[r])||(null===(u=this.getDataSourceJson().childDataSourceJsons)||void 0===u?void 0:u[d]),c);return h&&(this.portalUrl&&(h=h.set("portalUrl",this.portalUrl)),this.itemId&&(h=h.set("itemId",this.itemId))),h}findLayerDefinitionInfo(e){let t;return this.getPartialLayerAndTableDefinitions().concat(this.getPartialSubLayerDefinitions()).some(((r,i)=>{const a=f.dataSourceUtils.getFullArcGISServiceUrl(this.url,!0,r);return this.getChildIdByLayerDefinition(r,a)===e&&(t={proxyUrl:a,url:a,partialLayerDefinition:r,order:i},!0)})),t}updateServiceDefinitionByLayer(){var e,t;(null===(e=this.layer)||void 0===e?void 0:e.sourceJSON)?this.serviceDefinition=this.layer.sourceJSON:this.serviceDefinition={name:null===(t=this.layer)||void 0===t?void 0:t.title}}fetchServiceDefinitionByUrl(){return te(this,void 0,void 0,(function*(){var e,t,r;if(this.getServiceDefinition())return this.getServiceDefinition();if(this.url){const i=yield f.ServiceManager.getInstance().fetchServiceInfo(this.url).then((e=>e.definition));if(!i)return null;if(i.name||(i.name=f.dataSourceUtils.getLabelFromArcGISServiceUrl(this.getDataSourceJson().url)),null===(e=i.subLayers)||void 0===e?void 0:e.some((e=>!e.type))){const e=(null===(t=this.parentDataSource)||void 0===t?void 0:t.getServiceDefinition)?null===(r=this.parentDataSource)||void 0===r?void 0:r.getServiceDefinition():yield f.ServiceManager.getInstance().fetchServiceInfo(`${f.dataSourceUtils.getFullArcGISServiceUrl(this.url,!1)}/layers`).then((e=>e.definition));i.subLayers=i.subLayers.map((t=>{var r;const i=null===(r=null==e?void 0:e.layers)||void 0===r?void 0:r.find((e=>e.id===t.id));return Object.assign(Object.assign({},t),i)}))}return this.serviceDefinition=i,this.serviceDefinition}return Promise.reject(new p(this.id,"Failed to fetch service definition, need url."))}))}getPartialSubLayerDefinitions(){var e;return(null===(e=this.getServiceDefinition())||void 0===e?void 0:e.subLayers)||[]}getPartialLayerAndTableDefinitions(){var e,t;const r=(null===(e=this.getServiceDefinition())||void 0===e?void 0:e.layers)||[],i=(null===(t=this.getServiceDefinition())||void 0===t?void 0:t.tables)||[];return r.concat(i)}getChildIdByLayerDefinition(e,t){return f.dataSourceUtils.getFixedLayerIdByLayerDefinition(e)||f.dataSourceUtils.getLabelFromArcGISServiceUrl(t)}getChildIdByLayer(e){return f.dataSourceUtils.getFixedLayerIdByLayer(e)||f.dataSourceUtils.getLabelFromArcGISServiceUrl(f.dataSourceUtils.getUrlByLayer(e))}getChildIdBySubLayer(e){var t,r;const i=Object.assign(Object.assign({},e),{id:null!==(r=null===(t=null==e?void 0:e.source)||void 0===t?void 0:t.mapLayerId)&&void 0!==r?r:e.id});return f.dataSourceUtils.getFixedLayerIdByLayer(i)||f.dataSourceUtils.getLabelFromArcGISServiceUrl(f.dataSourceUtils.getUrlByLayer(e))}getChildIdsByUrl(){return this.getPartialLayerAndTableDefinitions().concat(this.getPartialSubLayerDefinitions()).map((e=>this.getChildIdByLayerDefinition(e,f.dataSourceUtils.getFullArcGISServiceUrl(this.getDataSourceJson().url,!0,e))))}updateChildDataSourcesGDBVersion(e){this.getInfo().gdbVersion&&e.forEach((e=>{e.type===o.FeatureLayer&&e.changeGDBVersion(this.getInfo().gdbVersion)}))}getGDBVersion(){return this.getInfo().gdbVersion}changeGDBVersion(e){(0,f.getAppStore)().dispatch(f.appActions.changeDataSourceGDBVersion(this.id,e)),this.updateChildDataSourcesGDBVersion(this.getAllChildDataSources()),f.jimuHistory.changeQueryObjectByDataSourceGDBVersion(this.id,e)}}var ie=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class ae extends A{load(){return ie(this,void 0,void 0,(function*(){return this.setStatus(s.Loading),yield this.doLoad().then((e=>(this.records=e,this.setStatus(s.Loaded),this.records)))}))}}class se{constructor(e){Object.assign(this,e)}getQueryCapabilities(){return{maxPageSize:null}}}var oe=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))},ne=function(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(i=Object.getOwnPropertySymbols(e);a<i.length;a++)t.indexOf(i[a])<0&&Object.prototype.propertyIsEnumerable.call(e,i[a])&&(r[i[a]]=e[i[a]])}return r};const{DEFAULT_QUERY_PAGE_SIZE:le,DATA_VIEW_ID_FOR_NO_SELECTION:ue,OUTPUT_DATA_VIEW_ID:de,SELECTION_DATA_VIEW_ID:ce}=f.CONSTANTS;class he extends A{constructor(e){super(e),this.pages={},this.pagePromises={},this.loadMissingFieldsByPagePromises={},this.throttleQueryRecordsByIdWithCurrentQueryParams=f.lodash.throttle(this.queryRecordsByIdWithCurrentQueryParams.bind(this),200),this.setCapabilities(new se({})),this.url=this.getDataSourceJson().url,this.isSqlCaseSensitive=!!this.getDataSourceJson().isDataInDataSourceInstance||!f.dataSourceUtils.isAGOLHostedService(this.getDataSourceJson().url);const t=e.belongToDataSource&&e.belongToDataSource.getStatus()!==s.NotReady;this.getDataSourceJson().isOutputFromWidget&&!t?(this.setStatus(s.NotReady),this.setCountStatus(s.NotReady)):(this.setStatus(s.Unloaded),this.setCountStatus(s.Unloaded))}ready(){if(this.isSelectionView()){const e=this.getMainDataSource().id,{allSelectedRecordIds:t,allSelectOptions:r}=this.getSelectedIdsAndSelectOptionsFromUrl(),i=()=>{if(0===t.length&&0===Object.keys(r).length)return Promise.resolve({});const i=t.length>0?this.queryRecordsByIdWithCurrentQueryParams(t,this.getMainDataSource(),{returnGeometry:!0,outFields:this.getAllUsedFields()}).then((e=>{var t;this.getMainDataSource().selectRecordsByIds(null===(t=e.records)||void 0===t?void 0:t.map((e=>e.getId())),e.records)})):null,a=Object.keys(r).map((t=>{var i,a,s;if(null===(a=null===(i=r[t])||void 0===i?void 0:i.ids)||void 0===a?void 0:a.length)return this.queryRecordsByIdWithCurrentQueryParams(r[t].ids,this.getMainDataSource(),{returnGeometry:!0,outFields:this.getAllUsedFields()}).then((e=>{this.getMainDataSource().selectRecords(Object.assign(Object.assign({},r[t]),{records:e.records}))}));if(null===(s=r[t])||void 0===s?void 0:s.queryParams){const i=t===e?null:t.replace(`${e}-`,""),a=i?this.dataSourceManager.createDataView(this.getMainDataSource(),i):this.getMainDataSource();return null==a?void 0:a.queryAll(Object.assign(Object.assign({},r[t].queryParams),{returnGeometry:!0,outFields:this.getAllUsedFields()})).then((e=>{a.selectRecords(Object.assign(Object.assign({},r[t]),{records:e.records}))}))}return null}));this.pendingPromiseToQuerySelectedRecordsPresetBeforeDsReady=Promise.allSettled([i,...a].filter((e=>!!e))).then((()=>{})).finally((()=>{this.pendingPromiseToQuerySelectedRecordsPresetBeforeDsReady=null}))};return this.getMainDataSource().getDataSourceJson().isDataInDataSourceInstance?this.getMainDataSource().setOnceSetSourceRecords(i):i(),Promise.resolve()}return this.isDataView&&this.dataViewId===ue?(this.loadNoSelectionView(),Promise.resolve()):Promise.resolve()}loadNoSelectionView(){const e=this.isDataView&&this.dataViewId===ue?this:this.getMainDataSource().getDataView(ue);return e&&this.useNoSelectionView(this.getSelectionDataView())?Promise.allSettled([e.load({returnGeometry:!0},{widgetId:ue}),e.loadCount({},{widgetId:ue})]).then((()=>{var e,t,r,i;const{allSelectedRecordIds:a,allSelectOptions:s}=this.getSelectedIdsAndSelectOptionsFromUrl();this.getMainDataSource().getSelectedRecordIds().length||a.length||Object.keys(s).length||(null===(e=this.getMainDataSource().getDataView(ce))||void 0===e||e.clearRecords(),null===(r=null===(t=this.getMainDataSource().getDataView(ce))||void 0===t?void 0:t.getAllDerivedDataSources())||void 0===r||r.forEach((e=>{null==e||e.clearRecords()})),null===(i=this.getMainDataSource().getDataView(ce))||void 0===i||i.addSourceVersion())})):Promise.resolve()}getSelectedIdsAndSelectOptionsFromUrl(){const e=this.getMainDataSource().id,t=f.UrlManager.getInstance(),r=f.urlUtils.getDataSourceInfosFromUrlParams(t.getQueryObject(),t.getHashObject());let i=[];const a={};return r&&Object.keys(r).forEach((t=>{var s,o,n,l,u;(t===e||f.dataSourceUtils.isDerivedFrom(e,t))&&(Array.isArray(null===(s=r[t])||void 0===s?void 0:s.selection)&&(null===(o=r[t])||void 0===o?void 0:o.selection).length?i=i.concat(null===(n=r[t])||void 0===n?void 0:n.selection):(null===(u=null===(l=r[t])||void 0===l?void 0:l.selection)||void 0===u?void 0:u.widgetId)&&(a[t]=r[t].selection))})),i=Array.from(new Set(i)),{allSelectedRecordIds:i,allSelectOptions:a}}get isSqlCaseSensitive(){return this._isSqlCaseSensitive}set isSqlCaseSensitive(e){this._isSqlCaseSensitive=e}getCurrentQueryParams(e){return this.getCurrentQueryParamsWithSpecificWidgetQueries(e,this.getInfo().widgetQueries)}getRuntimeQueryParams(e){return this.getRuntimeQueryParamsWithSpecificWidgetQueries(e,this.getInfo().widgetQueries)}getCurrentQueryParamsWithSpecificWidgetQueries(e,t){const r=this.getWidgetIdsFromWidgetDataSourcePairs(null==e?void 0:e.exclude),i=this.getRuntimeQueryParamsWithSpecificWidgetQueries(r,t);return this.getCurrentQueryParamsByQuery(i,e)}getRuntimeQueryParamsWithSpecificWidgetQueries(e,t){const r=e?null==t?void 0:t.without(...[].concat(e)):t;return this.getMergedWidgetQueries(r)}getCurrentQueryParamsByQuery(e,t){let r;return this.isLocal?r=this.mergeQueryParams(this.belongToDataSource.getCurrentQueryParams(t),e):this.isDataView?(r=this.mergeQueryParams(this.getConfigQueryParams(),e),r=this.mergeQueryParams(this.getMainDataSource().getCurrentQueryParams(Object.assign(Object.assign({},t),{dataSourceToFormatSql:this})),r)):(r=this.mergeQueryParams(this.getConfigQueryParams(),e),r=this.mergeQueryParams(this.getRemoteQueryParams(),r)),r}getMergedWidgetQueries(e){let t=e&&Object.keys(e)||[];return t=t.sort(((e,t)=>e.localeCompare(t,"en",{numeric:!0,sensitivity:"base"}))),this.mergeQueryParams(...t.map((t=>e[t])))}getWidgetIdsFromWidgetDataSourcePairs(e){return e?Array.isArray(e)?e.filter((e=>e.dataSourceId===this.id)).map((e=>e.widgetId)):e.dataSourceId===this.id?[e.widgetId]:null:null}getCurrentQueryId(){return this.lastQueryId}getRealQueryParams(e,t,r){let i;if("query"===t)r&&r.scope?r.scope===g.InAllData?i=e:r.scope===g.InRemoteConfigView?i=this.mergeQueryParams(this.getRemoteQueryParams(),e):r.scope===g.InConfigView?(i=this.mergeQueryWithConfigQuery(e),i=this.mergeQueryParams(this.getRemoteQueryParams(),i)):i=r.scope===g.InRuntimeView?this.mergeQueryParams(this.getCurrentQueryParamsWithSpecificWidgetQueries({exclude:r.excludeQuery,dataSourceToFormatSql:r.dataSourceToFormatSql},this.getInfo().widgetQueries),e):e:i=this.mergeQueryParams(this.getCurrentQueryParamsWithSpecificWidgetQueries({exclude:null==r?void 0:r.excludeQuery,dataSourceToFormatSql:null==r?void 0:r.dataSourceToFormatSql},this.getInfo().widgetQueries),e);else{if(!r||!r.widgetId)return console.error("Please pass widget id for load."),null;const t=(this.getInfo().widgetQueries||(0,f.Immutable)({})).set(r.widgetId,e);r&&r.scope?r.scope===g.InAllData?i=e:r.scope===g.InRemoteConfigView?i=this.mergeQueryParams(this.getRemoteQueryParams(),e):r.scope===g.InConfigView?(i=this.mergeQueryWithConfigQuery(e),i=this.mergeQueryParams(this.getRemoteQueryParams(),i)):i=r.scope===g.InRuntimeView?this.getCurrentQueryParamsWithSpecificWidgetQueries({exclude:r.excludeQuery,dataSourceToFormatSql:r.dataSourceToFormatSql},t):e:i=this.getCurrentQueryParamsWithSpecificWidgetQueries({exclude:null==r?void 0:r.excludeQuery,dataSourceToFormatSql:null==r?void 0:r.dataSourceToFormatSql},t)}return i}mergeQueryWithConfigQuery(e){let t;return this.isLocal?this.belongToDataSource.isDataView?(t=this.mergeQueryParams(this.belongToDataSource.getConfigQueryParams(),e),t=this.mergeQueryParams(this.getMainDataSource().getConfigQueryParams(),t)):t=this.mergeQueryParams(this.getConfigQueryParams(),e):this.isDataView?(t=this.mergeQueryParams(this.getConfigQueryParams(),e),t=this.mergeQueryParams(this.getMainDataSource().getConfigQueryParams(),t)):t=this.mergeQueryParams(this.getConfigQueryParams(),e),t}updateQueryParams(e,t){var r;e=this.getQueryWithoutPage(e),f.utils.isDeepEqual(e||{},(null===(r=this.getInfo().widgetQueries)||void 0===r?void 0:r[t])||{})||(this.updateWidgetQueries(e,t),this.isSelectionView()?(this.load({returnGeometry:!0,pageSize:this.getSourceRecords().length},{widgetId:ce}),this.loadCount({},{widgetId:ce})):(this.handleSelectionOnQueryParamChanges(),this.id===this.getMainDataSource().id&&this.loadNoSelectionView()))}updateWidgetQueries(e,t){(0,f.getAppStore)().dispatch(f.appActions.updateWidgetQuery(this.id,t,e))}getQueryPageSize(){var e,t,r;const i=(null===(e=this.getDataViewConfig())||void 0===e?void 0:e.pageSize)||le,a=(null===(r=null===(t=this.getCapabilities())||void 0===t?void 0:t.getQueryCapabilities())||void 0===r?void 0:r.maxPageSize)||1/0;return Math.min(i,a)}getMaxRecordCount(){var e;return(null===(e=this.getDataViewConfig())||void 0===e?void 0:e.maximum)||null}getQueryWithoutPage(e){if(!e)return null;const{pageSize:t,page:r}=e;return ne(e,["pageSize","page"])}checkClearLocalCache(e,t,r){const i=this.getQueryWithoutPage(e),a=this.getRealQueryParams(i,"load",r),s=this.applyUsedFields(a,"*"),o=this.applyUsedFields(t,"*"),n=r.refresh||this.getInfo().needRefresh;return!(f.utils.isDeepEqual(s,o)&&!n)&&(this.getInfo().needRefresh&&this.setNeedRefresh(!1),!0)}selectRecords(e,t,r){const i=Object.create(null,{selectRecords:{get:()=>super.selectRecords}});return oe(this,void 0,void 0,(function*(){if(this.clearPendingSelect(),(null==e?void 0:e.records)||(null==e?void 0:e.ids)){const t=yield i.selectRecords.call(this,e);return Promise.resolve(Object.assign(Object.assign({},t),{queryParams:(0,f.Immutable)(null==e?void 0:e.queryParams)}))}if(null==e?void 0:e.queryParams){const a=new AbortController;return t&&(t.onabort=e=>{a.abort()}),this.abortControllerOfPendingPromiseToQuerySelectedRecordsBySelectOptions=a,this.queryAll(Object.assign(Object.assign({},e.queryParams),{returnGeometry:!0}),this.abortControllerOfPendingPromiseToQuerySelectedRecordsBySelectOptions.signal,r).then((r=>(r.isAborted&&!(null==t?void 0:t.aborted)||i.selectRecords.call(this,Object.assign(Object.assign({},e),{records:r.records})),r))).catch((t=>(console.error("Failed to select by options. ",t),{records:[],queryParams:(0,f.Immutable)(e.queryParams)})))}return Promise.resolve({records:[],queryParams:null})}))}copySelectionToDataView(e){this.clearPendingSelect(),super.copySelectionToDataView(e)}clearPendingSelect(){var e;null===(e=this.abortControllerOfPendingPromiseToQuerySelectedRecordsBySelectOptions)||void 0===e||e.abort(),this.abortControllerOfPendingPromiseToQuerySelectedRecordsBySelectOptions=null}getRecordsByPage(e,t){const r=[],i=Object.assign({},this.pages),a=Object.keys(i).map((e=>parseInt(e))).sort(((e,t)=>t-e))[0],{start:s,end:o}=this.getStartAndEndForPage(e,t);if(null===s||null===o)return[];let n,l=0;for(let e=1;e<=a;e++){n=this.getRealPageSize(e);const t=l;if(l+=n,!(t+n-1<s||t>o)&&i[e])for(let a=0;a<i[e].length;a++)t+a<s||t+a>o||r.push(i[e][a])}return r}getRecordsByPageWithSelection(e,t){return this.concatRecordsAndSelection(this.getSelectedRecords(),this.getRecordsByPage(e,t))}getPagesData(){return this.pages}setPagesData(e){this.pages=e}clearRecordsNotAddVersion(){!this.isSelectionView()&&this.getSelectedRecords().length>0&&this.copySelectionToDataView([]),this.pages={},this.pagePromises={},this.loadMissingFieldsByPagePromises={},this.loadMissingFieldsForAllPagePromise=null,this.count=null,this.countPromise=null,this.byIdPromise=null}clearCountNotAddVersion(){this.count=null,this.countPromise=null}clearQueryByIdNotAddVersion(){this.byIdPromise=null}getRecords(){let e=[];const t=[];for(let e=1;e<=Object.keys(this.pages).length&&this.pages[e];e++)t.push(e);return t.forEach((t=>{e=e.concat(this.pages[t])})),null!==this.getMaxRecordCount()&&this.getMaxRecordCount()<e.length?e.slice(0,this.getMaxRecordCount()):e}getAllLoadedRecords(){let e=[];return Object.keys(this.pages).forEach((t=>{this.pages[t]&&(e=e.concat(this.pages[t]))})),null!==this.getMaxRecordCount()&&this.getMaxRecordCount()<e.length?e.slice(0,this.getMaxRecordCount()):e}setRecords(e){const t={},r=this.getQueryPageSize();e.forEach(((e,i)=>{const a=Math.ceil((i+1)/r);t[a]||(t[a]=[]),t[a][i%r]=e})),this.setPagesData(t),this.addVersion()}setSourceRecords(e){if(super.setSourceRecords(e),this.canSaveSourceRecords()&&this.onceSetSourceRecords){const e=this.onceSetSourceRecords;this.setOnceSetSourceRecords(null),f.lodash.defer((()=>{e()}))}}get count(){return this._count}set count(e){this._count=e}getRealQueryPages(e,t){const{start:r,end:i}=this.getStartAndEndForPage(e,t);if(null===r||null===i)return[];let a,s,o,n,l=0;const u=Object.keys(this.pages).map((e=>parseInt(e))).sort(((e,t)=>e-t));for(let e=0;e<u.length;e++){if(s=a||0,a=u[e],l=l+this.getRealPageSize(a)+(a-s-1)*this.getQueryPageSize(),!o&&r<l){let e=l,t=a;for(;r<e;)e-=this.getRealPageSize(t),t--;o=t+1}if(!n&&i<l){let e=l,t=a;for(;i<e;)e-=this.getRealPageSize(t),t--;n=t+1}if(o&&n)break}if(!o||!n){const e=u.length?u[u.length-1]:0;o=o||e+Math.floor((r-l)/this.getQueryPageSize())+1,n=n||e+Math.floor((i-l)/this.getQueryPageSize())+1}const d=[];for(let e=o;e<=n;e++)d.push(e);return d}getStartAndEndForPage(e,t){if("number"!=typeof e||"number"!=typeof t)return{start:null,end:null};const r=t*(e-1);let i=r+t-1;const a=this.getMaxRecordCount();return null!==a&&(i=Math.min(i,a-1)),r<=i?{start:r,end:i}:{start:null,end:null}}haveMorePages(e,t){var r;if(e<1||t<1)return"unknown";const i=r=>r>e*t,a=this.getMaxRecordCount();if(!("number"==typeof a?i(a):"unknown"))return!1;if("number"==typeof this.count&&f.utils.isDeepEqual((0,f.Immutable)(this.lastCountQueryParams||{}).without(...f.dataSourceUtils.NON_COUNT_AFFECTING_QUERY_PARAMS_KEYS),(0,f.Immutable)(this.lastQueryParams||{}).without(...f.dataSourceUtils.NON_COUNT_AFFECTING_QUERY_PARAMS_KEYS)))return i(this.count);{const a=Object.keys(this.pagePromises).map((e=>parseInt(e)));if(!a.length&&1===e)return!0;const s=Math.max(...a);if(!(null===(r=this.pagePromises[s])||void 0===r?void 0:r.exceededTransferLimit)&&!!this.pages[s]){return i(a.reduce(((e,t,r)=>{const i=a[r-1]||0;return e+(Array.isArray(this.pages[t])?this.pages[t].length:this.getQueryPageSize())+(t-i-1)*this.getQueryPageSize()}),0))}{const r=this.getRealQueryPages(e,t);return Math.max(...r)<=s||"unknown"}}}load(e,t={}){var r;if(this.getStatus()===s.NotReady)return Promise.resolve([]);(e=Object.assign({},e)).page||(e.page=1),e.pageSize||(e.pageSize=this.getQueryPageSize());const i=this.getRealQueryPages(e.page,e.pageSize);this.checkClearLocalCache(e,this.lastQueryParams,t)&&(Object.keys(this.pages).forEach((e=>{i.includes(parseInt(e))||delete this.pages[e]})),this.pagePromises={},this.loadMissingFieldsByPagePromises={},this.loadMissingFieldsForAllPagePromise=null);const a=this.getQueryWithoutPage(e);f.utils.isDeepEqual(a||{},(null===(r=this.getInfo().widgetQueries)||void 0===r?void 0:r[t.widgetId])||{})||this.updateWidgetQueries(a,t.widgetId);let o=this.getRealQueryParams(a,"load",t);const n=this.getAllUsedFields({queryParams:o,excludeWidgetsDoNotUseDsToQuery:!0});o=this.applyUsedFields(o,n),this.loadMissingFields(o);const l=i.filter((e=>this.pagePromises[e])).map((e=>this.pagePromises[e].promise));return l.length===i.length?Promise.all(l).then((()=>this.getRecordsByPageAndLoadMoreIfExceededTransferLimit(e,i,t))):(this.lastQueryParams=o,this.setStatus(s.Loading),this.setNeedRefresh(!1),Promise.all(i.map((t=>this.loadByPage(o,e,n,t)))).then((r=>r.find((e=>e))?(this.handleSelectionOnQueryParamChanges(),this.lastRefreshTime=new Date,this.setStatus(s.Loaded),window.jimuConfig.isInBuilder&&(0,f.getAppStore)().getState().appRuntimeInfo.appMode===f.AppMode.Design||this.startAutoRefresh(),this.getRecordsByPageAndLoadMoreIfExceededTransferLimit(e,i,t)):null),(e=>(console.error(e),this.setStatus(s.LoadError),null))))}getRecordsByPageAndLoadMoreIfExceededTransferLimit(e,t,r){var i;const a=this.getRecordsByPage(e.page,e.pageSize),s=this.getMaxRecordCount();return a.length<e.pageSize&&(null===(i=this.pagePromises[Math.max(...t)])||void 0===i?void 0:i.exceededTransferLimit)&&(!s||this.getAllLoadedRecords().length<s)?this.load(e,r):Promise.resolve(a)}getRealPageSize(e){var t;return(null===(t=this.pagePromises[e])||void 0===t?void 0:t.exceededTransferLimit)&&Array.isArray(this.pages[e])?this.pages[e].length:this.getQueryPageSize()}loadMissingFields(e,t=!1){f.lodash.defer((()=>{const r=this.getAllUsedFields({queryParams:e,excludeWidgetsDoNotUseDsToQuery:!0});if(this.updateLoadOnDemandFields(r),t){if(this.usedFieldsInTimeWindow=this.mergeUsedFields(this.usedFieldsInTimeWindow,r),this.loadMissingFieldsTimer)return;this.loadMissingFieldsTimer=setTimeout((()=>{this.doLoadMissingFields(e,this.usedFieldsInTimeWindow),clearTimeout(this.loadMissingFieldsTimer),this.loadMissingFieldsTimer=null,this.usedFieldsInTimeWindow=[]}),500)}else this.doLoadMissingFields(e,r)}))}doLoadMissingFields(e,t){var r;if(this.isSelectionView()){const i=this.getRecords(),a=this.getSourceRecords().filter((e=>!i.some((t=>t.getId()===e.getId())))),s=i.concat(a),o=[];if(s.forEach((e=>{this.findMissingFields(t,Object.keys(e.getData())).forEach((e=>{o.includes(e)||o.push(e)}))})),0===o.length)return;if(!this.loadMissingFieldsByPagePromises[ce]||this.missingSomeFields(o,this.loadMissingFieldsByPagePromises[ce].fields)){const t=i.map((e=>e.getId())),a=null===(r=this.getSchema())||void 0===r?void 0:r.fields,s=this.queryRecordsByIdWithCurrentQueryParams(t,this.getMainDataSource(),this.applyUsedFields(e,o)).then((e=>{var t;if(a!==(null===(t=this.getSchema())||void 0===t?void 0:t.fields))return!1;const r=this.getRecords(),i=this.getSourceRecords();return e.records.forEach((e=>{const t=r.find((t=>t.getId()===e.getId()));t&&t.setData(Object.assign(Object.assign({},t.getData()),e.getData()));const a=i.find((t=>t.getId()===e.getId()));a&&a.setData(Object.assign(Object.assign({},a.getData()),e.getData()))})),this.addSourceVersion(),this.addVersion(),!0})).catch((e=>(console.error("Failed to load missing fields, ",e),!1)));this.loadMissingFieldsByPagePromises[ce]={promise:s,fields:o}}}else{if(!Object.values(this.pagePromises).some((e=>this.missingSomeFields(t,e.fields))))return;const r={};if(Object.keys(this.pagePromises).forEach((e=>{const i=parseInt(e),a=this.findMissingFields(t,this.pagePromises[i].fields);r[i]=a})),!this.loadMissingFieldsForAllPagePromise||Object.keys(this.pagePromises).some((e=>this.missingSomeFields(r[e],this.loadMissingFieldsForAllPagePromise.fields[e])))){const t=[];Object.keys(this.pagePromises).forEach((i=>{const a=parseInt(i),s=r[a],o=this.loadMissingFieldsByPage(e,s,a);t.push(o)}));const i=Promise.all(t).then((e=>(e.find((e=>e))&&this.addVersion(),!0))).catch((e=>(console.error("Failed to load missing fields, ",e),!1)));this.loadMissingFieldsForAllPagePromise={promise:i,fields:r}}}}loadMissingFieldsByPage(e,t,r){var i;if(!t||0===t.length||"*"===this.pagePromises[r].fields)return Promise.resolve(!0);if(!this.loadMissingFieldsByPagePromises[r]||this.missingSomeFields(t,this.loadMissingFieldsByPagePromises[r].fields)){const a=Object.assign(Object.assign({},e),{page:r,pageSize:this.getQueryPageSize()}),s=null===(i=this.getSchema())||void 0===i?void 0:i.fields,o=this.query(this.applyUsedFields(a,t),{scope:g.InAllData}).then((e=>{var r,i;return s===(null===(r=this.getSchema())||void 0===r?void 0:r.fields)&&(this.pagePromises[e.queryParams.page].fields=this.pagePromises[e.queryParams.page].fields.concat(t),null===(i=e.records)||void 0===i||i.forEach((t=>{var r,i,a;const s=null===(r=this.pages[e.queryParams.page])||void 0===r?void 0:r.find((e=>e.getId()===t.getId()));s&&s.setData(Object.assign(Object.assign({},s.getData()),t.getData()));const o=null===(a=null===(i=this.getSelectionDataView())||void 0===i?void 0:i.getSourceRecords())||void 0===a?void 0:a.find((e=>e.getId()===t.getId()));o&&o.setData(Object.assign(Object.assign({},o.getData()),t.getData()))})),!0)}));this.loadMissingFieldsByPagePromises[r]={promise:o,fields:t}}return this.loadMissingFieldsByPagePromises[r].promise}handleSelectionOnQueryParamChanges(){var e,t;if(this.useNoSelectionView(this.getSelectionDataView()))return;if(this.getSelectionDataView().pendingPromiseToQuerySelectedRecordsPresetBeforeDsReady)return;const r=this.isDataView&&this.dataViewId===ue,i=this.isSelectionView(),a=this.isLocalViewOfSelectionView();if(!r&&!i&&!a){const t=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords();let r=[];this.getSelectedRecordIds().forEach((e=>{const i=this.getSelectionDataView().getSourceRecords().some((t=>t.getId()===e)),a=t.find((t=>(null==t?void 0:t.getId())===e));!i&&a&&(r=r.concat(a))})),r.length>0&&this.copySelectionToDataView(this.getSelectionDataView().getSourceRecords().concat(r)),this.updateSelectionInfoOfDerivedDssAndChangeUrl(Object.assign(Object.assign({},null===(e=this.getSelectOptionsFromInfo())||void 0===e?void 0:e.asMutable({deep:!0})),{ids:this.getSelectionDataView().getRecords().map((e=>e.getId()))}),this,!0)}else i&&this.getMainDataSource().updateSelectionInfoOfDerivedDssAndChangeUrl(Object.assign(Object.assign({},null===(t=this.getMainDataSource().getSelectOptionsFromInfo())||void 0===t?void 0:t.asMutable({deep:!0})),{ids:this.getRecords().map((e=>e.getId()))}))}loadByPage(e,t,r,i){if(this.pagePromises[i])return this.pagePromises[i].promise;if(this.getDataSourceJson().isDataInDataSourceInstance&&this.sourceRecordsMissingFields(this.getSourceRecords(),r))return Promise.resolve(!1);const a=Object.assign(Object.assign({},e),{page:i,pageSize:this.getQueryPageSize()});this.pagePromises[i]={promise:null,fields:r};const s=this.doQuery((0,f.Immutable)(a),(0,f.Immutable)(t)).then((a=>{const s=this.getQueryWithoutPage(a.queryParams);return!!f.utils.isDeepEqual(s,this.lastQueryParams)&&("number"==typeof a.sourceVersion&&a.sourceVersion!==this.getSourceVersion()?(delete this.pagePromises[i],this.loadByPage(e,t,r,i)):(this.pages[a.queryParams.page]=a.records,this.pagePromises[a.queryParams.page]&&(this.pagePromises[a.queryParams.page].exceededTransferLimit=a.exceededTransferLimit),!0))}));return this.pagePromises[i].promise=s,this.pagePromises[i].promise}sourceRecordsMissingFields(e,t){return!(!e||!t)&&e.some((e=>this.missingSomeFields(t,Object.keys(e.getData()))))}loadCount(e,t={}){if(this.getCountStatus()===s.NotReady)return Promise.resolve(0);if(!this.checkClearLocalCache(e,this.lastCountQueryParams,t)&&this.countPromise)return null!=this.count?Promise.resolve(this.count):this.countPromise;const r=this.getRealQueryParams(this.getQueryWithoutPage(e),"load",t);return this.lastCountQueryParams=r,this.setCountStatus(s.Loading),this.count=null,this.countPromise=this.doQueryCount((0,f.Immutable)(r)).then((r=>f.utils.isDeepEqual(r.queryParams,this.lastCountQueryParams)?"number"==typeof r.sourceVersion&&r.sourceVersion!==this.getSourceVersion()?(delete this.countPromise,this.loadCount(e,t)):(null===this.getMaxRecordCount()?this.count=r.count:this.count=Math.min(r.count,this.getMaxRecordCount()),this.setCountStatus(s.Loaded),this.count):null),(e=>(console.error(e),this.setCountStatus(s.LoadError),null))),this.countPromise}loadById(e,t){return this.getStatus()===s.NotReady?Promise.resolve(null):(e===this.lastQueryId&&!t&&this.byIdPromise||(this.lastQueryId=e,this.setStatus(s.Loading),this.byIdPromise=this.doQueryById(e).then((e=>(this.setStatus(s.Loaded),e)),(e=>(console.error(e),this.setStatus(s.LoadError),null)))),this.byIdPromise)}query(e,t){if(this.getStatus()===s.NotReady)return Promise.resolve({queryParams:(0,f.Immutable)(e),records:[],fields:[],sourceVersion:this.getSourceVersion()});const r=this.getRealQueryParams(e,"query",t);return this.doQuery((0,f.Immutable)(r),(0,f.Immutable)(e)).then((e=>{const t=this.getMaxRecordCount();if(null===t)return e;const r=e.queryParams.page||1,i=e.queryParams.pageSize;return 1!==r&&i?(r-1)*i>t?e.records=[]:(r-1)*i+e.records.length>t&&(e.records=e.records.slice(0,(r-1)*i+e.records.length-t)):e.records.length>t&&(e.records=e.records.slice(0,t)),e}))}queryCount(e,t){if(this.getCountStatus()===s.NotReady)return Promise.resolve({queryParams:(0,f.Immutable)(e),count:0,sourceVersion:this.getSourceVersion()});if(this.useNoSelectionView()){const r=this.getMainDataSource().getDataView(ue);if(r)return r.queryCount(e,t)}const r=this.getRealQueryParams(e,"query",t);return this.doQueryCount((0,f.Immutable)(r)).then((e=>(null===this.getMaxRecordCount()||(e.count=Math.min(e.count,this.getMaxRecordCount())),e)))}queryIds(e,t){if(this.getCountStatus()===s.NotReady)return Promise.resolve({queryParams:(0,f.Immutable)(e),ids:[],sourceVersion:this.getSourceVersion()});if(this.useNoSelectionView()){const r=this.getMainDataSource().getDataView(ue);if(r)return r.queryIds(e,t)}const r=this.getRealQueryParams(e,"query",t);return this.doQueryIds((0,f.Immutable)(r)).then((e=>{if(null===this.getMaxRecordCount())return e;{const t=Math.min(e.ids.length,this.getMaxRecordCount());return e.ids.splice(t),e}}))}queryAll(e,t,r,i){const a=Object.assign({},e),s={queryParams:(0,f.Immutable)(a).without("page").without("pageSize"),records:[]},o=e=>(e.isAborted=!0,e),n=(e,t,r,s,n)=>oe(this,void 0,void 0,(function*(){if(t>0)for(let l=1;l<=t;l++){a.page=l,a.pageSize=e;const u=yield this.query(a,i);if((null==u?void 0:u.records)&&u.records.length>0){if(r.records.push(...u.records),null==s?void 0:s.aborted)return o(r);null==n||n(l/t,r)}}return r}));return(null==t?void 0:t.aborted)?Promise.resolve(o(s)):(null==r||r(0,s),this.queryCount(a,i).then((e=>new Promise((i=>{var a,l;t&&(t.onabort=e=>{i(o(s))});const u=e.count,d=null!==this.getMaxRecordCount()?Math.min(u,this.getMaxRecordCount()):u,c=(null===(l=null===(a=this.getCapabilities())||void 0===a?void 0:a.getQueryCapabilities())||void 0===l?void 0:l.maxPageSize)||this.getQueryPageSize(),h=Math.ceil(d/c);n(c,h,s,t,r).then((e=>{i(e)}))})))))}queryById(e,t){return oe(this,void 0,void 0,(function*(){return this.getStatus()===s.NotReady?yield Promise.resolve(null):yield this.doQueryById(e,t)}))}getAutoRefreshInterval(){const e=this.getMainDataSource();let t=e.getDataViewConfig()&&e.getDataViewConfig().refreshInterval;return 0===t?0:(null==t&&(t=e.getSchema().refreshInterval),t)}getLastRefreshTime(){return this.lastRefreshTime}startAutoRefresh(){const e=this.getAutoRefreshInterval();e&&(this.autoRefreshHandle||(this.setNeedRefresh(!1),this.autoRefreshHandle=setInterval((()=>{this.setNeedRefresh(!0),f.lodash.defer((()=>{this.setNeedRefresh(!1)}))}),1e3*e)))}stopAutoRefresh(){this.autoRefreshHandle&&(this.setNeedRefresh(!1),clearInterval(this.autoRefreshHandle),this.autoRefreshHandle=null)}setNeedRefresh(e){this.getInfo().needRefresh!==e&&(0,f.getAppStore)().dispatch(f.appActions.setDataNeedRefresh(this.id,e))}setCapabilities(e){this.capabilities=e}getCapabilities(){return this.canSaveSourceRecords()?this.capabilities:this.getMainDataSource().getCapabilities()}getMainDataSource(){return super.getMainDataSource()}getDataViews(){return super.getDataViews()}getDataView(e){return super.getDataView(e)}updateSelectionInfo(e,t,r){var i;if(!(null==e?void 0:e.ids)&&!(null==e?void 0:e.records))return;if(!(this.getListenSelection()||this.id===(null==t?void 0:t.id)))return;const a=!this.isLocal&&!this.isDataView,s=this.dataViewId===de,o=!a&&!s,n=(null===(i=e.records)||void 0===i?void 0:i.map((e=>e.getId())))||e.ids;if(!((r||o)&&n.length>0))return void this.changeSelectedRecordIdsOfDsInfo(e);const l=this.getRecords(),u=this.getSelectedRecordIds();let d=[],c=[];const h={};l.forEach((e=>{if(e){const t=e.getId();h[t]=!0}}));const y={};u.forEach((e=>{y[e]=!0})),n.forEach((e=>{h[e]||!r&&y[e]?c=c.concat(e):d=d.concat(e)})),c.length!==n.length?this.throttleQueryRecordsByIdWithCurrentQueryParams(d).then((t=>{var r,i;const a=u,s=this.getSelectedRecordIds();if(s.length===a.length&&s.every((e=>a.some((t=>t===e))))){const a={};(null===(r=null==t?void 0:t.records)||void 0===r?void 0:r.length)>0&&t.records.forEach((e=>{if(e){const t=e.getId();a[t]=!0}}));const s=d.filter((e=>a[e])),o=c.concat(s);this.changeSelectedRecordIdsOfDsInfo(Object.assign(Object.assign({},e),{ids:o,records:null===(i=e.records)||void 0===i?void 0:i.filter((e=>o.includes(e.getId())))}))}})).catch((e=>{console.error(`Failed to check whether selected records in ${this.id}. `,e)})):this.changeSelectedRecordIdsOfDsInfo(e)}changeSelectedRecordIdsOfDsInfo(e){var t;(0,f.getAppStore)().dispatch(f.appActions.dataSourceSelectionChanged(this.id,e)),this.getMainDataSource().id===this.id&&(null===(t=this.getSelectionDataView())||void 0===t||t.addVersion(),this.useNoSelectionView(this.getSelectionDataView())&&this.getSelectionDataView().addSourceVersion())}queryRecordsByIdWithCurrentQueryParams(e,t,r){return oe(this,void 0,void 0,(function*(){const i=e,a=this.mergeQueryParams(r,{objectIds:i});return t?t.queryAll(a):this.queryAll(a)}))}deleteOneLoadedRecordById(e,t){const r=e.getPagesData();return Object.keys(r).some((i=>{var a;const s=null===(a=r[i])||void 0===a?void 0:a.findIndex((e=>(null==e?void 0:e.getId())===t));return"number"==typeof s&&s>-1&&(r[i].splice(s,1),null!=e.count&&e.count--,!0)}))}setOnceSetSourceRecords(e){this.onceSetSourceRecords=e}getAllUsedFields(e){return super.getAllUsedFields(e)}}var ye=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};const Se="data_source_id_for_record",ge="is_record_data_a_proxy";class ve extends m{constructor(e,t,r){super(),this._id=null,this.dataSource=t,null==e.attributes[t.getIdField()]&&(this._id=(0,f.uuidv1)()),!1!==(null==r?void 0:r.isBeforeMappingData)?(e.attributes=this.convertBeforeMappingDataToData(e.attributes),this.feature=e):this.feature=e,this.hasFullGeometry=!1!==(null==r?void 0:r.hasFullGeometry),this.setProxyForData(),this.fillGeometry()}setProxyForData(){var e;if(!(null===(e=this.feature)||void 0===e?void 0:e.attributes)||!this.dataSource)return;if(this.feature.attributes[ge]&&this.feature.attributes[Se]===this.dataSource.id)return;const t=this.dataSource;this.feature.attributes=new Proxy(this.feature.attributes[ge]?Object.assign({},this.feature.attributes):this.feature.attributes,{get(e,r){var i;let a;return r in e?a=e[r]:"string"==typeof r&&(null===(i=t.getSchema())||void 0===i?void 0:i.fields)&&r in t.getSchema().fields?t.loadMissingFields(Object.assign(Object.assign({},t.getCurrentQueryParams()),{outFields:[r]}),!0):r===Se?a=t.id:r===ge&&(a=!0),a}})}set dataSource(e){this._dataSource=e,this.setProxyForData()}get dataSource(){return this._dataSource}fillGeometry(){var e,t;if(!this.feature.geometry)return;const r=this.dataSource;this.feature.geometry.spatialReference||(this.feature.geometry.spatialReference=null===(t=null===(e=r.getLayerDefinition())||void 0===e?void 0:e.extent)||void 0===t?void 0:t.spatialReference)}queryAttachments(e){let t=null;const r=this.dataSource;if(t=r&&r.getMainDataSource().url,!t)return Promise.resolve([]);const i={attachmentTypes:e,url:t,featureId:this.getId()};return this._queryAllAttachmentsPromise||(this._queryAllAttachmentsPromise=f.dataSourceUtils.queryAllAttachments(i)),this._queryAllAttachmentsPromise.then((e=>ye(this,void 0,void 0,(function*(){return this.attachmentInfos=e,f.dataSourceUtils.filterAttachments(e,i)}))))}fetchSymbolPreviewHTML(){return this._isGraphicFeature()?(this._getSymbolPreviewHTMLPromise||(this._getSymbolPreviewHTMLPromise=(0,f.loadArcGISJSAPIModules)(["esri/symbols/support/symbolUtils"]).then((e=>{let t=null;return[t]=e,t.getDisplayedSymbol(this.feature).then((e=>{const r=document.createElement("div");return r.className="w-100 h-100 d-flex justify-content-center align-items-center",t.renderPreviewHTML(e,{node:r})}))}))),this._getSymbolPreviewHTMLPromise):Promise.resolve(null)}getData(){return this.feature.attributes}setData(e){this.feature.attributes=e,this.setProxyForData(),this._getSymbolPreviewHTMLPromise=null,this._queryAllAttachmentsPromise=null}clone(e){const t=f.lodash.clone(this);return e?("esri.Graphic"===this.feature.declaredClass?t.feature=this.feature.clone():t.feature=f.lodash.cloneDeep(this.feature),t):t}getDateFieldValue(e){const t=this.getFieldValue(e);return f.dataSourceUtils.getDateFieldValue(t,this.dataSource)}getFormattedFieldValue(e,t){const r=this.dataSource,i=r&&r.getLayerDefinition&&r.getLayerDefinition();if(!i)return super.getFormattedFieldValue(e,t);const a=f.dataSourceUtils.getDisplayValueForCodedValueOrSubtype(i,e,this.getData());return a.isCodedValueOrSubtype?a.displayValue:super.getFormattedFieldValue(e,t)}getDataBeforeMapping(){return this.convertDataToDataBeforeMapping(this.getData())}getOriginData(){const e=Object.assign({},this.feature);return e.attributes=this.convertDataToDataBeforeMapping(this.getData()),e}toJson(){return this.feature}getId(){return this._id||this.feature.attributes[this.dataSource.getIdField()]+""}setId(e){}getGeometry(){var e;return"esri.Graphic"===this.feature.declaredClass?null===(e=this.feature.geometry)||void 0===e?void 0:e.toJSON():this.feature.geometry}getRawGeometry(){return this.feature.geometry}setGeometry(e){var t,r,i;if("esri.Graphic"===(null===(t=this.feature)||void 0===t?void 0:t.declaredClass)){const t=f.moduleLoader.getModuleSync("esri/geometry/Geometry");this.feature.geometry=(null===(r=null==e?void 0:e.declaredClass)||void 0===r?void 0:r.includes("esri.geometry"))?e:(null==t?void 0:t.fromJSON(e))||e}else this.feature.geometry=(null===(i=null==e?void 0:e.declaredClass)||void 0===i?void 0:i.includes("esri.geometry"))?e.toJSON():e}setFeature(e){this.feature=e,this.fillGeometry()}getFeature(){return this.feature}getJSAPIGraphic(){return f.dataSourceUtils.changeToJSAPIGraphic(this.feature)}_isGraphicFeature(){var e;return!!(null===(e=null==this?void 0:this.feature)||void 0===e?void 0:e.layer)}}var pe=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class fe extends(_(C(ae))){constructor(e){super(e),this.type=o.CSV;const t=this.getDataSourceJson();t.data?(this.records=t.data.asMutable().map((e=>new D(e,this))),this.setStatus(s.Loaded)):this.url=t.url,this.portalUrl=t.portalUrl,this.itemId=t.itemId,this.url&&f.requestUtils.registerCacheableUrl(this.url)}ready(){return pe(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}doLoad(){return pe(this,void 0,void 0,(function*(){return yield fetch(this.url).then((e=>pe(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>e.map((e=>new D(e,this)))))}))}}const me={maxPageSize:1e3,supportsStatistics:!0,supportsPagination:!0,supportsOrderBy:!0,supportsDistinct:!0,supportsPaginationOnDistinct:!0,supportsPaginationOnStatisticsWithGroupBy:!1,supportsPaginationOnAggregatedQueries:!0,supportsOrderByOnlyOnLayerFields:!0,supportsPercentileStatistics:!0,supportsReturningQueryExtent:!0,supportedQueryFormats:"JSON, geoJSON"};class De extends se{getQueryCapabilities(){var e,t,r,i,a,s,o,n,l;return this.isClientSide||!this.layerDefinition?me:{maxPageSize:this.layerDefinition.maxRecordCount,supportsStatistics:!!(null===(e=this.layerDefinition.advancedQueryCapabilities)||void 0===e?void 0:e.supportsStatistics),supportsPagination:!!(null===(t=this.layerDefinition.advancedQueryCapabilities)||void 0===t?void 0:t.supportsPagination),supportsOrderBy:!!(null===(r=this.layerDefinition.advancedQueryCapabilities)||void 0===r?void 0:r.supportsOrderBy),supportsDistinct:!!(null===(i=this.layerDefinition.advancedQueryCapabilities)||void 0===i?void 0:i.supportsDistinct),supportsPaginationOnDistinct:!1!==(null===(a=this.layerDefinition.advancedQueryCapabilities)||void 0===a?void 0:a.supportsPaginationOnAggregatedQueries),supportsPaginationOnStatisticsWithGroupBy:!!(null===(s=this.layerDefinition.advancedQueryCapabilities)||void 0===s?void 0:s.supportsPaginationOnAggregatedQueries),supportsOrderByOnlyOnLayerFields:!!(null===(o=this.layerDefinition.advancedQueryCapabilities)||void 0===o?void 0:o.supportsOrderByOnlyOnLayerFields),supportsPercentileStatistics:!!(null===(n=this.layerDefinition.advancedQueryCapabilities)||void 0===n?void 0:n.supportsPercentileStatistics),supportedQueryFormats:this.layerDefinition.supportedQueryFormats,supportsReturningQueryExtent:!1!==(null===(l=this.layerDefinition.advancedQueryCapabilities)||void 0===l?void 0:l.supportsReturningQueryExtent)}}}var Ie=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class Le extends(_(C(he))){constructor(e){var t;super(e);const r=this.getDataSourceJson();this.portalUrl=r.portalUrl,this.itemId=r.itemId,this.layerId=r.layerId,e.layer?this.layer=e.layer:e.belongToDataSource&&e.belongToDataSource.layer&&(this.layer=e.belongToDataSource.layer),this.getDataSourceJson().isDataInDataSourceInstance&&(this.url=null,this.itemId=null,this.portalUrl=null),this.url||this.setCapabilities(new De({layerDefinition:null,isClientSide:!0})),(null===(t=this.layer)||void 0===t?void 0:t.portalItem)&&this.setItemInfo(this.layer.portalItem.sourceJSON)}getIdField(){return this.getSchema().idField}getGeometryType(){const e=this.getLayerDefinition();return(null==e?void 0:e.type)===d.Table?null:this.getDataSourceJson().geometryType||(null==e?void 0:e.geometryType)}queryExtent(e,t){if(this.getCountStatus()===s.NotReady)return Promise.resolve({queryParams:(0,f.Immutable)(e),extent:null,sourceVersion:this.getSourceVersion()});if(this.useNoSelectionView()){const r=this.getMainDataSource().getDataView(f.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION);if(r)return r.queryExtent(e,t)}const r=this.getRealQueryParams(e,"query",t);return this.doQueryExtent((0,f.Immutable)(r))}doQuery(e,t){return Ie(this,void 0,void 0,(function*(){var r,i,a;if(this._printUseAllFieldsWarning(e.outFields),!this.getCapabilities())return Promise.reject("Unable to perform query. Waiting for layer capabilities.");if(!e||!t)return Promise.reject("Unable to perform query. Query parameter is null.");let s=null,o="";const n=this.getCapabilities().getQueryCapabilities(),l=e.merge(t);if(e.outStatistics){if(e.outStatistics.some((e=>e.statisticType.includes("percentile")))?n.supportsStatistics&&n.supportsPercentileStatistics:n.supportsStatistics){let t=e;if((null===(r=e.groupByFieldsForStatistics)||void 0===r?void 0:r.length)>0){if(n.supportsPaginationOnStatisticsWithGroupBy||(t=t.without("page").without("pageSize")),(null===(i=t.orderByFields)||void 0===i?void 0:i.length)>0){let r=!1;if(n.supportsOrderBy)if(n.supportsOrderByOnlyOnLayerFields){r=!t.orderByFields.some((t=>e.outStatistics.map((e=>e.outStatisticFieldName)).some((e=>t.split(" ").includes(e)))))}else r=!0;r||(t=t.without("orderByFields"))}}else t=e.without("page").without("pageSize").without("orderByFields");s=yield this.doQueryByCapabilities(t),s=this.enhanceStatisticQueryResult(s,t,l)}else o="Do not support statistic query."}else{const t=!((null===(a=e.orderByFields)||void 0===a?void 0:a.length)>0)||n.supportsOrderBy,r=!e.returnDistinctValues||n.supportsDistinct&&!!e.outFields;if(t&&r){const t=n.supportsPagination,r=!e.returnDistinctValues||n.supportsPaginationOnDistinct;t&&r?s=yield this.doQueryByCapabilities(e):e.returnDistinctValues?(s=yield this.doQueryByCapabilities(e.without("page").without("pageSize")),s.queryParams=e.set("page",1)):s=yield this.doQueryWithoutPagination(e)}else t?r||(n.supportsDistinct?e.outFields||(o="outFields should be specified for returnDistinctValues."):o="Do not support distinct."):o="Do not support orderBy."}return s||Promise.reject(`Unable to perform query. Please check your parameters. ${o}`)}))}applyUsedFields(e,t){var r;if(!t||(null==e?void 0:e.outStatistics))return e;const i=Object.assign({},e);if(!i.returnDistinctValues&&t&&(i.outFields="string"==typeof t?[t]:t),!i.returnDistinctValues&&i.outFields&&!i.outFields.includes("*")){const e=this.getIdField();e&&!i.outFields.includes(e)&&(i.outFields=i.outFields.concat(e))}if(i.outFields&&!i.outFields.includes("*")){const e=null===(r=this.getLayerDefinition())||void 0===r?void 0:r.typeIdField,t=this.findJimuFieldName(e);t&&!i.outFields.includes(t)&&(i.outFields=i.outFields.concat(t))}return i}getAllUsedFields(e){var t,r,i,a;"debug"===(null==e?void 0:e.logLevel)&&console.group("All used fields");const s=null==e?void 0:e.queryParams,o=this.getIdField();if(null==s?void 0:s.honorOutFields)return(null===(t=null==s?void 0:s.outFields)||void 0===t?void 0:t.includes("*"))||(null===(r=null==s?void 0:s.outFields)||void 0===r?void 0:r.includes(o))?s.outFields:((null==s?void 0:s.outFields)||[]).concat(o);let n=(null===(i=null==s?void 0:s.outFields)||void 0===i?void 0:i.includes("*"))?"*":(null==s?void 0:s.outFields)||[];if(!(null==s?void 0:s.returnDistinctValues)){const t=f.dataSourceUtils.getUsedFieldsFromFeatureLayerQueryParams(s,this,"feature");if("debug"===(null==e?void 0:e.logLevel)&&console.log("Query params used fields are:",t),t.includes("*"))n="*";else{const r=super.getAllUsedFields(e);n="*"===r?"*":Array.from(new Set([...r,...t]))}o&&"*"!==n&&!n.includes(o)&&n.push(o)}const l=null===(a=this.getLayerDefinition())||void 0===a?void 0:a.typeIdField,u=this.findJimuFieldName(l);return u&&"*"!==n&&!n.includes(u)&&n.push(u),"*"!==n&&n.length===Object.keys(this.getSchema().fields).length&&("debug"===(null==e?void 0:e.logLevel)&&console.warn("All used fields are * since used fields length equals schema fields length."),n="*"),"debug"===(null==e?void 0:e.logLevel)&&(console.log("All used fields are:",n),console.groupEnd()),n}doQueryWithoutPagination(e){return Ie(this,void 0,void 0,(function*(){var t;const r=e.without("page").without("pageSize").set("returnIdsOnly",!0),i=(null===(t=(yield this.doQueryByCapabilities(r)).records)||void 0===t?void 0:t.map((e=>e.getId())))||[],a="number"==typeof e.page?e.page:1,s="number"==typeof e.pageSize?e.pageSize:this.getQueryPageSize(),o=this.sliceByPage(i,s,a);if(0===o.length)return{queryParams:e,records:[],count:0};const n=e.without("page","pageSize","where","sqlFormat","geometry","geometryType","distance","units","outStatistics","groupByFieldsForStatistics","returnDistinctValues","time").set("objectIds",o),l=yield this.doQueryByCapabilities(n);return l.queryParams=e,l.exceededTransferLimit=i.length>o.length,l}))}doQueryByCapabilities(e){return Ie(this,void 0,void 0,(function*(){var t,r,i;let a={queryParams:e,records:[],sourceVersion:this.getSourceVersion()};if(this.getDataSourceJson().isDataInDataSourceInstance){if(this.getSourceRecords().length>0){const t=this.getSourceRecords();if(f.dataSourceUtils.areQueryParamsEmpty(e)){const{start:r,end:i}=this.getStartAndEndForPage(e.page,e.pageSize),s=null!==r&&null!==i?t.slice(r,i+1):t;a={queryParams:e,records:s,sourceVersion:this.getSourceVersion()}}else a=yield f.dataSourceUtils.createJSAPIFeatureLayerByRecords(this,t,this.getSourceVersion()).then((t=>Ie(this,[t],void 0,(function*({layer:t,sourceVersion:r}){const i=yield this.doQueryByLayerCapabilities(e,t);return Object.assign(Object.assign({},i),{sourceVersion:r})}))))}}else if(this.layer)a=yield this.doQueryByLayerCapabilities(e,this.layer);else if(this.url){if("define"in window&&"function"==typeof window.define&&"amd"in window.define&&!this.layerForRestQuery&&(yield this.createLayerForRestQuery()),this.layerForRestQuery)a=yield this.doQueryByLayerCapabilities(e,this.layerForRestQuery);else{a=yield this.doQueryByUrlCapabilities(e,this.url);"pbf"===((null===(i=null===(r=null===(t=this.getCapabilities().getQueryCapabilities().supportedQueryFormats)||void 0===t?void 0:t.toLowerCase)||void 0===r?void 0:r.call(t))||void 0===i?void 0:i.includes("pbf"))?"pbf":"json")&&this.createLayerForRestQuery()}}else a=yield this.createJSAPILayerByFeatureCollectionItemId().then((t=>this.doQueryByLayerCapabilities(e,t)));return a}))}createLayerForRestQuery(){return this.isDataView||this.isLocal?this.getMainDataSource().createLayerForRestQuery():this.layerForRestQuery?Promise.resolve():(this.layerForRestQueryPromise||(this.layerForRestQueryPromise=this.createJSAPILayerByDataSource(this,!1).then((e=>{this.layerForRestQuery=e,this.getAllDerivedDataSources().forEach((t=>{t.layerForRestQuery=e}))})).catch((e=>{console.warn("Failed to create JS API layer to do query.",e)}))),this.layerForRestQueryPromise)}enhanceStatisticQueryResult(e,t,r){var i,a;let s=null===(i=e.records)||void 0===i?void 0:i.slice();if(!s)return e;let o=e.queryParams;if(null==r?void 0:r.outStatistics){if(r.orderByFields&&!(null==t?void 0:t.orderByFields)&&(s=s.length>1?this.sortRecordsByFields(s,r.orderByFields):s,o=o.set("orderByFields",r.orderByFields)),"number"==typeof r.pageSize&&"number"!=typeof(null==t?void 0:t.pageSize)){const e=null!==(a=r.page)&&void 0!==a?a:1;s=this.sliceByPage(s,r.pageSize,e),o=o.set("pageSize",r.pageSize),o=o.set("page",r.page)}r.outStatistics.every((e=>!(null==e?void 0:e.outStatisticFieldName)||s.some((t=>void 0!==t.getFieldValue(e.outStatisticFieldName)))))||r.outStatistics.forEach((e=>{if(null==e?void 0:e.outStatisticFieldName){const t=s.some((t=>void 0!==t.getFieldValue(e.outStatisticFieldName.toLowerCase()))),r=s.some((t=>void 0!==t.getFieldValue(e.outStatisticFieldName.toUpperCase())));s.forEach((i=>{const a=t?e.outStatisticFieldName.toLowerCase():r?e.outStatisticFieldName.toUpperCase():null;a&&(i.feature.attributes[e.outStatisticFieldName]=i.getFieldValue(a),delete i.feature.attributes[a])}))}}))}return Object.assign(Object.assign({},e),{records:s,queryParams:o})}sliceByPage(e,t,r){const i=t*(r-1),a=i+t;return e.slice(i,a)}sortRecordsByFields(e,t){return e.filter((e=>!!e)).sort(((e,r)=>this.compareRecordsByFields(e,r,t)))}compareRecordsByFields(e,t,r){var i,a;let s=0,o=0;for(;s<r.length;){const n=r[s].split(" ")[0];let l=0;if(r[s].split(" ").length>2)l=0;else if(typeof e.getFieldValue(n)!=typeof t.getFieldValue(n)){const r=null===(a=null===(i=this.getSchema())||void 0===i?void 0:i.fields)||void 0===a?void 0:a[n],s=((null==r?void 0:r.type)||f.JimuFieldType.Number)===f.JimuFieldType.String?"string":"number",o=typeof e.getFieldValue(n)===s,u=typeof t.getFieldValue(n)===s;l=o&&!u?1:!o&&u?-1:0}else{const r=e.getFieldValue(n),i=t.getFieldValue(n);l=this.getCompareValueResult(r,i)}if(o="DESC"===r[s].split(" ")[1]?-l:l,0!==o)break;s++}return o}getCompareValueResult(e,t){let r=0;return"string"==typeof e&&"string"==typeof t?r=e.localeCompare?e.localeCompare(t):0:"number"==typeof e&&"number"==typeof t&&(r=e-t),r}doQueryCount(e){return Ie(this,void 0,void 0,(function*(){const t=null==e?void 0:e.without("page","pageSize","orderByFields","returnIdsOnly");if(this.getDataSourceJson().isDataInDataSourceInstance){if(0===this.getSourceRecords().length)return Promise.resolve({queryParams:e,count:0,sourceVersion:this.getSourceVersion()});const r=this.getSourceRecords();if(f.dataSourceUtils.areQueryParamsEmpty(t))return Promise.resolve({queryParams:e,count:r.length,sourceVersion:this.getSourceVersion()});const{layer:i,sourceVersion:a}=yield f.dataSourceUtils.createJSAPIFeatureLayerByRecords(this,r,this.getSourceVersion()),s=yield this.doQueryCountByLayer(t,i);return Object.assign(Object.assign({},s),{queryParams:e,sourceVersion:a})}{let r;return r=this.layer?yield this.doQueryCountByLayer(t,this.layer):this.url?yield this.doQueryCountByUrl(t,this.url):yield this.createJSAPILayerByFeatureCollectionItemId().then((e=>this.doQueryCountByLayer(t,e))),Object.assign(Object.assign({},r),{queryParams:e})}}))}doQueryIds(e){return Ie(this,void 0,void 0,(function*(){if(this.getDataSourceJson().isDataInDataSourceInstance){if(0===this.getSourceRecords().length)return Promise.resolve({queryParams:e,ids:[],sourceVersion:this.getSourceVersion()});const t=this.getSourceRecords();return f.dataSourceUtils.areQueryParamsEmpty(e)?Promise.resolve({queryParams:e,ids:t.map((e=>e.getId())),sourceVersion:this.getSourceVersion()}):f.dataSourceUtils.createJSAPIFeatureLayerByRecords(this,t,this.getSourceVersion()).then((t=>Ie(this,[t],void 0,(function*({layer:t,sourceVersion:r}){const i=yield this.doQueryIdsByLayer(e,t);return Object.assign(Object.assign({},i),{sourceVersion:r})}))))}return this.layer?this.doQueryIdsByLayer(e,this.layer):this.url?this.doQueryIdsByUrl(e,this.url):this.createJSAPILayerByFeatureCollectionItemId().then((t=>this.doQueryIdsByLayer(e,t)))}))}doQueryExtent(e){return Ie(this,void 0,void 0,(function*(){if(!this.getCapabilities().getQueryCapabilities().supportsReturningQueryExtent)return Promise.reject("Unable to perform extent query.");if(this.getDataSourceJson().isDataInDataSourceInstance){if(0===this.getSourceRecords().length)return Promise.resolve({queryParams:e,extent:null,count:0,sourceVersion:this.getSourceVersion()});const t=this.getSourceRecords();return f.dataSourceUtils.createJSAPIFeatureLayerByRecords(this,t,this.getSourceVersion()).then((t=>Ie(this,[t],void 0,(function*({layer:t,sourceVersion:r}){const i=yield this.doQueryExtentByLayer(e,t);return Object.assign(Object.assign({},i),{sourceVersion:r})}))))}return this.layer?this.doQueryExtentByLayer(e,this.layer):this.url?this.doQueryExtentByUrl(e,this.url):this.createJSAPILayerByFeatureCollectionItemId().then((t=>this.doQueryExtentByLayer(e,t)))}))}doQueryExtentByLayer(e,t){return Ie(this,void 0,void 0,(function*(){const r=this.getLayerViewForClientSideQuery(t);let i,a=!1;if(r){const t=yield r.clientQueryExtent(e);(null==t?void 0:t.success)&&(a=!0,i=t.data)}if(!a){const r=yield this.changeJimuQueryToJSAPIQuery(e);i=yield this.jsAPILayerQueryExtent(r,t)}return{queryParams:e,count:i.count,extent:i.extent}}))}doQueryExtentByUrl(e,t){return Ie(this,void 0,void 0,(function*(){const r=this.changeJimuQueryToRestAPIQuery(e);return delete r.resultRecordCount,delete r.resultOffset,delete r.returnIdsOnly,r.returnExtentOnly||(r.returnExtentOnly=!0),yield this._q(r,t).then((t=>({queryParams:e,count:t.count,extent:t.extent})))}))}doQueryCountByLayer(e,t){return Ie(this,void 0,void 0,(function*(){const r=this.getLayerViewForClientSideQuery(t);let i,a=!1;if(r){const t=yield r.clientQueryFeatureCount(e);(null==t?void 0:t.success)&&(a=!0,i=t.data)}if(!a){const r=yield this.changeJimuQueryToJSAPIQuery(e);i=yield this.jsAPILayerQueryFeatureCount(r,t)}return{queryParams:e,count:i}}))}doQueryCountByUrl(e,t){return Ie(this,void 0,void 0,(function*(){const r=this.changeJimuQueryToRestAPIQuery(e);return r.returnCountOnly||(r.returnCountOnly=!0),yield this._q(r,t).then((t=>({queryParams:e,count:t.count})))}))}doQueryIdsByLayer(e,t){return Ie(this,void 0,void 0,(function*(){const r=yield this.changeJimuQueryToJSAPIQuery(e),i=this.getLayerViewForClientSideQuery(t);let a,s=!1;if(i){const t=yield i.clientQueryObjectIds(e);(null==t?void 0:t.success)&&(s=!0,a=t.data)}return s||(a=yield this.jsAPILayerQueryObjectIds(r,t)),a||(a=[]),{queryParams:e,ids:a.map((e=>`${e}`))}}))}doQueryIdsByUrl(e,t){return Ie(this,void 0,void 0,(function*(){const r=this.changeJimuQueryToRestAPIQuery(e);return delete r.resultRecordCount,delete r.resultOffset,delete r.returnCountOnly,delete r.returnGeometry,r.returnIdsOnly||(r.returnIdsOnly=!0),this._q(r,t).then((t=>{var r;return{queryParams:e,ids:null===(r=t.objectIds)||void 0===r?void 0:r.map((e=>`${e}`))}}))}))}doQueryById(e,t){const r=t||["*"];return this.doQueryByCapabilities((0,f.Immutable)({objectIds:[e],returnGeometry:!0,returnZ:!0,outFields:r,notAddFieldsToClient:!0})).then((e=>e.records[0]))}getConfigQueryParams(){var e;const t=this.getDataViewConfig();if(!t)return null;return{where:f.dataSourceUtils.getArcGISSQL(t.where,this).sql,sqlExpression:null===(e=t.where)||void 0===e?void 0:e.asMutable({deep:!0}),orderByFields:this.getOrderByArray(t.orderBy)}}mergeQueryParams(...e){let t=(e=e||[]).filter((e=>e)).reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{});const r=e.map((e=>null==e?void 0:e.time)).filter((e=>"number"==typeof e||Array.isArray(e))),i=r.length>1?r.reduce(((e,t)=>f.dataSourceUtils.mergeTimeExtent(e,t)),null):r[0];if(delete t.time,-1===i)return t.where="1=2",t;("number"==typeof i||Array.isArray(i))&&(t.time=i);const a=e.map((e=>null==e?void 0:e.where)).filter((e=>e)),s=a.length>1?a.map((e=>`(${e})`)).join(" and "):a[0];t=Object.assign(Object.assign({},t),{where:s?`${s}`:""});const o=e.map((e=>null==e?void 0:e.sqlExpression)).filter((e=>e)),n=o.length>1?o.reduce(((e,t)=>f.dataSourceUtils.getMergedSQLExpressions([e,t],this)),null):o[0];if(t=Object.assign(Object.assign({},t),{sqlExpression:n}),t.returnDistinctValues){const r=e.reverse().find((e=>null==e?void 0:e.returnDistinctValues));t=Object.assign(Object.assign({},t),{outFields:r.outFields})}else{const r=e.map((e=>null==e?void 0:e.outFields)).filter((e=>e)),i=r.length>1?Array.from(new Set(r.reduce(((e,t)=>e.concat(t)),[]))):r[0];t=Object.assign(Object.assign({},t),{outFields:(null==i?void 0:i.includes("*"))?["*"]:i})}return t}getCurrentQueryParams(e){const t=super.getCurrentQueryParams(e);return this.applyGDBVersionAndFix(t,null==e?void 0:e.dataSourceToFormatSql)}getRealQueryParams(e,t,r){const i=super.getRealQueryParams(e,t,r);return this.applyGDBVersionAndFix(i,null==r?void 0:r.dataSourceToFormatSql)}getRemoteQueryParams(){return this.getSchema().filter?{where:this.getSchema().filter}:null}applyGDBVersionAndFix(e,t){this.getGDBVersion()&&(e.gdbVersion=this.getGDBVersion());let r=this.fixQueryParam((0,f.Immutable)(e));return r.sqlExpression&&t&&t.isSqlCaseSensitive!==this.isSqlCaseSensitive&&(r=r.set("where",f.dataSourceUtils.getArcGISSQL(r.sqlExpression,t).sql)),r.asMutable({deep:!0})}fixQueryParam(e){var t,r,i,a;let s=e;if(e.outStatistics&&Object.keys(e).forEach((e=>{["outStatistics","where","gdbVersion","geometry","geometryType","spatialRel","distance","units","groupByFieldsForStatistics","time","orderByFields","havingClause","page","pageSize"].includes(e)||(s=s.without(e))})),e.returnDistinctValues&&e.returnGeometry&&(s=s.set("returnGeometry",!1)),!e.returnDistinctValues&&e.returnGeometry&&(s=s.set("returnZ",!0)),!s.outStatistics&&!s.returnDistinctValues&&(null===(t=s.orderByFields)||void 0===t?void 0:t.length)>0){!!s.orderByFields.find((e=>e.split(" ")[0]===this.getIdField()))||(s=s.set("orderByFields",s.orderByFields.concat([`${this.getIdField()} ASC`])))}return s.returnDistinctValues&&(null===(r=s.outFields)||void 0===r?void 0:r.length)&&!(null===(i=s.orderByFields)||void 0===i?void 0:i.length)&&(s=s.set("orderByFields","*"===s.outFields[0]?[`${this.getIdField()} ASC`]:[s.outFields[0]])),f.dataSourceUtils.areDatesInUnknownTimezone(this)&&(s=s.set("timeReferenceUnknownClient",!0)),(null===(a=s.outFields)||void 0===a?void 0:a.some((e=>!e)))&&(s=s.set("outFields",s.outFields.filter((e=>!!e)))),s}fetchSchema(){return Ie(this,void 0,void 0,(function*(){if(this.getDataSourceJson().isStatistic||!this.url&&!this.itemId&&!this.layer)return Promise.resolve((0,f.Immutable)({}));let e;return e=this.layer?yield this.fetchSchemaWithLayer():yield this.fetchSchemaWithoutLayer(),(null==e?void 0:e.fields)&&Object.keys(e.fields).length?e:Promise.reject(new p(this.id,"No fields."))}))}createJSAPILayerByFeatureCollectionItemId(){return Ie(this,void 0,void 0,(function*(){return this.createFeatureLayerPromise||(this.itemId?this.createFeatureLayerPromise=(0,f.loadArcGISJSAPIModules)(["esri/layers/Layer","esri/portal/PortalItem"]).then((e=>Ie(this,void 0,void 0,(function*(){const t=e[0],r=e[1];return yield t.fromPortalItem({portalItem:new r({id:this.itemId,portal:{url:this.portalUrl}})})})))).then((e=>Ie(this,void 0,void 0,(function*(){return(null==e?void 0:e.type)===y.FeatureLayer?yield Promise.resolve(e):(null==e?void 0:e.type)===y.GroupLayer?yield e.loadAll().then((e=>Ie(this,void 0,void 0,(function*(){const t=e.layers.toArray().find((e=>`${e.layerId}`===this.layerId||f.dataSourceUtils.fixLayerId(e.title)===f.dataSourceUtils.fixLayerId(this.getMainDataSource().getDataSourceJson().sourceLabel)));return(null==t?void 0:t.type)===y.FeatureLayer?Promise.resolve(t):Promise.reject("Feature layer data source error: failed to create feature layer with specific layer id.")})))):void 0})))):this.createFeatureLayerPromise=Promise.reject("No item id.")),this.createFeatureLayerPromise}))}fetchSchemaWithoutLayer(){return Ie(this,void 0,void 0,(function*(){const e=this.url?f.ServiceManager.getInstance().fetchServiceInfo(this.url):Promise.resolve(null);return yield e.then((e=>this.itemId?Promise.all([this.fetchItemData(),this.fetchItemInfo()]).then((([t,r])=>{var i;const a=t&&t.layers&&(t.layers.find((e=>`${e.id}`===this.layerId))||t.layers[this.layerId]),s=(null==e?void 0:e.definition)?this.getUpdatedLayerDefinition(a,e.definition):null==a?void 0:a.layerDefinition;return!this.parentDataSource&&s&&(s.name=(null==r?void 0:r.title)||s.name),{serviceDefinition:s,fieldInfos:a&&a.popupInfo&&a.popupInfo.fieldInfos,filter:(null===(i=null==a?void 0:a.layerDefinition)||void 0===i?void 0:i.definitionExpression)?`(${a.layerDefinition.definitionExpression})`:null,refreshInterval:60*(null==a?void 0:a.refreshInterval)}})):{serviceDefinition:null==e?void 0:e.definition,fieldInfos:null,filter:null,refreshInterval:null})).then((({serviceDefinition:e,fieldInfos:t,filter:r,refreshInterval:i})=>{var a,s,o;const n={fields:{},idField:(null==e?void 0:e.idField)||(null===(s=null===(a=null==e?void 0:e.fields)||void 0===a?void 0:a.find((e=>"esriFieldTypeOID"===e.type)))||void 0===s?void 0:s.name)||"OBJECTID",filter:r,refreshInterval:i,label:null==e?void 0:e.name};return this.setLayerDefinitionAndQueryCapabilities(e),null===(o=null==e?void 0:e.fields)||void 0===o||o.forEach((e=>{const r=t&&t.find((t=>t.fieldName===e.name)),i=f.dataSourceUtils.convertFieldToJimuField(e,r);i&&(n.fields[e.name]=i)})),(0,f.Immutable)(n)}))}))}fetchSchemaWithLayer(){return Ie(this,void 0,void 0,(function*(){return this.layer.load().then((()=>{var e,t,r;if(!this.layer.fields)return null;this.updateLayerDefinitionByLayer();const i={fields:{},idField:this.layer.objectIdField||(null===(t=null===(e=this.layer.fields)||void 0===e?void 0:e.find((e=>"oid"===e.type)))||void 0===t?void 0:t.name)||"OBJECTID",filter:this.layer.definitionExpression?`${this.layer.definitionExpression}`:null,refreshInterval:60*(null!==(r=this.layer.refreshInterval)&&void 0!==r?r:0),label:this.layer.title};return this.layer.fields.forEach((e=>{const t=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos&&this.layer.popupTemplate.fieldInfos.find((t=>t.fieldName===e.name)),r=f.dataSourceUtils.convertFieldToJimuField(e.toJSON(),null==t?void 0:t.toJSON());r&&(i.fields[e.name]=r)})),(0,f.Immutable)(i)}))}))}updateLayerDefinitionByLayer(){var e,t;let r=this.layer.sourceJSON;if(this.layer.type===y.SubtypeGroupLayer){let e;this.layer.sublayers.forEach((t=>{const i=t.renderer.toJSON();if(i.field1===r.subtypeField&&"uniqueValue"===i.type&&i.field1&&!i.field2)if(e){const t=i.uniqueValueInfos[0];e.uniqueValueInfos.push(t)}else e=i})),e&&(r=Object.assign({name:this.layer.title},r,{drawingInfo:{renderer:e}}))}else{const i=this.layer.renderer;if(i&&i.toJSON()){const a=i.toJSON();if("uniqueValue"===a.type){let i=(null===(e=this.layer.sourceJSON)||void 0===e?void 0:e.types)||[];a.field1!==(null===(t=this.layer.sourceJSON)||void 0===t?void 0:t.typeIdField)&&(i=[],a.uniqueValueInfos.forEach((e=>{i.push({id:e.value,name:e.label,domain:{}})}))),r=Object.assign({name:this.layer.title},r,{drawingInfo:{renderer:a},typeIdField:a.field1,types:i})}}}r&&["typeIdField","subtypeField"].forEach((e=>{r[e]&&r.fields&&!r.fields.filter((t=>t.name===r[e])).length&&r.fields.some((t=>t.name.toLowerCase()===r[e].toLowerCase()&&(r[e]=t.name,!0)))})),this.setLayerDefinitionAndQueryCapabilities(r)}getLayerDefinition(){return f.dataSourceUtils.getLayerDefinition(this)}setLayerDefinition(e){this.layerDefinition=e}getPopupInfo(){return f.dataSourceUtils.getPopupInfo(this)}setPopupInfo(e){this.popupInfo=e}getItemInfo(){return this.isDataView||this.isLocal?this.getMainDataSource().getItemInfo():super.getItemInfo()}setLayerDefinitionAndQueryCapabilities(e){this.setLayerDefinition(e),this.setCapabilities(new De({layerDefinition:this.getLayerDefinition(),isClientSide:!this.url}))}getCapabilities(){return super.getCapabilities()}buildRecord(e){return new ve(e,this)}getFieldCodedValueList(e,t){let r="";const i=this.getSchema().fields;return Object.keys(i).some((t=>t===e&&(r=i[t].name,!0))),f.dataSourceUtils.getCodedValueListForCodedValueOrSubtypeField(this.getLayerDefinition(),r,t)}getGDBVersion(){return this.getInfo().gdbVersion}changeGDBVersion(e){(0,f.getAppStore)().dispatch(f.appActions.changeDataSourceGDBVersion(this.id,e)),this.layer&&(this.layer.gdbVersion=e)}getUpdatedLayerDefinition(e,t){let r=t,i={};if(e&&e.layerDefinition){const r=e.layerDefinition.drawingInfo;if(r){if(r.renderer&&"uniqueValue"===r.renderer.type){let a=t.types;r.renderer.field1!==t.typeIdField&&(a=[],r.renderer.uniqueValueInfos.forEach((e=>{a.push({id:e.value,name:e.label,domain:{}})}))),i={defaultVisibility:e.layerDefinition.defaultVisibility,drawingInfo:e.layerDefinition.drawingInfo,typeIdField:r.renderer.field1,types:a}}}else e.layerDefinition.defaultVisibility!==t.defaultVisibility&&(i={defaultVisibility:e.layerDefinition.defaultVisibility})}return e&&e.title&&(i.name=e.title),r=Object.assign({},r,i),r}getOrderByArray(e){var t;return null!==(t=null==e?void 0:e.map((e=>e.jimuFieldName+" "+e.order)).asMutable())&&void 0!==t?t:[]}changeJimuQueryToRestAPIQuery(e){var t,r,i,a,s;if(!e)return null;const o=e.asMutable({deep:!0});if("number"==typeof o.pageSize){const e=null!==(t=o.page)&&void 0!==t?t:1;o.resultOffset=(e-1)*o.pageSize,o.resultRecordCount=o.pageSize,null!==this.getMaxRecordCount()&&(1===e?o.resultRecordCount=Math.min(this.getMaxRecordCount(),o.pageSize):e*o.pageSize>this.getMaxRecordCount()&&(o.resultRecordCount=this.getMaxRecordCount()-(e-1)*o.pageSize)),delete o.page,delete o.pageSize}return Array.isArray(o.orderByFields)&&(o.orderByFields=o.orderByFields.join(",")),Array.isArray(o.groupByFieldsForStatistics)&&(o.groupByFieldsForStatistics=o.groupByFieldsForStatistics.join(",")),Array.isArray(o.time)&&(o.time=o.time.join(",")),(null===(r=o.outStatistics)||void 0===r?void 0:r.some((e=>{var t;return null===(t=e.statisticParameters)||void 0===t?void 0:t.orderBy})))&&(o.outStatistics=o.outStatistics.map((e=>{var t;return(null===(t=e.statisticParameters)||void 0===t?void 0:t.orderBy)&&(e.statisticParameters.orderBy=e.statisticParameters.orderBy.toUpperCase()),e}))),(null===(i=o.objectIds)||void 0===i?void 0:i.length)&&(o.objectIds=o.objectIds.map((e=>+e)).filter((e=>!isNaN(e)))),(null===(a=o.outStatistics)||void 0===a?void 0:a.length)||(null===(s=o.outFields)||void 0===s?void 0:s.length)||(o.outFields=[this.getIdField()]),o}changeJimuQueryToJSAPIQuery(e){return Ie(this,void 0,void 0,(function*(){return yield f.dataSourceUtils.changeJimuArcGISQueryToJSAPIQuery(this,e)}))}doQueryByUrlCapabilities(e,t){const r=this.changeJimuQueryToRestAPIQuery(e);return r.returnCountOnly?(console.error("To query count, please use queryCount."),Promise.reject("To query count, please use queryCount.")):this._q(r,t).then((t=>{var r;const i=Object.keys(this.getSchema().fields).filter((e=>t.fields&&t.fields.find((t=>t.name===this.getSchema().fields[e].name))));return{queryParams:e,fields:i,records:(t.features?t.features.map((e=>new ve(e,this))):null===(r=t.objectIds)||void 0===r?void 0:r.map((e=>new ve({attributes:{[this.getIdField()]:e}},this))))||[],exceededTransferLimit:t.exceededTransferLimit}}))}doQueryByLayerCapabilities(e,t){return Ie(this,void 0,void 0,(function*(){var r;const i=yield this.changeJimuQueryToJSAPIQuery(e),a=this.getLayerViewForClientSideQuery(t);if(e.returnIdsOnly){let r;delete i.returnIdsOnly;let s=!1;if(a){const t=yield a.clientQueryObjectIds(e);(null==t?void 0:t.success)&&(s=!0,r=t.data)}s||(r=yield this.jsAPILayerQueryObjectIds(i,t));const o=null==r?void 0:r.map((e=>new ve({attributes:{[this.getIdField()]:e}},this))),n=[this.getIdField()];return{queryParams:e,records:o,fields:n}}{let s,o=!1,n=!0;if(a){let t=e;(null===(r=t.orderByFields)||void 0===r?void 0:r.length)||(t=t.set("orderByFields",[this.getIdField()]));const i=yield a.clientQueryFeatures(t);(null==i?void 0:i.success)&&(o=!0,s=i.data,n=i.hasFullGeometry)}o||(s=yield this.jsAPILayerQueryFeatures(i,t));const l=s.features.map((e=>new ve(e,this,{hasFullGeometry:n}))),u=Object.keys(this.getSchema().fields).filter((e=>s.fields&&s.fields.find((t=>t.name===this.getSchema().fields[e].name))));return{queryParams:e,records:l,fields:u,exceededTransferLimit:s.exceededTransferLimit}}}))}getLayerViewForClientSideQuery(e){var t,r;if(!(null===(t=this.getRootDataSource())||void 0===t?void 0:t.map)||e!==this.layer)return null;const i=f.moduleLoader.getModuleSync("jimu-arcgis"),a=null===(r=null==i?void 0:i.MapViewManager)||void 0===r?void 0:r.getInstance();return null==a?void 0:a.getJimuLayerViewForClientQuery(this.getMainDataSource())}_q(e,t){return Ie(this,void 0,void 0,(function*(){const r=Object.keys(e||{}).reduce(((t,r)=>"object"!=typeof e[r]?`${t}&${r}=${e[r]}`:`${t}&${r}=${JSON.stringify(e[r])}`),""),i=`${t}?${r}`.length>1500,a=Object.assign({url:t,httpMethod:i?"POST":"GET"},e);return a.timeReferenceUnknownClient&&(a.params={where:a.where||"1=1",outFields:a.outFields||"*",timeReferenceUnknownClient:!0}),f.requestUtils.requestWrapper(t,(e=>Ie(this,void 0,void 0,(function*(){return a.authentication=e,f.esri.restFeatureService.queryFeatures(a)}))),1)}))}getTimezone(){var e,t,r;if(f.dataSourceUtils.areDatesInUnknownTimezone(this))return"unknown";{const i=null===(e=(0,f.getAppStore)().getState().appConfig.attributes)||void 0===e?void 0:e.timezone;if(!i||i.type===f.TimezoneConfig.Device)return"device";if(i.type===f.TimezoneConfig.Specific)return i.value;if(i.type===f.TimezoneConfig.Data){if(!!!(null===(t=this.getRootDataSource())||void 0===t?void 0:t.map))return this.getLayerTimezone();{const e=null===(r=this.getRootDataSource().map.resourceInfo)||void 0===r?void 0:r.timeZone;if(!e||"system"===e)return"device";if("unknown"===e)return this.getLayerTimezone();if("string"==typeof e)return e}}}return null}getLayerTimezone(){var e,t;return(null===(t=null===(e=this.getLayerDefinition())||void 0===e?void 0:e.dateFieldsTimeReference)||void 0===t?void 0:t.timeZone)||null}allowToExportData(){var e,t;if(this.isDataView||this.isLocal)return this.getMainDataSource().allowToExportData();if(this.getDataSourceJson().isOutputFromWidget&&1===(null===(e=this.getDataSourceJson().originDataSources)||void 0===e?void 0:e.length)){const e=null===(t=this.getDataSourceJson().originDataSources[0])||void 0===t?void 0:t.dataSourceId,r=e&&this.dataSourceManager.getDataSource(e);return r?r.allowToExportData():(console.error("Origin data source is not created, allow to export data by default. Output data source id is ",this.id),Promise.resolve(!0))}return!this.getDataSourceJson().disableExport?this.allowToExportDataInRemote():Promise.resolve(!1)}allowToExportDataInRemote(){return Ie(this,void 0,void 0,(function*(){return this.allowExportRemoteCheckPromise||(this.allowExportRemoteCheckPromise=f.proxyUtils.isDataSourceSubscriberOrPremium(this.getDataSourceJson()).then((e=>!e&&(!f.dataSourceUtils.isAGOLHostedService(this.getDataSourceJson().url)||this.allowToExportDataInItem())))),this.allowExportRemoteCheckPromise}))}allowToExportDataInItem(){return Ie(this,void 0,void 0,(function*(){try{if(!this.itemId)return!0;const e=(0,f.getAppStore)().getState().user;if(!e)return this.getWhetherAllowToExportInItemSetting();let t=this.getItemInfo();t=(null==t?void 0:t.contentOrigin)?t:yield f.requestUtils.requestWrapper((0,f.getAppStore)().getState().portalUrl,(e=>f.esri.restPortal.getItem(this.itemId,{portal:f.portalUrlUtils.getPortalRestUrl((0,f.getAppStore)().getState().portalUrl),authentication:e}))).catch((e=>(console.warn("Failed to get item info via app portal url. ",e),t)));if("self"===(null==t?void 0:t.contentOrigin)){if("org_admin"===e.role)return!0;return!!(e&&(null==t?void 0:t.owner)===e.username)||this.getWhetherAllowToExportInItemSetting()}return this.getWhetherAllowToExportInItemSetting()}catch(e){return console.log(`Failed to get whether data source ${this.id} allows to export data, `,e),!0}}))}getWhetherAllowToExportInItemSetting(){return Ie(this,void 0,void 0,(function*(){var e;if(this.url){const t=yield f.requestUtils.requestWrapper(this.url,(e=>Ie(this,void 0,void 0,(function*(){return yield f.esri.restRequest.request(this.url,{authentication:e,httpMethod:"GET"})}))),1);return!!(null===(e=null==t?void 0:t.capabilities)||void 0===e?void 0:e.includes("Extract"))}return!0}))}supportSymbol(){return f.dataSourceUtils.supportSymbol(this)}supportAttachment(){return f.dataSourceUtils.supportAttachment(this)}supportTime(){return f.dataSourceUtils.supportTime(this)}getTimeInfo(){var e,t,r;if(this.layer){const r=this.layer.timeInfo;return(null===(e=this.getLayerDefinition())||void 0===e?void 0:e.timeInfo)&&r?f.lodash.merge(this.getLayerDefinition().timeInfo,r.toJSON()):(null==r?void 0:r.toJSON())||(null===(t=this.getLayerDefinition())||void 0===t?void 0:t.timeInfo)}return null===(r=this.getLayerDefinition())||void 0===r?void 0:r.timeInfo}setSourceFeatures(e,t){return Ie(this,void 0,void 0,(function*(){let r;if(null==e?void 0:e.some((e=>"esri.Graphic"!==(null==e?void 0:e.declaredClass)))){const t=yield(0,f.loadArcGISJSAPIModule)("esri/Graphic");r=e.map((e=>"esri.Graphic"===(null==e?void 0:e.declaredClass)?e:new t(e)))}else r=e;const i=yield f.dataSourceUtils.createJSAPIFeatureLayerByRecords(this,null==r?void 0:r.map((e=>this.buildRecord(e))),null,t);this._layer=i.layer,this.clearRecordsNotAddVersion(),this.addSourceVersion()}))}getDataViews(){return super.getDataViews()}getDataView(e){return super.getDataView(e)}getMainDataSource(){return super.getMainDataSource()}get layer(){return f.dataSourceUtils.getJSAPILayer(this)}set layer(e){this._layer=e}_printUseAllFieldsWarning(e){(null==e?void 0:e.includes("*"))&&f.lodash.defer((()=>{console.debug(`Using * as out fields to do query. Data source id is: ${this.id}`)}))}}var Ae=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};const{queryRelated:be}=f.esri.restFeatureService;class Pe extends Le{constructor(){super(...arguments),this.type=o.FeatureLayer}get isAssociatedFeatureLayer(){return!!this.getAssociatedDataSource()}get isSqlCaseSensitive(){return this.getAssociatedDataSource()?this.getAssociatedDataSource().isSqlCaseSensitive:this._isSqlCaseSensitive}set isSqlCaseSensitive(e){this._isSqlCaseSensitive=e}ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return Ae(this,void 0,void 0,(function*(){return e.ready.call(this).then((()=>this.replaceSubLayerWithFeatureLayer()))}))}jsAPILayerQueryObjectIds(e,t){const r=t||this.layer;return null==r?void 0:r.queryObjectIds(e)}jsAPILayerQueryFeatures(e,t){const r=t||this.layer;return null==r?void 0:r.queryFeatures(e)}jsAPILayerQueryExtent(e,t){const r=t||this.layer;return null==r?void 0:r.queryExtent(e)}jsAPILayerQueryFeatureCount(e,t){const r=t||this.layer;return null==r?void 0:r.queryFeatureCount(e)}get layer(){return f.dataSourceUtils.getJSAPILayer(this)}set layer(e){this._layer=e}get restLayer(){return f.dataSourceUtils.getRestAPILayer(this)}set restLayer(e){this._restLayer=e}setAssociatedDataSource(e){this.associatedDataSource=e}getAssociatedDataSource(){return this.associatedDataSource}isInAppConfig(){var e;return this.isAssociatedFeatureLayer?null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.isInAppConfig():super.isInAppConfig()}createRestAPILayerByDataSource(){return f.dataSourceUtils.createRestAPILayerByDataSource(this)}getCharts(){var e,t;const r=this.getMainDataSource();if(null==r?void 0:r.layer)return r.layer.charts;if(null==r?void 0:r.getItemData()){const i=null===(t=null===(e=r.getItemData())||void 0===e?void 0:e.layers)||void 0===t?void 0:t.find((e=>`${e.id}`===this.layerId));return null==i?void 0:i.charts}return[]}fetchSchema(){const e=Object.create(null,{fetchSchema:{get:()=>super.fetchSchema}});return Ae(this,void 0,void 0,(function*(){var t,r;return this.getAssociatedDataSource()||this.getDataSourceJson().isOutputFromWidget||"multipatch"!==(null===(t=this.layer)||void 0===t?void 0:t.geometryType)&&"mesh"!==(null===(r=this.layer)||void 0===r?void 0:r.geometryType)?e.fetchSchema.call(this):null}))}fetchSchemaWithLayer(){const e=Object.create(null,{fetchSchemaWithLayer:{get:()=>super.fetchSchemaWithLayer}});return Ae(this,void 0,void 0,(function*(){var t,r;let i=yield e.fetchSchemaWithLayer.call(this);return i.filter&&(null===(t=this.layer.customParameters)||void 0===t?void 0:t.where)?i=i.set("filter",`(${i.filter}) and (${this.layer.customParameters.where})`):(null===(r=this.layer.customParameters)||void 0===r?void 0:r.where)&&(i=i.set("filter",`${this.layer.customParameters.where}`)),i}))}createRelatedDataSources(){return Ae(this,void 0,void 0,(function*(){var e,t;if(this.relatedDataSources)return this.relatedDataSources;try{const r=this.getRootDataSource(),i=f.dataSourceUtils.getFullArcGISServiceUrl(this.url,!1);if(!r||!i)return[];const a=(null===(e=this.getLayerDefinition())||void 0===e?void 0:e.relationships)||[];let s=[];if(r.map){const e=r,t=e.map.allLayers.toArray(),i=e.map.allTables.toArray(),a=t.concat(i);for(const e of a)if("feature"===e.type)s.push(e);else if("map-image"===e.type){const t=e;s=s.concat(t.allSublayers.toArray())}}const o=[];for(const e of a){let a=this.parentDataSource,n=null===(t=null==a?void 0:a.getChildDataSourceId)||void 0===t?void 0:t.call(a,e.relatedTableId.toString());const l=s.find((t=>[t.layerId,t.id].includes(e.relatedTableId)&&f.dataSourceUtils.getFullArcGISServiceUrl(t.url,!1)===i));l&&(a=r,n=f.dataSourceUtils.getDataSourceIdByJSAPILayer(r,l)),n&&o.push(a.createDataSourceById(n))}const n=(yield Promise.allSettled(o)).filter((e=>"fulfilled"===e.status)).map((e=>e.value));this.relatedDataSources=n}catch(e){console.error(e)}return this.relatedDataSources}))}getRelatedDataSources(){return this.relatedDataSources}queryRelatedRecords(e,t){return Ae(this,arguments,void 0,(function*(e,t,r={},i=!1){var a,s;if(!Array.isArray(t)||0===t.length)return[];const o=null===(s=((null===(a=this.getLayerDefinition())||void 0===a?void 0:a.relationships)||[]).find((t=>{var r;return t.relatedTableId===(null===(r=null==e?void 0:e.getLayerDefinition())||void 0===r?void 0:r.id)})))||void 0===s?void 0:s.id;if(void 0===o)return[];const n=t.map((e=>parseInt(e))).filter((e=>!isNaN(e))),l=e.getRealQueryParams(r,"query"),{where:u,outFields:d,returnGeometry:c}=l,h=yield f.requestUtils.requestWrapper(this.url,(e=>Ae(this,void 0,void 0,(function*(){return yield be({url:this.url,relationshipId:o,objectIds:n,params:{definitionExpression:i||!u?"1=1":u,outFields:d,returnGeometry:c},authentication:e})}))),1);return((null==h?void 0:h.relatedRecordGroups)||[]).map((t=>({objectId:t.objectId,relatedRecords:t.relatedRecords.map((t=>e.buildRecord(t))),count:t.count})))}))}queryRelatedFieldValues(e,t,r){return Ae(this,void 0,void 0,(function*(){const i=null==e?void 0:e.map((e=>e.getId())),a=((yield this.queryRelatedRecords(t,i,{outFields:[r]},!0))||[]).reduce(((e,t)=>e.concat(t.relatedRecords.map((e=>e.getFieldValue(r))))),[]);return Array.from(new Set(a))}))}changeSelectionInUrl(e){const t=this.getMainDataSource();f.UrlManager.getInstance().changeHashObjectByDataSourceSelection(this.isAssociatedFeatureLayer?this.getAssociatedDataSource().getMainDataSource().id:t.id,e)}doAddRecordToServerSideSource(e){return this.layer?this.addRecordByLayer(e,this.layer):this.url?this.addRecordByUrl(e,this.url):this.createJSAPILayerByFeatureCollectionItemId().then((t=>this.addRecordByLayer(e,t)))}doDeleteOneRecordFromServerSideSource(e){return this.layer?this.deleteOneRecordByLayer(e,this.layer):this.url?this.deleteOneRecordByUrl(e,this.url):this.createJSAPILayerByFeatureCollectionItemId().then((t=>this.deleteOneRecordByLayer(e,t)))}doUpdateRecordsInServerSideSource(e){return this.layer?this.updateRecordsByLayer(e,this.layer):this.url?this.updateRecordsByUrl(e,this.url):this.createJSAPILayerByFeatureCollectionItemId().then((t=>this.updateRecordsByLayer(e,t)))}addRecordByLayer(e,t){return Ae(this,void 0,void 0,(function*(){const r=(yield f.dataSourceUtils.changeToJSAPIGraphic(e.feature)).clone();return t.applyEdits({addFeatures:[r]}).then((e=>{var t,i;const a=null===(t=e.addFeatureResults[0])||void 0===t?void 0:t.objectId;if("number"!=typeof a||(null===(i=e.addFeatureResults[0])||void 0===i?void 0:i.error))return Promise.reject("Adding record failed.");const s=this.getIdField();return r.attributes[s]=a,new ve(r,this)}))}))}addRecordByUrl(e,t){return Ae(this,void 0,void 0,(function*(){const r=f.dataSourceUtils.changeToRestAPIFeature(e.feature),i=Object.assign({},r),a={url:t,features:[i]};return yield f.requestUtils.requestWrapper(t,(e=>Ae(this,void 0,void 0,(function*(){return a.authentication=e,yield f.esri.restFeatureService.addFeatures(a).then((e=>{var t,r;const a=null===(t=e.addResults[0])||void 0===t?void 0:t.objectId;if("number"!=typeof a||!(null===(r=e.addResults[0])||void 0===r?void 0:r.success))return Promise.reject("Adding record failed.");const s=this.getIdField();return i.attributes[s]=a,new ve(i,this)}))}))),1)}))}updateRecordsByLayer(e,t){return Ae(this,void 0,void 0,(function*(){const r=yield Promise.all(e.map((e=>Ae(this,void 0,void 0,(function*(){return yield f.dataSourceUtils.changeToJSAPIGraphic(e.feature).then((e=>e.clone()))})))));return t.applyEdits({updateFeatures:r}).then((e=>e.updateFeatureResults.filter((e=>!e.error)).length>0))}))}updateRecordsByUrl(e,t){return Ae(this,void 0,void 0,(function*(){const r=e.map((e=>Object.assign({},f.dataSourceUtils.changeToRestAPIFeature(e.feature)))),i={url:t,features:r};return yield f.requestUtils.requestWrapper(t,(e=>Ae(this,void 0,void 0,(function*(){return i.authentication=e,yield f.esri.restFeatureService.updateFeatures(i).then((e=>e.updateResults.filter((e=>e.success)).length>0))}))),1)}))}deleteOneRecordByLayer(e,t){return Ae(this,void 0,void 0,(function*(){const r=(yield f.dataSourceUtils.changeToJSAPIGraphic(e.feature)).clone();return t.applyEdits({deleteFeatures:[r]}).then((e=>e.deleteFeatureResults.filter((e=>!e.error)).length>0))}))}deleteOneRecordByUrl(e,t){return Ae(this,void 0,void 0,(function*(){const r=Object.assign({},f.dataSourceUtils.changeToRestAPIFeature(e.feature)),i=this.getIdField(),a=r.attributes[i],s={url:t,objectIds:[a]};return yield f.requestUtils.requestWrapper(t,(e=>Ae(this,void 0,void 0,(function*(){return s.authentication=e,yield f.esri.restFeatureService.deleteFeatures(s).then((e=>e.deleteResults.filter((e=>e.success)).length>0))}))),1)}))}afterUpdateRecords(e){this.checkAndClearCacheNotAddVersion(),super.afterUpdateRecords(e)}afterUpdateRecord(e){this.checkAndClearCacheNotAddVersion(),super.afterUpdateRecord(e)}afterAddRecord(e){this.getMainDataSource().clearRecords(),this.getMainDataSource().getAllDerivedDataSources().forEach((e=>{e.clearRecords()})),this.getMainDataSource().addSourceVersion()}afterDeleteRecordsByIds(e){this.checkAndClearCacheNotAddVersion(),super.afterDeleteRecordsByIds(e)}afterDeleteRecordById(e){this.checkAndClearCacheNotAddVersion(),super.afterDeleteRecordById(e)}checkAndClearCacheNotAddVersion(){this.getMainDataSource().getAllDerivedDataSources().concat(this.getMainDataSource()).forEach((e=>{f.dataSourceUtils.areQueryParamsEmpty((0,f.Immutable)(e.lastQueryParams))||e.clearRecordsNotAddVersion(),f.dataSourceUtils.areQueryParamsEmpty((0,f.Immutable)(e.lastCountQueryParams))||e.clearCountNotAddVersion(),e.lastQueryId&&e.clearQueryByIdNotAddVersion()}))}replaceSubLayerWithFeatureLayer(){return Ae(this,void 0,void 0,(function*(){var e;if("esri.layers.support.Sublayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)&&this.layer.url){const e=yield(0,f.loadArcGISJSAPIModule)("esri/layers/FeatureLayer"),t=this.layer.definitionExpression||null;this.layer=new e({id:this.layer.id,title:this.layer.title,url:f.dataSourceUtils.getUrlByLayer(this.layer),renderer:this.layer.renderer,popupTemplate:this.layer.popupTemplate,sourceJSON:this.layer.sourceJSON,parent:this.layer.parent,definitionExpression:t}),this.getAllDerivedDataSources().forEach((e=>{e.clearRecords(),e.layer=this.layer})),yield this.layer.load()}return Promise.resolve(this)}))}}var Ce=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class Fe extends re{constructor(){super(...arguments),this.type=o.FeatureService}fetchServiceDefinition(){const e=Object.create(null,{fetchServiceDefinition:{get:()=>super.fetchServiceDefinition}});return Ce(this,void 0,void 0,(function*(){const[t,r]=yield Promise.all([e.fetchServiceDefinition.call(this),f.ServiceManager.getInstance().fetchServiceInfo(`${this.url}/layers`).then((e=>e.definition))]);return t.layers=r.layers,t.tables=r.tables,t}))}getChildIds(){return this.getChildIdsByUrl()}createChildDataSourceOptionsById(e,t,r){return this.createChildDataSourceOptionsByIdFromUrl(e,t,r)}createJSAPILayerByDataSource(e){const t=Object.create(null,{createJSAPILayerByDataSource:{get:()=>super.createJSAPILayerByDataSource}});return Ce(this,arguments,void 0,(function*(e,r=!0,i=!1){var a,s,o,n,l,u,d;const c=e||this;let h;try{c.areChildDataSourcesCreated()||(yield c.childDataSourcesReady());if((null===(s=null===(a=c.getItemInfo())||void 0===a?void 0:a.typeKeywords)||void 0===s?void 0:s.includes("Singlelayer"))||1===(null===(n=null===(o=c.getServiceDefinition())||void 0===o?void 0:o.layers)||void 0===n?void 0:n.length)){const e=c.getChildDataSources();if(0===e.length){const[e,t]=yield(0,f.loadArcGISJSAPIModules)(["esri/layers/Layer","esri/layers/GroupLayer"]),r=yield e.fromArcGISServerUrl({url:`${c.url}/${(null===(d=null===(u=null===(l=c.getServiceDefinition())||void 0===l?void 0:l.layers)||void 0===u?void 0:u[0])||void 0===d?void 0:d.id)||0}`});h=new t({layers:r.isTable?[]:[r],tables:r.isTable?[r]:[],title:c.getLabel()})}else{const t=(0,f.loadArcGISJSAPIModule)("esri/layers/GroupLayer"),r=e[0].layer?Promise.resolve(e[0].layer):e[0].createJSAPILayerByDataSource(),[i,a]=yield Promise.all([t,r]);h=new i({layers:a.isTable?[]:[a],tables:a.isTable?[a]:[],title:c.getLabel()})}}else h=yield t.createJSAPILayerByDataSource.call(this,e,r,i);this.afterCreateJSAPILayer(h,c)}catch(e){if(i)throw e;console.error("Failed to create JS API layer. ",e,this.id)}return"group"===(null==h?void 0:h.type)?h:null}))}}class Re extends re{constructor(e){super(e),this.type=o.GroupLayer,this.setItemData(e.itemData)}getChildIds(){return this.layer?this.getChildIdsByLayer():this.url?this.getChildIdsByUrl():this.itemId||this.getItemData()?this.getChildIdsByItem():[]}createChildDataSourceOptionsById(e,t,r){return this.layer?this.createChildDataSourceOptionsByIdFromLayer(e,t,r):this.url?this.createChildDataSourceOptionsByIdFromUrl(e,t,r):this.itemId||this.getItemData()?this.createChildDataSourceOptionsByIdFromItem(e,t,r):null}getChildIdsByLayer(){return this.isJSAPIGroupLayer(this.layer)?this.getChildIdsByJSAPIGroupLayer():this.getChildIdsByJSAPISubLayer()}getChildIdsByItem(){return this.isFeatureCollectionItem(this.getItemInfo())?this.getChildIdsByFeatureCollectionItem():this.getChildIdsByGroupLayerItem()}createChildDataSourceOptionsByIdFromLayer(e,t,r){if(this.layer){const i=this.isJSAPIGroupLayer(this.layer),a=i?this.findLayerInfoOfJSAPIGroupLayer(r):this.findLayerInfoOfJSAPISubLayer(r);if(!(null==a?void 0:a.layer))return null;if(i)return this.createChildDataSourceOptionsByLayer(a.layer,a.url,t,e,a.order);{const r=this.createChildDataSourceOptionsByLayerDefinition(a.layer.sourceJSON,a.url,t,e,a.order);return a.layer.title&&r.dataSourceJson&&(r.dataSourceJson=r.dataSourceJson.set("sourceLabel",a.layer.title)),r?Object.assign(Object.assign({},r),{layer:a.layer}):null}}return null}createChildDataSourceOptionsByIdFromItem(e,t,r){let i;if(this.isFeatureCollectionItem(this.getItemInfo())){const a=this.findLayerInfoOfFeatureCollectionItem(r);if(!(null==a?void 0:a.layerDefinition))return null;i=this.createChildDataSourceOptionsByLayerDefinition(a.layerDefinition,null,t,e,a.order),i&&!i.dataSourceJson.layerId&&(i.dataSourceJson=i.dataSourceJson.set("layerId",`${a.order}`))}else{const a=this.findLayerInfoOfGroupLayerItem(r);if(!(null==a?void 0:a.layerItem))return null;i=this.createChildDataSourceOptionsByLayerItem(a.layerItem,a.portalUrl,t,e,a.order)}return i}createChildDataSourceOptionsByLayerItem(e,t,r,i,a){const s=this.createChildDataSourceJsonByLayerItem(e,t,r,i);return s?{id:i,dataSourceJson:s,parentDataSource:this,jimuChildId:r,order:a,itemData:e}:null}createChildDataSourceJsonByLayerItem(e,t,r,i){var a,s,o;if(!e||!i)return null;const n=null===(s=null===(a=this.getDataSourceJson().schema)||void 0===a?void 0:a.childSchemas)||void 0===s?void 0:s[r];return Y(i,e,t,null===(o=this.getDataSourceJson().childDataSourceJsons)||void 0===o?void 0:o[r],n)}createChildDataSourceOptionsByLayer(e,t,r,i,a){const s=this.createChildDataSourceJsonByLayer(e,t,r,i);return s?{id:i,dataSourceJson:s,parentDataSource:this,jimuChildId:r,order:a,layer:e}:null}createChildDataSourceJsonByLayer(e,t,r,i){var a,s,o,n,l,u;if(!e||!i)return null;const d=e.sourceJSON,c=f.dataSourceUtils._getFixedLayerIdByLayerDefinition(d)||f.dataSourceUtils.getLabelFromArcGISServiceUrl(t),h=(null===(s=null===(a=this.getDataSourceJson().schema)||void 0===a?void 0:a.childSchemas)||void 0===s?void 0:s[r])||(null===(n=null===(o=this.getDataSourceJson().schema)||void 0===o?void 0:o.childSchemas)||void 0===n?void 0:n[c]);return k(i,e,(null===(l=this.getDataSourceJson().childDataSourceJsons)||void 0===l?void 0:l[r])||(null===(u=this.getDataSourceJson().childDataSourceJsons)||void 0===u?void 0:u[c]),h)}findLayerInfoOfJSAPIGroupLayer(e){let t;return this.getJSAPILayersAndTables().some(((r,i)=>{const a=f.dataSourceUtils.getUrlByLayer(r);return this.getChildIdByLayer(r)===e&&(t={layer:r,url:a,order:i},!0)})),t}findLayerInfoOfJSAPISubLayer(e){let t;return this.getJSAPISubLayers().some(((r,i)=>{const a=f.dataSourceUtils.getUrlByLayer(r);return this.getChildIdBySubLayer(r)===e&&(t={layer:r,url:a,order:i},!0)})),t}findLayerInfoOfGroupLayerItem(e){let t;return this.getLayersOfGroupLayerItem().some(((r,i)=>this.getChildIdByLayerItem(r)===e&&(t={layerItem:r,order:i,portalUrl:this.portalUrl},!0))),t}findLayerInfoOfFeatureCollectionItem(e){let t;return this.getLayersOfFeatureCollectionItem().some(((r,i)=>this.getChildIdByLayerDefinition(r,null)===e&&(t={layerDefinition:r,order:i},!0))),t}getJSAPISubLayers(){var e,t;return(null===(t=null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse())||[]}getJSAPILayersAndTables(){var e,t,r,i;const a=(null===(t=null===(e=this.layer.layers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse())||[],s=(null===(i=null===(r=this.layer.tables)||void 0===r?void 0:r.toArray())||void 0===i?void 0:i.reverse())||[];return a.concat(s)}getLayersOfFeatureCollectionItem(){var e,t;return(null===(t=null===(e=this.getItemData())||void 0===e?void 0:e.layers)||void 0===t?void 0:t.map((e=>e.layerDefinition)))||[]}getLayersOfGroupLayerItem(){var e;return(null===(e=this.getItemData())||void 0===e?void 0:e.layers)||[]}getChildIdsByJSAPISubLayer(){return this.getJSAPISubLayers().map((e=>this.getChildIdBySubLayer(e)))}getChildIdsByJSAPIGroupLayer(){return this.getJSAPILayersAndTables().map((e=>this.getChildIdByLayer(e)))}getChildIdsByFeatureCollectionItem(){return this.getLayersOfFeatureCollectionItem().map((e=>this.getChildIdByLayerDefinition(e,null)))}getChildIdsByGroupLayerItem(){return this.getLayersOfGroupLayerItem().map((e=>this.getChildIdByLayerItem(e)))}getChildIdByLayerItem(e){return f.dataSourceUtils.getFixedLayerIdByLayerDefinition(e)}isJSAPIGroupLayer(e){return(null==e?void 0:e.type)===y.GroupLayer}isFeatureCollectionItem(e){return(null==e?void 0:e.type)===h.FeatureCollection}}var Oe=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class we extends re{constructor(){super(...arguments),this.type=o.MapService}getChildIds(){return this.layer?this.getChildIdsByLayer():this.getChildIdsByUrl()}createChildDataSourceOptionsById(e,t,r){return this.layer?this.createChildDataSourceOptionsByIdFromLayer(e,t,r):this.url?this.createChildDataSourceOptionsByIdFromUrl(e,t,r):null}fetchServiceDefinition(){const e=Object.create(null,{fetchServiceDefinition:{get:()=>super.fetchServiceDefinition}});return Oe(this,void 0,void 0,(function*(){return this.layer?(yield this.layer.loadAll(),this.updateServiceDefinitionByLayer(),this.getServiceDefinition()):e.fetchServiceDefinition.call(this)}))}supportTime(){return f.dataSourceUtils.supportTime(this)}getTimeInfo(){var e,t;return this.layer?null===(e=this.layer.timeInfo)||void 0===e?void 0:e.toJSON():null===(t=this.getServiceDefinition())||void 0===t?void 0:t.timeInfo}getTimeExtent(){const e=this.getInfo().widgetQueries||{},t=Object.values(e).map((e=>null==e?void 0:e.time)).filter((e=>"number"==typeof e||Array.isArray(e)));return t.length>1?t.reduce(((e,t)=>f.dataSourceUtils.mergeTimeExtent(e,t)),null):t[0]}changeTimeExtent(e,t){var r,i;f.utils.isDeepEqual(e,null===(i=null===(r=this.getInfo().widgetQueries)||void 0===r?void 0:r[t])||void 0===i?void 0:i.time)||((0,f.getAppStore)().dispatch(f.appActions.updateWidgetQuery(this.id,t,{time:e})),this.getAllChildDataSources().forEach((r=>{r.type===o.FeatureLayer&&r.updateQueryParams({time:e},t)})))}changeGDBVersion(e){super.changeGDBVersion(e),this.layer&&"map-image"===this.layer.type&&(this.layer.gdbVersion=e)}createChildDataSourceOptionsByIdFromLayer(e,t,r){if(this.layer){const i=this.findSubLayerInfo(r);if(!(null==i?void 0:i.subLayer))return null;const a=this.createChildDataSourceOptionsByLayerDefinition(i.subLayer.sourceJSON,i.url,t,e,i.order);return i.subLayer.title&&a.dataSourceJson&&(a.dataSourceJson=a.dataSourceJson.set("sourceLabel",i.subLayer.title)),a?Object.assign(Object.assign({},a),{layer:i.subLayer}):null}return null}findSubLayerInfo(e){let t;return this.getSubLayers().some(((r,i)=>{const a=f.dataSourceUtils.getUrlByLayer(r);return this.getChildIdBySubLayer(r)===e&&(t={subLayer:r,url:a,order:i},!0)})),t}getSubLayers(){var e,t;return(null===(t=null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse())||[]}getChildIdsByLayer(){var e,t;return((null===(t=null===(e=this.layer)||void 0===e?void 0:e.sublayers)||void 0===t?void 0:t.toArray())||[]).map((e=>this.getChildIdBySubLayer(e)))}}var Te=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class Ve extends A{constructor(){super(...arguments),this.type=o.SimpleLocal}updateRecords(e){return this.records=e,this.addVersion(),Promise.resolve(!0)}addRecord(e){return Te(this,void 0,void 0,(function*(){return e.getId()||e.setId((0,f.uuidv1)()),this.records.push(e),this.addVersion(),yield Promise.resolve(e)}))}updateRecord(e){return Te(this,void 0,void 0,(function*(){const t=this.records.findIndex((t=>t.getId()===e.getId()));return this.records.splice(t,1,e),this.addVersion(),Promise.resolve(!0)}))}deleteRecord(e){return Te(this,void 0,void 0,(function*(){return this.records.splice(e,1),this.addVersion(),yield Promise.resolve(!0)}))}}var Be=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class Ee extends re{constructor(){super(...arguments),this.type=o.SceneService}getChildIds(){return this.getChildIdsByUrl()}createChildDataSourceOptionsById(e,t,r){return this.createChildDataSourceOptionsByIdFromUrl(e,t,r)}createJSAPILayerByDataSource(e){const t=Object.create(null,{createJSAPILayerByDataSource:{get:()=>super.createJSAPILayerByDataSource}});return Be(this,arguments,void 0,(function*(e,r=!0,i=!1){var a,s,o,n,l,u,d;const c=e||this;let h;try{c.areChildDataSourcesCreated()||(yield c.childDataSourcesReady());if((null===(s=null===(a=c.getItemInfo())||void 0===a?void 0:a.typeKeywords)||void 0===s?void 0:s.includes("Singlelayer"))||1===(null===(n=null===(o=c.getServiceDefinition())||void 0===o?void 0:o.layers)||void 0===n?void 0:n.length)){const e=c.getChildDataSources();if(0===e.length){const[e,t]=yield(0,f.loadArcGISJSAPIModules)(["esri/layers/Layer","esri/layers/GroupLayer"]);h=new t({layers:[yield e.fromArcGISServerUrl({url:`${c.url}/layers/${(null===(d=null===(u=null===(l=c.getServiceDefinition())||void 0===l?void 0:l.layers)||void 0===u?void 0:u[0])||void 0===d?void 0:d.id)||0}`})],title:c.getLabel()})}else{const t=(0,f.loadArcGISJSAPIModule)("esri/layers/GroupLayer"),r=e[0].layer?Promise.resolve(e[0].layer):e[0].createJSAPILayerByDataSource(),[i,a]=yield Promise.all([t,r]);h=new i({layers:[a],title:c.getLabel()})}}else h=yield t.createJSAPILayerByDataSource.call(this,e,r,i);this.afterCreateJSAPILayer(h,c)}catch(e){if(i)throw e;console.error("Failed to create JS API layer. ",e,this.id)}return"group"===(null==h?void 0:h.type)?h:null}))}}var Ue=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class Qe extends Le{constructor(e){var t,r,i;super(e),this.type=o.SceneLayer;const a=this.getDataSourceJson();if(this.portalUrl=a.portalUrl,this.itemId=a.itemId,this.layerId=a.layerId,e.layer&&(this.layer=e.layer),e.belongToDataSource&&e.belongToDataSource.layer&&(this.layer=e.belongToDataSource.layer),this.isLocal){const r=null===(t=e.belongToDataSource)||void 0===t?void 0:t.getAssociatedDataSource();r&&f.DataSourceManager.getInstance().createLocalDataSource(r,this.localId)}else if(this.isDataView){const t=null===(r=e.belongToDataSource)||void 0===r?void 0:r.getAssociatedDataSource();t&&f.DataSourceManager.getInstance().createDataView(t,this.dataViewId)}this.getAssociatedDataSource()&&((0,f.observeStore)(this.onInfoChange.bind(this),["dataSourcesInfo",this.getAssociatedDataSource().id]),this.getAssociatedDataSource().setAssociatedDataSource(this)),(null===(i=this.layer)||void 0===i?void 0:i.portalItem)&&this.setItemInfo(this.layer.portalItem.sourceJSON)}ready(){return Promise.all([super.ready(),this.fetchLayerDefinition(),this.createAssociatedDataSource()]).then((()=>this.getAssociatedDataSource()?(this.getInfo().widgetQueries&&Object.keys(this.getInfo().widgetQueries).length&&(0,f.getAppStore)().dispatch(f.appActions.updateDataSourceInfo(this.getAssociatedDataSource().id,this.getAssociatedDataSource().getInfo().set("widgetQueries",this.getInfo().widgetQueries))),Promise.resolve()):Promise.reject("Need associated feature layer."))).then((()=>{var e,t;this.getAssociatedDataSource()&&(0,f.observeStore)(this.onInfoChange.bind(this),["dataSourcesInfo",this.getAssociatedDataSource().id]),(null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.layer)&&(null===(t=this.layer)||void 0===t?void 0:t.popupTemplate)&&(this.getAssociatedDataSource().layer.popupTemplate=this.layer.popupTemplate)}))}jsAPILayerQueryObjectIds(e,t){const r=t||this.layer;return null==r?void 0:r.queryObjectIds(e)}jsAPILayerQueryFeatures(e,t){const r=t||this.layer;return null==r?void 0:r.queryFeatures(e)}jsAPILayerQueryExtent(e,t){const r=t||this.layer;return null==r?void 0:r.queryExtent(e)}jsAPILayerQueryFeatureCount(e,t){const r=t||this.layer;return null==r?void 0:r.queryFeatureCount(e)}onInfoChange(){this.getAssociatedDataSource()&&!f.utils.isDeepEqual(this.getInfo().without("instanceStatus"),this.getAssociatedDataSource().getInfo().without("instanceStatus"))&&(0,f.getAppStore)().dispatch(f.appActions.updateDataSourceInfo(this.id,this.getAssociatedDataSource().getInfo().without("instanceStatus").set("instanceStatus",this.getInfo().instanceStatus)))}createAssociatedDataSource(){return this.getAssociatedDataSource()?Promise.resolve(this.getAssociatedDataSource()):this.layer?this._createAssociatedDataSourceWithLayer().then((e=>e||this._createAssociatedDataSourceWithUrl())):this._createAssociatedDataSourceWithUrl()}_createAssociatedDataSourceWithLayer(){const e=this._getNewAssociatedDataSourceId();return this.layer.load().then((()=>{const t=this.layer.associatedLayer;if(!t)return null;this.layer.definitionExpression&&(t.definitionExpression=this.layer.definitionExpression);let r=(0,f.Immutable)({id:e,type:o.FeatureLayer,url:f.dataSourceUtils.getUrlByLayer(t)});r=this._mergeAssociatedDataSourceJson(r);const i={id:e,dataSourceJson:r,layer:t,associatedDataSource:this};return this.dataSourceManager.createDataSource(i)})).then((e=>(this.associatedDataSource=e,this.associatedDataSource)))}_createAssociatedDataSourceWithUrl(){const e=this._getNewAssociatedDataSourceId();return f.dataSourceUtils.fetchAssociatedFeatureLayerDefinition(this.url,this.layerId,this.itemId,this.portalUrl).then((t=>{if(!t)return Promise.reject("Can not find associated feature layer");let r=H(e,t.def,t.url);return r=this._mergeAssociatedDataSourceJson(r),r})).then((e=>{const t={id:e.id,dataSourceJson:e,associatedDataSource:this};return this.dataSourceManager.createDataSource(t)})).then((e=>(this.associatedDataSource=e,this.associatedDataSource)))}_getNewAssociatedDataSourceId(){return`${this.getDataSourceJson().id}-associated_data_source`}getTimezone(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getTimezone()}fetchLayerDefinition(){return Ue(this,void 0,void 0,(function*(){var e;try{const t=this.url;if(this.layer)yield this.layer.load(),this.layerDefinition={id:this.layer.layerId,fields:null===(e=this.layer.fields)||void 0===e?void 0:e.map((e=>null==e?void 0:e.toJSON()))};else if(this.url){const e=yield f.ServiceManager.getInstance().fetchServiceInfo(t).then((e=>e.definition)).then((e=>e||null));this.layerDefinition=e}return Promise.resolve(this.layerDefinition)}catch(e){return Promise.resolve(null)}}))}getLayerDefinition(){return f.dataSourceUtils.getLayerDefinition(this)}setLayerDefinition(e){this.layerDefinition=e}getPopupInfo(){return f.dataSourceUtils.getPopupInfo(this)}setPopupInfo(e){this.popupInfo=e}getCapabilities(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getCapabilities()}get layer(){return f.dataSourceUtils.getJSAPILayer(this)}set layer(e){this._layer=e}getItemInfo(){return this.isDataView||this.isLocal?this.getMainDataSource().getItemInfo():super.getItemInfo()}fetchSchema(){return Ue(this,void 0,void 0,(function*(){const e=yield f.dataSourceUtils.getOriginDataLabel(this),t=(0,f.Immutable)({label:e}),r=yield this.getAssociatedDataSource()?this.getAssociatedDataSource().fetchSchema():Promise.resolve(null);return r?r.merge(t):t}))}setDataSourceJson(e){if(super.setDataSourceJson(e),this.getAssociatedDataSource()){const e=this._mergeAssociatedDataSourceJson(this.getAssociatedDataSource().getDataSourceJson());this.getAssociatedDataSource().setDataSourceJson(e)}}getFetchedSchema(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getFetchedSchema()}setFetchedSchema(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setFetchedSchema(e)}getReversedConfigSchema(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getReversedConfigSchema()}getSelectedFields(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSelectedFields()}setSelectedFields(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setSelectedFields(e)}getIdField(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getIdField()}queryById(e){var t,r;return null!==(r=null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.queryById(e).then((e=>this.fixRecordDataSource(e))))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}addRecord(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.addRecord(e)}updateRecord(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.updateRecord(e)}updateRecords(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.updateRecords(e)}deleteRecord(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.deleteRecord(e)}deleteRecordById(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.deleteRecordById(e)}doQuery(e,t){return this.getAssociatedDataSource()?this.getAssociatedDataSource().doQuery(e,t).then((e=>{var t;return e.records=null===(t=e.records)||void 0===t?void 0:t.map((e=>this.fixRecordDataSource(e))),e})):Promise.reject(Error("No Associated DataSource."))}doQueryById(e,t){return this.getAssociatedDataSource()?this.getAssociatedDataSource().doQueryById(e,t).then((e=>this.fixRecordDataSource(e))):Promise.reject(Error("No Associated DataSource."))}doQueryIds(e){return this.getAssociatedDataSource()?this.getAssociatedDataSource().doQueryIds(e).then((e=>{var t;return e.records&&(e.records=null===(t=e.records)||void 0===t?void 0:t.map((e=>this.fixRecordDataSource(e)))),e})):Promise.reject(Error("No Associated DataSource."))}doQueryCount(e){var t,r;return null!==(r=null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.doQueryCount(e))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}getConfigQueryParams(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getConfigQueryParams()}getRemoteQueryParams(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getRemoteQueryParams()}getCurrentQueryParams(e){var t;return Array.isArray(null==e?void 0:e.exclude)?e.exclude.forEach((e=>{this.fixExcludeQuery(e)})):(null==e?void 0:e.exclude)&&this.fixExcludeQuery(e.exclude),null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getCurrentQueryParams(e)}getRuntimeQueryParams(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRuntimeQueryParams(e)}getCurrentQueryId(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getCurrentQueryId()}mergeQueryParams(...e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.mergeQueryParams(...e)}buildRecord(e){return new ve(e,this)}getFieldCodedValueList(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.getFieldCodedValueList(e,t)}getRealQueryParams(e,t,r){var i;return r&&this.fixQueryOptions(r),null===(i=this.getAssociatedDataSource())||void 0===i?void 0:i.getRealQueryParams(e,t,r)}getAllUsedFields(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getAllUsedFields(e)}applyUsedFields(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.applyUsedFields(e,t)}updateQueryParams(e,t){var r;null===(r=this.getAssociatedDataSource())||void 0===r||r.updateQueryParams(e,t)}getGDBVersion(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getGDBVersion()}getGeometryType(){return this.getAssociatedDataSource()?this.getAssociatedDataSource().getGeometryType():null}getQueryPageSize(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getQueryPageSize()}getMaxRecordCount(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getMaxRecordCount()}getRecordsByPage(e,t){var r,i;return null===(i=null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.getRecordsByPage(e,t))||void 0===i?void 0:i.map((e=>this.fixRecordDataSource(e)))}getPagesData(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getPagesData()}setPagesData(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setPagesData(e)}getRealQueryPages(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.getRealQueryPages(e,t)}load(e,t={}){var r,i;return t&&this.fixQueryOptions(t),null!==(i=null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.load(e,t).then((e=>null==e?void 0:e.map((e=>this.fixRecordDataSource(e))))))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}loadCount(e,t={}){var r,i;return t&&this.fixQueryOptions(t),null!==(i=null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.loadCount(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}query(e,t){var r,i;return t&&this.fixQueryOptions(t),null!==(i=null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.query(e,t).then((e=>{var t,r;return(null===(t=e.records)||void 0===t?void 0:t.length)?Object.assign(Object.assign({},e),{records:null===(r=e.records)||void 0===r?void 0:r.map((e=>this.fixRecordDataSource(e)))}):e})))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}queryAll(e,t,r,i){var a,s;return null!==(s=null===(a=this.getAssociatedDataSource())||void 0===a?void 0:a.queryAll(e,t,r,i).then((e=>{var t,r;return(null===(t=e.records)||void 0===t?void 0:t.length)?Object.assign(Object.assign({},e),{records:null===(r=e.records)||void 0===r?void 0:r.map((e=>this.fixRecordDataSource(e)))}):e})))&&void 0!==s?s:Promise.reject(Error("No Associated DataSource."))}queryCount(e,t){var r,i;return t&&this.fixQueryOptions(t),null!==(i=null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.queryCount(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}loadById(e,t){var r,i;return null!==(i=null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.loadById(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}changeGDBVersion(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.changeGDBVersion(e)}getAssociatedDataSource(){if(!this.isDataView&&!this.isLocal)return this.associatedDataSource;const e=this._getRealAssociatedDataSourceId();return f.DataSourceManager.getInstance().getDataSource(e)}getAssociatedDataSourceById(e){return this.dataSourceManager.getDataSource(e).getAssociatedDataSource()}fixQueryOptions(e){(null==e?void 0:e.excludeQuery)&&(Array.isArray(e.excludeQuery)?e.excludeQuery.forEach((e=>{this.fixExcludeQuery(e)})):this.fixExcludeQuery(e.excludeQuery))}fixExcludeQuery(e){(null==e?void 0:e.dataSourceId)&&this.getAssociatedDataSourceById(e.dataSourceId)&&(e.dataSourceId=this.getAssociatedDataSourceById(e.dataSourceId).id)}_getRealAssociatedDataSourceId(){var e;let t;const r=null===(e=this.belongToDataSource)||void 0===e?void 0:e.getAssociatedDataSource();return t=this.isLocal?f.DataSourceManager.getInstance().getLocalDataSourceId(null==r?void 0:r.id,this.localId):this.isDataView?f.DataSourceManager.getInstance().getDataViewDataSourceId(null==r?void 0:r.id,this.dataViewId):this.associatedDataSource.id,t}clearRecords(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.clearRecords()}setRecords(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setRecords(e)}getRecords(){var e,t;return null===(t=null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getRecords())||void 0===t?void 0:t.map((e=>this.fixRecordDataSource(e)))}setSourceRecords(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setSourceRecords(e)}getSourceRecords(){var e,t;return null===(t=null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSourceRecords())||void 0===t?void 0:t.map((e=>this.fixRecordDataSource(e)))}fixRecordDataSource(e,t=this){if(!e)return null;const r=e.clone();return r.dataSource=t,r}getSelectedRecords(){var e,t;return null===(t=null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSelectedRecords())||void 0===t?void 0:t.map((e=>this.fixRecordDataSource(e,this.getSelectionDataView())))}nextRecord(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.nextRecord()}prevRecord(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.prevRecord()}getRecord(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRecord(e)}getRecordById(e){var t;return this.fixRecordDataSource(null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRecordById(e))}clearRecordsNotAddVersion(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.clearRecordsNotAddVersion()}clearSelection(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.clearSelection()}addVersion(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.addVersion()}selectRecord(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.selectRecord(e)}selectRecords(e,t,r){var i,a;return(null===(i=e.records)||void 0===i?void 0:i.length)&&(e.records=e.records.map((e=>e.clone()))),null===(a=this.getAssociatedDataSource())||void 0===a?void 0:a.selectRecords(e)}selectRecordById(e,t){var r;null===(r=this.getAssociatedDataSource())||void 0===r||r.selectRecordById(e,null==t?void 0:t.clone())}selectRecordsByIds(e,t){var r;null===(r=this.getAssociatedDataSource())||void 0===r||r.selectRecordsByIds(e,null==t?void 0:t.map((e=>e.clone())))}destroy(){const e=this.getAssociatedDataSource();e&&this.dataSourceManager.destroyDataSource(e.id)}supportSymbol(){return f.dataSourceUtils.supportSymbol(this)}supportAttachment(){return f.dataSourceUtils.supportAttachment(this)}getDataViews(){return super.getDataViews()}getDataView(e){return super.getDataView(e)}getMainDataSource(){return super.getMainDataSource()}_mergeAssociatedDataSourceJson(e){return null==e?void 0:e.set("query",this.getDataSourceJson().query).set("dataViews",this.getDataSourceJson().dataViews).set("schema",this.getDataSourceJson().schema)}get count(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.count}set count(e){this.getAssociatedDataSource()&&(this.getAssociatedDataSource().count=e)}allowToExportData(){const e=!this.getDataSourceJson().disableExport;return Promise.resolve(e)}}var Me=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class Je extends Le{constructor(){super(...arguments),this.type=o.ImageryLayer}jsAPILayerQueryObjectIds(e,t){const r=t||this.layer;return null==r?void 0:r.queryObjectIds(e)}jsAPILayerQueryFeatures(e,t){const r=t||this.layer;return"imagery"===(null==r?void 0:r.type)?r.queryRasters(e):null==r?void 0:r.queryFeatures(e)}jsAPILayerQueryExtent(e,t){const r=t||this.layer;return"imagery"===(null==r?void 0:r.type)?Promise.reject("Imagery layer does not support to query extent."):null==r?void 0:r.queryExtent(e)}jsAPILayerQueryFeatureCount(e,t){const r=t||this.layer;return"imagery"===(null==r?void 0:r.type)?r.queryRasterCount(e):null==r?void 0:r.queryFeatureCount(e)}getGeometryType(){return"esriGeometryPolygon"}get layer(){return f.dataSourceUtils.getJSAPILayer(this)}set layer(e){this._layer=e}ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return Me(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource(null,!0,!0)),yield this.layer.load(),e.ready.call(this),Promise.resolve(this)}))}}var xe=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class je extends(_(C(A))){constructor(e){super(e),this.type=o.ImageryTileLayer,e.layer&&(this.layer=e.layer);const t=this.getDataSourceJson();this.portalUrl=t.portalUrl,this.itemId=t.itemId}getLayerDefinition(){return this.layerDefinition}setLayerDefinition(e){this.layerDefinition=e}supportTime(){return f.dataSourceUtils.supportTime(this)}getTimeInfo(){var e;const t=null===(e=this.getLayerDefinition())||void 0===e?void 0:e.timeInfo,r=this.layer.timeInfo;return t&&r?f.lodash.merge(t,r.toJSON()):(null==r?void 0:r.toJSON())||t}updateQueryParams(e,t){var r;e=e||null,f.utils.isDeepEqual(e||{},(null===(r=this.getInfo().widgetQueries)||void 0===r?void 0:r[t])||{})||(0,f.getAppStore)().dispatch(f.appActions.updateWidgetQuery(this.id,t,e))}getCurrentQueryParams(e){var t,r,i;const a=(null===(t=null==e?void 0:e.exclude)||void 0===t?void 0:t.dataSourceId)===this.id?null===(r=null==e?void 0:e.exclude)||void 0===r?void 0:r.widgetId:null,s=a?null===(i=this.getInfo().widgetQueries)||void 0===i?void 0:i.without(a):this.getInfo().widgetQueries;return this.getMergedWidgetTimes(s)}getMergedWidgetTimes(e){let t=e&&Object.keys(e)||[];return t=t.sort(((e,t)=>e.localeCompare(t,"en",{numeric:!0,sensitivity:"base"}))),this.mergeTimeParams(...t.map((t=>e[t])))}mergeTimeParams(...e){const t=(e=e||[]).filter((e=>e)).reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{}),r=e.map((e=>null==e?void 0:e.time)).filter((e=>"number"==typeof e||Array.isArray(e))),i=r.length>1?r.reduce(((e,t)=>f.dataSourceUtils.mergeTimeExtent(e,t)),null):r[0];return delete t.time,-1===i?t.time=[1,0]:("number"==typeof i||Array.isArray(i))&&(t.time=i),t}ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return xe(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),this.layer.sourceJSON&&this.setLayerDefinition(this.layer.sourceJSON),e.ready.call(this),Promise.resolve()}))}}var Ne=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class _e extends Le{constructor(){super(...arguments),this.type=o.OrientedImageryLayer}jsAPILayerQueryObjectIds(e,t){const r=t||this.layer;return null==r?void 0:r.queryObjectIds(e)}jsAPILayerQueryFeatures(e,t){const r=t||this.layer;return null==r?void 0:r.queryFeatures(e)}jsAPILayerQueryExtent(e,t){const r=t||this.layer;return null==r?void 0:r.queryExtent(e)}jsAPILayerQueryFeatureCount(e,t){const r=t||this.layer;return null==r?void 0:r.queryFeatureCount(e)}get layer(){return f.dataSourceUtils.getJSAPILayer(this)}set layer(e){this._layer=e}ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return Ne(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource(null,!0,!0)),yield this.layer.load(),e.ready.call(this),Promise.resolve(this)}))}}var Ge=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class qe extends(_(C(A))){constructor(e){super(e),this.type=o.VectorTileService,e.layer&&(this.layer=e.layer);const t=this.getDataSourceJson();this.portalUrl=t.portalUrl,this.itemId=t.itemId}ready(){return Ge(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}}var We=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class ke extends(_(C(A))){constructor(e){super(e),this.type=o.GeoJSON,e.layer&&(this.layer=e.layer);const t=this.getDataSourceJson();this.portalUrl=t.portalUrl,this.itemId=t.itemId,this.url&&f.requestUtils.registerCacheableUrl(this.url)}ready(){return We(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}}var $e=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class ze extends(_(C(A))){constructor(e){super(e),this.type=o.KML,e.layer&&(this.layer=e.layer);const t=this.getDataSourceJson();this.portalUrl=t.portalUrl,this.itemId=t.itemId,(this.url||this.portalUrl&&this.itemId)&&f.requestUtils.registerCacheableUrl(((e,t)=>{if("https://utility.arcgis.com/sharing/kml"!==e)return!1;const r=null==t?void 0:t.url;return r.includes(this.url)||r.includes(`${this.portalUrl}/sharing/rest/content/items/${this.itemId}`)}))}ready(){return $e(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}}var Ye=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class He extends(_(C(A))){constructor(e){super(e),this.type=o.WFS,e.layer&&(this.layer=e.layer);const t=this.getDataSourceJson();this.portalUrl=t.portalUrl,this.itemId=t.itemId}ready(){return Ye(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}}var Ke=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class Xe extends(_(C(A))){constructor(e){super(e),this.type=o.WMS,e.layer&&(this.layer=e.layer);const t=this.getDataSourceJson();this.portalUrl=t.portalUrl,this.itemId=t.itemId}ready(){return Ke(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}}var Ze=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class et extends(_(C(A))){constructor(e){super(e),this.type=o.WMTS,e.layer&&(this.layer=e.layer);const t=this.getDataSourceJson();this.portalUrl=t.portalUrl,this.itemId=t.itemId}ready(){return Ze(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}}class tt extends A{constructor(){super(...arguments),this.type=o.Error}}var rt=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class it extends(ee(Le)){constructor(){super(...arguments),this.type=o.SubtypeGroupLayer}ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return rt(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource(null,!0,!0)),yield this.layer.loadAll(),e.ready.call(this)}))}getChildIds(){var e;return null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray().map((e=>this.getChildIdByLayer(e)))}createChildDataSourceById(e,t,r){const i=this.findLayerInfo(r);return(null==i?void 0:i.layer)?this.createChildDataSourceByLayer(i.layer,t,e,i.order):Promise.reject(new p(e,"Can not find data source."))}selectRecordsByIds(e,t,r=!0){const i=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),a=t||e.map((e=>i.find((t=>(null==t?void 0:t.getId())===e))));this.copySelectionToDataView(a,r),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:e})}copySelectionToDataView(e,t=!0){if(super.copySelectionToDataView(e),t){const t={},r=this.getSubtypeField();null==e||e.forEach((e=>{if(e){const i=e.getFieldValue(r);t[i]||(t[i]=[]),t[i].push(e)}})),this.getMainDataSource().getChildDataSources().forEach((e=>{const r=t[e.getSubtypeCode()]||[];e.selectRecordsByIds(r.map((e=>e.getId())),r,!1)}))}}updateWidgetQueries(e,t){super.updateWidgetQueries(e,t),this.getMainDataSource().id===this.id?this.getChildDataSources().forEach((e=>{e.addSourceVersion()})):this.isSelectionView()&&this.getMainDataSource().getChildDataSources().forEach((e=>{const t=e.getSelectionDataView();t.load({returnGeometry:!0,pageSize:t.getSourceRecords().length},{widgetId:f.CONSTANTS.SELECTION_DATA_VIEW_ID}),t.loadCount({},{widgetId:f.CONSTANTS.SELECTION_DATA_VIEW_ID})}))}setDataSourceJson(e){const t=this.getDataSourceJson().query;super.setDataSourceJson(e),f.utils.isDeepEqual(null==e?void 0:e.query,t)||this.getChildDataSources().forEach((e=>{e.addSourceVersion()}))}getRemoteQueryParams(e=!0){var t,r,i;if(e){const e=super.getRemoteQueryParams(),a=null===(i=null===(r=null===(t=this.getSchema())||void 0===t?void 0:t.fields)||void 0===r?void 0:r[this.getSubtypeField()])||void 0===i?void 0:i.name,s={};this.getChildDataSources().forEach((e=>{const t=e.getRemoteQueryParams(!1),r=e.getConfigQueryParams(),i=this.mergeQueryParams(t,r);(null==i?void 0:i.where)&&(s[e.getSubtypeCode()]=i.where)}));const o=f.dataSourceUtils.mergeSubtypeSublayerWhereClausesToSubtypeGroupLayer(a,null,s);return this.mergeQueryParams({where:o},e)}return super.getRemoteQueryParams()}getRuntimeQueryParams(e,t=!0){return this.getRuntimeQueryParamsWithSpecificWidgetQueries(e,this.getInfo().widgetQueries,t)}getRuntimeQueryParamsWithSpecificWidgetQueries(e,t,r=!0){var i,a,s;const o=this.getMainDataSource().id===this.id;if(r&&(o||this.isSelectionView())){const r=super.getRuntimeQueryParamsWithSpecificWidgetQueries(e,t),n=null===(s=null===(a=null===(i=this.getSchema())||void 0===i?void 0:i.fields)||void 0===a?void 0:a[this.getSubtypeField()])||void 0===s?void 0:s.name,l={};this.getMainDataSource().getChildDataSources().forEach((e=>{const t=o?e.getRuntimeQueryParams(null,!1):e.getSelectionDataView().getRuntimeQueryParams(null,!1);(null==t?void 0:t.where)&&(l[e.getSubtypeCode()]=t.where)}));const u=f.dataSourceUtils.mergeSubtypeSublayerWhereClausesToSubtypeGroupLayer(n,null,l);return this.mergeQueryParams({where:u},r)}return super.getRuntimeQueryParamsWithSpecificWidgetQueries(e,t)}getSubtypeField(){var e;const t=null===(e=this.getLayerDefinition())||void 0===e?void 0:e.subtypeField;return this.findJimuFieldName(t)||this.findJimuFieldName(null==t?void 0:t.toLowerCase())}jsAPILayerQueryObjectIds(e,t){const r=t||this.layer;return null==r?void 0:r.queryObjectIds(e)}jsAPILayerQueryFeatures(e,t){const r=t||this.layer;return null==r?void 0:r.queryFeatures(e)}jsAPILayerQueryExtent(e,t){const r=t||this.layer;return null==r?void 0:r.queryExtent(e)}jsAPILayerQueryFeatureCount(e,t){const r=t||this.layer;return null==r?void 0:r.queryFeatureCount(e)}get layer(){return f.dataSourceUtils.getJSAPILayer(this)}set layer(e){this._layer=e}getChildDataSources(){return super.getChildDataSources()}findLayerInfo(e){var t;let r;return null===(t=this.layer.sublayers)||void 0===t||t.toArray().some(((t,i)=>this.getChildIdByLayer(t)===e&&(r={layer:t,order:i},!0))),r}createChildDataSourceByLayer(e,t,r,i){var a,s,o;const n=(null===(s=null===(a=this.getDataSourceJson().schema)||void 0===a?void 0:a.childSchemas)||void 0===s?void 0:s[t])||null,l=k(r,e,(null===(o=this.getDataSourceJson().childDataSourceJsons)||void 0===o?void 0:o[t])||null,n);if(l){const r={id:l.id,dataSourceJson:l,layer:e,parentDataSource:this,jimuChildId:t,order:i};return this.dataSourceManager.createDataSource(r)}return Promise.reject(new p(r,"Do not support this type of data."))}getChildIdByLayer(e){return f.dataSourceUtils.getFixedLayerIdByLayer(e)}createJSAPILayerByDataSource(e,t,r){const i=Object.create(null,{createJSAPILayerByDataSource:{get:()=>super.createJSAPILayerByDataSource}});return rt(this,void 0,void 0,(function*(){var a,s;const o=e||this,n=yield i.createJSAPILayerByDataSource.call(this,e,t,r);return(null==n?void 0:n.type)!==y.SubtypeGroupLayer||(null===(a=o.getRootDataSource())||void 0===a?void 0:a.map)||(yield n.loadAll(),null===(s=n.sublayers)||void 0===s||s.toArray().forEach((e=>{e.id=`${e.subtypeCode}`}))),n}))}getSublayerDataSourceByRecordId(e){return rt(this,void 0,void 0,(function*(){var t;if(!e)return null;const r=this.getRecords().find((t=>t.getId()===e))||(yield this.queryById(e));if(!r)return null;const i=r.getFieldValue(this.getSubtypeField()),a=this.layer.sublayers.find((e=>e.subtypeCode===i));if(!a)return null;const s=this.getChildIdByLayer(a),o=null===(t=this.getJimuChildId(s))||void 0===t?void 0:t[0],n=this.getChildDataSourceId(o);let l=this.dataSourceManager.getDataSource(n);if(!l)try{l=yield this.createChildDataSourceById(n,o,s)}catch(e){l=null}return l}))}}var at=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class st extends Le{constructor(){super(...arguments),this.type=o.SubtypeSublayer}ready(){return super.ready().then((()=>{if(this.isSelectionView()){const e=this.getMainDataSource().parentDataSource.getSelectedRecords();if(!(null==e?void 0:e.length))return;const t=this.getSubtypeField(),r=this.getSubtypeCode(),i=e.filter((e=>e.getFieldValue(t)===r));i.length&&f.lodash.defer((()=>{this.getMainDataSource().selectRecordsByIds(i.map((e=>e.getId())),i,!1)}))}}))}getSubtypeCode(){return this.layer.subtypeCode}getSubtypeField(){return this.getMainDataSource().parentDataSource.getSubtypeField()}jsAPILayerQueryObjectIds(e,t){const r=t||this.layer,i=r.type===y.FeatureLayer?r:r.parent;return e.where=r.type===y.FeatureLayer?e.where:this.ensureWhereClauseMatchesSubtype(e.where),i.queryObjectIds(e)}jsAPILayerQueryFeatures(e,t){const r=t||this.layer,i=r.type===y.FeatureLayer?r:r.parent;return e.where=r.type===y.FeatureLayer?e.where:this.ensureWhereClauseMatchesSubtype(e.where),i.queryFeatures(e)}jsAPILayerQueryExtent(e,t){const r=t||this.layer,i=r.type===y.FeatureLayer?r:r.parent;return e.where=r.type===y.FeatureLayer?e.where:this.ensureWhereClauseMatchesSubtype(e.where),null==i?void 0:i.queryExtent(e)}jsAPILayerQueryFeatureCount(e,t){const r=t||this.layer,i=r.type===y.FeatureLayer?r:r.parent;return e.where=r.type===y.FeatureLayer?e.where:this.ensureWhereClauseMatchesSubtype(e.where),i.queryFeatureCount(e)}selectRecordsByIds(e,t,r=!0){const i=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),a=t||e.map((e=>i.find((t=>(null==t?void 0:t.getId())===e))));this.copySelectionToDataView(a,r),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:e})}copySelectionToDataView(e,t=!0){if(super.copySelectionToDataView(e),t){const t=this.getMainDataSource().parentDataSource,r=t.getSelectionDataView().getSourceRecords().filter((e=>(null==e?void 0:e.getFieldValue(t.getSubtypeField()))!==this.getSubtypeCode())).concat(e);t.selectRecordsByIds(r.map((e=>null==e?void 0:e.getId())),r,!1)}}updateQueryParams(e,t){if(super.updateQueryParams(e,t),this.getMainDataSource().id===this.id)this.getMainDataSource().parentDataSource.addSourceVersion();else if(this.isSelectionView()){const e=this.getMainDataSource().parentDataSource.getSelectionDataView();e.load({returnGeometry:!0,pageSize:e.getSourceRecords().length},{widgetId:f.CONSTANTS.SELECTION_DATA_VIEW_ID}),e.loadCount({},{widgetId:f.CONSTANTS.SELECTION_DATA_VIEW_ID})}}setDataSourceJson(e){const t=this.getDataSourceJson().query;if(super.setDataSourceJson(e),!f.utils.isDeepEqual(null==e?void 0:e.query,t)){this.getMainDataSource().parentDataSource.addSourceVersion()}}setLayerDefinition(e){const t=this.getMainDataSource().parentDataSource;this.layerDefinition=Object.assign(Object.assign(Object.assign({},t.getLayerDefinition()),{id:this.getSubtypeCode()}),e)}getRemoteQueryParams(e=!0){if(e){const e=super.getRemoteQueryParams(),t=this.getMainDataSource().parentDataSource,r=t.getRemoteQueryParams(!1),i=t.getConfigQueryParams();return this.mergeQueryParams(r,i,e)}return super.getRemoteQueryParams()}getRuntimeQueryParams(e,t=!0){return this.getRuntimeQueryParamsWithSpecificWidgetQueries(e,this.getInfo().widgetQueries,t)}getRuntimeQueryParamsWithSpecificWidgetQueries(e,t,r=!0){const i=this.getMainDataSource().id===this.id;if(r&&(i||this.isSelectionView())){const r=super.getRuntimeQueryParamsWithSpecificWidgetQueries(e,t),a=this.getMainDataSource().parentDataSource,s=i?a.getRuntimeQueryParams(null,!1):a.getSelectionDataView().getRuntimeQueryParams(null,!1);return this.mergeQueryParams(s,r)}return super.getRuntimeQueryParamsWithSpecificWidgetQueries(e,t)}changeSelectionInUrl(e){var t,r,i,a;((null===(t=null==e?void 0:e.queryParams)||void 0===t?void 0:t.geometry)||(null===(r=null==e?void 0:e.queryParams)||void 0===r?void 0:r.spatialRel)||0===(null===(i=e.records)||void 0===i?void 0:i.length)||0===(null===(a=e.ids)||void 0===a?void 0:a.length))&&super.changeSelectionInUrl(e)}get layer(){return f.dataSourceUtils.getJSAPILayer(this)}set layer(e){this._layer=e}ensureWhereClauseMatchesSubtype(e){var t,r,i;const a=this.getMainDataSource().parentDataSource,s=null===(i=null===(r=null===(t=a.getSchema())||void 0===t?void 0:t.fields)||void 0===r?void 0:r[a.getSubtypeField()])||void 0===i?void 0:i.name,o=this.getSubtypeCode();return f.dataSourceUtils.ensureWhereClauseMatchesSubtype(e,s,o)}allowToExportData(){return this.getMainDataSource().parentDataSource.allowToExportData()}createJSAPILayerByDataSource(e){return at(this,arguments,void 0,(function*(e,t=!0,r=!1){var i;const a=e||this;let s;try{if(a.dataViewId===f.CONSTANTS.SELECTION_DATA_VIEW_ID&&a.useNoSelectionView()){const e=a.getMainDataSource().getDataView(f.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION);if(e){s=(yield f.dataSourceUtils.createJSAPIFeatureLayerByRecords(e,e.getRecords())).layer}}else if(a.getDataSourceJson().isDataInDataSourceInstance)s=yield f.dataSourceUtils.createJSAPIFeatureLayerByRecords(a,a.getSourceRecords()).then((e=>null==e?void 0:e.layer));else{const e=a.getSubtypeCode(),t=this.getLayerConstructorOptions(a.getMainDataSource().parentDataSource);t.sublayers=[{subtypeCode:a.getSubtypeCode()}];const r=new(yield(0,f.loadArcGISJSAPIModule)("esri/layers/SubtypeGroupLayer"))(t);yield r.loadAll(),s=r.sublayers.toArray().find((t=>t.subtypeCode===e))}t&&(s.type===y.FeatureLayer?this.syncQueryParams(s,a):(this.syncQueryParams(s.parent,a),s.parent.definitionExpression=this.ensureWhereClauseMatchesSubtype(null===(i=a.getCurrentQueryParams())||void 0===i?void 0:i.where))),this.afterCreateJSAPILayer(s,a)}catch(e){if(r)throw e;console.error("Failed to create JS API layer. ",e,this.id)}return s}))}}var ot=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class nt extends re{constructor(e){if(super(e),this.type=o.BuildingSceneLayer,e.layer){const t=e.layer.url.split("/");"SceneServer"===t[t.length-1]&&(this.url=`${e.layer.url}/layers/${e.layer.layerId}`)}}ready(){return ot(this,void 0,void 0,(function*(){this.serviceDefinition||(this.serviceDefinition=yield this.fetchServiceDefinition());const e=f.dataSourceUtils.getFullArcGISServiceUrl(this.url,!1).replace("SceneServer","FeatureServer");try{yield f.requestUtils.requestWrapper(e,(t=>ot(this,void 0,void 0,(function*(){return yield f.esri.restRequest.request(e,{authentication:t,httpMethod:"GET"})}))))}catch(e){return e}return Promise.resolve()}))}createChildDataSourceOptionsById(e,t,r){var i;const a=this.getSubLayerUrlByChildId(r),s={url:a,layerDefinition:this.layer?null:this.getSubLayerDefinitionByChildId(r)},o=this.getSubLayerByChildId(r);let n=W(e,o,{portalUrl:""},s).set("url",a);(null===(i=s.layerDefinition)||void 0===i?void 0:i.layerType)&&(n=n.set("type",s.layerDefinition.layerType));const l=f.dataSourceUtils.getChildDsJsonFromRootDs(this,t),u={id:e,dataSourceJson:n.merge(l,{deep:!0}),jimuChildId:t,parentDataSource:this,serviceUrl:this.url};return this.layer?u.layer=o:this.serviceDefinition&&(u.layerDefinition=this.getSubLayerDefinitionByChildId(r)),u}getChildIds(){if(this.layer){return this.layer.sublayers.toArray().map((e=>this.getChildIdByLayer(e)))}if(this.serviceDefinition){return this.serviceDefinition.sublayers.map((e=>e.id))}return[]}getSubLayerByChildId(e){if(!this.layer)return null;const t=this.layer.sublayers.toArray();for(const r of t){if(this.getChildIdByLayer(r)===e)return r}return null}getSubLayerDefinitionByChildId(e){if(!this.serviceDefinition)return null;const t=this.serviceDefinition.sublayers;for(const r of t)if(r.id===e)return"group"===r.layerType?r.layerType=y.BuildingGroupSubLayer:"3DObject"===r.layerType&&(r.layerType=y.BuildingComponentSubLayer),r;return null}getSubLayerUrlByChildId(e){const t=this.getSubLayerByChildId(e),r=`${this.url}/sublayers/${e}`;if(t)return t.type===y.BuildingComponentSubLayer?r:null;return this.getSubLayerDefinitionByChildId(e).layerType===y.BuildingComponentSubLayer?r:null}updateQueryParams(e,t){const r=this.getAllChildDataSources().filter((e=>e.type===u.BuildingComponentSubLayer));for(const i of r)i.updateQueryParams(e,t)}}var lt=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class ut extends Qe{constructor(){super(...arguments),this.type=o.BuildingComponentSubLayer}createAssociatedDataSource(){return lt(this,void 0,void 0,(function*(){return this.getAssociatedDataSource()?Promise.resolve(this.getAssociatedDataSource()):this.layer?this._createAssociatedDataSourceWithLayer():this._createAssociatedDataSourceWithLayerDefinition()}))}getAssociatedFeatureServerUrl(){const e=f.dataSourceUtils.getFullArcGISServiceUrl(this.url,!1).split("/");e[e.length-1]="FeatureServer";return e.join("/")}_createAssociatedDataSourceWithLayer(){return lt(this,void 0,void 0,(function*(){const e=this._getNewAssociatedDataSourceId();yield this.layer.load();const t=this.layer.associatedLayer;if(!t)return this._createAssociatedDataSourceWithUrl();this.layer.definitionExpression&&(t.definitionExpression=this.layer.definitionExpression),yield t.load();const r=t.url+"/"+t.layerId;let i=(0,f.Immutable)({id:e,type:o.FeatureLayer,url:r});i=this._mergeAssociatedDataSourceJson(i);const a={id:e,dataSourceJson:i,layer:t,associatedDataSource:this},s=yield this.dataSourceManager.createDataSource(a);return this.associatedDataSource=s,this.associatedDataSource}))}_createAssociatedDataSourceWithLayerDefinition(){return lt(this,void 0,void 0,(function*(){const e=yield this.fetchLayerDefinition(),t=`${this.getAssociatedFeatureServerUrl()}/${e.associatedLayerID}`;let r=H(this._getNewAssociatedDataSourceId(),e,t);r=r.set("url",t),r=this._mergeAssociatedDataSourceJson(r).setIn(["type"],u.FeatureLayer);const i={id:r.id,dataSourceJson:r,associatedDataSource:this},a=yield this.dataSourceManager.createDataSource(i);return this.associatedDataSource=a,this.associatedDataSource}))}}var dt=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class ct extends re{constructor(){super(...arguments),this.type=o.BuildingGroupSubLayer}ready(){return dt(this,void 0,void 0,(function*(){this.serviceDefinition||(yield this.fetchServiceDefinition());let e=[];return e=window.jimuConfig.isInBuilder?yield this.childDataSourcesReady():this.getChildDataSourceIds(),0===e.length?Promise.reject("No sublayers inside this building-group layer, will not create the building-group data source"):Promise.resolve()}))}fetchServiceDefinition(){return this.serviceDefinition||(this.serviceDefinition=this.layerDefinition),Promise.resolve(this.layerDefinition||{})}createChildDataSourceOptionsById(e,t,r){var i;const a=this.getSubLayerUrlByChildId(r),s={url:a,layerDefinition:this.layer?null:this.getSubLayerDefinitionByChildId(r)},o=this.getSubLayerByChildId(r);let n=W(e,o,{portalUrl:""},s).set("url",a);(null===(i=s.layerDefinition)||void 0===i?void 0:i.layerType)&&(n=n.set("type",s.layerDefinition.layerType));const l=f.dataSourceUtils.getChildDsJsonFromRootDs(this,t),u={id:e,dataSourceJson:n.merge(l,{deep:!0}),jimuChildId:t,parentDataSource:this,serviceUrl:this.serviceUrl};return this.layer?u.layer=o:this.serviceDefinition&&(u.layerDefinition=this.getSubLayerDefinitionByChildId(r)),u}getChildIds(){if(this.layer){return this.layer.sublayers.toArray().map((e=>this.getChildIdByLayer(e)))}if(this.layerDefinition){return this.layerDefinition.sublayers.map((e=>e.id))}return[]}getSubLayerByChildId(e){if(!this.layer)return null;const t=this.layer.sublayers.toArray();for(const r of t){if(this.getChildIdByLayer(r)===e)return r}return null}getSubLayerDefinitionByChildId(e){if(!this.layerDefinition)return null;for(const t of this.layerDefinition.sublayers)if(t.id.toString()===e.toString())return"group"===t.layerType?t.layerType=y.BuildingGroupSubLayer:"3DObject"===t.layerType&&(t.layerType=y.BuildingComponentSubLayer),t;return null}getSubLayerUrlByChildId(e){const t=this.getSubLayerByChildId(e),r=`${this.serviceUrl}/sublayers/${e}`;if(t)return t.type===y.BuildingComponentSubLayer?r:null;return this.getSubLayerDefinitionByChildId(e).layerType===y.BuildingComponentSubLayer?r:null}}var ht=function(e,t,r,i){return new(r||(r=Promise))((function(a,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function n(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,n)}l((i=i.apply(e,t||[])).next())}))};class yt extends(_(C(A))){constructor(e){super(e),this.type=o.ElevationLayer,e.layer&&(this.layer=e.layer);const t=this.getDataSourceJson();this.portalUrl=t.portalUrl,this.itemId=t.itemId}ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return ht(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),e.ready.call(this),Promise.resolve()}))}}class St{createDataSource(e){var t;const r=null!==(t=e.dataSourceJson)&&void 0!==t?t:e.belongToDataSource.getMainDataSource().getDataSourceJson(),i=e.dataViewId&&r.dataViews&&r.dataViews[e.dataViewId]&&r.dataViews[e.dataViewId].type||r.type;switch(i){case o.Error:return new tt(e);case o.CSV:return new fe(e);case o.FeatureLayer:return new Pe(e);case o.FeatureService:return new Fe(e);case o.GroupLayer:return new Re(e);case o.MapService:return new we(e);case o.SceneService:return new Ee(e);case o.ImageryLayer:return new Je(e);case o.ImageryTileLayer:return new je(e);case o.ElevationLayer:return new yt(e);case o.OrientedImageryLayer:return new _e(e);case o.SubtypeGroupLayer:return new it(e);case o.SubtypeSublayer:return new st(e);case o.VectorTileService:return new qe(e);case o.GeoJSON:return new ke(e);case o.KML:return new ze(e);case o.WFS:return new He(e);case o.WMS:return new Xe(e);case o.WMTS:return new et(e);case o.SceneLayer:return new Qe(e);case o.SimpleLocal:return new Ve(e);case o.BuildingSceneLayer:return new nt(e);case o.BuildingComponentSubLayer:return new ut(e);case o.BuildingGroupSubLayer:return new ct(e);default:throw new Error(`Unhandled case: ${i}`)}}}const gt=St;return a})())}}}));