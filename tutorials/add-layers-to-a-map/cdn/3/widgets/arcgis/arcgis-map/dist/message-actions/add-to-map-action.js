System.register(["jimu-core","jimu-arcgis"],(function(e,t){var a={},r={};return{setters:[function(e){a.AbstractMessageAction=e.AbstractMessageAction,a.DataSourceTypes=e.DataSourceTypes,a.DataSourcesChangeType=e.DataSourcesChangeType,a.MessageType=e.MessageType,a.MutableStoreManager=e.MutableStoreManager,a.getAppStore=e.getAppStore},function(e){r.ADD_TO_MAP_DATA_ID_PREFIX=e.ADD_TO_MAP_DATA_ID_PREFIX,r.ActionType=e.ActionType,r.DataChangeStatus=e.DataChangeStatus,r.DataChangeType=e.DataChangeType,r.MapViewManager=e.MapViewManager}],execute:function(){e((()=>{"use strict";var e={62686:e=>{e.exports=r},79244:e=>{e.exports=a}},t={};function n(a){var r=t[a];if(void 0!==r)return r.exports;var i=t[a]={exports:{}};return e[a](i,i.exports,n),i.exports}n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};n.r(i),n.d(i,{default:()=>u});var o=n(79244),s=n(62686);class u extends o.AbstractMessageAction{filterMessageDescription(e){return e.messageType===o.MessageType.DataSourcesChange}filterMessage(e){return!0}onRemoveListen(e,t){var a;const r=(null===(a=o.MutableStoreManager.getInstance().getStateValue([this.widgetId]))||void 0===a?void 0:a.addToMapDatas)||{},n={};Object.entries(r).forEach((e=>{var a;(null===(a=e[1])||void 0===a?void 0:a.messageWidgetId)!==t&&(n[e[0]]=e[1])})),o.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"addToMapDatas",n)}onExecute(e,t){var a;const r=this._getActiveViewId(this.widgetId,(0,o.getAppStore)().getState().jimuMapViewsInfo),n=this._getDefaultViewId(this.widgetId,(0,o.getAppStore)().getState().jimuMapViewsInfo),i=r||n,u=(null===(a=o.MutableStoreManager.getInstance().getStateValue([this.widgetId]))||void 0===a?void 0:a.addToMapDatas)||{};return e.dataSources.forEach((t=>{var a;const d=t;if(!d.supportSpatialInfo||!d.supportSpatialInfo())return;if(d.type===o.DataSourceTypes.ElevationLayer)return;if(d.type===o.DataSourceTypes.SubtypeSublayer)return!1;const g=r&&s.MapViewManager.getInstance().getJimuMapViewById(r);if([o.DataSourceTypes.SceneLayer,o.DataSourceTypes.SceneService,o.DataSourceTypes.BuildingSceneLayer,o.DataSourceTypes.BuildingGroupSubLayer,o.DataSourceTypes.BuildingComponentSubLayer].includes(d.type)&&"2d"===(null===(a=null==g?void 0:g.view)||void 0===a?void 0:a.type))return;const p=`${s.ADD_TO_MAP_DATA_ID_PREFIX}messageAction_${this.widgetId}_${d.id}_`,c=`${p}???`,S=r?`${p}${r}`:c;n&&n===r&&u[c]&&o.MutableStoreManager.getInstance().updateStateValue(this.widgetId,`addToMapDatas.${c}.dataChangeType`,s.DataChangeType.Remove),u[S]={mapWidgetId:this.widgetId,messageWidgetId:e.widgetId,jimuMapViewId:i,dataSourceId:d.id,type:s.ActionType.MessageAction,dataChangeType:e.changeType===o.DataSourcesChangeType.Remove?s.DataChangeType.Remove:s.DataChangeType.Create,dataChangeStatus:e.changeType===o.DataSourcesChangeType.Remove?s.DataChangeStatus.Fulfilled:s.DataChangeStatus.Pending,title:S}})),o.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"addToMapDatas",u),Promise.resolve(!0)}_getActiveViewId(e,t){return Object.keys(t||{}).find((a=>t[a].mapWidgetId===e&&t[a].isActive))}_getDefaultViewId(e,t){return Object.keys(t||{}).find((a=>t[a].mapWidgetId===e))}}return i})())}}}));