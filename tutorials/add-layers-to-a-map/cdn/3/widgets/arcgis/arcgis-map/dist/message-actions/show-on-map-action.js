System.register(["jimu-core","jimu-arcgis"],(function(e,t){var a={},o={};return{setters:[function(e){a.AbstractMessageAction=e.AbstractMessageAction,a.DataSourceManager=e.DataSourceManager,a.Immutable=e.Immutable,a.MessageCarryData=e.MessageCarryData,a.MessageType=e.MessageType,a.MutableStoreManager=e.MutableStoreManager,a.RecordSetChangeType=e.RecordSetChangeType,a.getAppStore=e.getAppStore,a.i18n=e.i18n},function(e){o.ActionType=e.ActionType,o.SHOW_ON_MAP_DATA_ID_PREFIX=e.SHOW_ON_MAP_DATA_ID_PREFIX,o.featureUtils=e.featureUtils}],execute:function(){e((()=>{"use strict";var e={62686:e=>{e.exports=o},79244:e=>{e.exports=a}},t={};function n(a){var o=t[a];if(void 0!==o)return o.exports;var s=t[a]={exports:{}};return e[a](s,s.exports,n),s.exports}n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};n.r(s),n.d(s,{default:()=>m});var i=n(79244),r=n(62686);const l="Show on map data";function u(){return{isUseCustomSymbol:!0,symbolOption:{pointSymbol:r.featureUtils.getDefaultSymbol("point"),polylineSymbol:r.featureUtils.getDefaultSymbol("polyline"),polygonSymbol:r.featureUtils.getDefaultSymbol("polygon")},isOperationalLayer:!0}}function d(e,t){var a,o;const n=p(),s=null===(a=null==n?void 0:n.widgets)||void 0===a?void 0:a[e],r=null===(o=null==s?void 0:s.manifest)||void 0===o?void 0:o.publishMessages;let l=i.MessageCarryData.UseDataSource;return null==r||r.forEach((e=>{const a=e;(null==a?void 0:a.messageCarryData)&&(null==a?void 0:a.messageType)===t&&(l=null==a?void 0:a.messageCarryData)})),l}function c(e,t){var a;const o=d(e,t),n=p(),s=null===(a=null==n?void 0:n.widgets)||void 0===a?void 0:a[e],r=(null==s?void 0:s.useDataSources)||(0,i.Immutable)([]),l=function(e){var t;const a=null!==(t=null==e?void 0:e.map((e=>({dataSourceId:e,mainDataSourceId:e,rootDataSourceId:null}))))&&void 0!==t?t:[];return(0,i.Immutable)(a)}(null==s?void 0:s.outputDataSources)||(0,i.Immutable)([]),u=function(e){const t=[],a=g(e),o=null==a?void 0:a.useMapWidgetIds,n={};(null==o?void 0:o.length)>0&&o.forEach((e=>{if(e){const a=g(e),o=null==a?void 0:a.useDataSources;o&&o.forEach((e=>{var a;const o=null===(a=null==e?void 0:e.asMutable)||void 0===a?void 0:a.call(e,{deep:!0});o&&o.dataSourceId&&!n[o.dataSourceId]&&(n[o.dataSourceId]=!0,t.push(o))}))}}));return(0,i.Immutable)(t)}(e),c=l,m=(null==s?void 0:s.useDataSources)?r:u,v=(0,i.Immutable)(m.asMutable({deep:!0}).concat(c.asMutable({deep:!0})));switch(o){case i.MessageCarryData.OutputDataSource:return c;case i.MessageCarryData.UseDataSource:return m;case i.MessageCarryData.BothDataSource:return v}}function g(e){var t;if(!e)return null;const a=p();return null===(t=null==a?void 0:a.widgets)||void 0===t?void 0:t[e]}function p(){var e,t,a;return window.jimuConfig.isBuilder?null===(t=null===(e=(0,i.getAppStore)().getState())||void 0===e?void 0:e.appStateInBuilder)||void 0===t?void 0:t.appConfig:null===(a=(0,i.getAppStore)().getState())||void 0===a?void 0:a.appConfig}class m extends i.AbstractMessageAction{filterMessageDescription(e){if(e.messageType===i.MessageType.DataRecordSetChange){const t=i.DataSourceManager.getInstance(),a=c(e.widgetId,e.messageType);return!(0!==a.length||!function(e){var t;const a=e.widgetId;if((e.messageType===i.MessageType.DataRecordSetChange||e.messageType===i.MessageType.DataRecordsSelectionChange)&&a){const e=g(a);if(e&&"widgets/common/search/"===e.uri&&(null===(t=e.useMapWidgetIds)||void 0===t?void 0:t.length)>0)return!0}return!1}(e))||a.some((e=>{const a=t.getDataSource(e.dataSourceId);return!!a&&!!a.getGeometryType()}))}return!1}filterMessage(e){return!0}getDefaultMessageActionConfig(e){return u()}onRemoveListen(e,t){var a;const o=(null===(a=i.MutableStoreManager.getInstance().getStateValue([this.widgetId]))||void 0===a?void 0:a.showOnMapDatas)||{},n={};Object.entries(o).forEach((e=>{var a;(null===(a=e[1])||void 0===a?void 0:a.messageWidgetId)!==t&&(n[e[0]]=e[1])})),i.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"showOnMapDatas",n)}getSettingComponentUri(e,t){return"message-actions/show-on-map-action-setting"}onExecute(e,t){var a,o;if(e.type!==i.MessageType.DataRecordSetChange)return;const n=this._getActiveViewId(this.widgetId,(0,i.getAppStore)().getState().jimuMapViewsInfo),s=this._getDefaultViewId(this.widgetId,(0,i.getAppStore)().getState().jimuMapViewsInfo),u=n||s;let d=(null===(a=i.MutableStoreManager.getInstance().getStateValue([this.widgetId]))||void 0===a?void 0:a.showOnMapDatas)||{};return e.changeType===i.RecordSetChangeType.CreateUpdate?null===(o=e.dataRecordSets)||void 0===o||o.forEach((a=>{const o=this._getIdBase(a.name),c=`${o}???`,g=n?`${o}${n}`:c;let p;s&&s===n&&delete d[c],p=t?t.isUseCustomSymbol?t.symbolOption:!1===t.isUseCustomSymbol?null:void 0:void 0;const m=null==t?void 0:t.isOperationalLayer;let v=null;const S=d[g];v=S?S.titleCountInfo:function(e,t,a){const o=i.i18n.getIntl(),n=e.label||e.name||o.formatMessage({id:"showOnMapData",defaultMessage:l}),s=[];Object.values(a).forEach((e=>{const a=e.titleCountInfo;e.jimuMapViewId===t&&a&&a.rawTitle===n&&a.count>=0&&s.push(a.count)}));let r=null;if(s.length>0){const e=Math.max(...s);r={rawTitle:n,finalTitle:`${n} ${e+1}`,count:e+1}}else r={rawTitle:n,finalTitle:n,count:1};return r}(a,n,d);const f={mapWidgetId:this.widgetId,messageWidgetId:e.widgetId,jimuMapViewId:u,dataSet:a,title:v.finalTitle,type:r.ActionType.MessageAction,symbolOption:p,isOperationalLayer:m,titleCountInfo:v};d[g]=f})):e.changeType===i.RecordSetChangeType.Remove&&e.dataRecordSetNames.forEach((e=>{const t=this._getIdBase(e),a={};Object.entries(d).forEach((e=>{0!==e[0].indexOf(t)&&(a[e[0]]=e[1])})),d=a})),i.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"showOnMapDatas",d),Promise.resolve(!0)}_getIdBase(e){return`${r.SHOW_ON_MAP_DATA_ID_PREFIX}messageAction_${this.widgetId}_${e}_`}_getActiveViewId(e,t){return Object.keys(t||{}).find((a=>t[a].mapWidgetId===e&&t[a].isActive))}_getDefaultViewId(e,t){return Object.keys(t||{}).find((a=>t[a].mapWidgetId===e))}}return s})())}}}));