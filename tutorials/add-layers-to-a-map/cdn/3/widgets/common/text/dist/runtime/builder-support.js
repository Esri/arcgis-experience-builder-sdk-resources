System.register(["jimu-core","jimu-ui","jimu-ui/advanced/rich-text-editor","jimu-theme","jimu-for-builder"],(function(e,t){var o={},r={},n={},a={},s={};return{setters:[function(e){o.BrowserSizeMode=e.BrowserSizeMode,o.DataSourceManager=e.DataSourceManager,o.Immutable=e.Immutable,o.React=e.React,o.ReactRedux=e.ReactRedux,o.appActions=e.appActions,o.getAppStore=e.getAppStore,o.hooks=e.hooks,o.jsx=e.jsx},function(e){r.defaultMessages=e.defaultMessages,r.richTextUtils=e.richTextUtils,r.sanitizer=e.sanitizer},function(e){n.Bubble=e.Bubble,n.Delta=e.Delta,n.RichExpressionBuilderPopper=e.RichExpressionBuilderPopper,n.RichTextEditor=e.RichTextEditor,n.richTextEditorUtils=e.richTextEditorUtils},function(e){a.ThemeSwitchComponent=e.ThemeSwitchComponent},function(e){s.appBuilderSync=e.appBuilderSync}],execute:function(){e((()=>{"use strict";var e={79244:e=>{e.exports=o},4108:e=>{e.exports=s},1888:e=>{e.exports=a},14321:e=>{e.exports=r},33949:e=>{e.exports=n}},t={};function l(o){var r=t[o];if(void 0!==r)return r.exports;var n=t[o]={exports:{}};return e[o](n,n.exports,l),n.exports}l.d=(e,t)=>{for(var o in t)l.o(t,o)&&!l.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};l.r(i),l.d(i,{default:()=>L});var c={};l.r(c),l.d(c,{DATA_SOURCE_ID_REGEXP:()=>m,getDataSourceIds:()=>g,getDefaultValue:()=>y,getExpressionParts:()=>S,getInvalidDataSourceIds:()=>b,getUseDataSourceIds:()=>v,sanitizeHTML:()=>R,shouldShowPlaceholder:()=>x});var u=l(79244),d=l(14321),p=l(33949);const f=(e,t)=>{const o=d.richTextUtils.getHTMLTextContent(e);return e.replace(null==o?void 0:o.trim(),t)},h=(e,t)=>(t.forEach((e=>{var t;const o=null===(t=null==e?void 0:e.attributes)||void 0===t?void 0:t.linespace;o&&isNaN(Number(o))&&(e.attributes.linespace=1.5)})),t),m=/data-dsid=\"(((?![\=|\>|\"]).)*)[\"\>|"\s)]/gm,g=(e=(0,u.Immutable)([]))=>e.map((e=>{return t=null==e?void 0:e.dataSourceId,null!=u.DataSourceManager.getInstance().getDataSource(t)?null==e?void 0:e.dataSourceId:null;var t})).filter((e=>null!=e)),v=e=>{const t=m;let o,r=[];for(;null!==(o=t.exec(e));){let e=o[1];e.indexOf(",")>0?(e=e.split(","),r=r.concat(e)):r.push(e)}return r},b=(e,t)=>{const o=v(e);if(null==o||o.length<=0)return;const r=g(t),n=o.filter((e=>!r.includes(e)));return n.length>=0?n:void 0},S=e=>{let t=[];for(const o in e){const r=e[o],n=null==r?void 0:r.parts;null!=n&&(t=t.concat(n))}return t},x=(e,t,o)=>{const r=d.richTextUtils.isBlankRichText(e)&&!!t;return void 0!==o?!o&&r:r},R=(e="")=>""!==e?d.sanitizer.sanitize(e):e,y=(e,t,o="")=>{let r=t;const n=x(t,o);return e?n&&(r=f(o,d.richTextUtils.BLANK_CHARATER)):r=n?o:t,R(r)};var E=function(e,t){var o={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(o[r[n]]=e[r[n]])}return o};const{useEffect:w,useRef:C,useState:T,useMemo:O}=u.React,j={toolbar:!1,autoformat:{link:{trigger:/[\s]/,find:/https?:\/\/[\S]+|(www\.[\S]+)/gi,transform:function(e,t){return t?"http://"+e:e},format:"link"}},clipboard:{matchers:[["img",()=>new p.Delta],["p",h],["li",h],["h1",h],["h2",h],["h3",h],["h4",h],["h5",h],["h6",h]]}},I=/(?!^\n$)[\n]/gm,D=(e,t)=>(t.forEach((e=>{"string"==typeof e.insert&&(e.insert=e.insert.replace(I," "))})),t),M=e=>{e.clipboard.addMatcher("*",D)},P=(e,t)=>{if(null==e)return;const o=(e=>{const t=e.clipboard.matchers;let o=-1;if(t.some((([e,t],r)=>"*"===e&&t===D&&(o=r,!0))),o>-1)return e.clipboard.matchers.splice(o,1),!0})(e);t=R(t);const r=e.clipboard.convert({html:t});e.setContents(r,"silent"),p.richTextEditorUtils.setEditorCursorEnd(e,"silent"),o&&M(e)},A=e=>{const{editorRef:t,value:o,placeholder:r,enabled:n,onChange:a,onComplete:s}=e,l=E(e,["editorRef","value","placeholder","enabled","onChange","onComplete"]),[i,c]=u.hooks.useForwardRef(t),[h,m]=T(o),[g,v]=T(r),b=((e,t,o,r,n)=>{const a=C({enabled:e,value:t,placeholder:o,onChange:r,onComplete:n});return w((()=>{a.current={enabled:e,value:t,placeholder:o,onChange:r,onComplete:n}}),[e,t,o,r,n]),a})(n,h,g,a,s),S=O((()=>y(n,h,g)),[]),R=u.hooks.useEventCallback(((e,t,o)=>{"silent"!==o&&(x(h,g,n)?v(e):(m(e),null==a||a(e)))}));return u.hooks.useUpdateEffect((()=>{if(v(r),x(h,r)){const e=i.current;P(e,r)}}),[r]),u.hooks.useUpdateEffect((()=>{const{value:e,placeholder:t,onComplete:o}=b.current,r=i.current;if(n){const o=i.current;if(x(e,t)){const e=f(t,d.richTextUtils.BLANK_CHARATER);P(o,e),o.focus()}}else x(e,t)&&P(r,t),null==o||o(e,t)}),[n]),w((()=>{const e=i.current;null!=e&&M(e)}),[i]),u.hooks.useUnmount((()=>{const{value:e,placeholder:t,onComplete:o}=b.current;null==o||o(e,t)})),u.React.createElement(p.RichTextEditor,Object.assign({autoFocus:!0,enabled:n,editorRef:c,onChange:R,defaultValue:S,modules:j},l))};var B=l(1888),U=l(4108);const k=e=>{const{editor:t,formats:o,selection:r,useDataSources:n,widgetId:a,enabled:s,onInitResizeHandler:l}=e,i=u.ReactRedux.useSelector((e=>{var t;return!!(null===(t=e.widgetsState[a])||void 0===t?void 0:t.showExpression)})),c=u.ReactRedux.useSelector((e=>e.browserSizeMode)),f=u.ReactRedux.useSelector((e=>{var t;return null===(t=e.appConfig.widgets[a])||void 0===t?void 0:t.uri})),h=u.hooks.useTranslation(d.defaultMessages),[m,g]=u.React.useState(0),[v,b]=u.React.useState(0),S=u.React.useRef(null);c===u.BrowserSizeMode.Small&&U.appBuilderSync.publishSidePanelToApp({type:"textExpression",widgetId:a,uri:f,editor:t,formats:o,selection:r,useDataSources:n,active:i}),u.React.useEffect((()=>{null==l||l((()=>{var e;g((e=>e+1)),null===(e=S.current)||void 0===e||e.classList.add("d-none")}),null,(()=>{var e;b((e=>e+1)),null===(e=S.current)||void 0===e||e.classList.remove("d-none")}))}),[l]);const x=u.React.useMemo((()=>({title:h("dynamicContent"),onClose:()=>{(0,u.getAppStore)().dispatch(u.appActions.widgetStatePropChange(a,"showExpression",!1)),(0,u.getAppStore)().dispatch(u.appActions.widgetToolbarStateChange(a,["text-expression"]))}})),[a,h]);return u.hooks.useUpdateEffect((()=>{g((e=>e+1))}),[s]),u.React.createElement(B.ThemeSwitchComponent,{useTheme2:!0},u.React.createElement(p.Bubble,{editor:t,formats:o,selection:r,source:"user",version:m}),c!==u.BrowserSizeMode.Small&&u.React.createElement(p.RichExpressionBuilderPopper,{ref:S,version:v,source:"user",editor:t,formats:o,selection:r,open:i,useDataSources:n,header:x,widgetId:a}))};var z=function(e,t){var o={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(o[r[n]]=e[r[n]])}return o};const{useMemo:H,useCallback:_}=u.React,L={Editor:e=>{const{value:t,widgetId:o,useDataSources:r,onComplete:n,onCreate:a,onDestroy:s,onInitResizeHandler:l,enabled:i}=e,c=z(e,["value","widgetId","useDataSources","onComplete","onCreate","onDestroy","onInitResizeHandler","enabled"]),[d,p]=u.React.useState(t),f=((e,t)=>_((o=>null!=o?null==e?void 0:e(o):null==t?void 0:t()),[e,t]))(a,s),h=((e,t,o,r)=>u.React.useMemo((()=>({editor:n,selection:a,formats:s})=>(0,u.jsx)(k,{editor:n,selection:a,formats:s,widgetId:e,useDataSources:t,enabled:o,onInitResizeHandler:r})),[o,r,t,e]))(o,r,i,l),m=((e,t)=>H((()=>{const o=b(e,t),r={".ql-editor":{lineHeight:1.42}};return null==o||o.forEach((e=>{r[`exp[data-dsid*="${e}"]`]={opacity:.5,background:"var(--sys-color-error-main)",outline:"1px solid white"}})),r}),[e,t]))(d,r);return(0,u.jsx)(A,Object.assign({editorRef:f,css:m,value:t,plugin:h,onChange:p,onComplete:n,enabled:i},c))},builderUtils:c};return i})())}}}));