System.register(["jimu-core/data-source","jimu-core"],(function(e,t){var r={},a={};return{setters:[function(e){r.AbstractDataSource=e.AbstractDataSource,r.DataSourceError=e.DataSourceError,r.ItemMixinImpl=e.ItemMixinImpl,r.SetDataSourceMixinImpl=e.SetDataSourceMixinImpl,r.dataSourceJsonCreator=e.dataSourceJsonCreator},function(e){a.Immutable=e.Immutable,a.dataSourceUtils=e.dataSourceUtils,a.getAppStore=e.getAppStore,a.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules,a.portalUrlUtils=e.portalUrlUtils}],execute:function(){e((()=>{"use strict";var e={244:e=>{e.exports=a},349:e=>{e.exports=r}},t={};function o(r){var a=t[r];if(void 0!==a)return a.exports;var i=t[r]={exports:{}};return e[r](i,i.exports,o),i.exports}o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i,n,s={};o.r(s),o.d(s,{ArcGISDataSourceFactory:()=>m,ArcGISDataSourceTypes:()=>i,DataSourceTypes:()=>i,LayerTypes:()=>n,MapDataSourceImpl:()=>d,WebMapDataSourceImpl:()=>y,WebSceneDataSourceImpl:()=>S,default:()=>I}),function(e){e.Map="MAP",e.WebMap="WEB_MAP",e.WebScene="WEB_SCENE"}(i||(i={})),function(e){e.BaseDynamicLayer="base-dynamic",e.BaseElevationLayer="base-elevation",e.BaseTileLayer="base-tile",e.BuildingSceneLayer="building-scene",e.BuildingGroupSublayer="building-group",e.BuildingComponentSublayer="building-component",e.CSVLayer="csv",e.ElevationLayer="elevation",e.FeatureLayer="feature",e.GeoJSONLayer="geojson",e.GeoRSSLayer="geo-rss",e.GraphicsLayer="graphics",e.GroupLayer="group",e.SubtypeGroupLayer="subtype-group",e.SubtypeSublayer="subtype-sublayer",e.ImageryLayer="imagery",e.ImageryTileLayer="imagery-tile",e.OrientedImageryLayer="oriented-imagery",e.IntegratedMeshLayer="integrated-mesh",e.KMLLayer="kml",e.MapImageLayer="map-image",e.MapNotesLayer="map-notes",e.PointCloudLayer="point-cloud",e.SceneLayer="scene",e.TileLayer="tile",e.UnknownLayer="unknown",e.UnsupportedLayer="unsupported",e.VectorTileLayer="vector-tile",e.WMSLayer="wms",e.WMTSLayer="wmts",e.WebTileLayer="web-tile"}(n||(n={}));var c=o(349),l=o(244),u=function(e,t,r,a){return new(r||(r=Promise))((function(o,i){function n(e){try{c(a.next(e))}catch(e){i(e)}}function s(e){try{c(a.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,s)}c((a=a.apply(e,t||[])).next())}))};class d extends((0,c.SetDataSourceMixinImpl)(c.AbstractDataSource)){constructor(e){super(e),this.type=i.Map,this.map=e.map}ready(){return u(this,void 0,void 0,(function*(){return this.map||(yield this.createMap()),this.createFilterUrlChildDataSource()}))}getChildIds(){return this.getLayersAndTables().map((e=>this.getChildIdByLayer(e)))}createChildDataSourceById(e,t,r){const a=this.findLayerInfo(r);return(null==a?void 0:a.layer)?this.createChildDataSourceByLayer(a.layer,t,e,a.order):Promise.reject(new c.DataSourceError(e,"Can not find data source."))}createDataSourceByLayer(e){const t=this.getDataSourceByLayer(e);return t?Promise.resolve(t):this.createDataSourceById(l.dataSourceUtils.getDataSourceIdByJSAPILayer(this,e))}fetchSchema(){return u(this,void 0,void 0,(function*(){var e,t;const r=this.getChildDataSources();let a=(0,l.Immutable)({childSchemas:{},label:this.getDataSourceJson().sourceLabel||(null===(t=null===(e=this.map)||void 0===e?void 0:e.portalItem)||void 0===t?void 0:t.title)});return r.forEach(((e,t)=>{const r=e.getFetchedSchema();a=a.setIn(["childSchemas",e.jimuChildId],r)})),Promise.resolve(a)}))}getDataSourceByLayer(e){return this.dataSourceManager.getDataSource(l.dataSourceUtils.getDataSourceIdByJSAPILayer(this,e))}getDataSourcesByType(e){if(!e)return[];const t=[];return this.traverseToGetDataSourcesByType(e,this,t),t}traverseToGetDataSourcesByType(e,t,r){if(!e||!t||!r)return;t.type===e&&r.push(t);const a=t.isDataSourceSet()&&t.getChildDataSources();a&&a.forEach((t=>{this.traverseToGetDataSourcesByType(e,t,r)}))}createMap(){return u(this,void 0,void 0,(function*(){var e;const t=yield(0,l.loadArcGISJSAPIModules)(["esri/Map","esri/layers/FeatureLayer"]),r=t[0],a=t[1];this.map=new r,null===(e=this.getDataSourceJson().layers)||void 0===e||e.forEach((e=>{this.map.layers.add(new a(e))}))}))}createChildDataSourceByLayer(e,t,r,a){var o,i,n;const s=(null===(i=null===(o=this.getDataSourceJson().schema)||void 0===o?void 0:o.childSchemas)||void 0===i?void 0:i[t])||null,l=(null===(n=this.getDataSourceJson().childDataSourceJsons)||void 0===n?void 0:n[t])||null,u=c.dataSourceJsonCreator.createDataSourceJsonByJSAPILayer(r,e,l,s);if(u){const r={id:u.id,dataSourceJson:u,layer:e,parentDataSource:this,jimuChildId:t,order:a};return this.dataSourceManager.createDataSource(r)}return Promise.reject(new c.DataSourceError(r,"Do not support this type of data."))}findLayerInfo(e){let t;return this.getLayersAndTables().some(((r,a)=>this.getChildIdByLayer(r)===e&&(t={layer:r,order:a},!0))),t}getLayersAndTables(){const e=this.map.layers.toArray().reverse(),t=this.map.ground.layers.toArray().reverse(),r=(this.map.tables?this.map.tables.toArray():[]).reverse();return e.concat(t).concat(r)}getChildIdByLayer(e){return l.dataSourceUtils.getFixedLayerIdByLayer(e)}createFilterUrlChildDataSource(){const e=(0,l.getAppStore)().getState().dataSourcesInfo;return Promise.all(Object.keys(e||{}).filter((t=>{var r;return(null===(r=e[t].widgetQueries)||void 0===r?void 0:r._filterInUrl)&&this.findChildDataSourceIdByDescendantDataSourceId(t)})).map((e=>this.createDataSourceById(e)))).then((()=>{})).catch((e=>{console.error("create filter url child data sources error",e)}))}}var p=function(e,t,r,a){return new(r||(r=Promise))((function(o,i){function n(e){try{c(a.next(e))}catch(e){i(e)}}function s(e){try{c(a.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,s)}c((a=a.apply(e,t||[])).next())}))};class y extends((0,c.ItemMixinImpl)(d)){constructor(e){super(e),this.type=i.WebMap;const t=this.getDataSourceJson();this.portalUrl=t.portalUrl,this.itemId=t.itemId}createMap(){return p(this,void 0,void 0,(function*(){const e=yield(0,l.loadArcGISJSAPIModules)(["esri/WebMap","esri/portal/Portal","esri/portal/PortalItem"]),t=e[0],r=e[1],a=e[2];if(this.getDataSourceJson().portalUrl){const e=new r({url:l.portalUrlUtils.getPlatformUrlByOrgUrl(this.getDataSourceJson().portalUrl)});this.map=new t({portalItem:new a({id:this.getDataSourceJson().itemId,portal:e})})}else this.map=new t({portalItem:new a({id:this.getDataSourceJson().itemId})});this.map.isFulfilled()?this.initItem():yield this.map.load().then((()=>{this.initItem()}))}))}initItem(){var e;this.map&&(this.setItemData(this.map.resourceInfo),this.setItemInfo(null===(e=this.map.portalItem)||void 0===e?void 0:e.sourceJSON))}}var h=function(e,t,r,a){return new(r||(r=Promise))((function(o,i){function n(e){try{c(a.next(e))}catch(e){i(e)}}function s(e){try{c(a.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,s)}c((a=a.apply(e,t||[])).next())}))};class S extends((0,c.ItemMixinImpl)(d)){constructor(e){super(e),this.type=i.WebScene;const t=this.getDataSourceJson();this.portalUrl=t.portalUrl,this.itemId=t.itemId}createMap(){return h(this,void 0,void 0,(function*(){const e=yield(0,l.loadArcGISJSAPIModules)(["esri/WebScene","esri/portal/Portal","esri/portal/PortalItem"]),t=e[0],r=e[1],a=e[2];if(this.getDataSourceJson().portalUrl){const e=new r({url:l.portalUrlUtils.getPlatformUrlByOrgUrl(this.getDataSourceJson().portalUrl)});this.map=new t({portalItem:new a({id:this.getDataSourceJson().itemId,portal:e})})}else this.map=new t({portalItem:new a({id:this.getDataSourceJson().itemId})});this.map.isFulfilled()?this.initItem():yield this.map.load().then((()=>{this.initItem()}))}))}initItem(){var e;this.map&&(this.setItemData(this.map.resourceInfo),this.setItemInfo(null===(e=this.map.portalItem)||void 0===e?void 0:e.sourceJSON))}}class m{createDataSource(e){var t;const r=null!==(t=e.dataSourceJson)&&void 0!==t?t:e.belongToDataSource.getMainDataSource().getDataSourceJson(),a=e.dataViewId&&r.dataViews&&r.dataViews[e.dataViewId]&&r.dataViews[e.dataViewId].type||r.type;return a===i.Map?new d(e):a===i.WebMap?new y(e):a===i.WebScene?new S(e):void console.error("Unimplemented data source type.",a)}}const I=m;return s})())}}}));