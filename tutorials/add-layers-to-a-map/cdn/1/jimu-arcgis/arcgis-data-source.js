System.register(["jimu-core/data-source","jimu-core"],(function(e,t){var r={},a={};return{setters:[function(e){r.AbstractSetDataSource=e.AbstractSetDataSource,r.DataSourceError=e.DataSourceError,r.ItemMixinImpl=e.ItemMixinImpl,r.dataSourceJsonCreator=e.dataSourceJsonCreator},function(e){a.Immutable=e.Immutable,a.dataSourceUtils=e.dataSourceUtils,a.getAppStore=e.getAppStore,a.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules,a.portalUrlUtils=e.portalUrlUtils}],execute:function(){e((()=>{"use strict";var e={891:e=>{e.exports=a},840:e=>{e.exports=r}},t={};function o(r){var a=t[r];if(void 0!==a)return a.exports;var i=t[r]={exports:{}};return e[r](i,i.exports,o),i.exports}o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return(()=>{var e,t;o.r(i),o.d(i,{ArcGISDataSourceFactory:()=>u,ArcGISDataSourceTypes:()=>e,DataSourceTypes:()=>e,LayerTypes:()=>t,MapDataSourceImpl:()=>n,WebMapDataSourceImpl:()=>c,WebSceneDataSourceImpl:()=>l,default:()=>d}),function(e){e.Map="MAP",e.WebMap="WEB_MAP",e.WebScene="WEB_SCENE"}(e||(e={})),function(e){e.BaseDynamicLayer="base-dynamic",e.BaseElevationLayer="base-elevation",e.BaseTileLayer="base-tile",e.BuildingSceneLayer="building-scene",e.CSVLayer="csv",e.ElevationLayer="elevation",e.FeatureLayer="feature",e.GeoJSONLayer="geojson",e.GeoRSSLayer="geo-rss",e.GraphicsLayer="graphics",e.GroupLayer="group",e.SubtypeGroupLayer="subtype-group",e.ImageryLayer="imagery",e.IntegratedMeshLayer="integrated-mesh",e.KMLLayer="kml",e.MapImageLayer="map-image",e.MapNotesLayer="map-notes",e.PointCloudLayer="point-cloud",e.SceneLayer="scene",e.TileLayer="tile",e.UnknownLayer="unknown",e.UnsupportedLayer="unsupported",e.VectorTileLayer="vector-tile",e.WMSLayer="wms",e.WMTSLayer="wmts",e.WebTileLayer="web-tile"}(t||(t={}));var r=o(840),a=o(891),s=function(e,t,r,a){return new(r||(r=Promise))((function(o,i){function s(e){try{c(a.next(e))}catch(e){i(e)}}function n(e){try{c(a.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}c((a=a.apply(e,t||[])).next())}))};class n extends r.AbstractSetDataSource{constructor(t){super(t),this.type=e.Map,this.map=t.map}ready(){return s(this,void 0,void 0,(function*(){return this.map||(yield this.createMap()),a.dataSourceUtils.getWhetherUseProxy()&&this.setProxies(),this.createFilterUrlChildDataSource()}))}getChildIds(){return this.getLayersAndTables().map((e=>this.getChildIdByLayer(e)))}createChildDataSourceById(e,t,a){const o=this.findLayerInfo(a);return(null==o?void 0:o.layer)?this.createChildDataSourceByLayer(o.layer,t,e,o.order):Promise.reject(new r.DataSourceError(e,"Can not find data source."))}createDataSourceByLayer(e){const t=this.getDataSourceByLayer(e);return t?Promise.resolve(t):this.createDataSourceById(a.dataSourceUtils.getDataSourceIdByJSAPILayer(this,e))}fetchSchema(){var e,t;return s(this,void 0,void 0,(function*(){const r=this.getChildDataSources();let o=(0,a.Immutable)({childSchemas:{},label:null===(t=null===(e=this.map)||void 0===e?void 0:e.portalItem)||void 0===t?void 0:t.title});return r.forEach(((e,t)=>{const r=e.getFetchedSchema();o=o.setIn(["childSchemas",e.jimuChildId],r)})),Promise.resolve(o)}))}getDataSourceByLayer(e){return this.dataSourceManager.getDataSource(a.dataSourceUtils.getDataSourceIdByJSAPILayer(this,e))}getDataSourcesByType(e){if(!e)return[];const t=[];return this.traverseToGetDataSourcesByType(e,this,t),t}traverseToGetDataSourcesByType(e,t,r){if(!e||!t||!r)return;t.type===e&&r.push(t);const a=t.isDataSourceSet&&t.getChildDataSources();a&&a.forEach((t=>{this.traverseToGetDataSourcesByType(e,t,r)}))}createMap(){var e;return s(this,void 0,void 0,(function*(){const t=yield(0,a.loadArcGISJSAPIModules)(["esri/Map","esri/layers/FeatureLayer"]),r=t[0],o=t[1];this.map=new r,null===(e=this.getDataSourceJson().layers)||void 0===e||e.forEach((e=>{this.map.layers.add(new o(e))}))}))}setProxies(){var e;const t=(null===(e=this.map.tables)||void 0===e?void 0:e.toArray())||[];a.dataSourceUtils.getWhetherUseProxy()&&this.map.allLayers.toArray().concat(t).forEach((e=>{this.setProxyForLayerOrTable(e)}))}setProxyForLayerOrTable(e){const t=a.dataSourceUtils.getUrlByLayer(e);if(!t)return;const r=a.dataSourceUtils.getDataSourceProxyUrl(t);if(r){e.url=r;const t=e.portalItem;t&&t.when&&t.when((()=>{t.url=e.url,t.sourceJSON&&(t.sourceJSON.url=e.url)}))}}createChildDataSourceByLayer(e,t,a,o){var i,s,n;const c=(null===(s=null===(i=this.getDataSourceJson().schema)||void 0===i?void 0:i.childSchemas)||void 0===s?void 0:s[t])||null,l=(null===(n=this.getDataSourceJson().childDataSourceJsons)||void 0===n?void 0:n[t])||null,u=r.dataSourceJsonCreator.createDataSourceJsonByJSAPILayer(a,e,l,c);if(u){const r={id:u.id,dataSourceJson:u,layer:e,parentDataSource:this,jimuChildId:t,order:o};return this.dataSourceManager.createDataSource(r)}return Promise.reject(new r.DataSourceError(a,"Do not support this type of data."))}findLayerInfo(e){let t;return this.getLayersAndTables().some(((r,a)=>this.getChildIdByLayer(r)===e&&(t={layer:r,order:a},!0))),t}getLayersAndTables(){const e=this.map.layers.toArray().reverse(),t=(this.map.tables?this.map.tables.toArray():[]).reverse();return e.concat(t)}getChildIdByLayer(e){return a.dataSourceUtils.getFixedLayerIdByLayer(e)}createFilterUrlChildDataSource(){const e=(0,a.getAppStore)().getState().dataSourcesInfo;return Promise.all(Object.keys(e||{}).filter((t=>{var r;return(null===(r=e[t].widgetQueries)||void 0===r?void 0:r._filterInUrl)&&this.findChildDataSourceIdByDescendantDataSourceId(t)})).map((e=>this.createDataSourceById(e)))).then((()=>{})).catch((e=>{console.error("create filter url child data sources error",e)}))}}class c extends((0,r.ItemMixinImpl)(n)){constructor(t){super(t),this.type=e.WebMap;const r=this.getDataSourceJson();this.portalUrl=r.portalUrl,this.itemId=r.itemId}createMap(){return e=this,t=void 0,o=function*(){const e=yield(0,a.loadArcGISJSAPIModules)(["esri/WebMap","esri/portal/Portal","esri/portal/PortalItem"]),t=e[0],r=e[1],o=e[2];if(this.getDataSourceJson().portalUrl){const e=new r({url:a.portalUrlUtils.getPlatformUrlByOrgUrl(this.getDataSourceJson().portalUrl)});this.map=new t({portalItem:new o({id:this.getDataSourceJson().itemId,portal:e})})}else this.map=new t({portalItem:new o({id:this.getDataSourceJson().itemId})});this.map.isFulfilled()?this.initItem():yield this.map.load().then((()=>{this.initItem()}))},new((r=void 0)||(r=Promise))((function(a,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function n(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}c((o=o.apply(e,t||[])).next())}));var e,t,r,o}initItem(){var e;this.map&&(this.setItemData(this.map.resourceInfo),this.setItemInfo(null===(e=this.map.portalItem)||void 0===e?void 0:e.sourceJSON))}}class l extends((0,r.ItemMixinImpl)(n)){constructor(t){super(t),this.type=e.WebScene;const r=this.getDataSourceJson();this.portalUrl=r.portalUrl,this.itemId=r.itemId}createMap(){return e=this,t=void 0,o=function*(){const e=yield(0,a.loadArcGISJSAPIModules)(["esri/WebScene","esri/portal/Portal","esri/portal/PortalItem"]),t=e[0],r=e[1],o=e[2];if(this.getDataSourceJson().portalUrl){const e=new r({url:a.portalUrlUtils.getPlatformUrlByOrgUrl(this.getDataSourceJson().portalUrl)});this.map=new t({portalItem:new o({id:this.getDataSourceJson().itemId,portal:e})})}else this.map=new t({portalItem:new o({id:this.getDataSourceJson().itemId})});this.map.isFulfilled()?this.initItem():yield this.map.load().then((()=>{this.initItem()}))},new((r=void 0)||(r=Promise))((function(a,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function n(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}c((o=o.apply(e,t||[])).next())}));var e,t,r,o}initItem(){var e;this.map&&(this.setItemData(this.map.resourceInfo),this.setItemInfo(null===(e=this.map.portalItem)||void 0===e?void 0:e.sourceJSON))}}class u{createDataSource(t){var r;const a=null!==(r=t.dataSourceJson)&&void 0!==r?r:t.belongToDataSource.getMainDataSource().getDataSourceJson(),o=t.dataViewId&&a.dataViews&&a.dataViews[t.dataViewId]&&a.dataViews[t.dataViewId].type||a.type;return o===e.Map?new n(t):o===e.WebMap?new c(t):o===e.WebScene?new l(t):void console.error("Unimplemented data source type.",o)}}const d=u})(),i})())}}}));