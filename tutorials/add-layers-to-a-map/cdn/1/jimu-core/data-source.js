System.register(["jimu-core"],(function(e,t){var i={};return{setters:[function(e){i.AppMode=e.AppMode,i.CONSTANTS=e.CONSTANTS,i.DataSourceManager=e.DataSourceManager,i.Immutable=e.Immutable,i.JimuFieldType=e.JimuFieldType,i.ServiceManager=e.ServiceManager,i.TimezoneConfig=e.TimezoneConfig,i.UrlManager=e.UrlManager,i.appActions=e.appActions,i.dataSourceUtils=e.dataSourceUtils,i.esri=e.esri,i.getAppStore=e.getAppStore,i.i18n=e.i18n,i.jimuHistory=e.jimuHistory,i.loadArcGISJSAPIModule=e.loadArcGISJSAPIModule,i.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules,i.lodash=e.lodash,i.moduleLoader=e.moduleLoader,i.observeStore=e.observeStore,i.portalUrlUtils=e.portalUrlUtils,i.proxyUtils=e.proxyUtils,i.requestUtils=e.requestUtils,i.semver=e.semver,i.utils=e.utils,i.uuidv1=e.uuidv1}],execute:function(){e((()=>{"use strict";var e={8891:e=>{e.exports=i}},t={};function r(i){var a=t[i];if(void 0!==a)return a.exports;var s=t[i]={exports:{}};return e[i](s,s.exports,r),s.exports}r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};return(()=>{r.r(a),r.d(a,{AbstractDataRecord:()=>v,AbstractDataSource:()=>D,AbstractLayerFolderDataSource:()=>E,AbstractLoadableDataSource:()=>j,AbstractQueriableDataSource:()=>k,AbstractSetDataSource:()=>A,AllDataSourceTypes:()=>o,ArcGISDataSourceTypes:()=>i,CSVDataSourceImpl:()=>Z,DataSourceError:()=>g,DataSourceSelectionMode:()=>S,DataSourceStatus:()=>e,DataSourceTypes:()=>t,FeatureDataRecordImpl:()=>K,FeatureLayerDataSourceImpl:()=>ie,FeatureServiceDataSourceImpl:()=>re,GroupLayerDataSourceImpl:()=>ae,ItemMixinImpl:()=>b,JSAPILayerMixinImpl:()=>R,JimuCoreDataSourceFactory:()=>me,MapServiceDataSourceImpl:()=>se,QueryScope:()=>h,SceneLayerDataSourceImpl:()=>ue,SceneServiceDataSourceImpl:()=>le,SimpleDataRecordImpl:()=>f,SimpleDataRecordSetImpl:()=>p,SimpleLocalDataSourceImpl:()=>ne,SupportedItemTypes:()=>d,SupportedJSAPILayerTypes:()=>u,SupportedLayerServiceTypes:()=>n,SupportedLayerTypesInWebMapSpec:()=>c,SupportedServerTypes:()=>l,dataSourceJsonCreator:()=>s,default:()=>De});var e,t,i,s={};r.r(s),r.d(s,{createDataSourceJson:()=>O,createDataSourceJsonByItemData:()=>B,createDataSourceJsonByItemInfo:()=>U,createDataSourceJsonByJSAPILayer:()=>V,createDataSourceJsonByLayerDefinition:()=>T,getDataSourceTypeFromArcGISWholeServiceUrl:()=>M}),function(e){e.NotCreated="NOT_CREATED",e.Created="CREATED",e.CreateError="CREATE_ERROR",e.NotReady="NOT_READY",e.Unloaded="UNLOADED",e.Loading="LOADING",e.Loaded="LOADED",e.LoadError="LOAD_ERROR",e.Saving="SAVING",e.Saved="SAVED",e.SaveError="SAVE_ERROR",e.Closed="CLOSED",e.Connecting="CONNECTING",e.Connected="CONNECTED",e.Closing="CLOSING"}(e||(e={})),function(e){e.Error="ERROR",e.SimpleLocal="SIMPLE_LOCAL",e.CSV="CSV",e.FeatureLayer="FEATURE_LAYER",e.SceneLayer="SCENE_LAYER",e.GroupLayer="GROUP_LAYER",e.FeatureService="FEATURE_SERVICE",e.MapService="MAP_SERVICE",e.SceneService="SCENE_SERVICE",e.ImageService="IMAGE_SERVICE",e.VectorTileService="VECTOR_TILE_SERVICE",e.GeoJSON="GEO_JSON",e.KML="KML",e.WFS="WFS",e.WMS="WMS",e.WMTS="WMTS"}(t||(t={})),function(e){e.Map="MAP",e.WebMap="WEB_MAP",e.WebScene="WEB_SCENE"}(i||(i={}));const o=Object.assign(Object.assign({},t),i);var n,l,d,u,c,h,S;!function(e){e.FeatureLayer="Feature Layer",e.Table="Table",e.GroupLayer="Group Layer",e.SceneLayerPoint="Point",e.SceneLayer3DObject="3DObject"}(n||(n={})),function(e){e.FeatureService="FeatureServer",e.MapService="MapServer",e.SceneService="SceneServer",e.ImageService="ImageServer",e.VectorTileService="VectorTileServer"}(l||(l={})),function(e){e.WebMap="Web Map",e.WebScene="Web Scene",e.FeatureService="Feature Service",e.MapService="Map Service",e.SceneService="Scene Service",e.ImageService="Image Service",e.VectorTileService="Vector Tile Service",e.FeatureCollection="Feature Collection",e.GroupLayer="Group Layer",e.CSV="CSV",e.GeoJSON="GeoJson",e.KML="KML",e.WFS="WFS",e.WMS="WMS",e.WMTS="WMTS",e.GeometryService="Geometry Service",e.GeocodingService="Geocoding Service",e.GeoprocessingService="Geoprocessing Service",e.NetworkAnalysisService="Network Analysis Service",e.GeoenrichmentService="Geoenrichment service"}(d||(d={})),function(e){e.FeatureLayer="feature",e.MapImageLayer="map-image",e.TileLayer="tile",e.GroupLayer="group",e.SceneLayer="scene",e.ImageryLayer="imagery",e.ImageryTileLayer="imagery-tile",e.VectorTileLayer="vector-tile",e.KMLLayer="kml",e.CSVLayer="csv",e.GeoJSONLayer="geojson",e.WFSLayer="wfs",e.WMSLayer="wms",e.WMTSLayer="wmts"}(u||(u={})),function(e){e.FeatureLayer="ArcGISFeatureLayer",e.SceneLayer="ArcGISSceneServiceLayer",e.GroupLayer="GroupLayer",e.MapService="ArcGISMapServiceLayer",e.TiledMapService="ArcGISTiledMapServiceLayer",e.VectorTileService="VectorTileLayer",e.ImageService="ArcGISImageServiceLayer",e.TiledImageService="ArcGISTiledImageServiceLayer",e.CSV="CSV",e.GeoJSON="GeoJSON",e.KML="KML",e.WFS="WFS",e.WMS="WMS"}(c||(c={}));class g extends Error{constructor(e,t){super(`data source id: ${e}, ${t}`),this.dataSourceId=e}}!function(e){e.InAllData="IN_ALL_DATA",e.InRemoteConfigView="IN_REMOTE_CONFIG_VIEW",e.InConfigView="IN_CONFIG_VIEW",e.InRuntimeView="IN_RUNTIME_VIEW"}(h||(h={})),function(e){e.New="New",e.AddToCurrent="AddToCurrent",e.RemoveFromCurrent="RemoveFromCurrent",e.SelectFromCurrent="SelectFromCurrent"}(S||(S={}));var y=r(8891);class v{clone(e){const t=y.lodash.clone(this);return e?(t.setData(y.lodash.cloneDeep(this.getData())),t):t}getFieldValue(e){return this.getData()[e]}getDateFieldValue(e){return this.getFieldValue(e)}getFormattedFieldValue(e,t){const i=this.dataSource.getSchema().fields[e];if(!i)return this.getFieldValue(e);if(i.format)switch(i.type){case y.JimuFieldType.Date:return this.formatDateField(this.getDateFieldValue(e),i.format.dateFormat,t);case y.JimuFieldType.Number:return this.formatNumberField(this.getFieldValue(e),i.format.places,i.format.digitSeparator,t);default:return this.getFieldValue(e)}else switch(i.type){case y.JimuFieldType.Date:return null!==this.getFieldValue(e)&&void 0!==this.getFieldValue(e)?t.formatDate(this.getDateFieldValue(e)):null;case y.JimuFieldType.Number:return null!==this.getFieldValue(e)&&void 0!==this.getFieldValue(e)?t.formatNumber(this.getFieldValue(e)):null;default:return this.getFieldValue(e)}}convertBeforeMappingDataToData(e){const t={},i=this.dataSource.getReversedConfigSchema();return Object.keys(e).forEach((r=>{const a=i&&i.fields&&i.fields[r];a?a.forEach((i=>{t[i.jimuName]=e[r]})):t[r]=e[r]})),t}convertDataToDataBeforeMapping(e){const t={},i=this.dataSource.getSchema();return Object.keys(e).forEach((r=>{const a=i&&i.fields&&i.fields[r]?i.fields[r].name:r;t[a]=e[r]})),t}getFormattedData(e){const t={};return Object.keys(this.getData()).forEach((i=>{t[i]=this.getFormattedFieldValue(i,e)})),t}formatDateField(e,t,i){return y.dataSourceUtils.formatDateField(e,t,i)}formatNumberField(e,t,i,r){if(null==e)return null;const a=new Number(e);return i?r.formatNumber(e,{maximumFractionDigits:t,minimumFractionDigits:t}):a.toFixed(t)}set dataSource(e){this._dataSource=e}get dataSource(){return this._dataSource}}class f extends v{constructor(e,t,i=!0){super(),this.dataSource=t,this.data=i?this.convertBeforeMappingDataToData(e):e}getData(){return this.data}setData(e){this.data=e}getDataBeforeMapping(){return this.convertDataToDataBeforeMapping(this.data)}toJson(){return this.data}getId(){return this.data.id}setId(){}getGeometry(){return null}getRawGeometry(){return null}setGeometry(e){}}class p{constructor(e){Object.assign(this,e)}}var m=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}))};class D{constructor(e){if(this.isDataSourceSet=!1,this.records=[],this.dataSourceManager=e.dataSourceManager,Object.assign(this,e),this.originDataSourceJson=e.dataSourceJson,e.dataSourceJson)this.isDataView=!1,this.isLocal=!1,e.dataSourceJson.url&&(this.url=e.dataSourceJson.url);else{if(!e.belongToDataSource)return void console.error("bad DataSourceConstructorOptions.");e.localId?(this.isLocal=!0,this.isDataView=!1):(this.isLocal=!1,this.isDataView=!0)}this.getDataSourceJson().isDataInDataSourceInstance&&(this.sourceRecords=e.sourceRecords,this.url=null),this.isLocal?this.listenSelection=!1:this.listenSelection=!0}ready(){return Promise.resolve()}get url(){return y.dataSourceUtils.getWhetherUseProxy()&&y.dataSourceUtils.getDataSourceProxyUrl(this._url)||this._url}set url(e){this.getDataSourceJson().isDataInDataSourceInstance||(this._url=e)}isInAppConfig(){var e,t;return!!(null===(e=(0,y.getAppStore)().getState().appConfig.dataSources)||void 0===e?void 0:e[(null===(t=this.getRootDataSource())||void 0===t?void 0:t.id)||this.id])}getLabel(){if(this.isLocal)return this.belongToDataSource.getLabel();if(this.isDataView){if(this.dataViewId===y.CONSTANTS.OUTPUT_DATA_VIEW_ID&&this.getDataSourceJson().isOutputFromWidget)return y.i18n.getIntl().formatMessage({id:"outputView"},{dataSourceLabel:this.belongToDataSource.getLabel()});const e=this.getMainDataSource().getDataSourceJson(),t=(null==e?void 0:e.dataViews)&&e.dataViews[this.dataViewId];return(null==t?void 0:t.label)||this.belongToDataSource.getLabel()}return this.getDataSourceJson().label||this.getSchema().label}getDataSourceJson(){if(this.isDataView||this.isLocal){let e=this.getMainDataSource().getDataSourceJson();return this.dataViewId===y.CONSTANTS.SELECTION_DATA_VIEW_ID&&(e=e.set("isDataInDataSourceInstance",!0)),e}return this.dataSourceJson}setDataSourceJson(e){e?this.dataSourceJson?this.dataSourceJson=this.traverseToMergeDataSourceJson(this.dataSourceJson,e):this.dataSourceJson=e:this.dataSourceJson=this.originDataSourceJson}traverseToMergeDataSourceJson(e,t){if(!e&&!t)return console.error("Can not merge data source json since do not have base data source json or new data source json."),(0,y.Immutable)({});if(!e)return t;if(!t)return e;const i=this.dataSourceManager.getDataSource(e.id);if(!i)return e;let r=e.merge(t.asMutable({deep:!0}));return["label","isHidden","useFields","query","dataViews","childDataSourceJsons","schema","url","itemId","portalUrl"].forEach((a=>{t[a]||(r=r.without(a)),t[a]&&"schema"===a&&(r=r.set("schema",t.schema)),!t[a]||"url"!==a&&"portalUrl"!==a&&"itemId"!==a||(r=r.set(a,t[a]),i[a]=t[a],i.canSaveSourceRecords()&&i.getAllDerivedDataSources().forEach((e=>{e[a]=t[a]}))),e[a]&&"useFields"===a&&(r=t.schema?r.set("useFields",e.useFields.filter((e=>{var i;return!!(null===(i=t.schema.fields)||void 0===i?void 0:i[e])}))):r.set("useFields",e.useFields))})),r.childDataSourceJsons&&Object.keys(r.childDataSourceJsons).forEach((a=>{var s;const o=i.traverseToMergeDataSourceJson(null===(s=null==e?void 0:e.childDataSourceJsons)||void 0===s?void 0:s[a],t.childDataSourceJsons[a]);r=r.setIn(["childDataSourceJsons",a],o)})),r}getSchema(){return this.isDataView||this.isLocal?this.getMainDataSource().getSchema():this.schema||{}}getSelectedFields(){var e,t,i,r;let a;if(this.isLocal)return this.belongToDataSource.getSelectedFields();if(this.isSelectionView()||this.dataViewId===y.CONSTANTS.OUTPUT_DATA_VIEW_ID)return this.getMainDataSource().getSelectedFields();const s=(null===(e=this.getSchema())||void 0===e?void 0:e.fields)?Object.keys(this.getSchema().fields):[];if(a=this.isDataView?null===(i=null===(t=this.getDataSourceJson().dataViews)||void 0===t?void 0:t[this.dataViewId])||void 0===i?void 0:i.outFields:null===(r=this.getDataSourceJson().query)||void 0===r?void 0:r.outFields,!a&&!this.selectedFields)return s;let o=s;return a&&(o=o.filter((e=>a.includes(e)))),this.selectedFields&&(o=o.filter((e=>this.selectedFields.includes(e)))),o}getAllUsedFields(e){let t;return t="*"===this.getLoadOnDemandUsedFields()?this.getLoadOnDemandUsedFields(e):this.mergeUsedFields(this.getLoadOnDemandUsedFields(e),this.getConfigUsedFields(e)),"debug"===(null==e?void 0:e.logLevel)&&"*"===t&&console.warn("All used fields are * since used fields length equals schema fields length."),t}_printUsedFieldsDetail(e){this.getAllUsedFields(Object.assign({logLevel:"debug",excludeWidgetsDoNotUseDsToQuery:!0},e))}getLoadOnDemandUsedFields(e){return"debug"===(null==e?void 0:e.logLevel)&&console.log("Load on demand fields are:",this.loadOnDemandFields),this.loadOnDemandFields}getConfigUsedFields(e){var t,i,r;if(this.isLocal)return[];if(this.dataViewId===y.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION)return window.jimuConfig.isInBuilder?"*":null===(t=this.getMainDataSource().getDataView(y.CONSTANTS.SELECTION_DATA_VIEW_ID))||void 0===t?void 0:t.getAllUsedFields();"debug"===(null==e?void 0:e.logLevel)&&console.group("Config used fields");const a=null===(i=(0,y.getAppStore)().getState().appConfig)||void 0===i?void 0:i.widgets,s=null===(r=(0,y.getAppStore)().getState().appConfig)||void 0===r?void 0:r.messageConfigs;let o=[];s&&Object.values(s).forEach((e=>{var t,i;e.actions&&(o=o.concat(null===(i=(t=e.actions).asMutable)||void 0===i?void 0:i.call(t)))}));const n=(a?Object.values(a):[]).concat(o),l=[];n.every((t=>{var i,r;const a=(null==e?void 0:e.excludeWidgetsDoNotUseDsToQuery)&&(null===(r=null===(i=t.manifest)||void 0===i?void 0:i.properties)||void 0===r?void 0:r.notAutoLoadUsedFieldsData);return t.useDataSources&&t.useDataSources.every((i=>{var r,s,o,n,d,u,c,h,S;if((null==i?void 0:i.dataSourceId)!==(null===(r=this.getSelectionDataView())||void 0===r?void 0:r.id)&&a)return!0;const g=(null==i?void 0:i.dataSourceId)===this.id,y=(null==i?void 0:i.dataSourceId)===(null===(s=this.getSelectionDataView())||void 0===s?void 0:s.id),v=this.isSelectionView()&&(null==i?void 0:i.mainDataSourceId)===this.getMainDataSource().id,f=this.getDataSourceJson().isOutputFromWidget&&!this.getDataSourceJson().schema&&1===(null===(o=this.getDataSourceJson().originDataSources)||void 0===o?void 0:o.length)&&(null==i?void 0:i.dataSourceId)===this.getDataSourceJson().originDataSources[0].dataSourceId,p=this.getDataSourceJson().isOutputFromWidget&&!this.isDataView&&(null==i?void 0:i.mainDataSourceId)===this.getMainDataSource().id,m=(null==i?void 0:i.dataSourceId)===(null===(d=null===(n=this.getAssociatedDataSource)||void 0===n?void 0:n.call(this))||void 0===d?void 0:d.id);if(g||y||v||f||p||m){if(i.fields&&l.push(...i.fields),i.useFieldsInPopupInfo){const i=(null===(S=null===(h=null===(c=null===(u=this.getPopupInfo)||void 0===u?void 0:u.call(this))||void 0===c?void 0:c.fieldInfos)||void 0===h?void 0:h.map((e=>!1===e.visible?null:this.findJimuFieldName(e.fieldName))))||void 0===S?void 0:S.filter((e=>!!e)))||[];i.length>0?l.push(...i):("debug"===(null==e?void 0:e.logLevel)&&console.warn("Config used fields are * since widget uses popup info fields, but can not find them.",t.id||t.actionId),l.push("*"))}i.useFieldsInSymbol&&("debug"===(null==e?void 0:e.logLevel)&&console.warn("Config used fields are * since widget uses symbol fields.",t.id||t.actionId),l.push("*"))}return!l.includes("*")})),"debug"===(null==e?void 0:e.logLevel)&&console.log("Accumulated config used fields are:",l,t.id||t.actionId),!l.includes("*")}));let d=l.includes("*")?"*":Array.from(new Set(l));return"*"!==d&&(d=d.filter((e=>{var t,i;return!!(null===(i=null===(t=this.getSchema())||void 0===t?void 0:t.fields)||void 0===i?void 0:i[e])}))),"debug"===(null==e?void 0:e.logLevel)&&(console.log("Final config used fields are:",l),console.groupEnd()),d}updateLoadOnDemandFields(e){e&&(this.loadOnDemandFields=this.mergeUsedFields(this.loadOnDemandFields,this.findMissingFields(e,this.getConfigUsedFields())),"*"!==this.loadOnDemandFields&&(this.loadOnDemandFields=this.loadOnDemandFields.filter((e=>{var t,i;return!!(null===(i=null===(t=this.getSchema())||void 0===t?void 0:t.fields)||void 0===i?void 0:i[e])}))))}mergeUsedFields(e,t){if("*"===e||"*"===t)return"*";if(Array.isArray(e)&&Array.isArray(t)){let i=Array.from(new Set(e.concat(t))).filter((e=>!!e));return i.length===Object.keys(this.getSchema().fields).length&&(i="*"),i}return e||t||[]}missingSomeFields(e,t){return"*"!==t&&this.findMissingFields(e,t).length>0}findMissingFields(e,t){const i=this.getSelectedFields(),r="*"===e?i:e,a="*"===t?i:t,s=[];return null==r||r.forEach((e=>{(null==a?void 0:a.includes(e))||s.push(e)})),s}findJimuFieldName(e){const t=this.getSchema();let i=null;return(null==t?void 0:t.fields)&&(i=Object.keys(t.fields).find((i=>t.fields[i].name===e))),i}setSelectedFields(e){this.selectedFields=e}setSchema(e){this.schema=e}fetchSchema(){return m(this,void 0,void 0,(function*(){return yield Promise.resolve((0,y.Immutable)({}))}))}getFetchedSchema(){return this.isDataView||this.isLocal?this.getMainDataSource().getFetchedSchema():this.fetchedSchema}setFetchedSchema(e){this.fetchedSchema=e}getGeometryType(){return null}getReversedConfigSchema(){if(this.isDataView||this.isLocal)return this.getMainDataSource().getReversedConfigSchema();if(this.reverseSchema)return this.reverseSchema;if(this.isDataSourceSet){const e=this.getDataSourceJson().schema,t={childSchemas:{}};if(!e)return(0,y.Immutable)({});if(!e.childSchemas)return(0,y.Immutable)({label:e.label,childId:e.childId,jimuChildId:e.jimuChildId});Object.keys(e.childSchemas).forEach((i=>{const r=e.childSchemas[i].childId;t.childSchemas[r]?t.childSchemas[r].push(this.getOneReversedConfigSchema(e.childSchemas[i])):t.childSchemas[r]=[this.getOneReversedConfigSchema(e.childSchemas[i])]})),this.reverseSchema=(0,y.Immutable)(t)}else this.reverseSchema=this.getOneReversedConfigSchema(this.getDataSourceJson().schema);return this.reverseSchema}setRecords(e){this.records=e,this.addVersion()}getOneReversedConfigSchema(e){const t={};return e?(t.fields={},Object.keys(e.fields).forEach((i=>{const r=e.fields[i].asMutable({deep:!0});t.fields[r.name]?t.fields[r.name].push(r):t.fields[r.name]=[r]})),e.childId&&(t.childId=e.childId),e.jimuChildId&&(t.jimuChildId=e.jimuChildId),(0,y.Immutable)(t)):(0,y.Immutable)(t)}getStatus(){return(0,y.getAppStore)().getState().dataSourcesInfo[this.id]&&(0,y.getAppStore)().getState().dataSourcesInfo[this.id].status}setStatus(e){(0,y.getAppStore)().dispatch(y.appActions.dataSourceStatusChanged(this.id,e))}getCountStatus(){return(0,y.getAppStore)().getState().dataSourcesInfo[this.id]&&(0,y.getAppStore)().getState().dataSourcesInfo[this.id].countStatus}setCountStatus(e){(0,y.getAppStore)().dispatch(y.appActions.dataSourceCountStatusChanged(this.id,e))}getVersion(){var e;return null===(e=(0,y.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.version}addVersion(){(0,y.getAppStore)().dispatch(y.appActions.dataSourceVersionAdded(this.id))}getSourceVersion(){var e;return this.canSaveSourceRecords()?null===(e=(0,y.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.sourceVersion:this.getMainDataSource().getSourceVersion()}addSourceVersion(){this.canSaveSourceRecords()&&(0,y.getAppStore)().dispatch(y.appActions.dataSourceSourceVersionAdded(this.id))}getSelectedRecordIdsFromInfo(){var e,t;return(null===(t=null===(e=(0,y.getAppStore)().getState().dataSourcesInfo)||void 0===e?void 0:e[this.id])||void 0===t?void 0:t.selectedIds)||(0,y.Immutable)([])}getSelectOptionsFromInfo(){var e,t;return null===(t=null===(e=(0,y.getAppStore)().getState().dataSourcesInfo)||void 0===e?void 0:e[this.id])||void 0===t?void 0:t.selectOptions}updateSelectionInfo(e,t){e&&(this.getListenSelection()||this.id===(null==t?void 0:t.id))&&(0,y.getAppStore)().dispatch(y.appActions.dataSourceSelectionChanged(this.id,e))}buildRecord(e){return new f(e,this)}getRecords(){return this.records}getRecordsWithSelection(){return this.concatRecordsAndSelection(this.getSelectedRecords(),this.getRecords())}concatRecordsAndSelection(e,t){var i;const r=t||[];return null===(i=null==e?void 0:e.reverse())||void 0===i||i.forEach((e=>{(null==t?void 0:t.some((t=>(null==t?void 0:t.getId())===(null==e?void 0:e.getId()))))||r.unshift(e)})),r}clearSourceRecordsNotAddVersion(){this.clearRecordsNotAddVersion(),this.sourceRecords=[]}clearSourceRecords(){this.clearSourceRecordsNotAddVersion(),this.addSourceVersion(),this.addVersion()}setSourceRecords(e){if(this.canSaveSourceRecords()){this.clearRecordsNotAddVersion();const t=!this.isSelectionView();t&&y.lodash.defer((()=>{this.updateSelectionInfo({widgetId:null,ids:[]},this.getMainDataSource())})),this.sourceRecords=e.filter((e=>!!e)).map((e=>(e.dataSource=this,e))),this.getAllDerivedDataSources().forEach((e=>{e.clearRecords(),t&&y.lodash.defer((()=>{e.updateSelectionInfo({widgetId:null,ids:[]},e.getMainDataSource())}))})),this.addSourceVersion(),this.addVersion()}}getSourceRecords(){var e;if(!this.canSaveSourceRecords())return this.isLocalViewOfSelectionView()?this.belongToDataSource.getSourceRecords():this.getMainDataSource().getSourceRecords();let t=this.sourceRecords||[];if(this.useNoSelectionView(this)){const i=this.getMainDataSource().getDataView(y.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION);i&&(t=null===(e=i.getRecords())||void 0===e?void 0:e.map((e=>(e.dataSource=this,e))))}return t}useNoSelectionView(e=this){const t=e.sourceRecords||[];return e.isDataView&&e.dataViewId===y.CONSTANTS.SELECTION_DATA_VIEW_ID&&0===t.length&&e.getMainDataSource().getDataView(y.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION)&&0===e.getMainDataSource().getSelectedRecordIds().filter((e=>!!e)).length}canSaveSourceRecords(){return!this.isDataView&&!this.isLocal||this.isSelectionView()}getSelectionDataView(){const e=this.isDataView||this.isLocal?this.getMainDataSource().id:this.id;return this.dataSourceManager.getDataViewDataSource(e,y.CONSTANTS.SELECTION_DATA_VIEW_ID)}getSelectedRecords(){const e=this.getSelectionDataView(),t=e?e.getRecords():[],i=this.getSelectedRecordIds();return t.filter((e=>i.includes(e.getId())))}getSelectedRecordIndexes(){if(!(0,y.getAppStore)().getState().dataSourcesInfo[this.id])return[];const e=this.isDataView||this.isLocal?this.getMainDataSource().id:this.id;return(0,y.getAppStore)().getState().dataSourcesInfo[e].selectedIds?(0,y.getAppStore)().getState().dataSourcesInfo[e].selectedIds.asMutable().map((e=>this.getRecords().findIndex((t=>t.getId()===e)))):[]}getSelectedRecordIds(){return this.isSelectionView()?this.getMainDataSource().getSelectedRecordIdsFromInfo().asMutable():this.getSelectedRecordIdsFromInfo().asMutable()}nextRecord(){if(this.getSelectedRecordIndexes().length>1)return console.warn('method "nextRecord" only works when single record is selected'),null;if(this.getSelectedRecordIndexes().indexOf(this.getRecords().length-1))throw Error("Reach the end of data.");return(0,y.getAppStore)().dispatch(y.appActions.dataSourceSelectedIndexesChanged(this.id,[this.getSelectedRecordIndexes()[0]++])),this.getSelectedRecords()[0]}prevRecord(){if(this.getSelectedRecordIndexes().length>1)return console.warn('method "prevRecord" only works when single record is selected'),null;if(this.getSelectedRecordIndexes().indexOf(0))throw Error("Reach the start of data.");return(0,y.getAppStore)().dispatch(y.appActions.dataSourceSelectedIndexesChanged(this.id,[this.getSelectedRecordIndexes()[0]--])),this.getSelectedRecords()[0]}getRecord(e){return this.getRecords()[e]}getSourceRecord(e){return this.getSourceRecords()[e]}getRecordById(e){return this.getRecords().filter((t=>t&&t.getId()===e))[0]}getSourceRecordById(e){return this.getSourceRecords().filter((t=>t&&t.getId()===e))[0]}clearSelection(){this.copySelectionToDataView([]),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:[]})}updateSelectionInfoOfDerivedDssAndChangeUrl(e,t,i){const r=this.getMainDataSource(),a=t||r;a.getAllDerivedDataSources().forEach((t=>{t.id!==this.dataSourceManager.getDataViewDataSourceId(r.id,y.CONSTANTS.SELECTION_DATA_VIEW_ID)&&t.id!==this.dataSourceManager.getDataViewDataSourceId(r.id,y.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION)&&t.updateSelectionInfo(e,this,i)})),a.updateSelectionInfo(e,this,i),a.id===r.id&&y.UrlManager.getInstance().changeHashObjectByDataSourceSelection(r.id,e)}selectRecord(e){const t=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecord(e):this.getRecord(e);t&&(this.copySelectionToDataView([t]),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:[t.getId()]}))}selectRecords(e){let t=[];if(null==e?void 0:e.records)t=e.records;else if(null==e?void 0:e.ids){const i=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords();t=e.ids.map((e=>i.find((t=>(null==t?void 0:t.getId())===e))))}return this.copySelectionToDataView(t),this.updateSelectionInfoOfDerivedDssAndChangeUrl(e),Promise.resolve({records:t})}selectRecordById(e,t){if(this.getSelectedRecordIds().find((t=>t===e)))return;let i;i=this.getDataSourceJson().isDataInDataSourceInstance?t||e&&this.getSourceRecordById(e):t||e&&this.getRecordById(e),i?(this.copySelectionToDataView([i]),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:[e]})):(this.copySelectionToDataView([]),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:[]}))}selectRecordsByIds(e,t){const i=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),r=t||e.map((e=>i.find((t=>(null==t?void 0:t.getId())===e))));this.copySelectionToDataView(r),this.updateSelectionInfoOfDerivedDssAndChangeUrl({widgetId:null,ids:e})}copySelectionToDataView(e){const t=this.getSelectionDataView();t&&(t.setSourceRecords(e.filter((e=>!!e))),t.setRecords(e.filter((e=>!!e))))}getInfo(){return(0,y.getAppStore)().getState().dataSourcesInfo[this.id]||(0,y.Immutable)({})}clearRecords(){this.clearRecordsNotAddVersion(),this.addVersion()}clearRecordsNotAddVersion(){!this.isSelectionView()&&this.getSelectedRecords().length>0&&this.copySelectionToDataView([]),this.records=[]}getIdField(){return this.getSchema()&&this.getSchema().idField||"id"}getRootDataSource(){if(this.isDataView||this.isLocal)return this.getMainDataSource().getRootDataSource();let e=this.parentDataSource;for(;e&&e.parentDataSource;)e=e.parentDataSource;return e}getOriginDataSources(){return this.isDataView||this.isLocal?this.getMainDataSource().getOriginDataSources():this.getDataSourceJson().originDataSources&&0!==this.getDataSourceJson().originDataSources.length?this.getDataSourceJson().originDataSources.asMutable().map((e=>this.dataSourceManager.getDataSource(e.dataSourceId))):[]}getMainDataSource(){var e;return this.belongToDataSource?null!==(e=this.belongToDataSource.belongToDataSource)&&void 0!==e?e:this.belongToDataSource:this}getDataViews(){return this.getMainDataSource()!==this?[]:this.dataSourceManager.getDataSourcesAsArray().filter((e=>e.belongToDataSource===this&&e.isDataView))}getDataView(e){return this.getDataViews().find((t=>t.dataViewId===e))}getDataViewConfig(){return this.isLocal?this.belongToDataSource.getDataViewConfig():this.isDataView?this.getDataSourceJson().dataViews&&this.getDataSourceJson().dataViews[this.dataViewId]:this.getDataSourceJson().query}getLocalDataSources(){return this.isLocal?[]:this.dataSourceManager.getDataSourcesAsArray().filter((e=>e.belongToDataSource===this&&e.isLocal))}getLocalDataSource(e){return this.getLocalDataSources().find((t=>t.localId===e))}getAllDerivedDataSources(){let e=[];const t=this.getDataViews(),i=this.getLocalDataSources();return e=t.concat(i),t.forEach((t=>{e=e.concat(t.getLocalDataSources())})),e}getSaveStatus(){var e;return null===(e=(0,y.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.saveStatus}setSaveStatus(e){(0,y.getAppStore)().dispatch(y.appActions.dataSourceSaveStatusChanged(this.id,e))}setListenSelection(e){this.listenSelection=e}getListenSelection(){return this.listenSelection}isSelectionView(){return this.isDataView&&this.dataViewId===y.CONSTANTS.SELECTION_DATA_VIEW_ID}isLocalViewOfSelectionView(){return this.isLocal&&this.dataViewId===y.CONSTANTS.SELECTION_DATA_VIEW_ID}addRecord(t){return m(this,void 0,void 0,(function*(){return t?(this.setSaveStatus(e.Saving),yield this.doAddRecord(t).then((t=>(this.setSaveStatus(e.Saved),t)),(t=>m(this,void 0,void 0,(function*(){return this.setSaveStatus(e.SaveError),yield Promise.reject(t)}))))):yield Promise.reject("No record passed in.")}))}doAddRecord(e){return m(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doAddRecordToSourceRecords(e):yield Promise.reject("Editing source is not ready yet.")}))}updateRecord(e){return m(this,void 0,void 0,(function*(){return yield this.updateRecords([e])}))}updateRecords(t){return m(this,void 0,void 0,(function*(){return t&&0!==t.length?(this.setSaveStatus(e.Saving),yield this.doUpdateRecords(t).then((t=>(this.setSaveStatus(e.Saved),t)),(t=>m(this,void 0,void 0,(function*(){return this.setSaveStatus(e.SaveError),yield Promise.reject(t)}))))):yield Promise.reject("No records passed in.")}))}doUpdateRecords(e){return m(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doUpdateRecordsInSourceRecords(e):yield Promise.reject("Editing source is not ready yet.")}))}deleteRecord(e){return m(this,void 0,void 0,(function*(){const t=this.getRecords()[e];return yield this.deleteOneRecord(t)}))}deleteRecordById(e){return m(this,void 0,void 0,(function*(){const t=this.getRecordById(e);return yield this.deleteOneRecord(t)}))}deleteOneRecord(t){return m(this,void 0,void 0,(function*(){return t?(this.setSaveStatus(e.Saving),yield this.doDeleteOneRecord(t).then((t=>(this.setSaveStatus(e.Saved),t)),(t=>m(this,void 0,void 0,(function*(){return this.setSaveStatus(e.SaveError),yield Promise.reject(t)}))))):yield Promise.reject("No record passed in.")}))}doDeleteOneRecord(e){return m(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doDeleteOneRecordFromSourceRecords(e):yield Promise.reject("Editing source is not ready yet.")}))}doDeleteOneRecordFromSourceRecords(e){return m(this,void 0,void 0,(function*(){return this.sourceRecords=this.sourceRecords.filter((t=>t.getId()!==e.getId())),Promise.resolve(!0)}))}doAddRecordToSourceRecords(e){return m(this,void 0,void 0,(function*(){return this.sourceRecords=this.sourceRecords.concat(e),yield Promise.resolve(e)}))}doUpdateRecordsInSourceRecords(e){return m(this,void 0,void 0,(function*(){return e.forEach((e=>{const t=this.sourceRecords.findIndex((t=>t.getId()===e.getId()));t>-1&&(this.sourceRecords[t]=e)})),Promise.resolve(!0)}))}afterUpdateRecords(e){e&&0!==e.filter((e=>!!e)).length&&(this.updateLoadedRecords(this.getMainDataSource(),e),this.getMainDataSource().getAllDerivedDataSources().forEach((t=>{this.updateLoadedRecords(t,e)})),this.getMainDataSource().addSourceVersion())}updateLoadedRecords(e,t){const i=t.map((t=>e.getRecordById(t.getId())));i.filter((e=>!!e)).length>0&&(i.forEach(((e,i)=>{e&&(e.setData(t[i].getData()),e.setGeometry(t[i].getRawGeometry()))})),e.addVersion())}afterUpdateRecord(e){e&&(this.updateOneLoadedRecord(this.getMainDataSource(),e),this.getMainDataSource().getAllDerivedDataSources().forEach((t=>{this.updateOneLoadedRecord(t,e)})),this.getMainDataSource().addSourceVersion())}updateOneLoadedRecord(e,t){const i=e.getRecordById(t.getId());i&&(i.setData(t.getData()),i.setGeometry(t.getRawGeometry()),e.addVersion())}afterAddRecord(e){e&&(this.getMainDataSource().clearRecords(),this.getMainDataSource().getAllDerivedDataSources().forEach((e=>{e.clearRecords()})),this.getMainDataSource().addSourceVersion())}afterDeleteRecordById(e){e&&(this.getMainDataSource().getSelectedRecordIds().includes(e)&&this.getMainDataSource().selectRecordsByIds(this.getMainDataSource().getSelectedRecordIds().filter((t=>t!==e)),this.getMainDataSource().getSelectedRecords().filter((t=>t.getId()!==e))),this.deleteOneLoadedRecordById(this.getMainDataSource(),e),this.getMainDataSource().getAllDerivedDataSources().forEach((t=>{this.deleteOneLoadedRecordById(t,e)})),this.getMainDataSource().addSourceVersion())}deleteOneLoadedRecordById(e,t){const i=e.getRecords().findIndex((e=>(null==e?void 0:e.getId())===t));"number"==typeof i&&i>-1&&(e.getRecords().splice(i,1),e.addVersion())}destroy(){if(this.parentDataSource){const e=this.type===t.Error?this.dataSourceManager.restoreErrorDataSourceId(this.id):this.id;this.parentDataSource.clearChildDataSourcePromise(e)}}}var I=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}))};class A extends D{constructor(){super(...arguments),this.isDataSourceSet=!0,this.childDataSourcesCreated=!1,this.childDataSourcePromises={}}ready(){return Promise.resolve()}childDataSourcesReady(){return this.createChildDataSourcesRecursively().finally((()=>{this.childDataSourcesCreated=!0}))}areChildDataSourcesCreated(){return this.childDataSourcesCreated}createChildDataSourcesRecursively(){return this.createChildDataSources().then((e=>Promise.allSettled(e.map((e=>e.isDataSourceSet?e.childDataSourcesReady().then((()=>e)):e))).then((e=>e.filter((e=>"fulfilled"===e.status)).map((e=>e.value))))))}createChildDataSources(){return I(this,void 0,void 0,(function*(){return this.getChildDataSourceIds().forEach((e=>{this.childDataSourcePromises[e]||(this.childDataSourcePromises[e]=this.createDataSourceById(e))})),Promise.allSettled(Object.values(this.childDataSourcePromises)).then((e=>e.filter((e=>"fulfilled"===e.status)).map((e=>e.value))))}))}createDataSourceById(e){return I(this,void 0,void 0,(function*(){try{const t=this.findChildDataSourceIdByDescendantDataSourceId(e);if(!t)return Promise.reject(new g(e,"Can not find data source."));if(!this.childDataSourcePromises[t]){const e=this.getChildIds().find((e=>this.getJimuChildId(e).some((e=>this.getChildDataSourceId(e)===t)))),i=this.getJimuChildId(e).find((e=>this.getChildDataSourceId(e)===t));this.childDataSourcePromises[t]=this.createChildDataSourceById(t,i,e)}const i=yield this.childDataSourcePromises[t];return i.id===e?i:i.isDataSourceSet?i.createDataSourceById(e):Promise.reject(new g(e,"Can not find data source."))}catch(t){return Promise.reject(new g(e,"Failed to create the data source."))}}))}findChildDataSourceIdByDescendantDataSourceId(e){const t=this.getChildDataSourceIds(),i=null==e?void 0:e.split("-");return t.find((e=>{const t=null==e?void 0:e.split("-");return null==t?void 0:t.every(((e,t)=>i[t]===e))}),null)}getChildDataSourceIds(){return(this.getChildIds()||[]).reduce(((e,t)=>e.concat(this.getJimuChildId(t))),[]).map((e=>this.getChildDataSourceId(e)))}destroy(){Object.keys(this.childDataSourcePromises).forEach((e=>{this.dataSourceManager.destroyDataSource(e)}))}areSomeChildDataSourcesPending(){const e=Object.keys(this.childDataSourcePromises).map((e=>(e=>{const t={};return Promise.race([e,t]).then((e=>e===t),(e=>!1))})(this.childDataSourcePromises[e])));return Promise.all(e).then((e=>e.some((e=>e))))}getChildDataSourceId(e){return y.dataSourceUtils.getChildDataSourceId(this.id,e)}getChildDataSources(){return Object.keys(this.dataSourceManager.getDataSources()).filter((e=>this.dataSourceManager.getDataSource(e).parentDataSource===this)).map((e=>this.dataSourceManager.getDataSource(e))).sort(((e,t)=>e.order-t.order))}getAllChildDataSources(){const e=(t,i)=>{const r=t.isDataSourceSet&&t.getChildDataSources();r&&r.forEach((t=>{i.push(t),t.isDataSourceSet&&e(t,i)}))},t=[];return e(this,t),t}getChildDataSource(e){return this.dataSourceManager.getDataSource(this.getChildDataSourceId(e))}getJimuChildId(e){const t=this.getReversedConfigSchema();return t&&t.childSchemas&&t.childSchemas[e]?t.childSchemas[e].map((e=>e.jimuChildId)).asMutable():[e]}clearChildDataSourcePromise(e){delete this.childDataSourcePromises[e]}}const L={},P={},b=e=>class extends e{get itemId(){return this._itemId}set itemId(e){this._itemId!==e&&(this._itemId=e,this.clearData())}get portalUrl(){return this._portalUrl}set portalUrl(e){this._portalUrl!==e&&(this._portalUrl=e,this.clearData())}getItemData(){return this.itemData}setItemData(e){this.itemData=e}setItemInfo(e){this.itemInfo=e}getItemInfo(){return this.itemInfo}fetchItemData(){return this.portalUrl&&this.itemId?this.itemData?Promise.resolve(this.itemData):(L[C(this.portalUrl,this.itemId)]||(L[C(this.portalUrl,this.itemId)]=y.requestUtils.requestWrapper(this.portalUrl,(e=>y.esri.restPortal.getItemData(this.itemId,{portal:y.portalUrlUtils.getPortalRestUrl(this.portalUrl),authentication:e})))),L[C(this.portalUrl,this.itemId)].then((e=>(this.itemData=e,this.itemData)))):Promise.resolve(null)}fetchItemInfo(){return this.portalUrl&&this.itemId?this.itemInfo?Promise.resolve(this.itemInfo):(P[C(this.portalUrl,this.itemId)]||(P[C(this.portalUrl,this.itemId)]=y.requestUtils.requestWrapper(this.portalUrl,(e=>y.esri.restPortal.getItem(this.itemId,{portal:y.portalUrlUtils.getPortalRestUrl(this.portalUrl),authentication:e})))),P[C(this.portalUrl,this.itemId)].then((e=>(this.itemInfo=e,this.itemInfo)))):Promise.resolve(null)}clearData(){this.itemData=null,this.itemInfo=null}};function C(e,t){return`${e}-${t}`}const R=e=>class extends e{get jimuLayerId(){return this.layer&&!this._jimuLayerId&&(this._jimuLayerId=y.dataSourceUtils.getJimuLayerIdByJSAPILayer(this.layer)),this._jimuLayerId}createJSAPILayerByDataSource(){return e=this,t=void 0,r=function*(){let e;try{const t=this.getLayerConstructorOptions();if(F[this.type])e=new(yield(0,y.loadArcGISJSAPIModule)(F[this.type]))(t);else{const i=yield(0,y.loadArcGISJSAPIModule)("esri/layers/Layer");this.portalUrl&&this.itemId?e=yield i.fromPortalItem(t):this.url&&(e=yield i.fromArcGISServerUrl(t))}const i=this.getDataSourceJson().label||this.getDataSourceJson().sourceLabel;e&&e.title!==i&&(e.title=i),!e||this.layer||this._cachedLayer||(this._cachedLayer=e),yield e.loadAll?e.loadAll():e.load(),this.setJimuChildIdAsLayerId(e,this)}catch(e){console.error("Failed to create JS API layer. ",e,this.id)}return e},new((i=void 0)||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}));var e,t,i,r}setJimuChildIdAsLayerId(e,t){var i,r;if(!e||!t)return;e.id=t.jimuChildId||t.id,e[y.dataSourceUtils.EXB_DATA_SOURCE_ID_SET_TO_CREATED_JS_API_LAYER]=t.id;const a=[],s=(null===(i=e.layers)||void 0===i?void 0:i.toArray())||(null===(r=e.sublayers)||void 0===r?void 0:r.toArray());if(null==s?void 0:s.length){let e;s.forEach((i=>{e=t.getChildDataSources().filter((e=>!a.includes(e.id))).find((e=>y.dataSourceUtils.getWhetherDataSourceHasSameSourceWithJSAPILayer(e,i))),e&&(a.push(e.id),this.setJimuChildIdAsLayerId(i,e))}))}}supportSpatialInfo(){const e=y.DataSourceManager.getInstance().getDataSource(this.id);if(null==e?void 0:e.isDataSourceSet)return 0===e.getChildDataSources().length||e.getChildDataSources().some((e=>{var t;return null===(t=null==e?void 0:e.supportSpatialInfo)||void 0===t?void 0:t.call(e)}));const i=this.layer||this._cachedLayer;return i?!i.isTable:this.type===t.SceneLayer||!!(null==e?void 0:e.getGeometryType())}getLayerConstructorOptions(){var e,t;const i={};this.url&&(i.url=this.url),this.itemId&&this.portalUrl&&(i.portalItem={id:this.itemId,portal:{url:this.portalUrl}});const r=this.layer||this._cachedLayer;return(null==r?void 0:r.sourceJSON)&&(i.sourceJSON=r.sourceJSON),(null===(e=null==r?void 0:r.source)||void 0===e?void 0:e.clone)&&(i.source=r.source.clone()),(null===(t=null==r?void 0:r.portalItem)||void 0===t?void 0:t.clone)&&(i.portalItem=r.portalItem.clone()),i}},F={[t.CSV]:"esri/layers/CSVLayer",[t.GeoJSON]:"esri/layers/GeoJSONLayer",[t.KML]:"esri/layers/KMLLayer",[t.WFS]:"esri/layers/WFSLayer",[t.WMS]:"esri/layers/WMSLayer",[t.WMTS]:"esri/layers/WMTSLayer",[t.VectorTileService]:"esri/layers/VectorTileLayer"},w=["id","url","itemId","portalUrl","type","geometryType","layerId"];function O(e,t,i,r,a,s){if(t)return V(e,t,a,s);{let t,o;return i.data?t=B(e,i.data,i.portalUrl,a,s):i.item&&(t=U(e,i.item,i.portalUrl,a,s)),r&&(o=T(e,r.layerDefinition,r.url,a,s)),t&&o?o.merge(t):t||o}}function V(e,t,i,r){var a,s,n,l;if(!e||!t)return null;let d,c,h;const S=t.type;switch(S){case u.GroupLayer:d=o.GroupLayer;break;case u.FeatureLayer:d=o.FeatureLayer,c=`${t.layerId}`,h=null===(a=t.sourceJSON)||void 0===a?void 0:a.geometryType;break;case u.SceneLayer:d=o.SceneLayer,c=`${t.layerId}`;break;case u.MapImageLayer:case u.TileLayer:d=o.MapService;break;case u.ImageryLayer:case u.ImageryTileLayer:case u.VectorTileLayer:case u.KMLLayer:case u.CSVLayer:case u.GeoJSONLayer:case u.WFSLayer:case u.WMSLayer:case u.WMTSLayer:break;default:throw new Error(`Unhandled case: ${S}`)}let g;return d&&(g=(0,y.Immutable)({id:e,type:d,sourceLabel:t.title||(null===(s=t.sourceJSON)||void 0===s?void 0:s.name)}),g=t.url?g.set("url",y.dataSourceUtils.getDataSourceSourceUrl(y.dataSourceUtils.getUrlByLayer(t))):g,g=(null===(n=t.portalItem)||void 0===n?void 0:n.id)?g.set("portalUrl",null===(l=t.portalItem.portal)||void 0===l?void 0:l.url).set("itemId",t.portalItem.id):g,g=/^\d+$/.test(c)?g.set("layerId",c):g,g=h?g.set("geometryType",h):g,g=i?g.merge(i.without(...w),{deep:!0}):g,g=r?g.set("schema",r):g),g}function U(e,t,i,r,a){var s,n,l,u,c;if(!e||!t)return null;let h,S,g;const v=t.type;switch(v){case d.WebMap:case d.WebScene:case d.CSV:case d.GeoJSON:case d.KML:case d.WFS:case d.WMS:case d.WMTS:case d.GroupLayer:h=o[J(d,v)],g=null===(s=t.url)||void 0===s?void 0:s.replace(/^http:/,"https:").replace(/\/$/,"");break;case d.FeatureCollection:(null===(n=t.typeKeywords)||void 0===n?void 0:n.includes("Singlelayer"))?(h=o.FeatureLayer,S="0"):h=o.GroupLayer;break;case d.FeatureService:case d.MapService:case d.SceneService:case d.ImageService:case d.VectorTileService:if(y.dataSourceUtils.isSupportedWholeArcGISService(t.url))h=M(t.url);else if(y.dataSourceUtils.isSupportedSingleArcGISLayerService(t.url)){const e=M(y.dataSourceUtils.getFullArcGISServiceUrl(t.url,!1));e===o.FeatureService||e===o.MapService?h=o.FeatureLayer:e===o.SceneService&&(h=o.SceneLayer),S=h&&(null===(l=t.url)||void 0===l?void 0:l.replace(/\/$/,"").split("/").reverse()[0])}g=h===o.VectorTileService?null===(u=t.url)||void 0===u?void 0:u.replace(/^http:/,"https:").replace(/\/$/,""):null===(c=t.url)||void 0===c?void 0:c.split("?")[0].replace(/^http:/,"https:").replace(/\/$/,"");break;case d.GeocodingService:case d.GeoenrichmentService:case d.GeometryService:case d.GeoprocessingService:case d.NetworkAnalysisService:break;default:throw new Error(`Unhandled case: ${v}`)}let f;return h&&(f=(0,y.Immutable)({id:e,type:h,sourceLabel:t.title}),f=f.set("itemId",t.id),f=f.set("portalUrl",i),f=/^\d+$/.test(S)?f.set("layerId",S):f,f=g?f.set("url",g):f,f=r?f.merge(r.without(...w),{deep:!0}):f,f=a?f.set("schema",a):f),f}function B(e,t,i,r,a){var s;if(!e||!t)return null;let n,l;const d=t,u=d.layerType;switch(u){case c.FeatureLayer:case c.SceneLayer:n=o[J(c,u)],l=null===(s=d.url)||void 0===s?void 0:s.replace(/\/$/,"").split("/").reverse()[0];break;case c.GroupLayer:case c.MapService:n=o[J(c,u)];break;case c.TiledMapService:n=o.MapService;break;case c.VectorTileService:case c.ImageService:case c.TiledImageService:case c.CSV:case c.GeoJSON:case c.KML:case c.WFS:case c.WMS:break;default:throw new Error(`Unhandled case: ${u}`)}let h;return n&&(h=(0,y.Immutable)({id:e,type:n,sourceLabel:d.title}),h=h.set("itemId",d.itemId),h=h.set("portalUrl",i),h=/^\d+$/.test(l)?h.set("layerId",l):h,h=d.url?h.set("url",d.url.replace(/^http:/,"https:").replace(/\/$/,"")):h,h=r?h.merge(r.without(...w),{deep:!0}):h,h=a?h.set("schema",a):h),h}function T(e,t,i,r,a){if(!e||!t)return null;let s;if(y.dataSourceUtils.isSupportedWholeArcGISService(i)){const r=y.dataSourceUtils.getFullArcGISServiceUrl(i,!1,t);s=function(e,t,i){if(!e||!t||!i)return null;const r=M(t);if(!r)return null;return(0,y.Immutable)({id:e,type:r,url:y.dataSourceUtils.getFullArcGISServiceUrl(t,!1),sourceLabel:y.dataSourceUtils.getLabelFromArcGISServiceUrl(t)})}(e,y.dataSourceUtils.getDataSourceSourceUrl(r),t)}else if(!i||y.dataSourceUtils.isSupportedSingleArcGISLayerService(i)){const r=y.dataSourceUtils.getFullArcGISServiceUrl(i,!0,t);s=function(e,t,i){if(!e||!i)return null;let r;const a=i.type||i.layerType;switch(a){case n.GroupLayer:r=o.GroupLayer;break;case n.FeatureLayer:case n.Table:r=o.FeatureLayer;break;case n.SceneLayer3DObject:case n.SceneLayerPoint:r=o.SceneLayer;break;default:throw new Error(`Unhandled case: ${a}`)}let s;return r&&(s=(0,y.Immutable)({id:e,type:r,sourceLabel:i.name}),s=t?s.set("url",y.dataSourceUtils.getFullArcGISServiceUrl(t,!0,i)):s,s=/^\d+$/.test(`${i.id}`)?s.set("layerId",`${i.id}`):s,s=i.geometryType?s.set("geometryType",i.geometryType):s),s}(e,y.dataSourceUtils.getDataSourceSourceUrl(r),t)}return s=r&&s?s.merge(r.without(...w),{deep:!0}):s,s=a&&s?s.set("schema",a):s,s}function M(e){if(!y.dataSourceUtils.isSupportedWholeArcGISService(e))return null;const t=e.split("?")[0].split("/"),i=Object.values(l).find((e=>t.some((t=>e.toLowerCase()===t.toLowerCase()))));let r;switch(i){case l.FeatureService:case l.MapService:case l.SceneService:case l.ImageService:case l.VectorTileService:r=o[J(l,i)];break;default:throw new Error(`Unhandled case: ${i}`)}return r}function J(e,t){var i;return null===(i=Object.entries(e).find((([e,i])=>i===t)))||void 0===i?void 0:i[0]}var Q=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}))};class E extends(R(b(A))){constructor(e){var t;super(e),e.layer&&(this.layer=e.layer);const i=this.getDataSourceJson();this.portalUrl=i.portalUrl,this.itemId=i.itemId,(null===(t=this.layer)||void 0===t?void 0:t.portalItem)&&this.setItemInfo(this.layer.portalItem.sourceJSON)}ready(){const e=Object.create(null,{ready:{get:()=>super.ready},createChildDataSourcesRecursively:{get:()=>super.createChildDataSourcesRecursively}});return this.fetchDataDefinitions().then((()=>e.ready.call(this))).then((()=>Q(this,void 0,void 0,(function*(){const t=(0,y.getAppStore)().getState().appConfig;if(t.originExbVersion&&y.semver.lt(t.originExbVersion,"1.6.0")){const t=yield e.createChildDataSourcesRecursively.call(this);yield this.upgradeChildDssId(t)}}))))}upgradeChildDssId(e){return Q(this,void 0,void 0,(function*(){let t=(0,y.getAppStore)().getState().appConfig;const i=[],r=(e,t,i)=>((null==e?void 0:e.dataSourceId)&&(e.dataSourceId=e.dataSourceId.replace(t,i)),(null==e?void 0:e.mainDataSourceId)&&(e.mainDataSourceId=e.mainDataSourceId.replace(t,i)),e),a=(e,t)=>(null==e?void 0:e.mainDataSourceId)?e.mainDataSourceId===t:!!(null==e?void 0:e.dataSourceId)&&e.dataSourceId.split("-dataView_")[0]===t;if(e.forEach((e=>{var s,o,n,l,d,u,c;if(e){let h="",S=e;const g=[];for(;S;){const e=!S.parentDataSource,t=!S.isDataSourceSet&&!S.getDataSourceJson().url||y.dataSourceUtils.isSupportedSingleArcGISLayerService(S.getDataSourceJson().url),i=!!(null===(s=S.parentDataSource)||void 0===s?void 0:s.map);let r;if(e)r=S.id;else if(t&&!i){const e=S.getLayerDefinition?S.getLayerDefinition():null===(n=(o=S).getServiceDefinition)||void 0===n?void 0:n.call(o);r=y.dataSourceUtils._getFixedLayerIdByLayerDefinition(e)||S.jimuChildId}else r=t||i?S.jimuChildId:y.dataSourceUtils.getLabelFromArcGISServiceUrl(S.getDataSourceJson().url);if(!e&&!i&&S.getDataSourceJson().url&&(null===(c=null===(u=null===(d=null===(l=S.parentDataSource.layer)||void 0===l?void 0:l.layers)||void 0===d?void 0:d.toArray)||void 0===u?void 0:u.call(d))||void 0===c?void 0:c.filter((e=>y.dataSourceUtils.getUrlByLayer(e)===S.getDataSourceJson().url)).length)>1){const e=S.parentDataSource.layer.layers.toArray().filter((e=>y.dataSourceUtils.getUrlByLayer(e)===S.getDataSourceJson().url)).findIndex((e=>e.id===S.jimuChildId));e>0&&(r=`${r}_${e}`)}h=h?`${r}-${h}`:r,g.unshift({jimuChildIdFromLabel:r,jimuChildIdFromId:S.jimuChildId||S.id}),S=S.parentDataSource}Object.keys(t.widgets||{}).forEach((i=>{var s;if(null===(s=t.widgets[i].useDataSources)||void 0===s?void 0:s.some((e=>a(e,h)))){const a=t.widgets[i].asMutable({deep:!0});a.useDataSources=a.useDataSources.map((t=>r(t,h,e.id))),a.config&&(a.config=JSON.parse(JSON.stringify(a.config).replace(new RegExp(h,"g"),e.id))),t=t.setIn(["widgets",i],a)}})),Object.keys(t.dataSources||{}).forEach((i=>{var s;if(null===(s=t.dataSources[i].originDataSources)||void 0===s?void 0:s.some((e=>a(e,h)))){const a=t.dataSources[i].asMutable({deep:!0});a.originDataSources=a.originDataSources.map((t=>r(t,h,e.id))),t=t.setIn(["dataSources",i],a)}const o=[];if(g.forEach(((e,t)=>{o.push(e.jimuChildIdFromLabel),t!==g.length-1&&o.push("childDataSourceJsons")})),t.dataSources.getIn(o)){const i=g.slice().reverse();if(i[0].jimuChildIdFromId!==i[0].jimuChildIdFromLabel){const r=o.slice(0,o.length-2),a=t.dataSources.getIn(r).asMutable({deep:!0});a.childDataSourceJsons[i[0].jimuChildIdFromId]=a.childDataSourceJsons[i[0].jimuChildIdFromLabel],a.childDataSourceJsons[i[0].jimuChildIdFromId].id=e.id,delete a.childDataSourceJsons[i[0].jimuChildIdFromLabel],t=t.setIn(["dataSources"].concat(r),a)}}})),Object.keys(t.messageConfigs||{}).forEach((i=>{var a;const s=null===(a=t.messageConfigs[i].actions)||void 0===a?void 0:a.some((e=>{var t,i,r,a,s;return(null===(t=e.useDataSources)||void 0===t?void 0:t.some((e=>(null==e?void 0:e.mainDataSourceId)===h)))||(null===(r=null===(i=e.config)||void 0===i?void 0:i.actionUseDataSource)||void 0===r?void 0:r.mainDataSourceId)===h||(null===(s=null===(a=e.config)||void 0===a?void 0:a.messageUseDataSource)||void 0===s?void 0:s.mainDataSourceId)===h}));if(s){const a=t.messageConfigs[i].asMutable({deep:!0});a.actions=a.actions.map((t=>{var i,a;return t.useDataSources&&(t.useDataSources=t.useDataSources.map((t=>r(t,h,e.id)))),(null===(i=t.config)||void 0===i?void 0:i.actionUseDataSource)&&(t.config.actionUseDataSource=r(t.config.actionUseDataSource,h,e.id)),(null===(a=t.config)||void 0===a?void 0:a.messageUseDataSource)&&(t.config.messageUseDataSource=r(t.config.messageUseDataSource,h,e.id)),t})),t=t.setIn(["messageConfigs",i],a)}})),!e.isDataSourceSet&&Object.keys((0,y.getAppStore)().getState().dataSourcesInfo).some((e=>e.includes(h)))&&(Object.keys((0,y.getAppStore)().getState().dataSourcesInfo).forEach((t=>{if(t.includes(h)){const i=t,r=t.replace(h,e.id);(0,y.getAppStore)().dispatch(y.appActions.updateDataSourceInfo(e.id,(0,y.getAppStore)().getState().dataSourcesInfo[i].merge((0,y.getAppStore)().getState().dataSourcesInfo[r]||{})))}})),e.getDataView(y.CONSTANTS.SELECTION_DATA_VIEW_ID)&&i.push(e.getDataView(y.CONSTANTS.SELECTION_DATA_VIEW_ID).ready()))}})),(0,y.getAppStore)().getState().appConfig!==t){(0,y.getAppStore)().dispatch(y.appActions.appConfigChanged(t));const e=this.getRootDataSource()||this,i=t.dataSources[e.id];i&&y.lodash.defer((()=>{this.dataSourceManager.updateDataSourceByDataSourceJson(e,i)}))}return Promise.allSettled(i).then()}))}fetchDataDefinitions(){return Q(this,void 0,void 0,(function*(){const e=[this.fetchServiceDefinition().then((()=>{var e,t;(null===(t=null===(e=this.serviceDefinition)||void 0===e?void 0:e.tables)||void 0===t?void 0:t.length)>0&&(this.serviceDefinition.tables=this.serviceDefinition.tables.map((e=>Object.assign(Object.assign({},e),{type:n.Table}))))}))];this.layer||this.url||!this.itemId||e.push(this.fetchItemData(),this.fetchItemInfo()),yield Promise.all(e)}))}fetchServiceDefinition(){var e;return Q(this,void 0,void 0,(function*(){let t;if(this.layer?(yield this.layer.load(),this.updateServiceDefinitionByLayer(),t=this.getServiceDefinition()):this.url&&(t=yield this.fetchServiceDefinitionByUrl()),null===(e=null==t?void 0:t.layers)||void 0===e?void 0:e.some((e=>!e.type))){const e=t.layers.filter((e=>!e.type)).map((e=>y.dataSourceUtils.getFullArcGISServiceUrl(this.url,!0,e))),i=yield y.ServiceManager.getInstance().fetchChildLayerDefinitionsFromUrls(e),r=Object.values(i);t.layers.forEach(((e,i)=>{t.layers[i]=Object.assign(Object.assign({},t.layers[i]),r.find((e=>e.id===t.layers[i].id)))}))}return t}))}fetchSchema(){return Q(this,void 0,void 0,(function*(){const e=this.getChildDataSources(),t=yield y.dataSourceUtils.getOriginDataLabel(this);let i=(0,y.Immutable)({childSchemas:{},label:t});return e.forEach(((e,t)=>{const r=e.getFetchedSchema();i=i.setIn(["childSchemas",e.jimuChildId],r)})),Promise.resolve(i)}))}getServiceDefinition(){return this.isDataView||this.isLocal?this.getMainDataSource().getServiceDefinition():this.serviceDefinition}getItemInfo(){return this.isDataView||this.isLocal?this.getMainDataSource().getItemInfo():super.getItemInfo()}createChildDataSourceById(e,t,i){return Q(this,void 0,void 0,(function*(){const r=this.createChildDataSourceOptionsById(e,t,i);if(!r)return Promise.reject(new g(e,"Do not support this type of data."));const a=yield this.dataSourceManager.createDataSource(r);return this.updateChildDatasourcesGDBVersion([a]),a}))}createChildDataSourceOptionsByIdFromUrl(e,t,i){if(this.url){const r=this.findLayerDefinitionInfo(i);return(null==r?void 0:r.url)?this.createChildDataSourceOptionsByLayerDefinition(r.partailLayerDefinition,r.url,t,e,r.order):null}return null}createChildDataSourceOptionsByLayerDefinition(e,t,i,r,a){const s=this.createChildDataSourceJsonByLayerDefinition(e,t,i,r);return s?{id:r,dataSourceJson:s,parentDataSource:this,jimuChildId:i,order:a}:null}createChildDataSourceJsonByLayerDefinition(e,t,i,r){var a,s,o,n,l,d;if(!e||!r)return null;const u=y.dataSourceUtils._getFixedLayerIdByLayerDefinition(e)||y.dataSourceUtils.getLabelFromArcGISServiceUrl(t),c=(null===(s=null===(a=this.getDataSourceJson().schema)||void 0===a?void 0:a.childSchemas)||void 0===s?void 0:s[i])||(null===(n=null===(o=this.getDataSourceJson().schema)||void 0===o?void 0:o.childSchemas)||void 0===n?void 0:n[u]);let h=T(r,e,t,(null===(l=this.getDataSourceJson().childDataSourceJsons)||void 0===l?void 0:l[i])||(null===(d=this.getDataSourceJson().childDataSourceJsons)||void 0===d?void 0:d[u]),c);return h&&(this.portalUrl&&(h=h.set("portalUrl",this.portalUrl)),this.itemId&&(h=h.set("itemId",this.itemId))),h}findLayerDefinitionInfo(e){let t;return this.getPartialLayerAndTableDefinitions().concat(this.getPartialSubLayerDefinitions()).some(((i,r)=>{const a=y.dataSourceUtils.getFullArcGISServiceUrl(this.url,!0,i),s=y.dataSourceUtils.getDataSourceSourceUrl(a);return this.getChildIdByLayerDefinition(i,s)===e&&(t={proxyUrl:a,url:s,partailLayerDefinition:i,order:r},!0)})),t}updateServiceDefinitionByLayer(){var e,t;(null===(e=this.layer)||void 0===e?void 0:e.sourceJSON)?this.serviceDefinition=this.layer.sourceJSON:this.serviceDefinition={name:null===(t=this.layer)||void 0===t?void 0:t.title}}fetchServiceDefinitionByUrl(){var e,t,i;return Q(this,void 0,void 0,(function*(){if(this.getServiceDefinition())return this.getServiceDefinition();if(this.url){const r=yield y.ServiceManager.getInstance().fetchServiceInfo(this.url).then((e=>e.definition));if(!r)return null;if(r.name||(r.name=y.dataSourceUtils.getLabelFromArcGISServiceUrl(this.getDataSourceJson().url)),null===(e=r.subLayers)||void 0===e?void 0:e.some((e=>!e.type))){const e=(null===(t=this.parentDataSource)||void 0===t?void 0:t.getServiceDefinition)?null===(i=this.parentDataSource)||void 0===i?void 0:i.getServiceDefinition():yield y.ServiceManager.getInstance().fetchServiceInfo(`${y.dataSourceUtils.getFullArcGISServiceUrl(this.url,!1)}/layers`).then((e=>e.definition));r.subLayers=r.subLayers.map((t=>{var i;const r=null===(i=null==e?void 0:e.layers)||void 0===i?void 0:i.find((e=>e.id===t.id));return Object.assign(Object.assign({},t),r)}))}return this.serviceDefinition=r,this.serviceDefinition}return Promise.reject(new g(this.id,"Failed to fetch service definition, need url."))}))}getPartialSubLayerDefinitions(){var e;return(null===(e=this.getServiceDefinition())||void 0===e?void 0:e.subLayers)||[]}getPartialLayerAndTableDefinitions(){var e,t;const i=(null===(e=this.getServiceDefinition())||void 0===e?void 0:e.layers)||[],r=(null===(t=this.getServiceDefinition())||void 0===t?void 0:t.tables)||[];return i.concat(r)}getChildIdByLayerDefinition(e,t){return y.dataSourceUtils.getFixedLayerIdByLayerDefinition(e)||y.dataSourceUtils.getLabelFromArcGISServiceUrl(t)}getChildIdByLayer(e){return y.dataSourceUtils.getFixedLayerIdByLayer(e)||y.dataSourceUtils.getLabelFromArcGISServiceUrl(y.dataSourceUtils.getUrlByLayer(e))}getChildIdBySubLayer(e){var t,i;const r=Object.assign(Object.assign({},e),{id:null!==(i=null===(t=null==e?void 0:e.source)||void 0===t?void 0:t.mapLayerId)&&void 0!==i?i:e.id});return y.dataSourceUtils.getFixedLayerIdByLayer(r)||y.dataSourceUtils.getLabelFromArcGISServiceUrl(y.dataSourceUtils.getUrlByLayer(e))}getChildIdsByUrl(){return this.getPartialLayerAndTableDefinitions().concat(this.getPartialSubLayerDefinitions()).map((e=>this.getChildIdByLayerDefinition(e,y.dataSourceUtils.getFullArcGISServiceUrl(this.getDataSourceJson().url,!0,e))))}updateChildDatasourcesGDBVersion(e){this.getInfo().gdbVersion&&e.forEach((e=>{e.type===t.FeatureLayer&&e.changeGDBVersion(this.getInfo().gdbVersion)}))}getGDBVersion(){return this.getInfo().gdbVersion}changeGDBVersion(e){(0,y.getAppStore)().dispatch(y.appActions.changeDataSourceGDBVersion(this.id,e)),this.updateChildDatasourcesGDBVersion(this.getAllChildDataSources()),y.jimuHistory.changeQueryObjectByDataSourceGDBVersion(this.id,e)}}class j extends D{load(){return t=this,i=void 0,a=function*(){return this.setStatus(e.Loading),yield this.doLoad().then((t=>(this.records=t,this.setStatus(e.Loaded),this.records)))},new((r=void 0)||(r=Promise))((function(e,s){function o(e){try{l(a.next(e))}catch(e){s(e)}}function n(e){try{l(a.throw(e))}catch(e){s(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof r?i:new r((function(e){e(i)}))).then(o,n)}l((a=a.apply(t,i||[])).next())}));var t,i,r,a}}class x{constructor(e){Object.assign(this,e)}getQueryCapabilities(){return{maxPageSize:null}}}var N=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}))};const{DEFAULT_QUERY_PAGE_SIZE:G,DATA_VIEW_ID_FOR_NO_SELECTION:_,OUTPUT_DATA_VIEW_ID:q,SELECTION_DATA_VIEW_ID:W}=y.CONSTANTS;class k extends D{constructor(t){super(t),this.pages={},this.pagePromises={},this.loadMissingFieldsByPagePromises={},this.throttleQueryRecordsByIdWithCurrentQueryParams=y.lodash.throttle(this.queryRecordsByIdWithCurrentQueryParams,200),this.setCapabilities(new x({})),this.url=this.getDataSourceJson().url,this.isSqlCaseSensitive=!!this.getDataSourceJson().isDataInDataSourceInstance||!y.dataSourceUtils.isAGOLHostedService(this.getDataSourceJson().url);const i=t.belongToDataSource&&t.belongToDataSource.getStatus()!==e.NotReady;this.getDataSourceJson().isOutputFromWidget&&!i?(this.setStatus(e.NotReady),this.setCountStatus(e.NotReady)):(this.setStatus(e.Unloaded),this.setCountStatus(e.Unloaded))}ready(){if(this.isSelectionView()){const e=this.getMainDataSource().id,t=(0,y.getAppStore)().getState().dataSourcesInfo;let i=[];const r={};t&&Object.keys(t).forEach((a=>{var s,o,n,l;(a===e||y.dataSourceUtils.isDerivedFrom(e,a))&&((null===(o=null===(s=t[a])||void 0===s?void 0:s.selectedIds)||void 0===o?void 0:o.length)?i=i.concat(t[a].selectedIds.asMutable()):(null===(l=null===(n=t[a])||void 0===n?void 0:n.selectOptions)||void 0===l?void 0:l.widgetId)&&(r[a]=t[a].selectOptions.asMutable({deep:!0})))})),i=Array.from(new Set(i));const a=()=>{if(0===i.length&&0===Object.keys(r).length)return Promise.resolve({});const t=i.length>0?this.queryRecordsByIdWithCurrentQueryParams(i,this.getMainDataSource(),{returnGeometry:!0}).then((e=>{var t;this.getMainDataSource().selectRecordsByIds(null===(t=e.records)||void 0===t?void 0:t.map((e=>e.getId())),e.records)})):null,a=Object.keys(r).map((t=>{var i,a,s;if(null===(a=null===(i=r[t])||void 0===i?void 0:i.ids)||void 0===a?void 0:a.length)return this.queryRecordsByIdWithCurrentQueryParams(r[t].ids,this.getMainDataSource(),{returnGeometry:!0}).then((e=>{this.getMainDataSource().selectRecords(Object.assign(Object.assign({},r[t]),{records:e.records}))}));if(null===(s=r[t])||void 0===s?void 0:s.queryParams){const i=t===e?null:t.replace(`${e}-`,""),a=i?this.dataSourceManager.createDataView(this.getMainDataSource(),i):this.getMainDataSource();return null==a?void 0:a.queryAll(Object.assign(Object.assign({},r[t].queryParams),{returnGeometry:!0})).then((e=>{a.selectRecords(Object.assign(Object.assign({},r[t]),{records:e.records}))}))}return null}));this.pendingPromiseToQuerySelectedRecordsPresetBeforeDsReady=Promise.allSettled([t,...a].filter((e=>!!e))).then((()=>{this.getMainDataSource().addSourceVersion()})).finally((()=>{this.pendingPromiseToQuerySelectedRecordsPresetBeforeDsReady=null}))};return this.getMainDataSource().getDataSourceJson().isDataInDataSourceInstance?this.getMainDataSource().setOnceSetSourceRecords(a):a(),Promise.resolve({})}return this.isDataView&&this.dataViewId===_?Promise.allSettled([this.load({returnGeometry:!0},{widgetId:_}),this.loadCount({},{widgetId:_})]).then((()=>{var e,t,i;0===this.getMainDataSource().getSelectedRecordIds().filter((e=>!!e)).length&&(null===(e=this.getMainDataSource().getDataView(W))||void 0===e||e.clearRecords(),null===(i=null===(t=this.getMainDataSource().getDataView(W))||void 0===t?void 0:t.getAllDerivedDataSources())||void 0===i||i.forEach((e=>{null==e||e.clearRecords()})))})):Promise.resolve({})}getCurrentQueryParams(e){var t,i;const r=this.getRuntimeQueryParams((null===(t=null==e?void 0:e.exclude)||void 0===t?void 0:t.dataSourceId)===this.id?null===(i=null==e?void 0:e.exclude)||void 0===i?void 0:i.widgetId:null);return this.getCurrentQueryParamsByQuery(r,e)}getRuntimeQueryParams(e){var t;const i=e?null===(t=this.getInfo().widgetQueries)||void 0===t?void 0:t.without(e):this.getInfo().widgetQueries;return this.getMergedWidgetQueries(i)}getCurrentQueryParamsByQuery(e,t){let i;return this.isLocal?i=this.mergeQueryParams(this.belongToDataSource.getCurrentQueryParams(t),e):this.isDataView?(i=this.mergeQueryParams(this.getConfigQueryParams(),e),i=this.mergeQueryParams(this.getMainDataSource().getCurrentQueryParams(Object.assign(Object.assign({},t),{dataSourceToFormatSql:this})),i)):(i=this.mergeQueryParams(this.getConfigQueryParams(),e),i=this.mergeQueryParams(this.getRemoteQueryParams(),i)),i}getMergedWidgetQueries(e){let t=e&&Object.keys(e)||[];return t=t.sort(((e,t)=>e.localeCompare(t,"en",{numeric:!0,sensitivity:"base"}))),this.mergeQueryParams(...t.map((t=>e[t])))}getCurrentQueryId(){return this.lastQueryId}getRealQueryParams(e,t,i){let r;if("query"===t)i&&i.scope?i.scope===h.InAllData?r=e:i.scope===h.InRemoteConfigView?r=this.mergeQueryParams(this.getRemoteQueryParams(),e):i.scope===h.InConfigView?(r=this.mergeQueryWithConfigQuery(e),r=this.mergeQueryParams(this.getRemoteQueryParams(),r)):r=i.scope===h.InRuntimeView?this.mergeQueryParams(this.getCurrentQueryParams({exclude:i.excludeQuery,dataSourceToFormatSql:i.dataSourceToFormatSql}),e):e:r=this.mergeQueryParams(this.getCurrentQueryParams({exclude:null==i?void 0:i.excludeQuery,dataSourceToFormatSql:null==i?void 0:i.dataSourceToFormatSql}),e);else{if(!i||!i.widgetId)return console.error("Please pass widget id for load."),null;const t=()=>{let t,r=this.getInfo().widgetQueries||(0,y.Immutable)({});return(null==i?void 0:i.excludeQuery)&&(r=r.without(i.excludeQuery.widgetId)),r=r.set(i.widgetId,e),t=this.getMergedWidgetQueries(r),t=this.getCurrentQueryParamsByQuery(t,{exclude:i.excludeQuery,dataSourceToFormatSql:i.dataSourceToFormatSql}),t};i&&i.scope?i.scope===h.InAllData?r=e:i.scope===h.InRemoteConfigView?r=this.mergeQueryParams(this.getRemoteQueryParams(),e):i.scope===h.InConfigView?(r=this.mergeQueryWithConfigQuery(e),r=this.mergeQueryParams(this.getRemoteQueryParams(),r)):r=i.scope===h.InRuntimeView?t():e:r=t()}return r}mergeQueryWithConfigQuery(e){let t;return this.isLocal?this.belongToDataSource.isDataView?(t=this.mergeQueryParams(this.belongToDataSource.getConfigQueryParams(),e),t=this.mergeQueryParams(this.getMainDataSource().getConfigQueryParams(),t)):t=this.mergeQueryParams(this.getConfigQueryParams(),e):this.isDataView?(t=this.mergeQueryParams(this.getConfigQueryParams(),e),t=this.mergeQueryParams(this.getMainDataSource().getConfigQueryParams(),t)):t=this.mergeQueryParams(this.getConfigQueryParams(),e),t}updateQueryParams(e,t){var i;e=this.getQueryWithoutPage(e),y.utils.isDeepEqual(e||{},(null===(i=this.getInfo().widgetQueries)||void 0===i?void 0:i[t])||{})||((0,y.getAppStore)().dispatch(y.appActions.updateWidgetQuery(this.id,t,e)),this.isSelectionView()?(this.load({returnGeometry:!0},{widgetId:W}),this.loadCount({},{widgetId:W})):this.handleSelectionOnQueryParamChanges())}getQueryPageSize(){var e,t,i;const r=(null===(e=this.getDataViewConfig())||void 0===e?void 0:e.pageSize)||G,a=(null===(i=null===(t=this.getCapabilities())||void 0===t?void 0:t.getQueryCapabilities())||void 0===i?void 0:i.maxPageSize)||1/0;return Math.min(r,a)}getMaxRecordCount(){var e;return(null===(e=this.getDataViewConfig())||void 0===e?void 0:e.maximum)||null}getQueryWithoutPage(e){if(!e)return null;const{pageSize:t,page:i}=e;return function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(r=Object.getOwnPropertySymbols(e);a<r.length;a++)t.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(i[r[a]]=e[r[a]])}return i}(e,["pageSize","page"])}checkClearLocalCache(e,t,i){const r=this.getQueryWithoutPage(e),a=this.getRealQueryParams(r,"load",i),s=this.applyUsedFields(a,"*"),o=this.applyUsedFields(t,"*"),n=i.refresh||this.getInfo().needRefresh;return!(y.utils.isDeepEqual(s,o)&&!n||(this.getInfo().needRefresh&&this.setNeedRefresh(!1),0))}selectRecords(e,t,i){const r=Object.create(null,{selectRecords:{get:()=>super.selectRecords}});return N(this,void 0,void 0,(function*(){if(this.clearPendingSelect(),(null==e?void 0:e.records)||(null==e?void 0:e.ids)){const t=yield r.selectRecords.call(this,e);return Promise.resolve(Object.assign(Object.assign({},t),{queryParams:(0,y.Immutable)(null==e?void 0:e.queryParams)}))}if(null==e?void 0:e.queryParams){const a=new AbortController;return t&&(t.onabort=e=>{a.abort()}),this.abortControllerOfPendingPromiseToQuerySelectedRecordsBySelectOptions=a,this.queryAll(Object.assign(Object.assign({},e.queryParams),{returnGeometry:!0}),this.abortControllerOfPendingPromiseToQuerySelectedRecordsBySelectOptions.signal,i).then((i=>(i.isAborted&&!(null==t?void 0:t.aborted)||r.selectRecords.call(this,Object.assign(Object.assign({},e),{records:i.records})),i))).catch((t=>(console.error("Failed to select by options. ",t),{records:[],queryParams:(0,y.Immutable)(e.queryParams)})))}return Promise.resolve({records:[],queryParams:null})}))}selectRecordById(e,t){this.clearPendingSelect(),super.selectRecordById(e,t)}selectRecordsByIds(e,t){this.clearPendingSelect(),super.selectRecordsByIds(e,t)}selectRecord(e){this.clearPendingSelect(),super.selectRecord(e)}clearSelection(){this.clearPendingSelect(),super.clearSelection()}clearPendingSelect(){var e;null===(e=this.abortControllerOfPendingPromiseToQuerySelectedRecordsBySelectOptions)||void 0===e||e.abort(),this.abortControllerOfPendingPromiseToQuerySelectedRecordsBySelectOptions=null}getRecordsByPage(e,t){const i=[],r=Object.assign({},this.pages),a=Object.keys(r).map((e=>parseInt(e))).sort(((e,t)=>t-e))[0],s=this.getQueryPageSize();let o=t*(e-1),n=o+t-1;const l=this.getMaxRecordCount();if(null!==l){if(o>l-1)return i;o=Math.min(o,l-1),n=Math.min(n,l-1)}for(let e=1;e<=a;e++){const t=(e-1)*s;if(!(t+s-1<o||t>n)&&r[e])for(let a=0;a<r[e].length;a++)t+a<o||t+a>n||i.push(r[e][a])}return i}getRecordsByPageWithSelection(e,t){return this.concatRecordsAndSelection(this.getSelectedRecords(),this.getRecordsByPage(e,t))}getPagesData(){return this.pages}setPagesData(e){this.pages=e}clearRecordsNotAddVersion(){!this.isSelectionView()&&this.getSelectedRecords().length>0&&this.copySelectionToDataView([]),this.pages={},this.pagePromises={},this.loadMissingFieldsByPagePromises={},this.loadMissingFieldsForAllPagePromise=null,this.count=null,this.countPromise=null,this.byIdPromise=null}getRecords(){let e=[];const t=[];for(let e=1;e<=Object.keys(this.pages).length&&this.pages[e];e++)t.push(e);return t.forEach((t=>{e=e.concat(this.pages[t])})),null!==this.getMaxRecordCount()&&this.getMaxRecordCount()<e.length?e.slice(0,this.getMaxRecordCount()):e}setRecords(e){const t={},i=this.getQueryPageSize();e.forEach(((e,r)=>{const a=Math.ceil((r+1)/i);t[a]||(t[a]=[]),t[a][r%i]=e})),this.setPagesData(t),this.addVersion()}setSourceRecords(e){if(super.setSourceRecords(e),this.canSaveSourceRecords()&&this.onceSetSourceRecords){const e=this.onceSetSourceRecords;this.setOnceSetSourceRecords(null),y.lodash.defer((()=>{e()}))}}get count(){return this._count}set count(e){this._count=e}getRealQueryPages(e,t){const i=t*(e-1);let r=i+t-1;null!==this.getMaxRecordCount()&&(r=Math.min(r,this.getMaxRecordCount()-1));const a=Math.floor(i/this.getQueryPageSize())+1,s=Math.floor(r/this.getQueryPageSize())+1,o=[];for(let e=a;e<=s;e++)o.push(e);return o}load(t,i={}){var r;if(this.getStatus()===e.NotReady)return Promise.resolve([]);(t=Object.assign({},t)).page||(t.page=1),t.pageSize||(t.pageSize=this.getQueryPageSize());const a=this.getRealQueryPages(t.page,t.pageSize);this.checkClearLocalCache(t,this.lastQueryParams,i)&&(Object.keys(this.pages).forEach((e=>{a.includes(parseInt(e))||delete this.pages[e]})),this.pagePromises={},this.loadMissingFieldsByPagePromises={},this.loadMissingFieldsForAllPagePromise=null,this.count=null,this.countPromise=null);const s=this.getQueryWithoutPage(t);y.utils.isDeepEqual(s||{},(null===(r=this.getInfo().widgetQueries)||void 0===r?void 0:r[i.widgetId])||{})||(0,y.getAppStore)().dispatch(y.appActions.updateWidgetQuery(this.id,i.widgetId,s));let o=this.getRealQueryParams(s,"load",i);const n=this.getAllUsedFields({queryParams:o,excludeWidgetsDoNotUseDsToQuery:!0});o=this.applyUsedFields(o,n),this.loadMissingFields(o);const l=a.filter((e=>this.pagePromises[e])).map((e=>this.pagePromises[e].promise));return l.length===a.length?Promise.all(l).then((()=>this.getRecordsByPage(t.page,t.pageSize))):(this.lastQueryParams=o,this.setStatus(e.Loading),this.setNeedRefresh(!1),Promise.all(a.map((e=>this.loadByPage(o,t,n,e)))).then((i=>i.find((e=>e))?(this.handleSelectionOnQueryParamChanges(),this.lastRefreshTime=new Date,this.setStatus(e.Loaded),window.jimuConfig.isInBuilder&&(0,y.getAppStore)().getState().appRuntimeInfo.appMode===y.AppMode.Design||this.startAutoRefresh(),this.getRecordsByPage(t.page,t.pageSize)):null),(t=>(console.error(t),this.setStatus(e.LoadError),[]))))}loadMissingFields(e,t=!1){y.lodash.defer((()=>{const i=this.getAllUsedFields({queryParams:e,excludeWidgetsDoNotUseDsToQuery:!0});if(this.updateLoadOnDemandFields(i),t){if(this.usedFieldsInTimeWindow=this.mergeUsedFields(this.usedFieldsInTimeWindow,i),this.loadMissingFieldsTimer)return;this.loadMissingFieldsTimer=setTimeout((()=>{this.doLoadMissingFields(e,this.usedFieldsInTimeWindow),clearTimeout(this.loadMissingFieldsTimer),this.loadMissingFieldsTimer=null,this.usedFieldsInTimeWindow=[]}),500)}else this.doLoadMissingFields(e,i)}))}doLoadMissingFields(e,t){var i;if(this.isSelectionView()){const r=this.getRecords(),a=this.getSourceRecords().filter((e=>!r.some((t=>t.getId()===e.getId())))),s=r.concat(a),o=[];if(s.forEach((e=>{this.findMissingFields(t,Object.keys(e.getData())).forEach((e=>{o.includes(e)||o.push(e)}))})),0===o.length)return;if(!this.loadMissingFieldsByPagePromises[W]||this.missingSomeFields(o,this.loadMissingFieldsByPagePromises[W].fields)){const t=r.map((e=>e.getId())),a=null===(i=this.getSchema())||void 0===i?void 0:i.fields,s=this.queryRecordsByIdWithCurrentQueryParams(t,this.getMainDataSource(),this.applyUsedFields(e,o)).then((e=>{var t;if(a!==(null===(t=this.getSchema())||void 0===t?void 0:t.fields))return!1;const i=this.getRecords(),r=this.getSourceRecords();return e.records.forEach((e=>{const t=i.find((t=>t.getId()===e.getId()));t&&t.setData(Object.assign(Object.assign({},t.getData()),e.getData()));const a=r.find((t=>t.getId()===e.getId()));a&&a.setData(Object.assign(Object.assign({},a.getData()),e.getData()))})),this.addSourceVersion(),this.addVersion(),!0})).catch((e=>(console.error("Failed to load missing fields, ",e),!1)));this.loadMissingFieldsByPagePromises[W]={promise:s,fields:o}}}else{if(!Object.values(this.pagePromises).some((e=>this.missingSomeFields(t,e.fields))))return;const i={};if(Object.keys(this.pagePromises).forEach((e=>{const r=parseInt(e),a=this.findMissingFields(t,this.pagePromises[r].fields);i[r]=a})),!this.loadMissingFieldsForAllPagePromise||Object.keys(this.pagePromises).some((e=>this.missingSomeFields(i[e],this.loadMissingFieldsForAllPagePromise.fields[e])))){const t=[];Object.keys(this.pagePromises).forEach((r=>{const a=parseInt(r),s=i[a],o=this.loadMissingFieldsByPage(e,s,a);t.push(o)}));const r=Promise.all(t).then((e=>(e.find((e=>e))&&this.addVersion(),!0))).catch((e=>(console.error("Failed to load missing fields, ",e),!1)));this.loadMissingFieldsForAllPagePromise={promise:r,fields:i}}}}loadMissingFieldsByPage(e,t,i){var r;if(!t||0===t.length||"*"===this.pagePromises[i].fields)return Promise.resolve(!0);if(!this.loadMissingFieldsByPagePromises[i]||this.missingSomeFields(t,this.loadMissingFieldsByPagePromises[i].fields)){const a=Object.assign(Object.assign({},e),{page:i,pageSize:this.getQueryPageSize()}),s=null===(r=this.getSchema())||void 0===r?void 0:r.fields,o=this.query(this.applyUsedFields(a,t),{scope:h.InAllData}).then((e=>{var i,r;return s===(null===(i=this.getSchema())||void 0===i?void 0:i.fields)&&(this.pagePromises[e.queryParams.page].fields=this.pagePromises[e.queryParams.page].fields.concat(t),null===(r=e.records)||void 0===r||r.forEach((t=>{var i,r,a;const s=null===(i=this.pages[e.queryParams.page])||void 0===i?void 0:i.find((e=>e.getId()===t.getId()));s&&s.setData(Object.assign(Object.assign({},s.getData()),t.getData()));const o=null===(a=null===(r=this.getSelectionDataView())||void 0===r?void 0:r.getSourceRecords())||void 0===a?void 0:a.find((e=>e.getId()===t.getId()));o&&o.setData(Object.assign(Object.assign({},o.getData()),t.getData()))})),!0)}));this.loadMissingFieldsByPagePromises[i]={promise:o,fields:t}}return this.loadMissingFieldsByPagePromises[i].promise}handleSelectionOnQueryParamChanges(){var e,t;if(this.useNoSelectionView(this.getSelectionDataView()))return;if(this.getSelectionDataView().pendingPromiseToQuerySelectedRecordsPresetBeforeDsReady)return;const i=this.isDataView&&this.dataViewId===_,r=this.isSelectionView(),a=this.isLocalViewOfSelectionView();if(i||r||a)r&&this.getMainDataSource().updateSelectionInfoOfDerivedDssAndChangeUrl(Object.assign(Object.assign({},null===(t=this.getMainDataSource().getSelectOptionsFromInfo())||void 0===t?void 0:t.asMutable({deep:!0})),{ids:this.getRecords().map((e=>e.getId()))}));else{const t=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords();let i=[];this.getSelectedRecordIds().forEach((e=>{const r=this.getSelectionDataView().getSourceRecords().some((t=>t.getId()===e)),a=t.find((t=>(null==t?void 0:t.getId())===e));!r&&a&&(i=i.concat(a))})),i.length>0&&this.copySelectionToDataView(this.getSelectionDataView().getSourceRecords().concat(i)),this.updateSelectionInfoOfDerivedDssAndChangeUrl(Object.assign(Object.assign({},null===(e=this.getSelectOptionsFromInfo())||void 0===e?void 0:e.asMutable({deep:!0})),{ids:this.getSelectionDataView().getRecords().map((e=>e.getId()))}),this,!0)}}loadByPage(e,t,i,r){return N(this,void 0,void 0,(function*(){if(this.pagePromises[r])return yield this.pagePromises[r].promise;if(this.getDataSourceJson().isDataInDataSourceInstance&&this.sourceRecordsMissingFields(this.getSourceRecords(),i))return Promise.resolve(!1);const a=Object.assign(Object.assign({},e),{page:r,pageSize:this.getQueryPageSize()}),s=this.doQuery((0,y.Immutable)(a),(0,y.Immutable)(t)).then((a=>{const s=this.getQueryWithoutPage(a.queryParams);return!!y.utils.isDeepEqual(s,this.lastQueryParams)&&("number"==typeof a.sourceVersion&&a.sourceVersion!==this.getSourceVersion()?(delete this.pagePromises[r],this.loadByPage(e,t,i,r)):(this.pages[a.queryParams.page]=a.records,!0))}));return this.pagePromises[r]={promise:s,fields:i},this.pagePromises[r].promise}))}sourceRecordsMissingFields(e,t){return!(!e||!t)&&e.some((e=>this.missingSomeFields(t,Object.keys(e.getData()))))}loadCount(t,i={}){if(this.getCountStatus()===e.NotReady)return Promise.resolve(0);if(!this.checkClearLocalCache(t,this.lastCountQueryParams,i)&&this.countPromise)return this.countPromise;const r=this.getRealQueryParams(this.getQueryWithoutPage(t),"load",i);return this.lastCountQueryParams=r,this.setCountStatus(e.Loading),this.countPromise=this.doQueryCount((0,y.Immutable)(r)).then((r=>y.utils.isDeepEqual(r.queryParams,this.lastCountQueryParams)?"number"==typeof r.sourceVersion&&r.sourceVersion!==this.getSourceVersion()?(delete this.countPromise,this.loadCount(t,i)):(null===this.getMaxRecordCount()?this.count=r.count:this.count=Math.min(r.count,this.getMaxRecordCount()),this.setCountStatus(e.Loaded),this.count):null),(t=>(console.error(t),this.setCountStatus(e.LoadError),Promise.reject(t)))),this.countPromise}loadById(t,i){return this.getStatus()===e.NotReady?Promise.resolve(null):(t===this.lastQueryId&&!i&&this.byIdPromise||(this.lastQueryId=t,this.setStatus(e.Loading),this.byIdPromise=this.doQueryById(t).then((t=>(this.setStatus(e.Loaded),t)),(t=>(console.error(t),this.setStatus(e.LoadError),null)))),this.byIdPromise)}query(t,i){if(this.getStatus()===e.NotReady)return Promise.resolve({queryParams:(0,y.Immutable)(t),records:[],fields:[],sourceVersion:this.getSourceVersion()});const r=this.getRealQueryParams(t,"query",i);return this.doQuery((0,y.Immutable)(r),(0,y.Immutable)(t)).then((e=>{const t=this.getMaxRecordCount();if(null===t)return e;const i=e.queryParams.page||1,r=e.queryParams.pageSize;return 1!==i&&r?(i-1)*r>t?e.records=[]:(i-1)*r+e.records.length>t&&(e.records=e.records.slice(0,(i-1)*r+e.records.length-t)):e.records.length>t&&(e.records=e.records.slice(0,t)),e}))}queryCount(t,i){if(this.getCountStatus()===e.NotReady)return Promise.resolve({queryParams:(0,y.Immutable)(t),count:0,sourceVersion:this.getSourceVersion()});if(this.useNoSelectionView()){const e=this.getMainDataSource().getDataView(y.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION);if(e)return e.queryCount(t,i)}const r=this.getRealQueryParams(t,"query",i);return this.doQueryCount((0,y.Immutable)(r)).then((e=>(null===this.getMaxRecordCount()||(e.count=Math.min(e.count,this.getMaxRecordCount())),e)))}queryIds(t,i){if(this.getCountStatus()===e.NotReady)return Promise.resolve({queryParams:(0,y.Immutable)(t),ids:[],sourceVersion:this.getSourceVersion()});if(this.useNoSelectionView()){const e=this.getMainDataSource().getDataView(y.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION);if(e)return e.queryIds(t,i)}const r=this.getRealQueryParams(t,"query",i);return this.doQueryIds((0,y.Immutable)(r)).then((e=>{if(null===this.getMaxRecordCount())return e;{const t=Math.min(e.ids.length,this.getMaxRecordCount());return e.ids.splice(t),e}}))}queryAll(e,t,i,r){const a=Object.assign({},e),s={queryParams:(0,y.Immutable)(a).without("page").without("pageSize"),records:[]},o=e=>(e.isAborted=!0,e),n=(e,t,i,s,n)=>N(this,void 0,void 0,(function*(){if(t>0)for(let l=1;l<=t;l++){a.page=l,a.pageSize=e;const d=yield this.query(a,r);if((null==d?void 0:d.records)&&d.records.length>0){if(i.records.push(...d.records),null==s?void 0:s.aborted)return o(i);null==n||n(l/t,i)}}return i}));return(null==t?void 0:t.aborted)?Promise.resolve(o(s)):(null==i||i(0,s),this.queryCount(a,r).then((e=>new Promise((r=>{var a,l;t&&(t.onabort=e=>{r(o(s))});const d=e.count,u=null!==this.getMaxRecordCount()?Math.min(d,this.getMaxRecordCount()):d,c=(null===(l=null===(a=this.getCapabilities())||void 0===a?void 0:a.getQueryCapabilities())||void 0===l?void 0:l.maxPageSize)||this.getQueryPageSize(),h=Math.ceil(u/c);n(c,h,s,t,i).then((e=>{r(e)}))})))))}queryById(t){return N(this,void 0,void 0,(function*(){return this.getStatus()===e.NotReady?yield Promise.resolve(null):yield this.doQueryById(t)}))}getAutoRefreshInterval(){const e=this.getMainDataSource();let t=e.getDataViewConfig()&&e.getDataViewConfig().refreshInterval;return 0===t?0:(null==t&&(t=e.getSchema().refreshInterval),t)}getLastRefreshTime(){return this.lastRefreshTime}startAutoRefresh(){const e=this.getAutoRefreshInterval();e&&(this.autoRefreshHandle||(this.setNeedRefresh(!1),this.autoRefreshHandle=setInterval((()=>{this.setNeedRefresh(!0),y.lodash.defer((()=>{this.setNeedRefresh(!1)}))}),1e3*e)))}stopAutoRefresh(){this.autoRefreshHandle&&(this.setNeedRefresh(!1),clearInterval(this.autoRefreshHandle),this.autoRefreshHandle=null)}setNeedRefresh(e){this.getInfo().needRefresh!==e&&(0,y.getAppStore)().dispatch(y.appActions.setDataNeedRefresh(this.id,e))}setCapabilities(e){this.capabilities=e}getCapabilities(){return this.canSaveSourceRecords()?this.capabilities:this.getMainDataSource().getCapabilities()}getMainDataSource(){return super.getMainDataSource()}getDataViews(){return super.getDataViews()}getDataView(e){return super.getDataView(e)}updateSelectionInfo(e,t,i){var r;if(!(null==e?void 0:e.ids)&&!(null==e?void 0:e.records))return;if(!this.getListenSelection()&&this.id!==(null==t?void 0:t.id))return;const a=!this.isLocal&&!this.isDataView,s=this.dataViewId===q,o=!a&&!s,n=(null===(r=e.records)||void 0===r?void 0:r.map((e=>e.getId())))||e.ids;if(!((i||o)&&n.length>0))return void this.changeSelectedRecordIdsOfDsInfo(e);const l=this.getRecords(),d=this.getSelectedRecordIds();let u=[],c=[];const h={};l.forEach((e=>{if(e){const t=e.getId();h[t]=!0}}));const S={};d.forEach((e=>{S[e]=!0})),n.forEach((e=>{h[e]||!i&&S[e]?c=c.concat(e):u=u.concat(e)})),c.length!==n.length?this.throttleQueryRecordsByIdWithCurrentQueryParams(u).then((t=>{var i;const r=d,a=this.getSelectedRecordIds();if(a.length===r.length&&a.every((e=>r.some((t=>t===e))))){const r={};(null===(i=null==t?void 0:t.records)||void 0===i?void 0:i.length)>0&&t.records.forEach((e=>{if(e){const t=e.getId();r[t]=!0}}));const a=u.filter((e=>r[e]));this.changeSelectedRecordIdsOfDsInfo(Object.assign(Object.assign({},e),{ids:c.concat(a)}))}})).catch((e=>{console.error(`Failed to check whether selected records in ${this.id}. `,e)})):this.changeSelectedRecordIdsOfDsInfo(e)}changeSelectedRecordIdsOfDsInfo(e){var t;(0,y.getAppStore)().dispatch(y.appActions.dataSourceSelectionChanged(this.id,e)),this.getMainDataSource().id===this.id&&(null===(t=this.getSelectionDataView())||void 0===t||t.addVersion(),this.useNoSelectionView(this.getSelectionDataView())&&this.getSelectionDataView().addSourceVersion())}queryRecordsByIdWithCurrentQueryParams(e,t,i){return N(this,void 0,void 0,(function*(){const r=e.map((e=>+e)).filter((e=>!isNaN(e))),a=this.mergeQueryParams(i,{objectIds:r});return t?t.queryAll(a):this.queryAll(a)}))}deleteOneLoadedRecordById(e,t){var i;const r=e.getPagesData(),a=Object.keys(r).find((e=>{var i;return null===(i=r[e])||void 0===i?void 0:i.some((e=>(null==e?void 0:e.getId())===t))})),s=null===(i=r[a])||void 0===i?void 0:i.findIndex((e=>(null==e?void 0:e.getId())===t));"number"==typeof s&&s>-1&&(r[a].splice(s,1),e.addVersion())}setOnceSetSourceRecords(e){this.onceSetSourceRecords=e}getAllUsedFields(e){return super.getAllUsedFields(e)}}var z=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}))};const $="data_source_id_for_record",H="is_record_data_a_proxy";class K extends v{constructor(e,t,i){super(),this._id=null,this.dataSource=t,null==e.attributes[t.getIdField()]&&(this._id=(0,y.uuidv1)()),!1!==(null==i?void 0:i.isBeforeMappingData)?(e.attributes=this.convertBeforeMappingDataToData(e.attributes),this.feature=e):this.feature=e,this.hasFullGeometries=!1!==(null==i?void 0:i.hasFullGeometries),this.setProxyForData(),this.fillGeometry()}setProxyForData(){var e;if(!(null===(e=this.feature)||void 0===e?void 0:e.attributes)||!this.dataSource)return;if(this.feature.attributes[H]&&this.feature.attributes[$]===this.dataSource.id)return;const t=this.dataSource;this.feature.attributes=new Proxy(this.feature.attributes[H]?Object.assign({},this.feature.attributes):this.feature.attributes,{get(e,i){var r;let a;return i in e?a=e[i]:"string"==typeof i&&(null===(r=t.getSchema())||void 0===r?void 0:r.fields)&&i in t.getSchema().fields?t.loadMissingFields(Object.assign(Object.assign({},t.getCurrentQueryParams()),{outFields:[i]}),!0):i===$?a=t.id:i===H&&(a=!0),a}})}set dataSource(e){this._dataSource=e,this.setProxyForData()}get dataSource(){return this._dataSource}fillGeometry(){var e,t;if(!this.feature.geometry)return;const i=this.dataSource;this.feature.geometry.spatialReference||(this.feature.geometry.spatialReference=null===(t=null===(e=i.getLayerDefinition())||void 0===e?void 0:e.extent)||void 0===t?void 0:t.spatialReference)}queryAttachments(e){return z(this,void 0,void 0,(function*(){let t=null;const i=this.dataSource;if(t=i&&i.getMainDataSource().url,!t)return yield Promise.resolve([]);const r={attachmentTypes:e,url:t,featureId:this.getId()};return this._queryAllAttachmentsPromise||(this._queryAllAttachmentsPromise=y.dataSourceUtils.queryAllAttachments(r)),yield this._queryAllAttachmentsPromise.then((e=>z(this,void 0,void 0,(function*(){return this.attachmentInfos=e,yield y.dataSourceUtils.filterAttachments(e,r)}))))}))}fetchSymbolPreviewHTML(){return z(this,void 0,void 0,(function*(){return this._isGraphicFeature()?(this._getSymbolPreviewHTMLPromise||(this._getSymbolPreviewHTMLPromise=(0,y.loadArcGISJSAPIModules)(["esri/symbols/support/symbolUtils"]).then((e=>z(this,void 0,void 0,(function*(){let t=null;return[t]=e,yield t.getDisplayedSymbol(this.feature).then((e=>z(this,void 0,void 0,(function*(){const i=document.createElement("div");return i.className="w-100 h-100 d-flex justify-content-center align-items-center",yield t.renderPreviewHTML(e,{node:i})}))))}))))),yield this._getSymbolPreviewHTMLPromise):yield Promise.resolve(null)}))}getData(){return this.feature.attributes}setData(e){this.feature.attributes=e,this.setProxyForData()}clone(e){const t=y.lodash.clone(this);return e?("esri.Graphic"===this.feature.declaredClass?t.feature=this.feature.clone():t.feature=y.lodash.cloneDeep(this.feature),t):t}getDateFieldValue(e){const t=this.getFieldValue(e);return y.dataSourceUtils.getDateFieldValue(t,this.dataSource)}getFormattedFieldValue(e,t){const i=this.dataSource,r=i&&i.getLayerDefinition&&i.getLayerDefinition();if(!r)return super.getFormattedFieldValue(e,t);const a=y.dataSourceUtils.getDisplayValueForCodedValueOrSubtype(r,e,this.getData());return a.isCodedValueOrSubtype?a.displayValue:super.getFormattedFieldValue(e,t)}getDataBeforeMapping(){return this.convertDataToDataBeforeMapping(this.getData())}getOriginData(){const e=Object.assign({},this.feature);return e.attributes=this.convertDataToDataBeforeMapping(this.getData()),e}toJson(){return this.feature}getId(){return this._id||this.feature.attributes[this.dataSource.getIdField()]+""}setId(e){}getGeometry(){var e;return"esri.Graphic"===this.feature.declaredClass?null===(e=this.feature.geometry)||void 0===e?void 0:e.toJSON():this.feature.geometry}getRawGeometry(){return this.feature.geometry}setGeometry(e){var t,i,r;if("esri.Graphic"===(null===(t=this.feature)||void 0===t?void 0:t.declaredClass)){const t=y.moduleLoader.getModuleSync("esri/geometry/Geometry");this.feature.geometry=(null===(i=null==e?void 0:e.declaredClass)||void 0===i?void 0:i.includes("esri.geometry"))?e:(null==t?void 0:t.fromJSON(e))||e}else this.feature.geometry=(null===(r=null==e?void 0:e.declaredClass)||void 0===r?void 0:r.includes("esri.geometry"))?e.toJSON():e}setFeature(e){this.feature=e,this.fillGeometry()}getFeature(){return this.feature}_isGraphicFeature(){var e;return!!(null===(e=null==this?void 0:this.feature)||void 0===e?void 0:e.layer)}}var Y=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}))};class Z extends(R(b(j))){constructor(i){super(i),this.type=t.CSV;const r=this.getDataSourceJson();r.data?(this.records=r.data.asMutable().map((e=>new f(e,this))),this.setStatus(e.Loaded)):this.url=r.url,this.portalUrl=r.portalUrl,this.itemId=r.itemId,this.url&&y.requestUtils.registerCacheableUrl(this.url)}ready(){return Y(this,void 0,void 0,(function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()}))}doLoad(){return Y(this,void 0,void 0,(function*(){return yield fetch(this.url).then((e=>Y(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>e.map((e=>new f(e,this)))))}))}}const X={maxPageSize:1e3,supportsStatistics:!0,supportsPagination:!0,supportsOrderBy:!0,supportsDistinct:!0,supportsPaginationOnDistinct:!0,supportsPaginationOnStatisticsWithGroupBy:!1,supportsPaginationOnAggregatedQueries:!0,supportsOrderByOnlyOnLayerFields:!0,supportsPercentileStatistics:!0,supportedQueryFormats:"JSON, geoJSON"};class ee extends x{getQueryCapabilities(){var e,t,i,r,a,s,o,n;return this.isClientSide||!this.layerDefinition?X:{maxPageSize:this.layerDefinition.maxRecordCount,supportsStatistics:!!(null===(e=this.layerDefinition.advancedQueryCapabilities)||void 0===e?void 0:e.supportsStatistics),supportsPagination:!!(null===(t=this.layerDefinition.advancedQueryCapabilities)||void 0===t?void 0:t.supportsPagination),supportsOrderBy:!!(null===(i=this.layerDefinition.advancedQueryCapabilities)||void 0===i?void 0:i.supportsOrderBy),supportsDistinct:!!(null===(r=this.layerDefinition.advancedQueryCapabilities)||void 0===r?void 0:r.supportsDistinct),supportsPaginationOnDistinct:!1!==(null===(a=this.layerDefinition.advancedQueryCapabilities)||void 0===a?void 0:a.supportsPaginationOnAggregatedQueries),supportsPaginationOnStatisticsWithGroupBy:!!(null===(s=this.layerDefinition.advancedQueryCapabilities)||void 0===s?void 0:s.supportsPaginationOnAggregatedQueries),supportsOrderByOnlyOnLayerFields:!!(null===(o=this.layerDefinition.advancedQueryCapabilities)||void 0===o?void 0:o.supportsOrderByOnlyOnLayerFields),supportsPercentileStatistics:!!(null===(n=this.layerDefinition.advancedQueryCapabilities)||void 0===n?void 0:n.supportsPercentileStatistics),supportedQueryFormats:this.layerDefinition.supportedQueryFormats}}}var te=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}))};class ie extends(R(b(k))){constructor(e){var i;super(e),this.type=t.FeatureLayer;const r=this.getDataSourceJson();this.portalUrl=r.portalUrl,this.itemId=r.itemId,this.layerId=r.layerId,e.layer?this.layer=e.layer:e.belongToDataSource&&e.belongToDataSource.layer&&(this.layer=e.belongToDataSource.layer),this.getDataSourceJson().isDataInDataSourceInstance&&(this.url=null,this.itemId=null,this.portalUrl=null,this.setCapabilities(new ee({layerDefinition:null,isClientSide:!0}))),(null===(i=this.layer)||void 0===i?void 0:i.portalItem)&&this.setItemInfo(this.layer.portalItem.sourceJSON),this.getAssociatedDataSource()&&(this.isSqlCaseSensitive=this.getAssociatedDataSource().isSqlCaseSensitive)}ready(){return super.ready().then((()=>this.replaceSubLayerWithFeatureLayer()))}setAssociatedDataSource(e){this.associatedDataSource=e}getAssociatedDataSource(){return this.associatedDataSource}getIdField(){return this.getSchema().idField}getGeometryType(){const e=this.getLayerDefinition();return(null==e?void 0:e.type)===n.Table?null:this.getDataSourceJson().geometryType||(null==e?void 0:e.geometryType)}doQuery(e,t){var i,r,a;return te(this,void 0,void 0,(function*(){if(this._printUseAllFieldsWarning(e.outFields),!this.getCapabilities())return Promise.reject("Unable to perform query. Waiting for layer capabilities.");if(!e||!t)return Promise.reject("Unable to perform query. Query parameter is null.");let s=null,o="";const n=this.getCapabilities().getQueryCapabilities(),l=e.merge(t);if(e.outStatistics)if(e.outStatistics.some((e=>e.statisticType.includes("percentile")))?n.supportsStatistics&&n.supportsPercentileStatistics:n.supportsStatistics){let t=e;if((null===(i=e.groupByFieldsForStatistics)||void 0===i?void 0:i.length)>0){if(n.supportsPaginationOnStatisticsWithGroupBy||(t=t.without("page").without("pageSize")),(null===(r=t.orderByFields)||void 0===r?void 0:r.length)>0){let i=!1;n.supportsOrderBy&&(i=!n.supportsOrderByOnlyOnLayerFields||!t.orderByFields.some((t=>e.outStatistics.map((e=>e.outStatisticFieldName)).some((e=>t.split(" ").includes(e)))))),i||(t=t.without("orderByFields"))}}else t=e.without("page").without("pageSize").without("orderByFields");s=yield this.doQueryByCapabilities(t),s=this.enhanceStatisticQueryResult(s,t,l)}else o="Do not support statistic query.";else{const t=!((null===(a=e.orderByFields)||void 0===a?void 0:a.length)>0)||n.supportsOrderBy,i=!e.returnDistinctValues||n.supportsDistinct&&!!e.outFields;if(t&&i){const t=n.supportsPagination,i=!e.returnDistinctValues||n.supportsPaginationOnDistinct;t&&i?s=yield this.doQueryByCapabilities(e):e.returnDistinctValues?(s=yield this.doQueryByCapabilities(e.without("page").without("pageSize")),s.queryParams=e.set("page",1)):s=yield this.doQueryWithoutPagination(e)}else t?i||(n.supportsDistinct?e.outFields||(o="outFields should be specified for returnDistinctValues."):o="Do not support distinct."):o="Do not support orderBy."}return s||Promise.reject(`Unable to perform query. Please check your parameters. ${o}`)}))}applyUsedFields(e,t){var i;if(!t||(null==e?void 0:e.outStatistics))return e;const r=Object.assign({},e);if(!r.returnDistinctValues&&t&&(r.outFields="string"==typeof t?[t]:t),!r.returnDistinctValues&&r.outFields&&!r.outFields.includes("*")){const e=this.getIdField();e&&!r.outFields.includes(e)&&(r.outFields=r.outFields.concat(e))}if(r.outFields&&!r.outFields.includes("*")){const e=null===(i=this.getLayerDefinition())||void 0===i?void 0:i.typeIdField,t=this.findJimuFieldName(e);t&&!r.outFields.includes(t)&&(r.outFields=r.outFields.concat(t))}return r}getAllUsedFields(e){var t,i;"debug"===(null==e?void 0:e.logLevel)&&console.group("All used fields");const r=null==e?void 0:e.queryParams;let a=(null===(t=null==r?void 0:r.outFields)||void 0===t?void 0:t.includes("*"))?"*":(null==r?void 0:r.outFields)||[];if(!(null==r?void 0:r.returnDistinctValues)){const t=y.dataSourceUtils.getUsedFieldsFromFeatureLayerQueryParams(r,this,"feature");if("debug"===(null==e?void 0:e.logLevel)&&console.log("Query params used fields are:",t),t.includes("*"))a="*";else{const i=super.getAllUsedFields(e);a="*"===i?"*":Array.from(new Set([...i,...t]))}const i=this.getIdField();i&&"*"!==a&&!a.includes(i)&&a.push(i)}const s=null===(i=this.getLayerDefinition())||void 0===i?void 0:i.typeIdField,o=this.findJimuFieldName(s);return o&&"*"!==a&&!a.includes(o)&&a.push(o),"*"!==a&&a.length===Object.keys(this.getSchema().fields).length&&("debug"===(null==e?void 0:e.logLevel)&&console.warn("All used fields are * since used fields length equals schema fields length."),a="*"),"debug"===(null==e?void 0:e.logLevel)&&(console.log("All used fields are:",a),console.groupEnd()),a}doQueryWithoutPagination(e){var t,i,r;return te(this,void 0,void 0,(function*(){const a=e.without("page").without("pageSize").set("returnIdsOnly",!0),s=yield this.doQueryByCapabilities(a),o=(null===(i=null===(t=s.records)||void 0===t?void 0:t.map((e=>+e.getId())))||void 0===i?void 0:i.filter((e=>!isNaN(e))))||[],n="number"==typeof e.page?e.page:1,l="number"==typeof e.pageSize?e.pageSize:this.getQueryPageSize(),d=this.sliceByPage(o,l,n);if(0===d.length)return{queryParams:e,records:[],count:0};const u=yield this.doQueryByCapabilities((0,y.Immutable)({objectIds:d,outFields:(null===(r=e.outFields)||void 0===r?void 0:r.asMutable())||["*"],returnGeometry:e.returnGeometry}));return u.queryParams=e,u}))}doQueryByCapabilities(e){var t,i,r;return te(this,void 0,void 0,(function*(){let a={queryParams:e,records:[],sourceVersion:this.getSourceVersion()};if(this.getDataSourceJson().isDataInDataSourceInstance){if(this.getSourceRecords().length>0){const t=this.getSourceRecords();a=this.isQueryParamsEmpty(e)?{queryParams:e,records:t,sourceVersion:this.getSourceVersion()}:yield y.dataSourceUtils.createFeatureLayerByRecords(this,t,this.getSourceVersion()).then((({layer:t,sourceVersion:i})=>te(this,void 0,void 0,(function*(){const r=yield this.doQueryByLayerCapabilities(e,t);return Object.assign(Object.assign({},r),{sourceVersion:i})}))))}}else if(this.layer)a=yield this.doQueryByLayerCapabilities(e,this.layer);else if(this.url){const s=(null===(r=null===(i=null===(t=this.getCapabilities().getQueryCapabilities().supportedQueryFormats)||void 0===t?void 0:t.toLowerCase)||void 0===i?void 0:i.call(t))||void 0===r?void 0:r.includes("pbf"))?"pbf":"json";a="pbf"===s&&this.layerForRestQuery?yield this.doQueryByLayerCapabilities(e,this.layerForRestQuery):yield this.doQueryByUrlCapabilities(e,this.url),"pbf"!==s||this.layerForRestQuery||this.createLayerForRestQuery()}else a=yield this.createLayerByItemId().then((t=>this.doQueryByLayerCapabilities(e,t)));return a}))}createLayerForRestQuery(){this.isDataView||this.isLocal?this.getMainDataSource().createLayerForRestQuery():(this.layerForRestQueryPromise||(this.layerForRestQueryPromise=y.dataSourceUtils.createJSAPILayerByDataSource(this,!1)),this.layerForRestQueryPromise.then((e=>{this.layerForRestQuery=e,this.getAllDerivedDataSources().forEach((t=>{t.layerForRestQuery=e}))})))}isQueryParamsEmpty(e){if(!e)return!0;const t=e.without("page").without("pageSize").without("returnGeometry").without("returnZ").without("sqlExpression").without("outFields").without("notAddFieldsToClient");if(0===Object.keys(t).length)return!0;const i="string"==typeof t.where?t.where.replace(/\s+/g,"").replace(/\(/g,"").replace(/\)/g,""):null;return 1===Object.keys(t).length&&["","1=1"].some((e=>e===i))}enhanceStatisticQueryResult(e,t,i){var r,a;let s=null===(r=e.records)||void 0===r?void 0:r.slice();if(!s)return e;let o=e.queryParams;if(null==i?void 0:i.outStatistics){if(i.orderByFields&&!(null==t?void 0:t.orderByFields)&&(s=s.length>1?this.sortRecordsByFields(s,i.orderByFields):s,o=o.set("orderByFields",i.orderByFields)),"number"==typeof i.pageSize&&"number"!=typeof(null==t?void 0:t.pageSize)){const e=null!==(a=i.page)&&void 0!==a?a:1;s=this.sliceByPage(s,i.pageSize,e),o=o.set("pageSize",i.pageSize),o=o.set("page",i.page)}i.outStatistics.every((e=>!(null==e?void 0:e.outStatisticFieldName)||s.some((t=>void 0!==t.getFieldValue(e.outStatisticFieldName)))))||i.outStatistics.forEach((e=>{if(null==e?void 0:e.outStatisticFieldName){const t=s.some((t=>void 0!==t.getFieldValue(e.outStatisticFieldName.toLowerCase()))),i=s.some((t=>void 0!==t.getFieldValue(e.outStatisticFieldName.toUpperCase())));s.forEach((r=>{const a=t?e.outStatisticFieldName.toLowerCase():i?e.outStatisticFieldName.toUpperCase():null;a&&(r.feature.attributes[e.outStatisticFieldName]=r.getFieldValue(a),delete r.feature.attributes[a])}))}}))}return Object.assign(Object.assign({},e),{records:s,queryParams:o})}sliceByPage(e,t,i){const r=t*(i-1),a=r+t;return e.slice(r,a)}sortRecordsByFields(e,t){return e.filter((e=>!!e)).sort(((e,i)=>this.compareRecordsByFields(e,i,t)))}compareRecordsByFields(e,t,i){var r,a;let s=0,o=0;for(;s<i.length;){const n=i[s].split(" ")[0];let l=0;if(i[s].split(" ").length>2)l=0;else if(typeof e.getFieldValue(n)!=typeof t.getFieldValue(n)){const i=null===(a=null===(r=this.getSchema())||void 0===r?void 0:r.fields)||void 0===a?void 0:a[n],s=((null==i?void 0:i.type)||y.JimuFieldType.Number)===y.JimuFieldType.String?"string":"number",o=typeof e.getFieldValue(n)===s,d=typeof t.getFieldValue(n)===s;l=o&&!d?1:!o&&d?-1:0}else{const i=e.getFieldValue(n),r=t.getFieldValue(n);l=this.getCompareValueResult(i,r)}if(o="DESC"===i[s].split(" ")[1]?-l:l,0!==o)break;s++}return o}getCompareValueResult(e,t){let i=0;return"string"==typeof e&&"string"==typeof t?i=e.localeCompare?e.localeCompare(t):0:"number"==typeof e&&"number"==typeof t&&(i=e-t),i}doQueryCount(e){return te(this,void 0,void 0,(function*(){if(this.getDataSourceJson().isDataInDataSourceInstance){if(0===this.getSourceRecords().length)return yield Promise.resolve({queryParams:e,count:0,sourceVersion:this.getSourceVersion()});const t=this.getSourceRecords();return this.isQueryParamsEmpty(e)?Promise.resolve({queryParams:e,count:t.length,sourceVersion:this.getSourceVersion()}):yield y.dataSourceUtils.createFeatureLayerByRecords(this,t,this.getSourceVersion()).then((({layer:t,sourceVersion:i})=>te(this,void 0,void 0,(function*(){const r=yield this.doQueryCountByLayer(e,t);return Object.assign(Object.assign({},r),{sourceVersion:i})}))))}return this.layer?yield this.doQueryCountByLayer(e,this.layer):this.url?yield this.doQueryCountByUrl(e,this.url):yield this.createLayerByItemId().then((t=>this.doQueryCountByLayer(e,t)))}))}doQueryIds(e){return te(this,void 0,void 0,(function*(){if(this.getDataSourceJson().isDataInDataSourceInstance){if(0===this.getSourceRecords().length)return Promise.resolve({queryParams:e,ids:[],sourceVersion:this.getSourceVersion()});const t=this.getSourceRecords();return this.isQueryParamsEmpty(e)?Promise.resolve({queryParams:e,ids:t.map((e=>e.getId())),sourceVersion:this.getSourceVersion()}):y.dataSourceUtils.createFeatureLayerByRecords(this,t,this.getSourceVersion()).then((({layer:t,sourceVersion:i})=>te(this,void 0,void 0,(function*(){const r=yield this.doQueryIdsByLayer(e,t);return Object.assign(Object.assign({},r),{sourceVersion:i})}))))}return this.layer?this.doQueryIdsByLayer(e,this.layer):this.url?this.doQueryIdsByUrl(e,this.url):this.createLayerByItemId().then((t=>this.doQueryIdsByLayer(e,t)))}))}doAddRecordToServerSideSource(e){return this.layer?this.addRecordByLayer(e,this.layer):this.url?this.addRecordByUrl(e,this.url):this.createLayerByItemId().then((t=>this.addRecordByLayer(e,t)))}doDeleteOneRecordFromServerSideSource(e){return this.layer?this.deleteOneRecordByLayer(e,this.layer):this.url?this.deleteOneRecordByUrl(e,this.url):this.createLayerByItemId().then((t=>this.deleteOneRecordByLayer(e,t)))}doUpdateRecordsInServerSideSource(e){return this.layer?this.updateRecordsByLayer(e,this.layer):this.url?this.updateRecordsByUrl(e,this.url):this.createLayerByItemId().then((t=>this.updateRecordsByLayer(e,t)))}doQueryCountByLayer(e,t){return te(this,void 0,void 0,(function*(){const i=this.getLayerViewForClientSideQuery(t);let r,a=!1;if(i){const t=yield i.clientQueryFeatureCount(e);(null==t?void 0:t.success)&&(a=!0,r=t.data)}if(!a){const i=yield this.changeJimuQueryToJSAPIQuery(e);r=yield t.queryFeatureCount(i)}return{queryParams:e,count:r}}))}doQueryCountByUrl(e,t){return te(this,void 0,void 0,(function*(){const i=this.changeJimuQueryToRestAPIQuery(e);return delete i.resultRecordCount,delete i.resultOffset,i.returnCountOnly||(i.returnCountOnly=!0),yield this._q(i,t).then((t=>({queryParams:e,count:t.count})))}))}doQueryIdsByLayer(e,t){return te(this,void 0,void 0,(function*(){const i=yield this.changeJimuQueryToJSAPIQuery(e),r=this.getLayerViewForClientSideQuery(t);let a,s=!1;if(r){const t=yield r.clientQueryObjectIds(e);(null==t?void 0:t.success)&&(s=!0,a=t.data)}return s||(a=yield t.queryObjectIds(i)),a||(a=[]),{queryParams:e,ids:a.map((e=>`${e}`))}}))}doQueryIdsByUrl(e,t){return te(this,void 0,void 0,(function*(){const i=this.changeJimuQueryToRestAPIQuery(e);return delete i.resultRecordCount,delete i.resultOffset,delete i.returnCountOnly,delete i.returnGeometry,i.returnIdsOnly||(i.returnIdsOnly=!0),this._q(i,t).then((t=>{var i;return{queryParams:e,ids:null===(i=t.objectIds)||void 0===i?void 0:i.map((e=>`${e}`))}}))}))}doQueryById(e){return te(this,void 0,void 0,(function*(){return yield this.doQueryByCapabilities((0,y.Immutable)({objectIds:[parseInt(e)],returnGeometry:!0,returnZ:!0})).then((e=>e.records[0]))}))}queryById(e){const t=Object.create(null,{queryById:{get:()=>super.queryById}});return te(this,void 0,void 0,(function*(){return yield t.queryById.call(this,e)}))}getConfigQueryParams(){var e;const t=this.getDataViewConfig();return t?{where:y.dataSourceUtils.getArcGISSQL(t.where,this).sql,sqlExpression:null===(e=t.where)||void 0===e?void 0:e.asMutable({deep:!0}),orderByFields:this.getOrderByArray(t.orderBy)}:null}mergeQueryParams(...e){let t=(e=e||[]).filter((e=>e)).reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{});const i=e.map((e=>null==e?void 0:e.time)).filter((e=>"number"==typeof e||Array.isArray(e))),r=i.length>1?i.reduce(((e,t)=>y.dataSourceUtils.mergeTimeExtent(e,t)),null):i[0];if(-1===r)return t.where="1=2",t;("number"==typeof r||Array.isArray(r))&&(t.time=r);const a=e.map((e=>null==e?void 0:e.where)).filter((e=>e)),s=a.length>1?a.map((e=>`(${e})`)).join(" and "):a[0];t=Object.assign(Object.assign({},t),{where:s?`${s}`:""});const o=e.map((e=>null==e?void 0:e.sqlExpression)).filter((e=>e)),n=o.length>1?o.reduce(((e,t)=>y.dataSourceUtils.getMergedSQLExpressions([e,t],this)),null):o[0];return t=Object.assign(Object.assign({},t),{sqlExpression:n}),t}getCurrentQueryParams(e){const t=super.getCurrentQueryParams(e);return this.applyGDBVersionAndFix(t,null==e?void 0:e.dataSourceToFormatSql)}getRealQueryParams(e,t,i){const r=super.getRealQueryParams(e,t,i);return this.applyGDBVersionAndFix(r,null==i?void 0:i.dataSourceToFormatSql)}getRemoteQueryParams(){return this.getSchema().filter?{where:this.getSchema().filter}:null}applyGDBVersionAndFix(e,t){this.getGDBVersion()&&(e.gdbVersion=this.getGDBVersion());let i=this.fixQueryParam((0,y.Immutable)(e));return i.sqlExpression&&t&&t.isSqlCaseSensitive!==this.isSqlCaseSensitive&&(i=i.set("where",y.dataSourceUtils.getArcGISSQL(i.sqlExpression,t).sql)),i.asMutable({deep:!0})}fixQueryParam(e){var t,i,r;let a=e;return e.outStatistics&&Object.keys(e).forEach((e=>{["outStatistics","where","gdbVersion","geometry","geometryType","spatialRel","distance","units","groupByFieldsForStatistics","time","orderByFields","havingClause","page","pageSize"].includes(e)||(a=a.without(e))})),e.returnDistinctValues&&e.returnGeometry&&(a=a.set("returnGeometry",!1)),!e.returnDistinctValues&&e.returnGeometry&&(a=a.set("returnZ",!0)),!a.outStatistics&&!a.returnDistinctValues&&(null===(t=a.orderByFields)||void 0===t?void 0:t.length)>0&&(a.orderByFields.find((e=>e.split(" ")[0]===this.getIdField()))||(a=a.set("orderByFields",a.orderByFields.concat([`${this.getIdField()} ASC`])))),a.returnDistinctValues&&(null===(i=a.outFields)||void 0===i?void 0:i.length)&&!(null===(r=a.orderByFields)||void 0===r?void 0:r.length)&&(a=a.set("orderByFields",[a.outFields[0]])),y.dataSourceUtils.areDatesInUnknownTimezone(this)&&(a=a.set("timeReferenceUnknownClient",!0)),a}addRecordByLayer(e,t){return te(this,void 0,void 0,(function*(){const i=(yield y.dataSourceUtils.changeToJSAPIGraphic(e.feature)).clone();return t.applyEdits({addFeatures:[i]}).then((e=>{var t,r;const a=null===(t=e.addFeatureResults[0])||void 0===t?void 0:t.objectId;if("number"!=typeof a||(null===(r=e.addFeatureResults[0])||void 0===r?void 0:r.error))return Promise.reject("Adding record failed.");const s=this.getIdField();return i.attributes[s]=a,new K(i,this)}))}))}addRecordByUrl(e,t){return te(this,void 0,void 0,(function*(){const i=y.dataSourceUtils.changeToRestAPIFeature(e.feature),r=Object.assign({},i),a={url:t,features:[r]};return yield y.requestUtils.requestWrapper(t,(e=>te(this,void 0,void 0,(function*(){return a.authentication=e,yield y.esri.restFeatureLayer.addFeatures(a).then((e=>{var t,i;const a=null===(t=e.addResults[0])||void 0===t?void 0:t.objectId;if("number"!=typeof a||!(null===(i=e.addResults[0])||void 0===i?void 0:i.success))return Promise.reject("Adding record failed.");const s=this.getIdField();return r.attributes[s]=a,new K(r,this)}))}))),1)}))}updateRecordsByLayer(e,t){return te(this,void 0,void 0,(function*(){const i=yield Promise.all(e.map((e=>te(this,void 0,void 0,(function*(){return yield y.dataSourceUtils.changeToJSAPIGraphic(e.feature).then((e=>e.clone()))})))));return t.applyEdits({updateFeatures:i}).then((e=>e.updateFeatureResults.filter((e=>!e.error)).length>0))}))}updateRecordsByUrl(e,t){return te(this,void 0,void 0,(function*(){const i=e.map((e=>Object.assign({},y.dataSourceUtils.changeToRestAPIFeature(e.feature)))),r={url:t,features:i};return yield y.requestUtils.requestWrapper(t,(e=>te(this,void 0,void 0,(function*(){return r.authentication=e,yield y.esri.restFeatureLayer.updateFeatures(r).then((e=>e.updateResults.filter((e=>e.success)).length>0))}))),1)}))}deleteOneRecordByLayer(e,t){return te(this,void 0,void 0,(function*(){const i=(yield y.dataSourceUtils.changeToJSAPIGraphic(e.feature)).clone();return t.applyEdits({deleteFeatures:[i]}).then((e=>e.deleteFeatureResults.filter((e=>!e.error)).length>0))}))}deleteOneRecordByUrl(e,t){return te(this,void 0,void 0,(function*(){const i=Object.assign({},y.dataSourceUtils.changeToRestAPIFeature(e.feature)),r=this.getIdField(),a=i.attributes[r],s={url:t,objectIds:[a]};return yield y.requestUtils.requestWrapper(t,(e=>te(this,void 0,void 0,(function*(){return s.authentication=e,yield y.esri.restFeatureLayer.deleteFeatures(s).then((e=>e.deleteResults.filter((e=>e.success)).length>0))}))),1)}))}fetchSchema(){return te(this,void 0,void 0,(function*(){if(this.getDataSourceJson().isStatistic)return Promise.resolve((0,y.Immutable)({}));let e;return e=this.layer?yield this.fetchSchemaWithLayer():yield this.fetchSchemaWithoutLayer(),(null==e?void 0:e.fields)?e:Promise.reject(new g(this.id,"No fields."))}))}createLayerByItemId(){return te(this,void 0,void 0,(function*(){return this.createFeatureLayerPromise||(this.itemId?this.createFeatureLayerPromise=(0,y.loadArcGISJSAPIModules)(["esri/layers/Layer","esri/portal/PortalItem"]).then((e=>te(this,void 0,void 0,(function*(){const t=e[0],i=e[1];return yield t.fromPortalItem({portalItem:new i({id:this.itemId,portal:{url:this.portalUrl}})})})))).then((e=>te(this,void 0,void 0,(function*(){return(null==e?void 0:e.type)===u.FeatureLayer?yield Promise.resolve(e):(null==e?void 0:e.type)===u.GroupLayer?yield e.loadAll().then((e=>te(this,void 0,void 0,(function*(){const t=e.layers.toArray().find((e=>`${e.layerId}`===this.layerId||y.dataSourceUtils.fixLayerId(e.title)===y.dataSourceUtils.fixLayerId(this.getMainDataSource().getDataSourceJson().sourceLabel)));return(null==t?void 0:t.type)===u.FeatureLayer?Promise.resolve(t):Promise.reject("Feaure layer data source error: failed to create feature layer with specific layer id.")})))):void 0})))):this.createFeatureLayerPromise=Promise.reject("No item id.")),this.createFeatureLayerPromise}))}fetchSchemaWithoutLayer(){return te(this,void 0,void 0,(function*(){const e=this.url?y.ServiceManager.getInstance().fetchServiceInfo(this.url):Promise.resolve(null);return yield e.then((e=>this.itemId?Promise.all([this.fetchItemData(),this.fetchItemInfo()]).then((([t,i])=>{var r;const a=t&&t.layers&&t.layers[this.layerId],s=(null==e?void 0:e.definition)?this.getUpdatedLayerDefinition(a,e.definition):null==a?void 0:a.layerDefinition;return!this.parentDataSource&&s&&(s.name=(null==i?void 0:i.title)||s.name),{serviceDefinition:s,fieldInfos:a&&a.popupInfo&&a.popupInfo.fieldInfos,filter:(null===(r=null==a?void 0:a.layerDefinition)||void 0===r?void 0:r.definitionExpression)?`(${a.layerDefinition.definitionExpression})`:null,refreshInterval:60*(null==a?void 0:a.refreshInterval)}})):{serviceDefinition:null==e?void 0:e.definition,fieldInfos:null,filter:null,refreshInterval:null})).then((({serviceDefinition:e,fieldInfos:t,filter:i,refreshInterval:r})=>{var a,s,o,n;const l={fields:{},idField:(null==e?void 0:e.idField)||(null===(s=null===(a=null==e?void 0:e.fields)||void 0===a?void 0:a.find((e=>"esriFieldTypeOID"===e.type)))||void 0===s?void 0:s.name)||"OBJECTID",filter:i,refreshInterval:r,label:(null===(o=this.layer)||void 0===o?void 0:o.title)||(null==e?void 0:e.name)};return this.setLayerDefinitionAndQueryCapabilities(e),null===(n=null==e?void 0:e.fields)||void 0===n||n.forEach((e=>{const i=t&&t.find((t=>t.fieldName===e.name)),r=y.dataSourceUtils.convertFieldToJimuField(e,i);r&&(l.fields[e.name]=r)})),(0,y.Immutable)(l)}))}))}fetchSchemaWithLayer(){return te(this,void 0,void 0,(function*(){return this.layer.load().then((()=>{var e,t;if(!this.layer.fields)return null;if(!(this.getAssociatedDataSource()||this.getDataSourceJson().isOutputFromWidget||"multipatch"!==this.layer.geometryType&&"mesh"!==this.layer.geometryType))return null;this.updateLayerDefinitionByLayer();const i={fields:{},idField:this.layer.objectIdField||(null===(t=null===(e=this.layer.fields)||void 0===e?void 0:e.find((e=>"oid"===e.type)))||void 0===t?void 0:t.name)||"OBJECTID",filter:this.layer.definitionExpression?`(${this.layer.definitionExpression})`:null,refreshInterval:60*this.layer.refreshInterval,label:this.layer.title};return this.layer.fields.forEach((e=>{const t=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos&&this.layer.popupTemplate.fieldInfos.find((t=>t.fieldName===e.name)),r=y.dataSourceUtils.convertFieldToJimuField(e.toJSON(),null==t?void 0:t.toJSON());r&&(i.fields[e.name]=r)})),(0,y.Immutable)(i)}))}))}updateLayerDefinitionByLayer(){let e=this.layer.sourceJSON;const t=this.layer.renderer;if(t&&t.toJSON()){const i=t.toJSON();if("uniqueValue"===i.type){let t=this.layer.sourceJSON.types;i.field1!==this.layer.sourceJSON.typeIdField&&(t=[],i.uniqueValueInfos.forEach((e=>{t.push({id:e.value,name:e.label,domain:{}})}))),e=Object.assign({name:this.layer.title},e,{drawingInfo:{renderer:i},typeIdField:i.field1,types:t})}}this.setLayerDefinitionAndQueryCapabilities(e)}getLayerDefinition(){return y.dataSourceUtils.getLayerDefinition(this)}setLayerDefinition(e){this.layerDefinition=e}getPopupInfo(){return y.dataSourceUtils.getPopupInfo(this)}setPopupInfo(e){this.popupInfo=e}getItemInfo(){return this.isDataView||this.isLocal?this.getMainDataSource().getItemInfo():super.getItemInfo()}getCharts(){var e,t;const i=this.getMainDataSource();if(null==i?void 0:i.layer)return i.layer.charts;if(null==i?void 0:i.getItemData()){const r=null===(t=null===(e=i.getItemData())||void 0===e?void 0:e.layers)||void 0===t?void 0:t.find((e=>`${e.id}`===this.layerId));return null==r?void 0:r.charts}return[]}setLayerDefinitionAndQueryCapabilities(e){this.setLayerDefinition(e);const t=!this.url&&!!this.itemId;this.setCapabilities(new ee({layerDefinition:e,isClientSide:this.getDataSourceJson().isDataInDataSourceInstance||t}))}getCapabilities(){return super.getCapabilities()}buildRecord(e){return new K(e,this)}getFieldCodedValueList(e,t){let i="";const r=this.getSchema().fields;return Object.keys(r).some((t=>t===e&&(i=r[t].name,!0))),y.dataSourceUtils.getCodedValueListForCodedValueOrSubtypeField(this.getLayerDefinition(),i,t)}getGDBVersion(){return this.getInfo().gdbVersion}changeGDBVersion(e){(0,y.getAppStore)().dispatch(y.appActions.changeDataSourceGDBVersion(this.id,e)),this.layer&&(this.layer.gdbVersion=e)}getUpdatedLayerDefinition(e,t){let i=t;if(e&&e.layerDefinition){let r;const a=e.layerDefinition.drawingInfo;if(a){if(a.renderer&&"uniqueValue"===a.renderer.type){let i=t.types;a.renderer.field1!==t.typeIdField&&(i=[],a.renderer.uniqueValueInfos.forEach((e=>{i.push({id:e.value,name:e.label,domain:{}})}))),r={defaultVisibility:e.layerDefinition.defaultVisibility,drawingInfo:e.layerDefinition.drawingInfo,typeIdField:a.renderer.field1,types:i}}}else e.layerDefinition.defaultVisibility!==t.defaultVisibility&&(r={defaultVisibility:e.layerDefinition.defaultVisibility});i=Object.assign({},i,r)}return i}getOrderByArray(e){var t;return null!==(t=null==e?void 0:e.map((e=>e.jimuFieldName+" "+e.order)).asMutable())&&void 0!==t?t:[]}changeJimuQueryToRestAPIQuery(e){var t,i;if(!e)return null;const r=e.asMutable({deep:!0});if("number"==typeof r.pageSize){const e=null!==(t=r.page)&&void 0!==t?t:1;r.resultOffset=(e-1)*r.pageSize,r.resultRecordCount=r.pageSize,null!==this.getMaxRecordCount()&&(1===e?r.resultRecordCount=Math.min(this.getMaxRecordCount(),r.pageSize):e*r.pageSize>this.getMaxRecordCount()&&(r.resultRecordCount=this.getMaxRecordCount()-(e-1)*r.pageSize)),delete r.page,delete r.pageSize}return Array.isArray(r.orderByFields)&&(r.orderByFields=r.orderByFields.join(",")),Array.isArray(r.groupByFieldsForStatistics)&&(r.groupByFieldsForStatistics=r.groupByFieldsForStatistics.join(",")),Array.isArray(r.time)&&(r.time=r.time.join(",")),(null===(i=r.outStatistics)||void 0===i?void 0:i.some((e=>{var t;return null===(t=e.statisticParameters)||void 0===t?void 0:t.orderBy})))&&(r.outStatistics=r.outStatistics.map((e=>{var t;return(null===(t=e.statisticParameters)||void 0===t?void 0:t.orderBy)&&(e.statisticParameters.orderBy=e.statisticParameters.orderBy.toUpperCase()),e}))),r}changeJimuQueryToJSAPIQuery(e){return te(this,void 0,void 0,(function*(){return yield y.dataSourceUtils.changeJimuFeatureLayerQueryToJSAPILayerQuery(this,e)}))}doQueryByUrlCapabilities(e,t){const i=this.changeJimuQueryToRestAPIQuery(e);return i.returnCountOnly?(console.error("To query count, please use queryCount."),Promise.reject("To query count, please use queryCount.")):this._q(i,t).then((t=>{var i;const r=Object.keys(this.getSchema().fields).filter((e=>t.fields&&t.fields.find((t=>t.name===this.getSchema().fields[e].name))));return{queryParams:e,fields:r,records:(t.features?t.features.map((e=>new K(e,this))):null===(i=t.objectIds)||void 0===i?void 0:i.map((e=>new K({attributes:{[this.getIdField()]:e}},this))))||[]}}))}doQueryByLayerCapabilities(e,t){var i;return te(this,void 0,void 0,(function*(){const r=yield this.changeJimuQueryToJSAPIQuery(e),a=this.getLayerViewForClientSideQuery(t);if(e.returnIdsOnly){let i;delete r.returnIdsOnly;let s=!1;if(a){const t=yield a.clientQueryObjectIds(e);(null==t?void 0:t.success)&&(s=!0,i=t.data)}s||(i=yield t.queryObjectIds(r));const o=null==i?void 0:i.map((e=>new K({attributes:{[this.getIdField()]:e}},this))),n=[this.getIdField()];return{queryParams:e,records:o,fields:n}}{let s,o=!1,n=!0;if(a){let t=e;(null===(i=t.orderByFields)||void 0===i?void 0:i.length)||(t=t.set("orderByFields",[this.getIdField()]));const r=yield a.clientQueryFeatures(t);(null==r?void 0:r.success)&&(o=!0,s=r.data,n=r.hasFullGeometries)}o||(s=yield t.queryFeatures(r));const l=s.features.map((e=>new K(e,this,{hasFullGeometries:n}))),d=Object.keys(this.getSchema().fields).filter((e=>s.fields&&s.fields.find((t=>t.name===this.getSchema().fields[e].name))));return{queryParams:e,records:l,fields:d}}}))}getLayerViewForClientSideQuery(e){var t,i;if(!(null===(t=this.getRootDataSource())||void 0===t?void 0:t.map)||e!==this.layer)return null;const r=y.moduleLoader.getModuleSync("jimu-arcgis"),a=null===(i=null==r?void 0:r.MapViewManager)||void 0===i?void 0:i.getInstance();return null==a?void 0:a.getJimuLayerViewForClientQuery(this.getMainDataSource())}_q(e,t){return te(this,void 0,void 0,(function*(){const i=Object.keys(e||{}).reduce(((t,i)=>"object"!=typeof e[i]?`${t}&${i}=${e[i]}`:`${t}&${i}=${JSON.stringify(e[i])}`),""),r=`${t}?${i}`.length>1500,a=Object.assign({url:t,httpMethod:r?"POST":"GET"},e);return a.timeReferenceUnknownClient&&(a.params={where:a.where||"1=1",outFields:a.outFields||"*",timeReferenceUnknownClient:!0}),yield y.requestUtils.requestWrapper(t,(e=>te(this,void 0,void 0,(function*(){return a.authentication=e,yield y.esri.restFeatureLayer.queryFeatures(a)}))),1)}))}getTimezone(){var e,t,i;if(y.dataSourceUtils.areDatesInUnknownTimezone(this))return"unknown";{const r=null===(e=(0,y.getAppStore)().getState().appConfig.attributes)||void 0===e?void 0:e.timezone;if(!r||r.type===y.TimezoneConfig.Device)return"device";if(r.type===y.TimezoneConfig.Specific)return r.value;if(r.type===y.TimezoneConfig.Data){if(!(null===(t=this.getRootDataSource())||void 0===t?void 0:t.map))return this.getLayerTimezone();{const e=null===(i=this.getRootDataSource().map.resourceInfo)||void 0===i?void 0:i.timeZone;if(!e||"system"===e)return"device";if("unknown"===e)return this.getLayerTimezone();if("string"==typeof e)return e}}}return null}getLayerTimezone(){var e,t;return(null===(t=null===(e=this.getLayerDefinition())||void 0===e?void 0:e.dateFieldsTimeReference)||void 0===t?void 0:t.timeZone)||null}allowToExportData(){var e,t;if(this.isDataView||this.isLocal)return this.getMainDataSource().allowToExportData();if(this.getDataSourceJson().isOutputFromWidget&&1===(null===(e=this.getDataSourceJson().originDataSources)||void 0===e?void 0:e.length)){const e=null===(t=this.getDataSourceJson().originDataSources[0])||void 0===t?void 0:t.dataSourceId,i=e&&this.dataSourceManager.getDataSource(e);return i?i.allowToExportData():(console.error("Origin data source is not created, allow to export data by default. Output data source id is ",this.id),Promise.resolve(!0))}return this.getDataSourceJson().disableExport?Promise.resolve(!1):this.allowToExportDataInRemote()}allowToExportDataInRemote(){return te(this,void 0,void 0,(function*(){return this.allowExportRemoteCheckPromise||(this.allowExportRemoteCheckPromise=y.proxyUtils.isDataSourceSubscriberOrPremium(this.getDataSourceJson()).then((e=>!e&&(!y.dataSourceUtils.isAGOLHostedService(this.getDataSourceJson().url)||this.allowToExportDataInItem())))),this.allowExportRemoteCheckPromise}))}allowToExportDataInItem(){return te(this,void 0,void 0,(function*(){try{if(!this.itemId)return!0;const e=(0,y.getAppStore)().getState().user;if(!e)return this.getWhetherAllowToExportInItemSetting();let t=this.getItemInfo();return t=(null==t?void 0:t.contentOrigin)?t:yield y.requestUtils.requestWrapper((0,y.getAppStore)().getState().portalUrl,(e=>y.esri.restPortal.getItem(this.itemId,{portal:y.portalUrlUtils.getPortalRestUrl((0,y.getAppStore)().getState().portalUrl),authentication:e}))).catch((e=>(console.warn("Failed to get item info via app portal url. ",e),t))),"self"===(null==t?void 0:t.contentOrigin)?"org_admin"===e.role||(!(!e||(null==t?void 0:t.owner)!==e.username)||this.getWhetherAllowToExportInItemSetting()):this.getWhetherAllowToExportInItemSetting()}catch(e){return console.log(`Failed to get whether data source ${this.id} allows to export data, `,e),!0}}))}getWhetherAllowToExportInItemSetting(){var e;return te(this,void 0,void 0,(function*(){if(this.url){const t=yield y.requestUtils.requestWrapper(this.url,(e=>te(this,void 0,void 0,(function*(){return yield y.esri.restRequest.request(this.url,{authentication:e,httpMethod:"GET"})}))),1);return!!(null===(e=null==t?void 0:t.capabilities)||void 0===e?void 0:e.includes("Extract"))}return!0}))}supportSymbol(){return y.dataSourceUtils.supportSymbol(this)}supportAttachment(){return y.dataSourceUtils.supportAttachment(this)}supportTime(){return y.dataSourceUtils.supportTime(this)}getTimeInfo(){var e,t,i,r;return this.layer?(null===(e=this.getLayerDefinition())||void 0===e?void 0:e.timeInfo)&&this.layer.timeInfo?y.lodash.merge(this.getLayerDefinition().timeInfo,this.layer.timeInfo.toJSON()):(null===(t=this.layer.timeInfo)||void 0===t?void 0:t.toJSON())||(null===(i=this.getLayerDefinition())||void 0===i?void 0:i.timeInfo):null===(r=this.getLayerDefinition())||void 0===r?void 0:r.timeInfo}createJSAPILayerByDataSource(){return y.dataSourceUtils.createJSAPILayerByDataSource(this)}createRestAPILayerByDataSource(){return y.dataSourceUtils.createRestAPILayerByDataSource(this)}updateSourceByFeatures(e,t,i,r){return te(this,void 0,void 0,(function*(){const a=yield(0,y.loadArcGISJSAPIModule)("esri/layers/FeatureLayer");this._layer=new a(Object.assign(Object.assign({},r),{objectIdField:i,fields:t,source:e})),this.clearRecordsNotAddVersion(),this.addSourceVersion()}))}getDataViews(){return super.getDataViews()}getDataView(e){return super.getDataView(e)}getMainDataSource(){return super.getMainDataSource()}get layer(){return y.dataSourceUtils.getJSAPILayer(this)}set layer(e){this._layer=e}get restLayer(){return y.dataSourceUtils.getRestAPILayer(this)}set restLayer(e){this._restLayer=e}afterUpdateRecords(e){this.clearRecordsNotAddVersionForDerivedDssWhichQueryStat(),super.afterUpdateRecords(e)}afterUpdateRecord(e){this.clearRecordsNotAddVersionForDerivedDssWhichQueryStat(),super.afterUpdateRecord(e)}afterAddRecord(e){this.clearRecordsNotAddVersionForDerivedDssWhichQueryStat(),super.afterAddRecord(e)}afterDeleteRecordById(e){this.clearRecordsNotAddVersionForDerivedDssWhichQueryStat(),super.afterDeleteRecordById(e)}clearRecordsNotAddVersionForDerivedDssWhichQueryStat(){this.getMainDataSource().getAllDerivedDataSources().concat(this.getMainDataSource()).forEach((e=>{var t;(null===(t=e.getCurrentQueryParams())||void 0===t?void 0:t.outStatistics)&&e.clearRecordsNotAddVersion()}))}replaceSubLayerWithFeatureLayer(){var e;return te(this,void 0,void 0,(function*(){if("esri.layers.support.Sublayer"===(null===(e=this.layer)||void 0===e?void 0:e.declaredClass)&&this.layer.url){const e=yield(0,y.loadArcGISJSAPIModule)("esri/layers/FeatureLayer"),t=this.layer.definitionExpression||null;this.layer=new e({id:this.layer.id,title:this.layer.title,url:y.dataSourceUtils.getUrlByLayer(this.layer),renderer:this.layer.renderer,popupTemplate:this.layer.popupTemplate,sourceJSON:this.layer.sourceJSON,parent:this.layer.parent,definitionExpression:t}),this.getAllDerivedDataSources().forEach((e=>{e.clearRecords(),e.layer=this.layer})),yield this.layer.load()}return Promise.resolve(this)}))}_printUseAllFieldsWarning(e){(null==e?void 0:e.includes("*"))&&y.lodash.defer((()=>{console.debug(`Using * as out fields to do query. Data source id is: ${this.id}`)}))}}class re extends E{constructor(){super(...arguments),this.type=t.FeatureService}getChildIds(){return this.getChildIdsByUrl()}createChildDataSourceOptionsById(e,t,i){return this.createChildDataSourceOptionsByIdFromUrl(e,t,i)}createJSAPILayerByDataSource(){const e=Object.create(null,{createJSAPILayerByDataSource:{get:()=>super.createJSAPILayerByDataSource}});var t,i,r,a,s,o,n,l,d,u,c;return l=this,d=void 0,c=function*(){let l;try{if(this.areChildDataSourcesCreated()||(yield this.childDataSourcesReady()),(null===(i=null===(t=this.getItemInfo())||void 0===t?void 0:t.typeKeywords)||void 0===i?void 0:i.includes("Singlelayer"))||1===(null===(a=null===(r=this.getServiceDefinition())||void 0===r?void 0:r.layers)||void 0===a?void 0:a.length)){const e=this.getChildDataSources();if(0===e.length){const[e,t]=yield(0,y.loadArcGISJSAPIModules)(["esri/layers/Layer","esri/layers/GroupLayer"]),i=yield e.fromArcGISServerUrl({url:`${this.url}/${(null===(n=null===(o=null===(s=this.getServiceDefinition())||void 0===s?void 0:s.layers)||void 0===o?void 0:o[0])||void 0===n?void 0:n.id)||0}`});l=new t({layers:i.isTable?[]:[i],tables:i.isTable?[i]:[],title:this.getLabel()})}else{const t=(0,y.loadArcGISJSAPIModule)("esri/layers/GroupLayer"),i=e[0].layer?Promise.resolve(e[0].layer):e[0].createJSAPILayerByDataSource(),[r,a]=yield Promise.all([t,i]);l=new r({layers:a.isTable?[]:[a],tables:a.isTable?[a]:[],title:this.getLabel()})}}else l=yield e.createJSAPILayerByDataSource.call(this)}catch(e){console.error("Failed to create JS API layer. ",e,this.id)}return"group"===(null==l?void 0:l.type)?l:null},new((u=void 0)||(u=Promise))((function(e,t){function i(e){try{a(c.next(e))}catch(e){t(e)}}function r(e){try{a(c.throw(e))}catch(e){t(e)}}function a(t){var a;t.done?e(t.value):(a=t.value,a instanceof u?a:new u((function(e){e(a)}))).then(i,r)}a((c=c.apply(l,d||[])).next())}))}}class ae extends E{constructor(e){super(e),this.type=t.GroupLayer,this.setItemData(e.itemData)}getChildIds(){return this.layer?this.getChildIdsByLayer():this.url?this.getChildIdsByUrl():this.itemId||this.getItemData()?this.getChildIdsByItem():[]}createChildDataSourceOptionsById(e,t,i){return this.layer?this.createChildDataSourceOptionsByIdFromLayer(e,t,i):this.url?this.createChildDataSourceOptionsByIdFromUrl(e,t,i):this.itemId||this.getItemData()?this.createChildDataSourceOptionsByIdFromItem(e,t,i):null}getChildIdsByLayer(){return this.isJSAPIGroupLayer(this.layer)?this.getChildIdsByJSAPIGroupLayer():this.getChildIdsByJSAPISubLayer()}getChildIdsByItem(){return this.isFeatureCollectionItem(this.getItemInfo())?this.getChildIdsByFeatureCollectionItem():this.getChildIdsByGroupLayerItem()}createChildDataSourceOptionsByIdFromLayer(e,t,i){if(this.layer){const r=this.isJSAPIGroupLayer(this.layer),a=r?this.findLayerInfoOfJSAPIGroupLayer(i):this.findLayerInfoOfJSAPISubLayer(i);if(!(null==a?void 0:a.layer))return null;if(r)return this.createChildDataSourceOptionsByLayer(a.layer,a.url,t,e,a.order);{const i=this.createChildDataSourceOptionsByLayerDefinition(a.layer.sourceJSON,a.url,t,e,a.order);return a.layer.title&&i.dataSourceJson&&(i.dataSourceJson=i.dataSourceJson.set("sourceLabel",a.layer.title)),i?Object.assign(Object.assign({},i),{layer:a.layer}):null}}return null}createChildDataSourceOptionsByIdFromItem(e,t,i){let r;if(this.isFeatureCollectionItem(this.getItemInfo())){const a=this.findLayerInfoOfFeatureCollectionItem(i);if(!(null==a?void 0:a.layerDefinition))return null;r=this.createChildDataSourceOptionsByLayerDefinition(a.layerDefinition,null,t,e,a.order),r&&!r.dataSourceJson.layerId&&(r.dataSourceJson=r.dataSourceJson.set("layerId",`${a.order}`))}else{const a=this.findLayerInfoOfGroupLayerItem(i);if(!(null==a?void 0:a.layerItem))return null;r=this.createChildDataSourceOptionsByLayerItem(a.layerItem,a.portalUrl,t,e,a.order)}return r}createChildDataSourceOptionsByLayerItem(e,t,i,r,a){const s=this.createChildDataSourceJsonByLayerItem(e,t,i,r);return s?{id:r,dataSourceJson:s,parentDataSource:this,jimuChildId:i,order:a,itemData:e}:null}createChildDataSourceJsonByLayerItem(e,t,i,r){var a,s,o;if(!e||!r)return null;const n=null===(s=null===(a=this.getDataSourceJson().schema)||void 0===a?void 0:a.childSchemas)||void 0===s?void 0:s[i];return B(r,e,t,null===(o=this.getDataSourceJson().childDataSourceJsons)||void 0===o?void 0:o[i],n)}createChildDataSourceOptionsByLayer(e,t,i,r,a){const s=this.createChildDataSourceJsonByLayer(e,t,i,r);return s?{id:r,dataSourceJson:s,parentDataSource:this,jimuChildId:i,order:a,layer:e}:null}createChildDataSourceJsonByLayer(e,t,i,r){var a,s,o,n,l,d;if(!e||!r)return null;const u=e.sourceJSON,c=y.dataSourceUtils._getFixedLayerIdByLayerDefinition(u)||y.dataSourceUtils.getLabelFromArcGISServiceUrl(t),h=(null===(s=null===(a=this.getDataSourceJson().schema)||void 0===a?void 0:a.childSchemas)||void 0===s?void 0:s[i])||(null===(n=null===(o=this.getDataSourceJson().schema)||void 0===o?void 0:o.childSchemas)||void 0===n?void 0:n[c]);return V(r,e,(null===(l=this.getDataSourceJson().childDataSourceJsons)||void 0===l?void 0:l[i])||(null===(d=this.getDataSourceJson().childDataSourceJsons)||void 0===d?void 0:d[c]),h)}findLayerInfoOfJSAPIGroupLayer(e){let t;return this.getJSAPILayersAndTables().some(((i,r)=>{const a=y.dataSourceUtils.getUrlByLayer(i),s=y.dataSourceUtils.getDataSourceSourceUrl(a);return this.getChildIdByLayer(i)===e&&(t={layer:i,url:s,order:r},!0)})),t}findLayerInfoOfJSAPISubLayer(e){let t;return this.getJSAPISubLayers().some(((i,r)=>{const a=y.dataSourceUtils.getUrlByLayer(i),s=y.dataSourceUtils.getDataSourceSourceUrl(a);return this.getChildIdBySubLayer(i)===e&&(t={layer:i,url:s,order:r},!0)})),t}findLayerInfoOfGroupLayerItem(e){let t;return this.getLayersOfGroupLayerItem().some(((i,r)=>this.getChildIdByLayerItem(i)===e&&(t={layerItem:i,order:r,portalUrl:this.portalUrl},!0))),t}findLayerInfoOfFeatureCollectionItem(e){let t;return this.getLayersOfFeatureCollectionItem().some(((i,r)=>this.getChildIdByLayerDefinition(i,null)===e&&(t={layerDefinition:i,order:r},!0))),t}getJSAPISubLayers(){var e,t;return(null===(t=null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse())||[]}getJSAPILayersAndTables(){var e,t,i,r;const a=(null===(t=null===(e=this.layer.layers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse())||[],s=(null===(r=null===(i=this.layer.tables)||void 0===i?void 0:i.toArray())||void 0===r?void 0:r.reverse())||[];return a.concat(s)}getLayersOfFeatureCollectionItem(){var e,t;return(null===(t=null===(e=this.getItemData())||void 0===e?void 0:e.layers)||void 0===t?void 0:t.map((e=>e.layerDefinition)))||[]}getLayersOfGroupLayerItem(){var e;return(null===(e=this.getItemData())||void 0===e?void 0:e.layers)||[]}getChildIdsByJSAPISubLayer(){return this.getJSAPISubLayers().map((e=>this.getChildIdBySubLayer(e)))}getChildIdsByJSAPIGroupLayer(){return this.getJSAPILayersAndTables().map((e=>this.getChildIdByLayer(e)))}getChildIdsByFeatureCollectionItem(){return this.getLayersOfFeatureCollectionItem().map((e=>this.getChildIdByLayerDefinition(e,null)))}getChildIdsByGroupLayerItem(){return this.getLayersOfGroupLayerItem().map((e=>this.getChildIdByLayerItem(e)))}getChildIdByLayerItem(e){return y.dataSourceUtils.getFixedLayerIdByLayerDefinition(e)}isJSAPIGroupLayer(e){return(null==e?void 0:e.type)===u.GroupLayer}isFeatureCollectionItem(e){return(null==e?void 0:e.type)===d.FeatureCollection}}class se extends E{constructor(){super(...arguments),this.type=t.MapService}getChildIds(){return this.layer?this.getChildIdsByLayer():this.getChildIdsByUrl()}createChildDataSourceOptionsById(e,t,i){return this.layer?this.createChildDataSourceOptionsByIdFromLayer(e,t,i):this.url?this.createChildDataSourceOptionsByIdFromUrl(e,t,i):null}fetchServiceDefinition(){const e=Object.create(null,{fetchServiceDefinition:{get:()=>super.fetchServiceDefinition}});return t=this,i=void 0,a=function*(){return this.layer?(yield this.layer.loadAll(),this.updateServiceDefinitionByLayer(),this.getServiceDefinition()):e.fetchServiceDefinition.call(this)},new((r=void 0)||(r=Promise))((function(e,s){function o(e){try{l(a.next(e))}catch(e){s(e)}}function n(e){try{l(a.throw(e))}catch(e){s(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof r?i:new r((function(e){e(i)}))).then(o,n)}l((a=a.apply(t,i||[])).next())}));var t,i,r,a}supportTime(){return y.dataSourceUtils.supportTime(this)}getTimeInfo(){var e,t;return this.layer?null===(e=this.layer.timeInfo)||void 0===e?void 0:e.toJSON():null===(t=this.getServiceDefinition())||void 0===t?void 0:t.timeInfo}getTimeExtent(){const e=this.getInfo().widgetQueries||{},t=Object.values(e).map((e=>null==e?void 0:e.time)).filter((e=>"number"==typeof e||Array.isArray(e)));return t.length>1?t.reduce(((e,t)=>y.dataSourceUtils.mergeTimeExtent(e,t)),null):t[0]}changeTimeExtent(e,i){var r,a;y.utils.isDeepEqual(e,null===(a=null===(r=this.getInfo().widgetQueries)||void 0===r?void 0:r[i])||void 0===a?void 0:a.time)||((0,y.getAppStore)().dispatch(y.appActions.updateWidgetQuery(this.id,i,{time:e})),this.getAllChildDataSources().forEach((r=>{r.type===t.FeatureLayer&&r.updateQueryParams({time:e},i)})))}changeGDBVersion(e){super.changeGDBVersion(e),this.layer&&"map-image"===this.layer.type&&(this.layer.gdbVersion=e)}createChildDataSourceOptionsByIdFromLayer(e,t,i){if(this.layer){const r=this.findSubLayerInfo(i);if(!(null==r?void 0:r.subLayer))return null;const a=this.createChildDataSourceOptionsByLayerDefinition(r.subLayer.sourceJSON,r.url,t,e,r.order);return r.subLayer.title&&a.dataSourceJson&&(a.dataSourceJson=a.dataSourceJson.set("sourceLabel",r.subLayer.title)),a?Object.assign(Object.assign({},a),{layer:r.subLayer}):null}return null}findSubLayerInfo(e){let t;return this.getSubLayers().some(((i,r)=>{const a=y.dataSourceUtils.getUrlByLayer(i),s=y.dataSourceUtils.getDataSourceSourceUrl(a);return this.getChildIdBySubLayer(i)===e&&(t={subLayer:i,url:s,order:r},!0)})),t}getSubLayers(){var e,t;return(null===(t=null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray())||void 0===t?void 0:t.reverse())||[]}getChildIdsByLayer(){var e,t;return((null===(t=null===(e=this.layer)||void 0===e?void 0:e.sublayers)||void 0===t?void 0:t.toArray())||[]).map((e=>this.getChildIdBySubLayer(e)))}}var oe=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}))};class ne extends D{constructor(){super(...arguments),this.type=t.SimpleLocal}updateRecoreds(e){this.records=e,this.addVersion()}addRecord(e){return oe(this,void 0,void 0,(function*(){return e.getId()||e.setId((0,y.uuidv1)()),this.records.push(e),this.addVersion(),yield Promise.resolve(e)}))}updateRecord(e){return oe(this,void 0,void 0,(function*(){const t=this.records.findIndex((t=>t.getId()===e.getId()));return this.records.splice(t,1,e),this.addVersion(),Promise.resolve(!0)}))}deleteRecord(e){return oe(this,void 0,void 0,(function*(){return this.records.splice(e,1),this.addVersion(),yield Promise.resolve(!0)}))}}class le extends E{constructor(){super(...arguments),this.type=t.SceneService}getChildIds(){return this.getChildIdsByUrl()}createChildDataSourceOptionsById(e,t,i){return this.createChildDataSourceOptionsByIdFromUrl(e,t,i)}createJSAPILayerByDataSource(){const e=Object.create(null,{createJSAPILayerByDataSource:{get:()=>super.createJSAPILayerByDataSource}});var t,i,r,a,s,o,n,l,d,u,c;return l=this,d=void 0,c=function*(){let l;try{if(this.areChildDataSourcesCreated()||(yield this.childDataSourcesReady()),(null===(i=null===(t=this.getItemInfo())||void 0===t?void 0:t.typeKeywords)||void 0===i?void 0:i.includes("Singlelayer"))||1===(null===(a=null===(r=this.getServiceDefinition())||void 0===r?void 0:r.layers)||void 0===a?void 0:a.length)){const e=this.getChildDataSources();if(0===e.length){const[e,t]=yield(0,y.loadArcGISJSAPIModules)(["esri/layers/Layer","esri/layers/GroupLayer"]);l=new t({layers:[yield e.fromArcGISServerUrl({url:`${this.url}/layers/${(null===(n=null===(o=null===(s=this.getServiceDefinition())||void 0===s?void 0:s.layers)||void 0===o?void 0:o[0])||void 0===n?void 0:n.id)||0}`})],title:this.getLabel()})}else{const t=(0,y.loadArcGISJSAPIModule)("esri/layers/GroupLayer"),i=e[0].layer?Promise.resolve(e[0].layer):e[0].createJSAPILayerByDataSource(),[r,a]=yield Promise.all([t,i]);l=new r({layers:[a],title:this.getLabel()})}}else l=yield e.createJSAPILayerByDataSource.call(this)}catch(e){console.error("Failed to create JS API layer. ",e,this.id)}return"group"===(null==l?void 0:l.type)?l:null},new((u=void 0)||(u=Promise))((function(e,t){function i(e){try{a(c.next(e))}catch(e){t(e)}}function r(e){try{a(c.throw(e))}catch(e){t(e)}}function a(t){var a;t.done?e(t.value):(a=t.value,a instanceof u?a:new u((function(e){e(a)}))).then(i,r)}a((c=c.apply(l,d||[])).next())}))}}var de=function(e,t,i,r){return new(i||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}))};class ue extends(R(b(k))){constructor(e){var i,r,a;super(e),this.type=t.SceneLayer;const s=this.getDataSourceJson();if(this.portalUrl=s.portalUrl,this.itemId=s.itemId,this.layerId=s.layerId,e.layer&&(this.layer=e.layer),e.belongToDataSource&&e.belongToDataSource.layer&&(this.layer=e.belongToDataSource.layer),this.isLocal){const t=null===(i=e.belongToDataSource)||void 0===i?void 0:i.getAssociatedDataSource();t&&y.DataSourceManager.getInstance().createLocalDataSource(t,this.localId)}else if(this.isDataView){const t=null===(r=e.belongToDataSource)||void 0===r?void 0:r.getAssociatedDataSource();t&&y.DataSourceManager.getInstance().createDataView(t,this.dataViewId)}this.getAssociatedDataSource()&&((0,y.observeStore)(this.onInfoChange.bind(this),["dataSourcesInfo",this.getAssociatedDataSource().id]),this.getAssociatedDataSource().setAssociatedDataSource(this)),(null===(a=this.layer)||void 0===a?void 0:a.portalItem)&&this.setItemInfo(this.layer.portalItem.sourceJSON)}ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return de(this,void 0,void 0,(function*(){yield Promise.all([this.fetchLayerDefinition(),this.createAssociatedDataSource()]).then((()=>this.getAssociatedDataSource()?e.ready.call(this):Promise.reject("Need associated feature layer."))).then((()=>{var e,t;this.getAssociatedDataSource()&&(0,y.observeStore)(this.onInfoChange.bind(this),["dataSourcesInfo",this.getAssociatedDataSource().id]),(null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.layer)&&(null===(t=this.layer)||void 0===t?void 0:t.popupTemplate)&&(this.getAssociatedDataSource().layer.popupTemplate=this.layer.popupTemplate)}))}))}onInfoChange(){this.getAssociatedDataSource()&&!y.utils.isDeepEqual(this.getInfo().without("instanceStatus"),this.getAssociatedDataSource().getInfo().without("instanceStatus"))&&(0,y.getAppStore)().dispatch(y.appActions.updateDataSourceInfo(this.id,this.getAssociatedDataSource().getInfo().without("instanceStatus").set("instanceStatus",this.getInfo().instanceStatus)))}createAssociatedDataSource(){return de(this,void 0,void 0,(function*(){return this.getAssociatedDataSource()?yield Promise.resolve(this.getAssociatedDataSource()):this.layer?yield this._createAssociatedDataSourceWithLayer().then((e=>e||this._createAssociatedDataSourceWithUrl())):this._createAssociatedDataSourceWithUrl()}))}_createAssociatedDataSourceWithLayer(){return de(this,void 0,void 0,(function*(){const e=this._getNewAssociatedDataSourceId();return yield this.layer.load().then((()=>de(this,void 0,void 0,(function*(){const i=this.layer.associatedLayer;if(!i)return null;this.layer.definitionExpression&&(i.definitionExpression=this.layer.definitionExpression);let r=(0,y.Immutable)({id:e,type:t.FeatureLayer,url:y.dataSourceUtils.getUrlByLayer(i)});r=this._mergeAssociatedDataSourceJson(r);const a={id:e,dataSourceJson:r,layer:i,associatedDataSource:this};return yield this.dataSourceManager.createDataSource(a)})))).then((e=>(this.associatedDataSource=e,this.associatedDataSource)))}))}_createAssociatedDataSourceWithUrl(){return de(this,void 0,void 0,(function*(){const e=this._getNewAssociatedDataSourceId();return yield y.dataSourceUtils.fetchAssociatedFeatureLayerDefinition(this.url,this.layerId,this.itemId,this.portalUrl).then((t=>{if(!t)return Promise.reject("Can not find associated feature layer");let i=T(e,t.def,t.url);return i=this._mergeAssociatedDataSourceJson(i),i})).then((e=>de(this,void 0,void 0,(function*(){const t={id:e.id,dataSourceJson:e,associatedDataSource:this};return yield this.dataSourceManager.createDataSource(t)})))).then((e=>(this.associatedDataSource=e,this.associatedDataSource)))}))}_getNewAssociatedDataSourceId(){return`${this.getDataSourceJson().id}-associated_data_source`}getTimezone(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getTimezone()}fetchLayerDefinition(){var e;return de(this,void 0,void 0,(function*(){try{const t=this.url;if(this.layer)yield this.layer.load(),this.layerDefinition={id:this.layer.layerId,fields:null===(e=this.layer.fields)||void 0===e?void 0:e.map((e=>null==e?void 0:e.toJSON()))};else if(this.url){const e=yield y.ServiceManager.getInstance().fetchServiceInfo(t).then((e=>e.definition)).then((e=>e||null));this.layerDefinition=e}return Promise.resolve(this.layerDefinition)}catch(e){return Promise.resolve(null)}}))}getLayerDefinition(){return y.dataSourceUtils.getLayerDefinition(this)}setLayerDefinition(e){this.layerDefinition=e}getPopupInfo(){return y.dataSourceUtils.getPopupInfo(this)}setPopupInfo(e){this.popupInfo=e}getCapabilities(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getCapabilities()}get layer(){return y.dataSourceUtils.getJSAPILayer(this)}set layer(e){this._layer=e}getItemInfo(){return this.isDataView||this.isLocal?this.getMainDataSource().getItemInfo():super.getItemInfo()}fetchSchema(){return de(this,void 0,void 0,(function*(){const e=yield y.dataSourceUtils.getOriginDataLabel(this),t=(0,y.Immutable)({label:e}),i=yield this.getAssociatedDataSource()?this.getAssociatedDataSource().fetchSchema():Promise.resolve(null);return i?i.merge(t):t}))}setDataSourceJson(e){if(super.setDataSourceJson(e),this.getAssociatedDataSource()){const e=this._mergeAssociatedDataSourceJson(this.getAssociatedDataSource().getDataSourceJson());this.getAssociatedDataSource().setDataSourceJson(e)}}getFetchedSchema(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getFetchedSchema()}setFetchedSchema(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setFetchedSchema(e)}getReversedConfigSchema(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getReversedConfigSchema()}getSelectedFields(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSelectedFields()}setSelectedFields(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setSelectedFields(e)}getIdField(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getIdField()}queryById(e){var t,i;return de(this,void 0,void 0,(function*(){return yield null!==(i=null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.queryById(e))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}addRecord(e){var t;return de(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.addRecord(e)}))}updateRecord(e){var t;return de(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.updateRecord(e)}))}updateRecords(e){var t;return de(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.updateRecords(e)}))}deleteRecord(e){var t;return de(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.deleteRecord(e)}))}deleteRecordById(e){var t;return de(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.deleteRecordById(e)}))}doQuery(e,t){return this.getAssociatedDataSource()?this.getAssociatedDataSource().doQuery(e,t).then((e=>(e.records=e.records.map((e=>this.fixRecordDataSource(e))),e))):Promise.reject(Error("No Associated DataSource."))}doQueryById(e){return this.getAssociatedDataSource()?this.getAssociatedDataSource().doQueryById(e).then((e=>this.fixRecordDataSource(e))):Promise.reject(Error("No Associated DataSource."))}doQueryIds(e){return this.getAssociatedDataSource()?this.getAssociatedDataSource().doQueryIds(e).then((e=>(e.records&&(e.records=e.records.map((e=>this.fixRecordDataSource(e)))),e))):Promise.reject(Error("No Associated DataSource."))}doQueryCount(e){var t,i;return de(this,void 0,void 0,(function*(){return yield null!==(i=null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.doQueryCount(e))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}getConfigQueryParams(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getConfigQueryParams()}getRemoteQueryParams(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getRemoteQueryParams()}getCurrentQueryParams(e){var t;return(null==e?void 0:e.exclude)&&this.fixExcludeQuery(e.exclude),null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getCurrentQueryParams(e)}getRuntimeQueryParamsgetRuntimeQueryParams(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRuntimeQueryParams(e)}getCurrentQueryId(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getCurrentQueryId()}mergeQueryParams(...e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.mergeQueryParams(...e)}buildRecord(e){return new K(e,this)}getFieldCodedValueList(e,t){var i;return null===(i=this.getAssociatedDataSource())||void 0===i?void 0:i.getFieldCodedValueList(e,t)}getRealQueryParams(e,t,i){var r;return i&&this.fixQueryOptions(i),null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.getRealQueryParams(e,t,i)}getAllUsedFields(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getAllUsedFields(e)}applyUsedFields(e,t){var i;return null===(i=this.getAssociatedDataSource())||void 0===i?void 0:i.applyUsedFields(e,t)}updateQueryParams(e,t){var i;null===(i=this.getAssociatedDataSource())||void 0===i||i.updateQueryParams(e,t)}getGDBVersion(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getGDBVersion()}getQueryPageSize(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getQueryPageSize()}getMaxRecordCount(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getMaxRecordCount()}getRecordsByPage(e,t){var i,r;return null===(r=null===(i=this.getAssociatedDataSource())||void 0===i?void 0:i.getRecordsByPage(e,t))||void 0===r?void 0:r.map((e=>this.fixRecordDataSource(e)))}getPagesData(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getPagesData()}setPagesData(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setPagesData(e)}getRealQueryPages(e,t){var i;return null===(i=this.getAssociatedDataSource())||void 0===i?void 0:i.getRealQueryPages(e,t)}load(e,t={}){var i,r;return de(this,void 0,void 0,(function*(){return t&&this.fixQueryOptions(t),null!==(r=yield null===(i=this.getAssociatedDataSource())||void 0===i?void 0:i.load(e,t))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}))}loadCount(e,t={}){var i,r;return de(this,void 0,void 0,(function*(){return t&&this.fixQueryOptions(t),null!==(r=yield null===(i=this.getAssociatedDataSource())||void 0===i?void 0:i.loadCount(e,t))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}))}query(e,t){var i,r;return de(this,void 0,void 0,(function*(){return t&&this.fixQueryOptions(t),null!==(r=yield null===(i=this.getAssociatedDataSource())||void 0===i?void 0:i.query(e,t))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}))}queryCount(e,t){var i,r;return de(this,void 0,void 0,(function*(){return t&&this.fixQueryOptions(t),null!==(r=yield null===(i=this.getAssociatedDataSource())||void 0===i?void 0:i.queryCount(e,t))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}))}loadById(e,t){var i,r;return de(this,void 0,void 0,(function*(){return null!==(r=yield null===(i=this.getAssociatedDataSource())||void 0===i?void 0:i.loadById(e,t))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}))}changeGDBVersion(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.changeGDBVersion(e)}getAssociatedDataSource(){if(!this.isDataView&&!this.isLocal)return this.associatedDataSource;const e=this._getRealAssociatedDataSourceId();return y.DataSourceManager.getInstance().getDataSource(e)}getAssociatedDataSourceById(e){return this.dataSourceManager.getDataSource(e).getAssociatedDataSource()}fixQueryOptions(e){e&&e.excludeQuery&&this.fixExcludeQuery(e.excludeQuery)}fixExcludeQuery(e){(null==e?void 0:e.dataSourceId)&&this.getAssociatedDataSourceById(e.dataSourceId)&&(e.dataSourceId=this.getAssociatedDataSourceById(e.dataSourceId).id)}_getRealAssociatedDataSourceId(){var e;let t;const i=null===(e=this.belongToDataSource)||void 0===e?void 0:e.getAssociatedDataSource();return t=this.isLocal?y.DataSourceManager.getInstance().getLocalDataSourceId(null==i?void 0:i.id,this.localId):this.isDataView?y.DataSourceManager.getInstance().getDataViewDataSourceId(null==i?void 0:i.id,this.dataViewId):this.associatedDataSource.id,t}clearRecords(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.clearRecords()}setRecords(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setRecords(e)}getRecords(){var e,t;return null===(t=null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getRecords())||void 0===t?void 0:t.map((e=>this.fixRecordDataSource(e)))}setSourceRecords(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setSourceRecords(e)}getSourceRecords(){var e,t;return null===(t=null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSourceRecords())||void 0===t?void 0:t.map((e=>this.fixRecordDataSource(e)))}fixRecordDataSource(e,t=this){if(!e)return null;const i=e.clone();return i.dataSource=t,i}getSelectedRecords(){var e,t;return null===(t=null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSelectedRecords())||void 0===t?void 0:t.map((e=>this.fixRecordDataSource(e,this.getSelectionDataView())))}nextRecord(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.nextRecord()}prevRecord(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.prevRecord()}getRecord(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRecord(e)}getRecordById(e){var t;return this.fixRecordDataSource(null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRecordById(e))}clearRecordsNotAddVersion(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.clearRecordsNotAddVersion()}clearSelection(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.clearSelection()}addVersion(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.addVersion()}selectRecord(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.selectRecord(e)}selectRecords(e,t,i){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.selectRecords(e)}selectRecordById(e,t){var i;null===(i=this.getAssociatedDataSource())||void 0===i||i.selectRecordById(e,t)}selectRecordsByIds(e,t){var i;null===(i=this.getAssociatedDataSource())||void 0===i||i.selectRecordsByIds(e,t)}destroy(){const e=this.getAssociatedDataSource();e&&this.dataSourceManager.destroyDataSource(e.id)}supportSymbol(){return y.dataSourceUtils.supportSymbol(this)}supportAttachment(){return y.dataSourceUtils.supportAttachment(this)}createJSAPILayerByDataSource(){return de(this,void 0,void 0,(function*(){return yield y.dataSourceUtils.createJSAPILayerByDataSource(this)}))}getDataViews(){return super.getDataViews()}getDataView(e){return super.getDataView(e)}getMainDataSource(){return super.getMainDataSource()}_mergeAssociatedDataSourceJson(e){return null==e?void 0:e.set("query",this.getDataSourceJson().query).set("dataViews",this.getDataSourceJson().dataViews).set("schema",this.getDataSourceJson().schema)}get count(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.count}set count(e){this.getAssociatedDataSource()&&(this.getAssociatedDataSource().count=e)}allowToExportData(){return de(this,void 0,void 0,(function*(){const e=!this.getDataSourceJson().disableExport;return yield Promise.resolve(e)}))}}class ce extends(R(b(D))){constructor(e){super(e),this.type=t.ImageService,e.layer&&(this.layer=e.layer);const i=this.getDataSourceJson();this.portalUrl=i.portalUrl,this.itemId=i.itemId}ready(){return e=this,t=void 0,r=function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()},new((i=void 0)||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}));var e,t,i,r}}class he extends(R(b(D))){constructor(e){super(e),this.type=t.VectorTileService,e.layer&&(this.layer=e.layer);const i=this.getDataSourceJson();this.portalUrl=i.portalUrl,this.itemId=i.itemId}ready(){return e=this,t=void 0,r=function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()},new((i=void 0)||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}));var e,t,i,r}}class Se extends(R(b(D))){constructor(e){super(e),this.type=t.GeoJSON,e.layer&&(this.layer=e.layer);const i=this.getDataSourceJson();this.portalUrl=i.portalUrl,this.itemId=i.itemId,this.url&&y.requestUtils.registerCacheableUrl(this.url)}ready(){return e=this,t=void 0,r=function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()},new((i=void 0)||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}));var e,t,i,r}}class ge extends(R(b(D))){constructor(e){super(e),this.type=t.KML,e.layer&&(this.layer=e.layer);const i=this.getDataSourceJson();this.portalUrl=i.portalUrl,this.itemId=i.itemId,(this.url||this.portalUrl&&this.itemId)&&y.requestUtils.registerCacheableUrl(((e,t)=>{if("https://utility.arcgis.com/sharing/kml"!==e)return!1;const i=null==t?void 0:t.url;return i.includes(this.url)||i.includes(`${this.portalUrl}/sharing/rest/content/items/${this.itemId}`)}))}ready(){return e=this,t=void 0,r=function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()},new((i=void 0)||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}));var e,t,i,r}}class ye extends(R(b(D))){constructor(e){super(e),this.type=t.WFS,e.layer&&(this.layer=e.layer);const i=this.getDataSourceJson();this.portalUrl=i.portalUrl,this.itemId=i.itemId}ready(){return e=this,t=void 0,r=function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()},new((i=void 0)||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}));var e,t,i,r}}class ve extends(R(b(D))){constructor(e){super(e),this.type=t.WMS,e.layer&&(this.layer=e.layer);const i=this.getDataSourceJson();this.portalUrl=i.portalUrl,this.itemId=i.itemId}ready(){return e=this,t=void 0,r=function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()},new((i=void 0)||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}));var e,t,i,r}}class fe extends(R(b(D))){constructor(e){super(e),this.type=t.WMTS,e.layer&&(this.layer=e.layer);const i=this.getDataSourceJson();this.portalUrl=i.portalUrl,this.itemId=i.itemId}ready(){return e=this,t=void 0,r=function*(){return this.layer||(this.layer=yield this.createJSAPILayerByDataSource()),yield this.layer.load(),Promise.resolve()},new((i=void 0)||(i=Promise))((function(a,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function n(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}l((r=r.apply(e,t||[])).next())}));var e,t,i,r}}class pe extends D{constructor(){super(...arguments),this.type=t.Error}}class me{createDataSource(e){var i;const r=null!==(i=e.dataSourceJson)&&void 0!==i?i:e.belongToDataSource.getMainDataSource().getDataSourceJson(),a=e.dataViewId&&r.dataViews&&r.dataViews[e.dataViewId]&&r.dataViews[e.dataViewId].type||r.type;switch(a){case t.Error:return new pe(e);case t.CSV:return new Z(e);case t.FeatureLayer:return new ie(e);case t.FeatureService:return new re(e);case t.GroupLayer:return new ae(e);case t.MapService:return new se(e);case t.SceneService:return new le(e);case t.ImageService:return new ce(e);case t.VectorTileService:return new he(e);case t.GeoJSON:return new Se(e);case t.KML:return new ge(e);case t.WFS:return new ye(e);case t.WMS:return new ve(e);case t.WMTS:return new fe(e);case t.SceneLayer:return new ue(e);case t.SimpleLocal:return new ne(e);default:throw new Error(`Unhandled case: ${a}`)}}}const De=me})(),a})())}}}));