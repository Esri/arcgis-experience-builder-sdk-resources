/*! For license information please see auth.umd.min.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@esri/arcgis-rest-request")):"function"==typeof define&&define.amd?define(["exports","@esri/arcgis-rest-request"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).arcgisRest=e.arcgisRest||{},e.arcgisRest)}(this,(function(e,t){"use strict";var r=function(){return(r=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)};function n(e,r){return r.rawResponse=!1,t.request(e,r).then((function(e){var t={token:e.access_token,username:e.username,expires:new Date(Date.now()+(1e3*e.expires_in-1e3)),ssl:!0===e.ssl};return e.refresh_token&&(t.refreshToken=e.refresh_token),t}))}var s=(o.prototype.getToken=function(e,t){return this.token&&this.expires&&this.expires.getTime()>Date.now()?Promise.resolve(this.token):this._pendingTokenRequest||(this._pendingTokenRequest=this.refreshToken(t),this._pendingTokenRequest)},o.prototype.refreshToken=function(e){var t=this;return e=r({params:{client_id:this.clientId,client_secret:this.clientSecret,grant_type:"client_credentials",expiration:this.duration}},e),n(this.portal+"/oauth2/token/",e).then((function(e){return t._pendingTokenRequest=null,t.token=e.token,t.expires=e.expires,e.token}))},o.prototype.refreshSession=function(){var e=this;return this.refreshToken().then((function(){return e}))},o);function o(e){this.clientId=e.clientId,this.clientSecret=e.clientSecret,this.token=e.token,this.expires=e.expires,this.portal=e.portal||"https://www.arcgis.com/sharing/rest",this.duration=e.duration||7200}var i=(a.prototype.getToken=function(e){return Promise.resolve(this.key)},a);function a(e){this.key=e.key}function h(e,r){return"undefined"!=typeof window&&window.location&&window.location.host?r.params.referer=window.location.host:r.params.referer=t.NODEJS_DEFAULT_REFERER_HEADER,t.request(e,r)}var u=/^https?:\/\/(\S+)\.arcgis\.com.+/;function p(e){return u.test(e)}function c(e){return u.test(e)?(e=e.match(u)[1].split(".").pop()).includes("dev")?"dev":e.includes("qa")?"qa":"production":null}function l(e,r,n){return void 0===n&&(n="https://www.arcgis.com/sharing/rest"),n+="/oauth2/validateAppAccess",e={method:"POST",params:{f:"json",client_id:r,token:e}},t.request(n,e)}var d=(Object.defineProperty(f.prototype,"token",{get:function(){return this._token},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"tokenExpires",{get:function(){return this._tokenExpires},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"refreshToken",{get:function(){return this._refreshToken},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"refreshTokenExpires",{get:function(){return this._refreshTokenExpires},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"trustedServers",{get:function(){return console.log("DEPRECATED: use federatedServers instead"),this.federatedServers},enumerable:!1,configurable:!0}),f.beginOAuth2=function(e,n){void 0===n&&(n=window),e.duration&&console.log("DEPRECATED: 'duration' is deprecated - use 'expiration' instead");var s=(d=r({portal:"https://www.arcgis.com/sharing/rest",provider:"arcgis",expiration:20160,popup:!0,popupWindowFeatures:"height=400,width=600,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes",state:e.clientId,locale:""},e)).portal,o=d.provider,i=d.clientId,a=d.expiration,h=d.redirectUri,u=d.popup,p=d.popupWindowFeatures,c=d.state,l=d.locale,d=d.params;if(l="arcgis"===o?s+"/oauth2/authorize?client_id="+i+"&response_type=token&expiration="+(e.duration||a)+"&redirect_uri="+encodeURIComponent(h)+"&state="+c+"&locale="+l:s+"/oauth2/social/authorize?client_id="+i+"&socialLoginProviderName="+o+"&autoAccountCreateForSocial=true&response_type=token&expiration="+(e.duration||a)+"&redirect_uri="+encodeURIComponent(h)+"&state="+c+"&locale="+l,d&&(l=l+"&"+t.encodeQueryString(d)),u){var k,g=((k={promise:null,resolve:null,reject:null}).promise=new Promise((function(e,t){k.resolve=e,k.reject=t})),k);return n["__ESRI_REST_AUTH_HANDLER_"+i]=function(e,r){e?(e=JSON.parse(e),g.reject(new t.ArcGISAuthError(e.errorMessage,e.error))):r&&(r=JSON.parse(r),g.resolve(new f({clientId:i,portal:s,ssl:r.ssl,token:r.token,tokenExpires:new Date(r.expires),username:r.username})))},n.open(l,"oauth-window",p),g.promise}n.location.href=l},f.completeOAuth2=function(e,n){void 0===n&&(n=window);var s=r({portal:"https://www.arcgis.com/sharing/rest",popup:!0},e),o=s.portal,i=s.clientId,a=s.popup;function h(e,r){try{var s=void 0,h="__ESRI_REST_AUTH_HANDLER_"+i;if(a&&(n.opener?n.opener.parent&&n.opener.parent[h]?s=n.opener.parent[h]:n.opener&&n.opener[h]&&(s=n.opener[h]):n!==n.parent&&n.parent&&n.parent[h]&&(s=n.parent[h]),s))return s(e?JSON.stringify(e):void 0,JSON.stringify(r)),void n.close()}catch(e){throw new t.ArcGISAuthError('Unable to complete authentication. It\'s possible you specified popup based oAuth2 but no handler from "beginOAuth2()" present. This generally happens because the "popup" option differs between "beginOAuth2()" and "completeOAuth2()".')}if(e)throw new t.ArcGISAuthError(e.errorMessage,e.error);return new f({clientId:i,portal:o,ssl:r.ssl,token:r.token,tokenExpires:r.expires,username:r.username})}if(!(e=t.decodeQueryString(n.location.hash)).access_token){var u=void 0,p="Unknown error";return e.error&&(u=e.error,p=e.error_description),h({error:u,errorMessage:p})}return s=e.access_token,u=new Date(Date.now()+1e3*parseInt(e.expires_in,10)-6e4),p=e.username,h(void 0,{token:s,expires:u,ssl:"true"===e.ssl,username:p})},f.fromParent=function(e,t){var r;return!t&&window&&(t=window),new Promise((function(n,s){r=function(e){if(e.source===t.parent&&e.data)try{return n(f.parentMessageHandler(e))}catch(e){return s(e)}},t.addEventListener("message",r,!1),t.parent.postMessage({type:"arcgis:auth:requestCredential"},e)})).then((function(e){return t.removeEventListener("message",r,!1),e}))},f.authorize=function(e,t){e.duration&&console.log("DEPRECATED: 'duration' is deprecated - use 'expiration' instead");var n=(i=r({portal:"https://arcgis.com/sharing/rest",expiration:20160},e)).portal,s=i.clientId,o=i.expiration,i=i.redirectUri;t.writeHead(301,{Location:n+"/oauth2/authorize?client_id="+s+"&expiration="+(e.duration||o)+"&response_type=code&redirect_uri="+encodeURIComponent(i)}),t.end()},f.exchangeAuthorizationCode=function(e,t){var s=(e=r({portal:"https://www.arcgis.com/sharing/rest",refreshTokenTTL:20160},e)).portal,o=e.clientId,i=e.redirectUri,a=e.refreshTokenTTL;return n(s+"/oauth2/token",{params:{grant_type:"authorization_code",client_id:o,redirect_uri:i,code:t}}).then((function(e){return new f({clientId:o,portal:s,ssl:e.ssl,redirectUri:i,refreshToken:e.refreshToken,refreshTokenTTL:a,refreshTokenExpires:new Date(Date.now()+60*(a-1)*1e3),token:e.token,tokenExpires:e.expires,username:e.username})}))},f.deserialize=function(e){return new f({clientId:(e=JSON.parse(e)).clientId,refreshToken:e.refreshToken,refreshTokenExpires:new Date(e.refreshTokenExpires),username:e.username,password:e.password,token:e.token,tokenExpires:new Date(e.tokenExpires),portal:e.portal,ssl:e.ssl,tokenDuration:e.tokenDuration,redirectUri:e.redirectUri,refreshTokenTTL:e.refreshTokenTTL})},f.fromCredential=function(e){var t=void 0===e.ssl||e.ssl,r=e.expires||Date.now()+72e5;return new f({portal:e.server.includes("sharing/rest")?e.server:e.server+"/sharing/rest",ssl:t,token:e.token,username:e.userId,tokenExpires:new Date(r)})},f.parentMessageHandler=function(e){if("arcgis:auth:credential"===e.data.type)return f.fromCredential(e.data.credential);if("arcgis:auth:error"!==e.data.type)throw new Error("Unknown message type.");var t=new Error(e.data.error.message);throw t.name=e.data.error.name,t},f.prototype.toCredential=function(){return{expires:this.tokenExpires.getTime(),server:this.portal,ssl:this.ssl,token:this.token,userId:this.username}},f.prototype.getUser=function(e){var n=this;if(this._pendingUserRequest)return this._pendingUserRequest;if(this._user)return Promise.resolve(this._user);var s=this.portal+"/community/self";return e=r(r({httpMethod:"GET",authentication:this},e),{rawResponse:!1}),this._pendingUserRequest=t.request(s,e).then((function(e){return n._user=e,n._pendingUserRequest=null,e})),this._pendingUserRequest},f.prototype.getPortal=function(e){var n=this;if(this._pendingPortalRequest)return this._pendingPortalRequest;if(this._portalInfo)return Promise.resolve(this._portalInfo);var s=this.portal+"/portals/self";return e=r(r({httpMethod:"GET",authentication:this},e),{rawResponse:!1}),this._pendingPortalRequest=t.request(s,e).then((function(e){return n._portalInfo=e,n._pendingPortalRequest=null,e})),this._pendingPortalRequest},f.prototype.getUsername=function(){return this.username?Promise.resolve(this.username):this._user?Promise.resolve(this._user.username):this.getUser().then((function(e){return e.username}))},f.prototype.getToken=function(e,t){return n=e,s=p(r=this.portal),o=p(n),r=c(r),n=c(n),s&&o&&r===n||new RegExp(this.portal,"i").test(e)?this.getFreshToken(t):this.getTokenForServer(e,t);var r,n,s,o},f.prototype.validateAppAccess=function(e){return this.getToken(this.portal).then((function(t){return l(t,e)}))},f.prototype.toJSON=function(){return{clientId:this.clientId,refreshToken:this.refreshToken,refreshTokenExpires:this.refreshTokenExpires,username:this.username,password:this.password,token:this.token,tokenExpires:this.tokenExpires,portal:this.portal,ssl:this.ssl,tokenDuration:this.tokenDuration,redirectUri:this.redirectUri,refreshTokenTTL:this.refreshTokenTTL}},f.prototype.serialize=function(){return JSON.stringify(this)},f.prototype.enablePostMessageAuth=function(e,t){!t&&window&&(t=window),this._hostHandler=this.createPostMessageHandler(e),t.addEventListener("message",this._hostHandler,!1)},f.prototype.disablePostMessageAuth=function(e){!e&&window&&(e=window),e.removeEventListener("message",this._hostHandler,!1)},f.prototype.refreshSession=function(e){return this._user=null,this.username&&this.password?this.refreshWithUsernameAndPassword(e):this.clientId&&this.refreshToken?this.refreshWithRefreshToken():Promise.reject(new t.ArcGISAuthError("Unable to refresh token."))},f.prototype.getServerRootUrl=function(e){var r=((n=t.cleanUrl(e).split(/\/rest(\/admin)?\/services(?:\/|#|\?|$)/)[0].match(/(https?:\/\/)(.+)/))[0],n[1]),n=(e=n[2].split("/"))[0];return e=e.slice(1),""+r+n.toLowerCase()+"/"+e.join("/")},f.prototype.getDomainCredentials=function(e){return this.trustedDomains&&this.trustedDomains.length&&this.trustedDomains.some((function(t){return e.startsWith(t)}))?"include":"same-origin"},f.prototype.createPostMessageHandler=function(e){var t=this;return function(r){var n=-1<e.indexOf(r.origin),s="arcgis:auth:requestCredential"===r.data.type,o=t.tokenExpires.getTime()>Date.now();n&&s&&(s={},s=o?((o=t.toCredential()).server=o.server.replace("/sharing/rest",""),{type:"arcgis:auth:credential",credential:o}):{type:"arcgis:auth:error",error:{name:"tokenExpiredError",message:"Session token was expired, and not returned to the child application"}},r.source.postMessage(s,r.origin))}},f.prototype.getTokenForServer=function(e,r){var n=this,s=this.getServerRootUrl(e),o=this.federatedServers[s];return o&&o.expires&&o.expires.getTime()>Date.now()?Promise.resolve(o.token):this._pendingTokenRequests[s]||(this._pendingTokenRequests[s]=this.fetchAuthorizedDomains().then((function(){return t.request(s+"/rest/info",{credentials:n.getDomainCredentials(e)}).then((function(o){if(o.owningSystemUrl){if(function(e,r){return r=t.cleanUrl(function(e){if(!u.test(e))return e;switch(c(e)){case"dev":return"https://devext.arcgis.com/sharing/rest";case"qa":return"https://qaext.arcgis.com/sharing/rest";default:return"https://www.arcgis.com/sharing/rest"}}(r)).replace(/https?:\/\//,""),e=t.cleanUrl(e).replace(/https?:\/\//,""),new RegExp(e,"i").test(r)}(o.owningSystemUrl,n.portal))return t.request(o.owningSystemUrl+"/sharing/rest/info",r);throw new t.ArcGISAuthError(e+" is not federated with "+n.portal+".","NOT_FEDERATED")}if(o.authInfo&&void 0!==n.federatedServers[s])return Promise.resolve({authInfo:o.authInfo});throw new t.ArcGISAuthError(e+" is not federated with any portal and is not explicitly trusted.","NOT_FEDERATED")})).then((function(e){return e.authInfo.tokenServicesUrl})).then((function(t){return n.token&&n.tokenExpires.getTime()>Date.now()?h(t,{params:{token:n.token,serverUrl:e,expiration:n.tokenDuration,client:"referer"}}):h(t,{params:{username:n.username,password:n.password,expiration:n.tokenDuration,client:"referer"}}).then((function(e){return n._token=e.token,n._tokenExpires=new Date(e.expires),e}))})).then((function(e){return n.federatedServers[s]={expires:new Date(e.expires),token:e.token},delete n._pendingTokenRequests[s],e.token}))})),this._pendingTokenRequests[s])},f.prototype.getFreshToken=function(e){var t=this;return this.token&&!this.tokenExpires||this.token&&this.tokenExpires&&this.tokenExpires.getTime()>Date.now()?Promise.resolve(this.token):(this._pendingTokenRequests[this.portal]||(this._pendingTokenRequests[this.portal]=this.refreshSession(e).then((function(e){return t._pendingTokenRequests[t.portal]=null,e.token}))),this._pendingTokenRequests[this.portal])},f.prototype.refreshWithUsernameAndPassword=function(e){var t=this;return e=r({params:{username:this.username,password:this.password,expiration:this.tokenDuration}},e),h(this.portal+"/generateToken",e).then((function(e){return t._token=e.token,t._tokenExpires=new Date(e.expires),t}))},f.prototype.refreshWithRefreshToken=function(e){var t=this;return this.refreshToken&&this.refreshTokenExpires&&this.refreshTokenExpires.getTime()<Date.now()?this.refreshRefreshToken(e):(e=r({params:{client_id:this.clientId,refresh_token:this.refreshToken,grant_type:"refresh_token"}},e),n(this.portal+"/oauth2/token",e).then((function(e){return t._token=e.token,t._tokenExpires=e.expires,t})))},f.prototype.refreshRefreshToken=function(e){var t=this;return e=r({params:{client_id:this.clientId,refresh_token:this.refreshToken,redirect_uri:this.redirectUri,grant_type:"exchange_refresh_token"}},e),n(this.portal+"/oauth2/token",e).then((function(e){return t._token=e.token,t._tokenExpires=e.expires,t._refreshToken=e.refreshToken,t._refreshTokenExpires=new Date(Date.now()+60*(t.refreshTokenTTL-1)*1e3),t}))},f.prototype.fetchAuthorizedDomains=function(){var e=this;return this.server||!this.portal?Promise.resolve(this):this.getPortal().then((function(t){return t.authorizedCrossOriginDomains&&t.authorizedCrossOriginDomains.length&&(e.trustedDomains=t.authorizedCrossOriginDomains.filter((function(e){return!e.startsWith("http://")})).map((function(e){return e.startsWith("https://")?e:"https://"+e}))),e}))},f);function f(e){var r;this.clientId=e.clientId,this._refreshToken=e.refreshToken,this._refreshTokenExpires=e.refreshTokenExpires,this.username=e.username,this.password=e.password,this._token=e.token,this._tokenExpires=e.tokenExpires,this.portal=e.portal?t.cleanUrl(e.portal):"https://www.arcgis.com/sharing/rest",this.ssl=e.ssl,this.provider=e.provider||"arcgis",this.tokenDuration=e.tokenDuration||20160,this.redirectUri=e.redirectUri,this.refreshTokenTTL=e.refreshTokenTTL||20160,this.server=e.server,this.federatedServers={},this.trustedDomains=[],e.server&&(r=this.getServerRootUrl(e.server),this.federatedServers[r]={token:e.token,expires:e.tokenExpires}),this._pendingTokenRequests={}}e.ApiKey=i,e.ApplicationSession=s,e.UserSession=d,e.exchangeToken=function(e,r,n){return void 0===n&&(n="https://www.arcgis.com/sharing/rest"),n+="/oauth2/exchangeToken",e={method:"POST",params:{f:"json",client_id:r,token:e}},t.request(n,e).then((function(e){return e.token}))},e.fetchToken=n,e.generateToken=h,e.platformSelf=function(e,r,n){return void 0===n&&(n="https://www.arcgis.com/sharing/rest"),n+="/oauth2/platformSelf?f=json",r={method:"POST",headers:{"X-Esri-Auth-Client-Id":e,"X-Esri-Auth-Redirect-Uri":r},params:{f:"json"}},t.request(n,r)},e.validateAppAccess=l,Object.defineProperty(e,"__esModule",{value:!0})}));