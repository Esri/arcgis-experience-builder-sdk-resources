System.register(["jimu-core","jimu-for-builder/templates"],(function(e,t){var n={},i={};return{setters:[function(e){n.CONSTANTS=e.CONSTANTS,n.ExtensionManager=e.ExtensionManager,n.Immutable=e.Immutable,n.SessionManager=e.SessionManager,n.USER_SETTING_FILE_KEY=e.USER_SETTING_FILE_KEY,n.appActions=e.appActions,n.appConfigUtils=e.appConfigUtils,n.esri=e.esri,n.extensionSpec=e.extensionSpec,n.getAppStore=e.getAppStore,n.i18n=e.i18n,n.moduleLoader=e.moduleLoader,n.portalUrlUtils=e.portalUrlUtils,n.semver=e.semver,n.sharedThemeUtils=e.sharedThemeUtils,n.urlUtils=e.urlUtils,n.utils=e.utils,n.version=e.version},function(e){i.TemplateType=e.TemplateType,i.getTemplateConfig=e.getTemplateConfig}],execute:function(){e((()=>{"use strict";var e={9244:e=>{e.exports=n},6884:e=>{e.exports=i}},t={};function o(n){var i=t[n];if(void 0!==i)return i.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,o),r.exports}o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};o.r(r),o.d(r,{AppType:()=>d,PublishStatus:()=>l,SearchType:()=>c,appServices:()=>u,createAppCallBack:()=>Me,getNewTypeKeywordsWhenSaveApp:()=>Fe,getPublishStatus:()=>_e,getResourceOrigin:()=>re,initAppConfigOfNewApp:()=>Ne,toCreateAppByDefaultTemplate:()=>Ue,userServices:()=>a});var s={};o.r(s),o.d(s,{addItemResource:()=>B,checkItemVersion:()=>E,createItem:()=>C,getItem:()=>U,getItemData:()=>k,getItemResource:()=>$,getItemResources:()=>M,getOriginUrl:()=>S,getRequestMethod:()=>A,getUserContentUrl:()=>P,getUserName:()=>x,importItem:()=>I,removeItem:()=>R,removeItemResource:()=>L,request:()=>w,searchItems:()=>h,searchItemsByPortalUrl:()=>g,updateItem:()=>_,updateItemResource:()=>W});var u={};o.r(u),o.d(u,{addToFavorites:()=>Dt,changeAppFolder:()=>Rt,checkImportAppVersion:()=>vt,createAppByDefaultTemplate:()=>ct,createAppByItemTemplateId:()=>at,createAppByItemTemplateInfo:()=>ut,createTemplateByApp:()=>dt,deleteApp:()=>Lt,duplicateApp:()=>pt,getAppGroups:()=>kt,getAppInfo:()=>Ot,getDefaultTemplateConfig:()=>bt,getDraftAppConfig:()=>St,getFolders:()=>Ct,getGroupCategorySchema:()=>At,getGroupContent:()=>jt,getOrgCategorySchema:()=>Tt,getPublishedAppConfig:()=>wt,getUserTags:()=>It,importAppFromPortal:()=>gt,importAppFromZip:()=>ht,publishApp:()=>Ft,removeFromFavorites:()=>Gt,replaceExbVersionInAppConfig:()=>Be,saveApp:()=>mt,saveAsApp:()=>yt,searchApp:()=>Pt,searchAppByPortalUrl:()=>xt,searchGroups:()=>Et,transferAppToFullMode:()=>ft,updateAppInfo:()=>Ut,updateAppInfoWhenSaveApp:()=>Mt,updateAppThumbnail:()=>$t});var a={};o.r(a),o.d(a,{addUserResource:()=>Vt,getUserResource:()=>Yt,getUserResources:()=>zt,initUserResource:()=>Qt,removeUserResource:()=>Jt,updateUserResource:()=>Ht});var c,d,l,p=o(9244);!function(e){e.AGOL="AGOL",e.Portal="Portal",e.Other="Other"}(c||(c={})),function(e){e.TemplateType="Web Experience Template",e.ExperienceType="Web Experience"}(d||(d={})),function(e){e.Published="Published",e.Draft="Draft",e.Changed="Changed"}(l||(l={}));var f=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};function h(e){return f(this,arguments,void 0,(function*(e,t=c.Other){return yield v(e,"item",t)}))}function v(e,t){return f(this,arguments,void 0,(function*(e,t,n=c.Other){let i,o;return i=`${n===c.AGOL?"https://www.arcgis.com/":`${window.location.origin}${window.jimuConfig.mountPath}`}sharing/rest/search`,o="string"==typeof e||e instanceof p.esri.restPortal.SearchQueryBuilder?{params:{q:e}}:p.esri.restRequest.appendCustomParams(Object.assign(Object.assign({},e),{f:"json"}),["q","num","start","sortField","sortOrder","portalUrl","f","categories"]),w(i,o,"GET").then((n=>(n.nextStart&&-1!==n.nextStart&&(n.nextPage=function(){return f(this,void 0,void 0,(function*(){let i;return"string"==typeof e||e instanceof p.esri.restPortal.SearchQueryBuilder?i={q:e,start:n.nextStart}:(i=e,i.start=n.nextStart),yield v(i,t)}))}),n)))}))}function g(e,t){return f(this,void 0,void 0,(function*(){return yield m(e,t)}))}function m(e,t){return f(this,void 0,void 0,(function*(){let n,i;n||Promise.resolve(null),n=`${t}/sharing/rest/search`,i="string"==typeof e||e instanceof p.esri.restPortal.SearchQueryBuilder?{params:{q:e}}:p.esri.restRequest.appendCustomParams(Object.assign(Object.assign({},e),{f:"json"}),["q","num","start","sortField","sortOrder","portalUrl","f"]);const o=null==i?void 0:i.authentication,r={params:null==i?void 0:i.params,httpMethod:"GET"};return o&&(r.authentication=o),p.esri.restRequest.request(n,r).then((t=>(t.nextStart&&-1!==t.nextStart&&(t.nextPage=function(){return f(this,void 0,void 0,(function*(){let n;return"string"==typeof e||e instanceof p.esri.restPortal.SearchQueryBuilder?n={q:e,start:t.nextStart}:(n=e,n.start=t.nextStart),yield m(n,"item")}))}),t)))}))}var y=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};function w(e){return y(this,arguments,void 0,(function*(e,t={params:{f:"json"}},n="POST"){if("GET"===n){const n=e+function(e){if(!e)return"";const t=Object.keys(e);return t.length?"?"+t.map((t=>encodeURIComponent(t)+"="+encodeURIComponent(e[t]))).join("&"):""}(t.params);return yield fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}}).then((e=>y(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>y(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}return"POST"===n?t.params&&"FormData"===t.params.constructor.name?yield fetch(e,{method:"POST",body:t.params}).then((e=>y(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>y(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})))):yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.params)}).then((e=>y(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>y(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})))):yield Promise.reject(new Error(null))}))}function S(e=!1){var t;if(e)return p.urlUtils.getArcgisOnlineUrl();{const e=(null===(t=window.jimuConfig.mountPath)||void 0===t?void 0:t.slice(0,-1))||"";return`${window.location.origin}${e}`}}const b=p.esri.restRequest.request;function P(e=!1){return e?"/sharing/rest/content/":"/sharing/rest/content/users/"}function x(){var e;return null===(e=(0,p.getAppStore)().getState().user)||void 0===e?void 0:e.username}function A(e=!1){return e?b:w}function T(e){const t=JSON.parse(JSON.stringify(e));return t.data&&("undefined"!=typeof Blob&&e.data instanceof Blob||"ReadStream"===e.data.constructor.name?t.file=e.data:t.text=e.data,delete t.data),t}var j=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};function C(e){return j(this,void 0,void 0,(function*(){const t=Object.assign({folderId:null},e);return yield function(e){return j(this,void 0,void 0,(function*(){var t,n;if(e.file&&!e.multipart)return yield Promise.reject(new Error("The request must be a multipart request for file uploading."));if(e.multipart&&!e.filename)return yield Promise.reject(new Error("The file name is required for a multipart request."));const i=x(),o=`${S()}${P()}addItem`;e.params=Object.assign(Object.assign(Object.assign({},e.params),T(e.item)),{portalUrl:null===(n=null===(t=(0,p.getAppStore)())||void 0===t?void 0:t.getState())||void 0===n?void 0:n.portalUrl});const r=p.esri.restRequest.appendCustomParams(e,["owner","folderId","file","dataUrl","text","async","multipart","filename","overwrite"],{params:Object.assign({},e.params)});return r.params.username=i,yield w(o,r)}))}(t)}))}function I(e,t){return j(this,void 0,void 0,(function*(){const n=`${S()}${P()}importItem`;if(!(null==e?void 0:e.appZip))return Promise.reject(new Error("No app files"));t.params=Object.assign(Object.assign({},t.params),e);const i=Object.keys(t.params),o=new FormData;for(let e=0;e<i.length;e++)o.append(i[e],t.params[i[e]]);return t.params=o,yield w(n,t)}))}function E(e,t){return j(this,void 0,void 0,(function*(){const n=`${S()}${P()}checkItemVersion`;if(!(null==e?void 0:e.appZip))return Promise.reject(new Error("No app files"));t.params=Object.assign(Object.assign({},t.params),e);const i=Object.keys(t.params),o=new FormData;for(let e=0;e<i.length;e++)o.append(i[e],t.params[i[e]]);return t.params=o,yield w(n,t)}))}var O=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};function k(e,t){return O(this,arguments,void 0,(function*(e,t,n=!1){const i=`${S(n)}${P(n)}items/${e}/data`,o=Object.assign({params:{}},t);o.file&&(o.params.f=null),n&&!D()&&delete o.authentication;const r=A(n);return yield r(i,o).catch((e=>{if(!/Unexpected end of (JSON input|data at line 1 column 1)/i.test(e.message))throw new Error(e)}))}))}function U(e,t){return O(this,arguments,void 0,(function*(e,t,n=!1){const i=`${S(n)}${P(n)}items/${e}`,o=Object.assign({},t);n&&!D()&&delete o.authentication;const r=A(n);return yield r(i,o)}))}function M(e,t){return O(this,arguments,void 0,(function*(e,t,n=!1){const i=`${S(n)}${P(n)}items/${e}/resources`;t.params=Object.assign(Object.assign({},t.params),{num:1e3}),n&&!D()&&delete t.authentication;const o=A(n);return yield o(i,t,"GET")}))}function $(e,t){return O(this,arguments,void 0,(function*(e,t,n=!1){const i=t.fileName,o=`${S(n)}${P(n)}items/${e}/resources/${i}`;n&&!D()&&delete t.authentication;const r=A(n);return yield r(o,t,"GET")}))}function D(){const e=(0,p.getAppStore)().getState().portalUrl;return p.portalUrlUtils.isAGOLDomain(e)}var G=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};function R(e){return G(this,void 0,void 0,(function*(){const t=x(),n=S();e.userName=t;const i=`${n}${P()}items/${e.id}/delete`;return yield w(i,e)}))}function L(e){return G(this,void 0,void 0,(function*(){const t=`${S()}${P()}items/${e.id}/removeResources`;return e.params=Object.assign(Object.assign({},e.params),{resource:e.resource}),yield w(t,e)}))}var F=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};function _(e){return F(this,void 0,void 0,(function*(){const t=x(),n=S();e.userName=t;const i=`${n}${P()}items/${e.item.id}/update`;if(e.params=Object.assign(Object.assign({},e.params),T(e.item)),e.item.thumbnail&&"string"!=typeof e.item.thumbnail){e.params=Object.assign(Object.assign({},e.params),e.item);const t=Object.keys(e.params),n=new FormData;for(let i=0;i<t.length;i++)n.append(t[i],e.params[t[i]]);e.params=n}return yield w(i,e)}))}function W(e){return F(this,void 0,void 0,(function*(){const t=`${S()}${P()}items/${e.id}/updateResources`;e.params=Object.assign(Object.assign({fileName:e.name,text:e.content},e.params),{file:e.resource}),delete e.params.file,e.params.file=e.resource,void 0!==e.private&&(e.params.access=e.private?"private":"inherit");const n=Object.keys(e.params),i=new FormData;for(let t=0;t<n.length;t++)i.append(n[t],e.params[n[t]]);return e.params=i,yield w(t,e)}))}var q=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};function B(e){return q(this,void 0,void 0,(function*(){const t=`${S()}${P()}items/${e.id}/addResources`;e.params=Object.assign(Object.assign({fileName:e.name,text:e.content,access:e.private?"private":"inherit"},e.params),{file:e.resource}),delete e.params.file,e.params.file=e.resource;const n=Object.keys(e.params),i=new FormData;for(let t=0;t<n.length;t++)i.append(n[t],e.params[n[t]]);return e.params=i,yield w(t,e)}))}var N=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};const K=p.SessionManager.getInstance().isTrustedServer((0,p.getAppStore)().getState().portalUrl);function V(e){return N(this,arguments,void 0,(function*(e,t={f:"json"},n="POST"){if("GET"===n){const n=e+function(e){if(!e)return"";const t=Object.keys(e);return t.length?"?"+t.map((t=>encodeURIComponent(t)+"="+encodeURIComponent(e[t]))).join("&"):""}(t);return yield fetch(n,{credentials:K?"include":"same-origin",method:"GET",headers:{"Content-Type":"application/json"}}).then((e=>N(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>N(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}return"POST"===n?t&&"FormData"===t.constructor.name?yield fetch(e,{credentials:K?"include":"same-origin",method:"POST",body:t}).then((e=>N(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>N(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})))):yield fetch(e,{credentials:K?"include":"same-origin",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((e=>N(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>N(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})))):yield Promise.reject(new Error(null))}))}var Y=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};var z=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};function J(e,t){return z(this,arguments,void 0,(function*(e,t,n=!1){const i=`${S(n)}/sharing/rest/content/groups/${e}/search`;n&&!function(){const e=(0,p.getAppStore)().getState().portalUrl;return p.portalUrlUtils.isAGOLDomain(e)}()&&delete t.authentication;const o=Object.assign(Object.assign({},t),{httpMethod:"GET"}),r=p.esri.restRequest.request;return yield r(i,o)}))}var H=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};var Q=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};var X=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};var Z=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};function ee(e){return Z(this,arguments,void 0,(function*(e,t=!1){const n=function(e=!1){var t;return e?p.urlUtils.getArcgisOnlineOrgId():null===(t=(0,p.getAppStore)().getState().user)||void 0===t?void 0:t.orgId}(t),i=`${S(t)}/sharing/rest/portals/${n}/categorySchema`;t&&!te()&&delete e.authentication;const o=Object.assign(Object.assign({},e),{httpMethod:"GET"}),r=p.esri.restRequest.request;return yield r(i,o)}))}function te(){const e=(0,p.getAppStore)().getState().portalUrl;return p.portalUrlUtils.isAGOLDomain(e)}function ne(e){if(oe(e))return{};const t=p.SessionManager.getInstance().getMainSession();return ie(e)?t:{}}function ie(e){var t,n;if(!(null==e?void 0:e.portalUrl))return!window.jimuConfig.isDevEdition;const i=(null==e?void 0:e.portalUrl)||"",o=(null===(n=null===(t=(0,p.getAppStore)())||void 0===t?void 0:t.getState())||void 0===n?void 0:n.portalUrl)||"",r=(null==o?void 0:o.includes(i))||(null==i?void 0:i.includes(o));return(p.portalUrlUtils.isAGOLDomain(i)&&p.portalUrlUtils.isAGOLDomain(o)||r)&&!oe(e)}function oe(e){return!!((null==e?void 0:e.portalUrl)||"").endsWith("localhost:")||e.isLocalApp}function re(e){const t=se(e)?p.urlUtils.getArcgisOnlineUrl():(0,p.getAppStore)().getState().portalUrl;return(null==e?void 0:e.isLocalApp)?S()+"/apps/":p.portalUrlUtils.getPlatformUrlByOrgUrl(t)+"/sharing/rest/content/items/"}function se(e){if(!(null==e?void 0:e.portalUrl))return!1;const t=(null==e?void 0:e.portalUrl)||"",n=p.portalUrlUtils.isAGOLDomain(t),i=!ie(e),o=!oe(e);return i&&o&&n}var ue=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};var ae=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};var ce=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};var de=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};const{importItem:le,checkItemVersion:pe}=s;function fe(e,t,n){const i=n?s[n]:s[e],o=p.esri.restPortal[e];return t?ie(t)?o:i:window.jimuConfig.isDevEdition?i:o}function he(e,t){return de(this,void 0,void 0,(function*(){return function(e){let t;const n=(0,p.getAppStore)().getState().portalUrl,i=p.portalUrlUtils.isAGOLDomain(n);switch(e){case c.Portal:t=p.esri.restPortal.searchItems;break;case c.AGOL:t=i?p.esri.restPortal.searchItems:h;break;case c.Other:t=window.jimuConfig.isDevEdition?h:p.esri.restPortal.searchItems}return t}(t)(e,t)}))}function ve(e){return de(this,void 0,void 0,(function*(){return fe("updateItem")(e)}))}function ge(e){return de(this,void 0,void 0,(function*(){return window.jimuConfig.isDevEdition?yield _(e):yield function(e){return Y(this,void 0,void 0,(function*(){const t=p.SessionManager.getInstance().getMainSession(),n=e.owner?e.owner:null==t?void 0:t.username,i=`${(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/users/${n}/items/${e.item.id}/update`;e.params=Object.assign(Object.assign({},e.params),e.item);const o=Object.keys(e.params),r=new FormData;for(let t=0;t<o.length;t++)r.append(o[t],e.params[o[t]]);return e.params=r,yield V(i,r)}))}(e)}))}function me(e,t){return de(this,void 0,void 0,(function*(){return fe("getItem",e)(e.id,t,se(e))}))}function ye(e){return de(this,void 0,void 0,(function*(){return function(e){return ae(this,void 0,void 0,(function*(){const t=ne(e),n=ie(e)?`?token=${null==t?void 0:t.token}`:"",i=`${re(e)}${e.id}/resources//config/config.json${n}`;return yield V(i,{},"GET")}))}(e)}))}function we(e,t){return de(this,void 0,void 0,(function*(){return yield function(e,t){return ue(this,void 0,void 0,(function*(){const n=ne(e),i=ie(e),o=`${window.jimuConfig.isDevEdition?S():(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/items/${e.id}/copy`,r={params:t,httpMethod:"POST"};return i&&(r.authentication=n),yield p.esri.restRequest.request(o,r)}))}(e,t)}))}function Se(e,t){return de(this,void 0,void 0,(function*(){return yield function(e,t){return ce(this,void 0,void 0,(function*(){const n=ne(e),i=ie(e),o=p.SessionManager.getInstance().getMainSession(),r=`${window.jimuConfig.isDevEdition?S():(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/users/${null==o?void 0:o.username}/items/${e.id}/deleteThumbnail`,s={params:t,httpMethod:"POST"};return i&&(s.authentication=n),yield p.esri.restRequest.request(r,s)}))}(e,t)}))}function be(e,t,n){return de(this,void 0,void 0,(function*(){return yield function(e,t){return Z(this,arguments,void 0,(function*(e,t,n=!1){const i=`${S(n)}/sharing/rest/community/groups/${e}/c`;n&&!te()&&delete t.authentication;const o=Object.assign(Object.assign({},t),{params:{id:e},httpMethod:"GET"}),r=p.esri.restRequest.request;return yield r(i,o)}))}(e,t,n)}))}function Pe(e){return de(this,void 0,void 0,(function*(){return yield function(e){return H(this,void 0,void 0,(function*(){const t=p.SessionManager.getInstance().getMainSession(),n=`${(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/items/${e.items}/share`;e=Object.assign(Object.assign({},e),{f:"json",token:null==t?void 0:t.token});const i=Object.keys(e),o=new FormData;for(let t=0;t<i.length;t++)o.append(i[t],e[i[t]]);return e=o,yield V(n,e)}))}(e)}))}function xe(e){return de(this,void 0,void 0,(function*(){return yield function(e){return Q(this,void 0,void 0,(function*(){const t=p.SessionManager.getInstance().getMainSession(),n=`${(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/items/${e.items}/unshare`;e=Object.assign(Object.assign({},e),{f:"json",token:null==t?void 0:t.token});const i=Object.keys(e),o=new FormData;for(let t=0;t<i.length;t++)o.append(i[t],e[i[t]]);return e=o,yield V(n,e)}))}(e)}))}function Ae(e){return de(this,void 0,void 0,(function*(){return yield function(e){return X(this,void 0,void 0,(function*(){const t=p.SessionManager.getInstance().getMainSession(),n=`${(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/itemsgroups`,i={params:e,httpMethod:"GET",authentication:t};return yield p.esri.restRequest.request(n,i)}))}(e)}))}function Te(e){return function(e){return z(this,void 0,void 0,(function*(){const t=p.SessionManager.getInstance().getMainSession(),n=`${(0,p.getAppStore)().getState().portalUrl}/sharing/rest/content/users/${null==t?void 0:t.username}`,i=Object.assign(Object.assign({},e.params),{f:"json",token:null==t?void 0:t.token});return yield V(n,i,"GET")}))}(e)}const je={frameworkAction_SetData:"Select data",frameworkAction_ActionLayer:"Action data",frameworkAction_Conditions:"Conditions",frameworkAction_RelateMessage:"Trigger / action connection",frameworkAction_UseRelationship:"Use layer's relationship",frameworkAction_CustomFields:"Set custom connection fields",frameworkAction_TriggerLayerField:"Select a trigger field",frameworkAction_None:"none",frameworkAction_Equals:"equals",frameworkAction_ActionLayerField:"Select an action field",frameworkAction_MoreConditions:"More conditions",frameworkAction_SetExpression:"Please set your expression first.",frameworkAction_ChooseLayer:"Select data",frameworkAction_AutoBind:"Auto bound.",frameworkAction_NoLayer:"No data.",frameworkAction_QueryByExtent:"Query by current extent",defaultTextPlaceholder:"Double click to edit text",titlePlaceholder:"Here is the title",subTitlePlaceholder:"Here is the subtitle",shortTitlePlaceholder:"Title",shortSubTitlePlaceholder:"Subtitle",copyrightPlaceholder:"Copyright info",cardTitle:"Card title",bookmark:"Bookmark",number:"Number",templateSearchResult:"Search result",logo:"Logo",appItemCopy:"Copy",openingGuideStep1Title:"Getting started",openingGuideStep1Content:"This tour will show you how to navigate in Experience Builder",openingGuideStep2Title:"Canvas",openingGuideStep2Content:"You can interact with widgets in your experience visually on the canvas.",openingGuideStep3Title:"Sidebar",openingGuideStep3Content:"Allows you to open the widget, page, data, and theme panels.",openingGuideStep4Title:"Insert widget",openingGuideStep4Content:"Click on the Map widget and drag it onto the canvas.",openingGuideStep5Title:"Resize widget",openingGuideStep5Content:"You can change the size of widget on the canvas.",openingGuideStep7Title:"Style",openingGuideStep7Content:"Click the Style tab to switch to the style setting panel.",openingGuideStep8Title:"Size and position",openingGuideStep8Content:"Click the Full size button located at the top right hand corner.",openingGuideStep8Title2:"Style",openingGuideStep8Content2:"Allows you to customize properties such as size, position, background, animation, border, and transform.",openingGuideStep9Title:"Action",openingGuideStep9Content:"Click the Action tab to switch to the action setting panel.",openingGuideStep10Title:"Action",openingGuideStep10Content:"Interactions between widgets can be configured using triggers and actions. Widget actions are in response to linked trigger actions in other widgets.",openingGuideStep11Title:"Header",openingGuideStep11Content:"Click Live view to make your experience interactive inside the builder.",openingGuideStep12Title:"Page",openingGuideStep12Content:"Shows the structure of your experience. You can create and organize pages and folders and change page settings.",openingGuideStep13Title:"Data",openingGuideStep13Content:"Displays all the data listed in your experience and the widgets connected to the data.",openingGuideStep14Title:"Theme",openingGuideStep14Content:"Defines the color scheme for the appearance of your experience.",openingGuideStep15Title:"End of tour",openingGuideStep15Content:"You can always return if you need a refresher.",DSSelectionStep1Title:"Widget content",DSSelectionStep1Content:"Click on Select map to add a new data source.",DSSelectionStep2Title:"Add new data",DSSelectionStep2Content:"Click add new data and select a web map for a data source.",DSSelectionStep3Title:"Select data",DSSelectionStep3Content:"Click the web map in the select data panel.",DSSelectionStep4Title:"Widget content",DSSelectionStep4Content:"Click on Select data to add a new data source.",DSSelectionStep5Title:"Select data",DSSelectionStep5Content:"Click the feature layer in the select data panel.",insertWidgetStep1Title:"Insert widget",insertWidgetStep1Content:"Click on the widget and drag it onto the canvas.",expressModeStep1Title:"Express mode",expressModeStep1Content:"Use express mode to focus on essential functions and content when designing an experience. You can move an experience from express mode to full mode if you need more advanced features and layout settings.",expressModeLearnMore:"Learn more",welcomeStep1Content:"This tour will show you how to navigate in Experience Builder express mode.",mapWidgetTitle:"Configure Widget",mapWidgetContent:"<p>Activate a widget by clicking on it. Widget configuration will open on the right side panel. For example, please <b>click on the map</b>.</p>",expressSelectDataTitle:"Configure map",expressSelectDataContent:"Select map source, enable map tools and configure other settings.",expressMessageActionTitle:"Message action",expressMessageActionContent:"Configure message actions to communicate with other widgets.",widgetControllerTitle:"Widget controller",widgetControllerContent:"<p><b>Click at the Widget controller area,</b> managing buttons will show on the top bar. Configure Widget controller behaviors on the right side.</p>",expressWidgetControllerAddWidgetTitle:"Add or manage widgets in Widget controller",expressWidgetControllerAddWidgetContent:"Click the Add button on the top bar to add widgets to the Widget controller. Use the Manage widget button to reorder or group widgets. To remove a widget, click on it and a Delete button will show on the top bar.",expressTextTitle:"Configure title",expressTextContent:"Double click to change the title for your app.",expressSectionTitle:"Add or manage views",expressSectionContent:"<p><b>Click on the View navigation area</b>, managing buttons will show on the top bar. You can add new views, reorder or remove views. You can add a widget to each view.</p>",expressSidebarTitle:"Configure widget in Sidebar",expressSidebarContent:"<p><b>Click the expand button</b> to open the sidebar. Click the widget inside to configure.</p>",expressSidebarTitle1:"Configure Sidebar",expressSidebarContent1:"You can decide whether to show the sidebar by enabling or disabling the sidebar Collapse button.",expressGridTitle:"Managing grids",expressGridContent:"Click on a grid and managing buttons will show on the top bar. You can remove a grid or split it in a preferred way.",expressPlaceholderTitle:"Add or manage widget",expressPlaceholderContent:"<p>Click the Add button on Placeholder to add a widget and configure it on the right side. <br> To remove the widget, click on the widget and a delete button will show on the top bar.</p>",expressThemeTitle:"Theme & General settings",expressThemeContent:"Select a preferred theme from Theme tab. Configure app general settings from General tab.",expressWindowTitle:"Page or Window switch",expressWindowContent:"<p><b>Click the outline menu</b> to switch between page and window.</p>",expressWindowTitle1:"Configure window",expressWindowContent1:"Configure Window behaviors on the right side. Double click text to edit. For other widgets, click to activate configuration on the right side.",expressWindowTitle2:"Configure window",expressWindowContent2:"<p><b>Click Window option</b> to switch Window settings. Hover on the Window option and click the Set as splash icon beside it to set a splash window. You can choose window design from templates.</p>",expressTopBarTitle:"Top bar options",expressTopBarContent:"<ul><li>Review different screen sizes </li><li>Undo or Redo operations </li><li>Save, publish and preview the experience.</li><li>More</li></ul>",expressFullEditModeTitle:"Full mode",expressFullEditModeContent:"You can switch to full mode which allows advanced experience design.",expressEndGuideTitle:"Congratulations! You have completed the tour!",expressEndGuideContent:"Now start to build your experience. You can always return to the guide by clicking the Help button on the bottom left corner of the builder if you need a refresher.",goToExpressMode:"Go to express mode",goToFullMode:"Go to full mode",switchedToExpressMode:"Switched to express mode",switchedToFullMode:"Switched to full mode"};var Ce=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};const Ie=p.esri.restRequest.request,{TYPE_KEYWORDS_OF_EXPRESS_APP:Ee}=p.CONSTANTS;function Oe(e){return Ce(this,arguments,void 0,(function*(e,t=!1,n=""){const i=p.SessionManager.getInstance().getMainSession();let o=null;const r=(null==n?void 0:n.includes("Template"))?d.TemplateType:d.ExperienceType,s=window.isExpressBuilder?'typekeywords: "ExpressExperienceApp"':'NOT typekeywords: "ExpressExperienceApp"';return yield Pt({q:`type: "${r}" ${s} AND owner:${null==i?void 0:i.username} AND  title:"${e}"`,sortField:"modified",sortOrder:"desc"},c.Other).then((n=>Ce(this,void 0,void 0,(function*(){const i=n.results;if(i&&i.length>0){const n=function(e,t){const n=[],i=/^[\d]+$/;return e.forEach((e=>{var o,r;const s=null===(r=null===(o=e.title)||void 0===o?void 0:o.split(`${t} `)[1])||void 0===r?void 0:r.split(" ")[0];i.test(s)&&n.push(Number(s))})),n.sort((function(e,t){return e<t?1:-1})),n[0]||1}(i,e);return o=et(e,i,n,t),yield Promise.resolve(o)}return o=t?e:`${e} 1`,yield Promise.resolve(o)})))).catch((e=>Ce(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject(new Error(e))}))))}))}function ke(e){return Ce(this,void 0,void 0,(function*(){const{originAppInfo:t,folder:n,title:i,name:o,updateAppVersion:r,removeFaviconInConfig:s,isDuplicateApp:u,deleteThumbnail:a,appInfoItemForNewApp:c,retainsAppSummary:d}=e;return Oe(`${i||t.title}`,u,t.type).then((e=>Ce(this,void 0,void 0,(function*(){e=e||(null==t?void 0:t.title);const i={name:o||e,title:e,folder:n,includeResources:!0,copyPrivateResources:!0,f:"json"};return we(t,Object.assign(Object.assign({},i),{authentication:p.SessionManager.getInstance().getMainSession()})).then((n=>{const i=n.itemId;return Ot({id:i}).then((n=>(e&&(n.title=e),function(e){return Ce(this,arguments,void 0,(function*(e,t=!1,n,i=!1){const o=e.id;return function(e){return Ce(this,arguments,void 0,(function*(e,t=!1,n,i=!1){const o=(null==n?void 0:n.typeKeywords)||(null==e?void 0:e.typeKeywords)||[],r=e.id,s=We(o,e.type,t);return i||(e.snippet="",e.description=""),e.url="",e.clearEmptyFields=!0,n&&((null==n?void 0:n.typeKeywords)&&delete n.typeKeywords,e=Object.assign(Object.assign({},e),n)),e.typeKeywords=s,Ut(e).then((e=>Promise.resolve(r)))}))}(e,t,n,i).then((e=>Ge(o)))}))}(n,r,c,d).then((e=>Re(i,t,!0,r,s).then((e=>a?Se(n).then((e=>Promise.resolve(i))):Promise.resolve(i)),(e=>(Lt(i),Promise.reject(new Error(e)))))),(e=>(Lt(i),Promise.reject(new Error(e))))))))}),(e=>Promise.reject(new Error(e))))}))))}))}function Ue(e,t){return Ce(this,void 0,void 0,(function*(){const n=["EXB Experience","Ready To Use","JavaScript","status: Draft",`version:${p.version}`];window.isExpressBuilder&&n.push(Ee);const i={title:null==e?void 0:e.name,type:(null==e?void 0:e.type)||"Web Experience",typeKeywords:n,snippet:(null==e?void 0:e.snippet)||"",description:(null==e?void 0:e.description)||"",tags:(null==e?void 0:e.tags)||[],text:{__not_publish:!0}};return yield(()=>Ce(this,void 0,void 0,(function*(){return yield Promise.resolve(!1)})))().then((function(e){return Ce(this,void 0,void 0,(function*(){return e?yield Promise.reject(new Error("app existed.")):yield De(i,t)}))}))}))}function Me(e,t,n,i){return Ce(this,void 0,void 0,(function*(){const o=p.moduleLoader.getModuleSync("jimu-for-builder").AppResourceManager.getInstance(),r=t.id;let s=p.utils.replaceI18nPlaceholdersInObject(e,p.i18n.getIntl(),je);return s=function(e){e.attributes||(e.attributes={});e.widgets||(e.widgets={});e.widgetsManifest||(e.widgetsManifest={});e.views||(e.views={});e.sections||(e.sections={});e.dialogs||(e.dialogs={});e.pages||(e.pages={});e.layouts||(e.layouts={});e.dataSources||(e.dataSources={});e.messageConfigs||(e.messageConfigs={});return e}(s),p.appConfigUtils.addWebmapOrWebsceneToAppConfig(s,n,i,!0),o.upLoadAppConfig(r.toString(),s).then((()=>Ce(this,void 0,void 0,(function*(){return yield Promise.resolve(t)}))))}))}function $e(e){return Ce(this,void 0,void 0,(function*(){return yield function(e){return Ce(this,void 0,void 0,(function*(){const t=(0,p.getAppStore)().getState().portalUrl,n={id:e,portalUrl:t,isLocalApp:!1};return yield Ot(n).then((e=>Ce(this,void 0,void 0,(function*(){return yield Promise.resolve(n)})))).catch((e=>Ce(this,void 0,void 0,(function*(){return yield Promise.reject(new Error("Item does not exist or is inaccessible."))}))))}))}(e).then((e=>Ce(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})))).catch((t=>Ce(this,void 0,void 0,(function*(){return yield function(e){return Ce(this,void 0,void 0,(function*(){const t=(0,p.getAppStore)().getState().portalUrl;if(p.portalUrlUtils.isAGOLDomain(t))return yield Promise.reject(!1);const n={id:e,portalUrl:"https://maps.arcgis.com",isLocalApp:!1};return yield Ot(n).then((e=>Ce(this,void 0,void 0,(function*(){return yield Promise.resolve(n)})))).catch((e=>Ce(this,void 0,void 0,(function*(){return yield Promise.reject(new Error("Item does not exist or is inaccessible."))}))))}))}(e).then((e=>Ce(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})))).catch((t=>Ce(this,void 0,void 0,(function*(){return yield function(e){return Ce(this,void 0,void 0,(function*(){if(window.jimuConfig.isDevEdition){const t=(0,p.getAppStore)().getState().portalUrl,n={id:e,portalUrl:t,isLocalApp:!0};return yield Ot(n).then((e=>Ce(this,void 0,void 0,(function*(){return(null==e?void 0:e.success)?yield Promise.resolve(n):yield Promise.reject(new Error("Item does not exist or is inaccessible."))})))).catch((e=>Ce(this,void 0,void 0,(function*(){return yield Promise.reject(new Error("Item does not exist or is inaccessible."))}))))}return yield Promise.reject(new Error("Item does not exist or is inaccessible."))}))}(e)}))))}))))}))}function De(e,t){return Ce(this,void 0,void 0,(function*(){return t?yield(n={item:e,folderId:t,authentication:p.SessionManager.getInstance().getMainSession()},p.esri.restPortal.createItemInFolder(n)):yield function(e){return de(this,void 0,void 0,(function*(){return fe("createItem")(e)}))}({item:e,authentication:p.SessionManager.getInstance().getMainSession()});var n}))}function Ge(e){return Ce(this,void 0,void 0,(function*(){const t=p.SessionManager.getInstance().getMainSession();return yield ve({item:{id:e,owner:null==t?void 0:t.username,text:{__not_publish:!0}},authentication:p.SessionManager.getInstance().getMainSession()}).then((()=>Ce(this,void 0,void 0,(function*(){return yield Promise.resolve(!0)}))),(e=>Ce(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject(new Error(e))}))))}))}function Re(e,t){return Ce(this,arguments,void 0,(function*(e,t,n=!1,i=!1,o=!1){return(n?ye(t):wt(t)).then((r=>Ce(this,void 0,void 0,(function*(){return yield function(e,t,n){return Ce(this,void 0,void 0,(function*(){const i=re(t)+t+"/resources/",o=new RegExp("^"+i);function r(e){return o.test(e)}function s(n){return n.replace("/"+t+"/","/"+e+"/")}const u={matcher:r,handler:s};return Promise.resolve(p.utils.replaceStringInObject(n,u))}))}(e,t.id,r).then((s=>Ce(this,void 0,void 0,(function*(){var u,a;let c=function(e,t){var n;const i=(0,p.getAppStore)().getState().portalUrl;e.attributes&&(e.attributes.portalUrl=i);const o=null==e?void 0:e.dataSources;if(o&&se(t))for(const e in o){Ve(null===(n=o[e])||void 0===n?void 0:n.portalUrl)&&(o[e].portalUrl=i)}return e}(s,t);c.template=null==t?void 0:t.id,delete c.appProxies,delete c.historyLabels,i&&(c=null===(u=Be((0,p.Immutable)(c)))||void 0===u?void 0:u.asMutable({deep:!0})),o&&(null===(a=null==c?void 0:c.attributes)||void 0===a?void 0:a.favicon)&&delete c.attributes.favicon;const d=(new Date).getTime();if(c.timestamp=`${d}`,(null==r?void 0:r.__not_publish)&&!n)return yield Promise.reject(new Error("This item is not published"));const l=p.SessionManager.getInstance().getMainSession(),f=null==l?void 0:l.username;return p.moduleLoader.getModuleSync("jimu-for-builder").AppResourceManager.getInstance().upLoadAppConfig(e,c,f).then((()=>Ce(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))),(e=>Ce(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject(new Error(e))}))))}))))}))),(e=>Ce(this,void 0,void 0,(function*(){return yield Promise.reject(new Error("Resource does not exist or is inaccessible"))}))))}))}function Le(e,t,n){return Ce(this,void 0,void 0,(function*(){const i=ne({portalUrl:window.jimuConfig.isDevEdition?"localhost:":(0,p.getAppStore)().getState().portalUrl}),o=ne(t);if(n){const r=`${re(t)}${t.id}/info/${n}?token=${null==o?void 0:o.token}`,s=`${re(t)}${t.id}/${n}`;let u;return u=(null==n?void 0:n.startsWith("blob:"))?n:(null==n?void 0:n.includes("http"))?`${n}?token=${null==o?void 0:o.token}`:ie(t)?r:s,yield new Promise((function(t,n){const o=new XMLHttpRequest;o.open("GET",u,!0),o.responseType="blob",o.onload=function(o){if(200===this.status){const o=this.response;return $t({id:e,thumbnail:o,f:"json",token:null==i?void 0:i.token}).then((()=>{t(!0)}),(()=>{n(!1)}))}n(!1)},o.onerror=function(e){n(new Error(null))},o.send()}))}return Promise.resolve(!0)}))}function Fe(e,t=!1){let n=!1,i=e.typeKeywords||[];const o=_e(e);if(i=i.map((e=>(e.includes("status:")&&(n=!0),e.includes("status:")&&o!==l.Draft?`status: ${l.Changed}`:e.includes("version:")&&t?`version:${p.version}`:e))),!n){const e=`status: ${l.Draft}`;i.push(e)}return i}function _e(e){let t;return((null==e?void 0:e.typeKeywords)||[]).forEach((e=>{if(e.includes("status:")){switch(e.split(": ")[1]){case l.Published:t=l.Published;break;case l.Changed:t=l.Changed;break;case l.Draft:t=l.Draft}}})),t}function We(e,t,n=!1){const i=`version:${p.version}`,o=window.isExpressBuilder&&!(null==e?void 0:e.includes(Ee));if(!e||0===e.length){const e=["EXB Experience","Ready To Use","JavaScript","status: Draft",i];return o&&e.push(Ee),e}let r=!1,s=!1,u=e.map((e=>n&&e.includes("version:")?(s=!0,`version:${p.version}`):(e.includes("version:")&&(s=!0),!t||e!==d.ExperienceType&&e!==d.TemplateType?e.includes("status:")?(r=!0,"status: Draft"):e:t)));return u=u.filter((e=>!e.includes("publishVersion:")&&!e.includes("Registered App")&&!e.includes("App Proxy"))),!r&&u.push("status: Draft"),!s&&u.push(i),o&&u.push(Ee),u=Array.from(new Set(u)),u}function qe(e,t){return Object.values(e.widgets).forEach((e=>{"widgets/common/text/"===e.uri&&function(e,t){const n=t.type===d.TemplateType;if(n)return e;Ze(null==e?void 0:e.text)||delete e.placeholder}(e.config,t)})),e}function Be(e){var t;if(!e)return null;p.semver.lt(p.version,null==e?void 0:e.exbVersion)&&(e=e.set("exbVersion",p.version));const n=(null===(t=(0,p.getAppStore)().getState().appStateInBuilder)||void 0===t?void 0:t.appConfig).widgets||{};return Object.keys(n).forEach((t=>{var i,o,r;const s=null===(o=null===(i=n[t])||void 0===i?void 0:i.manifest)||void 0===o?void 0:o.version;if(s&&p.semver.valid(s)){p.semver.lt(s,null===(r=n[t])||void 0===r?void 0:r.version)&&(e=e.setIn(["widgets",t,"version"],s))}})),e}function Ne(e){var t,n,i;e.attributes?e.attributes.portalUrl=(0,p.getAppStore)().getState().portalUrl:e.attributes={portalUrl:(0,p.getAppStore)().getState().portalUrl};const o=null===(n=null===(t=(0,p.getAppStore)().getState().portalSelf)||void 0===t?void 0:t.portalProperties)||void 0===n?void 0:n.sharedTheme;return e.sharedThemeVariables=p.sharedThemeUtils.createSharedThemeVariables(o),window.isExpressBuilder&&(null===(i=null==e?void 0:e.forBuilderAttributes)||void 0===i?void 0:i.lockLayout)&&(e.forBuilderAttributes.lockLayout=!1),e}function Ke(e){return Ce(this,void 0,void 0,(function*(){const t=p.SessionManager.getInstance(),n=(new Date).getTime();return window.jimuConfig.isDevEdition?yield window.fetch(`${window.jimuConfig.mountPath}apps/${e}/resources/config/config.json`).then((e=>Ce(this,void 0,void 0,(function*(){return yield e.json()})))):yield Ie(`${p.portalUrlUtils.getPortalRestUrl((0,p.getAppStore)().getState().portalUrl)}/content/items/${e}/resources/config/config.json`,{authentication:t.getSessionByUrl((0,p.getAppStore)().getState().portalUrl),httpMethod:"GET",params:{timestamp:n}}).catch((e=>Ce(this,void 0,void 0,(function*(){return Promise.reject(new Error(e))}))))}))}function Ve(e){let t=!1;const n=(0,p.getAppStore)().getState().portalUrl;return(tt(n,e,"mapsdevext.arcgis.com")||tt(n,e,"mapsqa.arcgis.com")||tt(n,e,"maps.arcgis.com"))&&(t=!0),t}function Ye(e){const t={};return Object.keys(e).forEach((n=>{t[n]=Object.assign({},e[n])})),t}function ze(e){let t;const n=(0,p.getAppStore)().getState().portalUrl,i=p.SessionManager.getInstance().getMainSession(),o=p.portalUrlUtils.isAGOLDomain(n);switch(e){case c.Portal:t=i;break;case c.AGOL:t=o?i:{};break;case c.Other:t=window.jimuConfig.isDevEdition?{}:i}return t}function Je(e=[]){return(null==e?void 0:e.includes(Ee))&&(e=null==e?void 0:e.filter((e=>e!==Ee))),e}function He(e,t){const n=e.historyLabels;Object.keys(n[t]||{}).forEach((i=>{var o;(null===(o=e[t])||void 0===o?void 0:o[i])||delete n[t][i]}))}function Qe(e,t,n){const i=e[n],o=t[n];i&&o&&Object.keys(i).forEach((r=>{var s,u;const a=(null===(u=null===(s=t.historyLabels)||void 0===s?void 0:s[n])||void 0===u?void 0:u[r])||[];o[r]&&i[r].label!==o[r].label&&(a.includes(o[r].label)||a.push(o[r].label)),a.length>0&&(e.historyLabels?e.historyLabels[n]?e.historyLabels[n][r]=a:e.historyLabels[n]={[r]:a}:e.historyLabels={[n]:{[r]:a}})}))}const Xe=/<[^>]*>/g,Ze=e=>{if(!e)return!0;if("<p></p>"===e||"<p><br></p>"===e)return!0;let t="";return t=e.includes("<")?function(e){let t;do{t=e,e=e.replace(Xe,"")}while(e!==t);return e}(e):e,t=null==t?void 0:t.trim(),!t};function et(e,t,n=1,i=!1){const o=1===n&&i?e:`${e} ${n}`;if(!function(e,t){let n=!1;return t.forEach((t=>{e===t.title&&(n=!0)})),n}(o,t))return o;return et(e,t,n+1)}function tt(e,t,n){return((null==e?void 0:e.endsWith(n))||(null==e?void 0:e.endsWith(`${n}/`)))&&((null==t?void 0:t.endsWith(n))||(null==t?void 0:t.endsWith(`${n}/`)))}var nt=o(6884),it=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};function ot(e){return it(this,void 0,void 0,(function*(){const{originalAppInfo:t,useDraftConfig:n,updateAppConfigVersion:i,isRemoveFaviconInConfig:o,folderId:r}=e;return Ot(t).then((s=>it(this,void 0,void 0,(function*(){if(s){const u=(null==e?void 0:e.type)||d.ExperienceType;return Oe(s.title).then((e=>it(this,void 0,void 0,(function*(){if(e){return function(e,t,n,i){return it(this,void 0,void 0,(function*(){const o=i||e.type||"Web Experience";return De({title:e.name,type:o,typeKeywords:We(null==e?void 0:e.typeKeywords,o,n),snippet:(null==e?void 0:e.snippet)||"",description:(null==e?void 0:e.description)||"",tags:e.tags,thumbnail:e.thumbnail},t)}))}({name:e,tags:s.tags,thumbnail:s.thumbnail,type:u,typeKeywords:null==t?void 0:t.typeKeywords},r).then((e=>it(this,void 0,void 0,(function*(){if(e){return function(e){return it(this,void 0,void 0,(function*(){const{newAppId:t}=e;return Ge(t).then((t=>it(this,void 0,void 0,(function*(){return t?function(e){return it(this,void 0,void 0,(function*(){const{newAppId:t,originalAppInfo:n,useDraftConfig:i,updateAppConfigVersion:o,isRemoveFaviconInConfig:r}=e;return Re(t,n,i,o,r).then((e=>it(this,void 0,void 0,(function*(){return function(e,t){return it(this,void 0,void 0,(function*(){const n=ne(t);return function(e,t){return de(this,void 0,void 0,(function*(){return fe("getItemResources",e)(e.id,t,se(e))}))}(t,{authentication:n}).then((n=>it(this,void 0,void 0,(function*(){const i=[],o=n&&n.resources;if(o)for(let n=0;n<o.length;n++){"config/config.json"===o[n].resource||i.push(rt(e,t,o[n]))}return Promise.all(i)}))),(e=>it(this,void 0,void 0,(function*(){return Promise.resolve(null)}))))}))}(t,n).then((e=>it(this,void 0,void 0,(function*(){return e?Promise.resolve(!0):Promise.reject(new Error("Resource does not exist or is inaccessible"))}))),(e=>it(this,void 0,void 0,(function*(){return Promise.reject(new Error(e))}))))}))))}))}(e):Promise.reject(new Error(null))}))),(e=>it(this,void 0,void 0,(function*(){return Promise.reject(new Error(e))}))))}))}({newAppId:e.id,originalAppInfo:t,useDraftConfig:n,updateAppConfigVersion:i,isRemoveFaviconInConfig:o}).then((()=>it(this,void 0,void 0,(function*(){return Promise.resolve(e.id)}))),(t=>it(this,void 0,void 0,(function*(){return console.error(t),Lt(e.id),Promise.reject(new Error(t))}))))}return Promise.reject(new Error(null))}))))}return Promise.reject(new Error(null))}))))}return Promise.reject(new Error(null))}))))}))}function rt(e,t,n){return it(this,void 0,void 0,(function*(){const i=ne(t),o=ie(t)?`?token=${null==i?void 0:i.token}`:"",r=`${re(t)}${t.id}/resources/`,s=ne({portalUrl:window.jimuConfig.isDevEdition?"localhost:":(0,p.getAppStore)().getState().portalUrl}),u=r+n.resource+o;return yield new Promise((function(t,i){const o=new XMLHttpRequest;o.open("GET",u,!0),o.responseType="blob",o.onload=function(i){if(200===this.status){const i=this.response;return function(e){return de(this,void 0,void 0,(function*(){return fe("addItemResource")(e)}))}({id:e,resource:i,name:n.resource.split("/")[n.resource.split("/").length-1],params:{resourcesPrefix:n.resource.split("/").slice(0,n.resource.split("/").length-1).join("/")},authentication:s}).then((()=>{t(!0)}),(()=>{t(!1)}))}t(!1)},o.onerror=function(e){t(!1)},o.send()}))}))}var st=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};function ut(e,t){return st(this,void 0,void 0,(function*(){return ot({originalAppInfo:e,useDraftConfig:!1,updateAppConfigVersion:!1,isRemoveFaviconInConfig:!0,folderId:t,type:d.ExperienceType})}))}function at(e){return st(this,void 0,void 0,(function*(){return yield $e(e).then((e=>st(this,void 0,void 0,(function*(){return yield ut(e)}))))}))}function ct(e,t,n,i,o){return st(this,void 0,void 0,(function*(){return yield Oe(e).then((e=>st(this,void 0,void 0,(function*(){if(e){const r={template:t,name:e,description:"",type:d.ExperienceType};return yield Promise.all([bt(r)]).then((function(e){return st(this,void 0,void 0,(function*(){let t=e[0];return t.template=r.template,t=Ne(t),yield Ue(r,n).then((e=>st(this,void 0,void 0,(function*(){return yield Me(t,e,i,o)}))))}))})).catch((e=>st(this,void 0,void 0,(function*(){return console.error(e),yield Promise.reject(new Error(e))}))))}return yield Promise.reject(new Error(null))}))))}))}function dt(e,t){return st(this,void 0,void 0,(function*(){return ot({originalAppInfo:e,useDraftConfig:!0,updateAppConfigVersion:!0,isRemoveFaviconInConfig:!0,folderId:t,type:d.TemplateType})}))}var lt=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};function pt(e,t,n){return lt(this,void 0,void 0,(function*(){return yield Ot(e).then((i=>lt(this,void 0,void 0,(function*(){if(i){i.isLocalApp=null==e?void 0:e.isLocalApp;const o=p.i18n.getIntl().formatMessage({id:"copy"})||"copy",r=n?i.title:`${i.title} ${o}`;return ke({originAppInfo:i,folder:t,title:r,newAppType:i.type,isDuplicateApp:!0,updateAppVersion:!1,useDraftConfig:!0,removeFaviconInConfig:!1,deleteThumbnail:!1,retainsAppSummary:!0}).then((e=>Promise.resolve(e)))}return yield Promise.reject(new Error(null))}))))}))}function ft(e){return lt(this,void 0,void 0,(function*(){return(null==e?void 0:e.transferDirectly)?function(e){return Ce(this,void 0,void 0,(function*(){const t=Je(null==e?void 0:e.typeKeywords);return e.typeKeywords=t,Ut(Object.assign(Object.assign({},e),{thumbnailurl:void 0})).then((t=>Promise.resolve({appInfo:e})))}))}(e.appInfo):function(e){return Ce(this,void 0,void 0,(function*(){const t=e.appInfo;return pt(t,null,!0).then((e=>Ot({id:e}).then((n=>Ce(this,void 0,void 0,(function*(){const i=n,o=Je(null==i?void 0:i.typeKeywords);return i.typeKeywords=o,i.snippet=null==t?void 0:t.snippet,Ut({id:e,typeKeywords:o}).then((t=>({id:e,appInfo:i})))}))))))}))}(e)}))}function ht(e){return lt(this,void 0,void 0,(function*(){const t=p.SessionManager.getInstance().getMainSession();return yield function(e,t){return de(this,void 0,void 0,(function*(){return le(e,t)}))}(e,{authentication:t})}))}function vt(e){return lt(this,void 0,void 0,(function*(){const t=p.SessionManager.getInstance().getMainSession();return yield function(e,t){return de(this,void 0,void 0,(function*(){return pe(e,t)}))}(e,{authentication:t})}))}function gt(e){return lt(this,void 0,void 0,(function*(){return ot({originalAppInfo:e,useDraftConfig:!0,updateAppConfigVersion:!1,isRemoveFaviconInConfig:!0,type:e.type})}))}function mt(e,t,n,i){return lt(this,void 0,void 0,(function*(){const o=p.SessionManager.getInstance().getMainSession(),r=p.moduleLoader.getModuleSync("jimu-for-builder").AppResourceManager,s=p.moduleLoader.getModuleSync("jimu-for-builder").appConfigUtils,u=p.ExtensionManager.getInstance().getExtensions(p.extensionSpec.ExtensionPoints.BuilderOperations).sort(((e,t)=>(e.index||0)-(t.index||0)));for(const e of u)if(e.beforeSave)try{t=yield e.beforeSave(t)}catch(e){return console.error("Invoke beforeSave error.",e),Promise.reject(new Error(e))}const a=(null==e?void 0:e.owner)||o.username,c=Object.assign({},s.getCleanAppConfig(t)),d=r.getInstance();if(c)try{yield d.upLoadAppConfig(e.id,c,a);const t=[],{imageResources:o,iconResources:r}=d.getResourcesInDraft();if(o&&t.push(d.upLoadImageResourceList(Ye(o),i)),r&&t.push(d.upLoadIconResourceList(Ye(r),i)),n){const t=Fe(e,!0);e.typeKeywords=t}!i&&t.push(Mt(e)),yield Promise.all(t)}catch(e){yield Promise.reject(new Error(e))}else yield Promise.reject(new Error(null))}))}function yt(e,t,n,i,o){return lt(this,void 0,void 0,(function*(){return ke({originAppInfo:e,folder:n,title:t.title,name:t.title,updateAppVersion:!0,useDraftConfig:!0,removeFaviconInConfig:!1,appInfoItemForNewApp:t}).then((t=>{const r=p.SessionManager.getInstance().getMainSession();return me({id:t},{authentication:r}).then((r=>lt(this,void 0,void 0,(function*(){return function(e,t,n){return Ce(this,void 0,void 0,(function*(){if(!n)return yield Le(t.id,e,(null==e?void 0:e.thumbnailurl)||e.thumbnail);{const e=p.SessionManager.getInstance().getMainSession(),i={id:t.id,f:"json",token:null==e?void 0:e.token,thumbnail:n};yield $t(i,t.owner)}}))}(e,r,i).then((()=>lt(this,void 0,void 0,(function*(){var e;let i=(0,p.getAppStore)().getState().appStateInBuilder.appConfig;i=Be(i);const s=null==i?void 0:i.asMutable({deep:!0});return delete s.appProxies,delete s.historyLabels,o&&(null===(e=null==s?void 0:s.forBuilderAttributes)||void 0===e?void 0:e.lockLayout)&&(s.forBuilderAttributes.lockLayout=!1),mt(r,(0,p.Immutable)(s),!1,t).then((()=>lt(this,void 0,void 0,(function*(){return Ke(t).then((e=>lt(this,void 0,void 0,(function*(){return"/"===n&&n!==r.ownerFolder&&r.ownerFolder?Rt({itemId:t,folderId:"/",authentication:null}).then((n=>Promise.resolve({id:t,appConfig:e,appInfo:r}))):Promise.resolve({id:t,appConfig:e,appInfo:r})}))))}))),(e=>(console.error(e),Lt(t),Promise.reject(new Error(e)))))}))))}))),(e=>Promise.reject(new Error(e))))}))}))}function wt(e){return lt(this,void 0,void 0,(function*(){const t=ne(e);return yield function(e,t){return de(this,void 0,void 0,(function*(){return fe("getItemData",e)(e.id,t,se(e))}))}(e,{authentication:t}).then((e=>lt(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))),(e=>lt(this,void 0,void 0,(function*(){return yield Promise.reject(new Error(e))}))))}))}function St(e){return lt(this,void 0,void 0,(function*(){return yield ye(e).then((e=>lt(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))),(e=>lt(this,void 0,void 0,(function*(){return yield Promise.reject(new Error(e))}))))}))}function bt(e){return lt(this,void 0,void 0,(function*(){return(0,nt.getTemplateConfig)(nt.TemplateType.App,e.template)}))}function Pt(e,t){return lt(this,void 0,void 0,(function*(){const n=ze(t);return yield he(Object.assign(Object.assign({},e),{authentication:n}),t).then((e=>lt(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}))}function xt(e,t){return lt(this,void 0,void 0,(function*(){const n=(0,p.getAppStore)().getState().portalUrl;if(t===n){const t=ze(c.Portal);e.authentication=t}return yield function(e,t){return de(this,void 0,void 0,(function*(){return g(e,t)}))}(e,t).then((e=>lt(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}))}function At(e,t){return lt(this,void 0,void 0,(function*(){const n=p.SessionManager.getInstance().getMainSession();return yield be(e,{authentication:n},t).then((e=>lt(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}))}function Tt(e){return lt(this,void 0,void 0,(function*(){const t=p.SessionManager.getInstance().getMainSession();return yield function(e,t){return de(this,void 0,void 0,(function*(){return yield ee(e,t)}))}({authentication:t},e).then((e=>lt(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}))}function jt(e,t,n){return lt(this,void 0,void 0,(function*(){const i=p.SessionManager.getInstance().getMainSession();return yield function(e,t,n){return de(this,void 0,void 0,(function*(){return yield J(e,t,n)}))}(e,{params:t,authentication:i},n).then((e=>lt(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}))}function Ct(e){return lt(this,void 0,void 0,(function*(){return Te(e).then((e=>lt(this,void 0,void 0,(function*(){const t=(null==e?void 0:e.folders)||[];return yield Promise.resolve(t)}))),(e=>lt(this,void 0,void 0,(function*(){return yield Promise.reject(new Error(e))}))))}))}function It(e){return lt(this,void 0,void 0,(function*(){return yield function(e){return de(this,void 0,void 0,(function*(){return yield p.esri.restPortal.getUserTags(e)}))}({username:e,authentication:p.SessionManager.getInstance().getMainSession()})}))}function Et(e){return lt(this,void 0,void 0,(function*(){return yield function(e){return de(this,void 0,void 0,(function*(){return yield p.esri.restPortal.searchGroups(e)}))}(e)}))}function Ot(e){return lt(this,void 0,void 0,(function*(){const t=ne(e);return yield me(e,{authentication:t}).then((e=>lt(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}))}function kt(e){return lt(this,void 0,void 0,(function*(){return yield Ae(e).then((e=>lt(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}))}function Ut(e){return lt(this,void 0,void 0,(function*(){const t=p.SessionManager.getInstance().getMainSession(),n=window.jimuConfig.isDevEdition?"localhost:":(0,p.getAppStore)().getState().portalUrl,i={id:e.id,portalUrl:n};return yield me(i,{authentication:t}).then((n=>lt(this,void 0,void 0,(function*(){return yield ve({item:e,owner:n.owner,authentication:t}).then((()=>null))}))))}))}function Mt(e){return lt(this,void 0,void 0,(function*(){return Ut(Object.assign(Object.assign({},e),{thumbnailurl:void 0})).then((t=>{var n;const i=null==e?void 0:e.thumbnailurl,o=null===(n=(0,p.getAppStore)().getState().appRuntimeInfo)||void 0===n?void 0:n.saveThumbnailUrl;return i&&i!==o?((0,p.getAppStore)().dispatch(p.appActions.saveThumbnailUrl(i)),Le(e.id,e,i)):Promise.resolve(!0)})).catch((e=>Promise.reject(new Error("Update appInfo error"))))}))}function $t(e){return lt(this,arguments,void 0,(function*(e,t=""){const n=p.SessionManager.getInstance().getMainSession();return yield ge({item:e,authentication:n,owner:t}).then((()=>null))}))}function Dt(e){return lt(this,void 0,void 0,(function*(){return yield Pe(e).then((e=>lt(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}))}function Gt(e){return lt(this,void 0,void 0,(function*(){return yield xe(e).then((e=>lt(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))}))}function Rt(e){return lt(this,void 0,void 0,(function*(){return yield function(e){return de(this,void 0,void 0,(function*(){return yield p.esri.restPortal.moveItem(e)}))}(Object.assign(Object.assign({},e),{authentication:p.SessionManager.getInstance().getMainSession()}))}))}function Lt(e){return lt(this,void 0,void 0,(function*(){const t=p.SessionManager.getInstance().getMainSession();return yield me({id:e},{authentication:t}).then((t=>lt(this,void 0,void 0,(function*(){return yield function(e){return de(this,void 0,void 0,(function*(){return fe("removeItem")(e)}))}({id:e,owner:t.owner,authentication:p.SessionManager.getInstance().getMainSession()})}))))}))}function Ft(e){return lt(this,void 0,void 0,(function*(){const t=yield Ke(e.id);let n=yield wt(e);const i=p.SessionManager.getInstance().getMainSession();if(t&&n){const o=p.ExtensionManager.getInstance().getExtensions(p.extensionSpec.ExtensionPoints.BuilderOperations).sort(((e,t)=>(e.index||0)-(t.index||0)));for(const e of o)if(e.beforePublish)try{n=yield e.beforePublish(n)}catch(e){return console.error("Invoke beforePublish error.",e),Promise.reject(new Error(e))}const r=function(e,t){let n=!1,i=!1;const o=e.map((e=>e.includes("status:")?(n=!0,`status: ${l.Published}`):e.includes("publishVersion:")&&t?(i=!0,`publishVersion:${t}`):e));if(!n){const e=`status: ${l.Published}`;o.push(e)}return!i&&t&&o.push(`publishVersion:${t}`),o}(null==e?void 0:e.typeKeywords,null==n?void 0:n.exbVersion);return p.moduleLoader.getModuleSync("jimu-for-builder").AppResourceManager.getInstance().upLoadLocalResource(t).then((t=>lt(this,void 0,void 0,(function*(){if(!t)return yield Promise.reject(new Error(null));t=function(e,t){return t.__not_publish||(e.historyLabels&&(He(e,"pages"),He(e,"views"),He(e,"dialogs")),Qe(e,t,"pages"),Qe(e,t,"views"),Qe(e,t,"dialogs")),e}(t=qe(t,e),n);const o=(new Date).getTime();t.publishTimestamp=o;const s=function(e){const{type:t,id:n}=e;return window.jimuConfig.isDevEdition?null:p.urlUtils.getAppUrl({id:n,type:t===d.TemplateType?"template":"app",target:"current_portal",isFullUrl:!0})}(e);return yield ve({item:{id:e.id,owner:e.owner||(null==i?void 0:i.username),text:t,typeKeywords:r,url:s},authentication:p.SessionManager.getInstance().getMainSession()}).then((()=>lt(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},e),{typeKeywords:r});return Promise.resolve(t)}))),(()=>lt(this,void 0,void 0,(function*(){return yield Promise.reject(new Error(null))}))))}))),(()=>lt(this,void 0,void 0,(function*(){return yield Promise.reject(new Error(null))})))).catch((e=>lt(this,void 0,void 0,(function*(){return yield Promise.reject(new Error(e))}))))}yield Promise.reject(new Error(null))}))}var _t=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function u(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((i=i.apply(e,t||[])).next())}))};const Wt=p.esri.restRequest.request;var qt;let Bt,Nt;function Kt(e,t){return _t(this,void 0,void 0,(function*(){const n=p.SessionManager.getInstance().getMainSession(),{username:i}=n,o=(0,p.getAppStore)().getState().portalUrl,r=p.portalUrlUtils.getBaseUserUrl(o),s=yield Zt.getInstance().getToken();let u;switch(t=null!=t?t:Xt(),e){case qt.Add:u=r+"/"+i+"/addResource/?token="+s;break;case qt.Remove:u=r+"/"+i+"/removeResource/?token="+s;break;case qt.Get:u=r+"/"+i+"/resources/"+t+"?token="+s;break;case qt.GetAll:u=r+"/"+i+"/resources/?token="+s}return yield Promise.resolve(u)}))}function Vt(e,t){return _t(this,void 0,void 0,(function*(){t=null!=t?t:Xt();const n={httpMethod:"POST",params:Object.assign(Object.assign({},e),{key:t,access:"UserPrivateAllApps"})};return yield Kt(qt.Add).then((e=>_t(this,void 0,void 0,(function*(){return yield Wt(e,n).then((e=>_t(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))})))).catch((e=>_t(this,void 0,void 0,(function*(){return yield Promise.reject(new Error("Failed adding user resource:"+e.message))}))))}))}function Yt(e){return _t(this,void 0,void 0,(function*(){return e=null!=e?e:Xt(),yield Kt(qt.Get,e).then((e=>_t(this,void 0,void 0,(function*(){return yield Wt(e,{params:{f:"json"}}).then((e=>_t(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))})))).catch((e=>_t(this,void 0,void 0,(function*(){return yield Promise.reject(new Error("Failed retrieving user resource:"+e.message))}))))}))}function zt(){return _t(this,void 0,void 0,(function*(){return yield Kt(qt.GetAll).then((e=>_t(this,void 0,void 0,(function*(){return yield Wt(e,{params:{f:"json"}}).then((e=>_t(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))})))).catch((e=>_t(this,void 0,void 0,(function*(){return yield Promise.reject(new Error("Failed retrieving user resource list:"+e.message))}))))}))}function Jt(e){return _t(this,void 0,void 0,(function*(){return e=null!=e?e:Xt(),yield Kt(qt.Remove).then((t=>_t(this,void 0,void 0,(function*(){const n={params:{key:e}};return yield Wt(t,n).then((e=>_t(this,void 0,void 0,(function*(){return yield Promise.resolve(e)}))))})))).catch((e=>_t(this,void 0,void 0,(function*(){return yield Promise.reject(new Error("Failed removing user resource:"+e.message))}))))}))}function Ht(e){return _t(this,void 0,void 0,(function*(){return yield Yt().then((t=>_t(this,void 0,void 0,(function*(){const n=(0,p.Immutable)(null!=t?t:{}).merge(e,{deep:!0});return yield Vt({text:JSON.stringify(Object.assign({},n))})})))).then((e=>_t(this,void 0,void 0,(function*(){return yield Promise.resolve(e)})))).catch((e=>_t(this,void 0,void 0,(function*(){return yield Promise.reject(new Error("Failed updating user resource:"+e.message))}))))}))}function Qt(){return Bt||(Bt=zt().then((e=>_t(this,void 0,void 0,(function*(){if(0===e.total)return yield Vt({text:"{}"});{const t=e.userResources[0],n=Xt();return t.key===n?yield Promise.resolve({success:!0}):yield Yt(t.key).catch((e=>null)).then((e=>_t(this,void 0,void 0,(function*(){return e&&(e.showGuides||0===Object.keys(e).length)?yield Jt(t.key).then((()=>_t(this,void 0,void 0,(function*(){return yield Vt({text:JSON.stringify(Object.assign({},e))})})))):yield Vt({text:"{}"})}))))}})))).catch((e=>_t(this,void 0,void 0,(function*(){return yield Promise.reject(new Error("Failed initializing user resource:"+e.message))}))))),Promise.resolve(Bt)}function Xt(){if(!Nt){const e=p.SessionManager.getInstance().getMainSession();Nt=`${p.USER_SETTING_FILE_KEY}${(null==e?void 0:e.clientId)?`_${e.clientId}`:""}.json`}return Nt}!function(e){e.Add="ADD",e.Remove="REMOVE",e.Get="GET",e.GetAll="GETALL"}(qt||(qt={}));class Zt{static getInstance(){return Zt.instance||(Zt.instance=new Zt),Zt.instance}constructor(){this.session=p.SessionManager.getInstance().getMainSession()}_shouldExchangeToken(){return _t(this,void 0,void 0,(function*(){if(!this.exchangedToken||this.session.tokenExpires<new Date){if(!this.portalSelfPromise){const e=(0,p.getAppStore)().getState().portalUrl;this.portalSelfPromise=Wt(`${e}/sharing/rest/community/self?token=${this.session.token}`).then((e=>_t(this,[e],void 0,(function*({appInfo:e}){return yield Promise.resolve("experienceBuilder"!==(null==e?void 0:e.appId))})))).catch((e=>_t(this,void 0,void 0,(function*(){return yield Promise.reject(new Error(e.message))}))))}return yield this.portalSelfPromise}return yield Promise.resolve(!1)}))}_exchangeToken(){return _t(this,void 0,void 0,(function*(){const e=(0,p.getAppStore)().getState().portalUrl+"/sharing/rest/oauth2/exchangeToken",t={params:{client_id:this.session.clientId,token:this.session.token}};return yield Wt(e,t)}))}getToken(){return _t(this,void 0,void 0,(function*(){var e;return(yield this._shouldExchangeToken())?yield this._exchangeToken().catch((e=>(console.warn("Failed exchanging token. Using default token from user session."),{token:this.session.token}))).then((e=>_t(this,void 0,void 0,(function*(){return this.exchangedToken=null==e?void 0:e.token,yield Promise.resolve(this.exchangedToken)})))):yield Promise.resolve(null!==(e=this.exchangedToken)&&void 0!==e?e:this.session.token)}))}}return r})())}}}));