System.register(["jimu-core"],(function(e,t){var n={};return{setters:[function(e){n.AbstractMessageAction=e.AbstractMessageAction,n.AppMode=e.AppMode,n.DataSourceManager=e.DataSourceManager,n.Immutable=e.Immutable,n.JimuFieldType=e.JimuFieldType,n.MessageActionConnectionType=e.MessageActionConnectionType,n.MessageType=e.MessageType,n.MutableStoreManager=e.MutableStoreManager,n.dataSourceUtils=e.dataSourceUtils,n.getAppStore=e.getAppStore,n.lodash=e.lodash,n.messageActionUtils=e.messageActionUtils}],execute:function(){e((()=>{var e={79244:e=>{"use strict";e.exports=n}},t={};function a(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,a),i.exports}a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.p="";var o={};return a.p=window.jimuConfig.baseUrl,(()=>{"use strict";a.r(o),a.d(o,{default:()=>d});var e=a(79244);var t=function(e,t,n,a){return new(n||(n=Promise))((function(o,i){function s(e){try{l(a.next(e))}catch(e){i(e)}}function r(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}l((a=a.apply(e,t||[])).next())}))};function n(t,n){const a=[];for(let o=0;o<t.length;o++){const i=t[o],s=e.messageActionUtils.formatValue(i,n);a.includes(s)||a.push(s)}return a}function i(a,o,i,s){return t(this,void 0,void 0,(function*(){let t="";if(o.enabledDataRelationShip){let{messageField:r,actionField:l}=function(t,n,a){var o,i,s,r;let l=null,c=null;if(t.messageUseDataSource.mainDataSourceId===t.actionUseDataSource.mainDataSourceId&&t.messageUseDataSource.rootDataSourceId===t.actionUseDataSource.rootDataSourceId){const e=n.getSchema(),t=e&&e.fields&&Object.keys(e.fields).find((t=>"esriFieldTypeOID"===e.fields[t].esriType));l=e&&e.fields&&e.fields[t],c=l}else{let u,d;if(t.connectionType===e.MessageActionConnectionType.UseLayersRelationship){const t=e.dataSourceUtils.getJimuDataSourceRelationship(n,a);t&&(u=t.keyField,d=t.relatedKeyField)}else u=null===(o=t.messageUseDataSource.fields)||void 0===o?void 0:o[0],d=null===(i=t.actionUseDataSource.fields)||void 0===i?void 0:i[0];u&&(l=null===(s=n.getSchema().fields)||void 0===s?void 0:s[u]),d&&(c=null===(r=a.getSchema().fields)||void 0===r?void 0:r[d])}return{messageField:l,actionField:c}}(o,i,s);if(r&&l){const c=r.name,u=r.type,d=a;let g=[];if(o.connectionType===e.MessageActionConnectionType.UseLayersRelationship){g=n((yield null==i?void 0:i.queryRelatedFieldValues(d.records||[],s,l.name))||[],u),0===g.length&&(g=["-1"],l=s.getSchema().fields[s.getIdField()])}else{g=n(d.records.map((e=>e.getData()[c])),u)}if(t="",g.length>0){const n=!0,a=e.messageActionUtils.getSqlExpressionWidthMessageFieldValues(g,l,s,n);if(a){const n=(0,e.Immutable)(a),o=e.dataSourceUtils.getArcGISSQL(n,s);(null==o?void 0:o.sql)&&(t=null==o?void 0:o.sql)}}t||(t="")}}return t||(t=""),t}))}function s(n,a,o,s,r){return t(this,void 0,void 0,(function*(){let t="";const l=[],c=yield i(n,o,s,r);c&&l.push(c);const u=function(t,n,a){let o="";if(t.length>0){const t=n.sqlExprObj?e.dataSourceUtils.getArcGISSQL(n.sqlExprObj,a).sql:null;t&&(o=t)}else o="";return o||(o=""),o}(a,o,r);return u&&l.push(u),0===l.length?t="":1===l.length?t=l[0]:2===l.length&&(t=`(${l[0]}) AND (${l[1]})`),t||(t=""),t}))}function r(t){var n,a;const o=[],i=t.records||[],s=(t.dataSourceIds||[]).filter((e=>!!e));if(i.length>0&&i[0]){const e=null===(a=null===(n=i[0])||void 0===n?void 0:n.dataSource)||void 0===a?void 0:a.getMainDataSource();if(e){o.push(e.id);const t=e.getAssociatedDataSource&&e.getAssociatedDataSource();t&&o.push(t.id)}}if((null==s?void 0:s.length)>0){const t=e.DataSourceManager.getInstance();s.forEach((e=>{const n=t.getDataSource(e);if(n){const e=n.getMainDataSource();e&&o.push(e.id)}}))}return Array.from(new Set(o))}var l=function(e,t,n,a){return new(n||(n=Promise))((function(o,i){function s(e){try{l(a.next(e))}catch(e){i(e)}}function r(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,r)}l((a=a.apply(e,t||[])).next())}))};const c="filterActionValue-",u="filterMessageValue-";class d extends e.AbstractMessageAction{constructor(){super(...arguments),this.filterActions={}}filterMessageDescription(t){return(0,e.getAppStore)().getState().appRuntimeInfo.appMode!==e.AppMode.Express&&t.messageType===e.MessageType.DataRecordsSelectionChange}filterMessage(e){return!0}getDefaultMessageActionConfig(t){return{useAnyTriggerData:!0,messageUseDataSource:null,actionUseDataSource:null,sqlExprObj:null,enabledDataRelationShip:!0,connectionType:e.MessageActionConnectionType.SetCustomFields}}onRemoveListen(t,n){Object.keys(this.filterActions||{}).forEach((t=>{Object.entries(this.filterActions[t]||{}).forEach((a=>{var o;const i=a[0];(null===(o=a[1])||void 0===o?void 0:o.messageWidgetId)===n&&e.lodash.setValue(this.filterActions,`${t}.${i}.querySQL`,"")}));const a={layerDataSourceId:t.slice(18),querySQL:this.getUnionAllFilterQuerySQL(t)};e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,t,a)}))}onExecute(t,a){return l(this,void 0,void 0,(function*(){switch(t.type){case e.MessageType.DataRecordsSelectionChange:const o=t,i=o.records||[];let l,d,g=null;if(null==a?void 0:a.useAnyTriggerData)if(i.length>0)g=function(t){var a,o,i,s;let r="",l="";if(t.length>0){const c=null===(o=null===(a=t[0])||void 0===a?void 0:a.dataSource)||void 0===o?void 0:o.getMainDataSource();if(c){r=c.id;const a=c.getIdField(),o=a&&(null===(s=null===(i=c.getSchema())||void 0===i?void 0:i.fields)||void 0===s?void 0:s[a]);if(o){const a=[];t.forEach((e=>{const t=e.getId();null!=t&&""!==t&&a.push(t)}));const i=n(a,e.JimuFieldType.Number);if(i.length>0){const t=!0,n=e.messageActionUtils.getSqlExpressionWidthMessageFieldValues(i,o,c,t);if(n){const t=(0,e.Immutable)(n),a=e.dataSourceUtils.getArcGISSQL(t,c);(null==a?void 0:a.sql)&&(l=null==a?void 0:a.sql)}}}}}let c=null;return r&&l&&(c={layerDataSourceId:r,querySQL:l}),c}(i),g&&g.layerDataSourceId&&(l=e.DataSourceManager.getInstance().getDataSource(g.layerDataSourceId),d=l);else{const t=r(o);if(t.length>0&&t[0]){const n=t[0];g={layerDataSourceId:n,querySQL:""},l=e.DataSourceManager.getInstance().getDataSource(n),d=l}}else if(a)if(a.messageUseDataSource&&a.actionUseDataSource){const n=function(e,t){var n;if(null==t?void 0:t.useAnyTriggerData)return!0;const a=r(e),o=null===(n=null==t?void 0:t.messageUseDataSource)||void 0===n?void 0:n.mainDataSourceId;return o&&a.includes(o)}(o,a);if(!n){e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"filterActionValue",null);break}if(l=e.DataSourceManager.getInstance().getDataSource(a.messageUseDataSource.mainDataSourceId),d=e.DataSourceManager.getInstance().getDataSource(a.actionUseDataSource.mainDataSourceId),l&&d)if(0===i.length)g={layerDataSourceId:d&&d.id,querySQL:""};else{const e=yield s(t,i,a,l,d);g={layerDataSourceId:d&&d.id,querySQL:e}}else g=null}else g=null;const S=function(e,t){const n=`${u}${e}-${t}`;return n}(t.widgetId,null==l?void 0:l.id),f=function(e){const t=`${c}${e}`;return t}(null==g?void 0:g.layerDataSourceId);g&&(e.lodash.setValue(this.filterActions,`${f}.${S}`,{querySQL:null==g?void 0:g.querySQL,messageWidgetId:t.widgetId}),g.querySQL=this.getUnionAllFilterQuerySQL(f)),e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,f,g)}return!0}))}getUnionAllFilterQuerySQL(e){let t="";return Object.entries(this.filterActions[e]||{}).forEach((e=>{var n;const a=null===(n=e[1])||void 0===n?void 0:n.querySQL;t=t&&a?` ${t} AND ${a} `:a||t})),t}}})(),o})())}}}));