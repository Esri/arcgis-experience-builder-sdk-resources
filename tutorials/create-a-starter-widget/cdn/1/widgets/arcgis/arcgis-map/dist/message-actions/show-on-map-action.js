System.register(["jimu-core","jimu-arcgis"],(function(e,t){var a={},o={};return{setters:[function(e){a.AbstractMessageAction=e.AbstractMessageAction,a.DataSourceManager=e.DataSourceManager,a.Immutable=e.Immutable,a.MessageCarryData=e.MessageCarryData,a.MessageType=e.MessageType,a.MutableStoreManager=e.MutableStoreManager,a.RecordSetChangeType=e.RecordSetChangeType,a.getAppStore=e.getAppStore,a.i18n=e.i18n},function(e){o.ActionType=e.ActionType,o.SHOW_ON_MAP_DATA_ID_PREFIX=e.SHOW_ON_MAP_DATA_ID_PREFIX,o.featureUtils=e.featureUtils}],execute:function(){e((()=>{var e={62686:e=>{"use strict";e.exports=o},79244:e=>{"use strict";e.exports=a}},t={};function n(a){var o=t[a];if(void 0!==o)return o.exports;var s=t[a]={exports:{}};return e[a](s,s.exports,n),s.exports}n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.p="";var s={};return n.p=window.jimuConfig.baseUrl,(()=>{"use strict";n.r(s),n.d(s,{default:()=>d});var e=n(79244),t=n(62686);const a="Show on map data";function o(){return{isUseCustomSymbol:!0,symbolOption:{pointSymbol:t.featureUtils.getDefaultSymbol("point"),polylineSymbol:t.featureUtils.getDefaultSymbol("polyline"),polygonSymbol:t.featureUtils.getDefaultSymbol("polygon")},isOperationalLayer:!0}}function i(t,a){var o,n;const s=l(),i=null===(o=null==s?void 0:s.widgets)||void 0===o?void 0:o[t],r=null===(n=null==i?void 0:i.manifest)||void 0===n?void 0:n.publishMessages;let u=e.MessageCarryData.UseDataSource;return null==r||r.forEach((e=>{const t=e;(null==t?void 0:t.messageCarryData)&&(null==t?void 0:t.messageType)===a&&(u=null==t?void 0:t.messageCarryData)})),u}function r(t,a){var o;const n=i(t,a),s=l(),r=null===(o=null==s?void 0:s.widgets)||void 0===o?void 0:o[t],d=(null==r?void 0:r.useDataSources)||(0,e.Immutable)([]),c=function(t){var a;const o=null!==(a=null==t?void 0:t.map((e=>({dataSourceId:e,mainDataSourceId:e,rootDataSourceId:null}))))&&void 0!==a?a:[];return(0,e.Immutable)(o)}(null==r?void 0:r.outputDataSources)||(0,e.Immutable)([]),g=function(t){const a=[],o=u(t),n=null==o?void 0:o.useMapWidgetIds,s={};(null==n?void 0:n.length)>0&&n.forEach((e=>{if(e){const t=u(e),o=null==t?void 0:t.useDataSources;o&&o.forEach((e=>{var t;const o=null===(t=null==e?void 0:e.asMutable)||void 0===t?void 0:t.call(e,{deep:!0});o&&o.dataSourceId&&!s[o.dataSourceId]&&(s[o.dataSourceId]=!0,a.push(o))}))}}));return(0,e.Immutable)(a)}(t),p=c,m=(null==r?void 0:r.useDataSources)?d:g,v=(0,e.Immutable)(m.asMutable({deep:!0}).concat(p.asMutable({deep:!0})));switch(n){case e.MessageCarryData.OutputDataSource:return p;case e.MessageCarryData.UseDataSource:return m;case e.MessageCarryData.BothDataSource:return v}}function u(e){var t;if(!e)return null;const a=l();return null===(t=null==a?void 0:a.widgets)||void 0===t?void 0:t[e]}function l(){var t,a,o;return window.jimuConfig.isBuilder?null===(a=null===(t=(0,e.getAppStore)().getState())||void 0===t?void 0:t.appStateInBuilder)||void 0===a?void 0:a.appConfig:null===(o=(0,e.getAppStore)().getState())||void 0===o?void 0:o.appConfig}class d extends e.AbstractMessageAction{filterMessageDescription(t){if(t.messageType===e.MessageType.DataRecordSetChange){const a=e.DataSourceManager.getInstance(),o=r(t.widgetId,t.messageType);return!(0!==o.length||!function(t){var a;const o=t.widgetId;if((t.messageType===e.MessageType.DataRecordSetChange||t.messageType===e.MessageType.DataRecordsSelectionChange)&&o){const e=u(o);if(e&&"widgets/common/search/"===e.uri&&(null===(a=e.useMapWidgetIds)||void 0===a?void 0:a.length)>0)return!0}return!1}(t))||o.some((e=>{const t=a.getDataSource(e.dataSourceId);return!!t&&!!t.getGeometryType()}))}return!1}filterMessage(e){return!0}getDefaultMessageActionConfig(e){return o()}onRemoveListen(t,a){var o;const n=(null===(o=e.MutableStoreManager.getInstance().getStateValue([this.widgetId]))||void 0===o?void 0:o.showOnMapDatas)||{},s={};Object.entries(n).forEach((e=>{var t;(null===(t=e[1])||void 0===t?void 0:t.messageWidgetId)!==a&&(s[e[0]]=e[1])})),e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"showOnMapDatas",s)}getSettingComponentUri(e,t){return"message-actions/show-on-map-action-setting"}onExecute(o,n){var s,i;if(o.type!==e.MessageType.DataRecordSetChange)return;const r=this._getActiveViewId(this.widgetId,(0,e.getAppStore)().getState().jimuMapViewsInfo),u=this._getDefaultViewId(this.widgetId,(0,e.getAppStore)().getState().jimuMapViewsInfo),l=r||u;let d=(null===(s=e.MutableStoreManager.getInstance().getStateValue([this.widgetId]))||void 0===s?void 0:s.showOnMapDatas)||{};return o.changeType===e.RecordSetChangeType.CreateUpdate?null===(i=o.dataRecordSets)||void 0===i||i.forEach((s=>{const i=this._getIdBase(s.name),c=`${i}???`,g=r?`${i}${r}`:c;let p;u&&u===r&&delete d[c],p=n?n.isUseCustomSymbol?n.symbolOption:!1===n.isUseCustomSymbol?null:void 0:void 0;const m=null==n?void 0:n.isOperationalLayer;let v=null;const S=d[g];v=S?S.titleCountInfo:function(t,o,n){const s=e.i18n.getIntl(),i=t.label||t.name||s.formatMessage({id:"showOnMapData",defaultMessage:a}),r=[];Object.values(n).forEach((e=>{const t=e.titleCountInfo;e.jimuMapViewId===o&&t&&t.rawTitle===i&&t.count>=0&&r.push(t.count)}));let u=null;if(r.length>0){const e=Math.max(...r);u={rawTitle:i,finalTitle:`${i} ${e+1}`,count:e+1}}else u={rawTitle:i,finalTitle:i,count:1};return u}(s,r,d);const f={mapWidgetId:this.widgetId,messageWidgetId:o.widgetId,jimuMapViewId:l,dataSet:s,title:v.finalTitle,type:t.ActionType.MessageAction,symbolOption:p,isOperationalLayer:m,titleCountInfo:v};d[g]=f})):o.changeType===e.RecordSetChangeType.Remove&&o.dataRecordSetNames.forEach((e=>{const t=this._getIdBase(e),a={};Object.entries(d).forEach((e=>{0!==e[0].indexOf(t)&&(a[e[0]]=e[1])})),d=a})),e.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"showOnMapDatas",d),Promise.resolve(!0)}_getIdBase(e){return`${t.SHOW_ON_MAP_DATA_ID_PREFIX}messageAction_${this.widgetId}_${e}_`}_getActiveViewId(e,t){return Object.keys(t||{}).find((a=>t[a].mapWidgetId===e&&t[a].isActive))}_getDefaultViewId(e,t){return Object.keys(t||{}).find((a=>t[a].mapWidgetId===e))}}})(),s})())}}}));